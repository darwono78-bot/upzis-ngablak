<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Pembukuan UPZIS | Ranting Ngablak</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <style>
        /* Gaya CSS untuk Tampilan */
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; padding: 0; background-color: #f4f7f6; color: #333; }
        .container { padding: 20px; max-width: 100%; margin: auto; } /* Lebar Maksimum Disesuaikan */
        
        /* Gaya Navigasi */
        .navbar { background-color: #006400; color: white; padding: 10px 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.2); display: flex; align-items: center; justify-content: space-between; }
        .navbar-logo { font-size: 1.5rem; font-weight: bold; }
        .navbar-links a { color: white; text-decoration: none; padding: 8px 15px; margin-left: 10px; border-radius: 4px; transition: background-color 0.3s; }
        .navbar-links a:hover, .navbar-links a.active { background-color: #008000; }
        
        .button { padding: 10px 15px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; transition: background-color 0.3s; }
        .btn-green { background-color: #008000; color: white; }
        .btn-green:hover { background-color: #006400; }
        .btn-red { background-color: #cc0000; color: white; }
        .btn-red:hover { background-color: #a00000; }
        .btn-blue { background-color: #007bff; color: white; }
        .btn-blue:hover { background-color: #0056b3; }
        
        /* Gaya Login Box */
        .login-box { 
            background: white; 
            padding: 30px; 
            border-radius: 8px; 
            box-shadow: 0 4px 8px rgba(0,0,0,0.1); 
            width: 450px; 
            margin: 20px auto; 
        }
        .login-input-row { 
            display: flex; 
            gap: 10px; 
            margin-bottom: 10px; 
        }
        .login-input-row input { 
            width: 50%; 
            padding: 10px; 
            border: 1px solid #ccc; 
            border-radius: 4px; 
            box-sizing: border-box; 
            margin-bottom: 0; 
        }

        table { width: 100%; border-collapse: collapse; margin-top: 15px; background: white; box-shadow: 0 2px 4px rgba(0,0,0,0.05); font-size: 0.9rem; }
        th, td { border: 1px solid #ddd; padding: 10px; text-align: left; }
        th { background-color: #006400; color: white; text-align: center; font-size: small; }
        
        /* Gaya untuk kolom angka */
        .money-col { text-align: right !important; }
        /* Kelas untuk elemen yang disembunyikan di luar PDF Koin NU (Hanya Pembagian Dana yang tetap disembunyikan) */
        .koin-pembagian-col, .koin-pembagian-header { display: table-cell; }
        
        .action-btns button { margin: 2px; font-size: 0.7rem; padding: 5px; }
        .input-form { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); margin-top: 30px; }
        .input-form h3 { color: #006400; border-bottom: 2px solid #006400; padding-bottom: 5px; }
        .form-row { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 10px; }
        .form-row label { font-weight: bold; display: block; margin-bottom: 5px; }
        .form-row input, .form-row select { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        .form-controls { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        
        /* Gaya Footer Total */
        tfoot td { font-weight: bold; text-align: right; background-color: #f0f0f0; }
        .total-label { text-align: right !important; }

        /* TTD Area Diperbaiki (Centered Block) */
        .ttd-area { 
            width: 80%; 
            margin: 30px auto 0 auto; 
            display: none; 
            justify-content: space-between; 
            padding: 20px 0; 
            box-sizing: border-box; 
        }
        .ttd-box { 
            text-align: center; 
            width: 45%; 
        }
        
        .ttd-box p { margin: 0; line-height: 1.5; }
        .ttd-line { 
            height: 1px; 
            width: 100%; 
            background: black; 
            margin: 30px 0 5px 0; 
        }
        /* ============================ */

        .report-header-section {
            display: flex;
            justify-content: space-between; 
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #ddd;
        }
        .report-title-center { text-align: center; flex-grow: 1; }
        .report-controls { display: flex; gap: 10px; align-items: center; }
        .auto-entry { font-style: italic; background-color: #f9f9f9; }
        .manual-entry { background-color: #fffacd; } 
        .saldo-entry { background-color: #e6ffe6; font-weight: bold; } 
        .total-saldo { background-color: #d4edda !important; color: #155724; } 
        
        /* === Gaya Laporan Tahunan Baru === */
        #annual-data-table th { font-size: x-small; padding: 5px; vertical-align: middle; }
        #annual-data-table td { font-size: x-small; padding: 5px; }
        .annual-sub-header { background-color: #008000; color: white; font-weight: bold; }
        .annual-manual-input { background-color: #fffacd; }
        .annual-saldo-row { background-color: #e6ffe6; }
        .annual-total-row { background-color: #d4edda !important; color: #155724; font-weight: bold; }
        .editable-cell { cursor: pointer; border-bottom: 1px dashed #007bff; }
        
        /* Gaya untuk Baris KOIN NU (Baris 1-4) */
        .koin-fixed-entry { background-color: #f0fff0; font-weight: normal; }
    </style>
</head>
<body>

    <div class="navbar">
        <span class="navbar-logo">Pembukuan UPZIS</span>
        <div class="navbar-links">
            <a href="#" id="nav-koin" onclick="showModule('koin')">Laporan KOIN NU</a>
            <a href="#" id="nav-jurnal" onclick="showModule('jurnal')">Jurnal Umum</a>
            <a href="#" id="nav-tahunan" onclick="showModule('tahunan')">Laporan Tahunan</a>
        </div>
    </div>

    <div class="container">
        
        <div id="koin-nu-module" style="display: block;">
            <div id="koin-pdf-content">
                <div style="text-align: center; margin-bottom: 10px; padding-bottom: 10px; border-bottom: 3px double #006400;">
                    <h1 style="color: #006400; margin: 0; line-height: 1.2; font-size: 24px;">NU CARE UPZIS - LAZISNU RANTING NGABLAK</h1>
                    <p style="margin: 0; font-size: 14px; color: #555;">Sekretariat: Jalan [Nama Jalan], Desa Ngablak, Kec. [Kecamatan], Kab. [Kabupaten]</p>
                </div>

                <div class="report-header-section">
                    <div class="report-controls">
                        <label for="koin-filter-bulan">Bulan:</label>
                        <select id="koin-filter-bulan" onchange="filterData('koin')"></select>
                        <label for="koin-filter-tahun">Tahun:</label>
                        <select id="koin-filter-tahun" onchange="filterData('koin')"></select>
                    </div>
                    
                    <div class="report-title-center">
                        <p style="font-weight: bold; margin: 0;">Laporan Pemasukan KOIN NU Periode <span id="koin-pdf-periode-display"></span></p>
                    </div>

                    <div class="report-controls">
                        <button class="button btn-red" id="koin-download-btn-header" onclick="downloadPDF('koin')">Unduh PDF</button>
                    </div>
                </div>


                <table id="koin-data-table">
                    <thead>
                        <tr>
                            <th rowspan="2">NO</th>
                            <th rowspan="2">TANGGAL</th>
                            <th rowspan="2">NAMA PETUGAS</th>
                            <th rowspan="2" id="koin-hp-header">NO HP</th> 
                            <th rowspan="2">DONATUR/KELOMPOK</th>
                            <th rowspan="2" id="koin-alamat-header">ALAMAT (RT/RW)</th> 
                            <th rowspan="2" class="money-col">NOMINAL</th> 
                            <th colspan="4" class="koin-pembagian-header">PEMBAGIAN DANA KOIN</th> 
                            <th rowspan="2" id="koin-aksi-header" style="display: none;">Aksi</th>
                        </tr>
                        <tr>
                            <th class="koin-pembagian-header money-col">Petugas (10%)</th> 
                            <th class="koin-pembagian-header money-col">Ranting (60%)</th> 
                            <th class="koin-pembagian-header money-col">MWC (25%)</th> 
                            <th class="koin-pembagian-header money-col">PC (5%)</th> 
                        </tr>
                    </thead>
                    <tbody id="koin-data-body">
                        </tbody>
                    <tfoot>
                        <tr>
                            <td colspan="6" class="total-label" id="koin-total-label">TOTAL PENJUMLAHAN</td>
                            <td id="koin-total-nominal" class="money-col">0</td>
                            <td id="koin-total-petugas" class="money-col koin-pembagian-col">0</td>
                            <td id="koin-total-ranting" class="money-col koin-pembagian-col">0</td>
                            <td id="koin-total-mwc" class="money-col koin-pembagian-col">0</td>
                            <td id="koin-total-pc" class="money-col koin-pembagian-col">0</td>
                            <td id="koin-total-aksi" style="display: none;"></td>
                        </tr>
                    </tfoot>
                </table>
                
                <div id="koin-ttd-date" style="text-align: right; margin-bottom: 15px; display: none;"> Ngablak, <span id="koin-ttd-tanggal-output"></span></div>
                <div id="koin-ttd-area" class="ttd-area"> 
                    <div class="ttd-box"><p>Mengetahui,</p><p>Ketua UPZIS</p><div class="ttd-line"></div><p>(Nama Ketua)</p></div>
                    <div class="ttd-box"><p>Dibuat oleh,</p><p>Bendahara UPZIS</p><div class="ttd-line"></div><p>(Nama Bendahara)</p></div>
                </div>

            </div>
            <div class="form-controls" id="koin-admin-controls" style="display: none; margin-top: 20px;">
                <button class="button btn-red" onclick="deleteAllDataGlobal('koin')">Hapus Semua Data</button> 
                <button class="button btn-blue" onclick="logout()">Log Out</button> 
            </div>
            <div class="input-form" id="koin-input-area" style="display: none;">
                <h3>Input Data Pemasukan Baru (KOIN NU)</h3>
                <div class="form-row">
                    <div><label for="koin-input-tanggal">Tanggal:</label><input type="date" id="koin-input-tanggal" required></div>
                    <div><label for="koin-input-petugas">Nama Petugas:</label><input type="text" id="koin-input-petugas" required></div>
                    <div><label for="koin-input-hp">No. HP Petugas:</label><input type="tel" id="koin-input-hp" required></div>
                </div>
                <div class="form-row">
                    <div><label for="koin-input-donatur">Donatur/Kelompok:</label><input type="text" id="koin-input-donatur" required></div>
                    <div><label for="koin-input-alamat">Alamat (RT/RW):</label><input type="text" id="koin-input-alamat" required></div>
                    <div><label for="koin-input-nominal">Nominal:</label><input type="number" id="koin-input-nominal" required></div>
                </div>
                <div style="text-align: right; margin-top: 10px;">
    		<button class="button btn-green" onclick="saveData('koin')">Simpan Data</button>
		</div>
                <div style="clear: both;"></div> 
            </div>
        </div>
        
        <div id="jurnal-umum-module" style="display: none;">
             <div id="jurnal-pdf-content">
                <div style="text-align: center; margin-bottom: 10px; padding-bottom: 10px; border-bottom: 3px double #006400;">
                    <h1 style="color: #006400; margin: 0; line-height: 1.2; font-size: 24px;">NU CARE UPZIS - LAZISNU RANTING NGABLAK</h1>
                    <p style="margin: 0; font-size: 14px; color: #555;">Sekretariat: Jalan [Nama Jalan], Desa Ngablak, Kec. [Kecamatan], Kab. [Kabupaten]</p>
                </div>

                <div class="report-header-section">
                    <div class="report-controls">
                        <label for="jurnal-filter-bulan">Bulan:</label>
                        <select id="jurnal-filter-bulan" onchange="filterData('jurnal')"></select>
                        <label for="jurnal-filter-tahun">Tahun:</label>
                        <select id="jurnal-filter-tahun" onchange="filterData('jurnal')"></select>
                    </div>
                    
                    <div class="report-title-center">
                        <p style="font-weight: bold; margin: 0;">Jurnal Umum Periode <span id="jurnal-pdf-periode-display"></span></p>
                    </div>

                    <div class="report-controls">
                        <button class="button btn-red" id="jurnal-download-btn-header" onclick="downloadPDF('jurnal')">Unduh PDF</button>
                    </div>
                </div>

                <table id="jurnal-data-table">
                    <thead>
                        <tr>
                            <th>NO</th>
                            <th>TANGGAL</th>
                            <th>KETERANGAN</th>
                            <th>KATEGORI</th>
                            <th class="money-col">DANA MASUK</th> 
                            <th class="money-col">DANA KELUAR</th> 
                            <th class="money-col">SALDO</th> 
                            <th id="jurnal-aksi-header" style="display: none;">Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="jurnal-data-body"></tbody>
                    <tfoot>
                        <tr>
                            <td colspan="4" class="total-label" id="jurnal-total-label">TOTAL</td>
                            <td id="jurnal-total-masuk" class="money-col">0</td>
                            <td id="jurnal-total-keluar" class="money-col">0</td>
                            <td id="jurnal-saldo-akhir" class="total-saldo money-col">0</td>
                            <td id="jurnal-total-aksi" style="display: none;"></td>
                        </tr>
                    </tfoot>
                </table>

                <div id="jurnal-ttd-date" style="text-align: right; margin-bottom: 15px; display: none;"> Ngablak, <span id="jurnal-ttd-tanggal-output"></span></div>
                <div id="jurnal-ttd-area" class="ttd-area"> 
                    <div class="ttd-box"><p>Mengetahui,</p><p>Ketua UPZIS</p><div class="ttd-line"></div><p>(Nama Ketua)</p></div>
                    <div class="ttd-box"><p>Dibuat oleh,</p><p>Bendahara UPZIS</p><div class="ttd-line"></div><p>(Nama Bendahara)</p></div>
                </div>
            </div>

            <div class="form-controls" id="jurnal-admin-controls" style="display: none; margin-top: 20px;">
                <button class="button btn-red" onclick="deleteAllDataGlobal('jurnal')">Hapus Semua Data</button> 
                <button class="button btn-blue" onclick="logout()">Log Out</button> 
            </div>

            <div class="input-form" id="jurnal-input-area" style="display: none;">
                <h3>Input Data Jurnal Umum (Manual)</h3>
                <div class="form-row">
                    <div><label for="jurnal-input-tanggal">Tanggal:</label><input type="date" id="jurnal-input-tanggal" required></div>
                    <div><label for="jurnal-input-keterangan">Keterangan/Uraian:</label><input type="text" id="jurnal-input-keterangan" required></div>
                    <div>
                        <label for="jurnal-input-kategori">Kategori:</label>
                        <select id="jurnal-input-kategori" onchange="updateMasukKeluarFields()" required>
                            <option value="">Pilih Kategori</option>
                            <optgroup label="DANA MASUK">
                                <option value="Koin NU">Koin NU</option>
                                <option value="Donatur">Donatur</option>
                                <option value="Zakat Mall">Zakat Mall</option>
                                <option value="Infaq">Infaq</option>
                                <option value="Shodaqoh">Shodaqoh</option>
                                <option value="Saldo Bulan Lalu">Saldo Bulan Lalu</option>
                                <option value="Hasil Usaha">Hasil Usaha</option>
                            </optgroup>
                            <optgroup label="DANA KELUAR WAJIB">
                                <option value="Untuk Pendidikan">Untuk Pendidikan</option>
                                <option value="Untuk Sosial">Untuk Sosial</option>
                                <option value="Untuk Ekonomi">Untuk Ekonomi</option>
                                <option value="Untuk Kesehatan">Untuk Kesehatan</option>
                                <option value="Subsidi Banom & Lembaga NU">Subsidi Banom & Lembaga NU</option>
                                <option value="Untuk Bencana">Untuk Bencana</option>
                            </optgroup>
                            <optgroup label="DANA KELUAR LAIN-LAIN">
                                <option value="Petugas (10%)">Petugas (10%)</option>
                                <option value="MWC (25%)">MWC (25%)</option>
                                <option value="PC (5%)">PC (5%)</option>
                                <option value="Ranting (60%)">Ranting (60%)</option>
                                <option value="Rapat-rapat">Rapat-rapat</option>
                                <option value="PERWTN MLU">PERWTN MLU</option>
                                <option value="BIAYA REK BANK">BIAYA REK BANK</option>
                                <option value="Lain-lain">Lain-lain (General)</option>
                            </optgroup>
                        </select>
                    </div>
                </div>
                <div class="form-row" style="grid-template-columns: repeat(2, 1fr);">
                    <div><label for="jurnal-input-masuk">Dana Masuk:</label><input type="number" id="jurnal-input-masuk" min="0"></div>
                    <div><label for="jurnal-input-keluar">Dana Keluar:</label><input type="number" id="jurnal-input-keluar" min="0"></div>
                </div>
                 <div style="text-align: right; margin-top: 10px;">
   		 <button class="button btn-green" onclick="saveData('jurnal')">Simpan Data</button>
		 </div>
                <div style="clear: both;"></div> 
            </div>
        </div>
        
        <div id="laporan-tahunan-module" style="display: none;">
             <div id="tahunan-pdf-content">
                <div style="text-align: center; margin-bottom: 10px; padding-bottom: 10px; border-bottom: 3px double #006400;">
                    <h1 style="color: #006400; margin: 0; line-height: 1.2; font-size: 24px;">NU CARE UPZIS - LAZISNU RANTING NGABLAK</h1>
                    <p style="margin: 0; font-size: 14px; color: #555;">Sekretariat: Jalan [Nama Jalan], Desa Ngablak, Kec. [Kecamatan], Kab. [Kabupaten]</p>
                </div>

                <div class="report-header-section">
                    <div class="report-controls">
                        <label for="tahunan-filter-tahun">Tahun Laporan:</label>
                        <select id="tahunan-filter-tahun" onchange="filterData('tahunan')"></select>
                    </div>
                    
                    <div class="report-title-center">
                        <p style="font-weight: bold; margin: 0;">Laporan Tahunan Periode <span id="tahunan-pdf-periode-display"></span></p>
                    </div>

                    <div class="report-controls">
                        <button class="button btn-red" id="tahunan-download-btn-header" onclick="downloadPDF('tahunan')">Unduh PDF</button>
                    </div>
                </div>

                <div style="overflow-x: auto;">
                    <table id="annual-data-table">
                        <thead>
                            <tr>
                                <th rowspan="4" style="width: 1%;">NO (1)</th>
                                <th rowspan="4" style="width: 8%;">BULAN (2)</th>
                                <th colspan="2" class="annual-sub-header">PENERIMAAN</th>
                                <th colspan="12" class="annual-sub-header">PENGELUARAN WAJIB (5)</th>
                                <th colspan="7" class="annual-sub-header">PENGELUARAN LAIN-LAIN (6)</th>
                                <th rowspan="4" class="money-col" style="width: 8%;">JUMLAH PENGELUARAN (7)</th>
                                <th rowspan="4" class="money-col" style="width: 8%;">SALDO AKHIR BULAN INI (8)</th>
                                <th rowspan="4" class="money-col" style="width: 8%;">SALDO KAS TAHUN BERJALAN (9)</th>
                            </tr>
                            <tr>
                                <th rowspan="3" class="money-col" style="width: 8%;">Total Penerimaan Koin (3)</th>
                                <th rowspan="3" style="width: 5%;">Jumlah Donatur (4)</th>
                                
                                <th colspan="2">Pendidikan</th>
                                <th colspan="2">Kesehatan</th>
                                <th colspan="2">Ekonomi</th>
                                <th colspan="2">Sosial</th>
                                <th colspan="2">Subsidi Banom & Lembaga NU</th>
                                <th colspan="2">Bencana</th>
                                
                                <th colspan="3">Honor Wajib</th>
                                <th rowspan="3" class="money-col">Rapat-Rapat</th>
                                <th rowspan="3" class="money-col">PERWTN MLU</th>
                                <th rowspan="3" class="money-col">BIAYA REK BANK</th>
                                <th rowspan="3" class="money-col">Lain - Lain</th>
                            </tr>
                            <tr>
                                <th colspan="8">Rincian Per Bidang (Uang & Penerima)</th>
                                <th colspan="2">Uang & Keterangan</th>
                                <th colspan="2">Uang & Penerima</th>
                                
                                <th class="money-col">Petugas 10%</th>
                                <th class="money-col">MWC 25%</th>
                                <th class="money-col">PC 5%</th>
                            </tr>
                            <tr>
    				<th class="money-col annual-pengeluaran-wajib">Jml Uang</th>
    				<th class="annual-pengeluaran-wajib">Jml Penerima (Manual)</th> 
    				<th class="money-col annual-pengeluaran-wajib">Jml Uang</th>
    				<th class="annual-pengeluaran-wajib">Jml Penerima (Manual)</th>
    				<th class="money-col annual-pengeluaran-wajib">Jml Uang</th>
    				<th class="annual-pengeluaran-wajib">Jml Penerima (Manual)</th>
    				<th class="money-col annual-pengeluaran-wajib">Jml Uang</th>
    				<th class="annual-pengeluaran-wajib">Jml Penerima (Manual)</th>
    				<th class="money-col annual-pengeluaran-wajib">Jml Uang</th>
    				<th class="annual-pengeluaran-wajib">Keterangan (Manual)</th>
    				<th class="money-col annual-pengeluaran-wajib">Jml Uang</th>
    				<th class="annual-pengeluaran-wajib">Jml Penerima (Manual)</th>
    
    				<th class="money-col annual-pengeluaran-lain"></th>
    				<th class="money-col annual-pengeluaran-lain"></th>
    				<th class="money-col annual-pengeluaran-lain"></th>
			   </tr>
                        </thead>
                        <tbody id="annual-data-body"></tbody>
                        <tfoot>
                            <tr class="annual-total-row">
                                <td colspan="2" class="total-label" style="text-align: center;">TOTAL TAHUNAN</td>
                                <td id="tahunan-total-koin" class="money-col">0</td>
                                <td id="tahunan-total-donatur" class="money-col">0</td>
                                
                                <td id="tahunan-total-pend-uang" class="money-col">0</td>
                                <td id="tahunan-total-pend-penerima" style="text-align: center;">-</td>
                                <td id="tahunan-total-kes-uang" class="money-col">0</td>
                                <td id="tahunan-total-kes-penerima" style="text-align: center;">-</td>
                                <td id="tahunan-total-eko-uang" class="money-col">0</td>
                                <td id="tahunan-total-eko-penerima" style="text-align: center;">-</td>
                                <td id="tahunan-total-sosial-uang" class="money-col">0</td>
                                <td id="tahunan-total-sosial-penerima" style="text-align: center;">-</td>
                                <td id="tahunan-total-banom-uang" class="money-col">0</td>
                                <td id="tahunan-total-banom-ket" style="text-align: center;">-</td>
                                <td id="tahunan-total-bencana-uang" class="money-col">0</td>
                                <td id="tahunan-total-bencana-penerima" style="text-align: center;">-</td>

                                <td id="tahunan-total-honor-petugas" class="money-col">0</td>
                                <td id="tahunan-total-honor-mwc" class="money-col">0</td>
                                <td id="tahunan-total-honor-pc" class="money-col">0</td>
                                <td id="tahunan-total-rapat" class="money-col">0</td>
                                <td id="tahunan-total-perwtn-mlu" class="money-col">0</td>
                                <td id="tahunan-total-biaya-rek-bank" class="money-col">0</td>
                                <td id="tahunan-total-lain-lain-peng" class="money-col">0</td>
                                
                                <td id="tahunan-total-pengeluaran" class="money-col">0</td>
                                <td id="tahunan-total-saldo-akhir" class="money-col">0</td>
                                <td id="tahunan-total-saldo-kas" class="money-col">0</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>

                <div id="tahunan-ttd-date" style="text-align: right; margin-bottom: 15px; display: none;"> Ngablak, <span id="tahunan-ttd-tanggal-output"></span></div>
                <div id="tahunan-ttd-area" class="ttd-area"> 
                    <div class="ttd-box"><p>Mengetahui,</p><p>Ketua UPZIS</p><div class="ttd-line"></div><p>(Nama Ketua)</p></div>
                    <div class="ttd-box"><p>Dibuat oleh,</p><p>Bendahara UPZIS</p><div class="ttd-line"></div><p>(Nama Bendahara)</p></div>
                </div>
            </div>
             
            <div class="form-controls" id="tahunan-admin-controls" style="display: none; justify-content: flex-end;">
                <button class="button btn-blue" onclick="logout()">Log Out</button> 
            </div>
            
            <div class="input-form" id="tahunan-edit-input-area" style="display: none;">
                <h3>Edit Data Laporan Tahunan (Baris Khusus)</h3>
                <div class="form-row" style="grid-template-columns: 1fr 1fr 1fr;">
                    <div><label>Baris yang Diedit:</label><input type="text" id="annual-edit-label" disabled></div>
                    <div><label>Nominal/Penerima:</label><input type="number" id="annual-edit-nominal" required></div>
                    <div id="annual-edit-keterangan-group" style="display: none;">
                        <label>Keterangan/Uraian:</label>
                        <input type="text" id="annual-edit-keterangan">
                    </div>
                </div>
                <div style="float: right; margin-top: 10px;">
                    <button class="button btn-green" onclick="saveAnnualReportData()">Simpan Perubahan</button>
                    <button class="button btn-red" onclick="cancelAnnualEdit()">Batal</button>
                </div>
                <div style="clear: both;"></div> 
            </div>

        </div>
        <div id="login-area" style="display: none;">
            <div class="login-box">
                <h2 style="text-align: center; color: #006400;">ADMIN LOGIN</h2>
                <div class="login-input-row">
                    <input type="text" id="username" placeholder="Username">
                    <input type="password" id="password" placeholder="Password">
                </div>
                <button class="button btn-green" style="width: 100%;" onclick="attemptLogin()">Masuk</button>
            </div>
        </div>
        </div>
<script>
        // --- KONSTANTA DAN INISIALISASI ---
        
        // Data Global (akan diisi dari Firebase)
        let koinData = []; 
        let jurnalData = [];
        let annualData = [];

        // Pengaturan Login
        const ADMIN_USERNAME = 'admin';
        const ADMIN_PASSWORD = 'admin';
        // Status login akan default 'false' dan perlu diatur ulang setelah login berhasil
        let isLoggedIn = false; 
        let koinEditId = null;
        let jurnalEditId = null;
        let currentModule = 'koin'; // Default module
        let annualEditData = null; // Untuk menyimpan data yang sedang diedit di Laporan Tahunan

        // Kategori-kategori Jurnal
        const categories = {
            koin: 'Koin NU',
            saldo_bln_lalu: 'Saldo Bulan Lalu',
            honor_petugas: 'Petugas (10%)',
            honor_mwc: 'MWC (25%)',
            // ... (kategori lainnya)
            honor_pc: 'PC (5%)',
            honor_ranting: 'Ranting (60%)', 
            pendidikan: 'Untuk Pendidikan',
            sosial: 'Untuk Sosial',
            kesehatan: 'Untuk Kesehatan',
            ekonomi: 'Untuk Ekonomi',
            banom: 'Subsidi Banom & Lembaga NU',
            bencana: 'Untuk Bencana',
            rapat: 'Rapat-rapat',
            perwtn_mlu: 'PERWTN MLU',
            biaya_rek_bank: 'BIAYA REK BANK',
            lain_lain: 'Lain-lain',
            donatur: 'Donatur',
            zakat_mall: 'Zakat Mall',
            infaq: 'Infaq',
            shodaqoh: 'Shodaqoh',
            hasil_usaha: 'Hasil Usaha'
        };

        // Nama Bulan untuk tampilan
        const namaBulan = [
            'Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni', 
            'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'
        ];

        // --- UTILITY FUNCTIONS ---

        function formatRupiah(number) {
            if (number === 0) return '-';
            const formatter = new Intl.NumberFormat('id-ID', {
                style: 'currency',
                currency: 'IDR',
                minimumFractionDigits: 0
            });
            return formatter.format(number).replace('Rp', '').trim();
        }

        function formatTanggal(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString + 'T00:00:00'); 
            const day = date.getDate().toString().padStart(2, '0');
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const year = date.getFullYear();
            return `${day}/${month}/${year}`;
        }

        function formatTanggalTTD() {
             const today = new Date();
             const day = today.getDate();
             const month = today.getMonth();
             const year = today.getFullYear();
             return `${day} ${namaBulan[month]} ${year}`;
        }
        
        // --- ADMIN / LOGIN FUNCTIONS ---
        
        // Catatan: Anda perlu menyimpan status login di Firebase Authentication atau Session Storage jika ingin persisten
        function attemptLogin() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            if (username === ADMIN_USERNAME && password === ADMIN_PASSWORD) {
                isLoggedIn = true;
                // localStorage.setItem('isLoggedIn', 'true'); // Dihapus
                document.getElementById('username').value = '';
                document.getElementById('password').value = '';
                showModule('koin'); 
                alert('Login Berhasil!');
            } else {
                alert('Username atau Password salah!');
            }
        }
        
        function logout() {
            isLoggedIn = false;
            // localStorage.removeItem('isLoggedIn'); // Dihapus
            showModule('login');
            alert('Anda telah Logout.');
        }
        
        function showAdminControls(module) {
            // ... (logika untuk menampilkan tombol admin)
            const koinControls = document.getElementById('koin-admin-controls');
            const jurnalControls = document.getElementById('jurnal-admin-controls');
            const tahunanControls = document.getElementById('tahunan-admin-controls');
            const koinInput = document.getElementById('koin-input-area');
            const jurnalInput = document.getElementById('jurnal-input-area');
            
            [koinControls, jurnalControls, tahunanControls, koinInput, jurnalInput].forEach(el => {
                if(el) el.style.display = 'none';
            });
            
            if (isLoggedIn) {
                if (module === 'koin') {
                    koinControls.style.display = 'flex';
                    koinInput.style.display = 'block';
                    document.getElementById('koin-aksi-header').style.display = 'table-cell';
                    document.getElementById('koin-total-aksi').style.display = 'table-cell';
                } else if (module === 'jurnal') {
                    jurnalControls.style.display = 'flex';
                    jurnalInput.style.display = 'block';
                    document.getElementById('jurnal-aksi-header').style.display = 'table-cell';
                    document.getElementById('jurnal-total-aksi').style.display = 'table-cell';
                } else if (module === 'tahunan') {
                    tahunanControls.style.display = 'flex';
                }
            } else {
                 if(document.getElementById('koin-aksi-header')) document.getElementById('koin-aksi-header').style.display = 'none';
                 if(document.getElementById('koin-total-aksi')) document.getElementById('koin-total-aksi').style.display = 'none';
                 if(document.getElementById('jurnal-aksi-header')) document.getElementById('jurnal-aksi-header').style.display = 'none';
                 if(document.getElementById('jurnal-total-aksi')) document.getElementById('jurnal-total-aksi').style.display = 'none';
            }
        }

        // --- NAVIGASI DAN INISIALISASI MODULE ---
        
        function showModule(module) {
            document.getElementById('koin-nu-module').style.display = 'none';
            document.getElementById('jurnal-umum-module').style.display = 'none';
            document.getElementById('laporan-tahunan-module').style.display = 'none';
            document.getElementById('login-area').style.display = 'none';
            
            const container = document.querySelector('.container');
            container.style.display = 'block';
            
            document.querySelectorAll('.navbar-links a').forEach(link => link.classList.remove('active'));

            if (module === 'koin') {
                document.getElementById('koin-nu-module').style.display = 'block';
                document.getElementById('nav-koin').classList.add('active');
                currentModule = 'koin';
            } else if (module === 'jurnal') {
                document.getElementById('jurnal-umum-module').style.display = 'block';
                document.getElementById('nav-jurnal').classList.add('active');
                currentModule = 'jurnal';
            } else if (module === 'tahunan') {
                document.getElementById('laporan-tahunan-module').style.display = 'block';
                document.getElementById('nav-tahunan').classList.add('active');
                currentModule = 'tahunan';
            } else if (module === 'login') {
                document.getElementById('login-area').style.display = 'block';
                container.style.display = 'block'; 
                currentModule = 'login';
                return; 
            }
            
            filterData(currentModule);
            showAdminControls(currentModule);
            cancelAnnualEdit(); 
        }

        // Catatan: Fungsi `init` sudah tidak digunakan, diganti dengan `DOMContentLoaded` dan `loadAllCollections()`
        
        // --- FILTER DAN TAMPILAN DATA ---
        
        function populateFilterOptions() {
            // Collect all unique years and months from data
            let years = new Set();
            let months = new Set();
            
            koinData.forEach(d => {
                const date = new Date(d.tanggal);
                years.add(date.getFullYear());
                months.add(date.getMonth() + 1);
            });
            jurnalData.forEach(d => {
                const date = new Date(d.tanggal);
                years.add(date.getFullYear());
                months.add(date.getMonth() + 1);
            });
            annualData.forEach(d => {
                if (d.year) years.add(d.year);
            });

            const sortedYears = Array.from(years).sort((a, b) => b - a);
            const availableMonths = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12];

            const koinYearsSelect = document.getElementById('koin-filter-tahun');
            const jurnalYearsSelect = document.getElementById('jurnal-filter-tahun');
            const tahunanYearsSelect = document.getElementById('tahunan-filter-tahun');
            const koinMonthsSelect = document.getElementById('koin-filter-bulan');
            const jurnalMonthsSelect = document.getElementById('jurnal-filter-bulan');
            
            [koinYearsSelect, jurnalYearsSelect, tahunanYearsSelect].forEach(select => {
                select.innerHTML = '';
                sortedYears.forEach(year => {
                    select.innerHTML += `<option value="${year}">${year}</option>`;
                });
                if (sortedYears.length > 0) {
                    select.value = sortedYears[0];
                }
            });

            [koinMonthsSelect, jurnalMonthsSelect].forEach(select => {
                select.innerHTML = '<option value="all">Semua Bulan</option>';
                availableMonths.forEach(month => {
                    select.innerHTML += `<option value="${month}">${namaBulan[month - 1]}</option>`;
                });
                const currentMonth = new Date().getMonth() + 1;
                select.value = currentMonth;
            });
            
            if (tahunanYearsSelect.value === '' && sortedYears.length > 0) {
                tahunanYearsSelect.value = sortedYears[0];
            }
        }
        
        function filterData(module) {
            // ... (logika filter data)
            let filteredData = [];
            let year = 0;
            let month = 'all';

            if (module === 'koin') {
                year = parseInt(document.getElementById('koin-filter-tahun').value);
                month = document.getElementById('koin-filter-bulan').value;
                filteredData = koinData.filter(d => {
                    const date = new Date(d.tanggal);
                    const itemYear = date.getFullYear();
                    const itemMonth = date.getMonth() + 1;
                    return itemYear === year && (month === 'all' || itemMonth === parseInt(month));
                });
                renderKoinTable(filteredData, month, year);

            } else if (module === 'jurnal') {
                year = parseInt(document.getElementById('jurnal-filter-tahun').value);
                month = document.getElementById('jurnal-filter-bulan').value;
                filteredData = jurnalData.filter(d => {
                    const date = new Date(d.tanggal);
                    const itemYear = date.getFullYear();
                    const itemMonth = date.getMonth() + 1;
                    return itemYear === year && (month === 'all' || itemMonth === parseInt(month));
                });
                renderJurnalTable(filteredData, month, year);
                
            } else if (module === 'tahunan') {
                year = parseInt(document.getElementById('tahunan-filter-tahun').value);
                renderAnnualTable(year);
            }
        }

        // --- KOIN NU FUNCTIONS ---

        function renderKoinTable(data, monthFilter, yearFilter) {
            // ... (logika render tabel)
            const body = document.getElementById('koin-data-body');
            body.innerHTML = '';
            
            let totalNominal = 0;
            let totalPetugas = 0;
            let totalRanting = 0;
            let totalMWC = 0;
            let totalPC = 0;
            
            data.sort((a, b) => new Date(a.tanggal) - new Date(b.tanggal));

            data.forEach((d, index) => {
                const nominal = d.nominal || 0;
                const petugas = Math.round(nominal * 0.10);
                const ranting = Math.round(nominal * 0.60);
                const mwc = Math.round(nominal * 0.25);
                const pc = Math.round(nominal * 0.05);

                totalNominal += nominal;
                totalPetugas += petugas;
                totalRanting += ranting;
                totalMWC += mwc;
                totalPC += pc;

                const row = body.insertRow();
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${formatTanggal(d.tanggal)}</td>
                    <td>${d.petugas}</td>
                    <td id="koin-hp-row-${d.id}">${d.hp}</td>
                    <td>${d.donatur}</td>
                    <td id="koin-alamat-row-${d.id}">${d.alamat}</td>
                    <td class="money-col">${formatRupiah(nominal)}</td>
                    <td class="money-col koin-pembagian-col">${formatRupiah(petugas)}</td>
                    <td class="money-col koin-pembagian-col">${formatRupiah(ranting)}</td>
                    <td class="money-col koin-pembagian-col">${formatRupiah(mwc)}</td>
                    <td class="money-col koin-pembagian-col">${formatRupiah(pc)}</td>
                    <td style="display: ${isLoggedIn ? 'table-cell' : 'none'};" class="action-btns">
                        <button class="button btn-blue" onclick="editData('koin', '${d.id}')">Edit</button>
                        <button class="button btn-red" onclick="deleteData('koin', '${d.id}')">Hapus</button>
                    </td>
                `;
                if (d.type === 'manual') {
                    row.classList.add('manual-entry');
                }
            });
            
            document.getElementById('koin-total-nominal').innerText = formatRupiah(totalNominal);
            document.getElementById('koin-total-petugas').innerText = formatRupiah(totalPetugas);
            document.getElementById('koin-total-ranting').innerText = formatRupiah(totalRanting);
            document.getElementById('koin-total-mwc').innerText = formatRupiah(totalMWC);
            document.getElementById('koin-total-pc').innerText = formatRupiah(totalPC);
            
            const periodDisplay = document.getElementById('koin-pdf-periode-display');
            if (monthFilter === 'all') {
                periodDisplay.innerText = `Tahun ${yearFilter}`;
            } else {
                periodDisplay.innerText = `${namaBulan[parseInt(monthFilter) - 1]} ${yearFilter}`;
            }
            document.getElementById('koin-ttd-tanggal-output').innerText = formatTanggalTTD();
        }

        async function saveData(module) {
            if (module === 'koin') {
                // ... (pengambilan data input)
                const tanggal = document.getElementById('koin-input-tanggal').value;
                const petugas = document.getElementById('koin-input-petugas').value;
                const hp = document.getElementById('koin-input-hp').value;
                const donatur = document.getElementById('koin-input-donatur').value;
                const alamat = document.getElementById('koin-input-alamat').value;
                const nominal = parseInt(document.getElementById('koin-input-nominal').value) || 0;
                
                if (!tanggal || !petugas || !donatur || !nominal) {
                    alert('Mohon lengkapi Tanggal, Petugas, Donatur, dan Nominal.');
                    return;
                }
                
                const dataToSave = { tanggal, petugas, hp, donatur, alamat, nominal, type: 'manual' };

                if (koinEditId) {
                    // --- TEMPAT INTEGRASI FIREBASE EDIT ---
                    // Contoh: await updateDoc(doc(db, 'koin', koinEditId), dataToSave);
                    alert('Data Koin NU berhasil diubah.');
                    koinEditId = null;
                } else {
                    // --- TEMPAT INTEGRASI FIREBASE SAVE BARU ---
                    // Contoh: await addDoc(collection(db, 'koin'), dataToSave);
                    alert('Data Koin NU berhasil disimpan.');
                }

                // Setelah operasi database berhasil:
                // await loadAllCollections(); // Anda perlu membuat fungsi ini
                filterData('koin');
                clearInputFields('koin');
                
            } else if (module === 'jurnal') {
                 // ... (pengambilan data input)
                const tanggal = document.getElementById('jurnal-input-tanggal').value;
                const keterangan = document.getElementById('jurnal-input-keterangan').value;
                const kategori = document.getElementById('jurnal-input-kategori').value;
                const masuk = parseInt(document.getElementById('jurnal-input-masuk').value) || 0;
                const keluar = parseInt(document.getElementById('jurnal-input-keluar').value) || 0;

                if (!tanggal || !keterangan || !kategori || (masuk === 0 && keluar === 0)) {
                    alert('Mohon lengkapi Tanggal, Keterangan, Kategori, dan setidaknya salah satu Nominal (Masuk/Keluar).');
                    return;
                }
                
                const dataToSave = { tanggal, keterangan, kategori, masuk, keluar, type: 'manual' };

                if (jurnalEditId) {
                    // --- TEMPAT INTEGRASI FIREBASE EDIT ---
                    // Contoh: await updateDoc(doc(db, 'jurnal', jurnalEditId), dataToSave);
                    alert('Data Jurnal Umum berhasil diubah.');
                    jurnalEditId = null;
                } else {
                    // --- TEMPAT INTEGRASI FIREBASE SAVE BARU ---
                    // Contoh: await addDoc(collection(db, 'jurnal'), dataToSave);
                    alert('Data Jurnal Umum berhasil disimpan.');
                }
                
                // Setelah operasi database berhasil:
                // await loadAllCollections();
                filterData('jurnal');
                clearInputFields('jurnal');
            }
        }
        
        function clearInputFields(module) {
            // ... (logika clear input)
            if (module === 'koin') {
                document.getElementById('koin-input-tanggal').value = '';
                document.getElementById('koin-input-petugas').value = '';
                document.getElementById('koin-input-hp').value = '';
                document.getElementById('koin-input-donatur').value = '';
                document.getElementById('koin-input-alamat').value = '';
                document.getElementById('koin-input-nominal').value = '';
                koinEditId = null;
            } else if (module === 'jurnal') {
                document.getElementById('jurnal-input-tanggal').value = '';
                document.getElementById('jurnal-input-keterangan').value = '';
                document.getElementById('jurnal-input-kategori').value = '';
                document.getElementById('jurnal-input-masuk').value = '';
                document.getElementById('jurnal-input-keluar').value = '';
                jurnalEditId = null;
            }
        }
        
        function editData(module, id) {
            // ... (logika edit data)
            if (module === 'koin') {
                const data = koinData.find(d => d.id === id);
                if (data) {
                    document.getElementById('koin-input-tanggal').value = data.tanggal;
                    document.getElementById('koin-input-petugas').value = data.petugas;
                    document.getElementById('koin-input-hp').value = data.hp;
                    document.getElementById('koin-input-donatur').value = data.donatur;
                    document.getElementById('koin-input-alamat').value = data.alamat;
                    document.getElementById('koin-input-nominal').value = data.nominal;
                    koinEditId = id;
                    alert('Mode Edit Data Koin NU (ID: ' + id + '). Silakan ubah data di formulir input di bawah.');
                }
            } else if (module === 'jurnal') {
                const data = jurnalData.find(d => d.id === id);
                if (data) {
                    document.getElementById('jurnal-input-tanggal').value = data.tanggal;
                    document.getElementById('jurnal-input-keterangan').value = data.keterangan;
                    document.getElementById('jurnal-input-kategori').value = data.kategori;
                    document.getElementById('jurnal-input-masuk').value = data.masuk;
                    document.getElementById('jurnal-input-keluar').value = data.keluar;
                    jurnalEditId = id;
                    alert('Mode Edit Data Jurnal Umum (ID: ' + id + '). Silakan ubah data di formulir input di bawah.');
                }
            }
            document.getElementById(`${module}-input-area`).scrollIntoView({ behavior: 'smooth' });
        }
        
        async function deleteData(module, id) {
            if (!confirm(`Yakin ingin menghapus data ${module} dengan ID: ${id}?`)) return;
            
            if (module === 'koin') {
                // --- TEMPAT INTEGRASI FIREBASE DELETE ---
                // Contoh: await deleteDoc(doc(db, 'koin', id));
                // koinData = koinData.filter(d => d.id !== id); // Dihapus, data akan dimuat ulang dari Firebase
                alert('Data Koin NU berhasil dihapus.');
            } else if (module === 'jurnal') {
                 // --- TEMPAT INTEGRASI FIREBASE DELETE ---
                 // Contoh: await deleteDoc(doc(db, 'jurnal', id));
                // jurnalData = jurnalData.filter(d => d.id !== id); // Dihapus
                alert('Data Jurnal Umum berhasil dihapus.');
            }
            
            // Setelah operasi database berhasil:
            // await loadAllCollections(); 
            filterData(module);
        }
        
        async function deleteAllDataGlobal(module) {
             if (!isLoggedIn) {
                alert('Anda harus Login sebagai admin untuk melakukan aksi ini.');
                return;
            }
            if (!confirm(`Yakin ingin menghapus SEMUA DATA ${module}? Tindakan ini tidak bisa dibatalkan.`)) return;

            if (module === 'koin') {
                // --- TEMPAT INTEGRASI FIREBASE: HAPUS SEMUA DOKUMEN KOIN ---
                alert('Logika Hapus Semua Data Koin perlu diimplementasikan menggunakan Firebase.');
                koinData = []; // Bersihkan lokal sementara
            } else if (module === 'jurnal') {
                // --- TEMPAT INTEGRASI FIREBASE: HAPUS SEMUA DOKUMEN JURNAL ---
                alert('Logika Hapus Semua Data Jurnal perlu diimplementasikan menggunakan Firebase.');
                jurnalData = []; // Bersihkan lokal sementara
            } else if (module === 'tahunan') {
                // --- TEMPAT INTEGRASI FIREBASE: HAPUS SEMUA DOKUMEN TAHUNAN ---
                alert('Logika Hapus Semua Data Tahunan perlu diimplementasikan menggunakan Firebase.');
                annualData = []; // Bersihkan lokal sementara
            }
            
            // Setelah operasi database berhasil:
            // await loadAllCollections(); 
            filterData(module);
            populateFilterOptions();
        }

        // --- JURNAL UMUM FUNCTIONS ---

        function updateMasukKeluarFields() {
            // ... (logika update field masuk/keluar)
            const kategori = document.getElementById('jurnal-input-kategori').value;
            const masukField = document.getElementById('jurnal-input-masuk');
            const keluarField = document.getElementById('jurnal-input-keluar');

            masukField.value = '';
            keluarField.value = '';
            masukField.disabled = false;
            keluarField.disabled = false;

            if (kategori) {
                const masukCategories = ['Koin NU', 'Donatur', 'Zakat Mall', 'Infaq', 'Shodaqoh', 'Saldo Bulan Lalu', 'Hasil Usaha'];
                
                if (masukCategories.includes(kategori)) {
                    keluarField.disabled = true;
                } else {
                    masukField.disabled = true;
                }
            }
        }

        function calculateJurnalSaldo(filteredData, year, month) {
             // ... (logika perhitungan saldo)
            let saldoAwal = 0;
            let totalMasuk = 0;
            let totalKeluar = 0;
            
            if (month !== 'all') {
                const saldoAwalAnnual = annualData.find(d => d.type === 'saldo_bulan_lalu_manual' && d.year === year && d.month === parseInt(month));
                saldoAwal = saldoAwalAnnual ? saldoAwalAnnual.nominal : 0;
            } else {
                const saldoAkhirTahunLalu = jurnalData.find(d => d.id === 300);
                saldoAwal = saldoAkhirTahunLalu ? saldoAkhirTahunLalu.masuk : 0;
            }

            if (saldoAwal > 0) {
                filteredData.unshift({
                    id: 'saldo_awal', 
                    tanggal: `${year}-${month.toString().padStart(2, '0')}-01`, 
                    keterangan: 'Saldo Bulan Lalu', 
                    kategori: 'Saldo Bulan Lalu', 
                    masuk: saldoAwal, 
                    keluar: 0, 
                    type: 'auto'
                });
            }
            
            let saldoBerjalan = saldoAwal;
            filteredData.forEach(d => {
                if (d.id === 'saldo_awal' && month !== 'all') return; 

                saldoBerjalan += d.masuk - d.keluar;
                d.saldo = saldoBerjalan;
                
                if (d.id !== 'saldo_awal') {
                    totalMasuk += d.masuk;
                    totalKeluar += d.keluar;
                }
            });

            return { totalMasuk, totalKeluar, saldoAkhir: saldoBerjalan };
        }

        function renderJurnalTable(data, monthFilter, yearFilter) {
            // ... (logika render tabel)
            const body = document.getElementById('jurnal-data-body');
            body.innerHTML = '';
            
            data.sort((a, b) => {
                const dateA = new Date(a.tanggal);
                const dateB = new Date(b.tanggal);
                if (dateA.getTime() === dateB.getTime()) {
                    return a.id - b.id; 
                }
                return dateA - dateB;
            });
            
            const { totalMasuk, totalKeluar, saldoAkhir } = calculateJurnalSaldo(data, yearFilter, monthFilter);

            data.forEach((d, index) => {
                const row = body.insertRow();
                row.innerHTML = `
                    <td>${d.id === 'saldo_awal' ? '' : index}</td>
                    <td>${formatTanggal(d.tanggal)}</td>
                    <td>${d.keterangan}</td>
                    <td>${d.kategori}</td>
                    <td class="money-col">${formatRupiah(d.masuk)}</td>
                    <td class="money-col">${formatRupiah(d.keluar)}</td>
                    <td class="money-col">${formatRupiah(d.saldo || (d.id === 'saldo_awal' ? d.masuk : 0))}</td>
                    <td style="display: ${isLoggedIn ? 'table-cell' : 'none'};" class="action-btns">
                        ${d.type === 'manual' && d.id !== 300 ? `<button class="button btn-blue" onclick="editData('jurnal', '${d.id}')">Edit</button>` : ''}
                        ${d.type === 'manual' && d.id !== 300 ? `<button class="button btn-red" onclick="deleteData('jurnal', '${d.id}')">Hapus</button>` : ''}
                    </td>
                `;
                 if (d.id === 'saldo_awal') {
                    row.classList.add('saldo-entry');
                } else if (d.type === 'auto') {
                    row.classList.add('auto-entry');
                } else if (d.type === 'manual') {
                    row.classList.add('manual-entry');
                }
            });
            
            document.getElementById('jurnal-total-masuk').innerText = formatRupiah(totalMasuk);
            document.getElementById('jurnal-total-keluar').innerText = formatRupiah(totalKeluar);
            document.getElementById('jurnal-saldo-akhir').innerText = formatRupiah(saldoAkhir);
            
            const periodDisplay = document.getElementById('jurnal-pdf-periode-display');
            if (monthFilter === 'all') {
                periodDisplay.innerText = `Tahun ${yearFilter}`;
            } else {
                periodDisplay.innerText = `${namaBulan[parseInt(monthFilter) - 1]} ${yearFilter}`;
            }

            document.getElementById('jurnal-ttd-tanggal-output').innerText = formatTanggalTTD();
        }

        // --- LAPORAN TAHUNAN FUNCTIONS ---

        function calculateAnnualData(year) {
             // ... (logika perhitungan tahunan)
            const annualReport = [];
            const months = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12];

            let cumulativeSaldoKas = 0; 
            let totalTahunan = {
                koin: 0, donatur: 0,
                pendidikan: { uang: 0, penerima: 0 },
                kesehatan: { uang: 0, penerima: 0 },
                ekonomi: { uang: 0, penerima: 0 },
                sosial: { uang: 0, penerima: 0 },
                banom: { uang: 0 },
                bencana: { uang: 0, penerima: 0 },
                honor: { petugas: 0, mwc: 0, pc: 0 },
                rapat: 0, perwtn_mlu: 0, biaya_rek_bank: 0, lain_lain: 0,
                pengeluaran: 0, saldo_akhir: 0, saldo_kas: 0
            };

            const saldoBank = annualData.find(d => d.id === `saldo_bank_${year}`);
            const saldoKas = annualData.find(d => d.id === `saldo_kas_${year}`);
            
            cumulativeSaldoKas = (saldoBank ? saldoBank.nominal : 0) + (saldoKas ? saldoKas.nominal : 0);

            months.forEach(month => {
                const bulan = namaBulan[month - 1];
                let row = { bulan: bulan, no: month, year: year };
                
                const monthlyKoin = koinData.filter(d => {
                    const date = new Date(d.tanggal);
                    return date.getFullYear() === year && date.getMonth() + 1 === month;
                });
                row.total_koin = monthlyKoin.reduce((sum, d) => sum + d.nominal, 0);
                totalTahunan.koin += row.total_koin;

                const monthlyJurnal = jurnalData.filter(d => {
                    const date = new Date(d.tanggal);
                    return date.getFullYear() === year && date.getMonth() + 1 === month;
                });

                const monthlyManual = annualData.find(d => d.type === 'monthly' && d.year === year && d.month === month) || {};
                
                const saldoBlnLaluManual = annualData.find(d => d.type === 'saldo_bulan_lalu_manual' && d.year === year && d.month === month);
                const saldoAwalBulan = saldoBlnLaluManual ? saldoBlnLaluManual.nominal : 0;
                
                row.donatur = monthlyManual.donatur || 0;
                totalTahunan.donatur += row.donatur;

                const getJurnalEntry = (cat) => monthlyJurnal.filter(d => d.kategori === cat).reduce((sum, d) => sum + d.keluar, 0);
                
                row.pendidikan = { uang: getJurnalEntry(categories.pendidikan), penerima: (monthlyManual.pendidikan || {}).penerima || 0 };
                row.kesehatan = { uang: getJurnalEntry(categories.kesehatan), penerima: (monthlyManual.kesehatan || {}).penerima || 0 };
                row.ekonomi = { uang: getJurnalEntry(categories.ekonomi), penerima: (monthlyManual.ekonomi || {}).penerima || 0 };
                row.sosial = { uang: getJurnalEntry(categories.sosial), penerima: (monthlyManual.sosial || {}).penerima || 0 };
                row.banom = { uang: getJurnalEntry(categories.banom), keterangan: (monthlyManual.banom || {}).keterangan || '' };
                row.bencana = { uang: getJurnalEntry(categories.bencana), penerima: (monthlyManual.bencana || {}).penerima || 0 };

                row.honor_petugas = getJurnalEntry(categories.honor_petugas);
                row.honor_mwc = getJurnalEntry(categories.honor_mwc);
                row.honor_pc = getJurnalEntry(categories.honor_pc);

                row.rapat = getJurnalEntry(categories.rapat);
                row.perwtn_mlu = getJurnalEntry(categories.perwtn_mlu);
                row.biaya_rek_bank = getJurnalEntry(categories.biaya_rek_bank);
                row.lain_lain_peng = getJurnalEntry(categories.lain_lain);

                const totalPenerimaan = row.total_koin + saldoAwalBulan; 
                
                row.total_pengeluaran = 
                    row.pendidikan.uang + row.kesehatan.uang + row.ekonomi.uang + row.sosial.uang + row.banom.uang + row.bencana.uang + 
                    row.honor_petugas + row.honor_mwc + row.honor_pc + 
                    row.rapat + row.perwtn_mlu + row.biaya_rek_bank + row.lain_lain_peng;

                row.saldo_akhir = totalPenerimaan - row.total_pengeluaran;
                
                if (month === 1) {
                    row.saldo_kas = cumulativeSaldoKas + row.saldo_akhir;
                } else {
                    const prevMonth = annualReport[month - 2];
                    row.saldo_kas = (prevMonth ? prevMonth.saldo_kas : cumulativeSaldoKas) + row.saldo_akhir;
                }
                
                cumulativeSaldoKas = row.saldo_kas;

                totalTahunan.pendidikan.uang += row.pendidikan.uang;
                totalTahunan.pendidikan.penerima += row.pendidikan.penerima;
                totalTahunan.kesehatan.uang += row.kesehatan.uang;
                totalTahunan.kesehatan.penerima += row.kesehatan.penerima;
                totalTahunan.ekonomi.uang += row.ekonomi.uang;
                totalTahunan.ekonomi.penerima += row.ekonomi.penerima;
                totalTahunan.sosial.uang += row.sosial.uang;
                totalTahunan.sosial.penerima += row.sosial.penerima;
                totalTahunan.banom.uang += row.banom.uang;
                totalTahunan.bencana.uang += row.bencana.uang;
                totalTahunan.bencana.penerima += row.bencana.penerima;
                totalTahunan.honor.petugas += row.honor_petugas;
                totalTahunan.honor.mwc += row.honor_mwc;
                totalTahunan.honor.pc += row.honor_pc;
                totalTahunan.rapat += row.rapat;
                totalTahunan.perwtn_mlu += row.perwtn_mlu;
                totalTahunan.biaya_rek_bank += row.biaya_rek_bank;
                totalTahunan.lain_lain += row.lain_lain_peng;
                totalTahunan.pengeluaran += row.total_pengeluaran;
                
                annualReport.push(row);
            });

            totalTahunan.saldo_akhir = annualReport.length > 0 ? annualReport[annualReport.length - 1].saldo_akhir : 0;
            totalTahunan.saldo_kas = cumulativeSaldoKas; 

            return { annualReport, totalTahunan, saldoBank: saldoBank ? saldoBank.nominal : 0, saldoKas: saldoKas ? saldoKas.nominal : 0 };
        }

        function renderAnnualTable(yearFilter) {
            // ... (logika render tabel)
            const body = document.getElementById('annual-data-body');
            body.innerHTML = '';
            
            const { annualReport, totalTahunan, saldoBank, saldoKas } = calculateAnnualData(yearFilter);

            // Baris 1: Saldo Bank
            let rowBank = body.insertRow();
            rowBank.classList.add('annual-saldo-row');
            rowBank.innerHTML = `
                <td>1</td>
                <td>Saldo Bank Tahun ${yearFilter}</td>
                <td class="money-col editable-cell" onclick="openAnnualEdit('saldo_bank_${yearFilter}', 'nominal', 'Saldo Bank', ${saldoBank}, false)">${formatRupiah(saldoBank)}</td>
                <td colspan="23" style="text-align: center;">-</td>
            `;

            // Baris 2: Saldo Kas
            let rowKas = body.insertRow();
            rowKas.classList.add('annual-saldo-row');
            rowKas.innerHTML = `
                <td>2</td>
                <td>Saldo Kas Tahun ${yearFilter}</td>
                <td class="money-col editable-cell" onclick="openAnnualEdit('saldo_kas_${yearFilter}', 'nominal', 'Saldo Kas', ${saldoKas}, false)">${formatRupiah(saldoKas)}</td>
                <td colspan="23" style="text-align: center;">-</td>
            `;

            // Baris 3: Total Saldo Awal
            let rowTotalSaldo = body.insertRow();
            rowTotalSaldo.classList.add('annual-total-row');
            rowTotalSaldo.innerHTML = `
                <td>3</td>
                <td class="total-label" style="text-align: left !important;">Total Saldo Awal</td>
                <td class="money-col">${formatRupiah(saldoBank + saldoKas)}</td>
                <td colspan="23" style="text-align: center;">-</td>
            `;
            
            // Baris 4: Header Bulanan
            let rowHeaderBln = body.insertRow();
            rowHeaderBln.classList.add('annual-sub-header');
            rowHeaderBln.innerHTML = `
                <td colspan="26" style="text-align: center;">DATA BULANAN</td>
            `;
            
            annualReport.forEach((d, index) => {
                const monthID = index + 1;
                
                const saldoBulanLaluData = annualData.find(ad => ad.type === 'saldo_bulan_lalu_manual' && ad.year === yearFilter && ad.month === monthID) || { nominal: 0 };
                const saldoBulanLalu = saldoBulanLaluData.nominal;

                let row = body.insertRow();
                row.innerHTML = `
                    <td>${index + 4}</td>
                    <td>${d.bulan}</td>
                    <td class="money-col koin-fixed-entry">${formatRupiah(d.total_koin)}</td>
                    
                    <td class="money-col annual-manual-input editable-cell" onclick="openAnnualEdit('monthly_${yearFilter}_${monthID}', 'donatur', 'Donatur Bulan ${d.bulan}', ${d.donatur}, false)">${d.donatur}</td>
                    
                    <td class="money-col koin-fixed-entry">${formatRupiah(d.pendidikan.uang)}</td>
                    <td class="annual-manual-input editable-cell" onclick="openAnnualEdit('monthly_${yearFilter}_${monthID}', 'pendidikan.penerima', 'Penerima Pendidikan Bulan ${d.bulan}', ${d.pendidikan.penerima}, false)">${d.pendidikan.penerima}</td>
                    
                    <td class="money-col koin-fixed-entry">${formatRupiah(d.kesehatan.uang)}</td>
                    <td class="annual-manual-input editable-cell" onclick="openAnnualEdit('monthly_${yearFilter}_${monthID}', 'kesehatan.penerima', 'Penerima Kesehatan Bulan ${d.bulan}', ${d.kesehatan.penerima}, false)">${d.kesehatan.penerima}</td>
                    
                    <td class="money-col koin-fixed-entry">${formatRupiah(d.ekonomi.uang)}</td>
                    <td class="annual-manual-input editable-cell" onclick="openAnnualEdit('monthly_${yearFilter}_${monthID}', 'ekonomi.penerima', 'Penerima Ekonomi Bulan ${d.bulan}', ${d.ekonomi.penerima}, false)">${d.ekonomi.penerima}</td>
                    
                    <td class="money-col koin-fixed-entry">${formatRupiah(d.sosial.uang)}</td>
                    <td class="annual-manual-input editable-cell" onclick="openAnnualEdit('monthly_${yearFilter}_${monthID}', 'sosial.penerima', 'Penerima Sosial Bulan ${d.bulan}', ${d.sosial.penerima}, false)">${d.sosial.penerima}</td>
                    
                    <td class="money-col koin-fixed-entry">${formatRupiah(d.banom.uang)}</td>
                    <td class="annual-manual-input editable-cell" onclick="openAnnualEdit('monthly_${yearFilter}_${monthID}', 'banom.keterangan', 'Ket. Subsidi Banom Bulan ${d.bulan}', '${d.banom.keterangan}', true)">${d.banom.keterangan || '-'}</td>
                    
                    <td class="money-col koin-fixed-entry">${formatRupiah(d.bencana.uang)}</td>
                    <td class="annual-manual-input editable-cell" onclick="openAnnualEdit('monthly_${yearFilter}_${monthID}', 'bencana.penerima', 'Penerima Bencana Bulan ${d.bulan}', ${d.bencana.penerima}, false)">${d.bencana.penerima}</td>
                    
                    <td class="money-col koin-fixed-entry">${formatRupiah(d.honor_petugas)}</td>
                    <td class="money-col koin-fixed-entry">${formatRupiah(d.honor_mwc)}</td>
                    <td class="money-col koin-fixed-entry">${formatRupiah(d.honor_pc)}</td>
                    
                    <td class="money-col koin-fixed-entry">${formatRupiah(d.rapat)}</td>
                    <td class="money-col koin-fixed-entry">${formatRupiah(d.perwtn_mlu)}</td>
                    <td class="money-col koin-fixed-entry">${formatRupiah(d.biaya_rek_bank)}</td>
                    <td class="money-col koin-fixed-entry">${formatRupiah(d.lain_lain_peng)}</td>
                    
                    <td class="money-col annual-total-row">${formatRupiah(d.total_pengeluaran)}</td>
                    
                    <td class="money-col annual-manual-input editable-cell" onclick="openAnnualEdit('saldo_bulan_lalu_manual_${yearFilter}_${monthID}', 'nominal', 'Saldo Bulan Lalu ${d.bulan}', ${saldoBulanLalu}, false)">${formatRupiah(d.saldo_akhir)}</td>
                    
                    <td class="money-col annual-total-row">${formatRupiah(d.saldo_kas)}</td>
                `;
            });
            
            document.getElementById('tahunan-total-koin').innerText = formatRupiah(totalTahunan.koin);
            document.getElementById('tahunan-total-donatur').innerText = totalTahunan.donatur;
            document.getElementById('tahunan-total-pend-uang').innerText = formatRupiah(totalTahunan.pendidikan.uang);
            document.getElementById('tahunan-total-pend-penerima').innerText = totalTahunan.pendidikan.penerima;
            document.getElementById('tahunan-total-kes-uang').innerText = formatRupiah(totalTahunan.kesehatan.uang);
            document.getElementById('tahunan-total-kes-penerima').innerText = totalTahunan.kesehatan.penerima;
            document.getElementById('tahunan-total-eko-uang').innerText = formatRupiah(totalTahunan.ekonomi.uang);
            document.getElementById('tahunan-total-eko-penerima').innerText = totalTahunan.ekonomi.penerima;
            document.getElementById('tahunan-total-sosial-uang').innerText = formatRupiah(totalTahunan.sosial.uang);
            document.getElementById('tahunan-total-sosial-penerima').innerText = totalTahunan.sosial.penerima;
            document.getElementById('tahunan-total-banom-uang').innerText = formatRupiah(totalTahunan.banom.uang);
            document.getElementById('tahunan-total-bencana-uang').innerText = formatRupiah(totalTahunan.bencana.uang);
            document.getElementById('tahunan-total-bencana-penerima').innerText = totalTahunan.bencana.penerima;
            document.getElementById('tahunan-total-honor-petugas').innerText = formatRupiah(totalTahunan.honor.petugas);
            document.getElementById('tahunan-total-honor-mwc').innerText = formatRupiah(totalTahunan.honor.mwc);
            document.getElementById('tahunan-total-honor-pc').innerText = formatRupiah(totalTahunan.honor.pc);
            document.getElementById('tahunan-total-rapat').innerText = formatRupiah(totalTahunan.rapat);
            document.getElementById('tahunan-total-perwtn-mlu').innerText = formatRupiah(totalTahunan.perwtn_mlu);
            document.getElementById('tahunan-total-biaya-rek-bank').innerText = formatRupiah(totalTahunan.biaya_rek_bank);
            document.getElementById('tahunan-total-lain-lain-peng').innerText = formatRupiah(totalTahunan.lain_lain);
            document.getElementById('tahunan-total-pengeluaran').innerText = formatRupiah(totalTahunan.pengeluaran);
            document.getElementById('tahunan-total-saldo-akhir').innerText = formatRupiah(totalTahunan.saldo_akhir);
            document.getElementById('tahunan-total-saldo-kas').innerText = formatRupiah(totalTahunan.saldo_kas);

            document.getElementById('tahunan-pdf-periode-display').innerText = `Tahun ${yearFilter}`;
            document.getElementById('tahunan-ttd-tanggal-output').innerText = formatTanggalTTD();
        }

        function openAnnualEdit(id, key, label, value, isText) {
            // ... (logika open edit form)
            if (!isLoggedIn) {
                alert('Anda harus Login sebagai admin untuk mengedit data ini.');
                return;
            }
            
            annualEditData = { id, key, isText };
            
            document.getElementById('annual-edit-label').value = label;
            document.getElementById('tahunan-edit-input-area').style.display = 'block';
            
            const nominalInput = document.getElementById('annual-edit-nominal');
            const keteranganInput = document.getElementById('annual-edit-keterangan-group');
            
            if (isText) {
                nominalInput.style.display = 'none';
                keteranganInput.style.display = 'block';
                document.getElementById('annual-edit-keterangan').value = value;
            } else {
                nominalInput.style.display = 'block';
                keteranganInput.style.display = 'none';
                nominalInput.value = value;
            }
            
            document.getElementById('tahunan-edit-input-area').scrollIntoView({ behavior: 'smooth' });
        }

        function cancelAnnualEdit() {
            document.getElementById('tahunan-edit-input-area').style.display = 'none';
            annualEditData = null;
        }
        
        async function saveAnnualReportData() {
            if (!annualEditData) return;
            
            let newValue;
            if (annualEditData.isText) {
                newValue = document.getElementById('annual-edit-keterangan').value;
            } else {
                newValue = parseInt(document.getElementById('annual-edit-nominal').value);
                if (isNaN(newValue)) {
                    alert('Nominal harus berupa angka.');
                    return;
                }
            }
            
            const { id, key } = annualEditData;
            
            let targetData;
            // Mencari atau membuat entri data tahunan yang akan disimpan ke Firebase
            if (id.startsWith('saldo')) {
                targetData = annualData.find(d => d.id === id);
            } else if (id.startsWith('monthly')) {
                const parts = id.split('_'); 
                const year = parseInt(parts[1]);
                const month = parseInt(parts[2]);
                targetData = annualData.find(d => d.type === 'monthly' && d.year === year && d.month === month);
            } else if (id.startsWith('saldo_bulan_lalu_manual')) {
                const parts = id.split('_');
                const year = parseInt(parts[4]);
                const month = parseInt(parts[5]);
                targetData = annualData.find(d => d.type === 'saldo_bulan_lalu_manual' && d.year === year && d.month === month);
            }
            
            if (!targetData) {
                alert('Data target untuk penyimpanan tidak ditemukan! Entri baru akan dibuat.');
                // Logika untuk membuat objek baru jika tidak ada.
                if (id.startsWith('saldo')) {
                    targetData = { id: id, type: id.split('_')[0], year: parseInt(id.split('_')[2]), nominal: 0 };
                    annualData.push(targetData);
                } else if (id.startsWith('monthly')) {
                    const parts = id.split('_'); 
                    targetData = { 
                        type: 'monthly', year: parseInt(parts[1]), month: parseInt(parts[2]), 
                        donatur: 0, pendidikan: { penerima: 0 }, sosial: { penerima: 0 }, 
                        kesehatan: { penerima: 0 }, ekonomi: { penerima: 0 }, banom: { keterangan: '' }, 
                        bencana: { penerima: 0 }, rapat: 0, perwtn_mlu: 0, biaya_rek_bank: 0, lain_lain_peng: 0
                    };
                    annualData.push(targetData);
                } else if (id.startsWith('saldo_bulan_lalu_manual')) {
                    const parts = id.split('_'); 
                    targetData = { type: 'saldo_bulan_lalu_manual', year: parseInt(parts[4]), month: parseInt(parts[5]), nominal: 0 };
                    annualData.push(targetData);
                }
            }
            
            // Update nilai di objek lokal
            let keys = key.split('.');
            let obj = targetData;
            for (let i = 0; i < keys.length - 1; i++) {
                obj = obj[keys[i]];
            }
            obj[keys[keys.length - 1]] = newValue; 

            // --- TEMPAT INTEGRASI FIREBASE SAVE/UPDATE ANNUAL DATA ---
            // Asumsi: annual data disimpan di koleksi 'annual' dan ID dokumen = ID tahun (misal '2025'). 
            // Namun karena datanya kompleks, anggap saja ada fungsi saveAllAnnualData(annualData)
            // Contoh: await saveAllAnnualData(annualData);
            
            alert('Data tahunan berhasil disimpan!');
            // Setelah operasi database berhasil:
            // await loadAllCollections(); 
            cancelAnnualEdit();
            filterData('tahunan'); 
        }
        
        // --- PDF DOWNLOAD FUNCTION ---
        
        function downloadPDF(module) {
            // ... (logika download PDF, tidak ada perubahan)
            const contentId = `${module}-pdf-content`;
            const ttdDateId = `${module}-ttd-date`;
            const ttdAreaId = `${module}-ttd-area`;

            const content = document.getElementById(contentId);
            
            const aksiHeader = document.getElementById(`${module}-aksi-header`);
            const totalAksi = document.getElementById(`${module}-total-aksi`);
            if (aksiHeader) aksiHeader.style.display = 'none';
            if (totalAksi) totalAksi.style.display = 'none';
            
            const adminControls = document.getElementById(`${module}-admin-controls`);
            if (adminControls) adminControls.style.display = 'none';
            
            document.getElementById(ttdDateId).style.display = 'block';
            document.getElementById(ttdAreaId).style.display = 'flex';
            
            if (module === 'koin') {
                document.getElementById('koin-hp-header').style.display = 'none';
                document.getElementById('koin-alamat-header').style.display = 'none';
                document.querySelectorAll('.koin-pembagian-header').forEach(el => el.style.display = 'none');
                document.querySelectorAll('.koin-pembagian-col').forEach(el => el.style.display = 'none');
                
                document.querySelectorAll('[id^="koin-hp-row-"]').forEach(el => el.style.display = 'none');
                document.querySelectorAll('[id^="koin-alamat-row-"]').forEach(el => el.style.display = 'none');
                
                document.getElementById('koin-total-label').colSpan = 4;
            }
            
            if (module === 'tahunan') {
                document.querySelectorAll('.editable-cell').forEach(el => el.style.borderBottom = 'none');
            }


            const { jsPDF } = window.jspdf;
            
            html2canvas(content, { scale: 2 }).then(canvas => {
                const imgData = canvas.toDataURL('image/png');
                const imgWidth = 297; 
                const pageHeight = 210; 
                const imgHeight = canvas.height * imgWidth / canvas.width;
                let heightLeft = imgHeight;

                const pdf = new jsPDF('l', 'mm', 'a4'); 
                let position = 0;

                pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                heightLeft -= pageHeight;

                while (heightLeft >= 0) {
                    position = heightLeft - imgHeight;
                    pdf.addPage();
                    pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;
                }

                pdf.save(`Laporan_${module}_${document.getElementById(`${module}-pdf-periode-display`).innerText.replace(/ /g, '_')}.pdf`);
                
                if (aksiHeader) aksiHeader.style.display = 'table-cell';
                if (totalAksi) totalAksi.style.display = 'table-cell';
                if (adminControls) adminControls.style.display = 'flex';
                document.getElementById(ttdDateId).style.display = 'none';
                document.getElementById(ttdAreaId).style.display = 'none';
                
                 if (module === 'koin') {
                    document.getElementById('koin-hp-header').style.display = 'table-cell';
                    document.getElementById('koin-alamat-header').style.display = 'table-cell';
                    document.querySelectorAll('.koin-pembagian-header').forEach(el => el.style.display = 'table-cell');
                    document.querySelectorAll('.koin-pembagian-col').forEach(el => el.style.display = 'table-cell');
                    
                    document.querySelectorAll('[id^="koin-hp-row-"]').forEach(el => el.style.display = 'table-cell');
                    document.querySelectorAll('[id^="koin-alamat-row-"]').forEach(el => el.style.display = 'table-cell');
                    document.getElementById('koin-total-label').colSpan = 6;
                }
                
                if (module === 'tahunan') {
                    document.querySelectorAll('.editable-cell').forEach(el => el.style.borderBottom = '1px dashed #007bff');
                }
            });
        }
        
        // --- INISIALISASI UTAMA (GANTI DARI INIT) ---
        // Anda harus mendefinisikan fungsi async loadAllCollections() di tempat lain (misal, file firebase-config.js)
        // yang mengisi variabel global koinData, jurnalData, dan annualData dari Firestore.

        window.addEventListener('DOMContentLoaded', async () => {
            // Catatan: Jika Anda telah mendefinisikan fungsi `loadAllCollections` (seperti yang terlihat di file Kakak sebelumnya), 
            // pastikan fungsi tersebut ada dan mengembalikan data yang benar.
            if (typeof loadAllCollections === 'function') {
                await loadAllCollections();
            } else {
                console.warn("Fungsi 'loadAllCollections' tidak ditemukan. Data akan kosong.");
            }
            
            // Asumsi: isLoggedIn diatur setelah login berhasil. Untuk kemudahan, kita atur default ke true.
            // Jika Anda menggunakan Firebase Auth, silakan tambahkan listener auth state di sini.
            isLoggedIn = true; 
            
            populateFilterOptions();
            showModule('koin');
        });
</script>
</body>
</html>


