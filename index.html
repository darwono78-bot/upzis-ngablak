<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Pembukuan UPZIS | Ranting Ngablak</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <script>
        // ðŸš¨ GANTI DENGAN KONFIGURASI UNIK ANDA ðŸš¨
        const firebaseConfig = {
            apiKey: "AIzaSyA_8NMmZBaXZ4H6KQt7rHy8G1URR3HLP3A",
            authDomain: "upzis-ngablak.firebaseapp.com",
            projectId: "upzis-ngablak",
            storageBucket: "upzis-ngablak.firebasestorage.app",
            messagingSenderId: "869549648344",
            appId: "1:869549648344:web:a531a37cce3a87bb672aad"
        };

        // Inisialisasi Firebase
        firebase.initializeApp(firebaseConfig);

        // Variabel global untuk layanan Firebase
        const db = firebase.firestore(); 
        const auth = firebase.auth();   
        let isLoggedIn = false;         
    </script>

    <style>
        /* Gaya CSS untuk Tampilan (Ini tetap sama dengan file Anda) */
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; padding: 0; background-color: #f4f7f6; color: #333; }
        .container { padding: 20px; max-width: 100%; margin: auto; }
        .navbar { background-color: #006400; color: white; padding: 10px 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.2); display: flex; align-items: center; justify-content: space-between; }
        .navbar-logo { font-size: 1.5rem; font-weight: bold; }
        .navbar-links button { background: none; border: none; color: white; padding: 8px 15px; cursor: pointer; font-size: 1rem; margin-left: 10px; transition: background-color 0.2s; }
        .navbar-links button:hover { background-color: #004d00; }
        .tab-button { background-color: #f0f0f0; color: #333; border: 1px solid #ccc; padding: 10px 15px; cursor: pointer; margin-right: 5px; border-radius: 5px 5px 0 0; }
        .tab-button.active { background-color: white; border-bottom: none; }
        .tab-content { background-color: white; padding: 20px; border: 1px solid #ccc; border-top: none; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; font-size: 12px; }
        th { background-color: #f2f2f2; font-weight: bold; }
        .action-btns button { margin-right: 5px; padding: 3px 8px; font-size: 10px; cursor: pointer; }
        .text-center { text-align: center; }
        .text-right { text-align: right; }
        .flex-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .form-group { margin-bottom: 10px; }
        input, select { padding: 8px; border: 1px solid #ccc; border-radius: 4px; width: 100%; box-sizing: border-box; }
        /* Gaya untuk Laporan Tahunan */
        .annual-report-title { text-align: center; margin-bottom: 20px; }
        .annual-report-title h2 { margin: 0; }
        .annual-report-title p { margin: 5px 0 0 0; font-size: 0.9em; }
        /* Gaya Area TTD */
        .ttd-area { display: none; margin-top: 50px; justify-content: space-around; font-size: 11px; }
        .ttd-block { text-align: center; }
        /* Overlay Login */
        .login-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.7); z-index: 1000; justify-content: center; align-items: center; }
        .login-box { background-color: white; padding: 30px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3); width: 300px; text-align: center; }
        .login-box input { margin-bottom: 15px; }
        .login-box button { width: 100%; }

    </style>
</head>
<body>

    <div class="navbar">
        <div class="navbar-logo">Sistem Pembukuan UPZIS Ranting Ngablak</div>
        <div class="navbar-links">
            <button id="nav-koin" onclick="showModule('koin')" class="active">Koin NU</button>
            <button id="nav-jurnal" onclick="showModule('jurnal')">Jurnal Manual</button>
            <button id="nav-tahunan" onclick="showModule('tahunan')">Laporan Tahunan</button>
            
            <button id="login-btn" onclick="showLoginOverlay()">Login Admin</button>
            <button id="logout-btn" onclick="logoutAdmin()" style="display: none;">Logout</button>
        </div>
    </div>

    <div id="login-overlay" class="login-overlay">
        <div class="login-box">
            <h3>Login Admin</h3>
            <p id="login-error" style="color: red; display: none;"></p>
            <input type="email" id="login-email" placeholder="Email Admin" required>
            <input type="password" id="login-password" placeholder="Password" required>
            <button onclick="loginAdmin()">Login</button>
        </div>
    </div>

    <div id="main-content" class="container" style="display: none;">

        <div id="koin-module" class="module-content">
            <div id="koin-data-table" class="table-responsive">
                <table>
                    <thead>
                        <tr>
                            <th id="koin-aksi-header" style="width: 100px;">Aksi</th>
                            <th>No.</th>
                            <th>Tanggal</th>
                            <th>Ranting</th>
                            <th>Koin (100%)</th>
                            <th>Ranting (60%)</th>
                            <th>Petugas (10%)</th>
                            <th>MWC (25%)</th>
                            <th>PC (5%)</th>
                        </tr>
                    </thead>
                    <tbody id="koin-table-body"></tbody>
                    <tfoot>
                        <tr>
                            <td colspan="4" class="text-right"><strong>TOTAL</strong></td>
                            <td class="text-right" id="koin-total-100">0</td>
                            <td class="text-right" id="koin-total-60">0</td>
                            <td class="text-right" id="koin-total-10">0</td>
                            <td class="text-right" id="koin-total-25">0</td>
                            <td class="text-right" id="koin-total-5">0</td>
                        </tr>
                    </tfoot>
                </table>
            </div>
            <button onclick="downloadPDF('koin')" style="margin-top: 15px;">Download PDF Laporan Koin</button>
            
            <div id="koin-ttd-area" class="ttd-area">
                <div class="ttd-block">
                    Ngablak, <span id="koin-ttd-tanggal-output"></span><br>
                    Ketua UPZIS Ranting<br><br><br><br>
                    (...............................)
                </div>
            </div>
        </div>

        <div id="jurnal-module" class="module-content" style="display: none;">
            <div id="jurnal-data-table" class="table-responsive">
                <table>
                    <thead>
                        <tr>
                            <th id="jurnal-aksi-header" style="width: 100px;">Aksi</th>
                            <th>No.</th>
                            <th>Tanggal</th>
                            <th>Kategori</th>
                            <th>Keterangan</th>
                            <th>Masuk (Rp)</th>
                            <th>Keluar (Rp)</th>
                            <th>Saldo (Rp)</th>
                        </tr>
                    </thead>
                    <tbody id="jurnal-table-body"></tbody>
                    <tfoot>
                        <tr>
                            <td colspan="4" class="text-right"><strong>TOTAL</strong></td>
                            <td class="text-right" id="jurnal-total-masuk">0</td>
                            <td class="text-right" id="jurnal-total-keluar">0</td>
                            <td class="text-right" id="jurnal-saldo-akhir">0</td>
                        </tr>
                    </tfoot>
                </table>
            </div>
            <button onclick="downloadPDF('jurnal')" style="margin-top: 15px;">Download PDF Laporan Jurnal</button>

            <div id="jurnal-ttd-area" class="ttd-area">
                <div class="ttd-block">
                    Ngablak, <span id="jurnal-ttd-tanggal-output"></span><br>
                    Ketua UPZIS Ranting<br><br><br><br>
                    (...............................)
                </div>
            </div>
        </div>

        <div id="tahunan-module" class="module-content" style="display: none;">
            <div id="tahunan-pdf-content">
                <div class="annual-report-title">
                    <h2>LAPORAN KEUANGAN TAHUNAN</h2>
                    <p>UPZIS NU Ranting Ngablak</p>
                    <p id="tahunan-periode"></p>
                </div>
                <button onclick="downloadPDF('tahunan')" style="margin-top: 15px;">Download PDF Laporan Tahunan</button>
                
                <div id="tahunan-ttd-area" class="ttd-area">
                    <div class="ttd-block">
                        Ngablak, <span id="tahunan-ttd-tanggal-output"></span><br>
                        Ketua UPZIS Ranting<br><br><br><br>
                        (...............................)
                    </div>
                </div>
            </div>
        </div>

    </div>
    <script>
        // --- KONSTANTA DAN INISIALISASI ---
        
        // Kunci Data untuk Firestore (dulu Local Storage)
        const KOIN_KEY = 'upzis_koin_data';
        const JURNAL_KEY = 'upzis_jurnal_data';
        const ANNUAL_KEY = 'upzis_annual_data';

        let koinData = [];
        let jurnalData = [];
        let annualData = [];
        let currentModule = 'koin';
        let currentMonth = new Date().getMonth() + 1;
        let currentYear = new Date().getFullYear();
        // let isLoggedIn = false; // Sudah dideklarasikan di bagian atas (kode Firebase)

        // --- FUNGSI AUTHENTICATION (TAHAP 4) ---

        function showLoginOverlay() {
            document.getElementById('login-overlay').style.display = 'flex';
            document.getElementById('login-error').style.display = 'none';
        }

        function showLoginPage() {
            document.getElementById('main-content').style.display = 'none';
            document.getElementById('login-btn').style.display = 'inline';
            document.getElementById('logout-btn').style.display = 'none';
            // Tampilkan pesan/halaman yang memberitahu harus login
        }

        function showMainContent() {
            document.getElementById('login-overlay').style.display = 'none';
            document.getElementById('main-content').style.display = 'block';
            document.getElementById('login-btn').style.display = 'none';
            document.getElementById('logout-btn').style.display = 'inline';
            // Pastikan data dimuat ulang setelah login
            init(true); 
        }

        async function checkLoginStatus() {
            return new Promise(resolve => {
                auth.onAuthStateChanged(user => {
                    if (user) {
                        isLoggedIn = true;
                        showMainContent();
                    } else {
                        isLoggedIn = false;
                        showLoginPage();
                    }
                    resolve(); 
                });
            });
        }

        function loginAdmin() {
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            const errorElement = document.getElementById('login-error');

            errorElement.style.display = 'none';

            auth.signInWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    // Berhasil login
                    isLoggedIn = true;
                    showMainContent();
                })
                .catch((error) => {
                    // Gagal login
                    errorElement.textContent = "Gagal Login: Email atau Password salah.";
                    errorElement.style.display = 'block';
                    console.error("Login Error:", error.message);
                });
        }

        function logoutAdmin() {
            auth.signOut().then(() => {
                isLoggedIn = false;
                showLoginPage();
                // Opsional: Clear data lokal setelah logout
                koinData = [];
                jurnalData = [];
                annualData = [];
                // Render ulang tabel kosong
                showModule(currentModule); 
            }).catch((error) => {
                console.error("Logout Error:", error);
                alert("Gagal logout. Coba lagi.");
            });
        }
        
        // --- FUNGSI UTILITY (LOAD/SAVE/FORMAT) --- 

        // ðŸŽ¯ TAHAP 3: FUNGSI LOAD DATA BARU (ASINKRON - FIREBASE) ðŸŽ¯
        function loadDataFromStorage(key, defaultData) {
            const docId = `data-${key.toLowerCase()}`;
            
            // Mengembalikan janji (Promise) yang menunggu data dari Firestore
            return db.collection("records").doc(docId).get()
                .then(doc => {
                    if (doc.exists && doc.data().records) {
                        console.log(`Data ${key} berhasil dimuat dari Firestore.`);
                        return doc.data().records;
                    } else {
                        console.log(`Dokumen ${key} tidak ditemukan di Firestore, menggunakan data default.`);
                        return defaultData;
                    }
                })
                .catch(error => {
                    console.error(`Gagal memuat data ${key}: `, error);
                    return defaultData; 
                });
        }

        // ðŸŽ¯ TAHAP 2: FUNGSI SAVE DATA BARU (FIREBASE) ðŸŽ¯
        function saveDataToStorage(key, data) {
            const docId = `data-${key.toLowerCase()}`; 

            // Mengirim data ke Koleksi "records"
            return db.collection("records").doc(docId).set({
                records: data,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp() 
            })
            .then(() => {
                // Berhasil disimpan
            })
            .catch((error) => {
                console.error(`Gagal menyimpan data ${key}: `, error);
                alert(`âŒ Gagal menyimpan data ${key}. Periksa koneksi internet dan izin Firebase.`);
            });
        }
        
        // 2. Format Rupiah (Tanpa Rp) (Ini dari kode lama Anda)
        function formatRupiah(angka) {
            // ... (implementasi formatRupiah)
            return 'Rp ' + angka.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
        }
        
        function formatTanggalTTD() {
            const date = new Date();
            const options = { day: 'numeric', month: 'long', year: 'numeric' };
            return date.toLocaleDateString('id-ID', options);
        }

        // --- FUNGSI PERHITUNGAN (Asumsi sudah ada di kode Anda) ---
        // (Seperti calculateKoinTotals, calculateJurnalTotals, dll.)

        // --- FUNGSI RENDER (Asumsi sudah ada di kode Anda) ---
        // (Seperti renderKoinTable, renderJurnalTable, generateAnnualReportData, dll.)

        // ... Sisa kode Anda yang lain (tambah data, hapus data, edit data, dll.) ...

        // Bagian 6 Anda (Lanjutan)
        
        // --- Update Footer Tahunan (Bagian 6) ---
        function updateAnnualFooter(total, dataToRender) {
             // ... Kode updateAnnualFooter Anda di sini ...
             const totalKoin = total.koin;
             const totalPengeluaran = total.totalPengeluaran;
             const saldoKasAkhir = total.saldoKasTahunBerjalan;

             document.getElementById('tahunan-total-koin').textContent = formatRupiah(totalKoin);
             document.getElementById('tahunan-total-donatur').textContent = total.donatur;
             
             document.getElementById('tahunan-total-pend-uang').textContent = formatRupiah(total.pendidikan.uang);
             document.getElementById('tahunan-total-kes-uang').textContent = formatRupiah(total.kesehatan.uang);
             document.getElementById('tahunan-total-eko-uang').textContent = formatRupiah(total.ekonomi.uang);
             document.getElementById('tahunan-total-sosial-uang').textContent = formatRupiah(total.sosial.uang);
             document.getElementById('tahunan-total-banom-uang').textContent = formatRupiah(total.banom.uang);
             document.getElementById('tahunan-total-bencana-uang').textContent = formatRupiah(total.bencana.uang);
             
             document.getElementById('tahunan-total-honor-petugas').textContent = formatRupiah(total.honor.petugas);
             document.getElementById('tahunan-total-honor-mwc').textContent = formatRupiah(total.honor.mwc);
             document.getElementById('tahunan-total-honor-pc').textContent = formatRupiah(total.honor.pc);
             document.getElementById('tahunan-total-rapat').textContent = formatRupiah(total.rapat);
             document.getElementById('tahunan-total-perwtn-mlu').textContent = formatRupiah(total.perwtn_mlu);
             document.getElementById('tahunan-total-biaya-rek-bank').textContent = formatRupiah(total.biaya_rek_bank);
             document.getElementById('tahunan-total-lain-lain-peng').textContent = formatRupiah(total.lain_lain_peng);
             
             document.getElementById('tahunan-total-pengeluaran').textContent = formatRupiah(total.totalPengeluaran);
             
             const totalPenerimaanCash = totalKoin - total.honor.petugas - total.honor.mwc - total.honor.pc; 
             const saldoAkhirTahun = totalPenerimaanCash - totalPengeluaran; 
             
             document.getElementById('tahunan-total-saldo-akhir').textContent = formatRupiah(saldoKasAkhir - (dataToRender[0].koinNominal + dataToRender[1].koinNominal));
             document.getElementById('tahunan-total-saldo-kas').textContent = formatRupiah(saldoKasAkhir);
        }
        
        // --- JURNAL INPUT UTILITY (Bagian 6) ---
        function updateMasukKeluarFields() {
             // ... Kode updateMasukKeluarFields Anda di sini ...
             const kategori = document.getElementById('jurnal-input-kategori').value;
             const masukField = document.getElementById('jurnal-input-masuk');
             const keluarField = document.getElementById('jurnal-input-keluar');

             const isDanaMasuk = ['Koin NU', 'Donatur', 'Zakat Mall', 'Infaq', 'Shodaqoh', 'Saldo Bulan Lalu', 'Hasil Usaha', 'Ranting (60%)'].includes(kategori);
             const isDanaKeluar = !isDanaMasuk;

             if (['Ranting (60%)', 'Petugas (10%)', 'MWC (25%)', 'PC (5%)'].includes(kategori)) {
                 // Hanya tampilkan dan disable input, tapi biarkan input diisi secara manual jika admin mau
             }

             if (isDanaMasuk) {
                 masukField.disabled = false;
                 keluarField.disabled = true;
                 keluarField.value = 0; // Set Keluar ke 0
             } else if (isDanaKeluar) {
                 masukField.disabled = true;
                 masukField.value = 0; // Set Masuk ke 0
                 keluarField.disabled = false;
             } else {
                 masukField.disabled = false;
                 keluarField.disabled = false;
             }
        }


        // --- PDF EXPORT (Bagian 6) ---
        function downloadPDF(module) {
             // ... Kode downloadPDF Anda di sini ...
             const contentId = `${module}-pdf-content`;
             const content = document.getElementById(contentId);
             if (!content) return;

             const actionHeader = document.getElementById(`${module}-aksi-header`);
             const actionCells = content.querySelectorAll('.action-btns');
             const ttdArea = document.getElementById(`${module}-ttd-area`);
             const ttdDate = document.getElementById(`${module}-ttd-date`);
             
             const originalDisplay = actionHeader ? actionHeader.style.display : 'none';
             if (actionHeader) actionHeader.style.display = 'none';
             actionCells.forEach(cell => cell.style.display = 'none');
             if (ttdArea) ttdArea.style.display = 'flex';
             if (ttdDate) ttdDate.style.display = 'block';
             if (ttdDate) document.getElementById(`${module}-ttd-tanggal-output`).textContent = formatTanggalTTD();

             let originalFontSize = content.style.fontSize;
             let originalTableFontSize = null;
             let originalTablePadding = null; 

             if (module === 'tahunan') {
                 const tableWrapper = content.querySelector('div[style*="overflow-x: auto"]');
                 if (tableWrapper) {
                     tableWrapper.style.overflowX = 'visible';
                 }
                 
                 content.style.fontSize = '5px'; 
                 const annualTable = content.querySelector('#annual-data-table');
                 if (annualTable) {
                      originalTableFontSize = annualTable.style.fontSize;
                      annualTable.style.fontSize = '5px'; 
                      
                      const firstCell = annualTable.querySelector('th, td');
                      if(firstCell) {
                          originalTablePadding = firstCell.style.padding;
                      }

                      annualTable.querySelectorAll('th, td').forEach(el => {
                          el.style.padding = '1px';
                      });
                 }
             }

             html2canvas(content, {
                 scale: 3, 
                 width: content.scrollWidth, 
                 windowWidth: content.scrollWidth,
             }).then(function(canvas) {
                 const { jsPDF } = window.jspdf;
                 const imgData = canvas.toDataURL('image/jpeg', 1.0);
                 
                 const pdf = new jsPDF('l', 'mm', 'a4'); 
                 const pdfWidth = pdf.internal.pageSize.getWidth(); 

                 const margin = 10;
                 const targetPdfWidth = pdfWidth - (2 * margin); 
                 
                 const imgHeight = canvas.height * targetPdfWidth / canvas.width; 

                 let heightLeft = imgHeight;
                 let position = margin;
                 
                 pdf.addImage(imgData, 'JPEG', margin, position, targetPdfWidth, imgHeight);
                 heightLeft -= pdf.internal.pageSize.getHeight();
                 
                 while (heightLeft >= 0) {
                     position = heightLeft - imgHeight + margin; 
                     pdf.addPage();
                     pdf.addImage(imgData, 'JPEG', margin, position, targetPdfWidth, imgHeight);
                     heightLeft -= pdf.internal.pageSize.getHeight();
                 }
                 
                 pdf.save(`Laporan_${module}_${new Date().toISOString().split('T')[0]}.pdf`);

                 // KEMBALIKAN PERUBAHAN SEMENTARA SETELAH SELESAI
                 if (module === 'tahunan') {
                     const currentWrapper = content.querySelector('div[style*="overflow-x: visible"]');
                     if (currentWrapper) {
                         currentWrapper.style.overflowX = 'auto'; 
                     }
                     content.style.fontSize = originalFontSize; 
                     const annualTable = content.querySelector('#annual-data-table');
                     if (annualTable) {
                          annualTable.style.fontSize = originalTableFontSize;
                          annualTable.querySelectorAll('th, td').forEach(el => {
                              el.style.padding = originalTablePadding || ''; 
                          });
                     }
                 }
                 
                 // Kembalikan tampilan setelah selesai
                 if (actionHeader) actionHeader.style.display = originalDisplay;
                 actionCells.forEach(cell => cell.style.display = isLoggedIn ? 'table-cell' : 'none');
                 if (ttdArea) ttdArea.style.display = 'none';
                 if (ttdDate) ttdDate.style.display = 'none';
             });
        }
        
        // ðŸŽ¯ TAHAP 3.1: INISIALISASI BARU (ASINKRON) ðŸŽ¯
        async function init(isReload = false) {
            // Cek status login hanya sekali saat window.onload, 
            // atau jika dipanggil setelah login/logout.
            if (!isReload) {
                 await checkLoginStatus();
            }
            
            if (isLoggedIn) {
                // 1. Load data dari Firebase secara asinkron (menggunakan 'await')
                try {
                    koinData = await loadDataFromStorage(KOIN_KEY, koinData);
                    jurnalData = await loadDataFromStorage(JURNAL_KEY, jurnalData);
                    annualData = await loadDataFromStorage(ANNUAL_KEY, annualData);
                    
                } catch (error) {
                    console.error("Gagal memuat semua data awal:", error);
                    alert("Aplikasi gagal memuat data dari database. Periksa koneksi internet.");
                }
            } else {
                // Jika tidak login, gunakan data kosong atau default
                koinData = [];
                jurnalData = [];
                annualData = [];
            }
            
            // 2. Isi Opsi Filter
            // Asumsi populateFilterOptions() ada dan berfungsi dengan data
            // populateFilterOptions(); 
            
            // 3. Tampilkan modul default ('koin')
            showModule(currentModule);
        }

        window.onload = init;
    </script>
</body>
</html>

