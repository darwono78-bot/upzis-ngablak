<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Input & Laporan KOIN NU Paling Detail (Firebase Auth)</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <style>
        body { font-family: Arial, sans-serif; padding: 0 0 80px 0; background-color: #f8f9fa; margin: 0; }
        h1, h2 { color: #006400; margin: 15px 0 10px 0;}
        
        /* CSS untuk Navbar */
        #main-nav { background-color: #006400; padding: 10px 20px; color: white; display: flex; justify-content: space-between; align-items: center; }
        #nav-menu { display: flex; list-style: none; padding: 0; margin: 0; }
        #nav-menu li { margin-left: 20px; }
        #nav-menu button { background: none; color: white; border: none; padding: 8px 15px; cursor: pointer; }
        #nav-menu button.active { background-color: #004d00; border-radius: 5px; }
        .module-section { margin: 20px; padding: 15px; border: 1px solid #ccc; background: white; }
        
        /* CSS untuk Login Bar */
        #login-container-bar {
            position: fixed; bottom: 0; left: 0; width: 100%; background-color: #e9ecef;
            border-top: 1px solid #ccc; padding: 10px 20px; display: flex;
            justify-content: space-between; align-items: center; box-shadow: 0 -2px 5px rgba(0,0,0,0.1);
        }
        #login-form-content-bar, #logout-form-content-bar { display: flex; align-items: center; gap: 10px; }
        .admin-only { display: none; }
        .text-right { text-align: right; }
        .text-center { text-align: center; }
        .saldo-awal-row { font-weight: bold; background-color: #f0f0f0; }
        .auto-transaction-row { background-color: #fffacd; }
        
        /* Input/Table styles */
        input[type="text"], input[type="number"], input[type="date"], select { padding: 5px; margin-right: 5px; border: 1px solid #ccc; }
        table { border-collapse: collapse; margin-top: 10px; }
        th, td { border: 1px solid #ddd; padding: 8px; font-size: 14px; }
        th { background-color: #f2f2f2; }
    </style>
</head>
<body>
    
    <nav id="main-nav">
        <h1>Sistem Laporan KOIN NU</h1>
        <ul id="nav-menu">
            <li><button id="nav-modul-1a" onclick="switchModule('modul-1a-section')" class="active">Modul 1A (Penerimaan Detail)</button></li>
            <li><button id="nav-modul-2" onclick="switchModule('modul-2-section')">Modul 2 (Jurnal Umum)</button></li>
            <li><button id="nav-modul-3" onclick="switchModule('modul-3-section')">Modul 3 (Laporan Tahunan)</button></li>
            <li><button id="nav-modul-1" onclick="switchModule('modul-1-section')">Modul 1 (Input Agregat)</button></li>
        </ul>
    </nav>
    
    <div id="report-container">
        
        <div style="display: flex; justify-content: center; align-items: center; margin-bottom: 10px;">
            <div style="width: 100px; height: 100px; margin-right: 15px; background-color: #006400;"></div>
            <div style="text-align: left;">
                <h2 style="margin: 0; color: #006400; font-size: 22px;">NU CARE UPZIS - LAZISNU RANTING NGABLAK</h2>
                <p style="margin: 0; font-size: 15px; color: #333;">Sekretariat: [Alamat Anda]</p>
            </div>
        </div>
        <hr style="border-top: 3px double #000; margin-top: 0px; margin-bottom: 20px;">
        
        <div style="margin-bottom: 15px; padding: 10px; border: 1px solid #eee; background-color: #fafafa;">
            Filter Laporan:
            <select id="filter-bulan-all" onchange="updateFilters('filter-bulan-all', this.value)"></select>
            <select id="filter-tahun-all" onchange="updateFilters('filter-tahun-all', this.value)"></select>
        </div>

        <div id="modul-1a-section" class="module-section" style="display: block;">
            <h2>Modul 1A: Input Transaksi KOIN NU Rinci</h2>
            
            <div id="m1a-input-form-container" class="admin-only" style="margin-bottom: 15px;">
                <input type="date" id="m1a-tanggal-input" required>
                <input type="text" id="m1a-nama-petugas-input" placeholder="Nama Petugas" required>
                <input type="text" id="m1a-no-hp-input" placeholder="No. HP">
                <input type="text" id="m1a-donatur-input" placeholder="Nama Donatur/KK" required>
                <input type="text" id="m1a-alamat-input" placeholder="Alamat/RT/RW" required>
                <input type="number" id="m1a-nominal-input" placeholder="Nominal (Rp)" min="1" required>
                <button onclick="addKoinNUTransaction()">Tambah Koin NU</button>
                <button onclick="clearKoinNUInputs()">Clear Form</button>
            </div>
            
            <table id="m1a-table" style="width: 100%; border-collapse: collapse;">
                <thead>
                    <tr>
                        <th style="width: 30px;">No</th><th>Tanggal</th><th>Petugas</th><th>No. HP</th><th>Donatur</th><th>Alamat</th><th>Nominal</th>
                        <th>Honor Petugas (10%)</th><th>Honor MWC (25%)</th><th>Honor PC (5%)</th><th>Kas Ranting (60%)</th>
                        <th id="th-m1a-aksi" style="width: 120px;">Aksi</th>
                    </tr>
                </thead>
                <tbody id="m1a-transaction-body"></tbody>
                <tfoot>
                    <tr>
                        <td colspan="6" class="text-right">TOTAL AKUMULASI:</td>
                        <td class="text-right" id="m1a-total-nominal">0</td>
                        <td class="text-right" id="m1a-total-petugas">0</td>
                        <td class="text-right" id="m1a-total-mwc">0</td>
                        <td class="text-right" id="m1a-total-pc">0</td>
                        <td class="text-right" id="m1a-total-ranting">0</td>
                        <td id="tf-m1a-aksi" style="display: none;"></td>
                    </tr>
                </tfoot>
            </table>
        </div>

        <div id="modul-2-section" class="module-section" style="display: none;">
            <h2>Modul 2: Jurnal Umum Kas</h2>
            <div id="m2-input-form-container" class="admin-only" style="margin-bottom: 15px;">
                <input type="date" id="m2-tanggal-input" required>
                <input type="text" id="m2-keterangan-input" placeholder="Keterangan Transaksi" required>
                <select id="m2-kategori-input" required>
                    </select>
                <input type="number" id="m2-debit-input" placeholder="Dana Masuk (Debit Rp)" min="0" value="0">
                <input type="number" id="m2-kredit-input" placeholder="Dana Keluar (Kredit Rp)" min="0" value="0">
                <button onclick="addManualTransaction()">Tambah Transaksi Lain</button>
                <button onclick="clearManualTransactionInputs()">Clear Form</button>
            </div>
            
            <table id="m2-table" style="width: 100%; border-collapse: collapse;">
                <thead>
                    <tr>
                        <th style="width: 30px;">No</th><th>Tanggal</th><th>Keterangan</th><th>Kategori</th>
                        <th style="width: 120px;">Debit (Rp)</th><th style="width: 120px;">Kredit (Rp)</th><th style="width: 120px;">Saldo (Rp)</th>
                        <th id="th-m2-aksi" style="width: 120px;">Aksi</th>
                    </tr>
                </thead>
                <tbody id="m2-transaction-body">
                    <tr class="saldo-awal-row">
                        <td colspan="6" class="text-right">SALDO AWAL KAS (Bank + Tunai):</td>
                        <td class="text-right">
                            <span id="m2-saldo-awal-static" style="display: none;">0</span>
                            <div id="m2-saldo-awal-display-container">
                                <input type="number" id="m2-saldo-awal-input" value="15000000" style="width: 80px; text-align: right; display: none;">
                                <span id="m2-saldo-awal-display">0</span>
                            </div>
                        </td>
                        <td id="td-m2-saldo-awal-aksi" style="display: none;"></td>
                    </tr>
                </tbody>
                <tfoot>
                    <tr>
                        <td colspan="4" class="text-right">TOTAL AKUMULASI:</td>
                        <td class="text-right" id="m2-total-masuk">0</td>
                        <td class="text-right" id="m2-total-keluar">0</td>
                        <td class="text-right" id="m2-footer-saldo-total">0</td>
                        <td id="tf-m2-aksi" style="display: none;"></td>
                    </tr>
                </tfoot>
            </table>
        </div>

        <div id="modul-3-section" class="module-section" style="display: none;">
            <h2>Modul 3: Laporan Tahunan</h2>
            </div>

        <div id="modul-1-section" class="module-section" style="display: none;">
            <h2>Modul 1: Input Data Agregat Bulanan (Manual)</h2>
            </div>

    </div>

    <div id="login-container-bar">
        <div id="logout-form-content-bar" style="display: none;">
            <p>Admin Aktif: <strong id="admin-status"></strong></p>
            <button onclick="resetAllData()" style="background-color: orange; color: white;">RESET SEMUA DATA</button>
            <button onclick="logout()" style="background-color: red; color: white;">LOGOUT</button>
        </div>
        
        <div id="login-form-content-bar">
            <label for="username">Email Admin:</label>
            <input type="email" id="username" placeholder="admin@domain.com">
            <label for="password">Password:</label>
            <input type="password" id="password" placeholder="******">
            <button onclick="login()" style="background-color: #006400; color: white;">LOGIN</button>
            <span id="login-message-bar" style="color: red;"></span>
        </div>
    </div>


    <script>
        // ===================================
        // --- FIREBASE SETUP ---
        // ===================================
        const firebaseConfig = {
            apiKey: "AIzaSyA_8NMmZBaXZ4H6KQt7rHy8G1URR3HLP3A",
            authDomain: "upzis-ngablak.firebaseapp.com",
            projectId: "upzis-ngablak",
            storageBucket: "upzis-ngablak.firebasestorage.app",
            messagingSenderId: "869549648344",
            appId: "1:869549648344:web:a531a37cce3a87bb672aad"
        };

        let db;
        let auth;
        let isLoggedIn = false;
        let currentAdminEmail = 'Belum Login';
        
        // --- MAPPING COLLECTION ---
        const M1A_COLLECTION = 'laporan_koin_nu'; 
        const M2_COLLECTION = 'jurnal_umum';     
        const M1_COLLECTION = 'laporan_tahunan'; 

        // ===================================
        // --- GLOBAL STATE ---
        // ===================================
        let m1aTransactions = [];
        let m2ManualTransactions = [];
        let initialData = []; 
        const months = ['Semua Bulan', 'Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni', 'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'];
        let currentFilterMonth = 0; 
        let currentFilterYear = new Date().getFullYear();
        let saldoBankAwal = 10000000;
        let saldoTunaiAwal = 5000000;
        const M2_CATEGORIES = ['Infaq dan Shodaqoh', 'Zakat', 'Dana Lain-lain Masuk', 'Pendidikan', 'Kesehatan', 'Sosial Umum', 'Banom', 'Penanggulangan Bencana', 'Biaya Rapat/Operasional', 'Perawatan Inventaris', 'Biaya Bank/Administrasi', 'Pengeluaran Lain-lain'];

        // ===================================
        // --- FIREBASE DATA HANDLING ---
        // ===================================
        
        async function loadDataFromFirebase() {
            try {
                const m1aSnapshot = await db.collection(M1A_COLLECTION).orderBy('date', 'asc').get();
                m1aTransactions = m1aSnapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data(),
                    nominal: parseFloat(doc.data().nominal || 0)
                }));

                const m2Snapshot = await db.collection(M2_COLLECTION).orderBy('date', 'asc').get();
                m2ManualTransactions = m2Snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data(),
                    debit: parseFloat(doc.data().debit || 0),
                    kredit: parseFloat(doc.data().kredit || 0)
                }));
                
                const m1Snapshot = await db.collection(M1_COLLECTION).orderBy('order', 'asc').get();
                if (!m1Snapshot.empty) {
                    initialData = m1Snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data(),
                        penerimaan: parseFloat(doc.data().penerimaan || 0),
                        pendUang: parseFloat(doc.data().pendUang || 0),
                        kesUang: parseFloat(doc.data().kesUang || 0),
                        ekoUang: parseFloat(doc.data().ekoUang || 0),
                        sosumUang: parseFloat(doc.data().sosumUang || 0),
                        banomUang: parseFloat(doc.data().banomUang || 0),
                        bencanaUang: parseFloat(doc.data().bencanaUang || 0),
                        rapat: parseFloat(doc.data().rapat || 0),
                        perwtnMlu: parseFloat(doc.data().perwtnMlu || 0),
                        biayaBank: parseFloat(doc.data().biayaBank || 0),
                        lainLain: parseFloat(doc.data().lainLain || 0),
                        honorWajibPercent: parseFloat(doc.data().honorWajibPercent || 0.40),
                        year: doc.data().year || new Date().getFullYear(),
                        // Pastikan semua field numerik di-parse
                    }));
                } else {
                    initialData = Array.from({ length: 12 }, (_, i) => ({ 
                        bulan: months[i + 1], 
                        order: i + 1, year: currentFilterYear, 
                        penerimaan: 0, donatur: 0, 
                        pendUang: 0, pendPenerima: 0, 
                        kesUang: 0, kesPenerima: 0, 
                        ekoUang: 0, ekoPenerima: 0, 
                        sosumUang: 0, sosumPenerima: 0, 
                        banomUang: 0, banomPenerima: 0, 
                        bencanaUang: 0, bencanaPenerima: 0, 
                        rapat: 0, perwtnMlu: 0, biayaBank: 0, lainLain: 0, 
                        honorWajibPercent: 0.40 
                    }));
                }
            } catch (error) {
                console.error("Error loading data from Firebase:", error);
                // Non-fatal error jika user belum login
            }
        }

        // ===================================
        // --- UTILITY & FILTERING LOGIC (DIPERBAIKI) ---
        // ===================================
        
        function formatNominal(number) {
            if (typeof number !== 'number') return '0';
            return number.toLocaleString('id-ID');
        }

        function getFilteredM1aTransactions() {
            const month = currentFilterMonth;
            const year = currentFilterYear;
            let filtered = m1aTransactions.filter(t => new Date(t.date).getFullYear() === year);
            if (month !== 0) {
                filtered = filtered.filter(t => new Date(t.date).getMonth() === (month - 1));
            }
            return filtered.sort((a, b) => new Date(a.date) - new Date(b.date));
        }

        function getFilteredM2ManualTransactions() {
            const month = currentFilterMonth;
            const year = currentFilterYear;
            let filtered = m2ManualTransactions.filter(t => new Date(t.date).getFullYear() === year);
            if (month !== 0) {
                filtered = filtered.filter(t => new Date(t.date).getMonth() === (month - 1));
            }
            return filtered.sort((a, b) => new Date(a.date) - new Date(b.date));
        }

        // FUNGSI INI WAJIB ADA DI GLOBAL SCOPE
        function switchModule(moduleID) {
            document.querySelectorAll('.module-section').forEach(section => { section.style.display = 'none'; });
            document.querySelectorAll('#nav-menu button').forEach(button => { button.classList.remove('active'); });
            document.getElementById(moduleID).style.display = 'block';
            document.getElementById('nav-' + moduleID.replace('-section', '')).classList.add('active');
            recalculateAllReports();
        }

        // FUNGSI INI WAJIB ADA DI GLOBAL SCOPE
        function populateFilters() {
            const monthSelects = document.querySelectorAll('[id^="filter-bulan-"]');
            monthSelects.forEach(select => {
                select.innerHTML = '';
                months.forEach((m, i) => {
                    const option = document.createElement('option');
                    option.value = i;
                    option.textContent = m;
                    select.appendChild(option);
                });
            });

            const yearSelects = document.querySelectorAll('[id^="filter-tahun-"]');
            yearSelects.forEach(select => {
                select.innerHTML = '';
                const currentYear = new Date().getFullYear();
                for (let y = currentYear - 2; y <= currentYear + 1; y++) {
                    const option = document.createElement('option');
                    option.value = y;
                    option.textContent = y;
                    select.appendChild(option);
                }
            });

            // Set current filters to the current global state
            monthSelects.forEach(select => select.value = currentFilterMonth);
            yearSelects.forEach(select => select.value = currentFilterYear);
        }

        // FUNGSI INI WAJIB ADA DI GLOBAL SCOPE
        function updateFilters(id, value) {
            const val = parseInt(value);
            if (id.includes('bulan')) {
                currentFilterMonth = val;
            } else if (id.includes('tahun')) {
                currentFilterYear = val;
            }
            const targetPrefix = id.includes('bulan') ? 'filter-bulan-' : 'filter-tahun-';
            document.querySelectorAll(`[id^="${targetPrefix}"]`).forEach(select => {
                select.value = val;
            });
            recalculateAllReports();
        }
        
        // ===================================
        // --- CRUD LOGIC (SIMPLIFIED FOR LENGTH) ---
        // ===================================

        async function addKoinNUTransaction() {
            if (!isLoggedIn) return alert('Anda harus login sebagai Admin untuk menambah data.');
            // [.. Logika ambil input, validasi ..]
            const newTx = { /* ... */ };
            try {
                await db.collection(M1A_COLLECTION).add(newTx);
                alert('Transaksi Koin NU berhasil ditambahkan ke Firebase!');
                await loadDataFromFirebase();
                recalculateAllReports();
            } catch (error) { console.error("Error: ", error); alert("Gagal menambahkan."); }
        }
        
        // ... (deleteKoinNUTxn, editKoinNUTxn, clearKoinNUInputs) ...
        function clearKoinNUInputs() { /* ... */ }
        function addManualTransaction() { /* ... */ }
        function clearManualTransactionInputs() { /* ... */ }
        function deleteKoinNUTxn(docId) { /* ... */ }
        function editKoinNUTxn(docId) { /* ... */ }
        function deleteManualTxn(docId) { /* ... */ }
        function editManualTxn(docId) { /* ... */ }
        function parseInput(id) { /* ... */ return 0; }
        function saveModul1Data(monthData) { /* ... */ }

        function getKoinNUAggregateData() {
            const filtered = getFilteredM1aTransactions();
            const totalNominal = filtered.reduce((sum, t) => sum + t.nominal, 0);
            const totalHonorPetugas = totalNominal * 0.10; 
            const totalHonorMWC = totalNominal * 0.25;     
            const totalHonorPC = totalNominal * 0.05;       
            const totalRanting = totalNominal - (totalHonorPetugas + totalHonorMWC + totalHonorPC); 
            return { totalNominal, totalHonorPetugas, totalHonorMWC, totalHonorPC, totalRanting };
        }

        // ===================================
        // --- RENDERING LOGIC (DIPERBAIKI) ---
        // ===================================

        function updatePenerimaanDetail() {
            const tableBody = document.getElementById('m1a-transaction-body');
            tableBody.innerHTML = '';
            const filtered = getFilteredM1aTransactions();
            const { totalNominal, totalHonorPetugas, totalHonorMWC, totalHonorPC, totalRanting } = getKoinNUAggregateData();
            const aksiVisibilityStyle = isLoggedIn ? '' : 'none';

            filtered.forEach((tx, index) => {
                const row = tableBody.insertRow();
                // Honor Otomatis dihitung per baris (Logika Hardcoded Asli)
                const honorPetugas = tx.nominal * 0.10;
                const honorMWC = tx.nominal * 0.25;
                const honorPC = tx.nominal * 0.05;
                const ranting = tx.nominal - (honorPetugas + honorMWC + honorPC);

                const actionButtons = `
                    <button class="action-btn edit-btn" onclick="editKoinNUTxn('${tx.id}')">Edit</button>
                    <button class="action-btn delete-btn" onclick="deleteKoinNUTxn('${tx.id}')">Hapus</button>
                `;
                
                row.innerHTML = `
                    <td class="text-center">${index + 1}</td>
                    <td>${tx.date}</td>
                    <td>${tx.petugas}</td>
                    <td>${tx.noHp}</td>
                    <td>${tx.donatur}</td>
                    <td>${tx.alamat}</td>
                    <td class="text-right">${formatNominal(tx.nominal)}</td>
                    <td class="text-right">${formatNominal(honorPetugas)}</td>
                    <td class="text-right">${formatNominal(honorMWC)}</td>
                    <td class="text-right">${formatNominal(honorPC)}</td>
                    <td class="text-right">${formatNominal(ranting)}</td>
                    <td class="text-center" style="display: ${aksiVisibilityStyle};">${actionButtons}</td>
                `;
            });

            document.getElementById('m1a-total-nominal').textContent = formatNominal(totalNominal);
            document.getElementById('m1a-total-petugas').textContent = formatNominal(totalHonorPetugas);
            document.getElementById('m1a-total-mwc').textContent = formatNominal(totalHonorMWC);
            document.getElementById('m1a-total-pc').textContent = formatNominal(totalHonorPC);
            document.getElementById('m1a-total-ranting').textContent = formatNominal(totalRanting);
            document.getElementById('th-m1a-aksi').style.display = aksiVisibilityStyle;
            document.getElementById('tf-m1a-aksi').style.display = aksiVisibilityStyle;
        }


        function updateJurnalUmum() {
            const tableBody = document.getElementById('m2-transaction-body');
            const rowsToRemove = tableBody.querySelectorAll('tr:not(.saldo-awal-row)');
            rowsToRemove.forEach(row => row.remove());

            let saldoAwal = parseFloat(document.getElementById('m2-saldo-awal-input').value || 0);
            let runningSaldo = saldoAwal;
            document.getElementById('m2-saldo-awal-display').textContent = formatNominal(saldoAwal);
            document.getElementById('m2-saldo-awal-static').textContent = formatNominal(saldoAwal);

            const aksiVisibilityStyle = isLoggedIn ? '' : 'none';
            const saldoAwalAksiTd = document.getElementById('td-m2-saldo-awal-aksi');
            if (saldoAwalAksiTd) { saldoAwalAksiTd.style.display = aksiVisibilityStyle; }

            // Logika Honor Otomatis (Persis Logika Hardcoded Anda)
            const koinNUData = getKoinNUAggregateData();
            const totalNominalKoin = koinNUData.totalNominal;
            const autoTransactions = [];
            
            if (totalNominalKoin > 0) {
                // Logika: Penerimaan 100% Koin NU masuk Debit, lalu 3 pengeluaran Honor/MWC/PC keluar Kredit. Sisanya (Ranting) menjadi Saldo.
                autoTransactions.push({ date: new Date().toISOString().split('T')[0], keterangan: 'Penerimaan Koin NU (100% dari Modul 1A)', kategori: 'Koin NU (Otomatis)', debit: totalNominalKoin, kredit: 0, isAuto: true });
                autoTransactions.push({ date: new Date().toISOString().split('T')[0], keterangan: 'Pengeluaran Honor Petugas (10%)', kategori: 'Honor Petugas (Otomatis)', debit: 0, kredit: koinNUData.totalHonorPetugas, isAuto: true });
                autoTransactions.push({ date: new Date().toISOString().split('T')[0], keterangan: 'Pengeluaran Honor MWC (25%)', kategori: 'Honor MWC (Otomatis)', debit: 0, kredit: koinNUData.totalHonorMWC, isAuto: true });
                autoTransactions.push({ date: new Date().toISOString().split('T')[0], keterangan: 'Pengeluaran Honor PC (5%)', kategori: 'Honor PC (Otomatis)', debit: 0, kredit: koinNUData.totalHonorPC, isAuto: true });
            } 
            
            const sortedManualTransactions = getFilteredM2ManualTransactions();
            const allTransactions = [...autoTransactions, ...sortedManualTransactions];

            let totalMasuk = 0;
            let totalKeluar = 0;

            allTransactions.forEach((tx, index) => {
                const row = tableBody.insertRow();
                row.classList.add(tx.isAuto ? 'auto-transaction-row' : '');

                runningSaldo += tx.debit - tx.kredit;
                totalMasuk += tx.debit;
                totalKeluar += tx.kredit;

                const actionButtons = tx.isAuto ? '-' : `
                    <button class="action-btn edit-btn" onclick="editManualTxn('${tx.id}')">Edit</button>
                    <button class="action-btn delete-btn" onclick="deleteManualTxn('${tx.id}')">Hapus</button>
                `;

                row.innerHTML = `
                    <td class="text-center">${index + 1}</td>
                    <td>${tx.date ? tx.date : '-'}</td>
                    <td>${tx.keterangan}</td>
                    <td>${tx.kategori}</td>
                    <td class="text-right">${formatNominal(tx.debit)}</td>
                    <td class="text-right">${formatNominal(tx.kredit)}</td>
                    <td class="text-right">${formatNominal(runningSaldo)}</td>
                    <td class="text-center" style="display: ${aksiVisibilityStyle};">${actionButtons}</td>
                `;
            });

            document.getElementById('m2-total-masuk').textContent = formatNominal(totalMasuk);
            document.getElementById('m2-total-keluar').textContent = formatNominal(totalKeluar);
            document.getElementById('m2-footer-saldo-total').textContent = formatNominal(runningSaldo);
            document.getElementById('th-m2-aksi').style.display = aksiVisibilityStyle;
            document.getElementById('tf-m2-aksi').style.display = aksiVisibilityStyle;
        }

        function updateModul1() {
            // Placeholder: Logika rendering Modul 1
        }

        function updateLaporanTahunan() {
            // Placeholder: Logika rendering Modul 3
        }

        // FUNGSI INI WAJIB ADA DI GLOBAL SCOPE
        async function recalculateAllReports() {
            updatePenerimaanDetail();
            updateJurnalUmum(); 
            updateModul1(); 
            updateLaporanTahunan();
        }

        // ===================================
        // --- ADMIN / AUTH LOGIC ---
        // ===================================
        
        // FUNGSI INI WAJIB ADA DI GLOBAL SCOPE
        async function login() {
            const emailInput = document.getElementById('username');
            const passwordInput = document.getElementById('password');
            const messageBar = document.getElementById('login-message-bar');

            const email = emailInput.value.trim();
            const password = passwordInput.value.trim();

            if (!email || !password) {
                 messageBar.textContent = 'Email dan Password wajib diisi.';
                 return;
            }

            messageBar.textContent = 'Loading...';
            
            try {
                const userCredential = await auth.signInWithEmailAndPassword(email, password);
                messageBar.textContent = 'Login berhasil! Memuat data...';
            } catch (error) {
                console.error("Login Error:", error);
                messageBar.textContent = `Login Gagal: ${error.message}`;
            }
        }

        // FUNGSI INI WAJIB ADA DI GLOBAL SCOPE
        function logout() {
            auth.signOut().then(() => {
            }).catch((error) => {
                console.error("Logout Error:", error);
            });
        }
        
        async function resetAllData() {
            if (!isLoggedIn) return;
            if (confirm("ANDA YAKIN INGIN MENGHAPUS SEMUA DATA TRANSAKSI (M1A & M2)?")) {
                alert("Simulasi penghapusan data... Selesaikan logika ini untuk menghapus data di Firebase!");
                await loadDataFromFirebase();
                recalculateAllReports();
            }
        }

        async function handleAuthStateChange(user) {
            const loginContainer = document.getElementById('login-form-content-bar');
            const logoutContainer = document.getElementById('logout-form-content-bar');
            const adminStatus = document.getElementById('admin-status');
            const adminElements = document.querySelectorAll('.admin-only');

            isLoggedIn = !!user;
            currentAdminEmail = user ? user.email : 'Belum Login';

            if (isLoggedIn) {
                loginContainer.style.display = 'none';
                logoutContainer.style.display = 'flex';
                adminStatus.textContent = currentAdminEmail;
                adminElements.forEach(el => el.style.display = 'block'); 
            } else {
                loginContainer.style.display = 'flex';
                logoutContainer.style.display = 'none';
                adminElements.forEach(el => el.style.display = 'none'); 
            }
        }

        // ===================================
        // --- ONLOAD FUNCTION ---
        // ===================================

        window.onload = async () => {
            // 1. Initialize Firebase
            firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            auth = firebase.auth(); 
            
            // 2. Populate Filters and Categories
            populateFilters(); // FIX: Sekarang populateFilters sudah didefinisikan di scope global
            const select = document.getElementById('m2-kategori-input');
            select.innerHTML = M2_CATEGORIES.map(cat => `<option value="${cat}">${cat}</option>`).join('');
            
            // 3. Firebase Auth State Listener
            auth.onAuthStateChanged(async (user) => {
                handleAuthStateChange(user); 
                
                if (user) {
                    await loadDataFromFirebase();
                } else {
                    m1aTransactions = [];
                    m2ManualTransactions = [];
                    initialData = [];
                }
                
                // Render view (based on the latest data and login status)
                recalculateAllReports(); 
            });

            // 4. Set default module
            switchModule('modul-1a-section'); 
        };
    </script>
</body>
</html>
