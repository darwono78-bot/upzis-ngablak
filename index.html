<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Pembukuan UPZIS | Ranting Ngablak</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <style>
        /* Gaya CSS untuk Tampilan */
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; padding: 0; background-color: #f4f7f6; color: #333; }
        .container { padding: 20px; max-width: 100%; margin: auto; }
        
        /* Gaya Navigasi */
        .navbar { background-color: #006400; color: white; padding: 10px 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.2); display: flex; align-items: center; justify-content: space-between; }
        .navbar-logo { font-size: 1.5rem; font-weight: bold; }
        .navbar-links button { background-color: #008000; color: white; border: none; padding: 8px 15px; margin-left: 10px; border-radius: 5px; cursor: pointer; transition: background-color 0.3s; }
        .navbar-links button:hover { background-color: #004d00; }

        /* Tabs */
        .tab-buttons { display: flex; margin-bottom: 20px; border-bottom: 2px solid #ccc; }
        .tab-button { padding: 10px 15px; cursor: pointer; border: none; background: transparent; transition: background-color 0.3s; font-weight: bold; color: #555; }
        .tab-button.active { border-bottom: 3px solid #006400; color: #006400; background-color: #e8f5e9; }
        .tab-content { display: none; padding: 15px 0; }
        .tab-content.active { display: block; }
        
        /* Area Input */
        .input-area, .filter-area { background-color: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .input-area h2, .filter-area h2 { border-bottom: 2px solid #eee; padding-bottom: 10px; margin-top: 0; color: #006400; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 600; }
        .form-group input, .form-group select { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        .form-group button { padding: 10px 20px; background-color: #006400; color: white; border: none; border-radius: 4px; cursor: pointer; transition: background-color 0.3s; margin-right: 10px; }
        .form-group button:hover { background-color: #004d00; }
        .form-group button.cancel { background-color: #f44336; }
        .form-group button.cancel:hover { background-color: #d32f2f; }
        
        /* Tabel */
        .table-wrapper { overflow-x: auto; margin-top: 20px; }
        .data-table { width: 100%; border-collapse: collapse; background-color: white; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .data-table th, .data-table td { border: 1px solid #ddd; padding: 10px; text-align: left; }
        .data-table th { background-color: #e8f5e9; color: #006400; font-weight: bold; text-transform: uppercase; }
        .data-table tr:nth-child(even) { background-color: #f9f9f9; }
        
        /* Tombol Aksi Tabel */
        .action-button { background-color: #2196F3; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; margin-right: 5px; transition: background-color 0.3s; font-size: 0.8rem; }
        .action-button.edit { background-color: #ff9800; }
        .action-button.delete { background-color: #f44336; }
        .action-button:hover { opacity: 0.8; }
        
        /* Saldo Total */
        .saldo-total { margin-top: 20px; padding: 15px; background-color: #006400; color: white; border-radius: 8px; font-size: 1.2rem; font-weight: bold; text-align: center; box-shadow: 0 4px 8px rgba(0,0,0,0.2); }
        .saldo-total span { font-size: 1.5rem; margin-left: 10px; }
        
        /* Export Button */
        .export-button { background-color: #4CAF50; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; margin-top: 10px; display: block; width: 100%; text-align: center; transition: background-color 0.3s; }
        .export-button:hover { background-color: #45a049; }
        
        /* Tabel Tahunan */
        .annual-summary { margin-top: 20px; padding: 20px; background-color: #fff; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .annual-summary h3 { color: #006400; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .summary-item { margin-bottom: 10px; font-size: 1.1rem; }
        .summary-item span { font-weight: bold; float: right; }

        /* Media Queries */
        @media (min-width: 768px) {
            .container { max-width: 90%; }
        }
    </style>
</head>
<body>

    <div class="navbar">
        <div class="navbar-logo">Pembukuan UPZIS Ranting Ngablak</div>
        <div class="navbar-links">
            <button onclick="exportToPDF()">Export Laporan</button>
        </div>
    </div>

    <div class="container">
        
        <div class="tab-buttons">
            <button class="tab-button active" onclick="changeTab('koin')">Pembukuan KOIN NU</button>
            <button class="tab-button" onclick="changeTab('jurnal')">Jurnal Umum</button>
            <button class="tab-button" onclick="changeTab('tahunan')">Laporan Tahunan</button> </div>

        <div id="koin-tab" class="tab-content active">
            
            <div id="koin-input-area" class="input-area">
                <h2>Input Data KOIN NU</h2>
                <form id="koin-form">
                    <input type="hidden" id="koin-id" value="">
                    <div class="form-group">
                        <label for="koin-input-tanggal">Tanggal</label>
                        <input type="date" id="koin-input-tanggal" required>
                    </div>
                    <div class="form-group">
                        <label for="koin-input-nama">Nama</label>
                        <input type="text" id="koin-input-nama" required>
                    </div>
                    <div class="form-group">
                        <label for="koin-input-jumlah">Jumlah (Rp)</label>
                        <input type="number" id="koin-input-jumlah" required min="1000">
                    </div>
                    <div class="form-group">
                        <label for="koin-input-keterangan">Keterangan</label>
                        <input type="text" id="koin-input-keterangan">
                    </div>
                    <div class="form-group">
                        <button type="submit">Simpan Data KOIN NU</button>
                        <button type="button" class="cancel" onclick="resetForm('koin')">Batal / Reset</button>
                    </div>
                </form>
            </div>

            <div class="filter-area">
                <h2>Filter dan Laporan KOIN NU</h2>
                <div class="form-group">
                    <label for="koin-filter-bulan">Filter Bulan</label>
                    <select id="koin-filter-bulan" onchange="filterData('koin')"></select>
                </div>
                <div class="saldo-total" id="koin-saldo">Total Saldo KOIN NU: <span>Rp 0</span></div>
            </div>

            <div class="table-wrapper">
                <table id="koin-table" class="data-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Tanggal</th>
                            <th>Nama</th>
                            <th>Jumlah (Rp)</th>
                            <th>Keterangan</th>
                            <th>Aksi</th>
                        </tr>
                    </thead>
                    <tbody>
                        </tbody>
                </table>
            </div>
            
        </div>

        <div id="jurnal-tab" class="tab-content">

            <div id="jurnal-input-area" class="input-area">
                <h2>Input Data Jurnal Umum</h2>
                <form id="jurnal-form">
                    <input type="hidden" id="jurnal-id" value="">
                    <div class="form-group">
                        <label for="jurnal-input-tanggal">Tanggal</label>
                        <input type="date" id="jurnal-input-tanggal" required>
                    </div>
                    <div class="form-group">
                        <label for="jurnal-input-kategori">Kategori</label>
                        <select id="jurnal-input-kategori" onchange="updateJurnalJenis()" required>
                            <option value="">Pilih Kategori</option>
                            <option value="Saldo Bulan Lalu">Saldo Bulan Lalu (Hanya di Awal)</option>
                            <option value="Infaq Kotak">Infaq Kotak (Penerimaan)</option>
                            <option value="Penerimaan Lain">Penerimaan Lain</option>
                            <option value="Penyaluran Santunan">Penyaluran Santunan (Pengeluaran)</option>
                            <option value="Biaya Operasional">Biaya Operasional (Pengeluaran)</option>
                            <option value="Pengeluaran Lain">Pengeluaran Lain</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="jurnal-input-uraian">Uraian</label>
                        <input type="text" id="jurnal-input-uraian" required>
                    </div>
                    <div class="form-group">
                        <label for="jurnal-input-jenis">Jenis</label>
                        <select id="jurnal-input-jenis" disabled required>
                            <option value="masuk">Pemasukan (Debet)</option>
                            <option value="keluar">Pengeluaran (Kredit)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="jurnal-input-jumlah">Jumlah (Rp)</label>
                        <input type="number" id="jurnal-input-jumlah" required min="1">
                    </div>
                    <div class="form-group">
                        <button type="submit">Simpan Data Jurnal</button>
                        <button type="button" class="cancel" onclick="resetForm('jurnal')">Batal / Reset</button>
                    </div>
                </form>
            </div>

            <div class="filter-area">
                <h2>Filter dan Laporan Jurnal Umum</h2>
                <div class="form-group">
                    <label for="jurnal-filter-bulan">Filter Bulan</label>
                    <select id="jurnal-filter-bulan" onchange="filterData('jurnal')"></select>
                </div>
                <div class="saldo-total" id="jurnal-saldo">Total Saldo Kas: <span>Rp 0</span></div>
            </div>

            <div class="table-wrapper">
                <table id="jurnal-table" class="data-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Tanggal</th>
                            <th>Kategori</th>
                            <th>Uraian</th>
                            <th>Jenis</th>
                            <th>Debet (Masuk)</th>
                            <th>Kredit (Keluar)</th>
                            <th>Aksi</th>
                        </tr>
                    </thead>
                    <tbody>
                        </tbody>
                </table>
            </div>
        </div>
        
        <div id="tahunan-tab" class="tab-content">
            <div class="annual-summary">
                <h2>Laporan Ringkasan Tahunan UPZIS</h2>
                <div class="form-group">
                    <label for="tahunan-filter-tahun">Filter Tahun</label>
                    <select id="tahunan-filter-tahun" onchange="updateAnnualTable()"></select>
                </div>

                <h3>Ringkasan Keuangan</h3>
                <div class="summary-item">Total Penerimaan (Masuk): <span id="annual-total-debet">Rp 0</span></div>
                <div class="summary-item">Total Pengeluaran (Keluar): <span id="annual-total-kredit">Rp 0</span></div>
                <div class="saldo-total" id="annual-saldo-kas">Total Saldo Akhir Kas: <span>Rp 0</span></div>

                <h3>Rincian Pembagian Dana Zakat (berdasarkan Penerimaan Infaq Kotak)</h3>
                <div class="summary-item">Penerimaan Infaq Kotak Bersih: <span id="annual-infaq-kotak-bersih">Rp 0</span></div>
                
                <hr style="margin: 15px 0;">
                <div class="summary-item" style="color:#006400; font-size:1.2rem;">TOTAL ALOKASI ZAKAT: <span id="annual-total-alokasi">Rp 0</span></div>
                <hr style="margin: 15px 0;">

                <div class="summary-item">10% untuk Yatim/Piatu: <span id="annual-alokasi-yatim">Rp 0</span></div>
                <div class="summary-item">60% untuk Fakir Miskin: <span id="annual-alokasi-fakir">Rp 0</span></div>
                <div class="summary-item">25% untuk Operasional: <span id="annual-alokasi-operasional">Rp 0</span></div>
                <div class="summary-item">5% untuk Infaq (Diutamakan): <span id="annual-alokasi-infaq">Rp 0</span></div>

                <p style="margin-top: 20px;">*Pembagian dana dihitung berdasarkan persentase dari total penerimaan kategori "Infaq Kotak".</p>
            </div>
        </div>

    </div>

    <script>
        // Data Global (sekarang akan diisi dari Firebase)
        let koinData = [];
        let jurnalData = [];
        let annualData = []; // Dikembalikan
        let koinEditId = null; // ID dokumen Firebase (string)
        let jurnalEditId = null; // ID dokumen Firebase (string)
        const categories = [
            'Saldo Bulan Lalu', 'Infaq Kotak', 'Penerimaan Lain', 
            'Penyaluran Santunan', 'Biaya Operasional', 'Pengeluaran Lain'
        ];

        // ==========================================================
        // BARU: SETUP FIREBASE & INISIALISASI
        // ==========================================================
        const firebaseConfig = {
            apiKey: "AIzaSyA_8NMmZBaXZ4H6KQt7rHy8G1URR3HLP3A",
            authDomain: "upzis-ngablak.firebaseapp.com",
            projectId: "upzis-ngablak",
            storageBucket: "upzis-ngablak.firebasestorage.app",
            messagingSenderId: "869549648344",
            appId: "1:869549648344:web:a531a37cce3a87bb672aad"
        };

        // Inisialisasi Aplikasi dan Database
        const app = firebase.initializeApp(firebaseConfig);
        const db = app.firestore(); // Inisialisasi Cloud Firestore

        // Referensi Koleksi Firestore
        const koinCollection = db.collection('koinData');
        const jurnalCollection = db.collection('jurnalData');
        // ==========================================================

        /**
         * FUNGSI BARU: Mengambil data dari koleksi Firestore (ASINKRON)
         */
        async function getFirebaseData(moduleName) {
            let collectionRef = moduleName === 'koin' ? koinCollection : jurnalCollection;
            try {
                // Ambil semua dokumen
                const snapshot = await collectionRef.get();
                let dataArray = [];
                snapshot.forEach(doc => {
                    // Menggunakan ID dokumen Firestore (string) sebagai properti 'id' data
                    dataArray.push({ id: doc.id, ...doc.data() });
                });
                return dataArray;
            } catch (error) {
                console.error(`Gagal mengambil data ${moduleName} dari Firebase:`, error);
                return [];
            }
        }
        
        // ==========================================================
        // FUNGSI UTAMA (INIT)
        // ==========================================================
        
        // UBAH: Tambahkan kata kunci 'async' dan gunakan await
        async function init() {
            // Mengisi data dari Firebase (menggantikan LocalStorage)
            koinData = await getFirebaseData('koin');
            jurnalData = await getFirebaseData('jurnal');
            
            filterData('koin');
            filterData('jurnal');
            setupFilters();
            setupAnnualFilter(); // Panggil fungsi setup filter tahunan
            checkInitialSaldo();
            updateAnnualTable(); // Panggil update laporan tahunan
            
            document.getElementById('koin-form').addEventListener('submit', function(e) {
                e.preventDefault();
                saveData('koin');
            });
            document.getElementById('jurnal-form').addEventListener('submit', function(e) {
                e.preventDefault();
                saveData('jurnal');
            });
            
            updateKoinTable();
            updateJurnalTable();
        }

        // ==========================================================
        // FUNGSI CRUD (CREATE/UPDATE)
        // ==========================================================
        
        // UBAH: Tambahkan kata kunci 'async'
        async function saveData(moduleName) {
            let newData = {};
            
            if (moduleName === 'koin') {
                const id = koinEditId || null;
                const tanggal = document.getElementById('koin-input-tanggal').value;
                const nama = document.getElementById('koin-input-nama').value;
                const jumlah = parseInt(document.getElementById('koin-input-jumlah').value);
                const keterangan = document.getElementById('koin-input-keterangan').value;

                if (!tanggal || !nama || !jumlah) {
                    alert('Semua kolom wajib diisi (Kecuali Keterangan).');
                    return;
                }
                
                newData = { id: id, tanggal: tanggal, nama: nama, jumlah: jumlah, keterangan: keterangan, timestamp: firebase.firestore.FieldValue.serverTimestamp() };
                
            } else if (moduleName === 'jurnal') {
                const id = jurnalEditId || null;
                const tanggal = document.getElementById('jurnal-input-tanggal').value;
                const kategori = document.getElementById('jurnal-input-kategori').value;
                const uraian = document.getElementById('jurnal-input-uraian').value;
                const jenis = document.getElementById('jurnal-input-jenis').value;
                const jumlah = parseInt(document.getElementById('jurnal-input-jumlah').value);

                if (!tanggal || !kategori || !uraian || !jumlah) {
                    alert('Semua kolom wajib diisi.');
                    return;
                }

                // Cek Saldo Bulan Lalu
                if (kategori === 'Saldo Bulan Lalu') {
                    const saldoAwal = jurnalData.find(d => d.kategori === 'Saldo Bulan Lalu');
                    if (saldoAwal && id !== saldoAwal.id) {
                         alert('Hanya boleh ada satu entri "Saldo Bulan Lalu". Silakan edit entri yang sudah ada.');
                         return;
                    }
                    if (jenis !== 'masuk') {
                        alert('"Saldo Bulan Lalu" harus bertipe Pemasukan (Masuk/Debet).');
                        return;
                    }
                }
                
                newData = { id: id, tanggal: tanggal, kategori: kategori, uraian: uraian, jenis: jenis, jumlah: jumlah, timestamp: firebase.firestore.FieldValue.serverTimestamp() };
            }
            
            // Siapkan variabel Firebase
            let collectionRef, editIdVar;
            if (moduleName === 'koin') {
                collectionRef = koinCollection;
                editIdVar = koinEditId; 
            } else if (moduleName === 'jurnal') {
                collectionRef = jurnalCollection;
                editIdVar = jurnalEditId;
            }

            try {
                if (editIdVar !== null) {
                    // KASUS 1: PERBARUI DATA (ID sekarang adalah ID Dokumen Firestore string)
                    delete newData.id; // Hapus properti ID dari data yang diupdate
                    await collectionRef.doc(editIdVar).update(newData);
                    alert(`Data ${moduleName.toUpperCase()} berhasil diupdate!`);
                    
                } else {
                    // KASUS 2: TAMBAH DATA BARU (Firebase membuat ID secara otomatis)
                    delete newData.id; // ID lama (integer) dihapus
                    await collectionRef.add(newData);
                    alert(`Data ${moduleName.toUpperCase()} baru berhasil disimpan.`);
                }

                // Muat ulang data dari Firebase
                await refreshAndFilter(moduleName); 
                
            } catch (error) {
                console.error(`Gagal menyimpan data ${moduleName} ke Firebase:`, error);
                alert(`Gagal menyimpan data ${moduleName}. Lihat konsol untuk detailnya.`);
            }

            resetForm(moduleName);
        }

        /**
         * FUNGSI BARU: Muat ulang data dari Firebase setelah operasi CUD berhasil.
         */
        async function refreshAndFilter(moduleName) {
            if (moduleName === 'koin') {
                koinData = await getFirebaseData('koin');
                filterData('koin');
            } else if (moduleName === 'jurnal') {
                jurnalData = await getFirebaseData('jurnal');
                filterData('jurnal');
                checkInitialSaldo();
                updateAnnualTable(); // PENTING: Update laporan tahunan setelah jurnal diubah
            }
        }
        
        // ==========================================================
        // FUNGSI CRUD (EDIT)
        // ==========================================================

        function editData(moduleName, id) {
            if (id === 'new-saldo-awal') {
                alert('Silakan gunakan tombol "Tambah Data" untuk membuat entri Saldo Bulan Lalu yang baru.');
                return;
            }
            
            let data;
            if (moduleName === 'koin') {
                data = koinData.find(d => d.id === id); // ID (string) comparison
            } else {
                data = jurnalData.find(d => d.id === id); // ID (string) comparison
            }
            
            if (data) {
                if (moduleName === 'koin') {
                    document.getElementById('koin-input-tanggal').value = data.tanggal;
                    document.getElementById('koin-input-nama').value = data.nama;
                    document.getElementById('koin-input-jumlah').value = data.jumlah;
                    document.getElementById('koin-input-keterangan').value = data.keterangan;
                    koinEditId = data.id; 
                    window.scrollTo(0, document.getElementById('koin-input-area').offsetTop);
                } else if (moduleName === 'jurnal') {
                    document.getElementById('jurnal-input-tanggal').value = data.tanggal;
                    document.getElementById('jurnal-input-kategori').value = data.kategori;
                    document.getElementById('jurnal-input-uraian').value = data.uraian;
                    document.getElementById('jurnal-input-jenis').value = data.jenis;
                    document.getElementById('jurnal-input-jumlah').value = data.jumlah;

                    // Khusus untuk Saldo Bulan Lalu, nonaktifkan kategori dan jenis
                    if (data.kategori === 'Saldo Bulan Lalu') {
                         document.getElementById('jurnal-input-jenis').disabled = true;
                         document.getElementById('jurnal-input-kategori').disabled = true;
                    } else {
                         document.getElementById('jurnal-input-jenis').disabled = false;
                         document.getElementById('jurnal-input-kategori').disabled = false;
                    }
                    
                    jurnalEditId = data.id; 
                    window.scrollTo(0, document.getElementById('jurnal-input-area').offsetTop);
                }
            }
        }

        // ==========================================================
        // FUNGSI CRUD (DELETE)
        // ==========================================================

        // UBAH: Tambahkan kata kunci 'async'
        async function deleteData(moduleName, id) {
            if (id === null || id === undefined || id === 'new-saldo-awal') return;
            
            const docId = id; // 'id' sekarang adalah ID Dokumen Firebase (string)

            if (moduleName === 'jurnal') {
                // Perlu ambil data dari Firebase untuk validasi kategori
                try {
                    const doc = await jurnalCollection.doc(docId).get();
                    const dataToDelete = doc.data();
                    if (dataToDelete && dataToDelete.kategori === 'Saldo Bulan Lalu') {
                         alert('Entri Saldo Bulan Lalu adalah baris kunci dan tidak dapat dihapus, hanya dapat diubah (Edit).');
                         return;
                    }
                } catch (error) {
                     console.error("Gagal memeriksa data sebelum hapus:", error);
                     alert("Gagal memverifikasi data. Operasi hapus dibatalkan.");
                     return;
                }
            }

            if (confirm('Yakin ingin menghapus data ini?')) {
                let collectionRef = moduleName === 'koin' ? koinCollection : jurnalCollection;
                try {
                    // Panggil operasi HAPUS di Firebase
                    await collectionRef.doc(docId).delete();
                    alert(`Data ${moduleName.toUpperCase()} berhasil dihapus.`);

                    // Muat ulang data setelah penghapusan
                    await refreshAndFilter(moduleName);

                } catch (error) {
                    console.error(`Gagal menghapus data ${moduleName} dari Firebase:`, error);
                    alert(`Gagal menghapus data ${moduleName}. Lihat konsol untuk detailnya.`);
                }
            }
        }
        
        // ==========================================================
        // FUNGSI UTILITY & UI (TETAP SAMA/MINIMAL PERUBAHAN)
        // ==========================================================

        function formatRupiah(number) {
            return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(number);
        }

        function resetForm(moduleName) {
            if (moduleName === 'koin') {
                document.getElementById('koin-form').reset();
                koinEditId = null;
            } else if (moduleName === 'jurnal') {
                document.getElementById('jurnal-form').reset();
                document.getElementById('jurnal-input-jenis').disabled = true; // Kembali ke default disabled
                document.getElementById('jurnal-input-kategori').disabled = false;
                jurnalEditId = null;
            }
        }

        function updateJurnalJenis() {
            const kategori = document.getElementById('jurnal-input-kategori').value;
            const jenisInput = document.getElementById('jurnal-input-jenis');

            if (kategori === 'Infaq Kotak' || kategori === 'Penerimaan Lain' || kategori === 'Saldo Bulan Lalu') {
                jenisInput.value = 'masuk';
                jenisInput.disabled = true;
            } else if (kategori === 'Penyaluran Santunan' || kategori === 'Biaya Operasional' || kategori === 'Pengeluaran Lain') {
                jenisInput.value = 'keluar';
                jenisInput.disabled = true;
            } else {
                jenisInput.disabled = true;
            }
            
            // Khusus Saldo Bulan Lalu, harus masuk
            if (kategori === 'Saldo Bulan Lalu') {
                 jenisInput.value = 'masuk';
            }
        }

        function checkInitialSaldo() {
            const hasInitialSaldo = jurnalData.some(d => d.kategori === 'Saldo Bulan Lalu');
            const table = document.getElementById('jurnal-table');

            // Hapus baris peringatan jika ada
            let existingRow = document.getElementById('saldo-awal-alert');
            if (existingRow) {
                existingRow.remove();
            }

            if (!hasInitialSaldo) {
                const tbody = table.querySelector('tbody');
                const row = tbody.insertRow(0);
                row.id = 'saldo-awal-alert';
                row.innerHTML = `
                    <td colspan="7" style="text-align:center; background-color:#ffdddd; color:#d8000c;">
                        <strong>PERINGATAN:</strong> Belum ada entri <b>Saldo Bulan Lalu</b>. Silakan tambahkan.
                    </td>
                    <td style="text-align:center;">
                        <button class="action-button edit" onclick="editData('jurnal', 'new-saldo-awal')">Tambah Saldo Awal</button>
                    </td>
                `;
            }
        }

        function setupFilters() {
            const currentYear = new Date().getFullYear();
            const months = ['Semua Bulan', '01-Januari', '02-Februari', '03-Maret', '04-April', '05-Mei', '06-Juni', '07-Juli', '08-Agustus', '09-September', '10-Oktober', '11-November', '12-Desember'];
            
            const koinFilter = document.getElementById('koin-filter-bulan');
            const jurnalFilter = document.getElementById('jurnal-filter-bulan');

            [koinFilter, jurnalFilter].forEach(select => {
                select.innerHTML = '';
                months.forEach((month, index) => {
                    if (index === 0) {
                         select.add(new Option(month, 'all'));
                    } else {
                         select.add(new Option(`${month} ${currentYear}`, `${currentYear}-${month.substring(0, 2)}`));
                    }
                });
                select.value = 'all'; // Set default to 'Semua Bulan'
            });
        }
        
        // FUNGSI BARU/DIKEMBALIKAN: Setup Filter Tahunan
        function setupAnnualFilter() {
            const annualFilter = document.getElementById('tahunan-filter-tahun');
            const currentYear = new Date().getFullYear();
            const years = ['Semua Tahun'];
            for (let i = 0; i < 5; i++) { // Filter 5 tahun ke belakang
                years.push((currentYear - i).toString());
            }
            
            annualFilter.innerHTML = '';
            years.forEach((year, index) => {
                annualFilter.add(new Option(year, index === 0 ? 'all' : year));
            });
            annualFilter.value = currentYear.toString(); // Default ke tahun ini
        }
        
        // FUNGSI BARU/DIKEMBALIKAN: Update Laporan Tahunan
        function updateAnnualTable() {
            const selectedYear = document.getElementById('tahunan-filter-tahun').value;
            let filteredData = jurnalData;

            if (selectedYear !== 'all') {
                filteredData = jurnalData.filter(d => d.tanggal.startsWith(selectedYear));
            }

            let totalDebet = 0;
            let totalKredit = 0;
            let infaqKotak = 0;

            filteredData.forEach(d => {
                const jumlah = d.jumlah || 0;
                if (d.jenis === 'masuk') {
                    totalDebet += jumlah;
                    if (d.kategori === 'Infaq Kotak') {
                        infaqKotak += jumlah;
                    }
                } else if (d.jenis === 'keluar') {
                    totalKredit += jumlah;
                }
            });

            const saldoKas = totalDebet - totalKredit;

            // --- Logika Pembagian Dana Zakat (berdasarkan Infaq Kotak) ---
            const alokasiYatim = Math.round(infaqKotak * 0.10); // 10%
            const alokasiFakir = Math.round(infaqKotak * 0.60); // 60%
            const alokasiOperasional = Math.round(infaqKotak * 0.25); // 25%
            const alokasiInfaq = Math.round(infaqKotak * 0.05); // 5%
            const totalAlokasi = alokasiYatim + alokasiFakir + alokasiOperasional + alokasiInfaq;
            // -----------------------------------------------------------

            document.getElementById('annual-total-debet').textContent = formatRupiah(totalDebet);
            document.getElementById('annual-total-kredit').textContent = formatRupiah(totalKredit);
            document.getElementById('annual-saldo-kas').innerHTML = `Total Saldo Akhir Kas: <span>${formatRupiah(saldoKas)}</span>`;

            document.getElementById('annual-infaq-kotak-bersih').textContent = formatRupiah(infaqKotak);
            document.getElementById('annual-total-alokasi').textContent = formatRupiah(totalAlokasi);
            document.getElementById('annual-alokasi-yatim').textContent = formatRupiah(alokasiYatim);
            document.getElementById('annual-alokasi-fakir').textContent = formatRupiah(alokasiFakir);
            document.getElementById('annual-alokasi-operasional').textContent = formatRupiah(alokasiOperasional);
            document.getElementById('annual-alokasi-infaq').textContent = formatRupiah(alokasiInfaq);
        }


        function filterData(moduleName) {
            const filterElement = document.getElementById(`${moduleName}-filter-bulan`);
            const selectedMonth = filterElement.value;
            let filteredData = moduleName === 'koin' ? koinData : jurnalData;

            if (selectedMonth !== 'all') {
                filteredData = filteredData.filter(d => d.tanggal.startsWith(selectedMonth));
            }
            
            // Urutkan berdasarkan tanggal (terbaru ke terlama)
            filteredData.sort((a, b) => new Date(b.tanggal) - new Date(a.tanggal));
            
            if (moduleName === 'koin') {
                updateKoinTable(filteredData);
            } else {
                updateJurnalTable(filteredData);
            }
        }

        function updateKoinTable(data = koinData) {
            const tableBody = document.querySelector('#koin-table tbody');
            tableBody.innerHTML = '';
            let totalSaldo = 0;

            if (data.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="6" style="text-align:center;">Belum ada data KOIN NU.</td></tr>';
                document.getElementById('koin-saldo').innerHTML = `Total Saldo KOIN NU: <span>${formatRupiah(0)}</span>`;
                return;
            }

            data.forEach(d => {
                totalSaldo += d.jumlah;
                const row = tableBody.insertRow();
                // Menggunakan substring(0, 4) untuk ID (untuk tampilan)
                row.innerHTML = `
                    <td>${d.id.substring(0, 4)}...</td>
                    <td>${d.tanggal}</td>
                    <td>${d.nama}</td>
                    <td style="text-align:right;">${formatRupiah(d.jumlah)}</td>
                    <td>${d.keterangan || '-'}</td>
                    <td style="text-align:center;">
                        <button class="action-button edit" onclick="editData('koin', '${d.id}')">Edit</button>
                        <button class="action-button delete" onclick="deleteData('koin', '${d.id}')">Hapus</button>
                    </td>
                `;
            });

            document.getElementById('koin-saldo').innerHTML = `Total Saldo KOIN NU: <span>${formatRupiah(totalSaldo)}</span>`;
        }

        function updateJurnalTable(data = jurnalData) {
            const tableBody = document.querySelector('#jurnal-table tbody');
            tableBody.innerHTML = '';
            let totalDebet = 0;
            let totalKredit = 0;

            if (data.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="8" style="text-align:center;">Belum ada data Jurnal Umum.</td></tr>';
                document.getElementById('jurnal-saldo').innerHTML = `Total Saldo Kas: <span>${formatRupiah(0)}</span>`;
                checkInitialSaldo();
                return;
            }

            data.forEach(d => {
                const debet = d.jenis === 'masuk' ? d.jumlah : 0;
                const kredit = d.jenis === 'keluar' ? d.jumlah : 0;
                totalDebet += debet;
                totalKredit += kredit;

                const row = tableBody.insertRow();
                // Menggunakan substring(0, 4) untuk ID (untuk tampilan)
                row.innerHTML = `
                    <td>${d.id.substring(0, 4)}...</td>
                    <td>${d.tanggal}</td>
                    <td>${d.kategori}</td>
                    <td>${d.uraian}</td>
                    <td>${d.jenis === 'masuk' ? 'Debet' : 'Kredit'}</td>
                    <td style="text-align:right;">${debet > 0 ? formatRupiah(debet) : '-'}</td>
                    <td style="text-align:right;">${kredit > 0 ? formatRupiah(kredit) : '-'}</td>
                    <td style="text-align:center;">
                        <button class="action-button edit" onclick="editData('jurnal', '${d.id}')">Edit</button>
                        <button class="action-button delete" onclick="deleteData('jurnal', '${d.id}')">Hapus</button>
                    </td>
                `;
            });

            const saldoKas = totalDebet - totalKredit;
            document.getElementById('jurnal-saldo').innerHTML = `Total Saldo Kas: <span>${formatRupiah(saldoKas)}</span>`;
            
            // Panggil cek saldo awal lagi setelah data dimuat
            checkInitialSaldo();
        }
        
        function changeTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });

            document.getElementById(`${tabName}-tab`).classList.add('active');
            document.querySelector(`.tab-button[onclick="changeTab('${tabName}')"]`).classList.add('active');
            
            // Khusus tab tahunan, update data
            if (tabName === 'tahunan') {
                updateAnnualTable();
            }
        }
        
        function exportToPDF() {
            alert('Fungsi Export PDF belum diimplementasikan sepenuhnya. Silakan gunakan fungsi cetak browser (Ctrl+P) atau salin data dari tabel.');
        }

        window.onload = init;
    </script>
</body>
</html>
