<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Input & Laporan KOIN NU Paling Detail (Firebase Auth)</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <style>
        /* [.. Semua CSS Anda yang sebelumnya berada di sini ..] */
        body { font-family: Arial, sans-serif; padding: 0 0 80px 0; background-color: #f8f9fa; margin: 0; }
        h1, h2 { color: #006400; margin: 15px 0 10px 0;}
        
        /* CSS untuk Navbar */
        #main-nav {
            background-color: #006400;
            padding: 10px 20px;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        #nav-menu {
            display: flex;
            list-style: none;
            padding: 0;
            margin: 0;
        }
        #nav-menu li { margin-left: 20px; }
        .module-section { margin: 20px; padding: 15px; border: 1px solid #ccc; background: white; }
        
        /* CSS untuk Login Bar */
        #login-container-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: #e9ecef;
            border-top: 1px solid #ccc;
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 -2px 5px rgba(0,0,0,0.1);
        }
        #login-form-content-bar, #logout-form-content-bar {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .admin-only { display: none; }
        .text-right { text-align: right; }
        .text-center { text-align: center; }
        .saldo-awal-row { font-weight: bold; background-color: #f0f0f0; }
        /* ... CSS Selesai ... */
    </style>
</head>
<body>
    
    <nav id="main-nav">
        <h1>Sistem Laporan KOIN NU</h1>
        <ul id="nav-menu">
            <li><button id="nav-modul-1a" onclick="switchModule('modul-1a-section')" class="active">Modul 1A (Penerimaan Detail)</button></li>
            <li><button id="nav-modul-2" onclick="switchModule('modul-2-section')">Modul 2 (Jurnal Umum)</button></li>
            <li><button id="nav-modul-3" onclick="switchModule('modul-3-section')">Modul 3 (Laporan Tahunan)</button></li>
            <li><button id="nav-modul-1" onclick="switchModule('modul-1-section')">Modul 1 (Input Agregat)</button></li>
        </ul>
    </nav>
    
    <div id="report-container">
        
        <div style="display: flex; justify-content: center; align-items: center; margin-bottom: 10px;">
            <div style="width: 100px; height: 100px; margin-right: 15px; background-color: #006400;"></div>
            <div style="text-align: left;">
                <h2 style="margin: 0; color: #006400; font-size: 22px;">NU CARE UPZIS - LAZISNU RANTING NGABLAK</h2>
                <p style="margin: 0; font-size: 15px; color: #333;">Sekretariat: [Alamat Anda]</p>
            </div>
        </div>
        <hr style="border-top: 3px double #000; margin-top: 0px; margin-bottom: 20px;">
        
        <div id="modul-1a-section" class="module-section" style="display: block;">
            <h2>Modul 1A: Input Transaksi KOIN NU Rinci</h2>
            
            <div id="m1a-input-form-container" class="admin-only">
                <input type="date" id="m1a-tanggal-input" required>
                <input type="text" id="m1a-nama-petugas-input" placeholder="Nama Petugas" required>
                <input type="text" id="m1a-no-hp-input" placeholder="No. HP">
                <input type="text" id="m1a-donatur-input" placeholder="Nama Donatur/KK" required>
                <input type="text" id="m1a-alamat-input" placeholder="Alamat/RT/RW" required>
                <input type="number" id="m1a-nominal-input" placeholder="Nominal (Rp)" min="1" required>
                <button onclick="addKoinNUTransaction()">Tambah Koin NU</button>
                <button onclick="clearKoinNUInputs()">Clear Form</button>
            </div>
            
            <table id="m1a-table" style="width: 100%; border-collapse: collapse;">
                <thead>
                    <tr>
                        <th style="width: 30px;">No</th><th>Tanggal</th><th>Petugas</th><th>Donatur</th><th>Nominal</th>
                        <th>Honor Petugas (10%)</th><th>Honor MWC (25%)</th><th>Honor PC (5%)</th><th>Kas Ranting (60%)</th>
                        <th id="th-m1a-aksi" style="width: 120px;">Aksi</th>
                    </tr>
                </thead>
                <tbody id="m1a-transaction-body"></tbody>
                <tfoot>
                    <tr>
                        <td colspan="4" class="text-right">TOTAL AKUMULASI:</td>
                        <td class="text-right" id="m1a-total-nominal">0</td>
                        <td class="text-right" id="m1a-total-petugas">0</td>
                        <td class="text-right" id="m1a-total-mwc">0</td>
                        <td class="text-right" id="m1a-total-pc">0</td>
                        <td class="text-right" id="m1a-total-ranting">0</td>
                        <td id="tf-m1a-aksi" style="display: none;"></td>
                    </tr>
                </tfoot>
            </table>
        </div>

        <div id="modul-2-section" class="module-section" style="display: none;">
            <h2>Modul 2: Jurnal Umum Kas</h2>
            <div id="m2-input-form-container" class="admin-only">
                <input type="date" id="m2-tanggal-input" required>
                <input type="text" id="m2-keterangan-input" placeholder="Keterangan Transaksi" required>
                <select id="m2-kategori-input" required></select>
                <input type="number" id="m2-debit-input" placeholder="Dana Masuk (Debit Rp)" min="0">
                <input type="number" id="m2-kredit-input" placeholder="Dana Keluar (Kredit Rp)" min="0">
                <button onclick="addManualTransaction()">Tambah Transaksi Lain</button>
                <button onclick="clearManualTransactionInputs()">Clear Form</button>
            </div>
            
            <table id="m2-table" style="width: 100%; border-collapse: collapse;">
                <thead>
                    <tr>
                        <th style="width: 30px;">No</th><th>Tanggal</th><th>Keterangan</th><th>Kategori</th>
                        <th style="width: 120px;">Debit (Rp)</th><th style="width: 120px;">Kredit (Rp)</th><th style="width: 120px;">Saldo (Rp)</th>
                        <th id="th-m2-aksi" style="width: 120px;">Aksi</th>
                    </tr>
                </thead>
                <tbody id="m2-transaction-body">
                    <tr class="saldo-awal-row">
                        <td colspan="6" class="text-right">SALDO AWAL KAS (Bank + Tunai):</td>
                        <td class="text-right">
                            <span id="m2-saldo-awal-static">0</span>
                            <div id="m2-saldo-awal-display-container" class="admin-only">
                                <input type="number" id="m2-saldo-awal-input" value="15000000" style="width: 80px; text-align: right;">
                                <span id="m2-saldo-awal-display" style="display: none;">0</span>
                            </div>
                        </td>
                        <td id="td-m2-saldo-awal-aksi" style="display: none;"></td>
                    </tr>
                </tbody>
                <tfoot>
                    <tr>
                        <td colspan="4" class="text-right">TOTAL AKUMULASI:</td>
                        <td class="text-right" id="m2-total-masuk">0</td>
                        <td class="text-right" id="m2-total-keluar">0</td>
                        <td class="text-right" id="m2-footer-saldo-total">0</td>
                        <td id="tf-m2-aksi" style="display: none;"></td>
                    </tr>
                </tfoot>
            </table>
        </div>

        <div id="modul-3-section" class="module-section" style="display: none;">
            <h2>Modul 3: Laporan Tahunan</h2>
            </div>

        <div id="modul-1-section" class="module-section" style="display: none;">
            <h2>Modul 1: Input Data Agregat Bulanan (Manual)</h2>
            </div>

    </div>

    <div id="login-container-bar">
        
        <div id="logout-form-content-bar" style="display: none;">
            <p>Admin Aktif: <strong id="admin-status"></strong></p>
            <button onclick="resetAllData()" style="background-color: orange; color: white;">RESET SEMUA DATA</button>
            <button onclick="logout()" style="background-color: red; color: white;">LOGOUT</button>
        </div>
        
        <div id="login-form-content-bar">
            <label for="username">Email Admin:</label>
            <input type="email" id="username" placeholder="admin@domain.com">
            <label for="password">Password:</label>
            <input type="password" id="password" placeholder="******">
            <button onclick="login()" style="background-color: #006400; color: white;">LOGIN</button>
            <span id="login-message-bar" style="color: red;"></span>
        </div>
    </div>


    <script>
        // ===================================
        // --- FIREBASE SETUP ---
        // ===================================
        const firebaseConfig = {
            apiKey: "AIzaSyA_8NMmZBaXZ4H6KQt7rHy8G1URR3HLP3A",
            authDomain: "upzis-ngablak.firebaseapp.com",
            projectId: "upzis-ngablak",
            storageBucket: "upzis-ngablak.firebasestorage.app",
            messagingSenderId: "869549648344",
            appId: "1:869549648344:web:a531a37cce3a87bb672aad"
        };

        let db;
        let auth;
        let isLoggedIn = false;
        let currentAdminEmail = 'Belum Login';
        
        // --- MAPPING COLLECTION ---
        const M1A_COLLECTION = 'laporan_koin_nu'; 
        const M2_COLLECTION = 'jurnal_umum';     
        const M1_COLLECTION = 'laporan_tahunan'; 

        // ===================================
        // --- GLOBAL STATE ---
        // ===================================
        let m1aTransactions = [];
        let m2ManualTransactions = [];
        let initialData = []; 
        const months = ['Semua Bulan', 'Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni', 'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'];
        let currentFilterMonth = 0; 
        let currentFilterYear = new Date().getFullYear();

        // Saldo Awal State
        let saldoBankAwal = 10000000;
        let saldoTunaiAwal = 5000000;
        const M2_CATEGORIES = ['Infaq dan Shodaqoh', 'Zakat', 'Dana Lain-lain Masuk', 'Pendidikan', 'Kesehatan', 'Sosial Umum', 'Banom', 'Penanggulangan Bencana', 'Biaya Rapat/Operasional', 'Perawatan Inventaris', 'Biaya Bank/Administrasi', 'Pengeluaran Lain-lain'];

        // ===================================
        // --- FIREBASE DATA HANDLING ---
        // ===================================
        // [.. loadDataFromFirebase, getFilteredM1aTransactions, getFilteredM2ManualTransactions, parseInput, formatNominal, populateFilters, switchModule, updateFilters, dll. (Fungsi Utility/Data yang tidak berubah dari migrasi sebelumnya) ..]
        
        async function loadDataFromFirebase() {
            try {
                // 1. Ambil Data Koin NU (Modul 1A)
                const m1aSnapshot = await db.collection(M1A_COLLECTION).orderBy('date', 'asc').get();
                m1aTransactions = m1aSnapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data(),
                    nominal: parseFloat(doc.data().nominal || 0)
                }));

                // 2. Ambil Data Transaksi Manual (Modul 2)
                const m2Snapshot = await db.collection(M2_COLLECTION).orderBy('date', 'asc').get();
                m2ManualTransactions = m2Snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data(),
                    debit: parseFloat(doc.data().debit || 0),
                    kredit: parseFloat(doc.data().kredit || 0)
                }));
                
                // 3. Ambil Data Agregat Bulanan (Modul 1)
                const m1Snapshot = await db.collection(M1_COLLECTION).orderBy('order', 'asc').get();
                if (!m1Snapshot.empty) {
                    initialData = m1Snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data(),
                        // Pastikan semua properti nominal adalah number
                        penerimaan: parseFloat(doc.data().penerimaan || 0),
                        pendUang: parseFloat(doc.data().pendUang || 0),
                        // ... Tambahkan parse untuk semua field nominal Modul 1
                    }));
                } else {
                    initialData = Array.from({ length: 12 }, (_, i) => ({ 
                        bulan: months[i + 1], 
                        order: i + 1, year: currentFilterYear, // Tambahkan tahun untuk filtering
                        penerimaan: 0, donatur: 0, 
                        pendUang: 0, pendPenerima: 0, 
                        // ... inisialisasi semua field Modul 1 ...
                        honorWajibPercent: 0.40 
                    }));
                }
            } catch (error) {
                console.error("Error loading data from Firebase:", error);
                alert("Gagal memuat data dari database. Cek Firebase Rules Anda.");
            }
        }
        
        // ===================================
        // --- ADMIN / AUTH LOGIC (REVISED) ---
        // ===================================
        
        // Fungsi login sekarang menggunakan Firebase Auth
        async function login() {
            const emailInput = document.getElementById('username');
            const passwordInput = document.getElementById('password');
            const messageBar = document.getElementById('login-message-bar');

            const email = emailInput.value.trim();
            const password = passwordInput.value.trim();

            if (!email || !password) {
                 messageBar.textContent = 'Email dan Password wajib diisi.';
                 return;
            }

            messageBar.textContent = 'Loading...';
            
            try {
                // Gunakan Firebase Sign-In
                const userCredential = await auth.signInWithEmailAndPassword(email, password);
                // onAuthStateChanged akan dipanggil secara otomatis
                messageBar.textContent = 'Login berhasil! Memuat data...';
                
            } catch (error) {
                console.error("Login Error:", error);
                messageBar.textContent = `Login Gagal: ${error.message}`;
            }
        }

        function logout() {
            auth.signOut().then(() => {
                // onAuthStateChanged akan dipanggil
            }).catch((error) => {
                console.error("Logout Error:", error);
            });
        }
        
        async function resetAllData() {
            if (!isLoggedIn) return;
            // [.. Logika resetAllData (delete documents) ..]
            if (confirm("ANDA YAKIN INGIN MENGHAPUS SEMUA DATA TRANSAKSI (M1A & M2)?")) {
                // Simulasikan penghapusan
                alert("Semua data telah direset (dihapus).");
                await loadDataFromFirebase();
                recalculateAllReports();
            }
        }

        // Fungsi ini dipanggil oleh auth.onAuthStateChanged
        async function handleAuthStateChange(user) {
            const loginContainer = document.getElementById('login-form-content-bar');
            const logoutContainer = document.getElementById('logout-form-content-bar');
            const adminStatus = document.getElementById('admin-status');
            const adminElements = document.querySelectorAll('.admin-only');

            isLoggedIn = !!user;
            currentAdminEmail = user ? user.email : 'Belum Login';

            if (isLoggedIn) {
                loginContainer.style.display = 'none';
                logoutContainer.style.display = 'flex';
                adminStatus.textContent = currentAdminEmail;
                adminElements.forEach(el => el.style.display = 'block'); 
            } else {
                loginContainer.style.display = 'flex';
                logoutContainer.style.display = 'none';
                adminElements.forEach(el => el.style.display = 'none'); 
            }
            // Recalculate will be called by the listener in window.onload
        }

        // ===================================
        // --- MAIN CONTROL & ONLOAD ---
        // ===================================
        
        // [.. recalculateAllReports, addKoinNUTransaction, deleteKoinNUTxn, editKoinNUTxn, updatePenerimaanDetail, addManualTransaction, updateJurnalUmum, dll. (Fungsi CRUD/Laporan yang tidak berubah dari migrasi sebelumnya) ..]
        
        window.onload = async () => {
            // 1. Initialize Firebase
            firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            auth = firebase.auth(); 
            
            // 2. Populate Filters (Independent of login)
            populateFilters();
            
            // 3. Firebase Auth State Listener (Crucial for data loading)
            auth.onAuthStateChanged(async (user) => {
                handleAuthStateChange(user); 
                
                if (user) {
                    // Hanya load data dari Firebase jika ada user yang login
                    await loadDataFromFirebase();
                } else {
                    // Kosongkan data lokal jika logout
                    m1aTransactions = [];
                    m2ManualTransactions = [];
                    initialData = [];
                }
                
                // Render view (based on the latest data and login status)
                recalculateAllReports(); 
            });

            // 4. Set default module
            switchModule('modul-1a-section'); 
            
            // Populate M2 Categories
            const select = document.getElementById('m2-kategori-input');
            select.innerHTML = M2_CATEGORIES.map(cat => `<option value="${cat}">${cat}</option>`).join('');
        };
        
        // [.. Tambahkan kembali semua fungsi CRUD, Report, dan Utility Anda di sini, pastikan mereka menggunakan variabel global yang diisi oleh loadDataFromFirebase (seperti yang dilakukan pada langkah migrasi sebelumnya) ..]
        
    </script>
</body>
</html>
