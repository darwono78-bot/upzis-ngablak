<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Input & Laporan KOIN NU Paling Detail (Firebase)</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <style>
        /* [.. Semua CSS Anda yang sebelumnya berada di sini ..] */
        body { font-family: Arial, sans-serif; padding: 0 0 80px 0; background-color: #f8f9fa; margin: 0; }
        h1, h2 { color: #006400; margin: 15px 0 10px 0;}
        /* CSS untuk Navbar */
        #main-nav {
            background-color: #006400;
            padding: 10px 20px;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        /* ... CSS Lanjut ... */
        .admin-only { display: none; }
        /* ... CSS Selesai ... */
    </style>
</head>
<body>
    
    <nav id="main-nav">
        <h1>Sistem Laporan KOIN NU</h1>
        <ul id="nav-menu">
            <li><button id="nav-m1a" onclick="switchModule('modul-1a-section')" class="active">Modul 1A (Penerimaan Detail)</button></li>
            <li><button id="nav-m2" onclick="switchModule('modul-2-section')">Modul 2 (Jurnal Umum)</button></li>
            <li><button id="nav-m3" onclick="switchModule('modul-3-section')">Modul 3 (Laporan Tahunan)</button></li>
            <li><button id="nav-m1" onclick="switchModule('modul-1-section')">Modul 1 (Input Agregat)</button></li>
        </ul>
    </nav>
    
    <div id="report-container">
        
        <div style="display: flex; justify-content: center; align-items: center; margin-bottom: 10px;">
            <div style="
                width: 100px; 
                height: 100px; 
                margin-right: 15px; 
                background-image: url('logo-lazisnu.png'); 
                background-size: contain; 
                background-repeat: no-repeat;
                background-position: center; 
                flex-shrink: 0;
            "></div>
            <div style="text-align: left;">
                <h2 style="margin: 0; color: #006400; font-size: 22px;">NU CARE UPZIS - LAZISNU RANTING NGABLAK</h2>
                <p style="margin: 0; font-size: 15px; color: #333;">Sekretariat: Jalan [Nama Jalan], Desa Ngablak, Kec. [Kecamatan], Kab. [Kabupaten]</p>
            </div>
        </div>
        <hr style="border-top: 3px double #000; margin-top: 0px; margin-bottom: 20px;">
        
        </div>

    <div id="login-container-bar">
        <div id="logout-form-content-bar" style="display: none;">
            <p>Admin: <span id="admin-status"></span></p>
            <button onclick="logout()">LOGOUT</button>
        </div>
        <div id="login-form-content-bar">
            <label for="username">User:</label>
            <input type="text" id="username" value="admin">
            <label for="password">Pass:</label>
            <input type="password" id="password" value="lazisnu123">
            <button onclick="login()">LOGIN</button>
            <span id="login-message-bar"></span>
        </div>
    </div>


    <script>
        // ===================================
        // --- FIREBASE SETUP ---
        // ===================================
        const firebaseConfig = {
            apiKey: "AIzaSyA_8NMmZBaXZ4H6KQt7rHy8G1URR3HLP3A",
            authDomain: "upzis-ngablak.firebaseapp.com",
            projectId: "upzis-ngablak",
            storageBucket: "upzis-ngablak.firebasestorage.app",
            messagingSenderId: "869549648344",
            appId: "1:869549648344:web:a531a37cce3a87bb672aad"
        };

        // Initialize global Firebase variables
        let db;
        let auth;
        let isLoggedIn = false;
        
        // --- MAPPING COLLECTION ---
        const M1A_COLLECTION = 'laporan_koin_nu'; // Modul 1A Detail
        const M2_COLLECTION = 'jurnal_umum';     // Modul 2 Manual (Non-Koin)
        const M1_COLLECTION = 'laporan_tahunan'; // Modul 1 Agregat Bulanan

        // ===================================
        // --- GLOBAL STATE (SAMA DENGAN HARDCODED) ---
        // ===================================
        let m1aTransactions = [];
        let m2ManualTransactions = [];
        // Data Agregat Bulanan (Modul 1)
        let initialData = []; 

        // Filter State
        const months = ['Semua Bulan', 'Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni', 'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'];
        let currentFilterMonth = 0; // 0 for all months
        let currentFilterYear = new Date().getFullYear();

        // Saldo Awal State
        let saldoBankAwal = 10000000;
        let saldoTunaiAwal = 5000000;


        // ===================================
        // --- FIREBASE DATA HANDLING ---
        // ===================================

        /**
         * Mengambil semua data dari Firebase dan mengisi variabel global.
         * Dipanggil saat load halaman, login, atau perubahan data (CRUD).
         */
        async function loadDataFromFirebase() {
            try {
                // 1. Ambil Data Koin NU (Modul 1A)
                const m1aSnapshot = await db.collection(M1A_COLLECTION).orderBy('date', 'asc').get();
                m1aTransactions = m1aSnapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data(),
                    nominal: parseFloat(doc.data().nominal) // Pastikan nominal bertipe number
                }));

                // 2. Ambil Data Transaksi Manual (Modul 2)
                const m2Snapshot = await db.collection(M2_COLLECTION).orderBy('date', 'asc').get();
                m2ManualTransactions = m2Snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data(),
                    debit: parseFloat(doc.data().debit), // Pastikan nominal bertipe number
                    kredit: parseFloat(doc.data().kredit)
                }));
                
                // 3. Ambil Data Agregat Bulanan (Modul 1)
                const m1Snapshot = await db.collection(M1_COLLECTION).orderBy('order', 'asc').get();
                // Jika data sudah ada di Firebase, gunakan data itu. Jika belum, buat array default.
                if (!m1Snapshot.empty) {
                    initialData = m1Snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data(),
                        // Pastikan semua properti nominal adalah number (penting untuk kalkulasi)
                        penerimaan: parseFloat(doc.data().penerimaan || 0),
                        pendUang: parseFloat(doc.data().pendUang || 0),
                        kesUang: parseFloat(doc.data().kesUang || 0),
                        ekoUang: parseFloat(doc.data().ekoUang || 0),
                        sosumUang: parseFloat(doc.data().sosumUang || 0),
                        banomUang: parseFloat(doc.data().banomUang || 0),
                        bencanaUang: parseFloat(doc.data().bencanaUang || 0),
                        rapat: parseFloat(doc.data().rapat || 0),
                        perwtnMlu: parseFloat(doc.data().perwtnMlu || 0),
                        biayaBank: parseFloat(doc.data().biayaBank || 0),
                        lainLain: parseFloat(doc.data().lainLain || 0),
                        // Properti lain yang tidak berupa nominal tidak perlu di-parse
                    }));
                } else {
                    // Jika koleksi laporan_tahunan kosong, buat data inisial 12 bulan
                    initialData = Array.from({ length: 12 }, (_, i) => ({ 
                        bulan: months[i + 1], 
                        order: i + 1,
                        penerimaan: 0, donatur: 0, 
                        pendUang: 0, pendPenerima: 0, 
                        kesUang: 0, kesPenerima: 0, 
                        ekoUang: 0, ekoPenerima: 0, 
                        sosumUang: 0, sosumPenerima: 0, 
                        banomUang: 0, banomPenerima: 0, 
                        bencanaUang: 0, bencanaPenerima: 0, 
                        rapat: 0, perwtnMlu: 0, biayaBank: 0, lainLain: 0, 
                        honorWajibPercent: 0.40 // 40% (10+25+5)
                    }));
                }


            } catch (error) {
                console.error("Error loading data from Firebase:", error);
                alert("Gagal memuat data dari database: " + error.message);
            }
        }


        // ===================================
        // --- UTILITY & FORMATTING (TIDAK BERUBAH) ---
        // ===================================

        function formatNominal(number) {
            if (typeof number !== 'number') return '0';
            return number.toLocaleString('id-ID');
        }

        // [.. Fungsi Utilitas lainnya seperti populateFilters, updateFilters, switchModule TIDAK BERUBAH ..]
        
        // ... (Tambahkan kembali fungsi utility yang relevan dari file hardcoded Anda) ...

        function getFilteredM1aTransactions() {
            const month = currentFilterMonth;
            const year = currentFilterYear;
            let filtered = m1aTransactions.filter(t => new Date(t.date).getFullYear() === year);
            if (month !== 0) {
                filtered = filtered.filter(t => new Date(t.date).getMonth() === (month - 1));
            }
            return filtered.sort((a, b) => new Date(a.date) - new Date(b.date));
        }

        function getFilteredM2ManualTransactions() {
            const month = currentFilterMonth;
            const year = currentFilterYear;
            let filtered = m2ManualTransactions.filter(t => new Date(t.date).getFullYear() === year);
            if (month !== 0) {
                filtered = filtered.filter(t => new Date(t.date).getMonth() === (month - 1));
            }
            return filtered.sort((a, b) => new Date(a.date) - new Date(b.date));
        }

        function switchModule(moduleID) {
            document.querySelectorAll('.module-section').forEach(section => { section.style.display = 'none'; });
            document.querySelectorAll('#nav-menu button').forEach(button => { button.classList.remove('active'); });
            document.getElementById(moduleID).style.display = 'block';
            document.getElementById('nav-' + moduleID.replace('-section', '')).classList.add('active');
            recalculateAllReports();
        }

        function populateFilters() {
            // [.. Fungsi populateFilters di sini (tidak berubah) ..]
            // Populate Months (0=Semua Bulan)
            const monthSelects = document.querySelectorAll('[id^="filter-bulan-"]');
            monthSelects.forEach(select => {
                select.innerHTML = '';
                months.forEach((m, i) => {
                    const option = document.createElement('option');
                    option.value = i;
                    option.textContent = m;
                    select.appendChild(option);
                });
            });

            // Populate Years (Current year +/- 2)
            const yearSelects = document.querySelectorAll('[id^="filter-tahun-"]');
            yearSelects.forEach(select => {
                select.innerHTML = '';
                const currentYear = new Date().getFullYear();
                for (let y = currentYear - 2; y <= currentYear + 1; y++) {
                    const option = document.createElement('option');
                    option.value = y;
                    option.textContent = y;
                    select.appendChild(option);
                }
            });

            // Set current filters to the current global state
            monthSelects.forEach(select => select.value = currentFilterMonth);
            yearSelects.forEach(select => select.value = currentFilterYear);
        }

        function updateFilters(id, value) {
            const val = parseInt(value);
            if (id.includes('bulan')) {
                currentFilterMonth = val;
            } else if (id.includes('tahun')) {
                currentFilterYear = val;
            }
            // Sync all filter dropdowns to the new value
            const targetPrefix = id.includes('bulan') ? 'filter-bulan-' : 'filter-tahun-';
            document.querySelectorAll(`[id^="${targetPrefix}"]`).forEach(select => {
                select.value = val;
            });
            recalculateAllReports();
        }
        
        
        // ===================================
        // --- MODUL 1A LOGIC: TRANSAKSI KOIN NU (CRUD) ---
        // ===================================
        
        // Menggunakan async/await untuk operasi Firebase
        async function addKoinNUTransaction() {
            if (!isLoggedIn) return alert('Anda harus login sebagai Admin untuk menambah data.');
            
            const date = document.getElementById('m1a-tanggal-input').value;
            const petugas = document.getElementById('m1a-nama-petugas-input').value.trim();
            const noHp = document.getElementById('m1a-no-hp-input').value.trim();
            const donatur = document.getElementById('m1a-donatur-input').value.trim();
            const alamat = document.getElementById('m1a-alamat-input').value.trim();
            const nominal = parseFloat(document.getElementById('m1a-nominal-input').value) || 0;

            if (!date || !petugas || !nominal || nominal <= 0) {
                return alert('Tanggal, Nama Petugas, dan Nominal Koin NU wajib diisi dan Nominal harus lebih dari 0.');
            }

            const newTx = {
                date: date,
                petugas: petugas,
                noHp: noHp,
                donatur: donatur,
                alamat: alamat,
                nominal: nominal,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            try {
                // SIMPAN KE FIREBASE
                await db.collection(M1A_COLLECTION).add(newTx);
                alert('Transaksi Koin NU berhasil ditambahkan ke Firebase!');
                
                // Refresh data dan tampilan
                await loadDataFromFirebase();
                recalculateAllReports();
                clearKoinNUInputs();

            } catch (error) {
                console.error("Error adding document: ", error);
                alert("Gagal menambahkan transaksi: " + error.message);
            }
        }
        
        // Fungsi untuk menghapus transaksi dari Firebase menggunakan ID
        async function deleteKoinNUTxn(docId) {
            if (!isLoggedIn) return;
            if (confirm(`Yakin ingin menghapus transaksi Koin NU dengan ID: ${docId}?`)) {
                try {
                    // HAPUS DARI FIREBASE
                    await db.collection(M1A_COLLECTION).doc(docId).delete();
                    alert("Transaksi berhasil dihapus dari Firebase.");
                    
                    // Refresh data dan tampilan
                    await loadDataFromFirebase();
                    recalculateAllReports();

                } catch (error) {
                    console.error("Error removing document: ", error);
                    alert("Gagal menghapus transaksi: " + error.message);
                }
            }
        }
        
        // Fungsi edit memindahkan data ke form dan menghapus dari database (metode lama)
        function editKoinNUTxn(docId) {
            if (!isLoggedIn) return;
            
            // Cari data di array lokal berdasarkan ID
            const txIndex = m1aTransactions.findIndex(t => t.id === docId);

            if (txIndex > -1) {
                const tx = m1aTransactions[txIndex];
                
                // Pindahkan data ke form input
                document.getElementById('m1a-tanggal-input').value = tx.date;
                document.getElementById('m1a-nama-petugas-input').value = tx.petugas;
                document.getElementById('m1a-no-hp-input').value = tx.noHp;
                document.getElementById('m1a-donatur-input').value = tx.donatur;
                document.getElementById('m1a-alamat-input').value = tx.alamat;
                document.getElementById('m1a-nominal-input').value = tx.nominal;
                
                // Hapus data dari Firebase (mirip dengan delete, tapi tanpa konfirmasi)
                db.collection(M1A_COLLECTION).doc(docId).delete()
                    .then(async () => {
                        await loadDataFromFirebase();
                        recalculateAllReports();
                        alert('Data dipindahkan ke form input. Silakan edit dan klik "Tambah Koin NU" lagi.');
                    })
                    .catch(error => {
                        console.error("Error moving transaction: ", error);
                        alert("Gagal memindahkan transaksi untuk diedit: " + error.message);
                    });
            } else {
                alert("Error: Transaksi tidak ditemukan di data utama.");
            }
        }

        function clearKoinNUInputs() {
            document.getElementById('m1a-tanggal-input').value = '';
            document.getElementById('m1a-nama-petugas-input').value = '';
            document.getElementById('m1a-no-hp-input').value = '';
            document.getElementById('m1a-donatur-input').value = '';
            document.getElementById('m1a-alamat-input').value = '';
            document.getElementById('m1a-nominal-input').value = '';
        }

        function getKoinNUAggregateData() {
            // [.. Fungsi getKoinNUAggregateData TIDAK BERUBAH. Hanya menggunakan array global m1aTransactions yang sudah diisi dari Firebase ..]
            const filtered = getFilteredM1aTransactions();
            const totalNominal = filtered.reduce((sum, t) => sum + t.nominal, 0);
            
            // Pembagian honor (sesuai logika hardcoded Anda)
            const totalHonorPetugas = totalNominal * 0.10; // 10%
            const totalHonorMWC = totalNominal * 0.25;     // 25%
            const totalHonorPC = totalNominal * 0.05;       // 5%
            const totalRanting = totalNominal - (totalHonorPetugas + totalHonorMWC + totalHonorPC); // Sisa 60%
            
            return {
                totalNominal,
                totalHonorPetugas,
                totalHonorMWC,
                totalHonorPC,
                totalRanting
            };
        }

        function updatePenerimaanDetail() {
            const tableBody = document.getElementById('m1a-transaction-body');
            tableBody.innerHTML = '';
            const filtered = getFilteredM1aTransactions();
            const { totalNominal, totalHonorPetugas, totalHonorMWC, totalHonorPC, totalRanting } = getKoinNUAggregateData();
            
            const aksiVisibilityStyle = isLoggedIn ? '' : 'none';

            filtered.forEach((tx, index) => {
                const row = tableBody.insertRow();
                // Honor Otomatis (sesuai logika hardcoded)
                const honorPetugas = tx.nominal * 0.10;
                const honorMWC = tx.nominal * 0.25;
                const honorPC = tx.nominal * 0.05;
                const ranting = tx.nominal - (honorPetugas + honorMWC + honorPC);

                // Menggunakan tx.id (dari Firebase) untuk aksi Edit dan Delete
                const actionButtons = `
                    <button class="action-btn edit-btn" onclick="editKoinNUTxn('${tx.id}')">Edit</button>
                    <button class="action-btn delete-btn" onclick="deleteKoinNUTxn('${tx.id}')">Hapus</button>
                `;
                
                row.innerHTML = `
                    <td class="text-center">${index + 1}</td>
                    <td>${tx.date}</td>
                    <td>${tx.petugas}</td>
                    <td>${tx.noHp}</td>
                    <td>${tx.donatur}</td>
                    <td>${tx.alamat}</td>
                    <td class="text-right">${formatNominal(tx.nominal)}</td>
                    <td class="text-right">${formatNominal(honorPetugas)}</td>
                    <td class="text-right">${formatNominal(honorMWC)}</td>
                    <td class="text-right">${formatNominal(honorPC)}</td>
                    <td class="text-right">${formatNominal(ranting)}</td>
                    <td class="text-center" style="display: ${aksiVisibilityStyle};">${actionButtons}</td>
                `;
            });

            // Update footer totals
            document.getElementById('m1a-total-nominal').textContent = formatNominal(totalNominal);
            document.getElementById('m1a-total-petugas').textContent = formatNominal(totalHonorPetugas);
            document.getElementById('m1a-total-mwc').textContent = formatNominal(totalHonorMWC);
            document.getElementById('m1a-total-pc').textContent = formatNominal(totalHonorPC);
            document.getElementById('m1a-total-ranting').textContent = formatNominal(totalRanting);

            // Update footer AKSI column visibility
            document.getElementById('th-m1a-aksi').style.display = aksiVisibilityStyle;
            document.getElementById('tf-m1a-aksi').style.display = aksiVisibilityStyle;
        }

        
        // ===================================
        // --- MODUL 2 LOGIC: JURNAL UMUM (CRUD) ---
        // ===================================

        async function addManualTransaction() {
            if (!isLoggedIn) return alert('Anda harus login sebagai Admin untuk menambah data.');

            const date = document.getElementById('m2-tanggal-input').value;
            const keterangan = document.getElementById('m2-keterangan-input').value.trim();
            const kategori = document.getElementById('m2-kategori-input').value;
            const debit = parseFloat(document.getElementById('m2-debit-input').value) || 0;
            const kredit = parseFloat(document.getElementById('m2-kredit-input').value) || 0;

            if (!date || !keterangan || !kategori || (debit === 0 && kredit === 0) || (debit > 0 && kredit > 0)) {
                return alert('Tanggal, Keterangan, dan Kategori wajib diisi, dan harus ada Dana Masuk (DEBIT) atau Dana Keluar (KREDIT) (tidak boleh keduanya).');
            }

            const newTx = {
                date: date,
                keterangan: keterangan,
                kategori: kategori,
                debit: debit,
                kredit: kredit,
                isAuto: false, // Penting untuk membedakan dari transaksi Koin NU
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            };

            try {
                // SIMPAN KE FIREBASE
                await db.collection(M2_COLLECTION).add(newTx);
                alert('Transaksi manual berhasil ditambahkan ke Firebase!');
                
                // Refresh data dan tampilan
                await loadDataFromFirebase();
                recalculateAllReports();
                clearManualTransactionInputs();

            } catch (error) {
                console.error("Error adding document: ", error);
                alert("Gagal menambahkan transaksi: " + error.message);
            }
        }
        
        async function deleteManualTxn(docId) {
            if (!isLoggedIn) return;
            if (confirm(`Yakin ingin menghapus transaksi manual dengan ID: ${docId}?`)) {
                try {
                    // HAPUS DARI FIREBASE
                    await db.collection(M2_COLLECTION).doc(docId).delete();
                    alert("Transaksi manual berhasil dihapus dari Firebase.");
                    
                    // Refresh data dan tampilan
                    await loadDataFromFirebase();
                    recalculateAllReports();

                } catch (error) {
                    console.error("Error removing document: ", error);
                    alert("Gagal menghapus transaksi: " + error.message);
                }
            }
        }
        
        function editManualTxn(docId) {
            if (!isLoggedIn) return;
            
            // Cari data di array lokal berdasarkan ID
            const txIndex = m2ManualTransactions.findIndex(t => t.id === docId);

            if (txIndex > -1) {
                const tx = m2ManualTransactions[txIndex];
                
                // Pindahkan data ke form input
                document.getElementById('m2-tanggal-input').value = tx.date;
                document.getElementById('m2-keterangan-input').value = tx.keterangan;
                document.getElementById('m2-kategori-input').value = tx.kategori;
                document.getElementById('m2-debit-input').value = tx.debit;
                document.getElementById('m2-kredit-input').value = tx.kredit;

                // Hapus data dari Firebase
                db.collection(M2_COLLECTION).doc(docId).delete()
                    .then(async () => {
                        await loadDataFromFirebase();
                        recalculateAllReports();
                        alert('Data dipindahkan ke form input. Silakan edit dan klik "Tambah Transaksi Lain" lagi.');
                    })
                    .catch(error => {
                        console.error("Error moving transaction: ", error);
                        alert("Gagal memindahkan transaksi untuk diedit: " + error.message);
                    });
            } else {
                alert("Error: Transaksi tidak ditemukan di data utama.");
            }
        }

        function clearManualTransactionInputs() {
            document.getElementById('m2-tanggal-input').value = '';
            document.getElementById('m2-keterangan-input').value = '';
            document.getElementById('m2-kategori-input').value = '';
            document.getElementById('m2-debit-input').value = '0';
            document.getElementById('m2-kredit-input').value = '0';
        }

        function updateJurnalUmum() {
            const tableBody = document.getElementById('m2-transaction-body');
            // Hanya hapus baris transaksi, baris Saldo Awal TIDAK DILAKUKAN DI SINI
            const rowsToRemove = tableBody.querySelectorAll('tr:not(.saldo-awal-row)');
            rowsToRemove.forEach(row => row.remove());

            let saldoAwal;
            const saldoAwalInput = document.getElementById('m2-saldo-awal-input');
            if (saldoAwalInput) {
                saldoAwal = parseFloat(saldoAwalInput.value) || 0;
            } else {
                // Ambil saldo awal dari Modul 3 (hardcoded) jika input tidak ada (misal di halaman lain)
                saldoAwal = parseFloat(document.getElementById('saldo-bank-awal-input').value || 0) + parseFloat(document.getElementById('saldo-tunai-awal-input').value || 0);
            }
            
            let runningSaldo = saldoAwal;
            document.getElementById('m2-saldo-awal-display').textContent = formatNominal(saldoAwal);
            document.getElementById('m2-saldo-awal-static').textContent = formatNominal(saldoAwal);

            const aksiVisibilityStyle = isLoggedIn ? '' : 'none';
            const saldoAwalAksiTd = document.getElementById('td-m2-saldo-awal-aksi');
            if (saldoAwalAksiTd) { saldoAwalAksiTd.style.display = aksiVisibilityStyle; }

            // 2. Buat Transaksi Otomatis (Auto-Generated Transactions) - LOGIKA ASLI
            const koinNUData = getKoinNUAggregateData();
            const totalNominalKoin = koinNUData.totalNominal;
            const autoDate = null; 
            const autoTransactions = [];
            
            // Logika Hardcoded Anda dipertahankan: 4 baris OTOMATIS
            if (totalNominalKoin > 0) {
                autoTransactions.push({ date: autoDate, keterangan: 'Penerimaan Koin NU (100% dari Modul 1A)', kategori: 'Koin NU (Otomatis)', debit: totalNominalKoin, kredit: 0, isAuto: true });
                autoTransactions.push({ date: autoDate, keterangan: 'Pengeluaran Honor Petugas (10%)', kategori: 'Honor Petugas (Otomatis)', debit: 0, kredit: koinNUData.totalHonorPetugas, isAuto: true });
                autoTransactions.push({ date: autoDate, keterangan: 'Pengeluaran Honor MWC (25%)', kategori: 'Honor MWC (Otomatis)', debit: 0, kredit: koinNUData.totalHonorMWC, isAuto: true });
                autoTransactions.push({ date: autoDate, keterangan: 'Pengeluaran Honor PC (5%)', kategori: 'Honor PC (Otomatis)', debit: 0, kredit: koinNUData.totalHonorPC, isAuto: true });
            } 
            
            // 3. Urutkan Manual Transactions (SUDAH TERFILTER DARI FIREBASE)
            const sortedManualTransactions = getFilteredM2ManualTransactions();

            // 4. Gabungkan Auto dan Manual Transactions (Fixed Order)
            const allTransactions = [...autoTransactions, ...sortedManualTransactions];

            let totalMasuk = 0;
            let totalKeluar = 0;

            allTransactions.forEach((tx, index) => {
                const row = tableBody.insertRow();
                row.classList.add(tx.isAuto ? 'auto-transaction-row' : '');

                runningSaldo += tx.debit - tx.kredit;
                totalMasuk += tx.debit;
                totalKeluar += tx.kredit;

                // Aksi hanya bisa dilakukan pada transaksi manual (non-otomatis)
                const actionButtons = tx.isAuto ? '-' : `
                    <button class="action-btn edit-btn" onclick="editManualTxn('${tx.id}')">Edit</button>
                    <button class="action-btn delete-btn" onclick="deleteManualTxn('${tx.id}')">Hapus</button>
                `;

                row.innerHTML = `
                    <td class="text-center">${index + 1}</td>
                    <td>${tx.date ? tx.date : '-'}</td>
                    <td>${tx.keterangan}</td>
                    <td>${tx.kategori}</td>
                    <td class="text-right">${formatNominal(tx.debit)}</td>
                    <td class="text-right">${formatNominal(tx.kredit)}</td>
                    <td class="text-right">${formatNominal(runningSaldo)}</td>
                    <td class="text-center" style="display: ${aksiVisibilityStyle};">${actionButtons}</td>
                `;
            });

            // Update footer totals
            document.getElementById('m2-total-masuk').textContent = formatNominal(totalMasuk);
            document.getElementById('m2-total-keluar').textContent = formatNominal(totalKeluar);
            document.getElementById('m2-footer-saldo-total').textContent = formatNominal(runningSaldo);
            
            // Update footer AKSI column visibility
            document.getElementById('th-m2-aksi').style.display = aksiVisibilityStyle;
            document.getElementById('tf-m2-aksi').style.display = aksiVisibilityStyle;
        }

        // ===================================
        // --- MODUL 1 LOGIC: INPUT AGREGAT (CRUD) ---
        // ===================================

        function parseInput(id) {
            const el = document.getElementById(id);
            return el ? parseFloat(el.value) || 0 : 0;
        }

        // Fungsi ini sekarang menyimpan data ke Firebase (bukan lagi mengambil dari array lokal)
        async function saveModul1Data(monthData) {
            if (!isLoggedIn) return alert('Anda harus login sebagai Admin untuk menyimpan data.');

            // Ambil semua input dari form Modul 1
            const prefix = `m1-${monthData.order}-`;
            
            const updatedData = {
                ...monthData,
                penerimaan: parseInput(prefix + 'penerimaan'),
                donatur: parseInput(prefix + 'donatur'),
                pendUang: parseInput(prefix + 'pendUang'),
                pendPenerima: parseInput(prefix + 'pendPenerima'),
                kesUang: parseInput(prefix + 'kesUang'),
                kesPenerima: parseInput(prefix + 'kesPenerima'),
                ekoUang: parseInput(prefix + 'ekoUang'),
                ekoPenerima: parseInput(prefix + 'ekoPenerima'),
                sosumUang: parseInput(prefix + 'sosumUang'),
                sosumPenerima: parseInput(prefix + 'sosumPenerima'),
                banomUang: parseInput(prefix + 'banomUang'),
                banomPenerima: parseInput(prefix + 'banomPenerima'),
                bencanaUang: parseInput(prefix + 'bencanaUang'),
                bencanaPenerima: parseInput(prefix + 'bencanaPenerima'),
                rapat: parseInput(prefix + 'rapat'),
                perwtnMlu: parseInput(prefix + 'perwtnMlu'),
                biayaBank: parseInput(prefix + 'biayaBank'),
                lainLain: parseInput(prefix + 'lainLain'),
                // HonorWajibPercent tidak diubah di sini, tetap 0.40
            };
            
            try {
                if (monthData.id) {
                    // Jika sudah ada ID, UPDATE data
                    await db.collection(M1_COLLECTION).doc(monthData.id).update(updatedData);
                } else {
                    // Jika belum ada ID, ADD data baru
                    await db.collection(M1_COLLECTION).add(updatedData);
                }

                alert(`Data Agregat Bulan ${monthData.bulan} berhasil disimpan.`);
                
                // Refresh data dan laporan
                await loadDataFromFirebase();
                recalculateAllReports();

            } catch (error) {
                console.error("Error saving Modul 1 data: ", error);
                alert("Gagal menyimpan data agregat: " + error.message);
            }
        }
        
        function updateModul1() {
            // [.. Fungsi updateModul1 TIDAK BERUBAH. Sekarang menggunakan array global initialData yang sudah diisi dari Firebase ..]
            const inputBody = document.getElementById('m1-input-body');
            inputBody.innerHTML = '';
            
            // Menampilkan data berdasarkan filter tahun yang dipilih
            const dataFilteredByYear = initialData.filter(d => d.year === currentFilterYear);

            // Jika koleksi laporan_tahunan kosong, initialData akan berisi data default 12 bulan
            const dataToUse = dataFilteredByYear.length > 0 ? dataFilteredByYear : initialData.slice(0, 12);
            
            const aksiVisibilityStyle = isLoggedIn ? '' : 'none';

            dataToUse.forEach(data => {
                const prefix = `m1-${data.order}-`;
                const row = inputBody.insertRow();

                // Button SAVE kini memanggil fungsi saveModul1Data dengan data bulan tersebut
                const actionButton = `<button onclick="saveModul1Data(${JSON.stringify(data).replace(/"/g, '&quot;')})" style="padding: 3px 8px; background-color: #007bff; color: white; border: none; cursor: pointer;">SIMPAN</button>`;
                
                // [.. Konten baris tabel M1 di sini ..]
                row.innerHTML = `
                    <td class="text-center">${data.order}</td>
                    <td>${data.bulan}</td>
                    <td><input type="number" id="${prefix}penerimaan" value="${data.penerimaan}" min="0" style="display: ${isLoggedIn ? 'block' : 'none'};"> <span style="display: ${isLoggedIn ? 'none' : 'block'};">${formatNominal(data.penerimaan)}</span></td>
                    <td><input type="number" id="${prefix}donatur" value="${data.donatur}" min="0" style="display: ${isLoggedIn ? 'block' : 'none'};"> <span style="display: ${isLoggedIn ? 'none' : 'block'};">${formatNominal(data.donatur)}</span></td>
                    
                    <td class="text-center" style="width: 100px; display: ${aksiVisibilityStyle};">${actionButton}</td>
                `;
                
                // [.. Logika untuk mengisi semua kolom input di Modul 1 (seperti di kode asli) ..]
            });
        }

        // ===================================
        // --- MODUL 3 LOGIC: LAPORAN TAHUNAN (TIDAK BERUBAH) ---
        // ===================================

        function updateLaporanTahunan() {
            // [.. Fungsi updateLaporanTahunan TIDAK BERUBAH. Hanya menggunakan array global initialData yang sudah diisi dari Firebase ..]
            // ... (gunakan logika lama Anda yang bergantung pada initialData) ...
            
            // ... (logika perhitungan total tahunan) ...

            // ... (logika rendering tabel, Saldo Awal juga diisi dari input/state) ...
        }

        // ===================================
        // --- ADMIN / AUTH LOGIC ---
        // ===================================
        
        async function resetAllData() {
            if (!isLoggedIn) return;
            if (confirm("Anda yakin ingin MENGHAPUS SEMUA DATA TRANSAKSI (Modul 1A & Modul 2) dari Firebase? Tindakan ini TIDAK DAPAT DIBATALKAN.")) {
                try {
                    // Hapus koleksi Modul 1A (laporan_koin_nu)
                    const m1aDocs = await db.collection(M1A_COLLECTION).get();
                    const m1aDeletePromises = m1aDocs.docs.map(doc => doc.ref.delete());
                    await Promise.all(m1aDeletePromises);
                    
                    // Hapus koleksi Modul 2 (jurnal_umum)
                    const m2Docs = await db.collection(M2_COLLECTION).get();
                    const m2DeletePromises = m2Docs.docs.map(doc => doc.ref.delete());
                    await Promise.all(m2DeletePromises);
                    
                    alert("SEMUA DATA TRANSAKSI berhasil dihapus dari Firebase!");
                    await loadDataFromFirebase();
                    recalculateAllReports();
                } catch (error) {
                    console.error("Error saat reset data: ", error);
                    alert("Gagal mereset data: " + error.message);
                }
            }
        }

        function login() {
            // [.. Fungsi login yang Anda inginkan (misal login anonim/email/pass) ..]
            isLoggedIn = true; // Placeholder
            handleAuthStateChange({ email: document.getElementById('username').value });
        }
        
        function logout() {
            // [.. Fungsi logout ..]
            isLoggedIn = false; // Placeholder
            handleAuthStateChange(null);
        }
        
        function handleAuthStateChange(user) {
            // [.. Fungsi ini mengatur tampilan Admin ..]
            const loginContainer = document.getElementById('login-form-content-bar');
            const logoutContainer = document.getElementById('logout-form-content-bar');
            const adminStatus = document.getElementById('admin-status');
            const adminElements = document.querySelectorAll('.admin-only');

            if (isLoggedIn) { // Ubah ini menjadi 'if (user)' jika menggunakan auth Firebase sesungguhnya
                loginContainer.style.display = 'none';
                logoutContainer.style.display = 'flex';
                adminStatus.textContent = 'Aktif (Admin)';
                adminElements.forEach(el => el.style.display = ''); 
                
                // Toggle Saldo Awal Input vs Static Display in Modul 2
                const saldoInputContainer = document.getElementById('m2-saldo-awal-display-container');
                const saldoStatic = document.getElementById('m2-saldo-awal-static');
                if (saldoInputContainer && saldoStatic) { 
                    saldoInputContainer.style.display = 'block';
                    saldoStatic.style.display = 'none';
                }
                
            } else {
                loginContainer.style.display = 'flex';
                logoutContainer.style.display = 'none';
                adminElements.forEach(el => el.style.display = 'none'); 

                // Toggle Saldo Awal Input vs Static Display in Modul 2
                const saldoInputContainer = document.getElementById('m2-saldo-awal-display-container');
                const saldoStatic = document.getElementById('m2-saldo-awal-static');
                if (saldoInputContainer && saldoStatic) { 
                    saldoInputContainer.style.display = 'none';
                    saldoStatic.style.display = 'block';
                }
            }
            recalculateAllReports();
        }

        // ===================================
        // --- MAIN CONTROL FUNCTION ---
        // ===================================
        
        async function recalculateAllReports() {
            // Karena semua data diambil dan disimpan di variabel global (m1aTransactions, m2ManualTransactions, initialData)
            // maka fungsi laporan/rendering tetap bisa dipanggil seperti sebelumnya.
            
            // 1. Update Modul 1A & Modul 2 (depends on each other's output)
            updatePenerimaanDetail();
            updateJurnalUmum(); 
            
            // 2. Update Modul 1 (Input Agregat)
            updateModul1(); 

            // 3. Update Modul 3 (Laporan Tahunan)
            updateLaporanTahunan();
        }

        // ===================================
        // --- ONLOAD FUNCTION ---
        // ===================================

        window.onload = async () => {
            // 1. Initialize Firebase
            firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            auth = firebase.auth(); 
            
            // 2. Load data from Firebase
            await loadDataFromFirebase();
            
            // 3. Populate Filters (Harus dipanggil setelah initialData dimuat jika tahun/bulan disinkronkan)
            populateFilters();
            
            // 4. Render App View (Simulasi login default: Jika Anda menggunakan Firebase Auth sesungguhnya, gunakan auth.onAuthStateChanged)
            handleAuthStateChange(null); 
            switchModule('modul-1a-section'); // Tampilkan Modul 1A sebagai default
        };
        
        // [.. Definisikan kembali semua fungsi laporan/utility yang belum ada di atas (updateLaporanTahunan, dll.) ..]
        
    </script>

</body>
</html>
