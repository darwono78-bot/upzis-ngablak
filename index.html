<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Input & Laporan KOIN NU Paling Detail</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 0 0 80px 0; background-color: #f8f9fa; margin: 0; }
        h1, h2 { color: #006400; margin: 15px 0 10px 0;}
        
        /* CSS untuk Navbar */
        #main-nav {
            background-color: #006400;
            padding: 10px 20px;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        #main-nav h1 {
            color: white;
            font-size: 18px;
            margin: 0;
            flex-shrink: 0;
        }
        #nav-menu {
            display: flex;
            list-style: none;
            padding: 0;
            margin: 0;
        }
        #nav-menu li {
            margin-left: 20px;
        }
        #nav-menu button {
            background: none;
            border: none;
            color: white;
            padding: 8px 15px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            border-radius: 4px;
            transition: background-color 0.3s;
        }
        #nav-menu button.active {
            background-color: #4CAF50;
        }
        #nav-menu button:hover {
            background-color: #004d00;
        }

        /* Kontainer Utama Laporan */
        #report-container {
            padding: 20px;
        }

        /* Kontainer Modul */
        .module-section {
            padding: 15px 0;
        }
        
        /* === NEW: TABLE SCROLL WRAPPER === */
        .table-scroll-wrapper {
            width: 100%;
            overflow-x: auto; /* Enable horizontal scrolling */
            margin-bottom: 20px;
        }
        
        /* Tabel Styles */
        table { 
            width: 100%; 
            border-collapse: collapse; 
            min-width: 1000px; 
            background-color: white; 
            font-size: 11px; 
            table-layout: auto; /* Memungkinkan kolom menyesuaikan lebar konten */
        } 
        /* Modul 3 perlu lebih lebar minimum */
        #tabel-modul-3 {
            min-width: 2500px; /* Lebar Minimum diperbesar */
        }
        
        /* Style Kolom Uang agar memiliki minimum width */
        .col-nominal {
            min-width: 100px; /* Lebar minimum untuk nominal uang di M1A/M2 */
        }
        .col-aksi {
            width: 40px; /* Tetapkan lebar tetap untuk kolom aksi */
        }
        
        /* Override untuk Operasional M1 (tetap 70px agar seragam dengan Jml Uang sosial M1) */
        #tabel-modul-1 th:nth-child(16), #tabel-modul-1 td:nth-child(16),
        #tabel-modul-1 th:nth-child(17), #tabel-modul-1 td:nth-child(17),
        #tabel-modul-1 th:nth-child(18), #tabel-modul-1 td:nth-child(18),
        #tabel-modul-1 th:nth-child(19), #tabel-modul-1 td:nth-child(19) {
            min-width: 70px !important; 
        }
        /* ====================================================================================== */
        
        /* === FIX BARU: Lebar Kolom Jml Pnm di Modul 1 & Modul 3 agar tidak terlalu sempit (60px) === */
        /* Kolom 5, 7, 9, 11, 13, 15 adalah kolom 'Jml Pnm' (untuk M1) */
        #tabel-modul-1 th:nth-child(5), #tabel-modul-1 td:nth-child(5),
        #tabel-modul-1 th:nth-child(7), #tabel-modul-1 td:nth-child(7),
        #tabel-modul-1 th:nth-child(9), #tabel-modul-1 td:nth-child(9),
        #tabel-modul-1 th:nth-child(11), #tabel-modul-1 td:nth-child(11),
        #tabel-modul-1 th:nth-child(13), #tabel-modul-1 td:nth-child(13),
        #tabel-modul-1 th:nth-child(15), #tabel-modul-1 td:nth-child(15),
        /* Modul 3: Kolom 6, 8, 10, 12, 14, 16 (Jml Pnm) */
        #tabel-modul-3 th:nth-child(6), #tabel-modul-3 td:nth-child(6),
        #tabel-modul-3 th:nth-child(8), #tabel-modul-3 td:nth-child(8),
        #tabel-modul-3 th:nth-child(10), #tabel-modul-3 td:nth-child(10),
        #tabel-modul-3 th:nth-child(12), #tabel-modul-3 td:nth-child(12),
        #tabel-modul-3 th:nth-child(14), #tabel-modul-3 td:nth-child(14),
        #tabel-modul-3 th:nth-child(16), #tabel-modul-3 td:nth-child(16) {
            min-width: 60px !important; 
            width: 60px !important; 
        }
        /* ====================================================================================== */

        /* === PERBAIKAN UTAMA: Samakan lebar semua kolom uang di Modul 3 menjadi 70px === */
        #tabel-modul-3 th:nth-child(3), #tabel-modul-3 td:nth-child(3), /* Total Koin (3) */
        #tabel-modul-3 th:nth-child(5), #tabel-modul-3 td:nth-child(5), /* Jml Uang Pendidikan */
        #tabel-modul-3 th:nth-child(7), #tabel-modul-3 td:nth-child(7), /* Jml Uang Kesehatan */
        #tabel-modul-3 th:nth-child(9), #tabel-modul-3 td:nth-child(9), /* Jml Uang Ekonomi */
        #tabel-modul-3 th:nth-child(11), #tabel-modul-3 td:nth-child(11), /* Jml Uang Sosum */
        #tabel-modul-3 th:nth-child(13), #tabel-modul-3 td:nth-child(13), /* Jml Uang Banom */
        #tabel-modul-3 th:nth-child(15), #tabel-modul-3 td:nth-child(15), /* Jml Uang Bencana */
        #tabel-modul-3 th:nth-child(17), #tabel-modul-3 td:nth-child(17), /* Rapat */
        #tabel-modul-3 th:nth-child(18), #tabel-modul-3 td:nth-child(18), /* PERWTN MLU */
        #tabel-modul-3 th:nth-child(19), #tabel-modul-3 td:nth-child(19), /* BIAYA REK BANK */
        #tabel-modul-3 th:nth-child(20), #tabel-modul-3 td:nth-child(20), /* Lain - Lain */
        /* START: NEW HONOR WAJIB (3 COLUMNS) & SHIFTED FINAL COLUMNS */
        #tabel-modul-3 th:nth-child(21), #tabel-modul-3 td:nth-child(21), /* Honor Petugas (10%) */
        #tabel-modul-3 th:nth-child(22), #tabel-modul-3 td:nth-child(22), /* Honor MWC (25%) */
        #tabel-modul-3 th:nth-child(23), #tabel-modul-3 td:nth-child(23), /* Honor PC (5%) */
        #tabel-modul-3 th:nth-child(24), #tabel-modul-3 td:nth-child(24), /* JML Pengeluaran (7) */
        #tabel-modul-3 th:nth-child(25), #tabel-modul-3 td:nth-child(25), /* SALDO AKHIR */
        #tabel-modul-3 th:nth-child(26), #tabel-modul-3 td:nth-child(26)  /* SALDO KAS */
        {
            min-width: 70px !important; 
            width: 70px !important; 
            box-sizing: border-box;
        }
        /* ====================================================================================== */
        
        /* Overrides untuk kolom-kolom yang tidak boleh terlalu kecil */
        #tabel-modul-2 th:nth-child(3) { min-width: 200px; } /* KETERANGAN */
        #tabel-modul-2 th:nth-child(5), /* DEBIT */
        #tabel-modul-2 th:nth-child(6), /* KREDIT */
        #tabel-modul-2 th:nth-child(7) { /* SALDO */
            min-width: 120px; /* Lebar minimum lebih besar untuk nominal di M2 */
        }

        th, td { border: 1px solid #ddd; padding: 4px 6px; text-align: left; word-wrap: break-word; } 
        th { background-color: #006400; color: white; text-align: center; }
        .text-right { text-align: right; }
        .text-center { text-align: center; }
        .footer-total { background-color: #e6ffe6; font-weight: bold; }
        .koin-nu-header { background-color: #4CAF50 !important; color: white !important; }
        
        /* Input Styles */
        input[type="number"], input[type="text"], input[type="date"], select { 
            width: 90%; 
            padding: 2px; 
            border: 1px solid #ccc; 
            text-align: right; 
            box-sizing: border-box; 
            font-size: 11px; 
            background-color: white;
        }
        .input-form-container { 
            background-color: #e9f5ff; 
            padding: 15px; 
            border-radius: 8px; 
            margin-bottom: 20px;
            border: 1px solid #cceeff;
        }
        .form-row { display: flex; gap: 10px; margin-bottom: 10px; align-items: flex-end; }
        .form-row > div { flex: 1; }
        .form-row label { display: block; font-weight: bold; font-size: 11px; margin-bottom: 3px; }
        .form-row > div.flex-fix { flex: 0 0 120px; } /* Untuk kolom tanggal/nominal yang fix */
        
        /* Teks Input non-angka harus rata kiri */
        #m1a-keterangan-input, #m2-keterangan-input, #m1a-nama-petugas-input, #m1a-donatur-input, #m1a-alamat-input {
            text-align: left !important;
        }

        /* Baris Khusus */
        .auto-transaction-row td { background-color: #ffcccc; font-style: italic; }
        .saldo-awal-row td { background-color: #fffacd; font-weight: bold; } 
        
        /* Style untuk tombol aksi */
        .action-btn { 
            padding: 1px 3px; 
            font-size: 9px; 
            border: none; 
            cursor: pointer; 
            margin: 0; 
            flex-shrink: 0;
        }
        .edit-btn { background-color: #ffc107; color: black; }
        .delete-btn { background-color: #dc3545; color: white; }

        /* Login/Logout Bar (Fixed Bottom) */
        #login-container-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: #343a40; 
            color: white;
            padding: 8px 20px;
            box-shadow: 0 -2px 5px rgba(0,0,0,0.1);
            display: flex;
            justify-content: flex-end; 
            align-items: center;
            box-sizing: border-box;
            z-index: 1000;
        }
        #login-form-content-bar {
            display: flex;
            align-items: center;
        }
        #login-form-content-bar input {
            width: 120px;
            margin: 0 5px;
            padding: 5px;
            font-size: 12px;
            border: 1px solid #6c757d;
            background-color: #495057;
            color: white;
        }
        #login-form-content-bar label {
             font-size: 12px;
             margin-right: 5px;
        }
        #login-form-content-bar button {
            padding: 5px 10px;
            background-color: #28a745;
            color: white;
            border: none;
            cursor: pointer;
            font-size: 12px;
        }
        #login-message-bar {
            color: #ffc107;
            margin-left: 10px;
            font-size: 12px;
            font-weight: bold;
        }
        #logout-form-content-bar {
            display: flex;
            align-items: center;
        }
        #logout-form-content-bar p {
            margin: 0 15px 0 0;
            font-weight: bold;
            color: #28a745;
            font-size: 12px;
        }
        #logout-form-content-bar button {
            padding: 5px 15px; 
            background-color: #dc3545; 
            color: white; 
            border: none; 
            cursor: pointer; 
            font-size: 12px;
        }
    </style>
</head>
<body>
    
    <nav id="main-nav">
        <h1>Sistem Laporan KOIN NU</h1>
        <ul id="nav-menu">
            <li><button id="nav-m1a" onclick="switchModule('modul-1a-section')" class="active">Modul 1A (Penerimaan Detail)</button></li>
            <li><button id="nav-m2" onclick="switchModule('modul-2-section')">Modul 2 (Jurnal Umum)</button></li>
            <li><button id="nav-m3" onclick="switchModule('modul-3-section')">Modul 3 (Laporan Tahunan)</button></li>
            <li><button id="nav-m1" onclick="switchModule('modul-1-section')">Modul 1 (Input Agregat)</button></li>
        </ul>
    </nav>
    
    <div id="report-container">
        
        <div style="display: flex; justify-content: center; align-items: center; margin-bottom: 10px;">
            
            <div style="
                width: 100px; 
                height: 100px; 
                margin-right: 15px; 
                background-image: url('logo-lazisnu.png'); 
                background-size: contain; /* Memastikan gambar penuh dan pita bawah terlihat */
                background-repeat: no-repeat;
                background-position: center; 
                flex-shrink: 0;
            "></div>
            
            <div style="text-align: left;">
                <h2 style="margin: 0; color: #006400; font-size: 22px;">NU CARE UPZIS - LAZISNU RANTING NGABLAK</h2>
                <p style="margin: 0; font-size: 15px; color: #333;">Sekretariat: Jalan [Nama Jalan], Desa Ngablak, Kec. [Kecamatan], Kab. [Kabupaten]</p>
            </div>
            
        </div>
        <hr style="border-top: 3px double #000; margin-top: 0px; margin-bottom: 20px;">
        <div id="modul-1a-section" class="module-section">
            <h2>MODUL 1A: JURNAL PENERIMAAN KOIN NU DETAIL</h2>
            
            <div style="display: flex; gap: 20px; align-items: center; margin-bottom: 15px; padding: 5px; border-left: 5px solid #006400;">
                <div style="flex-shrink: 0; font-weight: bold; color: #006400; font-size: 12px;">Filter:</div>
                <div>
                    <select id="filter-bulan-m1a" onchange="updateFilters(this.id, this.value)"></select>
                </div>
                <div>
                    <select id="filter-tahun-m1a" onchange="updateFilters(this.id, this.value)"></select>
                </div>
            </div>
            
            <div class="table-scroll-wrapper">
                <table id="tabel-modul-1a">
                    <thead>
                        <tr>
                            <th style="width: 30px;">NO</th>
                            <th style="width: 80px;">TANGGAL</th>
                            <th style="min-width: 100px;">NAMA PETUGAS</th>
                            <th style="width: 70px;">NO HP</th>
                            <th style="min-width: 120px;">DONATUR/KELOMPOK</th>
                            <th>ALAMAT (RT/RW)</th>
                            <th class="col-nominal">NOMINAL (100%)</th>
                            <th class="koin-nu-header col-nominal">Petugas (10%)</th>
                            <th class="koin-nu-header col-nominal">MWC (25%)</th>
                            <th class="koin-nu-header col-nominal">PC (5%)</th>
                            <th class="koin-nu-header col-nominal">Ranting (60%)</th>
                            <th id="th-m1a-aksi" class="col-aksi">AKSI</th> 
                        </tr>
                    </thead>
                    <tbody id="m1a-transaction-body">
                        </tbody>
                    <tfoot>
                        <tr>
                            <td colspan="6" class="footer-total text-right">TOTAL PENERIMAAN KOIN NU</td>
                            <td id="m1a-total-nominal" class="footer-total text-right">0</td>
                            <td id="m1a-total-petugas" class="footer-total text-right">0</td>
                            <td id="m1a-total-mwc" class="footer-total text-right">0</td>
                            <td id="m1a-total-pc" class="footer-total text-right">0</td>
                            <td id="m1a-total-ranting" class="footer-total text-right">0</td>
                            <td id="tf-m1a-aksi" class="footer-total text-center">-</td> 
                        </tr>
                    </tfoot>
                </table>
            </div> <div class="admin-only" style="margin-bottom: 15px; border: 1px solid #dc3545; padding: 10px; border-radius: 5px; background-color: #f8d7da;">
                <p style="color: #721c24; font-weight: bold; margin-bottom: 5px;">
                    ⚠️ **PERHATIAN:** Klik tombol ini untuk menghapus **SEMUA** data transaksi yang ada di Modul 1A dan Modul 2. Tindakan ini **TIDAK** dapat dibatalkan.
                </p>
                <button onclick="resetAllData()" style="padding: 5px 15px; background-color: #dc3545; color: white; border: none; cursor: pointer; font-weight: bold;">
                    <span id="reset-button-text">RESET SEMUA DATA TRANSAKSI</span>
                </button>
            </div>

            <div class="input-form-container admin-only">
                <h3 style="margin-top: 0; color: #4CAF50;">Input Transaksi Koin NU</h3>
                <div class="form-row">
                    <div class="flex-fix">
                        <label for="m1a-tanggal-input">Tanggal</label>
                        <input type="date" id="m1a-tanggal-input" style="width: 100%;">
                    </div>
                    <div>
                        <label for="m1a-nama-petugas-input">Nama Petugas</label>
                        <input type="text" id="m1a-nama-petugas-input" style="width: 100%; text-align: left;">
                    </div>
                    <div class="flex-fix">
                        <label for="m1a-no-hp-input">No HP</label>
                        <input type="text" id="m1a-no-hp-input" style="width: 100%; text-align: left;">
                    </div>
                    <div>
                        <label for="m1a-donatur-input">Donatur/Kelompok</label>
                        <input type="text" id="m1a-donatur-input" style="width: 100%; text-align: left;">
                    </div>
                    <div>
                        <label for="m1a-alamat-input">Alamat (RT/RW)</label>
                        <input type="text" id="m1a-alamat-input" style="width: 100%; text-align: left;">
                    </div>
                    <div style="flex: 1.5;">
                        <label for="m1a-nominal-input">NOMINAL Koin NU (100%)</label>
                        <input type="number" id="m1a-nominal-input" value="" min="1" placeholder="Masukkan Nominal">
                    </div>
                </div>
                <button onclick="addKoinNUTransaction()" style="padding: 5px 15px; background-color: #4CAF50; color: white; border: none; cursor: pointer;">+ Tambah Koin NU</button>
                <button onclick="clearKoinNUInputs()" style="padding: 5px 15px; background-color: #f44336; color: white; border: none; cursor: pointer;">Bersihkan Input</button>
            </div>
        </div>

        <div id="modul-2-section" class="module-section" style="display: none;">
            <h2>MODUL 2: JURNAL UMUM (Buku Kas)</h2>
            
            <div style="display: flex; gap: 20px; align-items: center; margin-bottom: 15px; padding: 5px; border-left: 5px solid #006400;">
                <div style="flex-shrink: 0; font-weight: bold; color: #006400; font-size: 12px;">Filter:</div>
                <div>
                    <select id="filter-bulan-m2" onchange="updateFilters(this.id, this.value)"></select>
                </div>
                <div>
                    <select id="filter-tahun-m2" onchange="updateFilters(this.id, this.value)"></select>
                </div>
            </div>
            
            <div class="table-scroll-wrapper">
                <table id="tabel-modul-2">
                    <thead>
                        <tr>
                            <th style="width: 30px;">NO</th>
                            <th style="width: 90px;">TANGGAL</th>
                            <th style="min-width: 200px;">KETERANGAN</th>
                            <th>KATEGORI</th>
                            <th style="min-width: 120px;">DANA MASUK (DEBIT)</th>
                            <th style="min-width: 120px;">DANA KELUAR (KREDIT)</th>
                            <th style="min-width: 120px;">SALDO</th>
                            <th id="th-m2-aksi" class="col-aksi">AKSI</th> 
                        </tr>
                    </thead>
                    <tbody id="m2-transaction-body">
                        <tr>
                            <td colspan="4" class="saldo-awal-row text-right">Saldo Bulan Lalu:</td>
                            <td colspan="2">
                                <div id="m2-saldo-awal-display-container" class="admin-only" style="width: 100%; text-align: right; background-color: #fffacd; font-weight: bold; padding: 0; box-sizing: border-box;">
                                    <input type="number" id="m2-saldo-awal-input" value="15000000" min="0" oninput="recalculateAllReports()" style="width: 100%; text-align: right; background-color: #fffacd; font-weight: bold; padding: 2px;">
                                </div>
                                <div id="m2-saldo-awal-static" class="saldo-awal-row text-right" style="padding: 2px 6px; display: none;"></div> </td>
                            <td id="m2-saldo-awal-display" class="saldo-awal-row text-right">0</td>
                            <td id="td-m2-saldo-awal-aksi" class="saldo-awal-row text-center">-</td> 
                        </tr>
                        </tbody>
                    <tfoot>
                        <tr>
                            <td colspan="4" class="footer-total text-right">TOTAL</td>
                            <td id="m2-total-masuk" class="footer-total text-right">0</td>
                            <td id="m2-total-keluar" class="footer-total text-right">0</td>
                            <td id="m2-footer-saldo-total" class="footer-total text-right">0</td>
                            <td id="tf-m2-aksi" class="footer-total text-center">-</td> 
                        </tr>
                    </tfoot>
                </table>
            </div> <div class="admin-only" style="margin-bottom: 15px; border: 1px solid #dc3545; padding: 10px; border-radius: 5px; background-color: #f8d7da;">
                <p style="color: #721c24; font-weight: bold; margin-bottom: 5px;">
                    ⚠️ **PERHATIAN:** Klik tombol ini untuk menghapus **SEMUA** data transaksi yang ada di Modul 1A dan Modul 2. Tindakan ini **TIDAK** dapat dibatalkan.
                </p>
                <button onclick="resetAllData()" style="padding: 5px 15px; background-color: #dc3545; color: white; border: none; cursor: pointer; font-weight: bold;">
                    <span id="reset-button-text-m2">RESET SEMUA DATA TRANSAKSI</span>
                </button>
            </div>


            <div class="input-form-container admin-only">
                <h3 style="margin-top: 0; color: #007bff;">Input Transaksi Lainnya (Non-Koin NU)</h3>
                <div class="form-row">
                    <div class="flex-fix">
                        <label for="m2-tanggal-input">Tanggal</label>
                        <input type="date" id="m2-tanggal-input" style="width: 100%;">
                    </div>
                    <div style="flex: 2;">
                        <label for="m2-keterangan-input">Keterangan</label>
                        <input type="text" id="m2-keterangan-input" style="width: 100%; text-align: left;">
                    </div>
                    <div style="flex: 1;">
                        <label for="m2-kategori-input">Kategori</label>
                        <select id="m2-kategori-input" style="width: 100%; text-align: left; background-color: white;">
                            <option value="">-- Pilih Kategori --</option>
                            <optgroup label="Dana Masuk (Debit) Non-Koin">
                                <option value="Donatur Umum">Donatur Umum</option>
                                <option value="Zakat Maal">Zakat Maal</option>
                                <option value="Infaq dan Shodaqoh">Infaq dan Shodaqoh</option>
                                <option value="Hasil Usaha">Hasil Usaha</option>
                            </optgroup>
                            <optgroup label="Dana Keluar Lain-Lain (Kredit)">
                                <option value="Pendidikan (Lainnya)">Pendidikan (Lainnya)</option>
                                <option value="Sosial (Lainnya)">Sosial (Lainnya)</option>
                                <option value="Ekonomi (Lainnya)">Ekonomi (Lainnya)</option>
                                <option value="Kesehatan (Lainnya)">Kesehatan (Lainnya)</option>
                                <option value="Subsidi Banom (Lainnya)">Subsidi Banom (Lainnya)</option>
                                <option value="Bencana (Lainnya)">Bencana (Lainnya)</option>
                                <option value="Rapat">Rapat</option>
                                <option value="Perawatan MLU">PERWTN MLU</option>
                                <option value="Biaya Bank">BIAYA REK BANK</option>
                                <option value="Lain-Lain">Lain - Lain</option>
                            </optgroup>
                        </select>
                    </div>
                    <div style="flex: 1;">
                        <label for="m2-debit-input">DANA MASUK (DEBIT)</label>
                        <input type="number" id="m2-debit-input" value="0" min="0" onfocus="if(this.value=='0')this.value=''" onblur="if(this.value=='')this.value='0'">
                    </div>
                    <div style="flex: 1;">
                        <label for="m2-kredit-input">DANA KELUAR (KREDIT)</label>
                        <input type="number" id="m2-kredit-input" value="0" min="0" onfocus="if(this.value=='0')this.value=''" onblur="if(this.value=='')this.value='0'">
                    </div>
                </div>
                <button onclick="addManualTransaction()" style="padding: 5px 15px; background-color: #28a745; color: white; border: none; cursor: pointer;">+ Tambah Transaksi Lain</button>
                <button onclick="clearManualTransactionInputs()" style="padding: 5px 15px; background-color: #dc3545; color: white; border: none; cursor: pointer;">Bersihkan Input</button>
            </div>
        </div>
        
        <div id="modul-3-section" class="module-section" style="display: none;">
            <h2>MODUL 3: TAMPILAN LAPORAN TAHUNAN</h2>
            
            <div style="display: flex; gap: 20px; align-items: center; margin-bottom: 15px; padding: 5px; border-left: 5px solid #006400;">
                <div style="flex-shrink: 0; font-weight: bold; color: #006400; font-size: 12px;">Filter:</div>
                <div>
                    <select id="filter-bulan-m3" onchange="updateFilters(this.id, this.value)"></select>
                </div>
                <div>
                    <select id="filter-tahun-m3" onchange="updateFilters(this.id, this.value)"></select>
                </div>
            </div>
            
            <div class="table-scroll-wrapper">
                <table id="tabel-modul-3">
                    <thead>
                        <tr>
                            <th rowspan="3" style="width: 20px;">NO</th>
                            <th rowspan="3" style="width: 70px;">BULAN</th>
                            <th colspan="2">PENERIMAAN</th>
                            <th colspan="12">PENGELUARAN SOSIAL (JML UANG/JML PENERIMA)</th>
                            <th colspan="4">PENGELUARAN OPERASIONAL</th>
                            <th colspan="3" style="min-width: 210px;">HONOR WAJIB</th>
                            <th rowspan="3" style="min-width: 70px;">JML PENGELUARAN (7)</th>
                            <th rowspan="3" style="min-width: 70px;">SALDO AKHIR BULAN INI (8)</th>
                            <th rowspan="3" style="min-width: 70px;">SALDO KAS TAHUN BERJALAN (9)</th>
                        </tr>
                        <tr>
                            <th rowspan="2" style="min-width: 70px;">Total Koin (3)</th>
                            <th rowspan="2" style="width: 50px;">JML Donatur (4)</th>
                            <th colspan="2">Pendidikan</th>
                            <th colspan="2">Kesehatan</th>
                            <th colspan="2">Ekonomi</th>
                            <th colspan="2">Sosial Umum</th>
                            <th colspan="2">Subsidi Banom & Lembaga NU</th>
                            <th colspan="2">Bencana</th>
                            <th rowspan="2">Rapat</th>
                            <th rowspan="2">PERWTN MLU</th>
                            <th rowspan="2">BIAYA REK BANK</th>
                            <th rowspan="2">Lain - Lain</th>
                            <th rowspan="2" style="min-width: 70px;">Petugas (10%)</th>
                            <th rowspan="2" style="min-width: 70px;">MWC (25%)</th>
                            <th rowspan="2" style="min-width: 70px;">PC (5%)</th>
                        </tr>
                        <tr>
                            <th style="min-width: 70px;">Jml Uang</th>
                            <th style="width: 60px;">Jml Pnm</th>
                            <th style="min-width: 70px;">Jml Uang</th>
                            <th style="width: 60px;">Jml Pnm</th>
                            <th style="min-width: 70px;">Jml Uang</th>
                            <th style="width: 60px;">Jml Pnm</th>
                            <th style="min-width: 70px;">Jml Uang</th>
                            <th style="width: 60px;">Jml Pnm</th>
                            <th style="min-width: 70px;">Jml Uang</th>
                            <th style="width: 60px;">Jml Pnm</th>
                            <th style="min-width: 70px;">Jml Uang</th>
                            <th style="width: 60px;">Jml Pnm</th>
                        </tr>
                    </thead>
                    <tbody id="m3-data-body">
                        </tbody>
                    <tfoot>
                        <tr>
                            <td colspan="2" class="footer-total text-right">TOTAL TAHUNAN</td>
                            <td class="footer-total text-right" id="m3-total-penerimaan">0</td>
                            <td class="footer-total text-right" id="m3-total-donatur">0</td>
                            <td class="footer-total text-right" id="m3-total-pend-uang">0</td>
                            <td class="footer-total text-right" id="m3-total-pend-pnm">0</td>
                            <td class="footer-total text-right" id="m3-total-kes-uang">0</td>
                            <td class="footer-total text-right" id="m3-total-kes-pnm">0</td>
                            <td class="footer-total text-right" id="m3-total-eko-uang">0</td>
                            <td class="footer-total text-right" id="m3-total-eko-pnm">0</td>
                            <td class="footer-total text-right" id="m3-total-sosum-uang">0</td>
                            <td class="footer-total text-right" id="m3-total-sosum-pnm">0</td>
                            <td class="footer-total text-right" id="m3-total-banom-uang">0</td>
                            <td class="footer-total text-right" id="m3-total-banom-pnm">0</td>
                            <td class="footer-total text-right" id="m3-total-bencana-uang">0</td>
                            <td class="footer-total text-right" id="m3-total-bencana-pnm">0</td>
                            <td class="footer-total text-right" id="m3-total-rapat">0</td>
                            <td class="footer-total text-right" id="m3-total-perwtn">0</td>
                            <td class="footer-total text-right" id="m3-total-bank">0</td>
                            <td class="footer-total text-right" id="m3-total-lain">0</td>
                            <td class="footer-total text-right" id="m3-total-honor-petugas">0</td>
                            <td class="footer-total text-right" id="m3-total-honor-mwc">0</td>
                            <td class="footer-total text-right" id="m3-total-honor-pc">0</td>
                            <td class="footer-total text-right" id="m3-total-pengeluaran">0</td>
                            <td class="footer-total text-right" id="m3-footer-saldo-akhir">0</td>
                            <td class="footer-total text-right" id="m3-footer-saldo-kas">0</td>
                        </tr>
                    </tfoot>
                </table>
            </div> <input type="hidden" id="saldo-bank-awal-input" value="10000000">
            <input type="hidden" id="saldo-tunai-awal-input" value="5000000">
        </div>

        <div id="modul-1-section" class="module-section" style="display: none;">
            <h2 class="admin-only">MODUL 1: DATA AGREGAT BULANAN (Input Lama - Untuk Laporan Tahunan)</h2>
            <p class="admin-only" style="color: blue; font-style: italic;">(Data di modul ini hanya digunakan untuk laporan tahunan, tidak terhubung dengan Modul 1A/2)</p>
            
            <div style="display: flex; gap: 20px; align-items: center; margin-bottom: 15px; padding: 5px; border-left: 5px solid #006400;">
                <div style="flex-shrink: 0; font-weight: bold; color: #006400; font-size: 12px;">Filter:</div>
                <div>
                    <select id="filter-bulan-m1" onchange="updateFilters(this.id, this.value)"></select>
                </div>
                <div>
                    <select id="filter-tahun-m1" onchange="updateFilters(this.id, this.value)"></select>
                </div>
            </div>
            
            <div class="table-scroll-wrapper">
                <table id="tabel-modul-1" class="input-table admin-only">
                    <thead>
                        <tr>
                            <th rowspan="3">BULAN</th>
                            <th colspan="2">PENERIMAAN</th>
                            <th colspan="12">PENGELUARAN DANA SOSIAL/BANTUAN</th>
                            <th colspan="4">PENGELUARAN OPERASIONAL</th>
                        </tr>
                        <tr>
                            <th rowspan="2" style="min-width: 70px;">TOTAL KOIN</th>
                            <th rowspan="2" style="width: 50px;">JML DONATUR</th>
                            <th colspan="2">Pendidikan</th>
                            <th colspan="2">Kesehatan</th>
                            <th colspan="2">Ekonomi</th>
                            <th colspan="2">Sosial Umum</th>
                            <th colspan="2">Subsidi Banom & Lembaga NU</th>
                            <th colspan="2">Bencana</th>
                            <th rowspan="2">Rapat</th>
                            <th rowspan="2">PERWTN MLU</th>
                            <th rowspan="2">BIAYA REK BANK</th>
                            <th rowspan="2">Lain - Lain</th>
                        </tr>
                        <tr>
                            <th style="min-width: 70px;">Jml Uang</th>
                            <th style="width: 60px;">Jml Pnm</th>
                            <th style="min-width: 70px;">Jml Uang</th>
                            <th style="width: 60px;">Jml Pnm</th>
                            <th style="min-width: 70px;">Jml Uang</th>
                            <th style="width: 60px;">Jml Pnm</th>
                            <th style="min-width: 70px;">Jml Uang</th>
                            <th style="width: 60px;">Jml Pnm</th>
                            <th style="min-width: 70px;">Jml Uang</th>
                            <th style="width: 60px;">Jml Pnm</th>
                            <th style="min-width: 70px;">Jml Uang</th>
                            <th style="width: 60px;">Jml Pnm</th>
                        </tr>
                    </thead>
                    <tbody id="m1-input-body">
                        </tbody>
                </table>
            </div> </div>
    </div>
    
    <div id="login-container-bar">
        <div id="login-form-content-bar" style="display: none;">
            <label for="username">Username:</label>
            <input type="text" id="username">
            <label for="password">Password:</label>
            <input type="password" id="password">
            <button onclick="handleLogin()">Login</button>
            <p id="login-message-bar" style="color: white; margin-left: 10px;">(Akses terbatas Admin)</p>
        </div>
        
        <div id="logout-form-content-bar" style="display: none;"> 
            <p>Mode Admin Aktif</p>
            <button onclick="handleLogout()">Logout</button>
        </div>
    </div>

    <script>
        // --- GLOBAL CONFIG & CREDENTIALS ---
        const USERNAME = 'admin';
        const PASSWORD = 'admin123';
        let isLoggedIn = false;
        let activeModule = 'modul-1a-section'; // Default active module
        
        // Filter States
        const CURRENT_YEAR = new Date().getFullYear();
        let currentFilterMonth = 0; // 0 = All Months, 1 = January, ...
        let currentFilterYear = CURRENT_YEAR; 
        const MONTHS = ["Semua Bulan", "Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];
        
        // Data Modul 1 (Input Aggregat Lama) - Will be stored in global memory for demo, real system would use a DB
        let initialData = [
            { bulan: 'Januari', penerimaan: 4000000, donatur: 200, pendUang: 500000, pendPenerima: 5, kesUang: 300000, kesPenerima: 3, ekoUang: 400000, ekoPenerima: 4, sosumUang: 300000, sosumPenerima: 10, banomUang: 300000, banomPenerima: 2, bencanaUang: 0, bencanaPenerima: 0, rapat: 200000, perwtnMlu: 50000, biayaBank: 10000, lainLain: 140000, honorWajibPercent: 0.40 },
            { bulan: 'Februari', penerimaan: 5000000, donatur: 250, pendUang: 600000, pendPenerima: 6, kesUang: 0, kesPenerima: 0, ekoUang: 500000, ekoPenerima: 5, sosumUang: 400000, sosumPenerima: 15, banomUang: 0, banomPenerima: 0, bencanaUang: 0, bencanaPenerima: 0, rapat: 0, perwtnMlu: 0, biayaBank: 0, lainLain: 0, honorWajibPercent: 0.40 },
            { bulan: 'Maret', penerimaan: 0, donatur: 0, pendUang: 0, pendPenerima: 0, kesUang: 0, kesPenerima: 0, ekoUang: 0, ekoPenerima: 0, sosumUang: 0, sosumPenerima: 0, banomUang: 0, banomPenerima: 0, bencanaUang: 0, bencanaPenerima: 0, rapat: 0, perwtnMlu: 0, biayaBank: 0, lainLain: 0, honorWajibPercent: 0.40 },
            { bulan: 'April', penerimaan: 0, donatur: 0, pendUang: 0, pendPenerima: 0, kesUang: 0, kesPenerima: 0, ekoUang: 0, ekoPenerima: 0, sosumUang: 0, sosumPenerima: 0, banomUang: 0, banomPenerima: 0, bencanaUang: 0, bencanaPenerima: 0, rapat: 0, perwtnMlu: 0, biayaBank: 0, lainLain: 0, honorWajibPercent: 0.40 },
            { bulan: 'Mei', penerimaan: 0, donatur: 0, pendUang: 0, pendPenerima: 0, kesUang: 0, kesPenerima: 0, ekoUang: 0, ekoPenerima: 0, sosumUang: 0, sosumPenerima: 0, banomUang: 0, banomPenerima: 0, bencanaUang: 0, bencanaPenerima: 0, rapat: 0, perwtnMlu: 0, biayaBank: 0, lainLain: 0, honorWajibPercent: 0.40 },
            { bulan: 'Juni', penerimaan: 0, donatur: 0, pendUang: 0, pendPenerima: 0, kesUang: 0, kesPenerima: 0, ekoUang: 0, ekoPenerima: 0, sosumUang: 0, sosumPenerima: 0, banomUang: 0, banomPenerima: 0, bencanaUang: 0, bencanaPenerima: 0, rapat: 0, perwtnMlu: 0, biayaBank: 0, lainLain: 0, honorWajibPercent: 0.40 },
            { bulan: 'Juli', penerimaan: 0, donatur: 0, pendUang: 0, pendPenerima: 0, kesUang: 0, kesPenerima: 0, ekoUang: 0, ekoPenerima: 0, sosumUang: 0, sosumPenerima: 0, banomUang: 0, banomPenerima: 0, bencanaUang: 0, bencanaPenerima: 0, rapat: 0, perwtnMlu: 0, biayaBank: 0, lainLain: 0, honorWajibPercent: 0.40 },
            { bulan: 'Agustus', penerimaan: 0, donatur: 0, pendUang: 0, pendPenerima: 0, kesUang: 0, kesPenerima: 0, ekoUang: 0, ekoPenerima: 0, sosumUang: 0, sosumPenerima: 0, banomUang: 0, banomPenerima: 0, bencanaUang: 0, bencanaPenerima: 0, rapat: 0, perwtnMlu: 0, biayaBank: 0, lainLain: 0, honorWajibPercent: 0.40 },
            { bulan: 'September', penerimaan: 0, donatur: 0, pendUang: 0, pendPenerima: 0, kesUang: 0, kesPenerima: 0, ekoUang: 0, ekoPenerima: 0, sosumUang: 0, sosumPenerima: 0, banomUang: 0, banomPenerima: 0, bencanaUang: 0, bencanaPenerima: 0, rapat: 0, perwtnMlu: 0, biayaBank: 0, lainLain: 0, honorWajibPercent: 0.40 },
            { bulan: 'Oktober', penerimaan: 0, donatur: 0, pendUang: 0, pendPenerima: 0, kesUang: 0, kesPenerima: 0, ekoUang: 0, ekoPenerima: 0, sosumUang: 0, sosumPenerima: 0, banomUang: 0, banomPenerima: 0, bencanaUang: 0, bencanaPenerima: 0, rapat: 0, perwtnMlu: 0, biayaBank: 0, lainLain: 0, honorWajibPercent: 0.40 },
            { bulan: 'November', penerimaan: 0, donatur: 0, pendUang: 0, pendPenerima: 0, kesUang: 0, kesPenerima: 0, ekoUang: 0, ekoPenerima: 0, sosumUang: 0, sosumPenerima: 0, banomUang: 0, banomPenerima: 0, bencanaUang: 0, bencanaPenerima: 0, rapat: 0, perwtnMlu: 0, biayaBank: 0, lainLain: 0, honorWajibPercent: 0.40 },
            { bulan: 'Desember', penerimaan: 0, donatur: 0, pendUang: 0, pendPenerima: 0, kesUang: 0, kesPenerima: 0, ekoUang: 0, ekoPenerima: 0, sosumUang: 0, sosumPenerima: 0, banomUang: 0, banomPenerima: 0, bencanaUang: 0, bencanaPenerima: 0, rapat: 0, perwtnMlu: 0, biayaBank: 0, lainLain: 0, honorWajibPercent: 0.40 }
        ];

        // Transaction Data (for Modul 1A & 2)
        let m1aTransactions = []; // Stores detailed Koin NU transactions
        let m2ManualTransactions = []; // Stores other manual transactions (Debit/Kredit)
        
        // Honor Rates for Koin NU split (used in Modul 1A & Modul 2 auto-transactions)
        const HONOR_RATES = {
            petugas: 0.10, // 10%
            mwc: 0.25,     // 25%
            pc: 0.05,      // 5%
            ranting: 0.60  // 60%
        };
        
        // --- UTILITY FUNCTIONS ---
        const formatNominal = (angka) => {
            if (typeof angka !== 'number' || isNaN(angka)) return '0';
            return angka.toLocaleString('id-ID', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
        };
        const parseInput = (id) => {
            const element = document.getElementById(id);
            if (element) {
                return parseFloat(element.value) || 0;
            }
            return 0;
        };

        // ===================================
        // --- FILTER LOGIC ---
        // ===================================
        function populateFilters() {
            const monthSelects = document.querySelectorAll('[id^="filter-bulan-"]');
            const yearSelects = document.querySelectorAll('[id^="filter-tahun-"]');
            const startYear = 2024; 

            // Populate Months
            monthSelects.forEach(select => {
                select.innerHTML = ''; // Clear existing options
                MONTHS.forEach((month, index) => {
                    const option = document.createElement('option');
                    option.value = index;
                    option.textContent = month;
                    select.appendChild(option);
                });
                select.value = currentFilterMonth;
            });

            // Populate Years
            yearSelects.forEach(select => {
                select.innerHTML = ''; // Clear existing options
                for (let year = CURRENT_YEAR + 1; year >= startYear; year--) {
                    const option = document.createElement('option');
                    option.value = year;
                    option.textContent = year;
                    select.appendChild(option);
                }
                select.value = currentFilterYear;
            });
            
            // Sync all filter values to the current global state
            monthSelects.forEach(select => select.value = currentFilterMonth);
            yearSelects.forEach(select => select.value = currentFilterYear);
        }

        function updateFilters(id, value) {
            const val = parseInt(value);
            if (id.includes('bulan')) {
                currentFilterMonth = val;
            } else if (id.includes('tahun')) {
                currentFilterYear = val;
            }

            // Sync all filter dropdowns to the new value
            const targetPrefix = id.includes('bulan') ? 'filter-bulan-' : 'filter-tahun-';
            document.querySelectorAll(`[id^="${targetPrefix}"]`).forEach(select => {
                select.value = val;
            });

            recalculateAllReports();
        }

        function getFilteredM1aTransactions() {
            const month = currentFilterMonth;
            const year = currentFilterYear;
            let filtered = m1aTransactions.filter(t => new Date(t.date).getFullYear() === year);
            if (month !== 0) {
                filtered = filtered.filter(t => new Date(t.date).getMonth() === (month - 1));
            }
            return filtered.sort((a, b) => new Date(a.date) - new Date(b.date));
        }

        function getFilteredM2ManualTransactions() {
            const month = currentFilterMonth;
            const year = currentFilterYear;
            let filtered = m2ManualTransactions.filter(t => new Date(t.date).getFullYear() === year);
            if (month !== 0) {
                filtered = filtered.filter(t => new Date(t.date).getMonth() === (month - 1));
            }
            return filtered.sort((a, b) => new Date(a.date) - new Date(b.date));
        }


        // ===================================
        // --- MODULE SWITCHING ---
        // ===================================
        function switchModule(moduleID) {
            // Hide all modules
            document.querySelectorAll('.module-section').forEach(section => {
                section.style.display = 'none';
            });

            // Deactivate all nav buttons
            document.querySelectorAll('#nav-menu button').forEach(button => {
                button.classList.remove('active');
            });

            // Show target module
            document.getElementById(moduleID).style.display = 'block';
            activeModule = moduleID;

            // Activate target nav button
            const navButtonId = moduleID.replace('-section', '');
            const activeButton = document.getElementById('nav-' + navButtonId);
            if (activeButton) {
                activeButton.classList.add('active');
            }
            
            // Re-render only if needed
            if (moduleID === 'modul-1a-section') updatePenerimaanDetail();
            if (moduleID === 'modul-2-section') updateJurnalUmum();
            if (moduleID === 'modul-3-section') updateLaporanTahunan();
            if (moduleID === 'modul-1-section') updateModul1(); // For visual consistency
        }

        // ===================================
        // --- MODUL 1A LOGIC: PENERIMAAN DETAIL ---
        // ===================================
        function getKoinNUAggregateData() {
            const filtered = getFilteredM1aTransactions();
            let totalNominal = 0;
            filtered.forEach(t => totalNominal += t.nominal);

            const totalHonorPetugas = totalNominal * HONOR_RATES.petugas;
            const totalHonorMWC = totalNominal * HONOR_RATES.mwc;
            const totalHonorPC = totalNominal * HONOR_RATES.pc;
            const totalDanaRanting = totalNominal * HONOR_RATES.ranting;

            return { totalNominal, totalHonorPetugas, totalHonorMWC, totalHonorPC, totalDanaRanting };
        }

        function deleteKoinNUTxn(index) {
            if (!isLoggedIn) return;
            if (confirm(`Yakin ingin menghapus transaksi Koin NU #${index + 1}?`)) {
                // Find the transaction object in the filtered list
                const filteredTx = getFilteredM1aTransactions()[index]; 
                // Find the index of that object in the main array (m1aTransactions)
                const originalIndex = m1aTransactions.findIndex(t => t === filteredTx); 
                
                if (originalIndex > -1) {
                    m1aTransactions.splice(originalIndex, 1);
                    recalculateAllReports();
                } else {
                    alert("Error: Transaksi tidak ditemukan di data utama.");
                }
            }
        }

        function editKoinNUTxn(index) {
            if (!isLoggedIn) return;
            // Find the transaction object in the filtered list
            const filteredTx = getFilteredM1aTransactions()[index]; 
            // Find the index of that object in the main array (m1aTransactions)
            const originalIndex = m1aTransactions.findIndex(t => t === filteredTx); 
            
            if (originalIndex > -1) {
                const tx = m1aTransactions[originalIndex];
                document.getElementById('m1a-tanggal-input').value = tx.date;
                document.getElementById('m1a-nama-petugas-input').value = tx.petugas;
                document.getElementById('m1a-no-hp-input').value = tx.noHp;
                document.getElementById('m1a-donatur-input').value = tx.donatur;
                document.getElementById('m1a-alamat-input').value = tx.alamat;
                document.getElementById('m1a-nominal-input').value = tx.nominal;
                
                m1aTransactions.splice(originalIndex, 1);
                recalculateAllReports();
                alert('Data dipindahkan ke form input. Silakan edit dan klik "Tambah Koin NU" lagi.');
            } else {
                alert("Error: Transaksi tidak ditemukan di data utama.");
            }
        }

        function addKoinNUTransaction() {
            if (!isLoggedIn) return;
            const date = document.getElementById('m1a-tanggal-input').value;
            const petugas = document.getElementById('m1a-nama-petugas-input').value.trim();
            const noHp = document.getElementById('m1a-no-hp-input').value.trim();
            const donatur = document.getElementById('m1a-donatur-input').value.trim();
            const alamat = document.getElementById('m1a-alamat-input').value.trim();
            const nominal = parseFloat(document.getElementById('m1a-nominal-input').value) || 0;

            if (!date || !petugas || !nominal || nominal <= 0) {
                alert("Mohon isi Tanggal, Nama Petugas, dan Nominal Koin NU dengan benar.");
                return;
            }

            const newTransaction = { date, petugas, noHp, donatur, alamat, nominal };
            m1aTransactions.push(newTransaction);
            clearKoinNUInputs();
            recalculateAllReports();
        }

        function clearKoinNUInputs() {
            if (!isLoggedIn) return;
            document.getElementById('m1a-tanggal-input').value = '';
            document.getElementById('m1a-nama-petugas-input').value = '';
            document.getElementById('m1a-no-hp-input').value = '';
            document.getElementById('m1a-donatur-input').value = '';
            document.getElementById('m1a-alamat-input').value = '';
            document.getElementById('m1a-nominal-input').value = '';
        }

        function updatePenerimaanDetail() {
            const transactionBody = document.getElementById('m1a-transaction-body');
            transactionBody.innerHTML = ''; // Clear previous data
            let totalNominal = 0;
            const aksiVisibilityStyle = isLoggedIn ? 'table-cell' : 'none';

            // 1. Render Rows (based on FILTERED data)
            getFilteredM1aTransactions().forEach((t, index) => {
                const honorPetugas = t.nominal * HONOR_RATES.petugas;
                const honorMWC = t.nominal * HONOR_RATES.mwc;
                const honorPC = t.nominal * HONOR_RATES.pc;
                const danaRanting = t.nominal * HONOR_RATES.ranting;
                totalNominal += t.nominal;

                const actionButtons = `
                    <button class="action-btn edit-btn" onclick="editKoinNUTxn(${index})">Ubah</button>
                    <button class="action-btn delete-btn" onclick="deleteKoinNUTxn(${index})">Hapus</button>
                `;
                
                const row = transactionBody.insertRow();
                row.innerHTML = `
                    <td class="text-center">${index + 1}</td>
                    <td>${t.date}</td>
                    <td>${t.petugas}</td>
                    <td>${t.noHp}</td>
                    <td>${t.donatur}</td>
                    <td>${t.alamat}</td>
                    <td class="text-right">${formatNominal(t.nominal)}</td>
                    <td class="text-right">${formatNominal(honorPetugas)}</td>
                    <td class="text-right">${formatNominal(honorMWC)}</td>
                    <td class="text-right">${formatNominal(honorPC)}</td>
                    <td class="text-right">${formatNominal(danaRanting)}</td>
                    <td class="text-center" style="display: ${aksiVisibilityStyle}">${actionButtons}</td>
                `;
            });

            // 2. Calculate Aggregates (based on FILTERED data)
            const koinNUData = getKoinNUAggregateData();
            
            // 3. Update Modul 1A Footer & Header visibility
            document.getElementById('m1a-total-nominal').textContent = formatNominal(koinNUData.totalNominal);
            document.getElementById('m1a-total-petugas').textContent = formatNominal(koinNUData.totalHonorPetugas);
            document.getElementById('m1a-total-mwc').textContent = formatNominal(koinNUData.totalHonorMWC);
            document.getElementById('m1a-total-pc').textContent = formatNominal(koinNUData.totalHonorPC);
            document.getElementById('m1a-total-ranting').textContent = formatNominal(koinNUData.totalDanaRanting);

            // Update footer AKSI column visibility
            document.getElementById('th-m1a-aksi').style.display = aksiVisibilityStyle;
            document.getElementById('tf-m1a-aksi').style.display = aksiVisibilityStyle;
        }

        // ===================================
        // --- MODUL 2 LOGIC: JURNAL UMUM ---
        // ===================================
        function deleteManualTxn(index) {
            if (!isLoggedIn) return;
            if (confirm(`Yakin ingin menghapus transaksi manual #${index + 1}?`)) {
                // Find the transaction object in the filtered list
                const filteredTx = getFilteredM2ManualTransactions()[index]; 
                // Find the index of that object in the main array (m2ManualTransactions)
                const originalIndex = m2ManualTransactions.findIndex(t => t === filteredTx); 
                
                if (originalIndex > -1) {
                    m2ManualTransactions.splice(originalIndex, 1);
                    recalculateAllReports();
                } else {
                    alert("Error: Transaksi tidak ditemukan di data utama.");
                }
            }
        }

        function editManualTxn(index) {
            if (!isLoggedIn) return;
            // Find the transaction object in the filtered list
            const filteredTx = getFilteredM2ManualTransactions()[index]; 
            // Find the index of that object in the main array (m2ManualTransactions)
            const originalIndex = m2ManualTransactions.findIndex(t => t === filteredTx); 
            
            if (originalIndex > -1) {
                const tx = m2ManualTransactions[originalIndex];
                document.getElementById('m2-tanggal-input').value = tx.date;
                document.getElementById('m2-keterangan-input').value = tx.keterangan;
                document.getElementById('m2-kategori-input').value = tx.kategori;
                document.getElementById('m2-debit-input').value = tx.debit;
                document.getElementById('m2-kredit-input').value = tx.kredit;
                
                m2ManualTransactions.splice(originalIndex, 1);
                recalculateAllReports();
                alert('Data dipindahkan ke form input. Silakan edit dan klik "Tambah Transaksi Lain" lagi.');
            } else {
                alert("Error: Transaksi tidak ditemukan di data utama.");
            }
        }
        
        function addManualTransaction() {
            if (!isLoggedIn) return;
            const date = document.getElementById('m2-tanggal-input').value;
            const keterangan = document.getElementById('m2-keterangan-input').value.trim();
            const kategori = document.getElementById('m2-kategori-input').value;
            const debit = parseFloat(document.getElementById('m2-debit-input').value) || 0;
            const kredit = parseFloat(document.getElementById('m2-kredit-input').value) || 0;

            if (!date || !keterangan || !kategori || (debit === 0 && kredit === 0)) {
                alert("Mohon isi Tanggal, Keterangan, Kategori, dan salah satu nominal (Debit/Kredit) dengan benar.");
                return;
            }
            if (debit > 0 && kredit > 0) {
                alert("Mohon isi hanya salah satu nominal: Debit (Masuk) atau Kredit (Keluar).");
                return;
            }

            const newTransaction = { date, keterangan, kategori, debit, kredit, isAuto: false };
            m2ManualTransactions.push(newTransaction);
            clearManualTransactionInputs();
            recalculateAllReports();
        }

        function clearManualTransactionInputs() {
            if (!isLoggedIn) return;
            document.getElementById('m2-tanggal-input').value = '';
            document.getElementById('m2-keterangan-input').value = '';
            document.getElementById('m2-kategori-input').value = '';
            document.getElementById('m2-debit-input').value = '0';
            document.getElementById('m2-kredit-input').value = '0';
        }

        function updateJurnalUmum() {
            const transactionBody = document.getElementById('m2-transaction-body');
            // Hapus semua baris transaksi kecuali baris Saldo Awal (yaitu baris 0)
            while (transactionBody.rows.length > 1) { 
                transactionBody.deleteRow(1);
            }

            const aksiVisibilityStyle = isLoggedIn ? 'table-cell' : 'none';

            // 1. Ambil Saldo Awal & Update Aksi Visibility pada baris Saldo Awal
            const saldoAwalInput = document.getElementById('m2-saldo-awal-input');
            let saldoAwal = parseInput('m2-saldo-awal-input'); 
            let runningSaldo = saldoAwal;
            document.getElementById('m2-saldo-awal-display').textContent = formatNominal(saldoAwal);
            document.getElementById('m2-saldo-awal-static').textContent = formatNominal(saldoAwal);
            
            // FIX BARU: Sembunyikan sel aksi pada baris Saldo Awal saat log out
            const saldoAwalAksiTd = document.getElementById('td-m2-saldo-awal-aksi');
            if (saldoAwalAksiTd) {
                saldoAwalAksiTd.style.display = aksiVisibilityStyle;
            }

            // 2. Buat Transaksi Otomatis (Auto-Generated Transactions) - Fixed Order (Baris 2-5)
            const koinNUData = getKoinNUAggregateData();
            const totalNominalKoin = koinNUData.totalNominal;
            const autoDate = null; // Tampil sebagai '-' di tabel

            const autoTransactions = [];
            if (totalNominalKoin > 0) {
                autoTransactions.push({ date: autoDate, keterangan: 'Penerimaan Koin NU (100% dari Modul 1A)', kategori: 'Koin NU (Otomatis)', debit: totalNominalKoin, kredit: 0, isAuto: true });
                autoTransactions.push({ date: autoDate, keterangan: 'Pengeluaran Honor Petugas (10%)', kategori: 'Honor Petugas (Otomatis)', debit: 0, kredit: koinNUData.totalHonorPetugas, isAuto: true });
                autoTransactions.push({ date: autoDate, keterangan: 'Pengeluaran Honor MWC (25%)', kategori: 'Honor MWC (Otomatis)', debit: 0, kredit: koinNUData.totalHonorMWC, isAuto: true });
                autoTransactions.push({ date: autoDate, keterangan: 'Pengeluaran Honor PC (5%)', kategori: 'Honor PC (Otomatis)', debit: 0, kredit: koinNUData.totalHonorPC, isAuto: true });
            }

            // 3. Urutkan Manual Transactions (SUDAH TERFILTER)
            const sortedManualTransactions = getFilteredM2ManualTransactions();

            // 4. Gabungkan Auto dan Manual Transactions (Fixed Order)
            const allTransactions = [...autoTransactions, ...sortedManualTransactions];
            
            let totalMasuk = 0;
            let totalKeluar = 0;
            

            // 5. Render All Transactions
            allTransactions.forEach((t, index) => {
                const no = index + 1;
                const dateDisplay = t.date ? t.date : '-';
                
                runningSaldo += t.debit - t.kredit;
                totalMasuk += t.debit;
                totalKeluar += t.kredit;
                
                const actionButtons = t.isAuto ? '-' : `
                    <button class="action-btn edit-btn" onclick="editManualTxn(${index - autoTransactions.length})">Ubah</button>
                    <button class="action-btn delete-btn" onclick="deleteManualTxn(${index - autoTransactions.length})">Hapus</button>
                `;
                
                const row = transactionBody.insertRow();
                if (t.isAuto) { row.classList.add('auto-transaction-row'); }
                row.innerHTML = `
                    <td class="text-center">${no}</td>
                    <td>${dateDisplay}</td>
                    <td style="text-align: left;">${t.keterangan}</td>
                    <td style="text-align: left;">${t.kategori}</td>
                    <td class="text-right">${formatNominal(t.debit)}</td>
                    <td class="text-right">${formatNominal(t.kredit)}</td>
                    <td class="text-right">${formatNominal(runningSaldo)}</td>
                    <td class="text-center" style="display: ${aksiVisibilityStyle}">${actionButtons}</td>
                `;
            });

            // 6. Update Footer & Header visibility
            document.getElementById('m2-total-masuk').textContent = formatNominal(totalMasuk);
            document.getElementById('m2-total-keluar').textContent = formatNominal(totalKeluar);
            document.getElementById('m2-footer-saldo-total').textContent = formatNominal(runningSaldo);
            
            // Update header/footer AKSI column visibility
            document.getElementById('th-m2-aksi').style.display = aksiVisibilityStyle;
            document.getElementById('tf-m2-aksi').style.display = aksiVisibilityStyle;
        }

        // --- MODUL 1 & 3 LOGIC (Data Statis/Admin Input) ---
        function gatherInputData() {
            const data = [];
            // Modul 3 data is not filtered by month, but by year (implicit in INITIAL_DATA_SOURCE)
            initialData.forEach((monthData, index) => {
                const prefix = `m1-${index}-`;
                data.push({
                    bulan: monthData.bulan,
                    // Selalu baca dari input jika ada, jika tidak, gunakan default
                    penerimaan: parseInput(prefix + 'penerimaan') || monthData.penerimaan,
                    donatur: parseInput(prefix + 'donatur') || monthData.donatur,
                    pendUang: parseInput(prefix + 'pendUang') || monthData.pendUang,
                    pendPenerima: parseInput(prefix + 'pendPenerima') || monthData.pendPenerima,
                    kesUang: parseInput(prefix + 'kesUang') || monthData.kesUang,
                    kesPenerima: parseInput(prefix + 'kesPenerima') || monthData.kesPenerima,
                    ekoUang: parseInput(prefix + 'ekoUang') || monthData.ekoUang,
                    ekoPenerima: parseInput(prefix + 'ekoPenerima') || monthData.ekoPenerima,
                    sosumUang: parseInput(prefix + 'sosumUang') || monthData.sosumUang,
                    sosumPenerima: parseInput(prefix + 'sosumPenerima') || monthData.sosumPenerima,
                    banomUang: parseInput(prefix + 'banomUang') || monthData.banomUang,
                    banomPenerima: parseInput(prefix + 'banomPenerima') || monthData.banomPenerima,
                    bencanaUang: parseInput(prefix + 'bencanaUang') || monthData.bencanaUang,
                    bencanaPenerima: parseInput(prefix + 'bencanaPenerima') || monthData.bencanaPenerima,
                    rapat: parseInput(prefix + 'rapat') || monthData.rapat,
                    perwtnMlu: parseInput(prefix + 'perwtnMlu') || monthData.perwtnMlu,
                    biayaBank: parseInput(prefix + 'biayaBank') || monthData.biayaBank,
                    lainLain: parseInput(prefix + 'lainLain') || monthData.lainLain,
                    honorWajibPercent: monthData.honorWajibPercent // Use the defined percentage
                });
            });
            return data;
        }

        function calculateTotalNonHonorExpense(dataBulan) {
            return dataBulan.pendUang + dataBulan.kesUang + dataBulan.ekoUang + dataBulan.sosumUang + dataBulan.banomUang + dataBulan.bencanaUang + dataBulan.rapat + dataBulan.perwtnMlu + dataBulan.biayaBank + dataBulan.lainLain;
        }

        function updateModul1() {
            const inputBody = document.getElementById('m1-input-body');
            inputBody.innerHTML = ''; 
            const data = gatherInputData();

            data.forEach((dataBulan, index) => {
                const prefix = `m1-${index}-`;
                const row = inputBody.insertRow();
                
                row.innerHTML = `
                    <td class="text-center">${dataBulan.bulan.toUpperCase()}</td>
                    <td><input type="number" id="${prefix}penerimaan" value="${dataBulan.penerimaan}" min="0" oninput="recalculateAllReports()"></td>
                    <td><input type="number" id="${prefix}donatur" value="${dataBulan.donatur}" min="0" oninput="recalculateAllReports()"></td>
                    
                    <td><input type="number" id="${prefix}pendUang" value="${dataBulan.pendUang}" min="0" oninput="recalculateAllReports()"></td>
                    <td><input type="number" id="${prefix}pendPenerima" value="${dataBulan.pendPenerima}" min="0" oninput="recalculateAllReports()"></td>
                    
                    <td><input type="number" id="${prefix}kesUang" value="${dataBulan.kesUang}" min="0" oninput="recalculateAllReports()"></td>
                    <td><input type="number" id="${prefix}kesPenerima" value="${dataBulan.kesPenerima}" min="0" oninput="recalculateAllReports()"></td>

                    <td><input type="number" id="${prefix}ekoUang" value="${dataBulan.ekoUang}" min="0" oninput="recalculateAllReports()"></td>
                    <td><input type="number" id="${prefix}ekoPenerima" value="${dataBulan.ekoPenerima}" min="0" oninput="recalculateAllReports()"></td>

                    <td><input type="number" id="${prefix}sosumUang" value="${dataBulan.sosumUang}" min="0" oninput="recalculateAllReports()"></td>
                    <td><input type="number" id="${prefix}sosumPenerima" value="${dataBulan.sosumPenerima}" min="0" oninput="recalculateAllReports()"></td>
                    
                    <td><input type="number" id="${prefix}banomUang" value="${dataBulan.banomUang}" min="0" oninput="recalculateAllReports()"></td>
                    <td><input type="number" id="${prefix}banomPenerima" value="${dataBulan.banomPenerima}" min="0" oninput="recalculateAllReports()"></td>
                    
                    <td><input type="number" id="${prefix}bencanaUang" value="${dataBulan.bencanaUang}" min="0" oninput="recalculateAllReports()"></td>
                    <td><input type="number" id="${prefix}bencanaPenerima" value="${dataBulan.bencanaPenerima}" min="0" oninput="recalculateAllReports()"></td>
                    
                    <td><input type="number" id="${prefix}rapat" value="${dataBulan.rapat}" min="0" oninput="recalculateAllReports()"></td>
                    <td><input type="number" id="${prefix}perwtnMlu" value="${dataBulan.perwtnMlu}" min="0" oninput="recalculateAllReports()"></td>
                    <td><input type="number" id="${prefix}biayaBank" value="${dataBulan.biayaBank}" min="0" oninput="recalculateAllReports()"></td>
                    <td><input type="number" id="${prefix}lainLain" value="${dataBulan.lainLain}" min="0" oninput="recalculateAllReports()"></td>
                `;
            });
        }

        function updateLaporanTahunan() {
            const tableBody = document.getElementById('m3-data-body');
            tableBody.innerHTML = '';
            
            const data = gatherInputData();
            let runningSaldoKas = 0;
            const saldoBankAwal = parseInput('saldo-bank-awal-input');
            const saldoTunaiAwal = parseInput('saldo-tunai-awal-input');
            
            let totalSaldoAkhirBulanan = 0; 

            let totalPenerimaanTahunan = 0;
            let totalDonaturTahunan = 0;
            let totalPengeluaranTahunan = 0;
            
            // Perubahan di sini: Total Honor Tahunan dipecah
            let totalHonorPetugasTahunan = 0; 
            let totalHonorMWCTahunan = 0;     
            let totalHonorPCTahunan = 0;      
            
            let totalPendUangTahunan = 0;
            let totalPendPnmTahunan = 0;
            let totalKesUangTahunan = 0;
            let totalKesPnmTahunan = 0;
            let totalEkoUangTahunan = 0;
            let totalEkoPnmTahunan = 0;
            let totalSosumUangTahunan = 0;
            let totalSosumPnmTahunan = 0;
            let totalBanomUangTahunan = 0;
            let totalBanomPnmTahunan = 0;
            let totalBencanaUangTahunan = 0;
            let totalBencanaPnmTahunan = 0;
            let totalRapatTahunan = 0;
            let totalPerwtnTahunan = 0;
            let totalBankTahunan = 0;
            let totalLainTahunan = 0;

            // Baris 1: SALDO KAS BANK (Awal Tahun)
            runningSaldoKas += saldoBankAwal;
            let rowBank = tableBody.insertRow();
            rowBank.classList.add('saldo-awal-row');
            const bankSaldoContent = isLoggedIn ? `<input type="number" id="saldo-bank-awal-input" value="${saldoBankAwal}" min="0" oninput="recalculateAllReports()" style="width: 100%; font-size: 11px; text-align: right;">` : formatNominal(saldoBankAwal);
            // Tambah 2 colspan di sini karena ada 2 kolom baru (Petugas, MWC, PC)
            rowBank.innerHTML = `
                <td>-</td>
                <td>SALDO KAS BANK (Awal Tahun)</td>
                <td class="text-right">${bankSaldoContent}</td>
                <td class="text-right">-</td>
                <td colspan="19">-</td>
                <td>-</td>
                <td>-</td>
                <td class="text-right">-</td>
                <td class="text-right">${formatNominal(saldoBankAwal)}</td>
            `;

            // Baris 2: SALDO KAS TUNAI (Awal Tahun)
            runningSaldoKas += saldoTunaiAwal;
            let rowTunai = tableBody.insertRow();
            rowTunai.classList.add('saldo-awal-row');
            const tunaiSaldoContent = isLoggedIn ? `<input type="number" id="saldo-tunai-awal-input" value="${saldoTunaiAwal}" min="0" oninput="recalculateAllReports()" style="width: 100%; font-size: 11px; text-align: right;">` : formatNominal(saldoTunaiAwal);
            // Tambah 2 colspan di sini
            rowTunai.innerHTML = `
                <td>-</td>
                <td>SALDO KAS TUNAI (Awal Tahun)</td>
                <td class="text-right">${tunaiSaldoContent}</td>
                <td class="text-right">-</td>
                <td colspan="19">-</td>
                <td>-</td>
                <td>-</td>
                <td class="text-right">-</td>
                <td class="text-right">${formatNominal(runningSaldoKas)}</td>
            `;

            // Data Bulanan
            data.forEach((dataBulan, index) => {
                const no = index + 1;
                
                // Perhitungan Honor Wajib dipecah
                const honorPetugas = dataBulan.penerimaan * HONOR_RATES.petugas;
                const honorMWC = dataBulan.penerimaan * HONOR_RATES.mwc;
                const honorPC = dataBulan.penerimaan * HONOR_RATES.pc;
                const honorWajib = honorPetugas + honorMWC + honorPC; // Total Honor Wajib (40%)

                const totalPengeluaranNonHonor = calculateTotalNonHonorExpense(dataBulan);
                const jmlPengeluaranBulanIni = honorWajib + totalPengeluaranNonHonor;
                const saldoAkhirBulanIni = dataBulan.penerimaan - jmlPengeluaranBulanIni;
                runningSaldoKas += saldoAkhirBulanIni;
                
                totalSaldoAkhirBulanan += saldoAkhirBulanIni;

                // Akumulasi Total Tahunan (Honor Wajib)
                totalHonorPetugasTahunan += honorPetugas;
                totalHonorMWCTahunan += honorMWC;
                totalHonorPCTahunan += honorPC;

                // Akumulasi Total Tahunan (Lainnya)
                totalPenerimaanTahunan += dataBulan.penerimaan;
                totalDonaturTahunan += dataBulan.donatur;
                totalPengeluaranTahunan += jmlPengeluaranBulanIni;
                totalPendUangTahunan += dataBulan.pendUang;
                totalPendPnmTahunan += dataBulan.pendPenerima;
                totalKesUangTahunan += dataBulan.kesUang;
                totalKesPnmTahunan += dataBulan.kesPenerima;
                totalEkoUangTahunan += dataBulan.ekoUang;
                totalEkoPnmTahunan += dataBulan.ekoPenerima;
                totalSosumUangTahunan += dataBulan.sosumUang;
                totalSosumPnmTahunan += dataBulan.sosumPenerima;
                totalBanomUangTahunan += dataBulan.banomUang;
                totalBanomPnmTahunan += dataBulan.banomPenerima;
                totalBencanaUangTahunan += dataBulan.bencanaUang;
                totalBencanaPnmTahunan += dataBulan.bencanaPenerima;
                totalRapatTahunan += dataBulan.rapat;
                totalPerwtnTahunan += dataBulan.perwtnMlu;
                totalBankTahunan += dataBulan.biayaBank;
                totalLainTahunan += dataBulan.lainLain;

                const row = tableBody.insertRow();
                row.innerHTML = `
                    <td class="text-center">${no}</td>
                    <td class="text-center">${dataBulan.bulan.toUpperCase()}</td>
                    <td class="text-right">${formatNominal(dataBulan.penerimaan)}</td>
                    <td class="text-center">${formatNominal(dataBulan.donatur)}</td>
                    
                    <td class="text-right">${formatNominal(dataBulan.pendUang)}</td>
                    <td class="text-center">${formatNominal(dataBulan.pendPenerima)}</td>
                    <td class="text-right">${formatNominal(dataBulan.kesUang)}</td>
                    <td class="text-center">${formatNominal(dataBulan.kesPenerima)}</td>
                    <td class="text-right">${formatNominal(dataBulan.ekoUang)}</td>
                    <td class="text-center">${formatNominal(dataBulan.ekoPenerima)}</td>
                    <td class="text-right">${formatNominal(dataBulan.sosumUang)}</td>
                    <td class="text-center">${formatNominal(dataBulan.sosumPenerima)}</td>
                    <td class="text-right">${formatNominal(dataBulan.banomUang)}</td>
                    <td class="text-center">${formatNominal(dataBulan.banomPenerima)}</td>
                    <td class="text-right">${formatNominal(dataBulan.bencanaUang)}</td>
                    <td class="text-center">${formatNominal(dataBulan.bencanaPenerima)}</td>
                    
                    <td class="text-right">${formatNominal(dataBulan.rapat)}</td>
                    <td class="text-right">${formatNominal(dataBulan.perwtnMlu)}</td>
                    <td class="text-right">${formatNominal(dataBulan.biayaBank)}</td>
                    <td class="text-right">${formatNominal(dataBulan.lainLain)}</td>
                    
                    <td class="text-right">${formatNominal(honorPetugas)}</td>
                    <td class="text-right">${formatNominal(honorMWC)}</td>
                    <td class="text-right">${formatNominal(honorPC)}</td>
                    
                    <td class="text-right">${formatNominal(jmlPengeluaranBulanIni)}</td>
                    <td class="text-right">${formatNominal(saldoAkhirBulanIni)}</td>
                    <td class="text-right">${formatNominal(runningSaldoKas)}</td>
                `;
            });

            // Update Footer Total
            document.getElementById('m3-total-penerimaan').textContent = formatNominal(totalPenerimaanTahunan);
            document.getElementById('m3-total-donatur').textContent = formatNominal(totalDonaturTahunan);
            document.getElementById('m3-total-pend-uang').textContent = formatNominal(totalPendUangTahunan);
            document.getElementById('m3-total-pend-pnm').textContent = formatNominal(totalPendPnmTahunan);
            document.getElementById('m3-total-kes-uang').textContent = formatNominal(totalKesUangTahunan);
            document.getElementById('m3-total-kes-pnm').textContent = formatNominal(totalKesPnmTahunan);
            document.getElementById('m3-total-eko-uang').textContent = formatNominal(totalEkoUangTahunan);
            document.getElementById('m3-total-eko-pnm').textContent = formatNominal(totalEkoPnmTahunan);
            document.getElementById('m3-total-sosum-uang').textContent = formatNominal(totalSosumUangTahunan);
            document.getElementById('m3-total-sosum-pnm').textContent = formatNominal(totalSosumPnmTahunan);
            document.getElementById('m3-total-banom-uang').textContent = formatNominal(totalBanomUangTahunan);
            document.getElementById('m3-total-banom-pnm').textContent = formatNominal(totalBanomPnmTahunan);
            document.getElementById('m3-total-bencana-uang').textContent = formatNominal(totalBencanaUangTahunan);
            document.getElementById('m3-total-bencana-pnm').textContent = formatNominal(totalBencanaPnmTahunan);
            document.getElementById('m3-total-rapat').textContent = formatNominal(totalRapatTahunan);
            document.getElementById('m3-total-perwtn').textContent = formatNominal(totalPerwtnTahunan);
            document.getElementById('m3-total-bank').textContent = formatNominal(totalBankTahunan);
            document.getElementById('m3-total-lain').textContent = formatNominal(totalLainTahunan);
            
            // UPDATE: Footer Honor Wajib
            document.getElementById('m3-total-honor-petugas').textContent = formatNominal(totalHonorPetugasTahunan);
            document.getElementById('m3-total-honor-mwc').textContent = formatNominal(totalHonorMWCTahunan);
            document.getElementById('m3-total-honor-pc').textContent = formatNominal(totalHonorPCTahunan);
            
            // Total Pengeluaran (7)
            document.getElementById('m3-total-pengeluaran').textContent = formatNominal(totalPengeluaranTahunan);
            
            // Kolom 8 & 9
            document.getElementById('m3-footer-saldo-akhir').textContent = formatNominal(totalSaldoAkhirBulanan);
            document.getElementById('m3-footer-saldo-kas').textContent = formatNominal(runningSaldoKas);
        }

        // ===================================
        // --- LOGIN LOGIC (ADMIN ONLY) ---
        // ===================================
        function checkLoginStatus() {
            isLoggedIn = (localStorage.getItem('isLoggedIn') === 'true');
        }

        function handleLogin() {
            const usernameInput = document.getElementById('username').value;
            const passwordInput = document.getElementById('password').value;
            const message = document.getElementById('login-message-bar');

            if (usernameInput === USERNAME && passwordInput === PASSWORD) {
                localStorage.setItem('isLoggedIn', 'true');
                isLoggedIn = true;
                message.textContent = 'Login Berhasil!';
                setTimeout(renderAppView, 200);
            } else {
                // Pesan error diubah agar tidak memuat kredensial
                message.textContent = 'Username atau Password salah! Hubungi Admin.';
            }
        }

        function handleLogout() {
            localStorage.removeItem('isLoggedIn');
            isLoggedIn = false;
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
            renderAppView();
        }
        
        function updateAdminViewVisibility(loggedIn) {
            // 1. Toggle visibility of all admin-only elements (Input forms, Modul 1, Aksi buttons)
            const adminElements = document.querySelectorAll('.admin-only');
            adminElements.forEach(el => {
                // Hapus inline style terlebih dahulu
                el.style.display = ''; 

                // Set inline style based on login status: 'block' or 'none'
                el.style.display = loggedIn ? (el.tagName === 'DIV' || el.tagName === 'P' ? 'block' : 'table') : 'none';
                if (el.tagName === 'TD' || el.tagName === 'TH') {
                    // Hanya elemen input/header di tabel M1 yang disembunyikan
                    el.style.display = loggedIn ? 'table-cell' : 'none';
                }
            });

            // 2. Toggle visibility of login/logout bar content
            const loginBar = document.getElementById('login-form-content-bar');
            const logoutBar = document.getElementById('logout-form-content-bar');
            const loginMessage = document.getElementById('login-message-bar');
            if(loginBar && logoutBar) {
                loginBar.style.display = loggedIn ? 'none' : 'flex';
                logoutBar.style.display = loggedIn ? 'flex' : 'none';
            }
            if (!loggedIn) {
                // Reset message on logout
                loginMessage.textContent = '(Akses terbatas Admin)';
                loginMessage.style.color = 'white';
            }

            // 3. Toggle Saldo Awal Input vs Static Display in Modul 2
            const saldoInputContainer = document.getElementById('m2-saldo-awal-display-container');
            const saldoStatic = document.getElementById('m2-saldo-awal-static');
            if (saldoInputContainer && saldoStatic) {
                if (loggedIn) {
                    saldoInputContainer.style.display = 'block';
                    saldoStatic.style.display = 'none';
                } else {
                    saldoInputContainer.style.display = 'none';
                    saldoStatic.style.display = 'block';
                }
            }
        }

        // ===================================
        // --- MAIN CONTROL FUNCTION ---
        // ===================================
        function recalculateAllReports() {
            // 1. Update Modul 1A & Modul 2 (depends on each other's output)
            updatePenerimaanDetail(); 
            updateJurnalUmum();

            // 2. Update Modul 1 (Input Agregat)
            updateModul1();

            // 3. Update Modul 3 (Laporan Tahunan)
            updateLaporanTahunan();

            // 4. Update Admin View visibility based on login status
            updateAdminViewVisibility(isLoggedIn);
        }

        function renderAppView() {
            // 1. Check Login Status
            checkLoginStatus(); 

            // 2. Populate Filters (always run)
            populateFilters();

            // 3. Render all modules (will automatically apply filters and login views)
            recalculateAllReports();

            // 4. Set Initial View (Modul 1A)
            switchModule(activeModule);
        }

        function resetAllData() {
            if (!isLoggedIn) return;
            const confirmation = prompt("⚠️ PERHATIAN: Tindakan ini akan menghapus SEMUA data transaksi di Modul 1A dan Modul 2. Ketik 'KONFIRMASI RESET' untuk melanjutkan.");
            if (confirmation === 'KONFIRMASI RESET') {
                m1aTransactions = [];
                m2ManualTransactions = [];
                document.getElementById('m2-saldo-awal-input').value = 0;

                // Reset all Modul 1 inputs to 0
                document.querySelectorAll('#tabel-modul-1 input[type="number"]').forEach(input => input.value = 0);
                document.getElementById('saldo-bank-awal-input').value = 0;
                document.getElementById('saldo-tunai-awal-input').value = 0;

                alert("✅ SEMUA data transaksi (Modul 1A & 2) dan input (Modul 1 & Saldo Awal) telah DIHAPUS dan direset ke 0.");
                
                // Reset filters to default (All Months, Current Year)
                currentFilterMonth = 0;
                currentFilterYear = CURRENT_YEAR;
                populateFilters();
                recalculateAllReports();
            } else if (confirmation !== null) {
                alert("Reset dibatalkan. Konfirmasi tidak sesuai.");
            }
        }


        // --- ENTRY POINT ---
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize data with dummy if local storage is empty
            if (!localStorage.getItem('m1aTransactions')) {
                // Dummy data for Koin NU Transactions
                m1aTransactions = [
                    { date: '2025-01-05', petugas: 'Pak Ali', noHp: '0812...', donatur: 'Jamaah Masjid', alamat: 'RT 01/RW 03', nominal: 1000000 },
                    { date: '2025-01-10', petugas: 'Bu Siti', noHp: '0857...', donatur: 'Majelis Taklim', alamat: 'RT 05/RW 01', nominal: 2500000 },
                    { date: '2025-02-15', petugas: 'Pak Ali', noHp: '0812...', donatur: 'Kas Panti', alamat: 'RT 02/RW 04', nominal: 500000 }
                ];

                // Dummy data for Manual Transactions
                m2ManualTransactions = [
                    { date: '2025-01-15', keterangan: 'Pengeluaran Santunan Pendidikan', kategori: 'Pendidikan (Lainnya)', debit: 0, kredit: 150000, isAuto: false },
                    { date: '2025-01-20', keterangan: 'Penerimaan Sumbangan Kotak Amal Jumat', kategori: 'Infaq dan Shodaqoh', debit: 50000, kredit: 0, isAuto: false }
                ];
                
                // Set initialData to localStorage if needed in a real app. For this demo, just keep initialData global.
            } else {
                // Load data from localStorage (optional in this context, but good practice)
                // m1aTransactions = JSON.parse(localStorage.getItem('m1aTransactions'));
                // m2ManualTransactions = JSON.parse(localStorage.getItem('m2ManualTransactions'));
            }

            renderAppView();
        });
        
        // Fungsionalitas simpan data ke localStorage untuk real-app
        // window.onbeforeunload = function() {
        //     localStorage.setItem('m1aTransactions', JSON.stringify(m1aTransactions));
        //     localStorage.setItem('m2ManualTransactions', JSON.stringify(m2ManualTransactions));
        // };

    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pembukuan Haul: Donatur, Jurnal & Ekspor Firebase</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <style>
        /* Gaya agar tabel bisa digeser jika terlalu lebar */
        .table-wrapper {
            overflow-x: auto; 
        }

        /* --- PERBAIKAN FONT DAN TEBAL --- */
        /* Ganti font global ke Cambria / Times New Roman / Serif */
        body {
            font-family: Cambria, 'Times New Roman', Times, serif;
            padding: 0 0 80px 0; 
            background-color: #f8f9fa; 
            margin: 0; 
        }

        /* Terapkan tebal untuk elemen penting */
        .text-bold { font-weight: bold; }

        h1, h2, h3, h4, h5, th {
            font-weight: bold;
        }

        /* Gaya Khusus Tabel */
        #tabel-modul-2 {
            width: 100%;
            border-collapse: collapse;
            font-size: 11px; /* Ukuran font lebih kecil untuk kerapatan */
        }
        #tabel-modul-2 th, #tabel-modul-2 td {
            border: 1px solid #dee2e6;
            padding: 5px;
            text-align: left;
            vertical-align: top;
        }
        #tabel-modul-2 thead th {
            background-color: #e9ecef;
            text-align: center;
        }
        #tabel-modul-2 tbody tr:nth-child(even) {
            background-color: #f8f9fa; /* Warna selang-seling */
        }

        /* Header Sticky untuk Modul 2 */
        #tabel-modul-2 thead {
            position: sticky;
            top: 0; /* Tetap di atas saat digulir */
            z-index: 10;
        }

        /* Kontainer Gulir */
        .table-scroll-wrapper {
            max-height: 400px; /* Tinggi maksimum sebelum gulir vertikal muncul */
            overflow-y: auto;
            margin-bottom: 10px;
            border: 1px solid #dee2e6;
        }


        /* CSS untuk Navbar */
        #main-nav {
            background-color: #006400;
            padding: 10px 20px;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 20; /* Lebih tinggi dari header tabel */
        }
        #main-nav h1 {
            color: white;
            font-size: 18px;
            margin: 0;
            flex-shrink: 0;
        }
        #nav-menu {
            display: flex;
            list-style: none;
            padding: 0;
            margin: 0;
        }
        #nav-menu li {
            margin-left: 20px;
        }
        #nav-menu button {
            background: none;
            border: none;
            color: white;
            padding: 5px 10px;
            cursor: pointer;
            font-weight: bold;
        }
        #nav-menu button.active {
            background-color: #008000;
            border-radius: 5px;
        }

        /* CSS untuk Login/Logout */
        #login-status {
            color: white;
            font-size: 14px;
            display: flex;
            align-items: center;
        }
        #login-status button {
            margin-left: 10px;
            background-color: #8b0000; /* Merah Marun untuk Logout */
            padding: 5px 10px;
            border-radius: 5px;
            font-weight: bold;
        }

        /* Container Modul Utama */
        #app-container {
            padding: 20px;
        }
        
        /* Font dan ukuran input */
        input[type="text"], input[type="number"], input[type="date"], select {
            padding: 5px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
            width: 100%;
        }

        /* Admin only view */
        .admin-only-hidden {
            display: none;
        }
    </style>
</head>
<body>

    <nav id="main-nav">
        <h1>Sistem Pembukuan KOIN NU</h1>
        <ul id="nav-menu">
            <li><button onclick="showTab('donatur')">Modul 1A & Donatur</button></li>
            <li><button onclick="showTab('jurnal')">Modul 2 Jurnal Umum</button></li>
            <li><button onclick="showTab('laporan')">Modul 3 Laporan</button></li>
        </ul>
        <div id="login-status">
            <span id="user-email-display">Loading...</span>
            <button id="auth-button" onclick="handleAuth()">Login</button>
        </div>
    </nav>

    <div id="login-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 100;">
        <div style="background: white; width: 300px; margin: 100px auto; padding: 20px; border-radius: 8px;">
            <h2>Login Admin</h2>
            <input type="email" id="login-email" placeholder="Email" style="margin-bottom: 10px;">
            <input type="password" id="login-password" placeholder="Password" style="margin-bottom: 10px;">
            <button onclick="loginUser()" style="width: 100%; background-color: #006400; color: white; padding: 10px; border-radius: 5px; margin-top: 10px;">Login</button>
            <button onclick="toggleModal(false)" style="width: 100%; background-color: #ccc; color: black; padding: 10px; border-radius: 5px; margin-top: 5px;">Batal</button>
        </div>
    </div>


    <div id="app-container">
        
        <div id="donatur" class="p-4" style="display: none;">
            <h2 class="text-green-800 text-lg">MODUL 1A: Input Donatur Koin NU</h2>
            
            <div id="modul-1a-section" class="bg-white p-4 shadow-md rounded-md mb-6">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <div>
                        <label for="m1a-tanggal-input" class="block text-sm font-medium text-gray-700">Tanggal</label>
                        <input type="date" id="m1a-tanggal-input" required>
                    </div>
                    <div>
                        <label for="m1a-nama-petugas-input" class="block text-sm font-medium text-gray-700">Nama Petugas</label>
                        <input type="text" id="m1a-nama-petugas-input" required>
                    </div>
                    <div>
                        <label for="m1a-nominal-input" class="block text-sm font-medium text-gray-700">Nominal Koin NU</label>
                        <input type="number" id="m1a-nominal-input" placeholder="Nominal Uang" min="1000" required data-edit-id="">
                    </div>
                    <div>
                        <label for="m1a-no-hp-input" class="block text-sm font-medium text-gray-700">No. HP Donatur</label>
                        <input type="text" id="m1a-no-hp-input" placeholder="08xxxx">
                    </div>
                    <div>
                        <label for="m1a-donatur-input" class="block text-sm font-medium text-gray-700">Nama Donatur</label>
                        <input type="text" id="m1a-donatur-input" placeholder="Nama Donatur">
                    </div>
                    <div>
                        <label for="m1a-alamat-input" class="block text-sm font-medium text-gray-700">Alamat Donatur</label>
                        <input type="text" id="m1a-alamat-input" placeholder="RT/RW, Desa">
                    </div>
                </div>
                <button onclick="addKoinNUTransaction()" class="mt-4 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
                    Tambah Koin NU
                </button>
                <button onclick="clearKoinNUInputs()" class="mt-4 bg-gray-400 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded ml-2">
                    Reset Form
                </button>
            </div>

            <h3 class="text-green-800 text-base mt-8">MODUL 1: Data Donatur Koin NU</h3>
            <div class="table-scroll-wrapper">
                <table class="w-full text-sm text-left text-gray-500 dark:text-gray-400" id="donatur-table">
                    <thead class="text-xs text-gray-700 uppercase bg-gray-50 dark:bg-gray-700 dark:text-gray-400 sticky top-0" style="z-index: 1;">
                        <tr>
                            <th scope="col" class="py-3 px-6" style="width: 5%;">No</th>
                            <th scope="col" class="py-3 px-6" style="width: 10%;">Tanggal</th>
                            <th scope="col" class="py-3 px-6" style="width: 15%;">Petugas</th>
                            <th scope="col" class="py-3 px-6" style="width: 20%;">Donatur</th>
                            <th scope="col" class="py-3 px-6" style="width: 15%;">No. HP</th>
                            <th scope="col" class="py-3 px-6" style="width: 20%;">Alamat</th>
                            <th scope="col" class="py-3 px-6 text-right" style="width: 10%;">Nominal</th>
                            <th scope="col" class="py-3 px-6" style="width: 5%;">Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="donatur-table-body">
                        </tbody>
                </table>
            </div>

            <div id="donatur-pagination" class="flex justify-between items-center mt-4">
                <button onclick="prevDonaturPage()" class="bg-gray-200 hover:bg-gray-300 py-1 px-3 rounded">Sebelumnya</button>
                <span id="donatur-page-info" class="text-sm">Halaman 1</span>
                <button onclick="nextDonaturPage()" class="bg-gray-200 hover:bg-gray-300 py-1 px-3 rounded">Berikutnya</button>
            </div>
        </div>

        <div id="jurnal" class="p-4" style="display: none;">
            <h2 class="text-green-800 text-lg">MODUL 2: Jurnal Umum (Input Transaksi Lain)</h2>

            <div id="modul-2-input-section" class="bg-white p-4 shadow-md rounded-md mb-6">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    <div>
                        <label for="m2-tanggal-input" class="block text-sm font-medium text-gray-700">Tanggal</label>
                        <input type="date" id="m2-tanggal-input" required>
                    </div>
                    <div>
                        <label for="m2-keterangan-input" class="block text-sm font-medium text-gray-700">Keterangan</label>
                        <input type="text" id="m2-keterangan-input" placeholder="Contoh: Pembelian alat tulis" required>
                    </div>
                    <div>
                        <label for="m2-kategori-input" class="block text-sm font-medium text-gray-700">Kategori</label>
                        <select id="m2-kategori-input" required>
                            <option value="Infaq dan Shodaqoh">Infaq dan Shodaqoh</option>
                            <option value="Bantuan Sosial (Sosum)">Bantuan Sosial (Sosum)</option>
                            <option value="Banom">Banom</option>
                            <option value="Bencana">Bencana</option>
                            <option value="Rapat dan Koordinasi">Rapat dan Koordinasi</option>
                            <option value="Perawatan">Perawatan</option>
                            <option value="Biaya Bank">Biaya Bank</option>
                            <option value="Lain-lain">Lain-lain</option>
                            <option value="Pendidikan (Lainnya)">Pendidikan (Lainnya)</option>
                            <option value="Penerimaan Lain">Penerimaan Lain</option>
                        </select>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="m2-debit-input" class="block text-sm font-medium text-gray-700">Debit (Masuk)</label>
                            <input type="number" id="m2-debit-input" placeholder="0" min="0" data-edit-id="">
                        </div>
                        <div>
                            <label for="m2-kredit-input" class="block text-sm font-medium text-gray-700">Kredit (Keluar)</label>
                            <input type="number" id="m2-kredit-input" placeholder="0" min="0">
                        </div>
                    </div>
                </div>
                <button onclick="addManualTransaction()" class="mt-4 bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded">
                    Tambah Transaksi Lain
                </button>
                <button onclick="clearManualTransactionInputs()" class="mt-4 bg-gray-400 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded ml-2">
                    Reset Form
                </button>
            </div>

            <h3 class="text-green-800 text-base mt-8">Tabel Jurnal Umum (Gabungan Donatur dan Manual)</h3>
            
            <div id="modul-2-section" class="bg-white shadow-md rounded-md">
                <div class="table-scroll-wrapper">
                    <table id="tabel-modul-2">
                        <thead class="text-xs text-gray-700 uppercase bg-gray-50 dark:bg-gray-700 dark:text-gray-400 sticky top-0" style="z-index: 10;">
                            <tr>
                                <th style="width: 30px;">ID/Aksi</th>
                                <th style="width: 80px;">TANGGAL</th>
                                <th style="min-width: 200px;">KETERANGAN</th>
                                <th>KATEGORI</th>
                                <th style="min-width: 120px;">DANA MASUK (DEBIT)</th>
                                <th style="min-width: 120px;">DANA KELUAR (KREDIT)</th>
                                <th style="min-width: 120px;">SALDO</th>
                            </tr>
                        </thead>
                        <tbody id="m2-transaction-body">
                            <tr> 
                                <td colspan="4" class="saldo-awal-row text-right font-bold">Saldo Bulan Lalu:</td> 
                                <td colspan="2"> 
                                    <div id="m2-saldo-awal-display-container" class="admin-only-hidden" style="width: 100%; text-align: right; background-color: #fffacd; font-weight: bold; padding: 0; box-sizing: border-box;">
                                        <input type="number" id="m2-saldo-awal-input" value="0" min="0" oninput="m2SaldoAwal = parseInt(this.value)||0; recalculateAllReports(); renderAllTables();" style="width: 100%; text-align: right; padding: 5px; font-size: 11px;">
                                    </div>
                                    <span id="m2-saldo-awal-static" style="display: block; width: 100%; text-align: right; background-color: #fffacd; font-weight: bold; padding: 5px;">0</span>
                                </td>
                                <td id="m2-saldo-awal-display" class="saldo-awal-row text-right font-bold">0</td>
                            </tr>
                            </tbody>
                    </table>
                </div>
            </div>

            <div id="jurnal-pagination" class="flex justify-between items-center mt-4">
                <button onclick="prevJurnalPage()" class="bg-gray-200 hover:bg-gray-300 py-1 px-3 rounded">Sebelumnya</button>
                <span id="jurnal-page-info" class="text-sm">Halaman 1</span>
                <button onclick="nextJurnalPage()" class="bg-gray-200 hover:bg-gray-300 py-1 px-3 rounded">Berikutnya</button>
            </div>
        </div>

        <div id="laporan" class="p-4" style="display: none;">
            <h2 class="text-green-800 text-lg">MODUL 3: Laporan Keuangan (Laporan Pertanggungjawaban Global)</h2>
            <div class="mb-4">
                <button onclick="exportLaporanGlobalPDF()" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded">
                    Ekspor Laporan Global PDF
                </button>
            </div>
            
            <div id="modul-3-section" class="bg-white p-4 shadow-md rounded-md">
                <div id="m3-summary-info">
                    </div>

                <div class="table-scroll-wrapper mt-4">
                    <table class="w-full text-sm text-gray-700" id="tabel-modul-3">
                        <thead class="text-xs uppercase bg-gray-50 sticky top-0" style="z-index: 1;">
                            <tr>
                                <th rowspan="2" class="py-2 px-3 border">POS</th>
                                <th colspan="2" class="py-2 px-3 border">1. Donatur</th>
                                <th colspan="2" class="py-2 px-3 border">2. Infaq dan Shodaqoh</th>
                                <th colspan="2" class="py-2 px-3 border">3. Bantuan Sosial (Sosum)</th>
                                <th colspan="2" class="py-2 px-3 border">4. Banom</th>
                                <th colspan="2" class="py-2 px-3 border">5. Bencana</th>
                                <th rowspan="2" class="py-2 px-3 border">6. Rapat & Koordinasi</th>
                                <th rowspan="2" class="py-2 px-3 border">7. Perawatan MLU</th>
                                <th rowspan="2" class="py-2 px-3 border">8. Biaya Bank</th>
                                <th rowspan="2" class="py-2 px-3 border">9. Lain-lain</th>
                                <th rowspan="2" class="py-2 px-3 border">Total Pengeluaran (Rp)</th>
                                <th rowspan="2" class="py-2 px-3 border">Total Penerima (Orang)</th>
                            </tr>
                            <tr>
                                <th class="py-2 px-3 border">Uang (Rp)</th>
                                <th class="py-2 px-3 border">Penerima</th>
                                <th class="py-2 px-3 border">Uang (Rp)</th>
                                <th class="py-2 px-3 border">Penerima</th>
                                <th class="py-2 px-3 border">Uang (Rp)</th>
                                <th class="py-2 px-3 border">Penerima</th>
                                <th class="py-2 px-3 border">Uang (Rp)</th>
                                <th class="py-2 px-3 border">Penerima</th>
                                <th class="py-2 px-3 border">Uang (Rp)</th>
                                <th class="py-2 px-3 border">Penerima</th>
                            </tr>
                        </thead>
                        <tbody id="m3-report-body">
                            </tbody>
                        <tfoot id="m3-report-footer">
                            </tfoot>
                    </table>
                </div>
            </div>
        </div>

    </div>

    <script>
        // ================================================================================
        // 1. KONFIGURASI DAN VARIABEL GLOBAL
        // ================================================================================
        
        // GANTI DENGAN KONFIGURASI FIREBASE ANDA SENDIRI
        const firebaseConfig = {
    apiKey: "AIzaSyA_8NMmZBaXZ4H6KQt7rHy8G1URR3HLP3A",
    authDomain: "upzis-ngablak.firebaseapp.com",
    projectId: "upzis-ngablak",
    storageBucket: "upzis-ngablak.firebasestorage.app",
    messagingSenderId: "869549648344",
    appId: "1:869549648344:web:a531a37cce3a87bb672aad"
        };
        
        // Variabel Firebase Global (akan diinisialisasi di window.onload)
        let db;
        let auth;

        // Variabel Data Global
        let allTransactions = []; // Menyimpan Donatur Koin NU (M1A)
        let m2ManualTransactions = []; // Menyimpan Transaksi Manual (M2)
        let m3Data = getInitialM3Data(); // Data kerangka laporan M3
        let m2SaldoAwal = 0; // Saldo awal

        // Status Aplikasi
        let isLoggedIn = false;
        let currentDonaturPage = 1;
        let itemsPerDonaturPage = 10;
        let currentJurnalPage = 1;
        let itemsPerJurnalPage = 15;


        // ================================================================================
        // 2. UTILITAS
        // ================================================================================

        function getInitialM3Data() {
            return {
                bulan: '', tahun: '',
                donaturUang: 0, donaturPenerima: 0,
                infaqUang: 0, infaqPenerima: 0,
                sosumUang: 0, sosumPenerima: 0,
                banomUang: 0, banomPenerima: 0,
                bencanaUang: 0, bencanaPenerima: 0,
                rapat: 0,
                perwtnMlu: 0,
                biayaBank: 0,
                lainLain: 0,
            };
        }
        
        function formatNominal(num) {
            return num.toLocaleString('id-ID');
        }

        function showTab(tabName) {
            document.getElementById('donatur').style.display = 'none';
            document.getElementById('jurnal').style.display = 'none';
            document.getElementById('laporan').style.display = 'none';
            document.getElementById(tabName).style.display = 'block';

            // Update status aktif di nav
            document.querySelectorAll('#nav-menu button').forEach(btn => {
                btn.classList.remove('active');
                if (btn.innerText.toLowerCase().includes(tabName)) {
                    btn.classList.add('active');
                }
            });
            
            // Render ulang tabel saat pindah tab
            if (tabName === 'donatur' || tabName === 'jurnal') {
                renderAllTables();
            } else if (tabName === 'laporan') {
                recalculateAllReports();
                renderLaporanGlobal();
            }
        }
        
        // ================================================================================
        // 3. AUTENTIKASI (FIREBASE AUTH)
        // ================================================================================

        function toggleModal(show) {
            document.getElementById('login-modal').style.display = show ? 'block' : 'none';
        }

        function handleAuth() {
            if (isLoggedIn) {
                auth.signOut();
            } else {
                toggleModal(true);
            }
        }

        async function loginUser() {
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            try {
                await auth.signInWithEmailAndPassword(email, password);
                toggleModal(false);
            } catch (error) {
                alert("Login gagal: " + error.message);
                console.error("Login Error:", error);
            }
        }

        function handleAuthStateChange(user) {
            isLoggedIn = !!user;
            const userDisplay = document.getElementById('user-email-display');
            const authButton = document.getElementById('auth-button');
            const saldoInputContainer = document.getElementById('m2-saldo-awal-display-container');
            const saldoStatic = document.getElementById('m2-saldo-awal-static');


            if (user) {
                userDisplay.innerText = `Admin: ${user.email}`;
                authButton.innerText = 'Logout';
                // Tampilkan input saldo dan sembunyikan static display
                saldoInputContainer.style.display = 'block';
                saldoStatic.style.display = 'none';
                
            } else {
                userDisplay.innerText = 'Belum Login';
                authButton.innerText = 'Login';
                // Sembunyikan input saldo dan tampilkan static display
                saldoInputContainer.style.display = 'none';
                saldoStatic.style.display = 'block';
            }
        }

        // ================================================================================
        // 4. CRUD DAN DATA (MIGRASI KE FIREBASE FIRESTORE)
        // ================================================================================
        
        // =================================== 
        // --- CRUD FIREBASE BARU --- 
        // ===================================
        const deleteTransactionFromFirebase = async (transactionId) => {
            if (!auth.currentUser) {
                alert("Anda harus login untuk menghapus data.");
                return;
            }
            if (!confirm("Apakah Anda yakin ingin menghapus transaksi ini secara permanen?")) {
                return;
            }
            
            try {
                // Hapus dari koleksi user spesifik
                await db.collection("users").doc(auth.currentUser.uid).collection("transactions").doc(transactionId).delete();
                
                console.log("Transaksi berhasil dihapus:", transactionId);
                
                await loadTransactions(); 
                renderAllTables(); 
                recalculateAllReports();
                
            } catch (error) {
                console.error("Error menghapus transaksi: ", error);
                alert("Gagal menghapus data dari Firebase. Lihat konsol untuk detail.");
            }
        };

        const saveTransactionToFirebase = async (data) => {
            const user = auth.currentUser;
            if (!user) {
                alert("Anda harus login untuk menyimpan data.");
                return null;
            }
            
            try {
                if (data.id) {
                    // Update transaksi yang sudah ada (Edit)
                    const docRef = db.collection("users").doc(user.uid).collection("transactions").doc(data.id);
                    // Hapus 'id' dari data sebelum update
                    const { id, ...updatedData } = data; 
                    await docRef.update(updatedData);
                    console.log("Transaksi berhasil diupdate:", data.id);
                    return data.id;

                } else {
                    // Tambahkan transaksi baru (Input Baru)
                    const docRef = await db.collection("users").doc(user.uid).collection("transactions").add({
                        ...data,
                        timestamp: firebase.firestore.Timestamp.now()
                    });
                    console.log("Transaksi berhasil disimpan dengan ID:", docRef.id);
                    return docRef.id;
                }
            } catch (error) {
                console.error("Error menyimpan/mengupdate transaksi: ", error);
                alert("Gagal menyimpan data ke Firebase. Lihat konsol untuk detail.");
                return null;
            }
        };
        // =================================== 
        // --- AKHIR CRUD FIREBASE BARU --- 
        // ===================================

        // Modul 1A - Hapus
        function deleteKoinNUTxn(transactionId) {
            if (!isLoggedIn) return; 
            deleteTransactionFromFirebase(transactionId);
        }

        // Modul 1A - Edit
        function editKoinNUTxn(transactionId) {
            if (!isLoggedIn) return; 
            
            // Cari transaksi di data Donatur
            const tx = allTransactions.find(t => t.id === transactionId);
            
            if (tx) {
                // Pastikan konversi tanggal aman
                const dateValue = (tx.date instanceof Date) ? tx.date.toISOString().split('T')[0] : tx.date;

                document.getElementById('m1a-tanggal-input').value = dateValue;
                document.getElementById('m1a-nama-petugas-input').value = tx.petugas;
                document.getElementById('m1a-no-hp-input').value = tx.noHp;
                document.getElementById('m1a-donatur-input').value = tx.donatur;
                document.getElementById('m1a-alamat-input').value = tx.alamat;
                document.getElementById('m1a-nominal-input').value = tx.nominal;
                
                // Simpan ID transaksi di atribut data input untuk mode Edit
                document.getElementById('m1a-nominal-input').dataset.editId = tx.id;
                
                alert('Data dipindahkan ke form input. Silakan edit dan klik "Tambah Koin NU" untuk menyimpan perubahan.');
            } else {
                alert("Error: Transaksi Donatur tidak ditemukan.");
            }
        }

        // Modul 1A - Input/Update
        async function addKoinNUTransaction() {
            if (!isLoggedIn) return; 
            const date = document.getElementById('m1a-tanggal-input').value;
            const petugas = document.getElementById('m1a-nama-petugas-input').value.trim();
            const noHp = document.getElementById('m1a-no-hp-input').value.trim();
            const donatur = document.getElementById('m1a-donatur-input').value.trim();
            const alamat = document.getElementById('m1a-alamat-input').value.trim();
            const nominalInput = document.getElementById('m1a-nominal-input');
            const nominal = parseInt(nominalInput.value) || 0;

            if (!date || !petugas || nominal <= 0) {
                alert("Tanggal, Nama Petugas, dan Nominal Koin NU harus diisi dengan benar.");
                return;
            }
            
            // Periksa apakah ini mode edit
            const transactionId = nominalInput.dataset.editId;
            
            const data = {
                date: date,
                petugas: petugas,
                noHp: noHp,
                donatur: donatur,
                alamat: alamat,
                nominal: nominal,
                isManual: false, // Donatur Koin NU (Modul 1A)
            };
            
            if (transactionId) {
                data.id = transactionId;
            }

            const savedId = await saveTransactionToFirebase(data);
            
            if (savedId) {
                clearKoinNUInputs();
                await loadTransactions(); 
                renderAllTables();
                recalculateAllReports();
            }
        }

        function clearKoinNUInputs() {
            document.getElementById('m1a-tanggal-input').value = '';
            document.getElementById('m1a-nama-petugas-input').value = '';
            document.getElementById('m1a-no-hp-input').value = '';
            document.getElementById('m1a-donatur-input').value = '';
            document.getElementById('m1a-alamat-input').value = '';
            document.getElementById('m1a-nominal-input').value = '';
            document.getElementById('m1a-nominal-input').dataset.editId = ''; // Clear edit ID
            alert('Form Donatur dikosongkan.');
        }

        // Modul 2 - Edit
        function editManualTxn(transactionId) {
            if (!isLoggedIn) return; 
            
            // Cari transaksi di data Jurnal Manual
            const tx = m2ManualTransactions.find(t => t.id === transactionId);
            
            if (tx) {
                // Pastikan konversi tanggal aman
                const dateValue = (tx.date instanceof Date) ? tx.date.toISOString().split('T')[0] : tx.date;

                document.getElementById('m2-tanggal-input').value = dateValue;
                document.getElementById('m2-keterangan-input').value = tx.keterangan;
                document.getElementById('m2-kategori-input').value = tx.kategori;
                document.getElementById('m2-debit-input').value = tx.debit;
                document.getElementById('m2-kredit-input').value = tx.kredit;
                
                // Simpan ID transaksi di atribut data input untuk mode Edit
                document.getElementById('m2-debit-input').dataset.editId = tx.id;
                
                alert('Data dipindahkan ke form input. Silakan edit dan klik "Tambah Transaksi Lain" untuk menyimpan perubahan.');
            } else {
                alert("Error: Transaksi Jurnal tidak ditemukan.");
            }
        }

        // Modul 2 - Input/Update
        async function addManualTransaction() {
            if (!isLoggedIn) return;
            const date = document.getElementById('m2-tanggal-input').value;
            const keterangan = document.getElementById('m2-keterangan-input').value.trim();
            const kategori = document.getElementById('m2-kategori-input').value;
            const debit = parseInt(document.getElementById('m2-debit-input').value) || 0;
            const kredit = parseInt(document.getElementById('m2-kredit-input').value) || 0;

            if (!date || !keterangan || (debit === 0 && kredit === 0)) {
                alert("Tanggal, Keterangan, dan minimal satu nominal Debit/Kredit harus diisi.");
                return;
            }

            // Periksa apakah ini mode edit
            const transactionId = document.getElementById('m2-debit-input').dataset.editId;
            
            const data = {
                date: date,
                keterangan: keterangan,
                kategori: kategori,
                debit: debit,
                kredit: kredit,
                isManual: true, // Jurnal Manual (Modul 2)
            };

            if (transactionId) {
                data.id = transactionId;
            }

            const savedId = await saveTransactionToFirebase(data);
            
            if (savedId) {
                clearManualTransactionInputs();
                await loadTransactions(); 
                renderAllTables();
                recalculateAllReports();
            }
        }

        function clearManualTransactionInputs() {
            document.getElementById('m2-tanggal-input').value = '';
            document.getElementById('m2-keterangan-input').value = '';
            document.getElementById('m2-kategori-input').value = 'Infaq dan Shodaqoh';
            document.getElementById('m2-debit-input').value = '';
            document.getElementById('m2-kredit-input').value = '';
            document.getElementById('m2-debit-input').dataset.editId = ''; // Clear edit ID
            alert('Form Jurnal dikosongkan.');
        }

        // ================================================================================
        // 5. RENDER TABEL
        // ================================================================================
        
        function renderDonaturTable(transactions, page) {
            const tbody = document.getElementById('donatur-table-body');
            const pageInfo = document.getElementById('donatur-page-info');
            tbody.innerHTML = '';
            
            const totalItems = transactions.length;
            const totalPages = Math.ceil(totalItems / itemsPerDonaturPage);
            
            let currentPage = Math.max(1, Math.min(page, totalPages));
            currentDonaturPage = currentPage; // Update global page state

            const start = (currentPage - 1) * itemsPerDonaturPage;
            const end = start + itemsPerDonaturPage;
            const transactionsOnPage = transactions.slice(start, end);
            
            let totalNominal = 0;
            
            transactionsOnPage.forEach((transaction, indexInPage) => {
                const globalIndex = start + indexInPage + 1;
                totalNominal += transaction.nominal;
                
                const dateDisplay = (transaction.date instanceof Date) ? transaction.date.toISOString().split('T')[0] : transaction.date;
                
                let html = `
                    <tr class="bg-white border-b dark:bg-gray-800 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600">
                        <td class="py-2 px-6">${globalIndex}</td>
                        <td class="py-2 px-6">${dateDisplay}</td>
                        <td class="py-2 px-6">${transaction.petugas}</td>
                        <td class="py-2 px-6">${transaction.donatur || '-'}</td>
                        <td class="py-2 px-6">${transaction.noHp || '-'}</td>
                        <td class="py-2 px-6">${transaction.alamat || '-'}</td>
                        <td class="py-2 px-6 text-right">${formatNominal(transaction.nominal)}</td>
                        <td class="py-2 px-6">
                            <button class="text-blue-500 hover:text-blue-700 font-bold mr-2" onclick="editKoinNUTxn('${transaction.id}')">Edit</button>
                            <button class="text-red-500 hover:text-red-700 font-bold" onclick="deleteTransactionFromFirebase('${transaction.id}')">Hapus</button>
                        </td>
                    </tr>
                `;
                tbody.innerHTML += html;
            });

            pageInfo.innerText = `Halaman ${currentPage} dari ${totalPages || 1} (Total: ${totalItems} Donatur)`;
            
            // Tambahkan baris total
            const totalDonasiKeseluruhan = transactions.reduce((acc, t) => acc + t.nominal, 0);
            const totalRow = `
                <tr class="bg-gray-100 font-bold border-t-2 border-gray-900">
                    <td colspan="6" class="py-2 px-6 text-right">TOTAL DONASI HALAMAN INI:</td>
                    <td class="py-2 px-6 text-right">${formatNominal(totalNominal)}</td>
                    <td class="py-2 px-6"></td>
                </tr>
                <tr class="bg-gray-200 font-bold border-t-2 border-gray-900">
                    <td colspan="6" class="py-2 px-6 text-right">TOTAL DONASI KESELURUHAN:</td>
                    <td class="py-2 px-6 text-right">${formatNominal(totalDonasiKeseluruhan)}</td>
                    <td class="py-2 px-6"></td>
                </tr>
            `;
            tbody.innerHTML += totalRow;

            return totalDonasiKeseluruhan; 
        }

        function prevDonaturPage() {
            if (currentDonaturPage > 1) {
                currentDonaturPage--;
                renderAllTables();
            }
        }

        function nextDonaturPage() {
            const totalItems = allTransactions.length;
            const totalPages = Math.ceil(totalItems / itemsPerDonaturPage);
            if (currentDonaturPage < totalPages) {
                currentDonaturPage++;
                renderAllTables();
            }
        }

        function renderJurnalTable(totalDonasi, page) {
            const tbody = document.getElementById('m2-transaction-body');
            const pageInfo = document.getElementById('jurnal-page-info');
            
            // Gabungkan semua transaksi (Donasi Otomatis + Manual)
            const autoTransactions = allTransactions.map(t => {
                const dateDisplay = (t.date instanceof Date) ? t.date.toISOString().split('T')[0] : t.date;
                return {
                    id: t.id,
                    date: dateDisplay,
                    keterangan: `Donasi Koin NU (${t.donatur || 'Anonim'} - ${t.petugas})`,
                    kategori: 'Infaq dan Shodaqoh',
                    debit: t.nominal,
                    kredit: 0,
                    isManual: false,
                    timestamp: t.timestamp
                };
            });

            const allJurnalEntries = [
                ...autoTransactions,
                ...m2ManualTransactions.map(t => {
                    const dateDisplay = (t.date instanceof Date) ? t.date.toISOString().split('T')[0] : t.date;
                    return { ...t, date: dateDisplay };
                })
            ];

            // Urutkan berdasarkan tanggal, lalu timestamp (untuk memastikan urutan saat tanggal sama)
            allJurnalEntries.sort((a, b) => {
                if (a.date < b.date) return -1;
                if (a.date > b.date) return 1;
                if (a.timestamp < b.timestamp) return -1;
                if (a.timestamp > b.timestamp) return 1;
                return 0;
            });
            
            const totalItems = allJurnalEntries.length;
            const totalPages = Math.ceil(totalItems / itemsPerJurnalPage);
            
            let currentPage = Math.max(1, Math.min(page, totalPages));
            currentJurnalPage = currentPage; // Update global page state

            const start = (currentPage - 1) * itemsPerJurnalPage;
            const end = start + itemsPerJurnalPage;
            const transactionsOnPage = allJurnalEntries.slice(start, end);
            
            let currentSaldo = m2SaldoAwal;
            
            // Hitung saldo hingga halaman saat ini
            for (let i = 0; i < start; i++) {
                currentSaldo += (allJurnalEntries[i].debit || 0) - (allJurnalEntries[i].kredit || 0);
            }

            let html = '';

            // Render Saldo Awal (Baris Terkunci Saldo Awal)
            // Ambil dan update elemen Saldo Awal di DOM
            document.getElementById('m2-saldo-awal-input').value = m2SaldoAwal;
            document.getElementById('m2-saldo-awal-static').innerText = formatNominal(m2SaldoAwal);
            
            // Perbarui saldo yang tampil di baris Saldo Bulan Lalu
            document.getElementById('m2-saldo-awal-display').innerText = formatNominal(currentSaldo);

            let totalDebitOnPage = 0;
            let totalKreditOnPage = 0;
            
            transactionsOnPage.forEach((t) => {
                const debit = t.debit || 0;
                const kredit = t.kredit || 0;
                currentSaldo += debit - kredit;

                totalDebitOnPage += debit;
                totalKreditOnPage += kredit;

                // Tentukan aksi dan warna latar
                let aksiHtml;
                let bgColorClass = t.isManual ? 'bg-yellow-50' : 'bg-green-50'; // Kuning untuk manual, Hijau untuk Donasi Otomatis
                
                if (t.isManual) {
                    // Transaksi manual bisa diedit/dihapus
                    aksiHtml = `
                        <button class="text-blue-500 hover:text-blue-700 font-bold mr-2" onclick="editManualTxn('${t.id}')">Edit</button>
                        <button class="text-red-500 hover:text-red-700 font-bold" onclick="deleteTransactionFromFirebase('${t.id}')">Hapus</button>
                    `;
                } else {
                    // Transaksi otomatis (Donasi Koin NU)
                    aksiHtml = `
                        <button class="text-gray-500 hover:text-gray-700 font-bold" onclick="showTab('donatur')">Lihat M1A</button>
                    `;
                }

                html += `
                    <tr class="border-b ${bgColorClass} hover:bg-gray-100">
                        <td class="py-2 px-6">${aksiHtml}</td>
                        <td class="py-2 px-6">${t.date}</td>
                        <td class="py-2 px-6">${t.keterangan}</td>
                        <td class="py-2 px-6">${t.kategori}</td>
                        <td class="py-2 px-6 text-right">${formatNominal(debit)}</td>
                        <td class="py-2 px-6 text-right">${formatNominal(kredit)}</td>
                        <td class="py-2 px-6 text-right font-bold">${formatNominal(currentSaldo)}</td>
                    </tr>
                `;
            });

            // Tambahkan baris total
            const totalRow = `
                <tr class="bg-gray-200 font-bold border-t-2 border-gray-900 sticky bottom-0" style="z-index: 5;">
                    <td colspan="4" class="py-2 px-6 text-right">TOTAL TRANSAKSI HALAMAN INI:</td>
                    <td class="py-2 px-6 text-right">${formatNominal(totalDebitOnPage)}</td>
                    <td class="py-2 px-6 text-right">${formatNominal(totalKreditOnPage)}</td>
                    <td class="py-2 px-6 text-right">${formatNominal(currentSaldo)}</td>
                </tr>
            `;
            html += totalRow;

            // Masukkan data transaksi dan total ke tbody, setelah baris Saldo Awal (yang statis)
            // Kita harus mengambil baris pertama (Saldo Awal) dan mengganti sisanya.
            const saldoAwalRow = document.querySelector('#tabel-modul-2 tbody tr:first-child').outerHTML;
            tbody.innerHTML = saldoAwalRow + html;

            pageInfo.innerText = `Halaman ${currentPage} dari ${totalPages || 1} (Total: ${totalItems} Transaksi)`;
        }

        function prevJurnalPage() {
            if (currentJurnalPage > 1) {
                currentJurnalPage--;
                renderAllTables();
            }
        }

        function nextJurnalPage() {
            // Logika paginasi perlu data gabungan
            const totalJurnalEntries = allTransactions.length + m2ManualTransactions.length;
            const totalPages = Math.ceil(totalJurnalEntries / itemsPerJurnalPage);
            if (currentJurnalPage < totalPages) {
                currentJurnalPage++;
                renderAllTables();
            }
        }


        // ================================================================================
        // 6. LAPORAN (MODUL 3)
        // ================================================================================

        function recalculateAllReports() {
            m3Data = getInitialM3Data();
            
            // Hitung Donatur (M1A)
            m3Data.donaturUang = allTransactions.reduce((sum, t) => sum + (t.nominal || 0), 0);
            m3Data.donaturPenerima = allTransactions.length;
            
            // Hitung Jurnal Manual (M2)
            m2ManualTransactions.forEach(t => {
                const debit = t.debit || 0;
                const kredit = t.kredit || 0;
                
                if (debit > 0) {
                    // Penerimaan (masuk)
                    if (t.kategori === 'Infaq dan Shodaqoh') m3Data.infaqUang += debit;
                    else if (t.kategori === 'Penerimaan Lain') m3Data.lainLain += debit;
                } else if (kredit > 0) {
                    // Pengeluaran (keluar)
                    if (t.kategori === 'Bantuan Sosial (Sosum)') {
                        m3Data.sosumUang += kredit;
                        m3Data.sosumPenerima += 1; // Asumsi 1 transaksi = 1 penerima
                    }
                    else if (t.kategori === 'Banom') {
                        m3Data.banomUang += kredit;
                        m3Data.banomPenerima += 1;
                    }
                    else if (t.kategori === 'Bencana') {
                        m3Data.bencanaUang += kredit;
                        m3Data.bencanaPenerima += 1;
                    }
                    else if (t.kategori === 'Rapat dan Koordinasi') m3Data.rapat += kredit;
                    else if (t.kategori === 'Perawatan') m3Data.perwtnMlu += kredit;
                    else if (t.kategori === 'Biaya Bank') m3Data.biayaBank += kredit;
                    else if (t.kategori === 'Lain-lain' || t.kategori === 'Pendidikan (Lainnya)') m3Data.lainLain += kredit;
                }
            });
            
            renderLaporanGlobal();
        }

        function renderLaporanGlobal() {
            const tbody = document.getElementById('m3-report-body');
            const tfoot = document.getElementById('m3-report-footer');
            const summaryDiv = document.getElementById('m3-summary-info');
            tbody.innerHTML = '';
            tfoot.innerHTML = '';

            const m3 = m3Data;
            
            // Hitung Total Pemasukan dan Pengeluaran
            // Total Pemasukan adalah jumlah dari Donatur (M1A) dan Infaq/Penerimaan Lain (M2)
            const totalPemasukan = m3.donaturUang + m3.infaqUang + m3.lainLain; 
            const totalPengeluaran = m3.sosumUang + m3.banomUang + m3.bencanaUang + m3.rapat + m3.perwtnMlu + m3.biayaBank + m3.lainLain;
            const saldoAkhir = m2SaldoAwal + totalPemasukan - totalPengeluaran;
            const totalPenerima = m3.donaturPenerima + m3.sosumPenerima + m3.banomPenerima + m3.bencanaPenerima; // Hanya penerima yang dihitung

            // Render Ringkasan
            summaryDiv.innerHTML = `
                <p class="text-sm"><strong>Saldo Awal Periode:</strong> ${formatNominal(m2SaldoAwal)}</p>
                <p class="text-sm"><strong>Total Pemasukan (Baru):</strong> ${formatNominal(totalPemasukan)}</p>
                <p class="text-sm"><strong>Total Pengeluaran:</strong> ${formatNominal(totalPengeluaran)}</p>
                <p class="text-lg text-bold text-green-700"><strong>SALDO AKHIR PERIODE:</strong> ${formatNominal(saldoAkhir)}</p>
                <hr class="my-3">
            `;

            // Render Baris Data Pemasukan
            let pemasukanHtml = `
                <tr class="bg-green-100 font-bold">
                    <td colspan="18" class="py-2 px-3 border text-left">A. PEMASUKAN</td>
                </tr>
                <tr>
                    <td class="py-2 px-3 border">1. Donatur (Koin NU)</td>
                    <td class="py-2 px-3 border text-right">${formatNominal(m3.donaturUang)}</td>
                    <td class="py-2 px-3 border text-center">${formatNominal(m3.donaturPenerima)}</td>
                    <td colspan="15" class="py-2 px-3 border"></td>
                </tr>
                <tr>
                    <td class="py-2 px-3 border">2. Infaq dan Shodaqoh (Manual)</td>
                    <td colspan="2" class="py-2 px-3 border"></td>
                    <td class="py-2 px-3 border text-right">${formatNominal(m3.infaqUang)}</td>
                    <td class="py-2 px-3 border text-center"></td>
                    <td colspan="13" class="py-2 px-3 border"></td>
                </tr>
                <tr>
                    <td class="py-2 px-3 border">3. Penerimaan Lain (Manual)</td>
                    <td colspan="13" class="py-2 px-3 border"></td>
                    <td class="py-2 px-3 border text-right">${formatNominal(m3.lainLain)}</td>
                    <td colspan="2" class="py-2 px-3 border"></td>
                </tr>
                <tr class="bg-green-200 font-bold">
                    <td class="py-2 px-3 border text-bold">TOTAL PEMASUKAN</td>
                    <td colspan="17" class="py-2 px-3 border text-right text-bold">${formatNominal(totalPemasukan)}</td>
                </tr>
            `;

            // Render Baris Data Pengeluaran
            let pengeluaranHtml = `
                <tr class="bg-red-100 font-bold">
                    <td colspan="18" class="py-2 px-3 border text-left">B. PENGELUARAN</td>
                </tr>
                <tr>
                    <td class="py-2 px-3 border">1. Bantuan Sosial (Sosum)</td>
                    <td colspan="4" class="py-2 px-3 border"></td>
                    <td class="py-2 px-3 border text-right">${formatNominal(m3.sosumUang)}</td>
                    <td class="py-2 px-3 border text-center">${formatNominal(m3.sosumPenerima)}</td>
                    <td colspan="11" class="py-2 px-3 border"></td>
                </tr>
                <tr>
                    <td class="py-2 px-3 border">2. Banom</td>
                    <td colspan="6" class="py-2 px-3 border"></td>
                    <td class="py-2 px-3 border text-right">${formatNominal(m3.banomUang)}</td>
                    <td class="py-2 px-3 border text-center">${formatNominal(m3.banomPenerima)}</td>
                    <td colspan="9" class="py-2 px-3 border"></td>
                </tr>
                <tr>
                    <td class="py-2 px-3 border">3. Bencana</td>
                    <td colspan="8" class="py-2 px-3 border"></td>
                    <td class="py-2 px-3 border text-right">${formatNominal(m3.bencanaUang)}</td>
                    <td class="py-2 px-3 border text-center">${formatNominal(m3.bencanaPenerima)}</td>
                    <td colspan="7" class="py-2 px-3 border"></td>
                </tr>
                <tr>
                    <td class="py-2 px-3 border">4. Rapat & Koordinasi</td>
                    <td colspan="10" class="py-2 px-3 border"></td>
                    <td class="py-2 px-3 border text-right">${formatNominal(m3.rapat)}</td>
                    <td colspan="5" class="py-2 px-3 border"></td>
                </tr>
                <tr>
                    <td class="py-2 px-3 border">5. Perawatan MLU</td>
                    <td colspan="11" class="py-2 px-3 border"></td>
                    <td class="py-2 px-3 border text-right">${formatNominal(m3.perwtnMlu)}</td>
                    <td colspan="4" class="py-2 px-3 border"></td>
                </tr>
                <tr>
                    <td class="py-2 px-3 border">6. Biaya Bank</td>
                    <td colspan="12" class="py-2 px-3 border"></td>
                    <td class="py-2 px-3 border text-right">${formatNominal(m3.biayaBank)}</td>
                    <td colspan="3" class="py-2 px-3 border"></td>
                </tr>
                <tr>
                    <td class="py-2 px-3 border">7. Pengeluaran Lain-lain</td>
                    <td colspan="13" class="py-2 px-3 border"></td>
                    <td class="py-2 px-3 border text-right">${formatNominal(m3.lainLain)}</td>
                    <td colspan="2" class="py-2 px-3 border"></td>
                </tr>
                <tr class="bg-red-200 font-bold">
                    <td class="py-2 px-3 border text-bold">TOTAL PENGELUARAN</td>
                    <td colspan="14" class="py-2 px-3 border"></td>
                    <td class="py-2 px-3 border text-right text-bold">${formatNominal(totalPengeluaran)}</td>
                    <td class="py-2 px-3 border text-center text-bold">${formatNominal(totalPenerima)}</td>
                </tr>
            `;

            // Render Total Saldo
            let totalHtml = `
                <tr class="bg-gray-300 font-bold">
                    <td colspan="15" class="py-2 px-3 border text-left">SALDO AKHIR PERIODE (A + Saldo Awal - B)</td>
                    <td colspan="3" class="py-2 px-3 border text-right text-bold">${formatNominal(saldoAkhir)}</td>
                </tr>
            `;
            
            tbody.innerHTML = pemasukanHtml + pengeluaranHtml;
            tfoot.innerHTML = totalHtml;
        }

        function exportLaporanGlobalPDF() {
            window.jsPDF = window.jspdf.jsPDF;
            const doc = new jsPDF('landscape');
            const table = document.getElementById('tabel-modul-3');
            
            doc.text("Laporan Pertanggungjawaban Global", 148, 10, { align: "center" });
            
            // Konfigurasi jspdf-autotable
            doc.autoTable({
                html: table,
                startY: 15,
                theme: 'grid',
                headStyles: { 
                    fillColor: [233, 236, 239], 
                    textColor: 50, 
                    fontStyle: 'bold', 
                    fontSize: 6.5,
                    halign: 'center'
                },
                styles: { 
                    fontSize: 7, 
                    cellPadding: 2,
                },
                bodyStyles: {
                    halign: 'right'
                },
                footStyles: { 
                    fontStyle: 'bold', 
                    fillColor: [209, 213, 219],
                    halign: 'right'
                },
                didDrawCell: function(data) {
                    if (data.section === 'body') {
                        // Align kiri untuk kolom POS
                        if (data.column.index === 0) {
                            doc.text(data.cell.text, data.cell.x + data.cell.padding('left'), data.cell.y + data.cell.height / 2, { valign: 'middle', align: 'left' });
                        }
                        // Align tengah untuk kolom Penerima (index 2, 4, 6, 8, 10, 16)
                        const centerIndices = [2, 4, 6, 8, 10, 16];
                        if (centerIndices.includes(data.column.index)) {
                             doc.text(data.cell.text, data.cell.x + data.cell.width / 2, data.cell.y + data.cell.height / 2, { valign: 'middle', align: 'center' });
                        }
                    }
                }
            });

            // Tambahkan ringkasan
            const summaryInfo = document.getElementById('m3-summary-info').innerText.split('\n');
            let yPos = doc.lastAutoTable.finalY + 10;
            summaryInfo.forEach(line => {
                doc.text(line, 15, yPos);
                yPos += 7;
            });
            
            doc.save("LPJ_Global_Ringkasan.pdf");
        }


        // =================================================================================
        // 7. RENDER ALL DAN ONLOAD
        // =================================================================================

        const renderAllTables = () => {
            // Urutkan donatur sebelum merender
            allTransactions.sort((a, b) => a.timestamp - b.timestamp);
            const totalDonasi = renderDonaturTable(allTransactions, currentDonaturPage);
            renderJurnalTable(totalDonasi, currentJurnalPage);
        };

        window.onload = async () => { 
            
            // Inisialisasi Firebase
            firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            auth = firebase.auth(); 
            
            // Listener status autentikasi: fungsi handleAuthStateChange akan dipanggil
            auth.onAuthStateChanged(async (user) => {
                
                // Ambil data sebelum update status login untuk memastikan tampilan saldo yang benar
                await loadTransactions(); 
                handleAuthStateChange(user); 
                
                // Panggil render setelah semua data siap
                renderAllTables(); 
                recalculateAllReports(); 
            });

            // *PENTING: Panggil ini untuk menampilkan Donatur sebagai tab default*
            showTab('donatur'); 
        };

        // =================================================================================
        // 8. DATA LOADING
        // =================================================================================

        const loadTransactions = async () => {
            const user = auth.currentUser;
            
            if (!user) {
                allTransactions = [];
                m2ManualTransactions = [];
                m3Data = getInitialM3Data(); 
                console.log("Pengguna belum login, data tidak dimuat.");
                return;
            }

            try {
                // Ambil data dari Firestore, diurutkan berdasarkan timestamp
                const querySnapshot = await db.collection("users").doc(user.uid).collection("transactions")
                                            .orderBy("timestamp", "asc") 
                                            .get();

                allTransactions = [];
                m2ManualTransactions = [];
                
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    data.id = doc.id; 
                    
                    // Konversi Firebase Timestamp menjadi objek Date standar
                    if (data.timestamp && data.timestamp.toDate) {
                        data.timestamp = data.timestamp.toDate(); 
                    }

                    if (data.isManual === true) {
                        m2ManualTransactions.push(data);
                    } else {
                        allTransactions.push(data);
                    }
                });
                
                console.log(`Data ${allTransactions.length + m2ManualTransactions.length} berhasil dimuat dari Firestore untuk user: ${user.uid}.`);

            } catch (error) {
                console.error("Error memuat data dari Firestore: ", error);
                // Biarkan data kosong, jangan alert agar aplikasi tidak crash
                allTransactions = []; 
                m2ManualTransactions = [];
            }
        };
    </script>

</body>
</html>


