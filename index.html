<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Pembukuan UPZIS | Ranting Ngablak</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <style>
        /* Gaya CSS untuk Tampilan */
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; padding: 0; background-color: #f4f7f6; color: #333; }
        .container { padding: 20px; max-width: 100%; margin: auto; } /* Lebar Maksimum Disesuaikan */
        
        /* Gaya Navigasi */
        .navbar { background-color: #006400; color: white; padding: 10px 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.2); display: flex; align-items: center; justify-content: space-between; }
        .navbar-logo { font-size: 1.5rem; font-weight: bold; }
        .navbar-links a { color: white; text-decoration: none; padding: 8px 15px; margin-left: 10px; border-radius: 4px; transition: background-color 0.3s; }
        .navbar-links a:hover, .navbar-links a.active { background-color: #008000; }
        
        .button { padding: 10px 15px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; transition: background-color 0.3s; }
        .btn-green { background-color: #008000; color: white; }
        .btn-green:hover { background-color: #006400; }
        .btn-red { background-color: #cc0000; color: white; }
        .btn-red:hover { background-color: #a00000; }
        .btn-blue { background-color: #007bff; color: white; }
        .btn-blue:hover { background-color: #0056b3; }
        
        /* Gaya Login Box */
        .login-box { 
            background: white; 
            padding: 30px; 
            border-radius: 8px; 
            box-shadow: 0 4px 8px rgba(0,0,0,0.1); 
            width: 450px; 
            margin: 20px auto; 
        }
        .login-input-row { 
            display: flex; 
            gap: 10px; 
            margin-bottom: 10px; 
        }
        .login-input-row input { 
            width: 50%; 
            padding: 10px; 
            border: 1px solid #ccc; 
            border-radius: 4px; 
            box-sizing: border-box; 
            margin-bottom: 0; 
        }

        table { width: 100%; border-collapse: collapse; margin-top: 15px; background: white; box-shadow: 0 2px 4px rgba(0,0,0,0.05); font-size: 0.9rem; }
        th, td { border: 1px solid #ddd; padding: 10px; text-align: left; }
        th { background-color: #006400; color: white; text-align: center; font-size: small; }
        
        /* Gaya untuk kolom angka */
        .money-col { text-align: right !important; }
        /* Kelas untuk elemen yang disembunyikan di luar PDF Koin NU (Hanya Pembagian Dana yang tetap disembunyikan) */
        .koin-pembagian-col, .koin-pembagian-header { display: table-cell; }
        
        .action-btns button { margin: 2px; font-size: 0.7rem; padding: 5px; }
        .input-form { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); margin-top: 30px; }
        .input-form h3 { color: #006400; border-bottom: 2px solid #006400; padding-bottom: 5px; }
        .form-row { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 10px; }
        .form-row label { font-weight: bold; display: block; margin-bottom: 5px; }
        .form-row input, .form-row select { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        .form-controls { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        
        /* Gaya Footer Total */
        tfoot td { font-weight: bold; text-align: right; background-color: #f0f0f0; }
        .total-label { text-align: right !important; }

        /* TTD Area Diperbaiki (Centered Block) */
        .ttd-area { 
            width: 80%; 
            margin: 30px auto 0 auto; 
            display: none; 
            justify-content: space-between; 
            padding: 20px 0; 
            box-sizing: border-box; 
        }
        .ttd-box { 
            text-align: center; 
            width: 45%; 
        }
        
        .ttd-box p { margin: 0; line-height: 1.5; }
        .ttd-line { 
            height: 1px; 
            width: 100%; 
            background: black; 
            margin: 30px 0 5px 0; 
        }
        /* ============================ */

        .report-header-section {
            display: flex;
            justify-content: space-between; 
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #ddd;
        }
        .report-title-center { text-align: center; flex-grow: 1; }
        .report-controls { display: flex; gap: 10px; align-items: center; }
        .auto-entry { font-style: italic; background-color: #f9f9f9; }
        .manual-entry { background-color: #fffacd; } 
        .saldo-entry { background-color: #e6ffe6; font-weight: bold; } 
        .total-saldo { background-color: #d4edda !important; color: #155724; } 
        
        /* === Gaya Laporan Tahunan Baru === */
        #annual-data-table th { font-size: x-small; padding: 5px; vertical-align: middle; }
        #annual-data-table td { font-size: x-small; padding: 5px; }
        .annual-sub-header { background-color: #008000; color: white; font-weight: bold; }
        .annual-manual-input { background-color: #fffacd; }
        .annual-saldo-row { background-color: #e6ffe6; }
        .annual-total-row { background-color: #d4edda !important; color: #155724; font-weight: bold; }
        .editable-cell { cursor: pointer; border-bottom: 1px dashed #007bff; }
        
        /* Gaya untuk Baris KOIN NU (Baris 1-4) */
        .koin-fixed-entry { background-color: #f0fff0; font-weight: normal; }
    </style>
</head>
<body>

    <div class="navbar">
        <span class="navbar-logo">Pembukuan UPZIS</span>
        <div class="navbar-links">
            <a href="#" id="nav-koin" onclick="showModule('koin')">Laporan KOIN NU</a>
            <a href="#" id="nav-jurnal" onclick="showModule('jurnal')">Jurnal Umum</a>
            <a href="#" id="nav-tahunan" onclick="showModule('tahunan')">Laporan Tahunan</a>
        </div>
    </div>

    <div class="container">
        
        <div id="koin-nu-module" style="display: none;">
            <div id="koin-pdf-content">
                <div style="text-align: center; margin-bottom: 10px; padding-bottom: 10px; border-bottom: 3px double #006400;">
                    <h1 style="color: #006400; margin: 0; line-height: 1.2; font-size: 24px;">NU CARE UPZIS - LAZISNU RANTING NGABLAK</h1>
                    <p style="margin: 0; font-size: 14px; color: #555;">Sekretariat: Jalan [Nama Jalan], Desa Ngablak, Kec. [Kecamatan], Kab. [Kabupaten]</p>
                </div>

                <div class="report-header-section">
                    <div class="report-controls">
                        <label for="koin-filter-bulan">Bulan:</label>
                        <select id="koin-filter-bulan" onchange="filterData('koin')"></select>
                        <label for="koin-filter-tahun">Tahun:</label>
                        <select id="koin-filter-tahun" onchange="filterData('koin')"></select>
                    </div>
                    
                    <div class="report-title-center">
                        <p style="font-weight: bold; margin: 0;">Laporan Pemasukan KOIN NU Periode <span id="koin-pdf-periode-display"></span></p>
                    </div>

                    <div class="report-controls">
                        <button class="button btn-red" id="koin-download-btn-header" onclick="downloadPDF('koin')">Unduh PDF</button>
                    </div>
                </div>


                <table id="koin-data-table">
                    <thead>
                        <tr>
                            <th rowspan="2">NO</th>
                            <th rowspan="2">TANGGAL</th>
                            <th rowspan="2">NAMA PETUGAS</th>
                            <th rowspan="2" id="koin-hp-header">NO HP</th> 
                            <th rowspan="2">DONATUR/KELOMPOK</th>
                            <th rowspan="2" id="koin-alamat-header">ALAMAT (RT/RW)</th> 
                            <th rowspan="2" class="money-col">NOMINAL</th> 
                            <th colspan="4" class="koin-pembagian-header">PEMBAGIAN DANA KOIN</th> 
                            <th rowspan="2" id="koin-aksi-header" style="display: none;">Aksi">Aksi</th>
                        </tr>
                        <tr>
                            <th class="koin-pembagian-header money-col">Petugas (10%)</th> 
                            <th class="koin-pembagian-header money-col">Ranting (60%)</th> 
                            <th class="koin-pembagian-header money-col">MWC (25%)</th> 
                            <th class="koin-pembagian-header money-col">PC (5%)</th> 
                        </tr>
                    </thead>
                    <tbody id="koin-data-body">
                        </tbody>
                    <tfoot>
                        <tr>
                            <td colspan="6" class="total-label" id="koin-total-label">TOTAL PENJUMLAHAN</td>
                            <td id="koin-total-nominal" class="money-col">0</td>
                            <td id="koin-total-petugas" class="money-col koin-pembagian-col">0</td>
                            <td id="koin-total-ranting" class="money-col koin-pembagian-col">0</td>
                            <td id="koin-total-mwc" class="money-col koin-pembagian-col">0</td>
                            <td id="koin-total-pc" class="money-col koin-pembagian-col">0</td>
                            <td id="koin-total-aksi" style="display: none;"></td>
                        </tr>
                    </tfoot>
                </table>
                
                <div id="koin-ttd-date" style="text-align: right; margin-bottom: 15px; display: none;"> Ngablak, <span id="koin-ttd-tanggal-output"></span></div>
                <div id="koin-ttd-area" class="ttd-area"> 
                    <div class="ttd-box"><p>Mengetahui,</p><p>Ketua UPZIS</p><div class="ttd-line"></div><p>(Nama Ketua)</p></div>
                    <div class="ttd-box"><p>Dibuat oleh,</p><p>Bendahara UPZIS</p><div class="ttd-line"></div><p>(Nama Bendahara)</p></div>
                </div>

            </div>
            <div class="form-controls" id="koin-admin-controls" style="display: none; margin-top: 20px;">
                <button class="button btn-red" onclick="deleteAllDataGlobal('koin')">Hapus Semua Data</button> 
                <button class="button btn-blue" onclick="logout()">Log Out</button> 
            </div>
            <div class="input-form" id="koin-input-area" style="display: none;">
                <h3>Input Data Pemasukan Baru (KOIN NU)</h3>
                <div class="form-row">
                    <div><label for="koin-input-tanggal">Tanggal:</label><input type="date" id="koin-input-tanggal" required></div>
                    <div><label for="koin-input-petugas">Nama Petugas:</label><input type="text" id="koin-input-petugas" required></div>
                    <div><label for="koin-input-hp">No. HP Petugas:</label><input type="tel" id="koin-input-hp" required></div>
                </div>
                <div class="form-row">
                    <div><label for="koin-input-donatur">Donatur/Kelompok:</label><input type="text" id="koin-input-donatur" required></div>
                    <div><label for="koin-input-alamat">Alamat (RT/RW):</label><input type="text" id="koin-input-alamat" required></div>
                    <div><label for="koin-input-nominal">Nominal:</label><input type="number" id="koin-input-nominal" required></div>
                </div>
                <button class="button btn-green" onclick="saveData('koin')">Simpan Data</button>
                <div style="clear: both;"></div> 
            </div>
        </div>
        <div id="jurnal-umum-module" style="display: none;">
             <div id="jurnal-pdf-content">
                <div style="text-align: center; margin-bottom: 10px; padding-bottom: 10px; border-bottom: 3px double #006400;">
                    <h1 style="color: #006400; margin: 0; line-height: 1.2; font-size: 24px;">NU CARE UPZIS - LAZISNU RANTING NGABLAK</h1>
                    <p style="margin: 0; font-size: 14px; color: #555;">Sekretariat: Jalan [Nama Jalan], Desa Ngablak, Kec. [Kecamatan], Kab. [Kabupaten]</p>
                </div>

                <div class="report-header-section">
                    <div class="report-controls">
                        <label for="jurnal-filter-bulan">Bulan:</label>
                        <select id="jurnal-filter-bulan" onchange="filterData('jurnal')"></select>
                        <label for="jurnal-filter-tahun">Tahun:</label>
                        <select id="jurnal-filter-tahun" onchange="filterData('jurnal')"></select>
                    </div>
                    
                    <div class="report-title-center">
                        <p style="font-weight: bold; margin: 0;">Jurnal Umum Periode <span id="jurnal-pdf-periode-display"></span></p>
                    </div>

                    <div class="report-controls">
                        <button class="button btn-red" id="jurnal-download-btn-header" onclick="downloadPDF('jurnal')">Unduh PDF</button>
                    </div>
                </div>

                <table id="jurnal-data-table">
                    <thead>
                        <tr>
                            <th>NO</th>
                            <th>TANGGAL</th>
                            <th>KETERANGAN</th>
                            <th>KATEGORI</th>
                            <th class="money-col">DANA MASUK</th> 
                            <th class="money-col">DANA KELUAR</th> 
                            <th class="money-col">SALDO</th> 
                            <th id="jurnal-aksi-header" style="display: none;">Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="jurnal-data-body"></tbody>
                    <tfoot>
                        <tr>
                            <td colspan="4" class="total-label" id="jurnal-total-label">TOTAL</td>
                            <td id="jurnal-total-masuk" class="money-col">0</td>
                            <td id="jurnal-total-keluar" class="money-col">0</td>
                            <td id="jurnal-saldo-akhir" class="total-saldo money-col">0</td>
                            <td id="jurnal-total-aksi" style="display: none;"></td>
                        </tr>
                    </tfoot>
                </table>

                <div id="jurnal-ttd-date" style="text-align: right; margin-bottom: 15px; display: none;"> Ngablak, <span id="jurnal-ttd-tanggal-output"></span></div>
                <div id="jurnal-ttd-area" class="ttd-area"> 
                    <div class="ttd-box"><p>Mengetahui,</p><p>Ketua UPZIS</p><div class="ttd-line"></div><p>(Nama Ketua)</p></div>
                    <div class="ttd-box"><p>Dibuat oleh,</p><p>Bendahara UPZIS</p><div class="ttd-line"></div><p>(Nama Bendahara)</p></div>
                </div>
            </div>

            <div class="form-controls" id="jurnal-admin-controls" style="display: none; margin-top: 20px;">
                <button class="button btn-red" onclick="deleteAllDataGlobal('jurnal')">Hapus Semua Data</button> 
                <button class="button btn-blue" onclick="logout()">Log Out</button> 
            </div>

            <div class="input-form" id="jurnal-input-area" style="display: none;">
                <h3>Input Data Jurnal Umum (Manual)</h3>
                <div class="form-row">
                    <div><label for="jurnal-input-tanggal">Tanggal:</label><input type="date" id="jurnal-input-tanggal" required></div>
                    <div><label for="jurnal-input-keterangan">Keterangan/Uraian:</label><input type="text" id="jurnal-input-keterangan" required></div>
                    <div>
                        <label for="jurnal-input-kategori">Kategori:</label>
                        <select id="jurnal-input-kategori" onchange="updateMasukKeluarFields()" required>
                            <option value="">Pilih Kategori</option>
                            <optgroup label="DANA MASUK">
                                <option value="Koin NU">Koin NU</option>
                                <option value="Donatur">Donatur</option>
                                <option value="Zakat Mall">Zakat Mall</option>
                                <option value="Infaq">Infaq</option>
                                <option value="Shodaqoh">Shodaqoh</option>
                                <option value="Saldo Bulan Lalu">Saldo Bulan Lalu</option>
                                <option value="Hasil Usaha">Hasil Usaha</option>
                            </optgroup>
                            <optgroup label="DANA KELUAR">
                                <option value="Petugas (10%)">Petugas (10%)</option>
                                <option value="MWC (25%)">MWC (25%)</option>
                                <option value="PC (5%)">PC (5%)</option>
                                <option value="Ranting (60%)">Ranting (60%)</option>
                                <option value="Untuk Pendidikan">Untuk Pendidikan</option>
                                <option value="Untuk Sosial">Untuk Sosial</option>
                                <option value="Untuk Ekonomi">Untuk Ekonomi</option>
                                <option value="Untuk Kesehatan">Untuk Kesehatan</option>
                                <option value="Subsidi Banom & Lembaga NU">Subsidi Banom & Lembaga NU</option>
                                <option value="Lain-lain">Lain-lain</option>
                            </optgroup>
                        </select>
                    </div>
                </div>
                <div class="form-row" style="grid-template-columns: repeat(2, 1fr);">
                    <div><label for="jurnal-input-masuk">Dana Masuk:</label><input type="number" id="jurnal-input-masuk" min="0"></div>
                    <div><label for="jurnal-input-keluar">Dana Keluar:</label><input type="number" id="jurnal-input-keluar" min="0"></div>
                </div>
                <button class="button btn-green" onclick="saveData('jurnal')">Simpan Data</button>
                <div style="clear: both;"></div> 
            </div>
        </div>
        <div id="laporan-tahunan-module" style="display: none;">
             <div id="tahunan-pdf-content">
                <div style="text-align: center; margin-bottom: 10px; padding-bottom: 10px; border-bottom: 3px double #006400;">
                    <h1 style="color: #006400; margin: 0; line-height: 1.2; font-size: 24px;">NU CARE UPZIS - LAZISNU RANTING NGABLAK</h1>
                    <p style="margin: 0; font-size: 14px; color: #555;">Sekretariat: Jalan [Nama Jalan], Desa Ngablak, Kec. [Kecamatan], Kab. [Kabupaten]</p>
                </div>

                <div class="report-header-section">
                    <div class="report-controls">
                        <label for="tahunan-filter-tahun">Tahun Laporan:</label>
                        <select id="tahunan-filter-tahun" onchange="filterData('tahunan')"></select>
                    </div>
                    
                    <div class="report-title-center">
                        <p style="font-weight: bold; margin: 0;">Laporan Tahunan Periode <span id="tahunan-pdf-periode-display"></span></p>
                    </div>

                    <div class="report-controls">
                        <button class="button btn-red" id="tahunan-download-btn-header" onclick="downloadPDF('tahunan')">Unduh PDF</button>
                    </div>
                </div>

                <div style="overflow-x: auto;">
                    <table id="annual-data-table">
                        <thead>
                            <tr>
                                <th rowspan="3" style="width: 1%;">NO</th>
                                <th rowspan="3" style="width: 10%;">BULAN & TAHUN</th>
                                <th colspan="2" class="annual-sub-header">PENERIMAAN</th>
                                <th colspan="12" class="annual-sub-header">PENGELUARAN</th>
                            </tr>
                            <tr>
                                <th rowspan="2" class="money-col">Total Penerimaan KOIN</th>
                                <th rowspan="2">Jumlah Donatur (Manual)</th>
                                <th colspan="2">A. Bidang Pendidikan</th>
                                <th colspan="2">B. Bidang Sosial</th>
                                <th colspan="2">C. Bidang Kesehatan</th>
                                <th colspan="2">D. Bidang Ekonomi</th>
                                <th colspan="2">E. Subsidi Banom & Lembaga NU</th>
                                <th colspan="2">F. Lain-Lain</th>
                            </tr>
                            <tr>
                                <th class="money-col">Jml Uang (Auto)</th>
                                <th>Jml Penerima (Manual)</th>
                                <th class="money-col">Jml Uang (Auto)</th>
                                <th>Jml Penerima (Manual)</th>
                                <th class="money-col">Jml Uang (Auto)</th>
                                <th>Jml Penerima (Manual)</th>
                                <th class="money-col">Jml Uang (Auto)</th>
                                <th>Jml Penerima (Manual)</th>
                                <th class="money-col">Jml Uang (Auto)</th>
                                <th>Keterangan (Manual)</th>
                                <th class="money-col">Jml Uang (Manual)</th>
                                <th>Uraian (Manual)</th>
                            </tr>
                        </thead>
                        <tbody id="annual-data-body"></tbody>
                        <tfoot>
                            <tr class="annual-total-row">
                                <td colspan="2" class="total-label" style="text-align: center;">TOTAL TAHUNAN</td>
                                <td id="tahunan-total-koin" class="money-col">0</td>
                                <td id="tahunan-total-donatur" class="money-col">0</td>
                                <td id="tahunan-total-pend-uang" class="money-col">0</td>
                                <td id="tahunan-total-pend-penerima" class="money-col">0</td>
                                <td id="tahunan-total-sosial-uang" class="money-col">0</td>
                                <td id="tahunan-total-sosial-penerima" class="money-col">0</td>
                                <td id="tahunan-total-kes-uang" class="money-col">0</td>
                                <td id="tahunan-total-kes-penerima" class="money-col">0</td>
                                <td id="tahunan-total-eko-uang" class="money-col">0</td>
                                <td id="tahunan-total-eko-penerima" class="money-col">0</td>
                                <td id="tahunan-total-banom-uang" class="money-col">0</td>
                                <td id="tahunan-total-banom-ket" style="text-align: center;">-</td>
                                <td id="tahunan-total-lain-uang" class="money-col">0</td>
                                <td id="tahunan-total-lain-uraian" style="text-align: center;">-</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>

                <div id="tahunan-ttd-date" style="text-align: right; margin-bottom: 15px; display: none;"> Ngablak, <span id="tahunan-ttd-tanggal-output"></span></div>
                <div id="tahunan-ttd-area" class="ttd-area"> 
                    <div class="ttd-box"><p>Mengetahui,</p><p>Ketua UPZIS</p><div class="ttd-line"></div><p>(Nama Ketua)</p></div>
                    <div class="ttd-box"><p>Dibuat oleh,</p><p>Bendahara UPZIS</p><div class="ttd-line"></div><p>(Nama Bendahara)</p></div>
                </div>
            </div>
             
            <div class="form-controls" id="tahunan-admin-controls" style="display: none; justify-content: flex-end;">
                <button class="button btn-blue" onclick="logout()">Log Out</button> 
            </div>
            
            <div class="input-form" id="tahunan-edit-input-area" style="display: none;">
                <h3>Edit Data Laporan Tahunan (Baris Khusus)</h3>
                <div class="form-row" style="grid-template-columns: 1fr 1fr 1fr;">
                    <div><label>Baris yang Diedit:</label><input type="text" id="annual-edit-label" disabled></div>
                    <div><label>Nominal:</label><input type="number" id="annual-edit-nominal" required></div>
                    <div id="annual-edit-keterangan-group" style="display: none;">
                        <label>Keterangan/Uraian:</label>
                        <input type="text" id="annual-edit-keterangan">
                    </div>
                </div>
                <div style="float: right; margin-top: 10px;">
                    <button class="button btn-green" onclick="saveAnnualReportData()">Simpan Perubahan</button>
                    <button class="button btn-red" onclick="cancelAnnualEdit()">Batal</button>
                </div>
                <div style="clear: both;"></div> 
            </div>

        </div>
        <div id="login-area">
            <div class="login-box">
                <h2 style="text-align: center; color: #006400;">ADMIN LOGIN</h2>
                <div class="login-input-row">
                    <input type="text" id="username" placeholder="Username">
                    <input type="password" id="password" placeholder="Password">
                </div>
                <button class="button btn-green" style="width: 100%;" onclick="attemptLogin()">Masuk</button>
            </div>
        </div>
        </div>


    <script>
        // Data Dummy (Simulasi Database)
        let koinData = [
            // Sisa satu entri KOIN NU agar perhitungan bulan berjalan (Nov 2025) ada
            { id: 1, tanggal: '2025-11-26', petugas: 'Shodiq', hp: '0813250089797', donatur: 'RT 01', alamat: 'Ngablak RT 1/ RW 1', nominal: 2000000 },
        ];
        
        // Jurnal Umum Dikosongkan, hanya tersisa Saldo Bulan Lalu (Des 2024) yang akan otomatis jadi Saldo Awal 2025
        let jurnalData = [
            // Contoh Saldo Akhir Desember 2024 (Agar ada data untuk Saldo Bulan Lalu di Jan 2025)
            { id: 300, tanggal: '2024-12-31', keterangan: 'Saldo Akhir Tahun Lalu', kategori: 'Saldo Bulan Lalu', masuk: 5000000, keluar: 0, type: 'manual' },
        ];
        
        // Data Baru untuk Laporan Tahunan
        let annualData = [
            // Saldo Awal 2025
            { type: 'saldo_bank', year: 2025, nominal: 5000000 },
            { type: 'saldo_kas', year: 2025, nominal: 2500000 },
        ];

        let isLoggedIn = false;
        let koinEditId = null;
        let jurnalEditId = null;
        let annualEditData = null; // Menyimpan data yang sedang diedit di Laporan Tahunan
        let currentModule = 'koin';
        
        const namaBulan = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];
        
        // --- Fungsi Utama & Helpers ---

        function init() {
            populateFilterOptions();
            
            const today = new Date();
            const currentMonth = (today.getMonth() + 1).toString();
            const currentYear = today.getFullYear().toString();
            
            document.getElementById('koin-filter-bulan').value = currentMonth;
            document.getElementById('koin-filter-tahun').value = currentYear;
            document.getElementById('jurnal-filter-bulan').value = currentMonth;
            document.getElementById('jurnal-filter-tahun').value = currentYear;
            document.getElementById('tahunan-filter-tahun').value = currentYear;
            
            showModule('koin');
        }
        
        // 1. Format Tanggal Indonesia
        function formatTanggal(isoDate) {
            const date = new Date(isoDate + 'T00:00:00'); 
            if (isNaN(date)) return isoDate;
            const options = { year: 'numeric', month: '2-digit', day: '2-digit' };
            return date.toLocaleDateString('id-ID', options).replace(/\//g, '/');
        }
        
        // 1b. Format Tanggal TTD
        function formatTanggalTTD() {
            const today = new Date();
            const options = { year: 'numeric', month: 'long', day: 'numeric' };
            return today.toLocaleDateString('id-ID', options);
        }

        // 2. Format Rupiah (Tanpa Rp)
        function formatRupiah(number) {
            let num = number === undefined || number === null ? 0 : number;
            let numberString = Math.abs(num).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
            
            // >>> INI LOGIKA UNTUK SALDO MINUS BERWARNA MERAH (BUKAN BARIS MERAH) <<<
            if (num < 0) {
                return `<span style="color: red; font-weight: bold;">(${numberString})</span>`;
            }
            return numberString;
            // >>> AKHIR LOGIKA <<<
        }
        
        // 3. Helper: Mendapatkan tanggal akhir bulan sebelumnya (untuk Saldo Bulan Lalu)
        function getLastDayOfPreviousMonth(currentMonth, currentYear) {
            const m = parseInt(currentMonth);
            const y = parseInt(currentYear);
            const lastDayDate = new Date(y, m - 1, 0); 
            return lastDayDate.toISOString().split('T')[0];
        }

        // 4. Perhitungan Pembagian Dana KOIN NU
        function hitungPembagian(nominal) {
            return {
                petugas: nominal * 0.10, // 10%
                ranting: nominal * 0.60, // 60%
                mwc: nominal * 0.25,     // 25%
                pc: nominal * 0.05 // 5%
            };
        }
        
        // 4b. Hitung Total KOIN NU untuk Jurnal Umum
        function calculateKoinTotals(month, year) {
            const selectedMonth = month.padStart(2, '0');
            const selectedYear = year;
            
            const filteredKoin = koinData.filter(data => {
                const dataDate = new Date(data.tanggal);
                const dataMonth = (dataDate.getMonth() + 1).toString().padStart(2, '0');
                const dataYear = dataDate.getFullYear().toString();
                return dataMonth === selectedMonth && dataYear === selectedYear;
            });

            let totalNominal = filteredKoin.reduce((sum, data) => sum + data.nominal, 0);
            
            const pembagian = hitungPembagian(totalNominal);

            return {
                totalNominal: totalNominal,
                ranting: pembagian.ranting,
                petugas: pembagian.petugas,
                mwc: pembagian.mwc,
                pc: pembagian.pc
            };
        }
        
        // 5. Render Tabel KOIN NU
        function renderKoinTable(filteredData) {
            const tableBody = document.getElementById('koin-data-body');
            tableBody.innerHTML = '';
            
            let total = {
                nominal: 0,
                petugas: 0,
                ranting: 0,
                mwc: 0,
                pc: 0
            };

            filteredData.forEach((data, index) => {
                const pembagian = hitungPembagian(data.nominal);
                
                total.nominal += data.nominal;
                total.petugas += pembagian.petugas;
                total.ranting += pembagian.ranting;
                total.mwc += pembagian.mwc;
                total.pc += pembagian.pc;

                const row = tableBody.insertRow();
                row.innerHTML = `
                    <td style="text-align: center;">${index + 1}</td>
                    <td>${formatTanggal(data.tanggal)}</td>
                    <td>${data.petugas}</td>
                    <td>${data.hp}</td> 
                    <td>${data.donatur}</td>
                    <td>${data.alamat}</td>
                    <td class="money-col">${formatRupiah(data.nominal)}</td> 
                    <td class="money-col koin-pembagian-col">${formatRupiah(pembagian.petugas)}</td>
                    <td class="money-col koin-pembagian-col">${formatRupiah(pembagian.ranting)}</td>
                    <td class="money-col koin-pembagian-col">${formatRupiah(pembagian.mwc)}</td>
                    <td class="money-col koin-pembagian-col">${formatRupiah(pembagian.pc)}</td>
                    <td class="action-btns" data-id="${data.id}" style="display: ${isLoggedIn ? 'table-cell' : 'none'};">
                        <button class="button btn-blue" onclick="editData('koin', ${data.id})">Edit</button>
                        <button class="button btn-red" onclick="deleteData('koin', ${data.id})">Hapus</button>
                    </td> 
                `;
            });

            document.getElementById('koin-total-nominal').textContent = formatRupiah(total.nominal);
            document.getElementById('koin-total-petugas').textContent = formatRupiah(total.petugas);
            document.getElementById('koin-total-ranting').textContent = formatRupiah(total.ranting);
            document.getElementById('koin-total-mwc').textContent = formatRupiah(total.mwc);
            document.getElementById('koin-total-pc').textContent = formatRupiah(total.pc);

            const totalLabelCell = document.getElementById('koin-total-label');
            totalLabelCell.colSpan = isLoggedIn ? 6 : 7;

            // Atur kolom aksi di header dan footer
            document.getElementById('koin-aksi-header').style.display = isLoggedIn ? 'table-cell' : 'none';
            document.getElementById('koin-total-aksi').style.display = isLoggedIn ? 'table-cell' : 'none';
        }
        
        // 6. Render Tabel Jurnal Umum
        function renderJurnalTable(jurnalAllData, currentMonth, currentYear) {
            const tableBody = document.getElementById('jurnal-data-body');
            tableBody.innerHTML = '';
            
            const selectedMonth = currentMonth.padStart(2, '0');
            const selectedYear = currentYear;

            // 1. Hitung Saldo Bulan Lalu (Untuk Baris Saldo Awal)
            const saldoBulanLaluDate = getLastDayOfPreviousMonth(currentMonth, currentYear);
            const prevMonthData = jurnalAllData.filter(d => {
                const dataDate = new Date(d.tanggal);
                return dataDate.getFullYear() < parseInt(currentYear) || (dataDate.getFullYear() === parseInt(currentYear) && dataDate.getMonth() < parseInt(currentMonth) - 1);
            });

            let initialSaldo = prevMonthData.reduce((sum, d) => sum + d.masuk - d.keluar, 0);
            
            // Cek apakah Saldo Bulan Lalu sudah ada sebagai entri manual
            const existingSaldoEntry = jurnalAllData.find(d => d.kategori === 'Saldo Bulan Lalu' && d.tanggal === saldoBulanLaluDate);

            // Jika ada entri manual Saldo Bulan Lalu, gunakan nilainya, jika tidak, hitung otomatis
            let saldoBulanLaluEntry = existingSaldoEntry ? existingSaldoEntry : {
                id: 'auto-saldo',
                tanggal: saldoBulanLaluDate,
                keterangan: 'SALDO BULAN LALU (Saldo Awal)',
                kategori: 'Saldo Bulan Lalu',
                masuk: initialSaldo > 0 ? initialSaldo : 0,
                keluar: initialSaldo < 0 ? Math.abs(initialSaldo) : 0,
                type: 'saldo'
            };
            
            // Jika Saldo Bulan Lalu ada, gunakan nilainya untuk initialSaldo
            if (saldoBulanLaluEntry.type === 'manual' || saldoBulanLaluEntry.type === 'saldo') {
                initialSaldo = saldoBulanLaluEntry.masuk - saldoBulanLaluEntry.keluar;
            }

            // 2. Filter data Jurnal Manual (selain Saldo Bulan Lalu) di bulan ini
            const filteredJurnal = jurnalAllData.filter(data => {
                const dataDate = new Date(data.tanggal);
                const dataMonth = (dataDate.getMonth() + 1).toString().padStart(2, '0');
                const dataYear = dataDate.getFullYear().toString();
                
                // Hanya entri manual di bulan/tahun yang dipilih dan BUKAN Saldo Bulan Lalu
                return dataMonth === selectedMonth && dataYear === selectedYear && data.kategori !== 'Saldo Bulan Lalu';
            }).sort((a, b) => new Date(a.tanggal) - new Date(b.tanggal));


            // 3. Hitung Total KOIN NU (Pemasukan/Pengeluaran Pembagian)
            const koinTotals = calculateKoinTotals(currentMonth, currentYear);
            let fixedTopEntries = [];

            // Baris 1-4: Transaksi KOIN NU (Otomatis)
            if(koinTotals.totalNominal > 0) {
                // Baris 1: Pemasukan Total KOIN NU (100% dari Donatur)
                fixedTopEntries.push({ id: 'auto-koin-0', tanggal: '', keterangan: 'TOTAL PENJUMLAHAN DARI NOMINAL DONATUR (DARI KOIN NU)', kategori: 'Koin NU', masuk: koinTotals.totalNominal, keluar: 0, type: 'auto' });
                // Baris 2: Pengeluaran Petugas (10%)
                fixedTopEntries.push({ id: 'auto-koin-1', tanggal: '', keterangan: 'Pembagian Petugas KOIN NU', kategori: 'Petugas (10%)', masuk: 0, keluar: koinTotals.petugas, type: 'auto' });
                // Baris 3: Pengeluaran MWC (25%)
                fixedTopEntries.push({ id: 'auto-koin-2', tanggal: '', keterangan: 'Pembagian MWC KOIN NU', kategori: 'MWC (25%)', masuk: 0, keluar: koinTotals.mwc, type: 'auto' });
                // Baris 4: Pengeluaran PC (5%)
                fixedTopEntries.push({ id: 'auto-koin-3', tanggal: '', keterangan: 'Pembagian PC KOIN NU', kategori: 'PC (5%)', masuk: 0, keluar: koinTotals.pc, type: 'auto' });
            }
            
            // Baris 5: Saldo Bulan Lalu (di tempatkan paling atas setelah baris Koin NU)
            saldoBulanLaluEntry.tanggal = saldoBulanLaluDate; // Pastikan tanggal Saldo Bulan Lalu terisi
            fixedTopEntries.push(saldoBulanLaluEntry);


            // Gabungkan Fixed Entries dan Filtered Manual Entries
            let allEntries = fixedTopEntries.concat(filteredJurnal);
            
            // PENTING: Urutkan lagi setelah digabung, karena Saldo Bulan Lalu sudah di-fix di baris ke-5/1
            allEntries.sort((a, b) => {
                // Saldo Bulan Lalu (type: 'saldo' atau kategori: 'Saldo Bulan Lalu') harus selalu paling atas
                if (a.kategori === 'Saldo Bulan Lalu') return -1;
                if (b.kategori === 'Saldo Bulan Lalu') return 1;

                // KOIN NU (type: 'auto') harus di bawah Saldo Bulan Lalu dan di atas Manual
                if (a.type === 'auto' && b.type !== 'auto') return -1;
                if (b.type === 'auto' && a.type !== 'auto') return 1;
                
                // Urutkan berdasarkan tanggal jika keduanya manual
                return new Date(a.tanggal) - new Date(b.tanggal);
            });

            
            // 3. Render Baris Data & Hitung Total
            let runningSaldo = initialSaldo;
            let totalMasuk = 0;
            let totalKeluar = 0;

            allEntries.forEach((data, index) => {
                // Calculate running saldo
                runningSaldo += data.masuk - data.keluar;
                data.runningSaldo = runningSaldo;

                // Calculate total Masuk/Keluar (FIXED: Menggunakan += dan mengecualikan Saldo Bulan Lalu)
                if (data.kategori !== 'Saldo Bulan Lalu') { 
                    totalMasuk += data.masuk; 
                    totalKeluar += data.keluar;
                }

                const isAuto = data.type === 'auto';
                const isSaldoBulanLalu = data.kategori === 'Saldo Bulan Lalu';
                const isManual = data.type === 'manual';
                
                let rowClass = isAuto ? 'auto-entry koin-fixed-entry' : (isSaldoBulanLalu ? 'saldo-entry' : 'manual-entry');
                let actionId = '';

                const displayTanggal = data.tanggal ? formatTanggal(data.tanggal) : '';
                
                if (isManual || isSaldoBulanLalu) {
                    actionId = data.id;
                }
                
                const finalSaldoValue = data.runningSaldo;

                const row = tableBody.insertRow();
                row.innerHTML = `
                    <td style="text-align: center;">${index + 1}</td>
                    <td>${displayTanggal}</td>
                    <td class="${rowClass}">${data.keterangan}</td>
                    <td class="${rowClass}">${data.kategori}</td>
                    <td class="money-col ${rowClass}">${formatRupiah(data.masuk)}</td>
                    <td class="money-col ${rowClass}">${formatRupiah(data.keluar)}</td>
                    <td class="money-col" style="font-weight: bold;">${finalSaldoValue !== undefined ? formatRupiah(finalSaldoValue) : ''}</td>
                    <td class="action-btns" data-id="${actionId}" style="display: ${isLoggedIn ? 'table-cell' : 'none'};">
                    </td>
                `;

                const actionCell = row.querySelector('.action-btns');
                if (isSaldoBulanLalu && isLoggedIn) {
                    // Baris Saldo Bulan Lalu -> Hanya bisa EDIT
                    actionCell.innerHTML = `<button class="button btn-blue" onclick="editData('jurnal', '${data.id}')">Edit Saldo</button>`;
                } else if (isManual && isLoggedIn) {
                    // Baris Manual -> Bisa EDIT dan HAPUS
                    actionCell.innerHTML = `
                        <button class="button btn-blue" onclick="editData('jurnal', ${data.id})">Edit</button>
                        <button class="button btn-red" onclick="deleteData('jurnal', ${data.id})">Hapus</button>
                    `;
                }
                
                // Baris 1-4 (KOIN NU Otomatis) tidak memiliki tombol aksi.
                actionCell.style.display = isLoggedIn ? 'table-cell' : 'none';
            });
            
            // Tampilkan Total di Footer
            document.getElementById('jurnal-total-masuk').textContent = formatRupiah(totalMasuk);
            document.getElementById('jurnal-total-keluar').textContent = formatRupiah(totalKeluar);
            document.getElementById('jurnal-saldo-akhir').textContent = formatRupiah(runningSaldo);
            
            // Atur colspan footer
            const totalLabelCell = document.getElementById('jurnal-total-label');
            totalLabelCell.colSpan = isLoggedIn ? 4 : 5;

            // Atur kolom aksi di header dan footer
            document.getElementById('jurnal-aksi-header').style.display = isLoggedIn ? 'table-cell' : 'none';
            document.getElementById('jurnal-total-aksi').style.display = isLoggedIn ? 'table-cell' : 'none';
        }
        
        // 7. Render Laporan Tahunan
        function renderAnnualReport(currentYear) {
            const tableBody = document.getElementById('annual-data-body');
            tableBody.innerHTML = '';

            const selectedYear = parseInt(currentYear);
            document.getElementById('tahunan-pdf-periode-display').textContent = selectedYear;

            // 1. Filter data Jurnal Umum untuk tahun ini (manual entries only)
            const manualJurnalYearly = jurnalData.filter(d => {
                const dataDate = new Date(d.tanggal);
                return dataDate.getFullYear() === selectedYear;
            });
            
            // 2. Hitung total KOIN NU per bulan
            const koinTotalsMonthly = {};
            for (let m = 1; m <= 12; m++) {
                koinTotalsMonthly[m] = calculateKoinTotals(m.toString(), currentYear);
            }

            // 3. Kumpulkan data untuk Saldo Awal Tahun
            const saldoAwalBankEntry = annualData.find(d => d.type === 'saldo_bank' && d.year === selectedYear);
            const saldoAwalKasEntry = annualData.find(d => d.type === 'saldo_kas' && d.year === selectedYear);

            // Jika data saldo awal belum ada, buat entri dummy
            if (!saldoAwalBankEntry) {
                // Hitung saldo akhir tahun sebelumnya
                const prevYearJurnal = jurnalData.filter(d => new Date(d.tanggal).getFullYear() < selectedYear);
                let initialSaldo = prevYearJurnal.reduce((sum, d) => sum + d.masuk - d.keluar, 0);

                annualData.push({ type: 'saldo_bank', year: selectedYear, nominal: initialSaldo > 0 ? initialSaldo : 0 });
                annualData.push({ type: 'saldo_kas', year: selectedYear, nominal: 0 }); 
            }
            
            const saldoBank = annualData.find(d => d.type === 'saldo_bank' && d.year === selectedYear) || { nominal: 0 };
            const saldoKas = annualData.find(d => d.type === 'saldo_kas' && d.year === selectedYear) || { nominal: 0 };
            
            // 4. Hitung dan tampilkan baris Saldo Awal (Bank & Kas)
            let totalAnnualKoin = 0;
            let totalAnnualDonatur = 0;
            let totalAnnualPendUang = 0;
            let totalAnnualPendPenerima = 0;
            let totalAnnualSosialUang = 0;
            let totalAnnualSosialPenerima = 0;
            let totalAnnualKesUang = 0;
            let totalAnnualKesPenerima = 0;
            let totalAnnualEkoUang = 0;
            let totalAnnualEkoPenerima = 0;
            let totalAnnualBanomUang = 0;
            let totalAnnualLainUang = 0;

            const rowAwalBank = tableBody.insertRow();
            rowAwalBank.className = 'annual-saldo-row';
            rowAawalBank.innerHTML = `
                <td style="text-align: center;">-</td>
                <td style="font-weight: bold;">SALDO AWAL TAHUN (BANK)</td>
                <td class="money-col editable-cell" onclick="editAnnualData('saldo_bank', ${selectedYear}, 'SALDO AWAL TAHUN (BANK)', ${saldoBank.nominal})">${formatRupiah(saldoBank.nominal)}</td>
                <td class="money-col">-</td>
                <td class="money-col">-</td>
                <td class="money-col">-</td>
                <td class="money-col">-</td>
                <td class="money-col">-</td>
                <td class="money-col">-</td>
                <td class="money-col">-</td>
                <td class="money-col">-</td>
                <td class="money-col">-</td>
                <td class="money-col">-</td>
                <td class="money-col">-</td>
                <td class="money-col">-</td>
                <td class="money-col">-</td>
            `;
             const rowAwalKas = tableBody.insertRow();
            rowAwalKas.className = 'annual-saldo-row';
            rowAwalKas.innerHTML = `
                <td style="text-align: center;">-</td>
                <td style="font-weight: bold;">SALDO AWAL TAHUN (KAS)</td>
                <td class="money-col editable-cell" onclick="editAnnualData('saldo_kas', ${selectedYear}, 'SALDO AWAL TAHUN (KAS)', ${saldoKas.nominal})">${formatRupiah(saldoKas.nominal)}</td>
                <td class="money-col">-</td>
                <td class="money-col">-</td>
                <td class="money-col">-</td>
                <td class="money-col">-</td>
                <td class="money-col">-</td>
                <td class="money-col">-</td>
                <td class="money-col">-</td>
                <td class="money-col">-</td>
                <td class="money-col">-</td>
                <td class="money-col">-</td>
                <td class="money-col">-</td>
                <td class="money-col">-</td>
                <td class="money-col">-</td>
            `;

            
            // 5. Loop per Bulan
            for (let i = 0; i < 12; i++) {
                const month = i + 1;
                const monthName = namaBulan[i];
                
                // Data KOIN NU bulan ini
                const koinMonth = koinTotalsMonthly[month];

                // Data Jurnal Manual bulan ini
                const jurnalMonth = manualJurnalYearly.filter(d => {
                    const dataDate = new Date(d.tanggal);
                    return dataDate.getMonth() === i;
                });
                
                // Hitung total manual per kategori
                const getSum = (cat, isMasuk = false) => jurnalMonth
                    .filter(d => d.kategori === cat)
                    .reduce((sum, d) => sum + (isMasuk ? d.masuk : d.keluar), 0);
                
                // --- PENGELUARAN OTOMATIS (DARI PEMBAGIAN KOIN) ---
                const pengeluaranKoinRanting = koinMonth.ranting;
                const pengeluaranKoinPetugas = koinMonth.petugas;
                const pengeluaranKoinMWC = koinMonth.mwc;
                const pengeluaranKoinPC = koinMonth.pc;
                
                // --- PENERIMAAN MANUAL ---
                const totalDonatur = getSum('Donatur', true) + getSum('Zakat Mall', true) + getSum('Infaq', true) + getSum('Shodaqoh', true) + getSum('Hasil Usaha', true);
                
                // --- PENGELUARAN MANUAL (YANG BISA DIEDIT JUMLAH PENERIMA/KETERANGAN) ---
                const jmlPendidikan = getSum('Untuk Pendidikan');
                const jmlSosial = getSum('Untuk Sosial');
                const jmlKesehatan = getSum('Untuk Kesehatan');
                const jmlEkonomi = getSum('Untuk Ekonomi');
                const jmlBanom = getSum('Subsidi Banom & Lembaga NU');
                const jmlLain = getSum('Lain-lain');
                
                // --- MENGAMBIL DATA MANUAL DARI INPUT JURNAL (JML PENERIMA / KETERANGAN) ---
                const getManualData = (category, field) => {
                    const entry = jurnalMonth.find(d => d.kategori === category && d[field] !== undefined);
                    return entry ? entry[field] : (field === 'jumlah_penerima' ? 0 : '-');
                };
                
                // Data manual harus disimpan di annualData jika ingin diedit
                let annualManualData = annualData.find(d => d.type === 'manual_report' && d.year === selectedYear && d.month === month);
                if (!annualManualData) {
                    annualManualData = {
                        type: 'manual_report', 
                        year: selectedYear, 
                        month: month, 
                        jml_pendidikan_penerima: 0, 
                        jml_sosial_penerima: 0, 
                        jml_kesehatan_penerima: 0, 
                        jml_ekonomi_penerima: 0, 
                        ket_banom: '-',
                        uraian_lain: '-'
                    };
                    annualData.push(annualManualData);
                }

                // Baris data per bulan
                const row = tableBody.insertRow();
                row.innerHTML = `
                    <td style="text-align: center;">${month}</td>
                    <td>${monthName} ${selectedYear}</td>
                    <td class="money-col">${formatRupiah(koinMonth.totalNominal)}</td>
                    <td class="money-col">${formatRupiah(totalDonatur)}</td> 

                    <td class="money-col">${formatRupiah(jmlPendidikan)}</td>
                    <td class="money-col annual-manual-input editable-cell" onclick="editAnnualData('jml_pendidikan_penerima', ${selectedYear}, 'Pendidikan - Penerima (${monthName})', ${annualManualData.jml_pendidikan_penerima || 0}, ${month})">${annualManualData.jml_pendidikan_penerima || 0}</td>

                    <td class="money-col">${formatRupiah(jmlSosial)}</td>
                    <td class="money-col annual-manual-input editable-cell" onclick="editAnnualData('jml_sosial_penerima', ${selectedYear}, 'Sosial - Penerima (${monthName})', ${annualManualData.jml_sosial_penerima || 0}, ${month})">${annualManualData.jml_sosial_penerima || 0}</td>

                    <td class="money-col">${formatRupiah(jmlKesehatan)}</td>
                    <td class="money-col annual-manual-input editable-cell" onclick="editAnnualData('jml_kesehatan_penerima', ${selectedYear}, 'Kesehatan - Penerima (${monthName})', ${annualManualData.jml_kesehatan_penerima || 0}, ${month})">${annualManualData.jml_kesehatan_penerima || 0}</td>

                    <td class="money-col">${formatRupiah(jmlEkonomi)}</td>
                    <td class="money-col annual-manual-input editable-cell" onclick="editAnnualData('jml_ekonomi_penerima', ${selectedYear}, 'Ekonomi - Penerima (${monthName})', ${annualManualData.jml_ekonomi_penerima || 0}, ${month})">${annualManualData.jml_ekonomi_penerima || 0}</td>

                    <td class="money-col">${formatRupiah(jmlBanom)}</td>
                    <td class="annual-manual-input editable-cell" onclick="editAnnualData('ket_banom', ${selectedYear}, 'Subsidi Banom - Keterangan (${monthName})', '${annualManualData.ket_banom || '-'}', ${month})">${annualManualData.ket_banom || '-'}</td>

                    <td class="money-col annual-manual-input editable-cell" onclick="editAnnualData('jml_lain_uang', ${selectedYear}, 'Lain-lain - Uang (${monthName})', ${jmlLain}, ${month})">${formatRupiah(jmlLain)}</td>
                    <td class="annual-manual-input editable-cell" onclick="editAnnualData('uraian_lain', ${selectedYear}, 'Lain-lain - Uraian (${monthName})', '${annualManualData.uraian_lain || '-'}', ${month})">${annualManualData.uraian_lain || '-'}</td>
                `;

                // Akumulasi Total
                totalAnnualKoin += koinMonth.totalNominal;
                totalAnnualDonatur += totalDonatur;
                totalAnnualPendUang += jmlPendidikan;
                totalAnnualPendPenerima += (annualManualData.jml_pendidikan_penerima || 0);
                totalAnnualSosialUang += jmlSosial;
                totalAnnualSosialPenerima += (annualManualData.jml_sosial_penerima || 0);
                totalAnnualKesUang += jmlKesehatan;
                totalAnnualKesPenerima += (annualManualData.jml_kesehatan_penerima || 0);
                totalAnnualEkoUang += jmlEkonomi;
                totalAnnualEkoPenerima += (annualManualData.jml_ekonomi_penerima || 0);
                totalAnnualBanomUang += jmlBanom;
                totalAnnualLainUang += jmlLain;
            }

            // Tampilkan Total Tahunan
            document.getElementById('tahunan-total-koin').textContent = formatRupiah(totalAnnualKoin);
            document.getElementById('tahunan-total-donatur').textContent = formatRupiah(totalAnnualDonatur);
            document.getElementById('tahunan-total-pend-uang').textContent = formatRupiah(totalAnnualPendUang);
            document.getElementById('tahunan-total-pend-penerima').textContent = totalAnnualPendPenerima;
            document.getElementById('tahunan-total-sosial-uang').textContent = formatRupiah(totalAnnualSosialUang);
            document.getElementById('tahunan-total-sosial-penerima').textContent = totalAnnualSosialPenerima;
            document.getElementById('tahunan-total-kes-uang').textContent = formatRupiah(totalAnnualKesUang);
            document.getElementById('tahunan-total-kes-penerima').textContent = totalAnnualKesPenerima;
            document.getElementById('tahunan-total-eko-uang').textContent = formatRupiah(totalAnnualEkoUang);
            document.getElementById('tahunan-total-eko-penerima').textContent = totalAnnualEkoPenerima;
            document.getElementById('tahunan-total-banom-uang').textContent = formatRupiah(totalAnnualBanomUang);
            document.getElementById('tahunan-total-lain-uang').textContent = formatRupiah(totalAnnualLainUang);

            // Atur tampilan TTD
            document.getElementById('tahunan-ttd-date').style.display = 'block';
            document.getElementById('tahunan-ttd-tanggal-output').textContent = formatTanggalTTD();
            document.getElementById('tahunan-ttd-area').style.display = 'flex';
        }

        // 8. Save Data (Koin & Jurnal)
        function saveData(moduleName) {
            if (!isLoggedIn) {
                alert('Anda harus login sebagai admin untuk menyimpan data.');
                return;
            }

            if (moduleName === 'koin') {
                const tanggal = document.getElementById('koin-input-tanggal').value;
                const petugas = document.getElementById('koin-input-petugas').value;
                const hp = document.getElementById('koin-input-hp').value;
                const donatur = document.getElementById('koin-input-donatur').value;
                const alamat = document.getElementById('koin-input-alamat').value;
                const nominal = parseInt(document.getElementById('koin-input-nominal').value);

                if (!tanggal || !petugas || !hp || !donatur || !alamat || isNaN(nominal) || nominal <= 0) {
                    alert('Mohon lengkapi semua data dengan benar.');
                    return;
                }

                const newId = koinEditId !== null ? koinEditId : Math.max(0, ...koinData.map(d => d.id)) + 1;
                const newEntry = { id: newId, tanggal, petugas, hp, donatur, alamat, nominal };

                if (koinEditId !== null) {
                    const index = koinData.findIndex(d => d.id === koinEditId);
                    koinData[index] = newEntry;
                    koinEditId = null;
                } else {
                    koinData.push(newEntry);
                }

                alert('Data KOIN NU berhasil disimpan!');
                document.getElementById('koin-input-area').reset; // Clear form, although not a true form element
                filterData('koin');
            } else if (moduleName === 'jurnal') {
                const tanggal = document.getElementById('jurnal-input-tanggal').value;
                const keterangan = document.getElementById('jurnal-input-keterangan').value;
                const kategori = document.getElementById('jurnal-input-kategori').value;
                let masuk = parseInt(document.getElementById('jurnal-input-masuk').value) || 0;
                let keluar = parseInt(document.getElementById('jurnal-input-keluar').value) || 0;

                if (!tanggal || !keterangan || !kategori) {
                    alert('Mohon lengkapi Tanggal, Keterangan, dan Kategori.');
                    return;
                }
                
                if (kategori === 'Saldo Bulan Lalu') {
                    if (masuk > 0 && keluar > 0) {
                        alert('Saldo Awal tidak boleh memiliki Dana Masuk dan Dana Keluar sekaligus. Mohon perbaiki.');
                        return;
                    }
                    if (masuk === 0 && keluar === 0) {
                         alert('Saldo Awal harus memiliki nilai di Dana Masuk atau Dana Keluar.');
                        return;
                    }
                    
                    // Pastikan kategori Saldo Bulan Lalu hanya berlaku untuk baris Saldo Awal Otomatis/Edit
                    if (jurnalEditId === 'auto-saldo') {
                         masuk = Math.max(masuk, 0);
                         keluar = Math.max(keluar, 0);
                         
                         const entryIndex = jurnalData.findIndex(d => d.id === jurnalEditId);
                         if (entryIndex !== -1) {
                            jurnalData[entryIndex].masuk = masuk;
                            jurnalData[entryIndex].keluar = keluar;
                            jurnalData[entryIndex].type = 'manual'; // Ubah type menjadi manual setelah diedit
                            alert('Saldo Awal berhasil diperbarui.');
                            filterData('jurnal');
                            document.getElementById('jurnal-input-area').style.display = 'none';
                            jurnalEditId = null;
                            return;
                         }
                    } else if (jurnalEditId === null) {
                         alert('Anda tidak bisa membuat entri Saldo Bulan Lalu baru secara manual. Hanya Saldo Awal yang bisa diedit.');
                         return;
                    }

                } else if (masuk > 0 && keluar > 0) {
                    alert('Data Jurnal tidak boleh memiliki Dana Masuk dan Dana Keluar sekaligus. Mohon perbaiki.');
                    return;
                }
                
                if (masuk === 0 && keluar === 0) {
                    alert('Nilai Dana Masuk atau Dana Keluar harus diisi (tidak boleh nol semua).');
                    return;
                }

                const newId = jurnalEditId !== null ? jurnalEditId : Math.max(0, ...jurnalData.map(d => d.id)) + 1;
                const newEntry = { id: newId, tanggal, keterangan, kategori, masuk, keluar, type: 'manual' };

                if (jurnalEditId !== null) {
                    const index = jurnalData.findIndex(d => d.id === jurnalEditId);
                    jurnalData[index] = newEntry;
                    jurnalEditId = null;
                } else {
                    jurnalData.push(newEntry);
                }

                alert('Data Jurnal Umum berhasil disimpan!');
                filterData('jurnal');
                document.getElementById('jurnal-input-area').style.display = 'none';
            }
        }
        
        // 9. Edit Data (Koin & Jurnal)
        function editData(moduleName, id) {
             if (!isLoggedIn) return;

             if (moduleName === 'koin') {
                const data = koinData.find(d => d.id === id);
                if (!data) return;

                koinEditId = id;
                document.getElementById('koin-input-tanggal').value = data.tanggal;
                document.getElementById('koin-input-petugas').value = data.petugas;
                document.getElementById('koin-input-hp').value = data.hp;
                document.getElementById('koin-input-donatur').value = data.donatur;
                document.getElementById('koin-input-alamat').value = data.alamat;
                document.getElementById('koin-input-nominal').value = data.nominal;
                document.getElementById('koin-input-area').style.display = 'block';
                document.getElementById('koin-input-area').scrollIntoView({ behavior: 'smooth' });

             } else if (moduleName === 'jurnal') {
                const data = jurnalData.find(d => d.id === id);
                if (!data) return;

                jurnalEditId = id;
                document.getElementById('jurnal-input-tanggal').value = data.tanggal;
                document.getElementById('jurnal-input-keterangan').value = data.keterangan;
                document.getElementById('jurnal-input-kategori').value = data.kategori;
                document.getElementById('jurnal-input-masuk').value = data.masuk;
                document.getElementById('jurnal-input-keluar').value = data.keluar;

                // Handle Saldo Bulan Lalu (hanya boleh edit masuk/keluar)
                if (data.kategori === 'Saldo Bulan Lalu') {
                    document.getElementById('jurnal-input-kategori').disabled = true;
                } else {
                    document.getElementById('jurnal-input-kategori').disabled = false;
                }

                document.getElementById('jurnal-input-area').style.display = 'block';
                document.getElementById('jurnal-input-area').scrollIntoView({ behavior: 'smooth' });
             }
        }

        // 10. Delete Data (Koin & Jurnal)
        function deleteData(moduleName, id) {
             if (!isLoggedIn) return;

             if (confirm('Yakin ingin menghapus data ini?')) {
                 if (moduleName === 'koin') {
                    koinData = koinData.filter(d => d.id !== id);
                    filterData('koin');
                    alert('Data KOIN NU berhasil dihapus.');
                 } else if (moduleName === 'jurnal') {
                    jurnalData = jurnalData.filter(d => d.id !== id);
                    filterData('jurnal');
                    alert('Data Jurnal Umum berhasil dihapus.');
                 }
             }
        }
        
        // 11. Login Function (UPDATED)
        function attemptLogin() {
            const usernameInput = document.getElementById('username').value;
            const passwordInput = document.getElementById('password').value;

            // Kredensial Login BARU:
            const adminUser = 'upzis'; // <--- USERNAME BARU
            const adminPass = 'ngablak2025'; // <--- PASSWORD BARU

            if (usernameInput === adminUser && passwordInput === adminPass) {
                isLoggedIn = true;
                document.getElementById('login-area').style.display = 'none';
                
                // Tampilkan menu dan kontrol admin untuk modul yang sedang aktif
                showModule(currentModule); 
                alert('Login Berhasil! Selamat datang, Admin.');
            } else {
                alert('Login Gagal! Username atau Password salah.');
            }
        }

        // 12. Logout
        function logout() {
            isLoggedIn = false;
            document.getElementById('login-area').style.display = 'block';
            
            // Sembunyikan semua kontrol admin
            document.getElementById('koin-admin-controls').style.display = 'none';
            document.getElementById('koin-input-area').style.display = 'none';
            document.getElementById('jurnal-admin-controls').style.display = 'none';
            document.getElementById('jurnal-input-area').style.display = 'none';
            document.getElementById('tahunan-admin-controls').style.display = 'none';
            
            // Render ulang untuk menyembunyikan kolom aksi
            filterData(currentModule); 
            alert('Anda telah berhasil Logout.');
        }

        // 13. Tampilkan Modul yang Dipilih
        function showModule(moduleName) {
            currentModule = moduleName;
            document.getElementById('koin-nu-module').style.display = 'none';
            document.getElementById('jurnal-umum-module').style.display = 'none';
            document.getElementById('laporan-tahunan-module').style.display = 'none';
            
            document.getElementById('nav-koin').classList.remove('active');
            document.getElementById('nav-jurnal').classList.remove('active');
            document.getElementById('nav-tahunan').classList.remove('active');

            if (moduleName === 'koin') {
                document.getElementById('koin-nu-module').style.display = 'block';
                document.getElementById('nav-koin').classList.add('active');
            } else if (moduleName === 'jurnal') {
                document.getElementById('jurnal-umum-module').style.display = 'block';
                document.getElementById('nav-jurnal').classList.add('active');
            } else if (moduleName === 'tahunan') {
                document.getElementById('laporan-tahunan-module').style.display = 'block';
                document.getElementById('nav-tahunan').classList.add('active');
            }
            
            filterData(moduleName); 
            
            // Tampilkan/Sembunyikan kontrol admin
            if (isLoggedIn) {
                 document.getElementById('koin-admin-controls').style.display = (moduleName === 'koin') ? 'flex' : 'none';
                 document.getElementById('jurnal-admin-controls').style.display = (moduleName === 'jurnal') ? 'flex' : 'none';
                 document.getElementById('tahunan-admin-controls').style.display = (moduleName === 'tahunan') ? 'flex' : 'none';
            } else {
                 document.getElementById('koin-admin-controls').style.display = 'none';
                 document.getElementById('jurnal-admin-controls').style.display = 'none';
                 document.getElementById('tahunan-admin-controls').style.display = 'none';
            }
        }

        // 14. Filter Data (Koin, Jurnal, Tahunan)
        function filterData(moduleName) {
            if (moduleName === 'koin') {
                const selectedMonth = document.getElementById('koin-filter-bulan').value;
                const selectedYear = document.getElementById('koin-filter-tahun').value;
                const filteredData = koinData.filter(data => {
                    const dataDate = new Date(data.tanggal);
                    const dataMonth = (dataDate.getMonth() + 1).toString();
                    const dataYear = dataDate.getFullYear().toString();
                    return dataMonth === selectedMonth && dataYear === selectedYear;
                });

                document.getElementById('koin-pdf-periode-display').textContent = `${namaBulan[parseInt(selectedMonth) - 1]} ${selectedYear}`;
                renderKoinTable(filteredData);
                
                 // Atur tampilan TTD
                document.getElementById('koin-ttd-date').style.display = 'block';
                document.getElementById('koin-ttd-tanggal-output').textContent = formatTanggalTTD();
                document.getElementById('koin-ttd-area').style.display = 'flex';

            } else if (moduleName === 'jurnal') {
                const selectedMonth = document.getElementById('jurnal-filter-bulan').value;
                const selectedYear = document.getElementById('jurnal-filter-tahun').value;
                
                document.getElementById('jurnal-pdf-periode-display').textContent = `${namaBulan[parseInt(selectedMonth) - 1]} ${selectedYear}`;
                renderJurnalTable(jurnalData, selectedMonth, selectedYear);
                
                // Atur tampilan TTD
                document.getElementById('jurnal-ttd-date').style.display = 'block';
                document.getElementById('jurnal-ttd-tanggal-output').textContent = formatTanggalTTD();
                document.getElementById('jurnal-ttd-area').style.display = 'flex';
                
            } else if (moduleName === 'tahunan') {
                const selectedYear = document.getElementById('tahunan-filter-tahun').value;
                renderAnnualReport(selectedYear);
            }
        }

        // 15. Download PDF
        function downloadPDF(moduleName) {
            const contentId = `${moduleName}-pdf-content`;
            const content = document.getElementById(contentId);

            // Sembunyikan elemen yang tidak perlu di PDF
            const isKoin = moduleName === 'koin';
            const koinPembagianCols = document.querySelectorAll('.koin-pembagian-col');
            const koinPembagianHeaders = document.querySelectorAll('.koin-pembagian-header');
            
            koinPembagianCols.forEach(el => el.style.display = isKoin ? 'table-cell' : 'none');
            koinPembagianHeaders.forEach(el => el.style.display = isKoin ? 'table-cell' : 'none');
            
            // Sembunyikan kolom aksi
            const actionCells = content.querySelectorAll('.action-btns');
            actionCells.forEach(cell => cell.style.display = 'none');
            const actionHeaders = content.querySelectorAll(`#${moduleName}-aksi-header`);
            actionHeaders.forEach(header => header.style.display = 'none');

            html2canvas(content, { 
                scale: 2, 
                useCORS: true, 
                allowTaint: true 
            }).then(canvas => {
                const imgData = canvas.toDataURL('image/png');
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('l', 'mm', 'a4'); // 'l' for landscape, 'a4' size
                const imgWidth = 297; // A4 landscape width in mm
                const pageHeight = 210; // A4 landscape height in mm
                const imgHeight = canvas.height * imgWidth / canvas.width;
                let heightLeft = imgHeight;
                let position = 0;

                pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                heightLeft -= pageHeight;

                while (heightLeft >= 0) {
                    position = heightLeft - imgHeight;
                    pdf.addPage();
                    pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;
                }

                pdf.save(`${moduleName}_laporan_${document.getElementById(`${moduleName}-pdf-periode-display`).textContent.replace(/\s/g, '_')}.pdf`);
                
                // Kembalikan tampilan setelah download
                actionCells.forEach(cell => cell.style.display = isLoggedIn ? 'table-cell' : 'none');
                actionHeaders.forEach(header => header.style.display = isLoggedIn ? 'table-cell' : 'none');
                
                koinPembagianCols.forEach(el => el.style.display = 'table-cell');
                koinPembagianHeaders.forEach(el => el.style.display = 'table-cell');
                
            });
        }
        
        // 16. Edit Data Tahunan
        function editAnnualData(type, year, label, currentValue, month = null) {
            if (!isLoggedIn) {
                alert('Anda harus login sebagai admin untuk mengedit data.');
                return;
            }

            // Simpan data yang akan diedit
            annualEditData = { type, year, month };

            // Tampilkan form edit
            const editArea = document.getElementById('tahunan-edit-input-area');
            document.getElementById('annual-edit-label').value = label;

            const nominalInput = document.getElementById('annual-edit-nominal');
            const ketGroup = document.getElementById('annual-edit-keterangan-group');
            const ketInput = document.getElementById('annual-edit-keterangan');

            // Cek apakah yang diedit adalah nominal (angka) atau keterangan (teks)
            if (type.includes('penerima') || type.includes('saldo')) {
                // Nominal (Jumlah Penerima atau Saldo Awal)
                nominalInput.type = 'number';
                nominalInput.value = currentValue;
                nominalInput.style.display = 'block';
                ketGroup.style.display = 'none';
            } else if (type.includes('ket_banom') || type.includes('uraian_lain')) {
                // Keterangan/Uraian (Teks)
                nominalInput.style.display = 'none'; // Sembunyikan input nominal
                ketGroup.style.display = 'block';
                ketInput.value = currentValue;
            } else if (type.includes('jml_lain_uang')) {
                // Khusus Lain-lain Uang (edit nominal, bukan penerima)
                nominalInput.type = 'number';
                nominalInput.value = (typeof currentValue === 'string' ? 0 : currentValue);
                nominalInput.style.display = 'block';
                ketGroup.style.display = 'none';
            }

            editArea.style.display = 'block';
            editArea.scrollIntoView({ behavior: 'smooth' });
        }

        // 17. Save Data Tahunan
        function saveAnnualReportData() {
            if (!annualEditData) return;

            const { type, year, month } = annualEditData;
            
            let newValue;
            if (type.includes('ket_banom') || type.includes('uraian_lain')) {
                newValue = document.getElementById('annual-edit-keterangan').value;
            } else {
                newValue = parseInt(document.getElementById('annual-edit-nominal').value);
                if (isNaN(newValue) || newValue < 0) {
                    alert('Nilai harus berupa angka positif.');
                    return;
                }
            }
            
            // 1. Cari data yang akan diupdate
            let targetData = annualData.find(d => d.type === type && d.year === year && d.month === month);

            // Jika tidak ditemukan, cari di data manual bulanan
            if (!targetData) {
                targetData = annualData.find(d => d.type === 'manual_report' && d.year === year && d.month === month);
            }
            
            // 2. Jika masih belum ditemukan (misalnya: saldo awal bank/kas), coba cari lagi
            if (!targetData && (type === 'saldo_bank' || type === 'saldo_kas')) {
                targetData = annualData.find(d => d.type === type && d.year === year);
            }

            if (!targetData) {
                alert('Terjadi kesalahan: Data tidak ditemukan untuk diupdate.');
                return;
            }

            // 3. Update nilai
            if (type === 'saldo_bank' || type === 'saldo_kas') {
                 targetData.nominal = newValue;
            } else if (type === 'jml_pendidikan_penerima') {
                targetData.jml_pendidikan_penerima = newValue;
            } else if (type === 'jml_sosial_penerima') {
                targetData.jml_sosial_penerima = newValue;
            } else if (type === 'jml_kesehatan_penerima') {
                targetData.jml_kesehatan_penerima = newValue;
            } else if (type === 'jml_ekonomi_penerima') {
                targetData.jml_ekonomi_penerima = newValue;
            } else if (type === 'ket_banom') {
                targetData.ket_banom = newValue;
            } else if (type === 'uraian_lain') {
                targetData.uraian_lain = newValue;
            } 
            // Khusus untuk Lain-lain Uang, ini harus diupdate di Jurnal Umum, bukan di annualData
            else if (type === 'jml_lain_uang') {
                 // Cari entri jurnal umum 'Lain-lain' di bulan dan tahun yang sama
                 const jurnalEntry = jurnalData.find(d => {
                     const date = new Date(d.tanggal);
                     return d.kategori === 'Lain-lain' && date.getFullYear() === year && (date.getMonth() + 1) === month;
                 });

                 if (jurnalEntry) {
                     jurnalEntry.keluar = newValue; // Update nilai pengeluaran di Jurnal Umum
                 } else {
                     // Jika tidak ada, buat entri baru (opsional, tergantung kebutuhan)
                     alert('Perhatian: Entri Jurnal "Lain-lain" belum ada di bulan ini. Silakan buat entri baru terlebih dahulu melalui Jurnal Umum.');
                     // Jika Anda tetap ingin menyimpan, Anda bisa push entri dummy ke jurnalData, tapi sebaiknya disarankan lewat Jurnal Umum.
                 }
            }


            alert('Data tahunan berhasil disimpan!');
            cancelAnnualEdit();
            filterData('tahunan'); // Re-render the report
        }
        
        // 18. Batal Edit Tahunan
        function cancelAnnualEdit() {
            annualEditData = null;
            document.getElementById('tahunan-edit-input-area').style.display = 'none';
        }

        // 19. Delete All Data (Global)
        function deleteAllDataGlobal(moduleName) {
            if (!isLoggedIn) {
                alert('Anda harus login sebagai admin untuk melakukan aksi ini.');
                return;
            }

            let dataName = (moduleName === 'koin') ? 'KOIN NU' : 'Jurnal Umum';

            if (confirm(`PERINGATAN! Anda yakin ingin MENGHAPUS SEMUA DATA ${dataName}? Aksi ini TIDAK DAPAT DIBATALKAN.`)) {
                 if (moduleName === 'koin') {
                    koinData = [];
                    alert('Semua data KOIN NU telah dihapus.');
                 } else if (moduleName === 'jurnal') {
                    // Hapus semua kecuali satu entri saldo awal tahun lalu (untuk jaga-jaga)
                    jurnalData = jurnalData.filter(d => d.kategori === 'Saldo Bulan Lalu');
                    alert('Semua data Jurnal Umum telah dihapus (kecuali Saldo Awal).');
                 }
                 filterData(moduleName);
            }
        }
        
        // 20. Update Masuk/Keluar Fields berdasarkan Kategori
        function updateMasukKeluarFields() {
            const kategori = document.getElementById('jurnal-input-kategori').value;
            const masukInput = document.getElementById('jurnal-input-masuk');
            const keluarInput = document.getElementById('jurnal-input-keluar');
            
            // Daftar kategori yang pasti MASUK
            const masukCategories = ['Koin NU', 'Donatur', 'Zakat Mall', 'Infaq', 'Shodaqoh', 'Saldo Bulan Lalu', 'Hasil Usaha'];
            // Daftar kategori yang pasti KELUAR
            const keluarCategories = ['Petugas (10%)', 'MWC (25%)', 'PC (5%)', 'Ranting (60%)', 'Untuk Pendidikan', 'Untuk Sosial', 'Untuk Ekonomi', 'Untuk Kesehatan', 'Subsidi Banom & Lembaga NU', 'Lain-lain'];

            // Atur properti berdasarkan kategori yang dipilih
            if (masukCategories.includes(kategori)) {
                masukInput.disabled = false;
                keluarInput.disabled = true;
                keluarInput.value = 0;
            } else if (keluarCategories.includes(kategori)) {
                masukInput.disabled = true;
                masukInput.value = 0;
                keluarInput.disabled = false;
            } else {
                // Jika tidak ada kategori yang dipilih
                masukInput.disabled = false;
                keluarInput.disabled = false;
            }

            // Khusus untuk Saldo Bulan Lalu, beri peringatan
            if (kategori === 'Saldo Bulan Lalu') {
                alert('Perhatian! Kategori "Saldo Bulan Lalu" HANYA ditujukan untuk entri Saldo Awal yang otomatis muncul, atau pengeditan Saldo Awal.');
            }
        }

        // 21. Populate Filter Options
        function populateFilterOptions() {
            const currentYear = new Date().getFullYear();
            const yearRange = 5; // Tampilkan 5 tahun ke belakang dan 5 tahun ke depan

            for (let i = 0; i < 12; i++) {
                const option = new Option(namaBulan[i], (i + 1).toString());
                document.getElementById('koin-filter-bulan').appendChild(option.cloneNode(true));
                document.getElementById('jurnal-filter-bulan').appendChild(option);
            }

            for (let y = currentYear - yearRange; y <= currentYear + yearRange; y++) {
                const option = new Option(y.toString(), y.toString());
                document.getElementById('koin-filter-tahun').appendChild(option.cloneNode(true));
                document.getElementById('jurnal-filter-tahun').appendChild(option.cloneNode(true));
                document.getElementById('tahunan-filter-tahun').appendChild(option);
            }
        }


        // Inisialisasi Aplikasi
        window.onload = init;
    </script>
</body>
</html>
