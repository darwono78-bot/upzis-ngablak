<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Input & Laporan KOIN NU Paling Detail</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        body { font-family: Arial, sans-serif; padding: 0 0 80px 0; background-color: #f8f9fa; margin: 0; }
        h1, h2 { color: #006400; margin: 15px 0 10px 0;}
        
        /* CSS untuk Navbar */
        #main-nav {
            background-color: #006400;
            padding: 10px 20px;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        #main-nav h1 {
            color: white;
            font-size: 18px;
            margin: 0;
            flex-shrink: 0;
        }
        #nav-menu {
            display: flex;
            list-style: none;
            padding: 0;
            margin: 0;
        }
        #nav-menu li {
            margin-left: 20px;
        }
        #nav-menu button {
            background: none;
            border: none;
            color: white;
            padding: 8px 15px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            border-radius: 4px;
            transition: background-color 0.3s;
        }
        #nav-menu button.active {
            background-color: #4CAF50;
        }
        #nav-menu button:hover {
            background-color: #004d00;
        }

        /* Kontainer Utama Laporan */
        #report-container {
            padding: 20px;
        }

        /* Kontainer Modul */
        .module-section {
            padding: 15px 0;
        }
        
        /* === NEW: TABLE SCROLL WRAPPER === */
        .table-scroll-wrapper {
            width: 100%;
            overflow-x: auto; /* Enable horizontal scrolling */
            margin-bottom: 20px;
        }
        
        /* Tabel Styles */
        table { 
            width: 100%; 
            border-collapse: collapse; 
            min-width: 1000px; 
            background-color: white; 
            font-size: 11px; 
            table-layout: auto; /* Memungkinkan kolom menyesuaikan lebar konten */
        } 
        /* Modul 3 perlu lebih lebar minimum */
        #tabel-modul-3 {
            min-width: 2500px; /* Lebar Minimum diperbesar */
        }
        
        /* Style Kolom Uang agar memiliki minimum width */
        .col-nominal {
            min-width: 100px; /* Lebar minimum untuk nominal uang di M1A/M2 */
        }
        .col-aksi {
            width: 40px; /* Tetapkan lebar tetap untuk kolom aksi */
        }
        
        /* Override untuk Operasional M1 (tetap 70px agar seragam dengan Jml Uang sosial M1) */
        #tabel-modul-1 th:nth-child(16), #tabel-modul-1 td:nth-child(16),
        #tabel-modul-1 th:nth-child(17), #tabel-modul-1 td:nth-child(17),
        #tabel-modul-1 th:nth-child(18), #tabel-modul-1 td:nth-child(18),
        #tabel-modul-1 th:nth-child(19), #tabel-modul-1 td:nth-child(19) {
            min-width: 70px !important; 
        }
        /* ====================================================================================== */
        
        /* === FIX BARU: Lebar Kolom Jml Pnm di Modul 1 & Modul 3 agar tidak terlalu sempit (60px) === */
        /* Kolom 5, 7, 9, 11, 13, 15 adalah kolom 'Jml Pnm' (untuk M1) */
        #tabel-modul-1 th:nth-child(5), #tabel-modul-1 td:nth-child(5),
        #tabel-modul-1 th:nth-child(7), #tabel-modul-1 td:nth-child(7),
        #tabel-modul-1 th:nth-child(9), #tabel-modul-1 td:nth-child(9),
        #tabel-modul-1 th:nth-child(11), #tabel-modul-1 td:nth-child(11),
        #tabel-modul-1 th:nth-child(13), #tabel-modul-1 td:nth-child(13),
        #tabel-modul-1 th:nth-child(15), #tabel-modul-1 td:nth-child(15),
        /* Modul 3: Kolom 6, 8, 10, 12, 14, 16 (Jml Pnm) */
        #tabel-modul-3 th:nth-child(6), #tabel-modul-3 td:nth-child(6),
        #tabel-modul-3 th:nth-child(8), #tabel-modul-3 td:nth-child(8),
        #tabel-modul-3 th:nth-child(10), #tabel-modul-3 td:nth-child(10),
        #tabel-modul-3 th:nth-child(12), #tabel-modul-3 td:nth-child(12),
        #tabel-modul-3 th:nth-child(14), #tabel-modul-3 td:nth-child(14),
        #tabel-modul-3 th:nth-child(16), #tabel-modul-3 td:nth-child(16) {
            min-width: 60px !important; 
            width: 60px !important; 
        }
        /* ====================================================================================== */

        /* === PERBAIKAN UTAMA: Samakan lebar semua kolom uang di Modul 3 menjadi 70px === */
        #tabel-modul-3 th:nth-child(3), #tabel-modul-3 td:nth-child(3), /* Total Koin (3) */
        #tabel-modul-3 th:nth-child(5), #tabel-modul-3 td:nth-child(5), /* Jml Uang Pendidikan */
        #tabel-modul-3 th:nth-child(7), #tabel-modul-3 td:nth-child(7), /* Jml Uang Kesehatan */
        #tabel-modul-3 th:nth-child(9), #tabel-modul-3 td:nth-child(9), /* Jml Uang Ekonomi */
        #tabel-modul-3 th:nth-child(11), #tabel-modul-3 td:nth-child(11), /* Jml Uang Sosum */
        #tabel-modul-3 th:nth-child(13), #tabel-modul-3 td:nth-child(13), /* Jml Uang Banom */
        #tabel-modul-3 th:nth-child(15), #tabel-modul-3 td:nth-child(15), /* Jml Uang Bencana */
        #tabel-modul-3 th:nth-child(17), #tabel-modul-3 td:nth-child(17), /* Rapat */
        #tabel-modul-3 th:nth-child(18), #tabel-modul-3 td:nth-child(18), /* PERWTN MLU */
        #tabel-modul-3 th:nth-child(19), #tabel-modul-3 td:nth-child(19), /* BIAYA REK BANK */
        #tabel-modul-3 th:nth-child(20), #tabel-modul-3 td:nth-child(20), /* Lain - Lain */
        /* START: NEW HONOR WAJIB (3 COLUMNS) & SHIFTED FINAL COLUMNS */
        #tabel-modul-3 th:nth-child(21), #tabel-modul-3 td:nth-child(21), /* Honor Petugas (10%) */
        #tabel-modul-3 th:nth-child(22), #tabel-modul-3 td:nth-child(22), /* Honor MWC (25%) */
        #tabel-modul-3 th:nth-child(23), #tabel-modul-3 td:nth-child(23), /* Honor PC (5%) */
        #tabel-modul-3 th:nth-child(24), #tabel-modul-3 td:nth-child(24), /* JML Pengeluaran (7) */
        #tabel-modul-3 th:nth-child(25), #tabel-modul-3 td:nth-child(25), /* SALDO AKHIR */
        #tabel-modul-3 th:nth-child(26), #tabel-modul-3 td:nth-child(26)  /* SALDO KAS */
        {
            min-width: 70px !important; 
            width: 70px !important; 
            box-sizing: border-box;
        }
        /* ====================================================================================== */
        
        /* Overrides untuk kolom-kolom yang tidak boleh terlalu kecil */
        #tabel-modul-2 th:nth-child(3) { min-width: 200px; } /* KETERANGAN */
        #tabel-modul-2 th:nth-child(5), /* DEBIT */
        #tabel-modul-2 th:nth-child(6), /* KREDIT */
        #tabel-modul-2 th:nth-child(7) { /* SALDO */
            min-width: 120px; /* Lebar minimum lebih besar untuk nominal di M2 */
        }

        th, td { border: 1px solid #ddd; padding: 4px 6px; text-align: left; word-wrap: break-word; } 
        th { background-color: #006400; color: white; text-align: center; }
        .text-right { text-align: right; }
        .text-center { text-align: center; }
        .footer-total { background-color: #e6ffe6; font-weight: bold; }
        .koin-nu-header { background-color: #4CAF50 !important; color: white !important; }
        
        /* Input Styles */
        input[type="number"], input[type="text"], input[type="date"], select { 
            width: 90%; 
            padding: 2px; 
            border: 1px solid #ccc; 
            text-align: right; 
            box-sizing: border-box; 
            font-size: 11px; 
            background-color: white;
        }
        .input-form-container { 
            background-color: #e9f5ff; 
            padding: 15px; 
            border-radius: 8px; 
            margin-bottom: 20px;
            border: 1px solid #cceeff;
        }
        .form-row { display: flex; gap: 10px; margin-bottom: 10px; align-items: flex-end; }
        .form-row > div { flex: 1; }
        .form-row label { display: block; font-weight: bold; font-size: 11px; margin-bottom: 3px; }
        .form-row > div.flex-fix { flex: 0 0 120px; } /* Untuk kolom tanggal/nominal yang fix */
        
        /* Teks Input non-angka harus rata kiri */
        #m1a-keterangan-input, #m2-keterangan-input, #m1a-nama-petugas-input, #m1a-donatur-input, #m1a-alamat-input {
            text-align: left !important;
        }

        /* Baris Khusus */
        .auto-transaction-row td { background-color: #ffcccc; font-style: italic; }
        .saldo-awal-row td { background-color: #fffacd; font-weight: bold; } 
        
        /* Style untuk tombol aksi */
        .action-btn { 
            padding: 1px 3px; 
            font-size: 9px; 
            border: none; 
            cursor: pointer; 
            margin: 0; 
            flex-shrink: 0;
        }
        .edit-btn { background-color: #ffc107; color: black; }
        .delete-btn { background-color: #dc3545; color: white; }

        /* Login/Logout Bar (Fixed Bottom) */
        #login-container-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: #343a40; 
            color: white;
            padding: 8px 20px;
            box-shadow: 0 -2px 5px rgba(0,0,0,0.1);
            display: flex;
            justify-content: flex-end; 
            align-items: center;
            box-sizing: border-box;
            z-index: 1000;
        }
        #login-form-content-bar {
            display: flex;
            align-items: center;
        }
        #login-form-content-bar input {
            width: 120px;
            margin: 0 5px;
            padding: 5px;
            font-size: 12px;
            border: 1px solid #6c757d;
            background-color: #495057;
            color: white;
        }
        #login-form-content-bar label {
             font-size: 12px;
             margin-right: 5px;
        }
        #login-form-content-bar button {
            padding: 5px 10px;
            background-color: #28a745;
            color: white;
            border: none;
            cursor: pointer;
            font-size: 12px;
        }
        #login-message-bar {
            color: #ffc107;
            margin-left: 10px;
            font-size: 12px;
            font-weight: bold;
        }
        #logout-form-content-bar {
            display: flex;
            align-items: center;
        }
        #logout-form-content-bar p {
            margin: 0 15px 0 0;
            font-weight: bold;
            color: #28a745;
            font-size: 12px;
        }
        #logout-form-content-bar button {
            padding: 5px 15px; 
            background-color: #dc3545; 
            color: white; 
            border: none; 
            cursor: pointer; 
            font-size: 12px;
        }
    </style>
</head>
<body>
    
    <nav id="main-nav">
        <h1>Sistem Laporan KOIN NU</h1>
        <ul id="nav-menu">
            <li><button id="nav-m1a" onclick="switchModule('modul-1a-section')" class="active">Modul 1A (Penerimaan Detail)</button></li>
            <li><button id="nav-m2" onclick="switchModule('modul-2-section')">Modul 2 (Jurnal Umum)</button></li>
            <li><button id="nav-m3" onclick="switchModule('modul-3-section')">Modul 3 (Laporan Tahunan)</button></li>
            <li><button id="nav-m1" onclick="switchModule('modul-1-section')">Modul 1 (Input Agregat)</button></li>
        </ul>
    </nav>
    
    <div id="report-container">
        
        <div style="display: flex; justify-content: center; align-items: center; margin-bottom: 10px;">
            
            <div style="
                width: 100px; 
                height: 100px; 
                margin-right: 15px; 
                background-image: url('logo-lazisnu.png'); 
                background-size: contain; 
                background-repeat: no-repeat;
                background-position: center; 
                flex-shrink: 0;
            "></div>
            
            <div style="text-align: left;">
                <h2 style="margin: 0; color: #006400; font-size: 22px;">NU CARE UPZIS - LAZISNU RANTING NGABLAK</h2>
                <p style="margin: 0; font-size: 15px; color: #333;">Sekretariat: Jalan [Nama Jalan], Desa Ngablak, Kec. [Kecamatan], Kab. [Kabupaten]</p>
            </div>
            
        </div>
        <hr style="border-top: 3px double #000; margin-top: 0px; margin-bottom: 20px;">

        <div id="modul-1a-section" class="module-section">
            <h2>MODUL 1A: JURNAL PENERIMAAN KOIN NU DETAIL</h2>
            
            <div style="display: flex; gap: 20px; align-items: center; margin-bottom: 15px; padding: 5px; border-left: 5px solid #006400;">
                <div style="flex-shrink: 0; font-weight: bold; color: #006400; font-size: 12px;">Filter:</div>
                <div>
                    <select id="filter-bulan-m1a" onchange="updateFilters(this.id, this.value)"></select>
                </div>
                <div>
                    <select id="filter-tahun-m1a" onchange="updateFilters(this.id, this.value)"></select>
                </div>
            </div>
            
            <div class="table-scroll-wrapper">
                <table id="tabel-modul-1a">
                    <thead>
                        <tr>
                            <th style="width: 30px;">NO</th>
                            <th style="width: 80px;">TANGGAL</th>
                            <th style="min-width: 100px;">NAMA PETUGAS</th>
                            <th style="width: 70px;">NO HP</th>
                            <th style="min-width: 120px;">DONATUR/KELOMPOK</th>
                            <th>ALAMAT (RT/RW)</th>
                            <th class="col-nominal">NOMINAL (100%)</th>
                            <th class="koin-nu-header col-nominal">Petugas (10%)</th>
                            <th class="koin-nu-header col-nominal">MWC (25%)</th>
                            <th class="koin-nu-header col-nominal">PC (5%)</th>
                            <th class="koin-nu-header col-nominal">Ranting (60%)</th>
                            <th id="th-m1a-aksi" class="col-aksi">AKSI</th> 
                        </tr>
                    </thead>
                    <tbody id="m1a-transaction-body">
                        </tbody>
                    <tfoot>
                        <tr>
                            <td colspan="6" class="footer-total text-right">TOTAL PENERIMAAN KOIN NU</td>
                            <td id="m1a-total-nominal" class="footer-total text-right">0</td>
                            <td id="m1a-total-petugas" class="footer-total text-right">0</td>
                            <td id="m1a-total-mwc" class="footer-total text-right">0</td>
                            <td id="m1a-total-pc" class="footer-total text-right">0</td>
                            <td id="m1a-total-ranting" class="footer-total text-right">0</td>
                            <td id="tf-m1a-aksi" class="footer-total text-center">-</td> 
                        </tr>
                    </tfoot>
                </table>
            </div> 
            <div class="admin-only" style="margin-bottom: 15px; border: 1px solid #dc3545; padding: 10px; border-radius: 5px; background-color: #f8d7da;">
                <p style="color: #721c24; font-weight: bold; margin-bottom: 5px;">
                    ⚠️ **PERHATIAN:** Klik tombol ini untuk menghapus **SEMUA** data transaksi yang ada di Modul 1A dan Modul 2. Tindakan ini **TIDAK** dapat dibatalkan.
                </p>
                <button onclick="resetAllData()" style="padding: 5px 15px; background-color: #dc3545; color: white; border: none; cursor: pointer; font-weight: bold;">
                    <span id="reset-button-text">RESET SEMUA DATA TRANSAKSI</span>
                </button>
            </div>

            <div class="input-form-container admin-only">
                <h3 style="margin-top: 0; color: #4CAF50;">Input Transaksi Koin NU</h3>
                <div class="form-row">
                    <div class="flex-fix">
                        <label for="m1a-tanggal-input">Tanggal</label>
                        <input type="date" id="m1a-tanggal-input" style="width: 100%;">
                    </div>
                    <div>
                        <label for="m1a-nama-petugas-input">Nama Petugas</label>
                        <input type="text" id="m1a-nama-petugas-input" style="width: 100%; text-align: left;">
                    </div>
                    <div class="flex-fix">
                        <label for="m1a-no-hp-input">No HP</label>
                        <input type="text" id="m1a-no-hp-input" style="width: 100%; text-align: left;">
                    </div>
                    <div>
                        <label for="m1a-donatur-input">Donatur/Kelompok</label>
                        <input type="text" id="m1a-donatur-input" style="width: 100%; text-align: left;">
                    </div>
                    <div>
                        <label for="m1a-alamat-input">Alamat (RT/RW)</label>
                        <input type="text" id="m1a-alamat-input" style="width: 100%; text-align: left;">
                    </div>
                    <div style="flex: 1.5;">
                        <label for="m1a-nominal-input">NOMINAL Koin NU (100%)</label>
                        <input type="number" id="m1a-nominal-input" value="" min="1" placeholder="Masukkan Nominal">
                    </div>
                </div>
                <button onclick="addKoinNUTransaction()" style="padding: 5px 15px; background-color: #4CAF50; color: white; border: none; cursor: pointer;">+ Tambah Koin NU</button>
                <button onclick="clearKoinNUInputs()" style="padding: 5px 15px; background-color: #f44336; color: white; border: none; cursor: pointer;">Bersihkan Input</button>
            </div>
        </div>

        <div id="modul-2-section" class="module-section" style="display: none;">
            <h2>MODUL 2: JURNAL UMUM (Buku Kas)</h2>
            
            <div style="display: flex; gap: 20px; align-items: center; margin-bottom: 15px; padding: 5px; border-left: 5px solid #006400;">
                <div style="flex-shrink: 0; font-weight: bold; color: #006400; font-size: 12px;">Filter:</div>
                <div>
                    <select id="filter-bulan-m2" onchange="updateFilters(this.id, this.value)"></select>
                </div>
                <div>
                    <select id="filter-tahun-m2" onchange="updateFilters(this.id, this.value)"></select>
                </div>
            </div>
            
            <div class="table-scroll-wrapper">
                <table id="tabel-modul-2">
                    <thead>
                        <tr>
                            <th style="width: 30px;">NO</th>
                            <th style="width: 90px;">TANGGAL</th>
                            <th style="min-width: 200px;">KETERANGAN</th>
                            <th>KATEGORI</th>
                            <th style="min-width: 120px;">DANA MASUK (DEBIT)</th>
                            <th style="min-width: 120px;">DANA KELUAR (KREDIT)</th>
                            <th style="min-width: 120px;">SALDO</th>
                            <th id="th-m2-aksi" class="col-aksi">AKSI</th> 
                        </tr>
                    </thead>
                    <tbody id="m2-transaction-body">
                        <tr>
                            <td colspan="4" class="saldo-awal-row text-right">Saldo Bulan Lalu:</td>
                            <td colspan="2">
                                <div id="m2-saldo-awal-display-container" class="admin-only" style="width: 100%; text-align: right; background-color: #fffacd; font-weight: bold; padding: 0; box-sizing: border-box;">
                                    <input type="number" id="m2-saldo-awal-input" value="15000000" min="0" oninput="recalculateAllReports()" style="width: 100%; text-align: right; background-color: #fffacd; font-weight: bold; padding: 2px;">
                                </div>
                                <div id="m2-saldo-awal-static" class="saldo-awal-row text-right" style="padding: 2px 6px; display: none;">0</div> 
                            </td>
                            <td id="m2-saldo-awal-display" class="saldo-awal-row text-right">0</td>
                            <td id="td-m2-saldo-awal-aksi" class="saldo-awal-row text-center">-</td> 
                        </tr>
                        </tbody>
                    <tfoot>
                        <tr>
                            <td colspan="4" class="footer-total text-right">TOTAL</td>
                            <td id="m2-total-masuk" class="footer-total text-right">0</td>
                            <td id="m2-total-keluar" class="footer-total text-right">0</td>
                            <td id="m2-footer-saldo-total" class="footer-total text-right">0</td>
                            <td id="tf-m2-aksi" class="footer-total text-center">-</td> 
                        </tr>
                    </tfoot>
                </table>
            </div> 
            <div class="admin-only" style="margin-bottom: 15px; border: 1px solid #dc3545; padding: 10px; border-radius: 5px; background-color: #f8d7da;">
                <p style="color: #721c24; font-weight: bold; margin-bottom: 5px;">
                    ⚠️ **PERHATIAN:** Klik tombol ini untuk menghapus **SEMUA** data transaksi yang ada di Modul 1A dan Modul 2. Tindakan ini **TIDAK** dapat dibatalkan.
                </p>
                <button onclick="resetAllData()" style="padding: 5px 15px; background-color: #dc3545; color: white; border: none; cursor: pointer; font-weight: bold;">
                    <span id="reset-button-text-m2">RESET SEMUA DATA TRANSAKSI</span>
                </button>
            </div>


            <div class="input-form-container admin-only">
                <h3 style="margin-top: 0; color: #007bff;">Input Transaksi Lainnya (Non-Koin NU)</h3>
                <div class="form-row">
                    <div class="flex-fix">
                        <label for="m2-tanggal-input">Tanggal</label>
                        <input type="date" id="m2-tanggal-input" style="width: 100%;">
                    </div>
                    <div style="flex: 2;">
                        <label for="m2-keterangan-input">Keterangan</label>
                        <input type="text" id="m2-keterangan-input" style="width: 100%; text-align: left;">
                    </div>
                    <div>
                        <label for="m2-kategori-input">Kategori</label>
                        <select id="m2-kategori-input" style="width: 100%; text-align: left;">
                            <option value="Infaq dan Shodaqoh">Infaq dan Shodaqoh</option>
                            <option value="Zakat">Zakat</option>
                            <option value="Dana Sosial Lain">Dana Sosial Lain</option>
                            <option value="Pendidikan (Lainnya)">Pendidikan (Lainnya)</option>
                            <option value="Kesehatan (Lainnya)">Kesehatan (Lainnya)</option>
                            <option value="Ekonomi (Lainnya)">Ekonomi (Lainnya)</option>
                            <option value="Sosial Umum (Lainnya)">Sosial Umum (Lainnya)</option>
                            <option value="Banom (Lainnya)">Banom (Lainnya)</option>
                            <option value="Bencana (Lainnya)">Bencana (Lainnya)</option>
                            <option value="Rapat (Lainnya)">Rapat (Lainnya)</option>
                            <option value="PERWTN MLU (Lainnya)">PERWTN MLU (Lainnya)</option>
                            <option value="BIAYA REK BANK (Lainnya)">BIAYA REK BANK (Lainnya)</option>
                            <option value="Lain - Lain (Lainnya)">Lain - Lain (Lainnya)</option>
                        </select>
                    </div>
                    <div style="flex: 1;">
                        <label for="m2-debit-input">DANA MASUK (DEBIT)</label>
                        <input type="number" id="m2-debit-input" value="0" min="0" onfocus="if(this.value=='0')this.value=''" onblur="if(this.value=='')this.value='0'">
                    </div>
                    <div style="flex: 1;">
                        <label for="m2-kredit-input">DANA KELUAR (KREDIT)</label>
                        <input type="number" id="m2-kredit-input" value="0" min="0" onfocus="if(this.value=='0')this.value=''" onblur="if(this.value=='')this.value='0'">
                    </div>
                </div>
                <button onclick="addManualTransaction()" style="padding: 5px 15px; background-color: #28a745; color: white; border: none; cursor: pointer;">+ Tambah Transaksi Lain</button>
                <button onclick="clearManualTransactionInputs()" style="padding: 5px 15px; background-color: #dc3545; color: white; border: none; cursor: pointer;">Bersihkan Input</button>
            </div>
        </div>
        
        <div id="modul-3-section" class="module-section" style="display: none;">
            <h2>MODUL 3: TAMPILAN LAPORAN TAHUNAN</h2>
            
            <div style="display: flex; gap: 20px; align-items: center; margin-bottom: 15px; padding: 5px; border-left: 5px solid #006400;">
                <div style="flex-shrink: 0; font-weight: bold; color: #006400; font-size: 12px;">Filter Tahun:</div>
                <div>
                    <select id="filter-tahun-m3" onchange="updateFilters(this.id, this.value)"></select>
                </div>
                <button onclick="exportModul3ToPDF()" style="padding: 5px 10px; background-color: #dc3545; color: white; border: none; cursor: pointer;">Ekspor ke PDF</button>
            </div>

            <div class="table-scroll-wrapper">
                <table id="tabel-modul-3">
                    <thead>
                        <tr>
                            <th rowspan="3" style="width: 30px;">No</th>
                            <th rowspan="3" style="width: 80px;">Bulan</th>
                            <th rowspan="3" class="koin-nu-header col-nominal">Total Koin NU (Ranting 60%)</th>
                            <th colspan="12">Penyaluran Program (Mustahik)</th>
                            <th colspan="4">Biaya Operasional Ranting (60% Koin NU)</th>
                            <th colspan="3" class="koin-nu-header">Honorisasi Wajib (Koin NU)</th>
                            <th rowspan="3" class="col-nominal">JML Pengeluaran (7)</th>
                            <th rowspan="3" class="col-nominal">SALDO AKHIR</th>
                            <th rowspan="3" class="col-nominal">SALDO KAS</th>
                        </tr>
                        <tr>
                            <th colspan="2">Pendidikan</th>
                            <th colspan="2">Kesehatan</th>
                            <th colspan="2">Ekonomi</th>
                            <th colspan="2">Sosial Umum</th>
                            <th colspan="2">Banom</th>
                            <th colspan="2">Bencana</th>

                            <th rowspan="2" class="col-nominal">Rapat</th>
                            <th rowspan="2" class="col-nominal">PERWTN MLU</th>
                            <th rowspan="2" class="col-nominal">BIAYA REK BANK</th>
                            <th rowspan="2" class="col-nominal">Lain - Lain</th>

                            <th class="koin-nu-header col-nominal">Petugas (10%)</th>
                            <th class="koin-nu-header col-nominal">MWC (25%)</th>
                            <th class="koin-nu-header col-nominal">PC (5%)</th>
                        </tr>
                        <tr>
                            <th class="col-nominal">Jml Uang</th>
                            <th>Jml Pnm</th>
                            <th class="col-nominal">Jml Uang</th>
                            <th>Jml Pnm</th>
                            <th class="col-nominal">Jml Uang</th>
                            <th>Jml Pnm</th>
                            <th class="col-nominal">Jml Uang</th>
                            <th>Jml Pnm</th>
                            <th class="col-nominal">Jml Uang</th>
                            <th>Jml Pnm</th>
                            <th class="col-nominal">Jml Uang</th>
                            <th>Jml Pnm</th>
                            
                            <th class="koin-nu-header col-nominal">Uang</th>
                            <th class="koin-nu-header col-nominal">Uang</th>
                            <th class="koin-nu-header col-nominal">Uang</th>
                        </tr>
                    </thead>
                    <tbody id="m3-report-body">
                        </tbody>
                    <tfoot>
                        <tr>
                            <td colspan="2" class="footer-total text-right" style="font-size: 12px;">TOTAL TAHUNAN</td>
                            <td id="m3-total-penerimaan" class="footer-total text-right">0</td>
                            
                            <td id="m3-total-pend-uang" class="footer-total text-right">0</td>
                            <td id="m3-total-pend-pnm" class="footer-total text-center">0</td>
                            
                            <td id="m3-total-kes-uang" class="footer-total text-right">0</td>
                            <td id="m3-total-kes-pnm" class="footer-total text-center">0</td>

                            <td id="m3-total-eko-uang" class="footer-total text-right">0</td>
                            <td id="m3-total-eko-pnm" class="footer-total text-center">0</td>

                            <td id="m3-total-sosum-uang" class="footer-total text-right">0</td>
                            <td id="m3-total-sosum-pnm" class="footer-total text-center">0</td>

                            <td id="m3-total-banom-uang" class="footer-total text-right">0</td>
                            <td id="m3-total-banom-pnm" class="footer-total text-center">0</td>

                            <td id="m3-total-bencana-uang" class="footer-total text-right">0</td>
                            <td id="m3-total-bencana-pnm" class="footer-total text-center">0</td>
                            
                            <td id="m3-total-rapat" class="footer-total text-right">0</td>
                            <td id="m3-total-perwtn" class="footer-total text-right">0</td>
                            <td id="m3-total-bank" class="footer-total text-right">0</td>
                            <td id="m3-total-lain" class="footer-total text-right">0</td>

                            <td id="m3-total-honor-petugas" class="footer-total text-right">0</td>
                            <td id="m3-total-honor-mwc" class="footer-total text-right">0</td>
                            <td id="m3-total-honor-pc" class="footer-total text-right">0</td>

                            <td id="m3-total-pengeluaran" class="footer-total text-right">0</td>
                            <td id="m3-footer-saldo-akhir" class="footer-total text-right">0</td>
                            <td id="m3-footer-saldo-kas" class="footer-total text-right">0</td>
                        </tr>
                    </tfoot>
                </table>
            </div>
            <input type="hidden" id="saldo-bank-awal-input" value="10000000"> 
            <input type="hidden" id="saldo-tunai-awal-input" value="5000000">
        </div>

        <div id="modul-1-section" class="module-section" style="display: none;">
            <h2 class="admin-only">MODUL 1: DATA AGREGAT BULANAN (Input Lama - Untuk Laporan Tahunan)</h2>
            <p class="admin-only" style="color: blue; font-style: italic;">(Data di modul ini hanya digunakan untuk laporan tahunan, tidak terhubung dengan Modul 1A/2)</p>

            <div style="display: flex; gap: 20px; align-items: center; margin-bottom: 15px; padding: 5px; border-left: 5px solid #006400;">
                <div style="flex-shrink: 0; font-weight: bold; color: #006400; font-size: 12px;">Filter Tahun:</div>
                <div>
                    <select id="filter-tahun-m1" onchange="updateFilters(this.id, this.value)"></select>
                </div>
            </div>
            
            <div class="table-scroll-wrapper">
                <table id="tabel-modul-1">
                    <thead>
                        <tr>
                            <th rowspan="3" style="width: 80px;">Bulan</th>
                            <th colspan="2" class="koin-nu-header">Penerimaan ZISWAF/Koin NU</th>
                            <th colspan="12">Penyaluran Program</th>
                            <th colspan="4">Biaya Operasional Ranting (60% Koin NU)</th>
                        </tr>
                        <tr>
                            <th rowspan="2" class="koin-nu-header col-nominal" style="min-width: 90px;">Jml Uang</th>
                            <th rowspan="2" class="koin-nu-header" style="min-width: 60px;">Jml Donatur</th>
                            
                            <th colspan="2">Pendidikan</th>
                            <th colspan="2">Kesehatan</th>
                            <th colspan="2">Ekonomi</th>
                            <th colspan="2">Sosial Umum</th>
                            <th colspan="2">Banom</th>
                            <th colspan="2">Bencana</th>

                            <th rowspan="2" class="col-nominal">Rapat</th>
                            <th rowspan="2" class="col-nominal">PERWTN MLU</th>
                            <th rowspan="2" class="col-nominal">BIAYA REK BANK</th>
                            <th rowspan="2" class="col-nominal">Lain - Lain</th>
                        </tr>
                        <tr>
                            <th class="col-nominal">Jml Uang</th>
                            <th>Jml Pnm</th>
                            <th class="col-nominal">Jml Uang</th>
                            <th>Jml Pnm</th>
                            <th class="col-nominal">Jml Uang</th>
                            <th>Jml Pnm</th>
                            <th class="col-nominal">Jml Uang</th>
                            <th>Jml Pnm</th>
                            <th class="col-nominal">Jml Uang</th>
                            <th>Jml Pnm</th>
                            <th class="col-nominal">Jml Uang</th>
                            <th>Jml Pnm</th>
                        </tr>
                    </thead>
                    <tbody id="m1-input-body">
                        </tbody>
                    <tfoot>
                        <tr>
                            <td class="footer-total text-right" style="font-size: 12px;">TOTAL TAHUNAN</td>
                            <td id="m1-total-penerimaan" class="footer-total text-right">0</td>
                            <td id="m1-total-donatur" class="footer-total text-right">0</td>
                            
                            <td id="m1-total-pend-uang" class="footer-total text-right">0</td>
                            <td id="m1-total-pend-pnm" class="footer-total text-center">0</td>
                            
                            <td id="m1-total-kes-uang" class="footer-total text-right">0</td>
                            <td id="m1-total-kes-pnm" class="footer-total text-center">0</td>

                            <td id="m1-total-eko-uang" class="footer-total text-right">0</td>
                            <td id="m1-total-eko-pnm" class="footer-total text-center">0</td>

                            <td id="m1-total-sosum-uang" class="footer-total text-right">0</td>
                            <td id="m1-total-sosum-pnm" class="footer-total text-center">0</td>

                            <td id="m1-total-banom-uang" class="footer-total text-right">0</td>
                            <td id="m1-total-banom-pnm" class="footer-total text-center">0</td>

                            <td id="m1-total-bencana-uang" class="footer-total text-right">0</td>
                            <td id="m1-total-bencana-pnm" class="footer-total text-center">0</td>
                            
                            <td id="m1-total-rapat" class="footer-total text-right">0</td>
                            <td id="m1-total-perwtn" class="footer-total text-right">0</td>
                            <td id="m1-total-bank" class="footer-total text-right">0</td>
                            <td id="m1-total-lain" class="footer-total text-right">0</td>
                        </tr>
                    </tfoot>
                </table>
            </div>
            <div class="admin-only" style="margin-top: 15px;">
                <button onclick="saveModul1Data()" style="padding: 8px 20px; background-color: #007bff; color: white; border: none; cursor: pointer; font-weight: bold;">Simpan Data Agregat ke Firebase</button>
                <p style="font-size: 11px; margin-top: 5px; color: #6c757d;">(Penting: Tekan ini setelah selesai mengedit data tahunan)</p>
            </div>
        </div>
        
    </div>

    <div id="login-container-bar">
        <div id="logout-form-content-bar" style="display: none;">
            <p>Status: Logged in as <span id="user-email-display"></span></p>
            <button onclick="logout()">LOGOUT</button>
        </div>
        <div id="login-form-content-bar">
            <label for="email-input">Email:</label>
            <input type="text" id="email-input" placeholder="admin@nu.id">
            <label for="password-input">Password:</label>
            <input type="password" id="password-input" placeholder="password">
            <button onclick="login()">LOGIN (Admin)</button>
            <p id="login-message-bar"></p>
        </div>
    </div>

    <script>
        // ===================================
        // --- FIREBASE SETUP ---
        // ===================================

        // Ganti dengan konfigurasi Firebase Anda yang sebenarnya!
        const firebaseConfig = {
            apiKey: "AIzaSyA_8NMmZBaXZ4H6KQt7rHy8G1URR3HLP3A",
            authDomain: "upzis-ngablak.firebaseapp.com",
            projectId: "upzis-ngablak",
            storageBucket: "upzis-ngablak.firebasestorage.app",
            messagingSenderId: "869549648344",
            appId: "1:869549648344:web:a531a37cce3a87bb672aad"
                };
        
        let db;
        let auth;
        let isLoggedIn = false;

        // ===================================
        // --- GLOBAL STATE ---
        // ===================================
        const today = new Date();
        const currentYear = today.getFullYear();
        let currentFilterMonth = 0; // 0 = Semua Bulan
        let currentFilterYear = currentYear;
        
        const months = {
            1: 'Januari', 2: 'Februari', 3: 'Maret', 4: 'April', 
            5: 'Mei', 6: 'Juni', 7: 'Juli', 8: 'Agustus', 
            9: 'September', 10: 'Oktober', 11: 'November', 12: 'Desember'
        };

        // Data Transaksi
        let m1aTransactions = []; // Data Modul 1A (Koin NU Detail)
        let m2ManualTransactions = []; // Data Manual Modul 2 (Non-Koin NU)
        let initialData = []; // Data Modul 1 (Agregat Bulanan)

        // ===================================
        // --- UTILITIES ---
        // ===================================

        function formatNominal(number) {
            if (number === null || isNaN(number)) return '0';
            return new Intl.NumberFormat('id-ID', { minimumFractionDigits: 0 }).format(Math.round(number));
        }

        function parseInput(id) {
            const input = document.getElementById(id);
            if (!input) return 0;
            return parseFloat(input.value) || 0;
        }

        // UTILITY: FUNGSI INI WAJIB: Membuat template 12 bulan (data agregat)
        function createDefaultInitialData(year) {
            return Array.from({ length: 12 }, (_, i) => ({ 
                bulan: months[i + 1], 
                order: i + 1, 
                year: year, 
                // Semua field numerik diset 0, menjamin struktur M1 & M3 ada
                penerimaan: 0, donatur: 0, 
                pendUang: 0, pendPenerima: 0, 
                kesUang: 0, kesPenerima: 0, 
                ekoUang: 0, ekoPenerima: 0, 
                sosumUang: 0, sosumPenerima: 0, 
                banomUang: 0, banomPenerima: 0, 
                bencanaUang: 0, bencanaPenerima: 0, 
                rapat: 0, perwtnMlu: 0, biayaBank: 0, lainLain: 0, 
                // honorWajibPercent digunakan untuk perhitungan di M3
                honorWajibPercent: 0.40, 
                id: null
            }));
        }

        // ===================================
        // --- FIREBASE AUTH & DATA HANDLER ---
        // ===================================
        
        async function loadTransactions() {
            try {
                if (!db) return; // Pastikan Firebase sudah terinisialisasi
                
                // 1. Load Modul 1A Transactions
                const m1aSnapshot = await db.collection('m1aTransactions').get();
                m1aTransactions = m1aSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                // 2. Load Modul 2 Manual Transactions
                const m2ManualSnapshot = await db.collection('m2ManualTransactions').get();
                m2ManualTransactions = m2ManualSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                // 3. Load Modul 1 Agregat Data
                const m1Snapshot = await db.collection('m1Agregat').where('year', '==', currentFilterYear).get();
                const m1LoadedData = m1Snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                // Merge loaded data with default template to ensure 12 months are present
                const defaultData = createDefaultInitialData(currentFilterYear);
                initialData = defaultData.map(defaultMonth => {
                    const loadedMonth = m1LoadedData.find(m => m.order === defaultMonth.order);
                    return loadedMonth ? { ...defaultMonth, ...loadedMonth } : defaultMonth;
                });
                
            } catch (error) {
                console.error("Error loading data:", error);
                alert("Gagal memuat data dari Firebase. Pastikan koneksi dan konfigurasi benar.");
                // Jika gagal, gunakan data dummy/kosong
                initialData = createDefaultInitialData(currentFilterYear); 
            }
        }

        async function saveModul1Data() {
            if (!isLoggedIn) {
                alert("Anda harus login untuk menyimpan data.");
                return;
            }
            if (!db) return;

            const dataToSave = getModul1InputData();
            
            try {
                for (const monthData of dataToSave) {
                    const monthRef = db.collection('m1Agregat').doc(`${monthData.year}-${monthData.order}`);
                    await monthRef.set(monthData, { merge: true }); // Merge agar data lain tidak hilang
                }
                alert("Data Agregat Modul 1 berhasil disimpan!");
                // Setelah simpan, reload data dan update laporan
                await loadTransactions(); 
                recalculateAllReports();
            } catch (error) {
                console.error("Error saving Modul 1 data:", error);
                alert("Gagal menyimpan data Modul 1 ke Firebase.");
            }
        }

        // Fungsi Login
        async function login() {
            const email = document.getElementById('email-input').value;
            const password = document.getElementById('password-input').value;
            const messageBar = document.getElementById('login-message-bar');
            messageBar.textContent = 'Logging in...';

            try {
                const userCredential = await auth.signInWithEmailAndPassword(email, password);
                // AuthStateChanged listener akan handle sisanya
            } catch (error) {
                messageBar.textContent = `Login Gagal: ${error.message}`;
                console.error("Login error:", error);
            }
        }

        // Fungsi Logout
        async function logout() {
            try {
                await auth.signOut();
                // AuthStateChanged listener akan handle sisanya
            } catch (error) {
                console.error("Logout error:", error);
            }
        }

        // Handler utama perubahan status login
        async function handleAuthStateChange(user) {
            const loginBar = document.getElementById('login-form-content-bar');
            const logoutBar = document.getElementById('logout-form-content-bar');
            const adminOnlyElements = document.querySelectorAll('.admin-only');

            if (user) {
                // LOGGED IN
                isLoggedIn = true;
                loginBar.style.display = 'none';
                logoutBar.style.display = 'flex';
                document.getElementById('user-email-display').textContent = user.email;

                adminOnlyElements.forEach(el => el.style.display = 'block');
                document.getElementById('login-message-bar').textContent = '';
                
                await loadTransactions();
            } else {
                // LOGGED OUT
                isLoggedIn = false;
                loginBar.style.display = 'flex';
                logoutBar.style.display = 'none';
                
                adminOnlyElements.forEach(el => el.style.display = 'none');
                
                // FIX PENTING: Saat logout, data numerik di-reset, tapi struktur 12 bulan tetap ada
                m1aTransactions = [];
                m2ManualTransactions = [];
                initialData = createDefaultInitialData(currentFilterYear); 
            }
            
            // Panggil render setelah status login dan data siap
            recalculateAllReports();
            
            // Atur visibilitas Aksi pada semua tabel
            toggleAksiColumnVisibility(isLoggedIn);
        }

        // ===================================
        // --- FILTERING ---
        // ===================================

        function populateFilters() {
            const currentMonth = today.getMonth() + 1;
            const yearOptions = [currentYear - 1, currentYear, currentYear + 1];

            const createOption = (value, text) => `<option value="${value}">${text}</option>`;

            // Populate Month Selects (M1A, M2)
            const monthOptions = [createOption(0, 'Semua Bulan')];
            for (let i = 1; i <= 12; i++) {
                monthOptions.push(createOption(i, months[i]));
            }
            ['m1a', 'm2'].forEach(prefix => {
                const select = document.getElementById(`filter-bulan-${prefix}`);
                if (select) {
                    select.innerHTML = monthOptions.join('');
                    select.value = currentFilterMonth;
                }
            });

            // Populate Year Selects (M1A, M2, M3, M1)
            const yearOptionsHtml = yearOptions.map(year => createOption(year, year)).join('');
            ['m1a', 'm2', 'm3', 'm1'].forEach(prefix => {
                const select = document.getElementById(`filter-tahun-${prefix}`);
                if (select) {
                    select.innerHTML = yearOptionsHtml;
                    select.value = currentFilterYear;
                }
            });
        }

        function syncFilters() {
            const monthSelects = document.querySelectorAll('[id^="filter-bulan-"]');
            const yearSelects = document.querySelectorAll('[id^="filter-tahun-"]');

            monthSelects.forEach(select => select.value = currentFilterMonth);
            yearSelects.forEach(select => select.value = currentFilterYear);
        }

        async function updateFilters(id, value) {
            const val = parseInt(value);
            if (id.includes('bulan')) {
                currentFilterMonth = val;
            } else if (id.includes('tahun')) {
                currentFilterYear = val;
                if (isLoggedIn) {
                    // Jika ganti tahun saat login, panggil ulang loadTransactions
                    await loadTransactions(); 
                } else {
                    // Jika ganti tahun saat logout, update template data
                    initialData = createDefaultInitialData(currentFilterYear);
                }
            }
            
            // Sync all filter dropdowns to the new value
            const targetPrefix = id.includes('bulan') ? 'filter-bulan-' : 'filter-tahun-';
            document.querySelectorAll(`[id^="${targetPrefix}"]`).forEach(select => {
                select.value = val;
            });
            
            recalculateAllReports();
        }

        function getFilteredM1aTransactions() {
            const month = currentFilterMonth;
            const year = currentFilterYear;
            let filtered = m1aTransactions.filter(t => new Date(t.date).getFullYear() === year);
            if (month !== 0) {
                filtered = filtered.filter(t => new Date(t.date).getMonth() === (month - 1));
            }
            return filtered.sort((a, b) => new Date(a.date) - new Date(b.date));
        }

        function getFilteredM2ManualTransactions() {
            const month = currentFilterMonth;
            const year = currentFilterYear;
            let filtered = m2ManualTransactions.filter(t => new Date(t.date).getFullYear() === year);
            if (month !== 0) {
                filtered = filtered.filter(t => new Date(t.date).getMonth() === (month - 1));
            }
            return filtered.sort((a, b) => new Date(a.date) - new Date(b.date));
        }
        
        // ===================================
        // --- MODULE SWITCHING ---
        // ===================================

        function switchModule(moduleID) {
            // Hide all modules
            document.querySelectorAll('.module-section').forEach(section => {
                section.style.display = 'none';
            });
            // Show selected module
            document.getElementById(moduleID).style.display = 'block';

            // Deactivate all nav buttons
            document.querySelectorAll('#nav-menu button').forEach(button => {
                button.classList.remove('active');
            });
            // Activate current nav button
            document.getElementById(`nav-${moduleID.split('-')[1].slice(0, 3)}`).classList.add('active');

            // Force recalculate (just in case)
            recalculateAllReports();
        }

        // ===================================
        // --- MODUL 1A LOGIC: PENERIMAAN DETAIL ---
        // ===================================

        function deleteKoinNUTxn(index) {
            if (!isLoggedIn) return;
            if (confirm(`Yakin ingin menghapus transaksi Koin NU #${index + 1}?`)) {
                // Find the transaction object in the filtered list
                const filteredTx = getFilteredM1aTransactions()[index];
                
                if (filteredTx && filteredTx.id && db) {
                    db.collection('m1aTransactions').doc(filteredTx.id).delete()
                        .then(async () => {
                            await loadTransactions();
                            recalculateAllReports();
                        })
                        .catch(error => alert(`Gagal hapus transaksi: ${error.message}`));
                } else {
                    // Untuk dummy data
                    const originalIndex = m1aTransactions.findIndex(t => t === filteredTx);
                    if (originalIndex > -1) {
                        m1aTransactions.splice(originalIndex, 1);
                        recalculateAllReports();
                    } else {
                        alert("Error: Transaksi tidak ditemukan di data utama.");
                    }
                }
            }
        }

        function editKoinNUTxn(index) {
            if (!isLoggedIn) return;
            const filteredTx = getFilteredM1aTransactions()[index];
            if (!filteredTx) return;

            // Move data to form
            document.getElementById('m1a-tanggal-input').value = filteredTx.date;
            document.getElementById('m1a-nama-petugas-input').value = filteredTx.petugas;
            document.getElementById('m1a-no-hp-input').value = filteredTx.noHp;
            document.getElementById('m1a-donatur-input').value = filteredTx.donatur;
            document.getElementById('m1a-alamat-input').value = filteredTx.alamat;
            document.getElementById('m1a-nominal-input').value = filteredTx.nominal;

            // Delete the old transaction
            if (filteredTx.id && db) {
                db.collection('m1aTransactions').doc(filteredTx.id).delete()
                    .then(async () => {
                        await loadTransactions();
                        recalculateAllReports();
                        alert('Data dipindahkan ke form input. Silakan edit dan klik "Tambah Koin NU" lagi.');
                    })
                    .catch(error => alert(`Gagal menghapus data lama: ${error.message}`));
            } else {
                // Untuk dummy data
                const originalIndex = m1aTransactions.findIndex(t => t === filteredTx);
                if (originalIndex > -1) {
                    m1aTransactions.splice(originalIndex, 1);
                    recalculateAllReports();
                    alert('Data dipindahkan ke form input. Silakan edit dan klik "Tambah Koin NU" lagi.');
                }
            }
        }

        async function addKoinNUTransaction() {
            if (!isLoggedIn) {
                alert("Anda harus login untuk menambah transaksi.");
                return;
            }
            const date = document.getElementById('m1a-tanggal-input').value;
            const petugas = document.getElementById('m1a-nama-petugas-input').value.trim();
            const noHp = document.getElementById('m1a-no-hp-input').value.trim();
            const donatur = document.getElementById('m1a-donatur-input').value.trim();
            const alamat = document.getElementById('m1a-alamat-input').value.trim();
            const nominal = parseFloat(document.getElementById('m1a-nominal-input').value) || 0;

            if (!date || !donatur || nominal <= 0) {
                alert("Tanggal, Donatur, dan Nominal Koin NU (di atas 0) wajib diisi.");
                return;
            }

            const newTx = {
                date: date,
                petugas: petugas,
                noHp: noHp,
                donatur: donatur,
                alamat: alamat,
                nominal: nominal,
                // Perhitungan Otomatis
                honorPetugas: Math.round(nominal * 0.10),
                honorMWC: Math.round(nominal * 0.25),
                honorPC: Math.round(nominal * 0.05),
                ranting: Math.round(nominal * 0.60),
                timestamp: Date.now()
            };

            try {
                const docRef = await db.collection('m1aTransactions').add(newTx);
                newTx.id = docRef.id;
                // Add to local array for immediate display before full reload (optional, but faster UX)
                m1aTransactions.push(newTx); 

                clearKoinNUInputs();
                recalculateAllReports();
            } catch (error) {
                console.error("Error adding transaction:", error);
                alert("Gagal menambahkan transaksi ke Firebase.");
            }
        }

        function clearKoinNUInputs() {
            document.getElementById('m1a-tanggal-input').value = '';
            document.getElementById('m1a-nama-petugas-input').value = '';
            document.getElementById('m1a-no-hp-input').value = '';
            document.getElementById('m1a-donatur-input').value = '';
            document.getElementById('m1a-alamat-input').value = '';
            document.getElementById('m1a-nominal-input').value = '';
        }

        function getKoinNUAggregateData() {
            const filteredTx = getFilteredM1aTransactions();
            const totalNominal = filteredTx.reduce((sum, t) => sum + t.nominal, 0);
            const totalHonorPetugas = filteredTx.reduce((sum, t) => sum + t.honorPetugas, 0);
            const totalHonorMWC = filteredTx.reduce((sum, t) => sum + t.honorMWC, 0);
            const totalHonorPC = filteredTx.reduce((sum, t) => sum + t.honorPC, 0);
            const totalRanting = filteredTx.reduce((sum, t) => sum + t.ranting, 0);

            return { totalNominal, totalHonorPetugas, totalHonorMWC, totalHonorPC, totalRanting, count: filteredTx.length };
        }

        function updatePenerimaanDetail() {
            const tableBody = document.getElementById('m1a-transaction-body');
            tableBody.innerHTML = '';
            
            const filteredTx = getFilteredM1aTransactions();
            let totalNominal = 0, totalPetugas = 0, totalMWC = 0, totalPC = 0, totalRanting = 0;

            filteredTx.forEach((tx, index) => {
                totalNominal += tx.nominal;
                totalPetugas += tx.honorPetugas;
                totalMWC += tx.honorMWC;
                totalPC += tx.honorPC;
                totalRanting += tx.ranting;

                const row = tableBody.insertRow();
                row.innerHTML = `
                    <td class="text-center">${index + 1}</td>
                    <td>${tx.date || '-'}</td>
                    <td>${tx.petugas || '-'}</td>
                    <td>${tx.noHp || '-'}</td>
                    <td>${tx.donatur || '-'}</td>
                    <td>${tx.alamat || '-'}</td>
                    <td class="text-right">${formatNominal(tx.nominal)}</td>
                    <td class="text-right">${formatNominal(tx.honorPetugas)}</td>
                    <td class="text-right">${formatNominal(tx.honorMWC)}</td>
                    <td class="text-right">${formatNominal(tx.honorPC)}</td>
                    <td class="text-right">${formatNominal(tx.ranting)}</td>
                    <td class="col-aksi text-center">
                        <button class="action-btn edit-btn" onclick="editKoinNUTxn(${index})">Edit</button>
                        <button class="action-btn delete-btn" onclick="deleteKoinNUTxn(${index})">Hapus</button>
                    </td>
                `;
            });

            // Update Footer
            document.getElementById('m1a-total-nominal').textContent = formatNominal(totalNominal);
            document.getElementById('m1a-total-petugas').textContent = formatNominal(totalPetugas);
            document.getElementById('m1a-total-mwc').textContent = formatNominal(totalMWC);
            document.getElementById('m1a-total-pc').textContent = formatNominal(totalPC);
            document.getElementById('m1a-total-ranting').textContent = formatNominal(totalRanting);
        }

        // ===================================
        // --- MODUL 2 LOGIC: JURNAL UMUM ---
        // ===================================

        function deleteManualTxn(index) {
            if (!isLoggedIn) return;
            if (confirm(`Yakin ingin menghapus transaksi manual #${index + 1}?`)) {
                const filteredTx = getFilteredM2ManualTransactions()[index];

                if (filteredTx && filteredTx.id && db) {
                    db.collection('m2ManualTransactions').doc(filteredTx.id).delete()
                        .then(async () => {
                            await loadTransactions();
                            recalculateAllReports();
                        })
                        .catch(error => alert(`Gagal hapus transaksi: ${error.message}`));
                } else {
                    const originalIndex = m2ManualTransactions.findIndex(t => t === filteredTx);
                    if (originalIndex > -1) {
                        m2ManualTransactions.splice(originalIndex, 1);
                        recalculateAllReports();
                    } else {
                        alert("Error: Transaksi tidak ditemukan di data utama.");
                    }
                }
            }
        }

        function editManualTxn(index) {
            if (!isLoggedIn) return;
            const filteredTx = getFilteredM2ManualTransactions()[index];
            if (!filteredTx) return;
            
            // Move data to form
            document.getElementById('m2-tanggal-input').value = filteredTx.date;
            document.getElementById('m2-keterangan-input').value = filteredTx.keterangan;
            document.getElementById('m2-kategori-input').value = filteredTx.kategori;
            document.getElementById('m2-debit-input').value = filteredTx.debit;
            document.getElementById('m2-kredit-input').value = filteredTx.kredit;

            // Delete the old transaction
            if (filteredTx.id && db) {
                db.collection('m2ManualTransactions').doc(filteredTx.id).delete()
                    .then(async () => {
                        await loadTransactions();
                        recalculateAllReports();
                        alert('Data dipindahkan ke form input. Silakan edit dan klik "Tambah Transaksi Lain" lagi.');
                    })
                    .catch(error => alert(`Gagal menghapus data lama: ${error.message}`));
            } else {
                const originalIndex = m2ManualTransactions.findIndex(t => t === filteredTx);
                if (originalIndex > -1) {
                    m2ManualTransactions.splice(originalIndex, 1);
                    recalculateAllReports();
                    alert('Data dipindahkan ke form input. Silakan edit dan klik "Tambah Transaksi Lain" lagi.');
                }
            }
        }

        async function addManualTransaction() {
            if (!isLoggedIn) {
                alert("Anda harus login untuk menambah transaksi.");
                return;
            }
            const date = document.getElementById('m2-tanggal-input').value;
            const keterangan = document.getElementById('m2-keterangan-input').value.trim();
            const kategori = document.getElementById('m2-kategori-input').value;
            const debit = parseFloat(document.getElementById('m2-debit-input').value) || 0;
            const kredit = parseFloat(document.getElementById('m2-kredit-input').value) || 0;

            if (!date || !keterangan || (debit <= 0 && kredit <= 0) || (debit > 0 && kredit > 0)) {
                alert("Tanggal, Keterangan, dan salah satu dari DEBIT atau KREDIT (di atas 0) wajib diisi.");
                return;
            }

            const newTx = {
                date: date,
                keterangan: keterangan,
                kategori: kategori,
                debit: debit,
                kredit: kredit,
                isAuto: false,
                timestamp: Date.now()
            };

            try {
                const docRef = await db.collection('m2ManualTransactions').add(newTx);
                newTx.id = docRef.id;
                m2ManualTransactions.push(newTx); 

                clearManualTransactionInputs();
                recalculateAllReports();
            } catch (error) {
                console.error("Error adding manual transaction:", error);
                alert("Gagal menambahkan transaksi manual ke Firebase.");
            }
        }

        function clearManualTransactionInputs() {
            document.getElementById('m2-tanggal-input').value = '';
            document.getElementById('m2-keterangan-input').value = '';
            document.getElementById('m2-kategori-input').value = 'Infaq dan Shodaqoh';
            document.getElementById('m2-debit-input').value = '0';
            document.getElementById('m2-kredit-input').value = '0';
        }

        function updateJurnalUmum() {
            const tableBody = document.getElementById('m2-transaction-body');
            // Kosongkan semua kecuali baris saldo awal (baris 0)
            while (tableBody.rows.length > 1) {
                tableBody.deleteRow(1); 
            }

            const saldoAwal = parseInput('m2-saldo-awal-input');
            let runningSaldo = saldoAwal;
            
            // Update Saldo Awal Display
            document.getElementById('m2-saldo-awal-display').textContent = formatNominal(saldoAwal);
            document.getElementById('m2-saldo-awal-static').textContent = formatNominal(saldoAwal); 

            // 2. Buat Transaksi Otomatis (Auto-Generated Transactions)
            const koinNUData = getKoinNUAggregateData();
            const totalNominalKoin = koinNUData.totalNominal;
            const autoDate = '-'; // Tampil sebagai '-' di tabel

            const autoTransactions = [];
            if (totalNominalKoin > 0) {
                autoTransactions.push({ date: autoDate, keterangan: 'Penerimaan Koin NU (100% dari Modul 1A)', kategori: 'Koin NU (Otomatis)', debit: totalNominalKoin, kredit: 0, isAuto: true, timestamp: 0 });
                autoTransactions.push({ date: autoDate, keterangan: 'Pengeluaran Honor Petugas (10%)', kategori: 'Honor Petugas (Otomatis)', debit: 0, kredit: koinNUData.totalHonorPetugas, isAuto: true, timestamp: 0 });
                autoTransactions.push({ date: autoDate, keterangan: 'Pengeluaran Honor MWC (25%)', kategori: 'Honor MWC (Otomatis)', debit: 0, kredit: koinNUData.totalHonorMWC, isAuto: true, timestamp: 0 });
                autoTransactions.push({ date: autoDate, keterangan: 'Pengeluaran Honor PC (5%)', kategori: 'Honor PC (Otomatis)', debit: 0, kredit: koinNUData.totalHonorPC, isAuto: true, timestamp: 0 });
            }

            // 3. Gabungkan Auto dan Manual Transactions (Sudah terfilter & diurutkan di getFilteredM2ManualTransactions)
            const allTransactions = [...autoTransactions, ...getFilteredM2ManualTransactions()];
            // Urutkan kembali berdasarkan tanggal manual/timestamp (untuk auto transaction)
            allTransactions.sort((a, b) => {
                // Utamakan auto transaction (timestamp 0)
                if (a.isAuto && !b.isAuto) return -1;
                if (!a.isAuto && b.isAuto) return 1;

                if (a.isAuto && b.isAuto) {
                    // Jaga urutan auto transaction
                    return a.keterangan.localeCompare(b.keterangan);
                }
                
                // Urutkan berdasarkan tanggal jika keduanya manual
                return new Date(a.date) - new Date(b.date);
            });
            
            let totalMasuk = 0;
            let totalKeluar = 0;
            
            allTransactions.forEach((tx, index) => {
                runningSaldo = runningSaldo + tx.debit - tx.kredit;
                totalMasuk += tx.debit;
                totalKeluar += tx.kredit;

                const row = tableBody.insertRow();
                if (tx.isAuto) {
                    row.classList.add('auto-transaction-row');
                }

                const actionCell = tx.isAuto ? 
                    `<td class="col-aksi text-center">-</td>` :
                    `<td class="col-aksi text-center">
                        <button class="action-btn edit-btn" onclick="editManualTxn(${index - autoTransactions.length})">Edit</button>
                        <button class="action-btn delete-btn" onclick="deleteManualTxn(${index - autoTransactions.length})">Hapus</button>
                    </td>`;
                
                row.innerHTML = `
                    <td class="text-center">${index + 1}</td>
                    <td>${tx.date || '-'}</td>
                    <td>${tx.keterangan || '-'}</td>
                    <td>${tx.kategori || '-'}</td>
                    <td class="text-right">${formatNominal(tx.debit)}</td>
                    <td class="text-right">${formatNominal(tx.kredit)}</td>
                    <td class="text-right">${formatNominal(runningSaldo)}</td>
                    ${actionCell}
                `;
            });

            // Update Footer
            document.getElementById('m2-total-masuk').textContent = formatNominal(totalMasuk);
            document.getElementById('m2-total-keluar').textContent = formatNominal(totalKeluar);
            document.getElementById('m2-footer-saldo-total').textContent = formatNominal(runningSaldo);
        }

        // ===================================
        // --- MODUL 1 LOGIC: INPUT AGREGAT ---
        // ===================================

        function getModul1InputData() {
            // Function ini digunakan untuk mengambil data dari input di Modul 1
            const data = initialData.map(monthData => {
                const prefix = `m1-${monthData.order}-`;
                // Menggunakan `monthData` sebagai fallback (nilai 0 jika tidak ada input)
                return {
                    id: monthData.id,
                    bulan: monthData.bulan,
                    order: monthData.order,
                    year: monthData.year,
                    // Parse input, jika kosong, gunakan nilai default dari monthData (yg sudah diset 0 saat logout)
                    penerimaan: parseInput(prefix + 'penerimaan') || monthData.penerimaan,
                    donatur: parseInput(prefix + 'donatur') || monthData.donatur,
                    
                    pendUang: parseInput(prefix + 'pendUang') || monthData.pendUang,
                    pendPenerima: parseInput(prefix + 'pendPenerima') || monthData.pendPenerima,
                    
                    kesUang: parseInput(prefix + 'kesUang') || monthData.kesUang,
                    kesPenerima: parseInput(prefix + 'kesPenerima') || monthData.kesPenerima,
                    
                    ekoUang: parseInput(prefix + 'ekoUang') || monthData.ekoUang,
                    ekoPenerima: parseInput(prefix + 'ekoPenerima') || monthData.ekoPenerima,
                    
                    sosumUang: parseInput(prefix + 'sosumUang') || monthData.sosumUang,
                    sosumPenerima: parseInput(prefix + 'sosumPenerima') || monthData.sosumPenerima,
                    
                    banomUang: parseInput(prefix + 'banomUang') || monthData.banomUang,
                    banomPenerima: parseInput(prefix + 'banomPenerima') || monthData.banomPenerima,
                    
                    bencanaUang: parseInput(prefix + 'bencanaUang') || monthData.bencanaUang,
                    bencanaPenerima: parseInput(prefix + 'bencanaPenerima') || monthData.bencanaPenerima,
                    
                    rapat: parseInput(prefix + 'rapat') || monthData.rapat,
                    perwtnMlu: parseInput(prefix + 'perwtnMlu') || monthData.perwtnMlu,
                    biayaBank: parseInput(prefix + 'biayaBank') || monthData.biayaBank,
                    lainLain: parseInput(prefix + 'lainLain') || monthData.lainLain,
                    
                    honorWajibPercent: monthData.honorWajibPercent // Use the defined percentage
                };
            });
            return data;
        }

        function calculateTotalNonHonorExpense(dataBulan) {
            return dataBulan.pendUang + dataBulan.kesUang + dataBulan.ekoUang + dataBulan.sosumUang + dataBulan.banomUang + dataBulan.bencanaUang + dataBulan.rapat + dataBulan.perwtnMlu + dataBulan.biayaBank + dataBulan.lainLain;
        }
        
        function updateModul1() {
            const inputBody = document.getElementById('m1-input-body');
            inputBody.innerHTML = ''; // Clear existing rows

            let totalPenerimaanTahunan = 0;
            let totalDonaturTahunan = 0;
            let totalPendUangTahunan = 0;
            let totalPendPnmTahunan = 0;
            let totalKesUangTahunan = 0;
            let totalKesPnmTahunan = 0;
            let totalEkoUangTahunan = 0;
            let totalEkoPnmTahunan = 0;
            let totalSosumUangTahunan = 0;
            let totalSosumPnmTahunan = 0;
            let totalBanomUangTahunan = 0;
            let totalBanomPnmTahunan = 0;
            let totalBencanaUangTahunan = 0;
            let totalBencanaPnmTahunan = 0;
            let totalRapatTahunan = 0;
            let totalPerwtnTahunan = 0;
            let totalBankTahunan = 0;
            let totalLainTahunan = 0;
            
            // Gunakan initialData (dijamin 12 bulan, baik dari Firebase/template 0)
            initialData.sort((a, b) => a.order - b.order).forEach(data => {
                const prefix = `m1-${data.order}-`;
                const row = inputBody.insertRow();
                
                // Kalkulasi total
                totalPenerimaanTahunan += data.penerimaan;
                totalDonaturTahunan += data.donatur;
                totalPendUangTahunan += data.pendUang;
                totalPendPnmTahunan += data.pendPenerima;
                totalKesUangTahunan += data.kesUang;
                totalKesPnmTahunan += data.kesPenerima;
                totalEkoUangTahunan += data.ekoUang;
                totalEkoPnmTahunan += data.ekoPenerima;
                totalSosumUangTahunan += data.sosumUang;
                totalSosumPnmTahunan += data.sosumPenerima;
                totalBanomUangTahunan += data.banomUang;
                totalBanomPnmTahunan += data.banomPenerima;
                totalBencanaUangTahunan += data.bencanaUang;
                totalBencanaPnmTahunan += data.bencanaPenerima;
                totalRapatTahunan += data.rapat;
                totalPerwtnTahunan += data.perwtnMlu;
                totalBankTahunan += data.biayaBank;
                totalLainTahunan += data.lainLain;

                // Tentukan tipe konten: Input jika login, Display jika logout
                const content = (id, value, type = 'number') => {
                    const isMoney = (type === 'number');
                    const align = isMoney ? 'text-right' : 'text-center';
                    
                    if (isLoggedIn) {
                        return `<input type="${type}" id="${id}" value="${value}" min="0" oninput="recalculateAllReports()" style="text-align: ${isMoney ? 'right' : 'center'};">`;
                    } else {
                        return `<div class="${align}" style="padding: 2px 0;">${formatNominal(value)}</div>`;
                    }
                };

                row.innerHTML = `
                    <td style="font-weight: bold;">${data.bulan}</td>
                    <td>${content(prefix + 'penerimaan', data.penerimaan)}</td>
                    <td>${content(prefix + 'donatur', data.donatur, 'number')}</td>
                    
                    <td>${content(prefix + 'pendUang', data.pendUang)}</td>
                    <td>${content(prefix + 'pendPenerima', data.pendPenerima, 'number')}</td>
                    
                    <td>${content(prefix + 'kesUang', data.kesUang)}</td>
                    <td>${content(prefix + 'kesPenerima', data.kesPenerima, 'number')}</td>
                    
                    <td>${content(prefix + 'ekoUang', data.ekoUang)}</td>
                    <td>${content(prefix + 'ekoPenerima', data.ekoPenerima, 'number')}</td>
                    
                    <td>${content(prefix + 'sosumUang', data.sosumUang)}</td>
                    <td>${content(prefix + 'sosumPenerima', data.sosumPenerima, 'number')}</td>
                    
                    <td>${content(prefix + 'banomUang', data.banomUang)}</td>
                    <td>${content(prefix + 'banomPenerima', data.banomPenerima, 'number')}</td>
                    
                    <td>${content(prefix + 'bencanaUang', data.bencanaUang)}</td>
                    <td>${content(prefix + 'bencanaPenerima', data.bencanaPenerima, 'number')}</td>
                    
                    <td>${content(prefix + 'rapat', data.rapat)}</td>
                    <td>${content(prefix + 'perwtnMlu', data.perwtnMlu)}</td>
                    <td>${content(prefix + 'biayaBank', data.biayaBank)}</td>
                    <td>${content(prefix + 'lainLain', data.lainLain)}</td>
                `;
            });
            
            // Update Footer Total
            document.getElementById('m1-total-penerimaan').textContent = formatNominal(totalPenerimaanTahunan);
            document.getElementById('m1-total-donatur').textContent = formatNominal(totalDonaturTahunan);
            document.getElementById('m1-total-pend-uang').textContent = formatNominal(totalPendUangTahunan);
            document.getElementById('m1-total-pend-pnm').textContent = formatNominal(totalPendPnmTahunan);
            document.getElementById('m1-total-kes-uang').textContent = formatNominal(totalKesUangTahunan);
            document.getElementById('m1-total-kes-pnm').textContent = formatNominal(totalKesPnmTahunan);
            document.getElementById('m1-total-eko-uang').textContent = formatNominal(totalEkoUangTahunan);
            document.getElementById('m1-total-eko-pnm').textContent = formatNominal(totalEkoPnmTahunan);
            document.getElementById('m1-total-sosum-uang').textContent = formatNominal(totalSosumUangTahunan);
            document.getElementById('m1-total-sosum-pnm').textContent = formatNominal(totalSosumPnmTahunan);
            document.getElementById('m1-total-banom-uang').textContent = formatNominal(totalBanomUangTahunan);
            document.getElementById('m1-total-banom-pnm').textContent = formatNominal(totalBanomPnmTahunan);
            document.getElementById('m1-total-bencana-uang').textContent = formatNominal(totalBencanaUangTahunan);
            document.getElementById('m1-total-bencana-pnm').textContent = formatNominal(totalBencanaPnmTahunan);
            document.getElementById('m1-total-rapat').textContent = formatNominal(totalRapatTahunan);
            document.getElementById('m1-total-perwtn').textContent = formatNominal(totalPerwtnTahunan);
            document.getElementById('m1-total-bank').textContent = formatNominal(totalBankTahunan);
            document.getElementById('m1-total-lain').textContent = formatNominal(totalLainTahunan);
            
            // Jika login, tampilkan tombol simpan
            document.getElementById('modul-1-section').querySelectorAll('.admin-only').forEach(el => {
                el.style.display = isLoggedIn ? 'block' : 'none';
            });
        }

        // ===================================
        // --- MODUL 3 LOGIC: LAPORAN TAHUNAN ---
        // ===================================

        function updateModul3() {
            const tableBody = document.getElementById('m3-report-body');
            tableBody.innerHTML = '';

            // Ambil data agregat (dijamin 12 bulan)
            const reportData = initialData;

            // Saldo Awal Tahun
            const saldoBankAwal = parseInput('saldo-bank-awal-input');
            const saldoTunaiAwal = parseInput('saldo-tunai-awal-input');
            let runningSaldoKas = saldoBankAwal + saldoTunaiAwal;

            let totalPenerimaanTahunan = 0;
            let totalDonaturTahunan = 0;
            let totalPendUangTahunan = 0;
            let totalPendPnmTahunan = 0;
            let totalKesUangTahunan = 0;
            let totalKesPnmTahunan = 0;
            let totalEkoUangTahunan = 0;
            let totalEkoPnmTahunan = 0;
            let totalSosumUangTahunan = 0;
            let totalSosumPnmTahunan = 0;
            let totalBanomUangTahunan = 0;
            let totalBanomPnmTahunan = 0;
            let totalBencanaUangTahunan = 0;
            let totalBencanaPnmTahunan = 0;
            let totalRapatTahunan = 0;
            let totalPerwtnTahunan = 0;
            let totalBankTahunan = 0;
            let totalLainTahunan = 0;
            let totalHonorPetugasTahunan = 0;
            let totalHonorMWCTahunan = 0;
            let totalHonorPCTahunan = 0;
            let totalPengeluaranTahunan = 0;
            

            // Baris 1: SALDO KAS BANK (Awal Tahun)
            let rowBank = tableBody.insertRow();
            rowBank.classList.add('saldo-awal-row');
            const bankSaldoContent = isLoggedIn ? 
                `<input type="number" id="saldo-bank-awal-input" value="${saldoBankAwal}" min="0" oninput="recalculateAllReports()" style="width: 100%; font-size: 11px; text-align: right;">` : 
                formatNominal(saldoBankAwal);
            // Saldo Kas Bank ada di kolom 3
            rowBank.innerHTML = ` 
                <td>-</td> 
                <td>SALDO KAS BANK (Awal Tahun)</td> 
                <td class="text-right">${bankSaldoContent}</td> 
                <td class="text-right">-</td> 
                <td colspan="19" class="text-center">-</td>
                <td class="text-right">0</td>
                <td class="text-right">${formatNominal(saldoBankAwal)}</td> 
                <td class="text-right">${formatNominal(saldoBankAwal)}</td> 
            `;

            // Baris 2: SALDO KAS TUNAI (Awal Tahun)
            runningSaldoKas += saldoTunaiAwal;
            let rowTunai = tableBody.insertRow();
            rowTunai.classList.add('saldo-awal-row');
            const tunaiSaldoContent = isLoggedIn ? 
                `<input type="number" id="saldo-tunai-awal-input" value="${saldoTunaiAwal}" min="0" oninput="recalculateAllReports()" style="width: 100%; font-size: 11px; text-align: right;">` : 
                formatNominal(saldoTunaiAwal);
            // Saldo Kas Tunai ada di kolom 3
            rowTunai.innerHTML = ` 
                <td>-</td> 
                <td>SALDO KAS TUNAI (Awal Tahun)</td> 
                <td class="text-right">${tunaiSaldoContent}</td> 
                <td class="text-right">-</td> 
                <td colspan="19" class="text-center">-</td> 
                <td class="text-right">0</td>
                <td class="text-right">${formatNominal(saldoTunaiAwal)}</td> 
                <td class="text-right">${formatNominal(runningSaldoKas)}</td> 
            `;
            
            // Render 12 Bulan
            reportData.sort((a, b) => a.order - b.order).forEach((dataBulan, index) => {
                const row = tableBody.insertRow();
                const totalPenerimaanBulanIni = dataBulan.penerimaan;
                
                // Honorisasi Wajib: 40% dari total penerimaan Koin NU
                const totalHonorWajib = Math.round(totalPenerimaanBulanIni * dataBulan.honorWajibPercent);
                const honorPetugas = Math.round(totalHonorWajib * (10/40)); // 10%
                const honorMWC = Math.round(totalHonorWajib * (25/40));     // 25%
                const honorPC = Math.round(totalHonorWajib * (5/40));       // 5%

                const totalNonHonorExpense = calculateTotalNonHonorExpense(dataBulan);
                const jmlPengeluaranBulanIni = totalNonHonorExpense + honorPetugas + honorMWC + honorPC;
                
                const saldoAkhirBulanIni = totalPenerimaanBulanIni - jmlPengeluaranBulanIni;
                runningSaldoKas += saldoAkhirBulanIni;

                // Update Total Tahunan
                totalPenerimaanTahunan += totalPenerimaanBulanIni;
                totalPendUangTahunan += dataBulan.pendUang;
                totalPendPnmTahunan += dataBulan.pendPenerima;
                totalKesUangTahunan += dataBulan.kesUang;
                totalKesPnmTahunan += dataBulan.kesPenerima;
                totalEkoUangTahunan += dataBulan.ekoUang;
                totalEkoPnmTahunan += dataBulan.ekoPenerima;
                totalSosumUangTahunan += dataBulan.sosumUang;
                totalSosumPnmTahunan += dataBulan.sosumPenerima;
                totalBanomUangTahunan += dataBulan.banomUang;
                totalBanomPnmTahunan += dataBulan.banomPenerima;
                totalBencanaUangTahunan += dataBulan.bencanaUang;
                totalBencanaPnmTahunan += dataBulan.bencanaPenerima;
                totalRapatTahunan += dataBulan.rapat;
                totalPerwtnTahunan += dataBulan.perwtnMlu;
                totalBankTahunan += dataBulan.biayaBank;
                totalLainTahunan += dataBulan.lainLain;
                totalHonorPetugasTahunan += honorPetugas;
                totalHonorMWCTahunan += honorMWC;
                totalHonorPCTahunan += honorPC;
                totalPengeluaranTahunan += jmlPengeluaranBulanIni;


                row.innerHTML = `
                    <td class="text-center">${index + 1}</td>
                    <td style="font-weight: bold;">${dataBulan.bulan}</td>
                    <td class="text-right">${formatNominal(totalPenerimaanBulanIni)}</td>
                    
                    <td class="text-right">${formatNominal(dataBulan.pendUang)}</td>
                    <td class="text-center">${formatNominal(dataBulan.pendPenerima)}</td>
                    
                    <td class="text-right">${formatNominal(dataBulan.kesUang)}</td>
                    <td class="text-center">${formatNominal(dataBulan.kesPenerima)}</td>
                    
                    <td class="text-right">${formatNominal(dataBulan.ekoUang)}</td>
                    <td class="text-center">${formatNominal(dataBulan.ekoPenerima)}</td>
                    
                    <td class="text-right">${formatNominal(dataBulan.sosumUang)}</td>
                    <td class="text-center">${formatNominal(dataBulan.sosumPenerima)}</td>
                    
                    <td class="text-right">${formatNominal(dataBulan.banomUang)}</td>
                    <td class="text-center">${formatNominal(dataBulan.banomPenerima)}</td>
                    
                    <td class="text-right">${formatNominal(dataBulan.bencanaUang)}</td>
                    <td class="text-center">${formatNominal(dataBulan.bencanaPenerima)}</td>

                    <td class="text-right">${formatNominal(dataBulan.rapat)}</td>
                    <td class="text-right">${formatNominal(dataBulan.perwtnMlu)}</td>
                    <td class="text-right">${formatNominal(dataBulan.biayaBank)}</td>
                    <td class="text-right">${formatNominal(dataBulan.lainLain)}</td>
                    
                    <td class="text-right">${formatNominal(honorPetugas)}</td>
                    <td class="text-right">${formatNominal(honorMWC)}</td>
                    <td class="text-right">${formatNominal(honorPC)}</td>

                    <td class="text-right">${formatNominal(jmlPengeluaranBulanIni)}</td>
                    <td class="text-right">${formatNominal(saldoAkhirBulanIni)}</td>
                    <td class="text-right">${formatNominal(runningSaldoKas)}</td>
                `;
            });

            // Update Footer Total
            document.getElementById('m3-total-penerimaan').textContent = formatNominal(totalPenerimaanTahunan);
            document.getElementById('m3-total-pend-uang').textContent = formatNominal(totalPendUangTahunan);
            document.getElementById('m3-total-pend-pnm').textContent = formatNominal(totalPendPnmTahunan);
            document.getElementById('m3-total-kes-uang').textContent = formatNominal(totalKesUangTahunan);
            document.getElementById('m3-total-kes-pnm').textContent = formatNominal(totalKesPnmTahunan);
            document.getElementById('m3-total-eko-uang').textContent = formatNominal(totalEkoUangTahunan);
            document.getElementById('m3-total-eko-pnm').textContent = formatNominal(totalEkoPnmTahunan);
            document.getElementById('m3-total-sosum-uang').textContent = formatNominal(totalSosumUangTahunan);
            document.getElementById('m3-total-sosum-pnm').textContent = formatNominal(totalSosumPnmTahunan);
            document.getElementById('m3-total-banom-uang').textContent = formatNominal(totalBanomUangTahunan);
            document.getElementById('m3-total-banom-pnm').textContent = formatNominal(totalBanomPnmTahunan);
            document.getElementById('m3-total-bencana-uang').textContent = formatNominal(totalBencanaUangTahunan);
            document.getElementById('m3-total-bencana-pnm').textContent = formatNominal(totalBencanaPnmTahunan);
            document.getElementById('m3-total-rapat').textContent = formatNominal(totalRapatTahunan);
            document.getElementById('m3-total-perwtn').textContent = formatNominal(totalPerwtnTahunan);
            document.getElementById('m3-total-bank').textContent = formatNominal(totalBankTahunan);
            document.getElementById('m3-total-lain').textContent = formatNominal(totalLainTahunan);
            document.getElementById('m3-total-honor-petugas').textContent = formatNominal(totalHonorPetugasTahunan);
            document.getElementById('m3-total-honor-mwc').textContent = formatNominal(totalHonorMWCTahunan);
            document.getElementById('m3-total-honor-pc').textContent = formatNominal(totalHonorPCTahunan);
            document.getElementById('m3-total-pengeluaran').textContent = formatNominal(totalPengeluaranTahunan);
            // Saldo Akhir dan Saldo Kas Tahunan adalah hasil dari bulan terakhir
            document.getElementById('m3-footer-saldo-akhir').textContent = formatNominal(reportData.length > 0 ? reportData[reportData.length - 1].saldoAkhirBulanIni : 0);
            document.getElementById('m3-footer-saldo-kas').textContent = formatNominal(runningSaldoKas);
        }

        function exportModul3ToPDF() {
            if (typeof window.jsPDF === 'undefined') {
                alert("Library jsPDF tidak dimuat. Pastikan koneksi internet aktif.");
                return;
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('l', 'mm', 'a4'); // 'l' for landscape, 'mm' for units
            
            doc.setFontSize(14);
            doc.text("MODUL 3: LAPORAN TAHUNAN KOIN NU", 148, 15, null, null, "center");
            doc.setFontSize(10);
            doc.text(`Tahun: ${currentFilterYear}`, 148, 20, null, null, "center");

            const table = document.getElementById('tabel-modul-3');
            
            // Reformat data for autoTable
            const headerRows = table.tHead.rows;
            const bodyRows = table.tBodies[0].rows;
            const footerRows = table.tFoot.rows;

            // Extract Headers (This is complex for multi-row headers, simplified)
            const headers = Array.from(headerRows[2].cells).map(cell => cell.textContent.trim());

            // Extract Body Data
            const data = Array.from(bodyRows).map(row => 
                Array.from(row.cells).map(cell => cell.textContent.trim())
            );

            // Extract Footer Data
            const footer = Array.from(footerRows[0].cells).map(cell => cell.textContent.trim());
            
            doc.autoTable({
                head: [headers],
                body: data,
                foot: [footer],
                startY: 30,
                theme: 'grid',
                headStyles: { 
                    fillColor: [0, 100, 0], // Dark Green
                    textColor: [255, 255, 255],
                    fontSize: 8,
                    halign: 'center'
                },
                styles: {
                    fontSize: 7,
                    cellPadding: 1
                },
                columnStyles: {
                    // Align nominal columns to the right (assuming they are columns 2, 4, 6, 8, etc.)
                    2: { halign: 'right' }, 3: { halign: 'center' }, 
                    4: { halign: 'right' }, 5: { halign: 'center' },
                    6: { halign: 'right' }, 7: { halign: 'center' },
                    8: { halign: 'right' }, 9: { halign: 'center' },
                    10: { halign: 'right' }, 11: { halign: 'center' },
                    12: { halign: 'right' }, 13: { halign: 'center' },
                    14: { halign: 'right' }, 15: { halign: 'center' },
                    16: { halign: 'right' }, 17: { halign: 'right' },
                    18: { halign: 'right' }, 19: { halign: 'right' },
                    20: { halign: 'right' }, 21: { halign: 'right' },
                    22: { halign: 'right' }, 23: { halign: 'right' },
                    24: { halign: 'right' }, 25: { halign: 'right' },
                },
                footStyles: {
                    fillColor: [230, 255, 230],
                    textColor: [0, 0, 0],
                    fontStyle: 'bold',
                    halign: 'right'
                }
            });

            // Tambahkan judul baris 1 dan 2 secara manual karena multi-row header rumit di jsPDF-autotable
            // doc.text("Penerimaan ZISWAF/Koin NU", 25, 25, null, null, "center"); 
            
            doc.save(`Laporan_Tahunan_KOIN_NU_${currentFilterYear}.pdf`);
        }


        // ===================================
        // --- DATA RESET ---
        // ===================================

        async function resetAllData() {
            if (!isLoggedIn) {
                alert("Anda harus login untuk menghapus data.");
                return;
            }

            const confirmText = "ANDA YAKIN INGIN MENGHAPUS SELURUH DATA TRANSAKSI (MODUL 1A DAN MODUL 2) UNTUK TAHUN INI? Tindakan ini tidak dapat dibatalkan!";
            if (!confirm(confirmText)) {
                return;
            }

            try {
                // Delete M1A transactions
                const m1aSnapshot = await db.collection('m1aTransactions').get();
                const m1aDeletes = m1aSnapshot.docs.map(doc => doc.ref.delete());
                await Promise.all(m1aDeletes);

                // Delete M2 manual transactions
                const m2ManualSnapshot = await db.collection('m2ManualTransactions').get();
                const m2Deletes = m2ManualSnapshot.docs.map(doc => doc.ref.delete());
                await Promise.all(m2Deletes);
                
                // Hapus data agregat (Modul 1) yang spesifik tahun ini
                const m1AgregatSnapshot = await db.collection('m1Agregat').where('year', '==', currentFilterYear).get();
                const m1Deletes = m1AgregatSnapshot.docs.map(doc => doc.ref.delete());
                await Promise.all(m1Deletes);

                alert("SELURUH DATA TRANSAKSI BERHASIL DIHAPUS!");
                await loadTransactions();
                recalculateAllReports();
            } catch (error) {
                console.error("Error during full reset:", error);
                alert("Gagal menghapus data di Firebase. Cek konsol untuk detail.");
            }
        }


        // ===================================
        // --- DISPLAY & CONTROL ---
        // ===================================

        function toggleAksiColumnVisibility(loggedIn) {
            const aksiVisibilityStyle = loggedIn ? '' : 'none';
            // Modul 1A
            document.getElementById('th-m1a-aksi').style.display = aksiVisibilityStyle;
            document.getElementById('tf-m1a-aksi').style.display = aksiVisibilityStyle;
            // Modul 2
            document.getElementById('th-m2-aksi').style.display = aksiVisibilityStyle;
            document.getElementById('tf-m2-aksi').style.display = aksiVisibilityStyle;
            const saldoAwalAksiTd = document.getElementById('td-m2-saldo-awal-aksi');
            if (saldoAwalAksiTd) {
                saldoAwalAksiTd.style.display = aksiVisibilityStyle;
            }
            // Admin only containers (in M1A, M2, M1)
            document.querySelectorAll('.admin-only').forEach(el => {
                el.style.display = loggedIn ? 'block' : 'none';
            });
            // Toggle Saldo Awal Input vs Static Display in Modul 2
            const saldoInputContainer = document.getElementById('m2-saldo-awal-display-container');
            const saldoStatic = document.getElementById('m2-saldo-awal-static');
            if (saldoInputContainer && saldoStatic) {
                if (loggedIn) {
                    saldoInputContainer.style.display = 'block';
                    saldoStatic.style.display = 'none';
                } else {
                    saldoInputContainer.style.display = 'none';
                    saldoStatic.style.display = 'block';
                }
            }
        }

        function recalculateAllReports() {
            // 1. Update Modul 1A & Modul 2 (depends on each other's output)
            updatePenerimaanDetail();
            updateJurnalUmum(); 

            // 2. Update Modul 1 (Input Agregat)
            updateModul1(); 

            // 3. Update Modul 3 (Laporan Tahunan - depends on Modul 1 data)
            updateModul3(); 
            
            // Sinkronkan filter
            syncFilters();
        }

        // ===================================
        // --- INITIALIZATION ---
        // ===================================
        window.onload = () => {
            // 1. Inisialisasi Firebase
            if (firebaseConfig.apiKey !== "YOUR_API_KEY") {
                 firebase.initializeApp(firebaseConfig);
                 db = firebase.firestore();
                 auth = firebase.auth();
            } else {
                console.warn("⚠️ PERHATIAN: Konfigurasi Firebase belum diisi. Aplikasi berjalan dengan data dummy/kosong.");
                // Set auth.onAuthStateChanged listener to handle the unauthenticated state
                auth = { onAuthStateChanged: (callback) => callback(null) };
            }

            // 2. Populate Filters
            populateFilters();
            
            // 3. Set Auth State Listener (akan memicu load data & render)
            auth.onAuthStateChanged(handleAuthStateChange);

            // 4. Set default view
            switchModule('modul-1a-section'); 
        };

    </script>
</body>
</html>

