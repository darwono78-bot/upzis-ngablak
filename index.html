<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Pembukuan UPZIS | Ranting Ngablak</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <style>
        /* Gaya CSS untuk Tampilan */
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; padding: 0; background-color: #f4f7f6; color: #333; }
        .container { padding: 20px; max-width: 100%; margin: auto; } 
        
        /* Gaya Navigasi */
        .navbar { background-color: #006400; color: white; padding: 10px 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.2); display: flex; align-items: center; justify-content: space-between; }
        .navbar-logo { font-size: 1.5rem; font-weight: bold; }
        .navbar-links { display: flex; }
        .navbar-links a, .navbar-links button { color: white; text-decoration: none; padding: 10px 15px; background: none; border: none; cursor: pointer; font-size: 1rem; transition: background-color 0.3s; }
        .navbar-links a:hover, .navbar-links button:hover, .navbar-links .active { background-color: #004d00; }
        .navbar-links .logout-button { background-color: #e74c3c; border-radius: 5px; margin-left: 10px; }
        .navbar-links .logout-button:hover { background-color: #c0392b; }
        
        /* Gaya Modul dan Form */
        .module { background-color: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); margin-top: 20px; }
        .module-header { border-bottom: 2px solid #006400; padding-bottom: 10px; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; }
        .module-header h2 { color: #006400; margin: 0; }
        
        /* Gaya 2 Kolom */
        .row {
            display: flex;
            gap: 20px; 
            margin-bottom: 15px;
        }
        .column {
            flex: 1; 
        }
        
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; }
        .form-group input, .form-group select { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        .form-actions button { background-color: #006400; color: white; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; font-size: 1rem; transition: background-color 0.3s; }
        .form-actions button:hover { background-color: #004d00; }
        
        /* Gaya Tabel */
        .data-table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 0.9em; }
        .data-table th, .data-table td { border: 1px solid #ddd; padding: 10px; text-align: left; }
        .data-table th { background-color: #f2f2f2; color: #333; }
        .data-table tr:nth-child(even) { background-color: #f9f9f9; }
        .action-cell button { padding: 5px 10px; margin-right: 5px; cursor: pointer; border-radius: 3px; border: none; }
        .edit-btn { background-color: #f39c12; color: white; }
        .delete-btn { background-color: #e74c3c; color: white; }
        
        /* Gaya Laporan Tahunan */
        #laporan-tahunan-container { padding: 20px; border: 1px solid #ccc; margin-top: 20px; background-color: #fff; }
        #annual-data-table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
        #annual-data-table th, #annual-data-table td { border: 1px solid #000; padding: 8px; font-size: 0.95em; }
        .total-row th, .total-row td { font-weight: bold; background-color: #f2f2f2; }
        .ttd-area { margin-top: 40px; display: flex; justify-content: space-around; width: 100%; }
        .ttd-column { text-align: center; width: 30%; }
        .ttd-column hr { border: none; border-top: 1px solid #000; margin-top: 60px; }
        
        /* Gaya Login (Disembunyikan) */
        #login-module { display: none; } 

        /* Print CSS */
        @media print {
            body * { visibility: hidden; }
            #laporan-tahunan-container, #laporan-tahunan-container * { visibility: visible; }
            #laporan-tahunan-container { position: absolute; left: 0; top: 0; margin: 0; padding: 10px; box-shadow: none; border: none; }
            .navbar, .module-header, .filter-area, .form-actions, .action-cell, .ttd-area, #tahun-cetak-date, .ttd-date-area { display: none !important; }
            #annual-data-table { font-size: 10pt; }
            #annual-data-table th, #annual-data-table td { padding: 5px; }
            .ttd-area-print { display: flex !important; justify-content: space-around; margin-top: 40px; }
            .ttd-column-print { text-align: center; width: 30%; }
            .ttd-column-print hr { border: none; border-top: 1px solid #000; margin-top: 60px; }
        }
    </style>
</head>
<body>

    <div id="app">
        <div id="login-module" style="display: none;">
            <div id="login-form">
                <h2>Admin Login</h2>
                <div class="form-group">
                    <input type="text" id="username" placeholder="Username (admin)" value="admin" required>
                </div>
                <div class="form-group">
                    <input type="password" id="password" placeholder="Password" required>
                </div>
                <button onclick="attemptLogin()">Login</button>
            </div>
        </div>

        <div id="main-app">
            <div class="navbar">
                <div class="navbar-logo">UPZIS RANTING NGABLAK</div>
                <div class="navbar-links">
                    <button id="nav-koin" onclick="showModule('koin')">KOIN NU</button>
                    <button id="nav-jurnal" onclick="showModule('jurnal')">JURNAL UMUM</button>
                    <button id="nav-tahunan" onclick="showModule('tahunan')">LAPORAN TAHUNAN</button>
                    <button class="logout-button" onclick="logout()">Admin Login</button> </div>
            </div>

            <div class="container">
                <div id="koin-module" class="module" style="display: none;">
                    <div class="module-header">
                        <h2>Input Data KOIN NU</h2>
                        <div class="filter-area">
                            <label for="koin-filter-bulan">Bulan:</label>
                            <select id="koin-filter-bulan" onchange="filterData('koin')"></select>
                            <label for="koin-filter-tahun">Tahun:</label>
                            <select id="koin-filter-tahun" onchange="filterData('koin')"></select>
                            <button onclick="exportTable('koin')">Export CSV</button>
                        </div>
                    </div>
                    
                    <div class="form-input">
                        <h3>Form Input Koin NU</h3>
                        <div class="row">
                            <div class="column">
                                <div class="form-group">
                                    <label for="koin-input-tanggal">Tanggal</label>
                                    <input type="date" id="koin-input-tanggal" required>
                                </div>
                                <div class="form-group">
                                    <label for="koin-input-petugas">Nama Petugas</label>
                                    <input type="text" id="koin-input-petugas" placeholder="Nama Petugas" required>
                                </div>
                                <div class="form-group">
                                    <label for="koin-input-hp">Nomor HP Petugas</label>
                                    <input type="text" id="koin-input-hp" placeholder="No HP Petugas" required>
                                </div>
                            </div>
                            <div class="column">
                                <div class="form-group">
                                    <label for="koin-input-donatur">Nama Donatur</label>
                                    <input type="text" id="koin-input-donatur" placeholder="Nama Donatur" required>
                                </div>
                                <div class="form-group">
                                    <label for="koin-input-alamat">Alamat Donatur</label>
                                    <input type="text" id="koin-input-alamat" placeholder="Alamat Donatur" required>
                                </div>
                                <div class="form-group">
                                    <label for="koin-input-nominal">Nominal (Rp)</label>
                                    <input type="number" id="koin-input-nominal" placeholder="Nominal (Rp)" required>
                                </div>
                            </div>
                        </div>

                        <div class="form-actions">
                            <button onclick="saveData('koin')">Simpan Data</button>
                            <button onclick="resetForm('koin')" id="koin-reset-btn" style="background-color: #34495e;">Batal</button>
                        </div>
                    </div>

                    <table class="data-table" id="koin-data-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Tanggal</th>
                                <th>Petugas</th>
                                <th>No HP</th>
                                <th>Donatur</th>
                                <th>Alamat</th>
                                <th>Nominal</th>
                                <th class="action-cell">Aksi</th>
                            </tr>
                        </thead>
                        <tbody>
                            </tbody>
                        <tfoot>
                            <tr>
                                <td colspan="6" style="text-align: right; font-weight: bold;">TOTAL NOMINAL</td>
                                <td id="koin-total-nominal" style="font-weight: bold;">Rp 0</td>
                                <td></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>

                <div id="jurnal-module" class="module" style="display: none;">
                    <div class="module-header">
                        <h2>Input Data Jurnal Umum</h2>
                        <div class="filter-area">
                            <label for="jurnal-filter-bulan">Bulan:</label>
                            <select id="jurnal-filter-bulan" onchange="filterData('jurnal')"></select>
                            <label for="jurnal-filter-tahun">Tahun:</label>
                            <select id="jurnal-filter-tahun" onchange="filterData('jurnal')"></select>
                            <button onclick="exportTable('jurnal')">Export CSV</button>
                        </div>
                    </div>

                    <div class="form-input">
                        <h3>Form Input Jurnal Umum (Dana Masuk / Dana Keluar)</h3>
                        <div class="row">
                            <div class="column">
                                <div class="form-group">
                                    <label for="jurnal-input-tanggal">Tanggal</label>
                                    <input type="date" id="jurnal-input-tanggal" required>
                                </div>
                                <div class="form-group">
                                    <label for="jurnal-input-keterangan">Keterangan</label>
                                    <input type="text" id="jurnal-input-keterangan" placeholder="Keterangan Transaksi" required>
                                </div>
                                <div class="form-group">
                                    <label for="jurnal-input-kategori">Kategori</label>
                                    <select id="jurnal-input-kategori" required>
                                        <option value="">Pilih Kategori...</option>
                                        </select>
                                </div>
                            </div>
                            <div class="column">
                                <div class="form-group">
                                    <label for="jurnal-input-masuk">Dana Masuk (Debit)</label>
                                    <input type="number" id="jurnal-input-masuk" placeholder="Nominal Masuk (Debit)" value="0">
                                </div>
                                <div class="form-group">
                                    <label for="jurnal-input-keluar">Dana Keluar (Kredit)</label>
                                    <input type="number" id="jurnal-input-keluar" placeholder="Nominal Keluar (Kredit)" value="0">
                                </div>
                                <div class="form-actions" style="margin-top: 30px;">
                                    <button onclick="saveData('jurnal')">Simpan Data</button>
                                    <button onclick="resetForm('jurnal')" id="jurnal-reset-btn" style="background-color: #34495e;">Batal</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <table class="data-table" id="jurnal-data-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Tanggal</th>
                                <th>Keterangan</th>
                                <th>Kategori</th>
                                <th>Masuk</th>
                                <th>Keluar</th>
                                <th class="action-cell">Aksi</th>
                            </tr>
                        </thead>
                        <tbody>
                            </tbody>
                        <tfoot>
                            <tr class="total-row">
                                <td colspan="4" style="text-align: right;">TOTAL</td>
                                <td id="jurnal-total-masuk" style="font-weight: bold;">Rp 0</td>
                                <td id="jurnal-total-keluar" style="font-weight: bold;">Rp 0</td>
                                <td></td>
                            </tr>
                            <tr class="total-row">
                                <td colspan="4" style="text-align: right;">SALDO AKHIR</td>
                                <td colspan="2" id="jurnal-saldo-akhir" style="font-weight: bold; text-align: center;">Rp 0</td>
                                <td></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>

                <div id="tahunan-module" class="module" style="display: none;">
                    <div class="module-header">
                        <h2>Laporan Tahunan dan Saldo Awal</h2>
                        <div class="filter-area">
                            <label for="tahunan-filter-tahun">Tahun:</label>
                            <select id="tahunan-filter-tahun" onchange="filterData('tahunan')"></select>
                            <button onclick="cetakLaporan()">Cetak PDF</button>
                        </div>
                    </div>
                    
                    <div class="form-input" id="saldo-awal-form">
                        <h3>Atur Saldo Awal Tahun</h3>
                        <p>Saldo awal tahun ini akan menjadi basis perhitungan akumulasi.</p>
                        <div class="form-group">
                            <input type="number" id="annual-saldo-awal-input" placeholder="Masukkan Saldo Awal Tahun" value="0">
                            <button onclick="saveAnnualSaldoAwal()">Simpan Saldo Awal</button>
                        </div>
                    </div>

                    <div id="laporan-tahunan-container">
                        <h1 style="text-align: center; color: #006400;">LAPORAN TAHUNAN UPZIS</h1>
                        <h2 style="text-align: center; margin-top: 0;">PERIODE TAHUN <span id="tahun-cetak-text">...</span></h2>
                        
                        <div class="module-header" id="tahun-cetak-date" style="display: none;">
                            <span id="ttd-date-area"></span>
                        </div>

                        <table class="data-table" id="annual-data-table">
                            <thead>
                                <tr>
                                    <th>BULAN</th>
                                    <th>PEMASUKAN (A)</th>
                                    <th>PENGELUARAN (B)</th>
                                    <th>SALDO BULAN INI (A-B)</th>
                                    <th>SALDO AKUMULASI (C)</th>
                                </tr>
                            </thead>
                            <tbody>
                                </tbody>
                            <tfoot>
                                <tr class="total-row">
                                    <th>TOTAL TAHUNAN</th>
                                    <td id="annual-total-masuk">Rp 0</td>
                                    <td id="annual-total-keluar">Rp 0</td>
                                    <td id="annual-total-saldo">Rp 0</td>
                                    <td></td>
                                </tr>
                            </tfoot>
                        </table>
                        
                        <div class="ttd-area-print" id="ttd-area" style="display: none;">
                            <div class="ttd-column-print">
                                <p>Mengetahui,</p>
                                <p>Ketua UPZIS Ranting Ngablak</p>
                                <hr>
                            </div>
                            <div class="ttd-column-print">
                                <p>Dibuat Oleh,</p>
                                <p>Bendahara UPZIS Ranting Ngablak</p>
                                <hr>
                            </div>
                        </div>
                        
                    </div>
                </div>
            </div>
        </div>
    </div>
    
<script type="module">
    // 1. Ambil library Firebase yang dibutuhkan
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
    import { 
        getFirestore, collection, addDoc, onSnapshot, query, doc, updateDoc, deleteDoc, orderBy 
    } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";
    // Import untuk Firebase Authentication (Login)
    import { getAuth, signInWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";

    // 2. KONFIGURASI KUNCI FIREBASE ANDA (GANTI DENGAN KUNCI ASLI!)
    const firebaseConfig = {
        apiKey: "GANTI_DENGAN_API_KEY_ANDA", 
        authDomain: "GANTI_DENGAN_AUTH_DOMAIN_ANDA", 
        projectId: "GANTI_DENGAN_PROJECT_ID_ANDA", 
        storageBucket: "GANTI_DENGAN_STORAGE_BUCKET_ANDA", 
        messagingSenderId: "GANTI_DENGAN_SENDER_ID_ANDA",
        appId: "GANTI_DENGAN_APP_ID_ANDA"
    };

    // 3. Inisialisasi Aplikasi dan Database
    const app = initializeApp(firebaseConfig);
    window.db = getFirestore(app);
    window.auth = getAuth(app);
    
    // 4. LAMPIRKAN KE GLOBAL WINDOW: Ini memungkinkan kode JavaScript lama Anda mengakses Firebase
    window.collection = collection;
    window.addDoc = addDoc;
    window.onSnapshot = onSnapshot;
    window.query = query;
    window.doc = doc;
    window.updateDoc = updateDoc;
    window.deleteDoc = deleteDoc;
    window.signInWithEmailAndPassword = signInWithEmailAndPassword;
    window.onAuthStateChanged = onAuthStateChanged;
    window.orderBy = orderBy;
</script>
<script>
        // --- KONSTANTA DAN INISIALISASI ---
        const ANNUAL_KEY = 'annualData';
        let koinData = [];
        let jurnalData = [];
        let annualData = {};
        let isLoggedIn = false; // Default: Tidak login saat tampilan awal
        let currentModule = 'koin';
        let koinEditId = null; 
        let jurnalEditId = null;

        const categories = {
            saldo_bln_lalu: 'SALDO_BLN_LALU',
            pemasukan_lain: 'PEMASUKAN_LAIN',
            pengeluaran_rutin: 'PENGELUARAN_RUTIN',
            pengeluaran_sosial: 'PENGELUARAN_SOSIAL',
        };
        
        // Mapping kategori ke teks
        const categoryMap = {
            [categories.saldo_bln_lalu]: 'Saldo Awal Tahun',
            [categories.pemasukan_lain]: 'Pemasukan Lain-lain',
            [categories.pengeluaran_rutin]: 'Pengeluaran Rutin Operasional',
            [categories.pengeluaran_sosial]: 'Pengeluaran Sosial/Bantuan',
        };

        // --- HELPER FUNCTIONS (Sama seperti sebelumnya) ---
        function loadDataFromStorage(key, defaultData) {
            const data = localStorage.getItem(key);
            try {
                return data ? JSON.parse(data) : defaultData;
            } catch (e) {
                console.error(`Error parsing data for ${key}:`, e);
                return defaultData;
            }
        }

        function saveDataToStorage(key, data) {
            localStorage.setItem(key, JSON.stringify(data));
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('id-ID', { year: 'numeric', month: 'long', day: '2-digit' });
        }

        function formatRupiah(number) {
            return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(number);
        }

        function resetForm(module) {
            if (module === 'koin') {
                document.getElementById('koin-input-tanggal').value = '';
                document.getElementById('koin-input-petugas').value = '';
                document.getElementById('koin-input-hp').value = '';
                document.getElementById('koin-input-donatur').value = '';
                document.getElementById('koin-input-alamat').value = '';
                document.getElementById('koin-input-nominal').value = '';
                document.getElementById('koin-reset-btn').textContent = 'Batal';
                document.querySelector('#koin-module .form-actions button:first-child').textContent = 'Simpan Data';
                koinEditId = null;
            } else if (module === 'jurnal') {
                document.getElementById('jurnal-input-tanggal').value = '';
                document.getElementById('jurnal-input-keterangan').value = '';
                document.getElementById('jurnal-input-kategori').value = '';
                document.getElementById('jurnal-input-masuk').value = '0';
                document.getElementById('jurnal-input-keluar').value = '0';
                document.getElementById('jurnal-reset-btn').textContent = 'Batal';
                document.querySelector('#jurnal-module .form-actions button:first-child').textContent = 'Simpan Data';
                jurnalEditId = null;
            }
        }

        function populateFilterOptions() {
            const today = new Date();
            const currentYear = today.getFullYear();
            const startYear = 2023; 
            const years = Array.from({ length: currentYear - startYear + 2 }, (_, i) => startYear + i);
            const months = ["Semua Bulan", "Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];

            const monthSelects = ['koin-filter-bulan', 'jurnal-filter-bulan'];
            monthSelects.forEach(id => {
                const select = document.getElementById(id);
                select.innerHTML = '';
                months.forEach((month, index) => {
                    const option = document.createElement('option');
                    option.value = index;
                    option.textContent = month;
                    select.appendChild(option);
                });
                select.value = today.getMonth() + 1; // Default: Bulan saat ini
            });

            const yearSelects = ['koin-filter-tahun', 'jurnal-filter-tahun', 'tahunan-filter-tahun'];
            yearSelects.forEach(id => {
                const select = document.getElementById(id);
                select.innerHTML = '';
                years.reverse().forEach(year => {
                    const option = document.createElement('option');
                    option.value = year;
                    option.textContent = year;
                    select.appendChild(option);
                });
                select.value = currentYear; // Default: Tahun saat ini
            });
            
            // Isi opsi kategori Jurnal
            const jurnalKategoriSelect = document.getElementById('jurnal-input-kategori');
            jurnalKategoriSelect.innerHTML = '<option value="">Pilih Kategori...</option>';
            for (const key in categories) {
                const option = document.createElement('option');
                option.value = categories[key];
                option.textContent = categoryMap[categories[key]];
                jurnalKategoriSelect.appendChild(option);
            }
        }

        // --- AUTHENTICATION ---
        // Fungsi attemptLogin tetap ada, tapi hanya dipanggil dari Admin Login
        function attemptLogin() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            // Pastikan user admin@upzisngablak.com terdaftar di Firebase Auth
            const adminEmail = 'admin@upzisngablak.com'; // <--- GANTI DENGAN EMAIL ADMIN NYATA DI FIREBASE
            
            if (username !== 'admin') { 
                alert('Login Gagal! Username harus "admin".'); 
                return;
            }

            if (window.auth) {
                window.signInWithEmailAndPassword(window.auth, adminEmail, password)
                    .then((userCredential) => {
                        isLoggedIn = true;
                        alert('Login Berhasil! Anda memiliki akses edit.');
                        showModule(currentModule);
                    })
                    .catch((error) => {
                        const errorCode = error.code;
                        console.error("Firebase Auth Error:", error.message);
                        alert(`Login Gagal! Password salah atau user tidak terdaftar. Error Code: (${errorCode})`);
                    });
            } else {
                alert('Error: Firebase Authentication belum terinisialisasi.');
            }
        }

        // Fungsi logout diubah menjadi 'Admin Login'
        function logout() {
            // Jika user sedang login (isLoggedIn = true), lakukan logout Firebase
            if (isLoggedIn) {
                if (window.auth) {
                    window.auth.signOut().then(() => {
                        isLoggedIn = false;
                        alert('Anda telah logout dari mode Admin.');
                        // Setelah logout, tampilkan halaman utama lagi (koin module)
                        showModule(currentModule); 
                    }).catch((error) => {
                        console.error("Logout Error:", error);
                    });
                } else {
                    isLoggedIn = false;
                    showModule(currentModule);
                }
            } else {
                 // Jika user belum login, tampilkan form login
                document.getElementById('main-app').style.display = 'none';
                document.getElementById('login-module').style.display = 'flex';
            }
        }

        // --- DATA CRUD (Membutuhkan Login) ---
        function saveData(module) {
            if (!isLoggedIn) {
                alert('Anda harus login sebagai admin untuk menyimpan data.');
                logout(); // Panggil login screen
                return;
            }
            
            // ... (Logika saveData Koin/Jurnal tetap sama, hanya terproteksi oleh isLoggedIn)
            if (module === 'koin') {
                const tanggal = document.getElementById('koin-input-tanggal').value;
                const petugas = document.getElementById('koin-input-petugas').value;
                const hp = document.getElementById('koin-input-hp').value;
                const donatur = document.getElementById('koin-input-donatur').value;
                const alamat = document.getElementById('koin-input-alamat').value;
                const nominal = parseInt(document.getElementById('koin-input-nominal').value) || 0;
                
                if (!tanggal || !petugas || !donatur || nominal <= 0) {
                    alert('Mohon lengkapi semua data Koin NU yang diperlukan.');
                    return;
                }
                
                const koinDataToSave = {
                    tanggal: tanggal,
                    petugas: petugas,
                    hp: hp,
                    donatur: donatur,
                    alamat: alamat,
                    nominal: nominal,
                    timestamp: Date.now(),
                };

                const collectionName = 'koin_nu'; 
                
                if (koinEditId) {
                   const docRef = window.doc(window.db, collectionName, koinEditId);
                   window.updateDoc(docRef, koinDataToSave)
                       .then(() => {
                           alert('Data KOIN NU berhasil diperbarui di Firebase!');
                           resetForm('koin');
                       })
                       .catch((error) => {
                           console.error("Error updating document: ", error);
                           alert('Gagal memperbarui data di Firebase.');
                       });
                } else {
                   window.addDoc(window.collection(window.db, collectionName), koinDataToSave)
                       .then((docRef) => {
                           alert('Data KOIN NU berhasil disimpan di Firebase dengan ID: ' + docRef.id);
                           resetForm('koin');
                       })
                       .catch((error) => {
                           console.error("Error adding document: ", error);
                           alert('Gagal menyimpan data di Firebase.');
                       });
                }
                koinEditId = null; 
                return; 
            } 
            
            else if (module === 'jurnal') {
                const tanggal = document.getElementById('jurnal-input-tanggal').value;
                const keterangan = document.getElementById('jurnal-input-keterangan').value;
                const kategori = document.getElementById('jurnal-input-kategori').value;
                const masuk = parseInt(document.getElementById('jurnal-input-masuk').value) || 0;
                const keluar = parseInt(document.getElementById('jurnal-input-keluar').value) || 0;
                
                if (!tanggal || !keterangan || !kategori || (masuk <= 0 && keluar <= 0)) {
                    alert('Mohon lengkapi semua data Jurnal Umum yang diperlukan.');
                    return;
                }

                const jurnalDataToSave = {
                    tanggal: tanggal,
                    keterangan: keterangan,
                    kategori: kategori,
                    masuk: masuk,
                    keluar: keluar,
                    timestamp: Date.now(),
                };

                const collectionName = 'jurnal_umum'; 
                
                if (jurnalEditId) {
                   const docRef = window.doc(window.db, collectionName, jurnalEditId);
                   window.updateDoc(docRef, jurnalDataToSave)
                       .then(() => {
                           alert('Data Jurnal Umum berhasil diperbarui di Firebase!');
                           resetForm('jurnal');
                       })
                       .catch((error) => {
                           console.error("Error updating document: ", error);
                           alert('Gagal memperbarui data di Firebase.');
                       });
                } else {
                   window.addDoc(window.collection(window.db, collectionName), jurnalDataToSave)
                       .then((docRef) => {
                           alert('Data Jurnal Umum berhasil disimpan di Firebase dengan ID: ' + docRef.id);
                           resetForm('jurnal');
                       })
                       .catch((error) => {
                           console.error("Error adding document: ", error);
                           alert('Gagal menyimpan data di Firebase.');
                       });
                }
                jurnalEditId = null; 
                return;
            }
            
            else if (module === 'annual') {
                saveDataToStorage(ANNUAL_KEY, annualData);
                filterData('tahunan');
            }
        }

        function editData(module, id) {
            if (!isLoggedIn) {
                alert('Anda harus login sebagai admin untuk melakukan aksi ini.');
                logout(); // Panggil login screen
                return;
            }
            // ... (Logika editData tetap sama)
            if (module === 'koin') {
                const data = koinData.find(d => d.id == id);
                if (data) {
                    document.getElementById('koin-input-tanggal').value = data.tanggal;
                    document.getElementById('koin-input-petugas').value = data.petugas;
                    document.getElementById('koin-input-hp').value = data.hp;
                    document.getElementById('koin-input-donatur').value = data.donatur;
                    document.getElementById('koin-input-alamat').value = data.alamat;
                    document.getElementById('koin-input-nominal').value = data.nominal;
                    document.querySelector('#koin-module .form-actions button:first-child').textContent = 'Update Data';
                    document.getElementById('koin-reset-btn').textContent = 'Batal Edit';
                    koinEditId = id;
                }
            } else if (module === 'jurnal') {
                const data = jurnalData.find(d => d.id == id);
                if (data) {
                    document.getElementById('jurnal-input-tanggal').value = data.tanggal;
                    document.getElementById('jurnal-input-keterangan').value = data.keterangan;
                    document.getElementById('jurnal-input-kategori').value = data.kategori;
                    document.getElementById('jurnal-input-masuk').value = data.masuk;
                    document.getElementById('jurnal-input-keluar').value = data.keluar;
                    document.querySelector('#jurnal-module .form-actions button:first-child').textContent = 'Update Data';
                    document.getElementById('jurnal-reset-btn').textContent = 'Batal Edit';
                    jurnalEditId = id;
                }
            }
        }

        function deleteData(module, id) {
            if (!isLoggedIn) {
                alert('Anda harus login sebagai admin untuk menghapus data.');
                logout(); // Panggil login screen
                return;
            }
            
            if (module === 'jurnal') {
                const dataToDelete = jurnalData.find(d => d.id == id);
                if (dataToDelete && dataToDelete.kategori === categories.saldo_bln_lalu) {
                    alert("Entri Saldo Awal Tahun tidak dapat dihapus, hanya dapat diedit melalui Laporan Tahunan."); 
                    return;
                }
            }
            
            if (!confirm("Yakin ingin menghapus data ini?")) return;

            let collectionName;
            
            if (module === 'koin') {
                collectionName = 'koin_nu';
            } else if (module === 'jurnal') {
                collectionName = 'jurnal_umum';
            } else {
                return;
            }
            
            const docRef = window.doc(window.db, collectionName, id);
            window.deleteDoc(docRef)
                .then(() => {
                    alert(`Data ${module.toUpperCase()} berhasil dihapus dari Firebase!`);
                })
                .catch((error) => {
                    console.error("Error removing document: ", error);
                    alert('Gagal menghapus data dari Firebase.');
                });
        }
        
        function saveAnnualSaldoAwal() {
            if (!isLoggedIn) {
                alert('Anda harus login sebagai admin untuk mengatur Saldo Awal.');
                logout(); // Panggil login screen
                return;
            }
            const year = parseInt(document.getElementById('tahunan-filter-tahun').value);
            const saldoAwal = parseInt(document.getElementById('annual-saldo-awal-input').value) || 0;
            
            annualData[year] = saldoAwal;
            saveData('annual'); 
            alert(`Saldo Awal Tahun ${year} berhasil disimpan: ${formatRupiah(saldoAwal)}`);
            filterData('tahunan');
        }

        // --- RENDER FUNCTIONS (Sama seperti sebelumnya) ---
        function filterKoinData(data, selectedMonth, selectedYear) {
            let totalNominal = 0;
            const filteredData = data.filter(item => {
                const itemDate = new Date(item.tanggal);
                const itemMonth = itemDate.getMonth() + 1; 
                const itemYear = itemDate.getFullYear();

                const isMonthMatch = selectedMonth === 0 || itemMonth === selectedMonth;
                const isYearMatch = selectedYear === 0 || itemYear === selectedYear;

                if (isMonthMatch && isYearMatch) {
                    totalNominal += item.nominal;
                    return true;
                }
                return false;
            });

            return { data: filteredData, totalNominal: totalNominal };
        }

        function renderKoinTable(data, summary) {
            const tableBody = document.querySelector('#koin-data-table tbody');
            const totalNominalCell = document.getElementById('koin-total-nominal');
            tableBody.innerHTML = '';

            data.forEach(item => {
                const row = tableBody.insertRow();
                row.innerHTML = `
                    <td>${item.id.substring(0, 4)}...</td>
                    <td>${formatDate(item.tanggal)}</td>
                    <td>${item.petugas}</td>
                    <td>${item.hp}</td>
                    <td>${item.donatur}</td>
                    <td>${item.alamat}</td>
                    <td>${formatRupiah(item.nominal)}</td>
                    <td class="action-cell">
                        <button class="edit-btn" onclick="editData('koin', '${item.id}')">Edit</button>
                        <button class="delete-btn" onclick="deleteData('koin', '${item.id}')">Hapus</button>
                    </td>
                `;
            });
            totalNominalCell.textContent = formatRupiah(summary.totalNominal);
        }

        function filterJurnalData(data, selectedMonth, selectedYear) {
            let totalMasuk = 0;
            let totalKeluar = 0;
            let saldoAkhir = 0;

            const filteredData = data.filter(item => {
                const itemDate = new Date(item.tanggal);
                const itemMonth = itemDate.getMonth() + 1;
                const itemYear = itemDate.getFullYear();

                const isMonthMatch = selectedMonth === 0 || itemMonth === selectedMonth;
                const isYearMatch = selectedYear === 0 || itemYear === selectedYear;

                if (isMonthMatch && isYearMatch) {
                    totalMasuk += item.masuk;
                    totalKeluar += item.keluar;
                    return true;
                }
                return false;
            });
            
            const allFilteredYear = data.filter(item => new Date(item.tanggal).getFullYear() === selectedYear);
            
            // Saldo awal tahun diambil dari annualData
            const saldoAwalTahun = annualData[selectedYear] || 0;
            saldoAkhir = saldoAwalTahun;
            
            allFilteredYear.forEach(item => {
                saldoAkhir += item.masuk;
                saldoAkhir -= item.keluar;
            });
            
            return { data: filteredData, totalMasuk: totalMasuk, totalKeluar: totalKeluar, saldoAkhir: saldoAkhir };
        }

        function renderJurnalTable(allData, selectedMonth, selectedYear) {
            const tableBody = document.querySelector('#jurnal-data-table tbody');
            tableBody.innerHTML = '';
            
            const summary = filterJurnalData(allData, selectedMonth, selectedYear);
            const dataToRender = summary.data;

            dataToRender.forEach(item => {
                const row = tableBody.insertRow();
                row.innerHTML = `
                    <td>${item.id.substring(0, 4)}...</td>
                    <td>${formatDate(item.tanggal)}</td>
                    <td>${item.keterangan}</td>
                    <td>${categoryMap[item.kategori] || item.kategori}</td>
                    <td style="color: green;">${formatRupiah(item.masuk)}</td>
                    <td style="color: red;">${formatRupiah(item.keluar)}</td>
                    <td class="action-cell">
                        <button class="edit-btn" onclick="editData('jurnal', '${item.id}')">Edit</button>
                        <button class="delete-btn" onclick="deleteData('jurnal', '${item.id}')">Hapus</button>
                    </td>
                `;
            });

            document.getElementById('jurnal-total-masuk').textContent = formatRupiah(summary.totalMasuk);
            document.getElementById('jurnal-total-keluar').textContent = formatRupiah(summary.totalKeluar);
            document.getElementById('jurnal-saldo-akhir').textContent = formatRupiah(summary.saldoAkhir);
        }

        function renderAnnualTable(year) {
            const tableBody = document.querySelector('#annual-data-table tbody');
            tableBody.innerHTML = '';
            document.getElementById('tahun-cetak-text').textContent = year;
            
            const allJurnal = jurnalData.filter(d => new Date(d.tanggal).getFullYear() == year);
            const allKoin = koinData.filter(d => new Date(d.tanggal).getFullYear() == year);

            let monthlySummary = {};
            let totalMasuk = 0;
            let totalKeluar = 0;
            let currentAkumulasi = 0;

            let saldoAwalTahun = annualData[year] || 0;
            currentAkumulasi = saldoAwalTahun;
            
            document.getElementById('annual-saldo-awal-input').value = saldoAwalTahun;
            
            const allTransactions = [...allJurnal];
            allKoin.forEach(koin => {
                allTransactions.push({
                    tanggal: koin.tanggal,
                    keterangan: `Donasi KOIN NU dari ${koin.donatur}`,
                    kategori: 'KOIN_NU',
                    masuk: koin.nominal,
                    keluar: 0
                });
            });

            for (let i = 1; i <= 12; i++) {
                monthlySummary[i] = { masuk: 0, keluar: 0, saldoBulan: 0 };
            }

            allTransactions.forEach(item => {
                const date = new Date(item.tanggal);
                const month = date.getMonth() + 1;
                
                if (monthlySummary[month]) {
                    monthlySummary[month].masuk += item.masuk || 0;
                    monthlySummary[month].keluar += item.keluar || 0;
                }
            });

            const months = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];
            
            months.forEach((monthName, index) => {
                const month = index + 1;
                const summary = monthlySummary[month];
                
                summary.saldoBulan = summary.masuk - summary.keluar;
                currentAkumulasi += summary.saldoBulan;
                
                totalMasuk += summary.masuk;
                totalKeluar += summary.keluar;

                const row = tableBody.insertRow();
                row.innerHTML = `
                    <td>${monthName.toUpperCase()}</td>
                    <td>${formatRupiah(summary.masuk)}</td>
                    <td>${formatRupiah(summary.keluar)}</td>
                    <td style="font-weight: bold;">${formatRupiah(summary.saldoBulan)}</td>
                    <td style="font-weight: bold;">${formatRupiah(currentAkumulasi)}</td>
                `;
            });
            
            document.getElementById('annual-total-masuk').textContent = formatRupiah(totalMasuk);
            document.getElementById('annual-total-keluar').textContent = formatRupiah(totalKeluar);
            document.getElementById('annual-total-saldo').textContent = formatRupiah(currentAkumulasi - saldoAwalTahun); 
            document.querySelector('#annual-data-table tfoot tr:last-child td:last-child').textContent = formatRupiah(currentAkumulasi);
        }

        // --- EXPORT & CETAK (Sama seperti sebelumnya) ---
        function exportTable(module) {
            // ... (Logika exportTable sama)
            let data = [];
            let filename = '';

            if (module === 'koin') {
                const filterBulan = document.getElementById('koin-filter-bulan').value;
                const filterTahun = document.getElementById('koin-filter-tahun').value;
                const summary = filterKoinData(koinData, parseInt(filterBulan), parseInt(filterTahun));
                data = summary.data;
                
                let headers = ["ID", "Tanggal", "Petugas", "No HP", "Donatur", "Alamat", "Nominal"];
                
                let csvContent = "data:text/csv;charset=utf-8,";
                csvContent += headers.join(";") + "\n";
                
                data.forEach(item => {
                    let row = [
                        item.id,
                        item.tanggal,
                        item.petugas,
                        item.hp,
                        item.donatur,
                        item.alamat,
                        item.nominal,
                    ];
                    csvContent += row.join(";") + "\n";
                });
                filename = `Laporan_KOIN_NU_${filterTahun}_Bulan_${filterBulan}.csv`;

            } else if (module === 'jurnal') {
                const filterBulan = document.getElementById('jurnal-filter-bulan').value;
                const filterTahun = document.getElementById('jurnal-filter-tahun').value;
                const summary = filterJurnalData(jurnalData, parseInt(filterBulan), parseInt(filterTahun));
                data = summary.data;
                
                let headers = ["ID", "Tanggal", "Keterangan", "Kategori", "Masuk", "Keluar"];
                
                let csvContent = "data:text/csv;charset=utf-8,";
                csvContent += headers.join(";") + "\n";
                
                data.forEach(item => {
                    let row = [
                        item.id,
                        item.tanggal,
                        item.keterangan,
                        categoryMap[item.kategori] || item.kategori,
                        item.masuk,
                        item.keluar,
                    ];
                    csvContent += row.join(";") + "\n";
                });
                filename = `Laporan_Jurnal_Umum_${filterTahun}_Bulan_${filterBulan}.csv`;

            } else {
                return;
            }
            
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", filename);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        function cetakLaporan() {
            const year = document.getElementById('tahunan-filter-tahun').value;
            const container = document.getElementById('laporan-tahunan-container');
            const actionHeader = container.querySelector('.module-header');
            const ttdArea = document.getElementById('ttd-area');
            const ttdDate = document.getElementById('tahun-cetak-date');
            
            const actionCells = container.querySelectorAll('.action-cell');
            
            const originalDisplay = actionHeader ? actionHeader.style.display : 'none';
            
            if (actionHeader) actionHeader.style.display = 'none';
            actionCells.forEach(cell => cell.style.display = 'none');
            if (ttdArea) ttdArea.style.display = 'flex';
            if (ttdDate) ttdDate.style.display = 'block';
            
            const date = new Date().toLocaleDateString('id-ID', {day: '2-digit', month: 'long', year: 'numeric'});
            document.getElementById('ttd-date-area').textContent = `Dicetak pada: Ngablak, ${date}`;

            const originalTableFontSize = '0.95em'; 
            const originalTablePadding = '8px';
            const annualTable = container.querySelector('#annual-data-table');
            if (annualTable) {
                 annualTable.style.fontSize = '8pt';
                 annualTable.querySelectorAll('th, td').forEach(el => {
                     el.style.padding = '3px';
                 });
            }
            
            html2canvas(container, { scale: 2 }).then(canvas => {
                const imgData = canvas.toDataURL('image/png');
                const { jsPDF } = window.jspdf;
                let pdf = new jsPDF('p', 'mm', 'a4');
                const imgProps = pdf.getImageProperties(imgData);
                const pdfWidth = pdf.internal.pageSize.getWidth();
                const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
                
                pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
                pdf.save(`Laporan_Tahunan_UPZIS_Ngablak_${year}.pdf`);

                if (actionHeader) actionHeader.style.display = originalDisplay;
                actionCells.forEach(cell => cell.style.display = isLoggedIn ? 'table-cell' : 'none');
                if (ttdArea) ttdArea.style.display = 'none';
                if (ttdDate) ttdDate.style.display = 'none';
                
                if (annualTable) {
                     annualTable.style.fontSize = originalTableFontSize;
                     annualTable.querySelectorAll('th, td').forEach(el => {
                         el.style.padding = originalTablePadding;
                     });
                }
            });
        }
        
        // --- MODIFIED: showModule (Untuk menyembunyikan/menampilkan form admin) ---
        function showModule(module) {
            currentModule = module;
            const modules = ['koin-module', 'jurnal-module', 'tahunan-module'];
            const navs = ['nav-koin', 'nav-jurnal', 'nav-tahunan'];
            
            // Sembunyikan semua modul utama
            modules.forEach(id => {
                const element = document.getElementById(id);
                if (element) element.style.display = 'none';
            });
            // Hapus kelas aktif dari navigasi
            navs.forEach(id => {
                const element = document.getElementById(id);
                if (element) element.classList.remove('active');
            });
            
            // Tampilkan modul yang diminta
            const moduleElement = document.getElementById(module + '-module');
            if (moduleElement) moduleElement.style.display = 'block';
            
            const navElement = document.getElementById('nav-' + module);
            if (navElement) navElement.classList.add('active');

            // Sembunyikan/Tampilkan Form Input dan Kolom Aksi berdasarkan status login
            const isInputVisible = isLoggedIn ? 'block' : 'none';
            const isActionCellVisible = isLoggedIn ? 'table-cell' : 'none';
            
            // Form Input Koin & Jurnal
            document.querySelector('#koin-module .form-input').style.display = isInputVisible;
            document.querySelector('#jurnal-module .form-input').style.display = isInputVisible;
            
            // Form Saldo Awal Tahunan
            document.getElementById('saldo-awal-form').style.display = isInputVisible; 
            
            // Kolom Aksi di Tabel Koin & Jurnal
            document.querySelectorAll('#koin-data-table .action-cell, #jurnal-data-table .action-cell').forEach(cell => {
                cell.style.display = isActionCellVisible;
            });
            document.querySelectorAll('#koin-data-table th:last-child, #jurnal-data-table th:last-child').forEach(th => {
                th.style.display = isActionCellVisible;
            });
            
            // Tampilkan tombol Admin Login / Logout
            const adminButton = document.querySelector('.logout-button');
            adminButton.textContent = isLoggedIn ? 'Logout Admin' : 'Admin Login';
            adminButton.style.backgroundColor = isLoggedIn ? '#e74c3c' : '#2980b9';
            
            // Panggil filterData untuk memuat data terbaru dan menyesuaikan tampilan
            filterData(module);
        }
        
        // --- DATA FILTER (Menggunakan Firebase Real-time) ---
        function filterData(module) {
            const today = new Date();
            const selectedMonth = parseInt(document.getElementById(module + '-filter-bulan')?.value || today.getMonth() + 1);
            const selectedYear = parseInt(document.getElementById(module + '-filter-tahun')?.value || today.getFullYear());
            
            if (module === 'koin' || module === 'jurnal') {
                let collectionName = module === 'koin' ? 'koin_nu' : 'jurnal_umum';
                
                if (window[`${module}Unsubscribe`]) {
                    window[`${module}Unsubscribe`](); 
                }
                
                const q = window.query(window.collection(window.db, collectionName), 
                                       window.orderBy("tanggal", "asc"));
                
                window[`${module}Unsubscribe`] = window.onSnapshot(q, (querySnapshot) => {
                    let dataArray = [];
                    querySnapshot.forEach((doc) => {
                        dataArray.push({ id: doc.id, ...doc.data() });
                    });
                    
                    if (module === 'koin') {
                        window.koinData = dataArray;
                        const filtered = filterKoinData(window.koinData, selectedMonth, selectedYear);
                        renderKoinTable(filtered.data, filtered);
                    } else if (module === 'jurnal') {
                        window.jurnalData = dataArray;
                        renderJurnalTable(window.jurnalData, selectedMonth, selectedYear);
                    }
                    
                    // Update tampilan aksi setelah data di-render
                    showModule(module); 
                });
                
                return;
            }

            if (module === 'tahunan') {
                renderAnnualTable(selectedYear);
                showModule(module); // Update tampilan aksi
            }
        }
        
        // --- INISIALISASI (Modified untuk Firebase Auth State) ---
        function init() {
            // Load Saldo Awal (annualData) dari Local Storage
            annualData = loadDataFromStorage(ANNUAL_KEY, annualData); 
            
            // 1. Inisialisasi Opsi Filter
            populateFilterOptions();
            
            // 2. Cek status login Firebase (jika sudah pernah login, akan otomatis terautentikasi)
            if (window.onAuthStateChanged) {
                 window.onAuthStateChanged(window.auth, (user) => {
                     if (user) {
                         isLoggedIn = true;
                         console.log("Admin sudah login otomatis.");
                     } else {
                         isLoggedIn = false;
                         console.log("Admin tidak login.");
                     }
                     // 3. Tampilkan modul default (KOIN NU)
                     showModule(currentModule); 
                 });
             } else {
                 // Fallback jika Firebase Auth gagal load
                 showModule(currentModule);
             }
        }

        document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
