<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Pembukuan UPZIS | Ranting Ngablak</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <style>
        /* Gaya CSS untuk Tampilan */
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; padding: 0; background-color: #f4f7f6; color: #333; }
        .container { padding: 20px; max-width: 100%; margin: auto; } /* Lebar Maksimum Disesuaikan */
        
        /* Gaya Navigasi */
        .navbar { background-color: #006400; color: white; padding: 10px 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.2); display: flex; align-items: center; justify-content: space-between; position: sticky; top: 0; z-index: 100; }
        .navbar-logo { font-size: 1.5rem; font-weight: bold; }
        .navbar-links button {
            background-color: transparent;
            color: white;
            border: none;
            padding: 8px 15px;
            cursor: pointer;
            font-size: 1rem;
            margin-left: 10px;
            border-radius: 4px;
            transition: background-color 0.3s;
        }
        .navbar-links button:hover, .navbar-links button.active {
            background-color: #004d00;
        }
        
        /* Gaya Formulir dan Kontrol */
        .form-group, .control-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: 600; }
        input[type="text"], input[type="number"], input[type="date"], select, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 1rem;
        }
        .button {
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
            transition: background-color 0.3s, opacity 0.3s;
            margin: 5px 0;
            display: inline-block;
        }
        .btn-green { background-color: #28a745; color: white; }
        .btn-green:hover { background-color: #1e7e34; }
        .btn-blue { background-color: #007bff; color: white; }
        .btn-blue:hover { background-color: #0056b3; }
        .btn-red { background-color: #dc3545; color: white; }
        .btn-red:hover { background-color: #c82333; }
        .btn-warning { background-color: #ffc107; color: #333; }
        .btn-warning:hover { background-color: #e0a800; }
        .btn-dark { background-color: #343a40; color: white; }
        .btn-dark:hover { background-color: #1d2124; }

        /* Gaya Tombol Aksi - PERBAIKAN */
        .action-btns {
            display: flex; 
            gap: 4px; /* Memberi jarak antar tombol */
            justify-content: center; /* Memastikan tombol di tengah div */
            align-items: center;
        }
        .action-btns button { 
            margin: 0; /* Hapus margin yang lama */
            font-size: 0.7rem; 
            padding: 5px; 
        }

        /* Gaya Tabel */
        .table-container { overflow-x: auto; margin-top: 20px; background-color: white; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        .data-table { width: 100%; border-collapse: collapse; min-width: 800px; }
        .data-table th, .data-table td {
            border: 1px solid #ddd;
            padding: 12px 8px;
            text-align: left;
        }
        .data-table th {
            background-color: #006400;
            color: white;
            text-transform: uppercase;
            font-size: 0.85rem;
        }
        .data-table tr:nth-child(even) { background-color: #f2f2f2; }
        .data-table tr:hover { background-color: #e9ecef; }
        .money-col { text-align: right; }
        .koin-pembagian-col { background-color: #f0fff0; }
        .saldo-entry { background-color: #ccffcc !important; font-weight: 600; }
        .auto-entry { background-color: #e3f2fd; } /* Entri otomatis (KOIN) di Jurnal Umum */

        /* Gaya Footer Total */
        .table-footer td {
            font-weight: bold;
            background-color: #004d00;
            color: white;
            border-top: 3px solid #003300;
        }

        /* Gaya Filter dan Kontrol Atas */
        .filter-controls {
            display: flex;
            gap: 15px;
            align-items: flex-end;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .filter-controls > div {
            flex-grow: 1;
            min-width: 150px;
        }
        .export-buttons {
            display: flex;
            gap: 10px;
        }

        /* Gaya Modal */
        .modal {
            display: none; 
            position: fixed; 
            z-index: 1000; 
            left: 0;
            top: 0;
            width: 100%; 
            height: 100%; 
            overflow: auto; 
            background-color: rgba(0,0,0,0.4); 
            padding-top: 60px;
        }
        .modal-content {
            background-color: #fefefe;
            margin: 5% auto; 
            padding: 20px;
            border: 1px solid #888;
            width: 80%; 
            max-width: 500px;
            border-radius: 8px;
            box-shadow: 0 4px 8px 0 rgba(0,0,0,0.2), 0 6px 20px 0 rgba(0,0,0,0.19);
            position: relative;
        }
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            position: absolute;
            top: 10px;
            right: 15px;
        }
        .close:hover,
        .close:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
        .modal h2 { margin-top: 0; color: #006400; }

        /* Login Button */
        #login-status {
            font-size: 0.9rem;
            color: #ccc;
            margin-right: 10px;
        }
        #login-button {
            padding: 8px 15px;
            background-color: #ffc107;
            color: #333;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }
        #login-button:hover { background-color: #e0a800; }
        
        /* Utility */
        .hidden { display: none !important; }

        /* Responsiveness */
        @media screen and (max-width: 768px) {
            .navbar { flex-direction: column; align-items: flex-start; }
            .navbar-links { margin-top: 10px; }
            .filter-controls { flex-direction: column; align-items: stretch; }
            .filter-controls > div { min-width: 100%; }
            .data-table { font-size: 0.8rem; }
            .data-table th, .data-table td { padding: 8px 5px; }
            .modal-content { width: 90%; }
        }
    </style>
</head>
<body>
    <div class="navbar">
        <div class="navbar-logo">Pembukuan UPZIS</div>
        <div class="navbar-links" id="navbar-links">
            <button id="koin-tab" class="active" onclick="switchTab('koin')">Laporan KOIN NU</button>
            <button id="jurnal-tab" onclick="switchTab('jurnal')">Jurnal Umum</button>
            <span id="login-status">Belum Login</span>
            <button id="login-button" onclick="showLoginModal()">Login</button>
        </div>
    </div>

    <div class="container">
        <div class="filter-controls">
            <div class="form-group">
                <label for="filter-month">Bulan</label>
                <select id="filter-month" onchange="filterData(window.currentTab)"></select>
            </div>
            <div class="form-group">
                <label for="filter-year">Tahun</label>
                <select id="filter-year" onchange="filterData(window.currentTab)"></select>
            </div>
            <div class="control-group">
                <button class="button btn-green" id="add-button" onclick="showAddModal()">+ Tambah Data</button>
            </div>
            <div class="control-group export-buttons">
                <button class="button btn-dark" onclick="exportToPdf(window.currentTab)">Export PDF</button>
                <button class="button btn-dark" onclick="exportToExcel(window.currentTab)">Export Excel</button>
            </div>
             <div class="control-group" id="delete-all-control" style="display: none;">
                <button class="button btn-red" onclick="deleteAllData(window.currentTab)">Hapus Semua Data</button>
            </div>
        </div>

        <div id="koin-nu-tab" class="tab-content">
            <h2>Laporan KOIN NU</h2>
            <div class="table-container">
                <table class="data-table" id="koin-table">
                    <thead>
                        <tr>
                            <th rowspan="2" style="width: 2%;">No</th>
                            <th rowspan="2" style="width: 10%;">Tanggal</th>
                            <th rowspan="2" style="width: 10%;">Nama Petugas</th>
                            <th rowspan="2" style="width: 8%;">No. HP</th>
                            <th rowspan="2" style="width: 10%;">Nama Donatur</th>
                            <th rowspan="2" style="width: 15%;">Alamat</th>
                            <th rowspan="2" style="width: 10%;">Nominal (Rp)</th>
                            <th colspan="4" style="text-align: center;">Pembagian (Rp) (10:60:25:5)</th>
                            <th rowspan="2" id="koin-aksi-header" style="display: none; width: 15%;">Aksi</th>
                        </tr>
                        <tr>
                            <th class="koin-pembagian-col" style="width: 6%;">Petugas (10%)</th>
                            <th class="koin-pembagian-col" style="width: 8%;">Ranting (60%)</th>
                            <th class="koin-pembagian-col" style="width: 8%;">MWC (25%)</th>
                            <th class="koin-pembagian-col" style="width: 5%;">PC (5%)</th>
                        </tr>
                    </thead>
                    <tbody id="koin-data-body">
                        </tbody>
                    <tfoot class="table-footer">
                        <tr>
                            <td colspan="6" style="text-align: right;">TOTAL</td>
                            <td id="koin-total-nominal" class="money-col">0</td>
                            <td id="koin-total-petugas" class="money-col koin-pembagian-col">0</td>
                            <td id="koin-total-ranting" class="money-col koin-pembagian-col">0</td>
                            <td id="koin-total-mwc" class="money-col koin-pembagian-col">0</td>
                            <td id="koin-total-pc" class="money-col koin-pembagian-col">0</td>
                            <td id="koin-total-aksi" style="display: none;"></td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>

        <div id="jurnal-umum-tab" class="tab-content hidden">
            <h2>Jurnal Umum</h2>
            <div class="table-container">
                <table class="data-table" id="jurnal-table">
                    <thead>
                        <tr>
                            <th style="width: 2%;">No</th>
                            <th style="width: 10%;">Tanggal</th>
                            <th style="width: 30%;">Keterangan</th>
                            <th style="width: 15%;">Kategori</th>
                            <th style="width: 10%;">Masuk (Rp)</th>
                            <th style="width: 10%;">Keluar (Rp)</th>
                            <th style="width: 10%;">Saldo (Rp)</th>
                            <th id="jurnal-aksi-header" style="display: none; width: 13%;">Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="jurnal-data-body">
                        </tbody>
                    <tfoot class="table-footer">
                        <tr>
                            <td colspan="4" style="text-align: right;">TOTAL</td>
                            <td id="jurnal-total-masuk" class="money-col">0</td>
                            <td id="jurnal-total-keluar" class="money-col">0</td>
                            <td id="jurnal-saldo-akhir" class="money-col">0</td>
                            <td id="jurnal-total-aksi" style="display: none;"></td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>
    </div>

    <div id="data-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('data-modal')">&times;</span>
            <h2 id="modal-title">Tambah Data</h2>
            <form id="data-form">
                <input type="hidden" id="data-id">
                <input type="hidden" id="data-module">

                <div id="koin-fields" class="hidden">
                    <div class="form-group">
                        <label for="koin-tanggal">Tanggal</label>
                        <input type="date" id="koin-tanggal" required>
                    </div>
                    <div class="form-group">
                        <label for="koin-petugas">Nama Petugas</label>
                        <input type="text" id="koin-petugas" required>
                    </div>
                    <div class="form-group">
                        <label for="koin-hp">No. HP</label>
                        <input type="text" id="koin-hp">
                    </div>
                    <div class="form-group">
                        <label for="koin-donatur">Nama Donatur</label>
                        <input type="text" id="koin-donatur" required>
                    </div>
                    <div class="form-group">
                        <label for="koin-alamat">Alamat</label>
                        <textarea id="koin-alamat"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="koin-nominal">Nominal (Rp)</label>
                        <input type="number" id="koin-nominal" min="0" required>
                    </div>
                </div>

                <div id="jurnal-fields" class="hidden">
                    <div class="form-group">
                        <label for="jurnal-tanggal">Tanggal</label>
                        <input type="date" id="jurnal-tanggal" required>
                    </div>
                    <div class="form-group">
                        <label for="jurnal-kategori">Kategori</label>
                        <select id="jurnal-kategori" required>
                            <option value="">Pilih Kategori</option>
                            <option value="Infaq/Shodaqoh">Infaq/Shodaqoh</option>
                            <option value="Penerimaan Transfer Ranting">Penerimaan Transfer Ranting</option>
                            <option value="Operasional">Operasional</option>
                            <option value="Bantuan/Penyaluran">Bantuan/Penyaluran</option>
                            <option value="Lain-lain Masuk">Lain-lain Masuk</option>
                            <option value="Lain-lain Keluar">Lain-lain Keluar</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="jurnal-keterangan">Keterangan</label>
                        <textarea id="jurnal-keterangan" required></textarea>
                    </div>
                    <div class="form-group">
                        <label for="jurnal-masuk">Masuk (Rp)</label>
                        <input type="number" id="jurnal-masuk" min="0">
                    </div>
                    <div class="form-group">
                        <label for="jurnal-keluar">Keluar (Rp)</label>
                        <input type="number" id="jurnal-keluar" min="0">
                    </div>
                </div>

                <button type="submit" class="button btn-green" id="save-button">Simpan</button>
                <button type="button" class="button btn-warning" onclick="closeModal('data-modal')">Batal</button>
            </form>
        </div>
    </div>

    <div id="login-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('login-modal')">&times;</span>
            <h2>Login Admin</h2>
            <div class="form-group">
                <label for="admin-password">Password</label>
                <input type="password" id="admin-password" placeholder="Masukkan Password" required>
            </div>
            <button class="button btn-blue" onclick="login()">Login</button>
        </div>
    </div>

    <div id="saldo-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('saldo-modal')">&times;</span>
            <h2>Edit Saldo Bulan Lalu</h2>
            <div class="form-group">
                <label for="saldo-nominal">Saldo Bulan Lalu (Rp)</label>
                <input type="number" id="saldo-nominal" min="0" required>
                <input type="hidden" id="saldo-bulan">
                <input type="hidden" id="saldo-tahun">
            </div>
            <button class="button btn-green" onclick="saveSaldoBulanLalu()">Simpan Saldo</button>
            <button type="button" class="button btn-warning" onclick="closeModal('saldo-modal')">Batal</button>
        </div>
    </div>

    <script type="module">
        // --- KONFIGURASI FIREBASE ---
        // GANTI DENGAN KONFIGURASI FIREBASE ANDA SENDIRI
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_PROJECT_ID.appspot.com",
            messagingSenderId: "YOUR_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        // Inisialisasi Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Nama Koleksi
        const COL_KOIN = "koin";
        const COL_JURNAL = "jurnal";
        const COL_SETTINGS = "settings";

        // Global State
        window.currentTab = 'koin';
        window.isLoggedIn = false;
        window.allData = {
            koin: [],
            jurnal: []
        };
        window.currentFilter = {};
        const ADMIN_PASS = "adminupzis"; // GANTI DENGAN PASSWORD ADMIN AMAN

        // --- UTILITY FUNCTIONS ---

        // Helper untuk format rupiah
        window.formatRupiah = (number) => {
            return new Intl.NumberFormat('id-ID', {
                style: 'currency',
                currency: 'IDR',
                minimumFractionDigits: 0
            }).format(number);
        };

        // Helper untuk format tanggal
        window.formatTanggal = (dateString) => {
            if (!dateString) return '-';
            const options = { day: '2-digit', month: '2-digit', year: 'numeric' };
            try {
                return new Date(dateString).toLocaleDateString('id-ID', options);
            } catch (e) {
                return dateString;
            }
        };

        // Helper untuk filter data per bulan/tahun
        const getFilteredData = (module) => {
            const { month, year } = window.currentFilter;
            return window.allData[module].filter(d => {
                const date = d.tanggal;
                const dMonth = new Date(date).getMonth() + 1; // getMonth() is 0-indexed
                const dYear = new Date(date).getFullYear();

                const monthMatch = month === 'all' || dMonth.toString() === month;
                const yearMatch = dYear.toString() === year;

                return monthMatch && yearMatch;
            }).sort((a, b) => new Date(a.tanggal) - new Date(b.tanggal));
        };
        
        // --- LOAD DATA FROM FIREBASE ---
        
        const loadCollection = async (collectionName) => {
            try {
                const snapshot = await db.collection(collectionName).get();
                return snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            } catch (e) {
                console.error(`Error loading ${collectionName}: `, e);
                return [];
            }
        };

        const loadAllCollections = async () => {
            const [koinData, jurnalData] = await Promise.all([
                loadCollection(COL_KOIN),
                loadCollection(COL_JURNAL)
            ]);
            window.allData.koin = koinData;
            window.allData.jurnal = jurnalData;
        };
        
        // --- LOGIN/LOGOUT LOGIC ---

        const updateLoginStatus = () => {
            const statusElement = document.getElementById('login-status');
            const buttonElement = document.getElementById('login-button');
            const addButton = document.getElementById('add-button');
            const deleteAllControl = document.getElementById('delete-all-control');

            if (window.isLoggedIn) {
                statusElement.textContent = "Admin Login";
                buttonElement.textContent = "Logout";
                buttonElement.onclick = logout;
                addButton.classList.remove('hidden');
                deleteAllControl.style.display = 'block';
            } else {
                statusElement.textContent = "Belum Login";
                buttonElement.textContent = "Login";
                buttonElement.onclick = showLoginModal;
                addButton.classList.add('hidden');
                deleteAllControl.style.display = 'none';
            }
            // Force re-render tables to show/hide action column
            filterData(window.currentTab);
        };

        window.login = () => {
            const password = document.getElementById('admin-password').value;
            if (password === ADMIN_PASS) {
                window.isLoggedIn = true;
                closeModal('login-modal');
                updateLoginStatus();
                alert("Login Berhasil!");
            } else {
                alert("Password Salah.");
            }
            document.getElementById('admin-password').value = '';
        };

        window.logout = () => {
            window.isLoggedIn = false;
            updateLoginStatus();
            alert("Logout Berhasil!");
        };

        window.showLoginModal = () => {
            if (!window.isLoggedIn) {
                document.getElementById('login-modal').style.display = 'block';
            }
        };

        // --- MODAL CONTROLS ---

        window.closeModal = (id) => {
            document.getElementById(id).style.display = 'none';
        };

        window.showAddModal = () => {
            if (!window.isLoggedIn) {
                alert('Silakan login sebagai admin untuk menambah data.');
                return;
            }
            const module = window.currentTab;
            const modal = document.getElementById('data-modal');
            const form = document.getElementById('data-form');

            // Reset form
            form.reset();
            document.getElementById('data-id').value = '';
            document.getElementById('data-module').value = module;
            document.getElementById('modal-title').textContent = `Tambah Data ${module === 'koin' ? 'KOIN NU' : 'Jurnal Umum'}`;

            // Tampilkan field yang sesuai
            document.getElementById('koin-fields').classList.toggle('hidden', module !== 'koin');
            document.getElementById('jurnal-fields').classList.toggle('hidden', module !== 'jurnal');

            // Set tanggal hari ini sebagai default
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('koin-tanggal').value = today;
            document.getElementById('jurnal-tanggal').value = today;

            modal.style.display = 'block';
        };
        
        window.editData = async (module, id, month, year, saldo) => {
            if (!window.isLoggedIn) {
                alert('Silakan login sebagai admin untuk mengedit data.');
                return;
            }
            
            // Logika Khusus untuk Saldo Bulan Lalu
            if (id === 'saldo-bulan-lalu-edit') {
                document.getElementById('saldo-nominal').value = saldo;
                document.getElementById('saldo-bulan').value = month;
                document.getElementById('saldo-tahun').value = year;
                document.getElementById('saldo-modal').style.display = 'block';
                return;
            }

            const dataToEdit = window.allData[module].find(d => d.id === id);
            if (!dataToEdit) return alert('Data tidak ditemukan.');

            const modal = document.getElementById('data-modal');
            const form = document.getElementById('data-form');

            // Reset form
            form.reset();
            document.getElementById('data-id').value = id;
            document.getElementById('data-module').value = module;
            document.getElementById('modal-title').textContent = `Edit Data ${module === 'koin' ? 'KOIN NU' : 'Jurnal Umum'}`;

            // Tampilkan field yang sesuai
            document.getElementById('koin-fields').classList.toggle('hidden', module !== 'koin');
            document.getElementById('jurnal-fields').classList.toggle('hidden', module !== 'jurnal');

            // Isi form
            if (module === 'koin') {
                document.getElementById('koin-tanggal').value = dataToEdit.tanggal;
                document.getElementById('koin-petugas').value = dataToEdit.petugas;
                document.getElementById('koin-hp').value = dataToEdit.hp;
                document.getElementById('koin-donatur').value = dataToEdit.donatur;
                document.getElementById('koin-alamat').value = dataToEdit.alamat;
                document.getElementById('koin-nominal').value = dataToEdit.nominal;
            } else if (module === 'jurnal') {
                document.getElementById('jurnal-tanggal').value = dataToEdit.tanggal;
                document.getElementById('jurnal-kategori').value = dataToEdit.kategori;
                document.getElementById('jurnal-keterangan').value = dataToEdit.keterangan;
                document.getElementById('jurnal-masuk').value = dataToEdit.masuk || 0;
                document.getElementById('jurnal-keluar').value = dataToEdit.keluar || 0;
            }

            modal.style.display = 'block';
        };

        // --- SAVE/DELETE DATA ---

        window.saveData = async (e) => {
            e.preventDefault();
            if (!window.isLoggedIn) return;

            const id = document.getElementById('data-id').value;
            const module = document.getElementById('data-module').value;
            const collectionRef = db.collection(module === 'koin' ? COL_KOIN : COL_JURNAL);
            
            let data = {};
            
            try {
                if (module === 'koin') {
                    data = {
                        tanggal: document.getElementById('koin-tanggal').value,
                        petugas: document.getElementById('koin-petugas').value,
                        hp: document.getElementById('koin-hp').value,
                        donatur: document.getElementById('koin-donatur').value,
                        alamat: document.getElementById('koin-alamat').value,
                        nominal: parseFloat(document.getElementById('koin-nominal').value),
                        createdAt: id ? data.createdAt : firebase.firestore.FieldValue.serverTimestamp()
                    };
                } else if (module === 'jurnal') {
                    const masuk = parseFloat(document.getElementById('jurnal-masuk').value) || 0;
                    const keluar = parseFloat(document.getElementById('jurnal-keluar').value) || 0;
                    if (masuk > 0 && keluar > 0) {
                        return alert('Jurnal tidak boleh memiliki nilai Masuk dan Keluar sekaligus. Pilih salah satu atau kosongkan.');
                    }
                    data = {
                        tanggal: document.getElementById('jurnal-tanggal').value,
                        kategori: document.getElementById('jurnal-kategori').value,
                        keterangan: document.getElementById('jurnal-keterangan').value,
                        masuk: masuk,
                        keluar: keluar,
                        type: 'manual', // Entri manual selalu type 'manual'
                        createdAt: id ? data.createdAt : firebase.firestore.FieldValue.serverTimestamp()
                    };
                }

                if (id) {
                    await collectionRef.doc(id).update(data);
                    alert("Data berhasil diupdate!");
                } else {
                    await collectionRef.add(data);
                    alert("Data berhasil ditambahkan!");
                }
                
                closeModal('data-modal');
                await loadAllCollections();
                filterData(module);

            } catch (e) {
                console.error("Error saving data: ", e);
                alert("Gagal menyimpan data: " + e.message);
            }
        };
        document.getElementById('data-form').addEventListener('submit', window.saveData);

        window.deleteData = async (module, id) => {
            if (!window.isLoggedIn) {
                alert('Silakan login sebagai admin untuk melakukan aksi ini.');
                return;
            }
            if (!confirm(`Yakin ingin menghapus data ini?`)) return;

            try {
                await db.collection(module === 'koin' ? COL_KOIN : COL_JURNAL).doc(id).delete();
                alert("Data berhasil dihapus.");
                await loadAllCollections();
                filterData(module);
            } catch (e) {
                console.error("Error deleting data: ", e);
                alert("Gagal menghapus data: " + e.message);
            }
        };
        
        window.deleteAllData = async (module) => {
            if (!window.isLoggedIn) return alert('Silakan login sebagai admin untuk melakukan aksi ini.');
            if (!confirm('Yakin ingin menghapus SEMUA DATA pada modul ini? Tindakan ini tidak bisa dibatalkan.')) return;

            try {
                if (module === 'koin') {
                    // fetch all docs in koin and delete
                    const snap = await firebase.firestore().collection(COL_KOIN).get();
                    const batch = firebase.firestore().batch();
                    snap.docs.forEach(d => batch.delete(d.ref));
                    await batch.commit();
                } else if (module === 'jurnal') {
                    const snap = await firebase.firestore().collection(COL_JURNAL).get();
                    const batch = firebase.firestore().batch();
                    // Hanya hapus entri 'manual', entri 'auto' tidak ada di koleksi jurnal.
                    // Jika ada entri auto dari koin yang tercatat di jurnal, mereka tidak akan terpengaruh karena ini hanya menghapus koleksi COL_JURNAL
                    snap.docs.forEach(d => batch.delete(d.ref));
                    await batch.commit();
                }
                alert('Semua data dihapus.');
                await loadAllCollections();
                filterData(module);
            } catch(e){ console.error(e); alert('Gagal menghapus semua data: '+e.message); }
        };

        // --- SALDO AWAL LOGIC ---
        
        const getSaldoBulanLalu = async (month, year) => {
            // Saldo bulan lalu dihitung berdasarkan saldo akhir bulan sebelumnya.
            // Untuk mempermudah, kita akan cek entri saldo_awal_manual yang disimpan di koleksi settings
            // Untuk bulan/tahun yang sedang difilter.

            if (month === 'all') return 0; // Tidak bisa menghitung saldo awal jika filter 'all'

            let prevMonth, prevYear;
            if (month === '1') {
                prevMonth = '12';
                prevYear = (parseInt(year) - 1).toString();
            } else {
                prevMonth = (parseInt(month) - 1).toString();
                if (prevMonth.length === 1) prevMonth = '0' + prevMonth; // Format '01'
                prevYear = year;
            }
            
            // 1. Cek apakah ada saldo_awal_manual untuk bulan saat ini (hanya untuk set awal)
            try {
                const docRef = db.collection(COL_SETTINGS).doc(`saldo_awal_${month}_${year}`);
                const docSnap = await docRef.get();
                if (docSnap.exists) {
                    return docSnap.data().nominal;
                }
            } catch (e) {
                console.warn('Gagal cek saldo awal manual:', e);
            }


            // 2. Jika tidak ada saldo manual, hitung saldo akhir bulan sebelumnya
            // Note: Perhitungan Saldo bulan lalu ini kompleks dan bisa memakan waktu/biaya.
            // Untuk aplikasi sederhana, kita asumsikan saldo awal didapat dari input manual.
            
            // Cek saldo akhir bulan sebelumnya (hanya dari Jurnal)
            const allJurnal = window.allData.jurnal;
            let saldoPrevMonth = 0;
            
            // Filter jurnal bulan sebelumnya
            const filteredPrevJurnal = allJurnal.filter(d => {
                const dMonth = (new Date(d.tanggal).getMonth() + 1).toString();
                const dYear = (new Date(d.tanggal).getFullYear()).toString();
                return dMonth === prevMonth && dYear === prevYear;
            }).sort((a, b) => new Date(a.tanggal) - new Date(b.tanggal));

            // Jika ada data bulan lalu, hitung saldo akhirnya
            if (filteredPrevJurnal.length > 0) {
                // Di sini Anda HARUS menghitung saldo awal BULAN LALU (dari Saldo Awal TAHUN/BULAN LALU Manual)
                // Ditambah semua transaksi Masuk/Keluar bulan lalu.
                // Karena kita hanya menyimpan Saldo Awal Manual di setting, kita akan tetap mengandalkan input manual.
                
                // Jika ingin menghitung dari saldo akhir bulan lalu, Anda perlu memanggil rekursif getSaldoBulanLalu
                // Namun, untuk menghindari infinite loop atau complexity, kita cukup meminta input manual
                // ATAU menggunakan nilai dari field saldo_awal_manual.
                
                // Dapatkan saldo awal bulan sebelumnya
                const saldoAwalBulanLalu = await getSaldoBulanLalu(prevMonth, prevYear);
                let currentSaldo = saldoAwalBulanLalu;
                
                for(const d of filteredPrevJurnal) {
                    currentSaldo += d.masuk;
                    currentSaldo -= d.keluar;
                }
                saldoPrevMonth = currentSaldo;
            }

            return saldoPrevMonth; // Return 0 jika tidak ada data bulan sebelumnya
        };

        window.saveSaldoBulanLalu = async () => {
            if (!window.isLoggedIn) return;

            const nominal = parseFloat(document.getElementById('saldo-nominal').value) || 0;
            const month = document.getElementById('saldo-bulan').value;
            const year = document.getElementById('saldo-tahun').value;
            
            if (nominal < 0) return alert('Saldo tidak boleh negatif.');

            try {
                // Simpan di koleksi settings
                const docRef = db.collection(COL_SETTINGS).doc(`saldo_awal_${month}_${year}`);
                await docRef.set({ nominal: nominal });
                alert('Saldo Bulan Lalu berhasil disimpan.');

                closeModal('saldo-modal');
                // Reload data dan filter
                await loadAllCollections();
                filterData(window.currentTab);
            } catch (e) {
                console.error('Error saving saldo:', e);
                alert('Gagal menyimpan saldo: ' + e.message);
            }
        };

        // --- TAB & FILTER CONTROLS ---

        window.switchTab = (tab) => {
            window.currentTab = tab;
            document.getElementById('koin-tab').classList.remove('active');
            document.getElementById('jurnal-tab').classList.remove('active');
            document.getElementById(`${tab}-tab`).classList.add('active');

            document.getElementById('koin-nu-tab').classList.add('hidden');
            document.getElementById('jurnal-umum-tab').classList.add('hidden');
            document.getElementById(`${tab}-nu-tab` || `${tab}-umum-tab`).classList.remove('hidden');
            
            filterData(tab);
        };

        const populateFilterOptions = () => {
            const currentYear = new Date().getFullYear();
            const monthSelect = document.getElementById('filter-month');
            const yearSelect = document.getElementById('filter-year');
            
            // Isi pilihan Bulan
            const months = ['01', '02', '03', '04', '05', '06', '07', '08', '09', '10', '11', '12'];
            const monthNames = ["Semua Bulan", "Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];
            
            monthSelect.innerHTML = `<option value="all">${monthNames[0]}</option>`;
            months.forEach((m, index) => {
                const option = document.createElement('option');
                option.value = m;
                option.textContent = monthNames[index + 1];
                monthSelect.appendChild(option);
            });
            
            // Isi pilihan Tahun
            const startYear = 2023; // Tahun mulai data
            yearSelect.innerHTML = '';
            for (let y = currentYear + 1; y >= startYear; y--) {
                const option = document.createElement('option');
                option.value = y.toString();
                option.textContent = y.toString();
                if (y === currentYear) {
                    option.selected = true;
                }
                yearSelect.appendChild(option);
            }
            
            // Set filter awal
            window.currentFilter.month = (new Date().getMonth() + 1).toString().padStart(2, '0');
            window.currentFilter.year = currentYear.toString();
            monthSelect.value = window.currentFilter.month;
            yearSelect.value = window.currentFilter.year;
        };

        window.filterData = async (module) => {
            window.currentFilter.month = document.getElementById('filter-month').value;
            window.currentFilter.year = document.getElementById('filter-year').value;
            
            const filteredData = getFilteredData(module);

            if (module === 'koin') {
                const total = filteredData.reduce((acc, d) => {
                    const nominal = d.nominal;
                    const petugas = Math.round(nominal * 0.10);
                    const ranting = Math.round(nominal * 0.60);
                    const mwc = Math.round(nominal * 0.25);
                    const pc = Math.round(nominal * 0.05);
                    const selisih = nominal - (petugas + ranting + mwc + pc);
                    const rantingFixed = ranting + selisih;

                    acc.totalNominal += nominal;
                    acc.petugas += petugas;
                    acc.ranting += rantingFixed;
                    acc.mwc += mwc;
                    acc.pc += pc;
                    return acc;
                }, { totalNominal: 0, petugas: 0, ranting: 0, mwc: 0, pc: 0 });

                renderKoinTable(filteredData, total);
            } else if (module === 'jurnal') {
                const saldoBulanLalu = await getSaldoBulanLalu(window.currentFilter.month, window.currentFilter.year);
                
                // Tambahkan entri otomatis dari rekapitulasi Koin NU
                const autoEntries = getJurnalAutoEntries(window.currentFilter.month, window.currentFilter.year);
                const allJurnal = [...filteredData, ...autoEntries].sort((a, b) => new Date(a.tanggal) - new Date(b.tanggal));

                renderJurnalTable(allJurnal, saldoBulanLalu);
            }
            
            // Update UI
            document.getElementById('add-button').textContent = `+ Tambah Data ${module === 'koin' ? 'KOIN NU' : 'Jurnal'}`;
        };
        
        // --- DATA JURNAL OTOMATIS DARI KOIN NU ---
        
        const getJurnalAutoEntries = (month, year) => {
            const allKoin = window.allData.koin;
            
            // 1. Filter Koin berdasarkan bulan dan tahun
            const filteredKoin = allKoin.filter(d => {
                const date = d.tanggal;
                const dMonth = (new Date(date).getMonth() + 1).toString().padStart(2, '0');
                const dYear = new Date(date).getFullYear().toString();
                return dMonth === month && dYear === year;
            });
            
            if (filteredKoin.length === 0) return [];
            
            // 2. Hitung total rekapitulasi bulanan
            const totalKoin = filteredKoin.reduce((acc, d) => {
                const nominal = d.nominal;
                const petugas = Math.round(nominal * 0.10);
                const ranting = Math.round(nominal * 0.60);
                const mwc = Math.round(nominal * 0.25);
                const pc = Math.round(nominal * 0.05);
                const selisih = nominal - (petugas + ranting + mwc + pc);
                const rantingFixed = ranting + selisih;
                
                acc.penerimaan += nominal;
                acc.petugas += petugas;
                acc.ranting += rantingFixed;
                acc.mwc += mwc;
                acc.pc += pc;
                return acc;
            }, { penerimaan: 0, petugas: 0, ranting: 0, mwc: 0, pc: 0 });
            
            const monthName = new Date(year, parseInt(month) - 1, 1).toLocaleString('id-ID', { month: 'long', year: 'numeric' });
            
            // 3. Buat Entri Jurnal Otomatis
            // Asumsi: Semua transaksi Koin dicatat pada tanggal terakhir bulan yang difilter
            const lastDayOfMonth = new Date(year, parseInt(month), 0).toISOString().split('T')[0];

            const entries = [];
            
            // a. Penerimaan Koin (Masuk)
            if (totalKoin.penerimaan > 0) {
                entries.push({
                    id: `koin-in-${month}-${year}`,
                    tanggal: lastDayOfMonth,
                    keterangan: `Penerimaan Dana Koin NU Bulan ${monthName} (Total: ${filteredKoin.length} Transaksi)`,
                    kategori: 'Penerimaan Koin NU',
                    masuk: totalKoin.penerimaan,
                    keluar: 0,
                    type: 'auto'
                });
            }

            // b. Penyaluran/Pembagian (Keluar)
            const totalKeluar = totalKoin.petugas + totalKoin.ranting + totalKoin.mwc + totalKoin.pc;
            if (totalKeluar > 0) {
                entries.push({
                    id: `koin-out-${month}-${year}`,
                    tanggal: lastDayOfMonth,
                    keterangan: `Penyaluran Koin NU Bulan ${monthName} (Pembagian Petugas, Ranting, MWC, PC)`,
                    kategori: 'Penyaluran Koin NU',
                    masuk: 0,
                    keluar: totalKeluar,
                    type: 'auto'
                });
            }

            return entries;
        };

        // --- RENDER TABLE FUNCTIONS ---

        // Fungsi Render KOIN NU Table (DIPERBAIKI)
        function renderKoinTable(data, total) {
            const tableBody = document.getElementById('koin-data-body');
            tableBody.innerHTML = '';
            
            if (data.length === 0) {
                const row = tableBody.insertRow();
                row.innerHTML = `<td colspan="12" style="text-align: center; font-style: italic;">Tidak ada data Koin NU untuk periode ini.</td>`;
                // Colspan diubah dari 11 menjadi 12 karena ada 12 kolom sekarang (termasuk Aksi)
            }

            data.forEach((d, index) => {
                const row = tableBody.insertRow();
                const nominal = d.nominal;
                const petugas = Math.round(nominal * 0.10);
                const ranting = Math.round(nominal * 0.60);
                const mwc = Math.round(nominal * 0.25);
                const pc = Math.round(nominal * 0.05);
                const selisih = nominal - (petugas + ranting + mwc + pc);
                const rantingFixed = ranting + selisih;

                let actionCellContent;
                if (window.isLoggedIn) {
                    const idString = `'${d.id}'`;
                    // Perbaikan: Tambahkan wrapper div dan centring melalui CSS
                    actionCellContent = ` 
                        <div class="action-btns">
                            <button class="button btn-blue" onclick="editData('koin', ${idString})">Edit</button> 
                            <button class="button btn-red" onclick="deleteData('koin', ${idString})">Hapus</button> 
                        </div>
                    `;
                } else {
                    actionCellContent = ''; // Kosong jika tidak login
                }

                row.innerHTML = `
                    <td style="text-align: center;">${index + 1}</td>
                    <td>${window.formatTanggal(d.tanggal)}</td>
                    <td>${d.petugas}</td>
                    <td id="koin-hp-cell">${d.hp}</td>
                    <td>${d.donatur}</td>
                    <td id="koin-alamat-cell">${d.alamat}</td>
                    <td class="money-col">${window.formatRupiah(nominal)}</td>
                    <td class="money-col koin-pembagian-col">${window.formatRupiah(petugas)}</td>
                    <td class="money-col koin-pembagian-col">${window.formatRupiah(rantingFixed)}</td>
                    <td class="money-col koin-pembagian-col">${window.formatRupiah(mwc)}</td>
                    <td class="money-col koin-pembagian-col">${window.formatRupiah(pc)}</td>
                    <td style="display: ${window.isLoggedIn ? 'table-cell' : 'none'}; text-align: center; vertical-align: middle;">${actionCellContent}</td>
                `;
            });

            // Update Footer Totals
            document.getElementById('koin-total-nominal').textContent = window.formatRupiah(total.totalNominal);
            document.getElementById('koin-total-petugas').textContent = window.formatRupiah(total.petugas);
            document.getElementById('koin-total-ranting').textContent = window.formatRupiah(total.ranting);
            document.getElementById('koin-total-mwc').textContent = window.formatRupiah(total.mwc);
            document.getElementById('koin-total-pc').textContent = window.formatRupiah(total.pc);

            document.getElementById('koin-aksi-header').style.display = window.isLoggedIn ? 'table-cell' : 'none';
            document.getElementById('koin-total-aksi').style.display = window.isLoggedIn ? 'table-cell' : 'none';
        }

        // Fungsi Render Jurnal Umum Table (DIPERBAIKI)
        function renderJurnalTable(data, saldoBulanLalu) {
            const tableBody = document.getElementById('jurnal-data-body');
            tableBody.innerHTML = '';
            
            const saldoAwalDate = data.length > 0 ? data[0].tanggal : new Date().toISOString().split('T')[0];
            let total = { masuk: 0, keluar: 0 };
            let runningSaldoTransactions = saldoBulanLalu;

            // 1. Tampilkan baris Saldo Bulan Lalu (hanya jika ada saldo awal atau data)
            if (saldoBulanLalu > 0 || data.length > 0) {
                const saldoAwalRow = tableBody.insertRow();
                saldoAwalRow.classList.add('saldo-entry');
                // Tombol Edit Saldo Bulan Lalu
                const editButton = window.isLoggedIn ? `<button class="button btn-blue" onclick="editData('jurnal', 'saldo-bulan-lalu-edit', '${window.currentFilter.month}', '${window.currentFilter.year}', ${saldoBulanLalu})">Edit Saldo</button>` : '';

                saldoAwalRow.innerHTML = `
                    <td style="text-align: center;">-</td>
                    <td>${window.formatTanggal(saldoAwalDate)}</td>
                    <td>SALDO BULAN LALU (Input Manual)</td>
                    <td>-</td>
                    <td class="money-col">${window.formatRupiah(saldoBulanLalu)}</td>
                    <td class="money-col">${window.formatRupiah(0)}</td>
                    <td class="money-col" style="font-weight: bold;">${window.formatRupiah(saldoBulanLalu)}</td>
                    <td style="display: ${window.isLoggedIn ? 'table-cell' : 'none'}; text-align: center; vertical-align: middle;">${editButton}</td>
                `;
            }

            // 2. Tampilkan semua transaksi
            data.forEach((d, index) => {
                runningSaldoTransactions += d.masuk;
                runningSaldoTransactions -= d.keluar;
                total.masuk += d.masuk;
                total.keluar += d.keluar;

                const row = tableBody.insertRow();
                const typeClass = d.type === 'auto' ? 'auto-entry' : 'manual-entry';
                row.classList.add(typeClass);
                
                let actionCellContent;
                if (window.isLoggedIn) {
                    if (d.type === 'manual') {
                        const idString = `'${d.id}'`;
                        // Tampilkan tombol Edit/Hapus untuk entri manual
                        actionCellContent = `
                            <div class="action-btns">
                                <button class="button btn-blue" onclick="editData('jurnal', ${idString})">Edit</button> 
                                <button class="button btn-red" onclick="deleteData('jurnal', ${idString})">Hapus</button> 
                            </div>`;
                    } else {
                        // Tampilkan tanda hubung (-) yang rapi dan terpusat untuk entri otomatis (Koin NU)
                        actionCellContent = '<span style="color: #6c757d;">-</span>';
                    }
                } else {
                    actionCellContent = ''; // Kosong jika tidak login
                }


                row.innerHTML = `
                    <td style="text-align: center;">${index + 1}</td>
                    <td>${window.formatTanggal(d.tanggal)}</td>
                    <td>${d.keterangan}</td>
                    <td>${d.kategori}</td>
                    <td class="money-col">${window.formatRupiah(d.masuk)}</td>
                    <td class="money-col">${window.formatRupiah(d.keluar)}</td>
                    <td class="money-col" style="font-weight: bold;">${window.formatRupiah(runningSaldoTransactions)}</td>
                    <td style="display: ${window.isLoggedIn ? 'table-cell' : 'none'}; text-align: center; vertical-align: middle;">${actionCellContent}</td>
                `;
            });
            
            // Handle case where there are no transactions after saldo awal
            if (saldoBulanLalu === 0 && data.length === 0) {
                 const row = tableBody.insertRow();
                 row.innerHTML = `<td colspan="8" style="text-align: center; font-style: italic;">Tidak ada data Jurnal Umum untuk periode ini.</td>`;
            }
            
            // Update Footer
            document.getElementById('jurnal-total-masuk').textContent = window.formatRupiah(total.masuk + (saldoBulanLalu > 0 ? saldoBulanLalu : 0));
            document.getElementById('jurnal-total-keluar').textContent = window.formatRupiah(total.keluar);
            document.getElementById('jurnal-saldo-akhir').textContent = window.formatRupiah(runningSaldoTransactions);
            
            document.getElementById('jurnal-aksi-header').style.display = window.isLoggedIn ? 'table-cell' : 'none';
            document.getElementById('jurnal-total-aksi').style.display = window.isLoggedIn ? 'table-cell' : 'none';
        }
        
        // --- EXPORT FUNCTIONS ---

        window.exportToPdf = async (module) => {
            alert('Fungsi Export PDF tidak tersedia karena memerlukan library jspdf/html2canvas yang rumit. Silakan gunakan Export Excel sebagai alternatif.');
            // Untuk implementasi lanjutan PDF:
            // const doc = new window.jspdf.jsPDF('l', 'mm', 'a4');
            // const tableId = `${module}-table`;
            // html2canvas(document.getElementById(tableId)).then(canvas => {
            //     const imgData = canvas.toDataURL('image/png');
            //     doc.addImage(imgData, 'PNG', 10, 10, 277, 180);
            //     doc.save(`${module}_${window.currentFilter.year}${window.currentFilter.month}.pdf`);
            // });
        };
        
        window.exportToExcel = (module) => {
            const tableId = `${module}-table`;
            const table = document.getElementById(tableId);
            let filename = `${module}_${window.currentFilter.year}${window.currentFilter.month}.xls`;

            let html = table.outerHTML;
            // Hapus kolom Aksi dari HTML sebelum diexport
            const actionColIndex = window.isLoggedIn ? (module === 'koin' ? 11 : 7) : -1;

            if (actionColIndex > -1) {
                // Hapus header Aksi
                html = html.replace(/<th[^>]*Aksi<\/th>/g, ''); 
                
                // Hapus sel Aksi dari setiap baris
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = html;
                
                tempDiv.querySelectorAll('tr').forEach(row => {
                    // Cari dan hapus kolom aksi (paling kanan)
                    const cells = row.querySelectorAll('td, th');
                    if (cells.length > actionColIndex) {
                        const cellToRemove = cells[actionColIndex];
                        // Pastikan kolom yang dihapus adalah kolom Aksi (atau kolom terakhir)
                        if (cellToRemove.innerText.includes('Edit') || cellToRemove.innerText.includes('Hapus') || cellToRemove.innerText.includes('-')) {
                             cellToRemove.remove();
                        }
                    }
                });

                html = tempDiv.innerHTML;
            }

            const uri = 'data:application/vnd.ms-excel;base64,';
            const base64 = (s) => window.btoa(unescape(encodeURIComponent(s)));

            const link = document.createElement('a');
            link.href = uri + base64(html);
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        };
        

        // Load initial data on page ready
        window.addEventListener('DOMContentLoaded', async () => {
            await loadAllCollections();
            populateFilterOptions && populateFilterOptions();
            updateLoginStatus(); // Set status login awal
            filterData && filterData('koin');
        });

        // Override any remaining save-to-local-storage calls by saving when window unload (keep but not needed)
        window.addEventListener('beforeunload', async () => {
            // no-op, data sudah disimpan di Firebase
        });
    </script>
</body>
</html>
