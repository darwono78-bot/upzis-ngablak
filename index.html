<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Pembukuan UPZIS | Ranting Ngablak</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <style>
        /* Gaya CSS untuk Tampilan */
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; padding: 0; background-color: #f4f7f6; color: #333; }
        .container { padding: 20px; max-width: 100%; margin: auto; } /* Lebar Maksimum Disesuaikan */
        
        /* Gaya Navigasi */
        .navbar { background-color: #006400; color: white; padding: 10px 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.2); display: flex; align-items: center; justify-content: space-between; }
        .navbar-logo { font-size: 1.5rem; font-weight: bold; }
        .navbar-links a { color: white; text-decoration: none; padding: 8px 15px; margin-left: 10px; border-radius: 4px; transition: background-color 0.3s; }
        .navbar-links a:hover, .navbar-links a.active { background-color: #008000; }
        
        .button { padding: 10px 15px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; transition: background-color 0.3s; }
        .btn-green { background-color: #008000; color: white; }
        .btn-green:hover { background-color: #006400; }
        .btn-red { background-color: #cc0000; color: white; }
        .btn-red:hover { background-color: #a00000; }
        .btn-blue { background-color: #007bff; color: white; }
        .btn-blue:hover { background-color: #0056b3; }
        
        /* Gaya Login Box */
        .login-box { 
            background: white; 
            padding: 30px; 
            border-radius: 8px; 
            box-shadow: 0 4px 8px rgba(0,0,0,0.1); 
            width: 450px; 
            margin: 20px auto; 
        }
        .login-input-row { 
            display: flex; 
            gap: 10px; 
            margin-bottom: 10px; 
        }
        .login-input-row input { 
            width: 50%; 
            padding: 10px; 
            border: 1px solid #ccc; 
            border-radius: 4px; 
            box-sizing: border-box; 
            margin-bottom: 0; 
        }

        table { width: 100%; border-collapse: collapse; margin-top: 15px; background: white; box-shadow: 0 2px 4px rgba(0,0,0,0.05); font-size: 0.9rem; }
        th, td { border: 1px solid #ddd; padding: 10px; text-align: left; }
        th { background-color: #006400; color: white; text-align: center; font-size: small; }
        
        /* Gaya untuk kolom angka */
        .money-col { text-align: right !important; }
        /* Kelas untuk elemen yang disembunyikan di luar PDF Koin NU (Hanya Pembagian Dana yang tetap disembunyikan) */
        .koin-pembagian-col, .koin-pembagian-header { display: table-cell; }
        
        .action-btns button { margin: 2px; font-size: 0.7rem; padding: 5px; }
        .input-form { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); margin-top: 30px; }
        .input-form h3 { color: #006400; border-bottom: 2px solid #006400; padding-bottom: 5px; }
        .form-row { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 10px; }
        .form-row label { font-weight: bold; display: block; margin-bottom: 5px; }
        .form-row input, .form-row select { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        .form-controls { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        
        /* Gaya Footer Total */
        tfoot td { font-weight: bold; text-align: right; background-color: #f0f0f0; }
        .total-label { text-align: right !important; }

        /* TTD Area Diperbaiki (Centered Block) */
        .ttd-area { 
            width: 80%; 
            margin: 30px auto 0 auto; 
            display: none; 
            justify-content: space-between; 
            padding: 20px 0; 
            box-sizing: border-box; 
        }
        .ttd-box { 
            text-align: center; 
            width: 45%; 
        }
        
        .ttd-box p { margin: 0; line-height: 1.5; }
        .ttd-line { 
            height: 1px; 
            width: 100%; 
            background: black; 
            margin: 30px 0 5px 0; 
        }
        /* ============================ */

        .report-header-section {
            display: flex;
            justify-content: space-between; 
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #ddd;
        }
        .report-title-center { text-align: center; flex-grow: 1; }
        .report-controls { display: flex; gap: 10px; align-items: center; }
        .auto-entry { font-style: italic; background-color: #f9f9f9; }
        .manual-entry { background-color: #fffacd; } 
        .saldo-entry { background-color: #e6ffe6; font-weight: bold; } 
        .total-saldo { background-color: #d4edda !important; color: #155724; } 
        
        /* === Gaya Laporan Tahunan Baru === */
        #annual-data-table th { font-size: x-small; padding: 5px; vertical-align: middle; }
        #annual-data-table td { font-size: x-small; padding: 5px; }
        .annual-sub-header { background-color: #008000; color: white; font-weight: bold; }
        .annual-manual-input { background-color: #fffacd; }
        .annual-saldo-row { background-color: #e6ffe6; }
        .annual-total-row { background-color: #d4edda !important; color: #155724; font-weight: bold; }
        .editable-cell { cursor: pointer; border-bottom: 1px dashed #007bff; }
    </style>
</head>
<body>

    <div class="navbar">
        <span class="navbar-logo">Pembukuan UPZIS</span>
        <div class="navbar-links">
            <a href="#" id="nav-koin" onclick="showModule('koin')">Laporan KOIN NU</a>
            <a href="#" id="nav-jurnal" onclick="showModule('jurnal')">Jurnal Umum</a>
            <a href="#" id="nav-tahunan" onclick="showModule('tahunan')">Laporan Tahunan</a>
        </div>
    </div>

    <div class="container">
        
        <div id="koin-nu-module" style="display: none;">
            <div id="koin-pdf-content">
                <div style="text-align: center; margin-bottom: 10px; padding-bottom: 10px; border-bottom: 3px double #006400;">
                    <h1 style="color: #006400; margin: 0; line-height: 1.2; font-size: 24px;">NU CARE UPZIS - LAZISNU RANTING NGABLAK</h1>
                    <p style="margin: 0; font-size: 14px; color: #555;">Sekretariat: Jalan [Nama Jalan], Desa Ngablak, Kec. [Kecamatan], Kab. [Kabupaten]</p>
                </div>

                <div class="report-header-section">
                    <div class="report-controls">
                        <label for="koin-filter-bulan">Bulan:</label>
                        <select id="koin-filter-bulan" onchange="filterData('koin')"></select>
                        <label for="koin-filter-tahun">Tahun:</label>
                        <select id="koin-filter-tahun" onchange="filterData('koin')"></select>
                    </div>
                    
                    <div class="report-title-center">
                        <p style="font-weight: bold; margin: 0;">Laporan Pemasukan KOIN NU Periode <span id="koin-pdf-periode-display"></span></p>
                    </div>

                    <div class="report-controls">
                        <button class="button btn-red" id="koin-download-btn-header" onclick="downloadPDF('koin')">Unduh PDF</button>
                    </div>
                </div>


                <table id="koin-data-table">
                    <thead>
                        <tr>
                            <th rowspan="2">NO</th>
                            <th rowspan="2">TANGGAL</th>
                            <th rowspan="2">NAMA PETUGAS</th>
                            <th rowspan="2" id="koin-hp-header">NO HP</th> 
                            <th rowspan="2">DONATUR/KELOMPOK</th>
                            <th rowspan="2" id="koin-alamat-header">ALAMAT (RT/RW)</th> 
                            <th rowspan="2" class="money-col">NOMINAL</th> 
                            <th colspan="4" class="koin-pembagian-header">PEMBAGIAN DANA KOIN</th> 
                            <th rowspan="2" id="koin-aksi-header" style="display: none;">Aksi</th>
                        </tr>
                        <tr>
                            <th class="koin-pembagian-header money-col">Petugas (10%)</th> 
                            <th class="koin-pembagian-header money-col">Ranting (60%)</th> 
                            <th class="koin-pembagian-header money-col">MWC (25%)</th> 
                            <th class="koin-pembagian-header money-col">PC (5%)</th> 
                        </tr>
                    </thead>
                    <tbody id="koin-data-body">
                        </tbody>
                    <tfoot>
                        <tr>
                            <td colspan="6" class="total-label" id="koin-total-label">TOTAL PENJUMLAHAN</td>
                            <td id="koin-total-nominal" class="money-col">0</td>
                            <td id="koin-total-petugas" class="money-col koin-pembagian-col">0</td>
                            <td id="koin-total-ranting" class="money-col koin-pembagian-col">0</td>
                            <td id="koin-total-mwc" class="money-col koin-pembagian-col">0</td>
                            <td id="koin-total-pc" class="money-col koin-pembagian-col">0</td>
                            <td id="koin-total-aksi" style="display: none;"></td>
                        </tr>
                    </tfoot>
                </table>
                
                <div id="koin-ttd-date" style="text-align: right; margin-bottom: 15px; display: none;"> Ngablak, <span id="koin-ttd-tanggal-output"></span></div>
                <div id="koin-ttd-area" class="ttd-area"> 
                    <div class="ttd-box"><p>Mengetahui,</p><p>Ketua UPZIS</p><div class="ttd-line"></div><p>(Nama Ketua)</p></div>
                    <div class="ttd-box"><p>Dibuat oleh,</p><p>Bendahara UPZIS</p><div class="ttd-line"></div><p>(Nama Bendahara)</p></div>
                </div>

            </div>
            <div class="form-controls" id="koin-admin-controls" style="display: none; margin-top: 20px;">
                <button class="button btn-red" onclick="deleteAllDataGlobal('koin')">Hapus Semua Data</button> 
                <button class="button btn-blue" onclick="logout()">Log Out</button> 
            </div>
            <div class="input-form" id="koin-input-area" style="display: none;">
                <h3>Input Data Pemasukan Baru (KOIN NU)</h3>
                <div class="form-row">
                    <div><label for="koin-input-tanggal">Tanggal:</label><input type="date" id="koin-input-tanggal" required></div>
                    <div><label for="koin-input-petugas">Nama Petugas:</label><input type="text" id="koin-input-petugas" required></div>
                    <div><label for="koin-input-hp">No. HP Petugas:</label><input type="tel" id="koin-input-hp" required></div>
                </div>
                <div class="form-row">
                    <div><label for="koin-input-donatur">Donatur/Kelompok:</label><input type="text" id="koin-input-donatur" required></div>
                    <div><label for="koin-input-alamat">Alamat (RT/RW):</label><input type="text" id="koin-input-alamat" required></div>
                    <div><label for="koin-input-nominal">Nominal:</label><input type="number" id="koin-input-nominal" required></div>
                </div>
                <button class="button btn-green" onclick="saveData('koin')">Simpan Data</button>
                <div style="clear: both;"></div> 
            </div>
        </div>
        <div id="jurnal-umum-module" style="display: none;">
             <div id="jurnal-pdf-content">
                <div style="text-align: center; margin-bottom: 10px; padding-bottom: 10px; border-bottom: 3px double #006400;">
                    <h1 style="color: #006400; margin: 0; line-height: 1.2; font-size: 24px;">NU CARE UPZIS - LAZISNU RANTING NGABLAK</h1>
                    <p style="margin: 0; font-size: 14px; color: #555;">Sekretariat: Jalan [Nama Jalan], Desa Ngablak, Kec. [Kecamatan], Kab. [Kabupaten]</p>
                </div>

                <div class="report-header-section">
                    <div class="report-controls">
                        <label for="jurnal-filter-bulan">Bulan:</label>
                        <select id="jurnal-filter-bulan" onchange="filterData('jurnal')"></select>
                        <label for="jurnal-filter-tahun">Tahun:</label>
                        <select id="jurnal-filter-tahun" onchange="filterData('jurnal')"></select>
                    </div>
                    
                    <div class="report-title-center">
                        <p style="font-weight: bold; margin: 0;">Jurnal Umum Periode <span id="jurnal-pdf-periode-display"></span></p>
                    </div>

                    <div class="report-controls">
                        <button class="button btn-red" id="jurnal-download-btn-header" onclick="downloadPDF('jurnal')">Unduh PDF</button>
                    </div>
                </div>

                <table id="jurnal-data-table">
                    <thead>
                        <tr>
                            <th>NO</th>
                            <th>TANGGAL</th>
                            <th>KETERANGAN</th>
                            <th>KATEGORI</th>
                            <th class="money-col">DANA MASUK</th> 
                            <th class="money-col">DANA KELUAR</th> 
                            <th class="money-col">SALDO</th> 
                            <th id="jurnal-aksi-header" style="display: none;">Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="jurnal-data-body"></tbody>
                    <tfoot>
                        <tr>
                            <td colspan="4" class="total-label" id="jurnal-total-label">TOTAL</td>
                            <td id="jurnal-total-masuk" class="money-col">0</td>
                            <td id="jurnal-total-keluar" class="money-col">0</td>
                            <td id="jurnal-saldo-akhir" class="total-saldo money-col">0</td>
                            <td id="jurnal-total-aksi" style="display: none;"></td>
                        </tr>
                    </tfoot>
                </table>

                <div id="jurnal-ttd-date" style="text-align: right; margin-bottom: 15px; display: none;"> Ngablak, <span id="jurnal-ttd-tanggal-output"></span></div>
                <div id="jurnal-ttd-area" class="ttd-area"> 
                    <div class="ttd-box"><p>Mengetahui,</p><p>Ketua UPZIS</p><div class="ttd-line"></div><p>(Nama Ketua)</p></div>
                    <div class="ttd-box"><p>Dibuat oleh,</p><p>Bendahara UPZIS</p><div class="ttd-line"></div><p>(Nama Bendahara)</p></div>
                </div>
            </div>

            <div class="form-controls" id="jurnal-admin-controls" style="display: none; margin-top: 20px;">
                <button class="button btn-red" onclick="deleteAllDataGlobal('jurnal')">Hapus Semua Data</button> 
                <button class="button btn-blue" onclick="logout()">Log Out</button> 
            </div>

            <div class="input-form" id="jurnal-input-area" style="display: none;">
                <h3>Input Data Jurnal Umum (Manual)</h3>
                <div class="form-row">
                    <div><label for="jurnal-input-tanggal">Tanggal:</label><input type="date" id="jurnal-input-tanggal" required></div>
                    <div><label for="jurnal-input-keterangan">Keterangan/Uraian:</label><input type="text" id="jurnal-input-keterangan" required></div>
                    <div>
                        <label for="jurnal-input-kategori">Kategori:</label>
                        <select id="jurnal-input-kategori" onchange="updateMasukKeluarFields()" required>
                            <option value="">Pilih Kategori</option>
                            <optgroup label="DANA MASUK">
                                <option value="Koin NU">Koin NU</option>
                                <option value="Donatur">Donatur</option>
                                <option value="Zakat Mall">Zakat Mall</option>
                                <option value="Infaq">Infaq</option>
                                <option value="Shodaqoh">Shodaqoh</option>
                                <option value="Saldo Bulan Lalu">Saldo Bulan Lalu</option>
                                <option value="Hasil Usaha">Hasil Usaha</option>
                            </optgroup>
                            <optgroup label="DANA KELUAR">
                                <option value="Petugas (10%)">Petugas (10%)</option>
                                <option value="MWC (25%)">MWC (25%)</option>
                                <option value="PC (5%)">PC (5%)</option>
                                <option value="Ranting (60%)">Ranting (60%)</option>
                                <option value="Untuk Pendidikan">Untuk Pendidikan</option>
                                <option value="Untuk Sosial">Untuk Sosial</option>
                                <option value="Untuk Ekonomi">Untuk Ekonomi</option>
                                <option value="Untuk Kesehatan">Untuk Kesehatan</option>
                                <option value="Subsidi Banom & Lembaga NU">Subsidi Banom & Lembaga NU</option>
                                <option value="Lain-lain">Lain-lain</option>
                            </optgroup>
                        </select>
                    </div>
                </div>
                <div class="form-row" style="grid-template-columns: repeat(2, 1fr);">
                    <div><label for="jurnal-input-masuk">Dana Masuk:</label><input type="number" id="jurnal-input-masuk" min="0"></div>
                    <div><label for="jurnal-input-keluar">Dana Keluar:</label><input type="number" id="jurnal-input-keluar" min="0"></div>
                </div>
                <button class="button btn-green" onclick="saveData('jurnal')">Simpan Data</button>
                <div style="clear: both;"></div> 
            </div>
        </div>
        <div id="laporan-tahunan-module" style="display: none;">
             <div id="tahunan-pdf-content">
                <div style="text-align: center; margin-bottom: 10px; padding-bottom: 10px; border-bottom: 3px double #006400;">
                    <h1 style="color: #006400; margin: 0; line-height: 1.2; font-size: 24px;">NU CARE UPZIS - LAZISNU RANTING NGABLAK</h1>
                    <p style="margin: 0; font-size: 14px; color: #555;">Sekretariat: Jalan [Nama Jalan], Desa Ngablak, Kec. [Kecamatan], Kab. [Kabupaten]</p>
                </div>

                <div class="report-header-section">
                    <div class="report-controls">
                        <label for="tahunan-filter-tahun">Tahun Laporan:</label>
                        <select id="tahunan-filter-tahun" onchange="filterData('tahunan')"></select>
                    </div>
                    
                    <div class="report-title-center">
                        <p style="font-weight: bold; margin: 0;">Laporan Tahunan Periode <span id="tahunan-pdf-periode-display"></span></p>
                    </div>

                    <div class="report-controls">
                        <button class="button btn-red" id="tahunan-download-btn-header" onclick="downloadPDF('tahunan')">Unduh PDF</button>
                    </div>
                </div>

                <div style="overflow-x: auto;">
                    <table id="annual-data-table">
                        <thead>
                            <tr>
                                <th rowspan="3" style="width: 1%;">NO</th>
                                <th rowspan="3" style="width: 10%;">BULAN & TAHUN</th>
                                <th colspan="2" class="annual-sub-header">PENERIMAAN</th>
                                <th colspan="12" class="annual-sub-header">PENGELUARAN</th>
                            </tr>
                            <tr>
                                <th rowspan="2" class="money-col">Total Penerimaan KOIN</th>
                                <th rowspan="2">Jumlah Donatur (Manual)</th>
                                <th colspan="2">A. Bidang Pendidikan</th>
                                <th colspan="2">B. Bidang Sosial</th>
                                <th colspan="2">C. Bidang Kesehatan</th>
                                <th colspan="2">D. Bidang Ekonomi</th>
                                <th colspan="2">E. Subsidi Banom & Lembaga NU</th>
                                <th colspan="2">F. Lain-Lain</th>
                            </tr>
                            <tr>
                                <th class="money-col">Jml Uang (Auto)</th>
                                <th>Jml Penerima (Manual)</th>
                                <th class="money-col">Jml Uang (Auto)</th>
                                <th>Jml Penerima (Manual)</th>
                                <th class="money-col">Jml Uang (Auto)</th>
                                <th>Jml Penerima (Manual)</th>
                                <th class="money-col">Jml Uang (Auto)</th>
                                <th>Jml Penerima (Manual)</th>
                                <th class="money-col">Jml Uang (Auto)</th>
                                <th>Keterangan (Manual)</th>
                                <th class="money-col">Jml Uang (Manual)</th>
                                <th>Uraian (Manual)</th>
                            </tr>
                        </thead>
                        <tbody id="annual-data-body"></tbody>
                        <tfoot>
                            <tr class="annual-total-row">
                                <td colspan="2" class="total-label" style="text-align: center;">TOTAL TAHUNAN</td>
                                <td id="tahunan-total-koin" class="money-col">0</td>
                                <td id="tahunan-total-donatur" class="money-col">0</td>
                                <td id="tahunan-total-pend-uang" class="money-col">0</td>
                                <td id="tahunan-total-pend-penerima" class="money-col">0</td>
                                <td id="tahunan-total-sosial-uang" class="money-col">0</td>
                                <td id="tahunan-total-sosial-penerima" class="money-col">0</td>
                                <td id="tahunan-total-kes-uang" class="money-col">0</td>
                                <td id="tahunan-total-kes-penerima" class="money-col">0</td>
                                <td id="tahunan-total-eko-uang" class="money-col">0</td>
                                <td id="tahunan-total-eko-penerima" class="money-col">0</td>
                                <td id="tahunan-total-banom-uang" class="money-col">0</td>
                                <td id="tahunan-total-banom-ket" style="text-align: center;">-</td>
                                <td id="tahunan-total-lain-uang" class="money-col">0</td>
                                <td id="tahunan-total-lain-uraian" style="text-align: center;">-</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>

                <div id="tahunan-ttd-date" style="text-align: right; margin-bottom: 15px; display: none;"> Ngablak, <span id="tahunan-ttd-tanggal-output"></span></div>
                <div id="tahunan-ttd-area" class="ttd-area"> 
                    <div class="ttd-box"><p>Mengetahui,</p><p>Ketua UPZIS</p><div class="ttd-line"></div><p>(Nama Ketua)</p></div>
                    <div class="ttd-box"><p>Dibuat oleh,</p><p>Bendahara UPZIS</p><div class="ttd-line"></div><p>(Nama Bendahara)</p></div>
                </div>
            </div>
             
            <div class="form-controls" id="tahunan-admin-controls" style="display: none; margin-top: 20px; justify-content: flex-end;">
                <button class="button btn-blue" onclick="logout()">Log Out</button> 
            </div>
            
            <div class="input-form" id="tahunan-edit-input-area" style="display: none;">
                <h3>Edit Data Laporan Tahunan (Baris Khusus)</h3>
                <div class="form-row" style="grid-template-columns: 1fr 1fr 1fr;">
                    <div><label>Baris yang Diedit:</label><input type="text" id="annual-edit-label" disabled></div>
                    <div><label>Nominal:</label><input type="number" id="annual-edit-nominal" required></div>
                    <div id="annual-edit-keterangan-group" style="display: none;">
                        <label>Keterangan/Uraian:</label>
                        <input type="text" id="annual-edit-keterangan">
                    </div>
                </div>
                <div style="float: right; margin-top: 10px;">
                    <button class="button btn-green" onclick="saveAnnualReportData()">Simpan Perubahan</button>
                    <button class="button btn-red" onclick="cancelAnnualEdit()">Batal</button>
                </div>
                <div style="clear: both;"></div> 
            </div>

        </div>
        <div id="login-area">
            <div class="login-box">
                <h2 style="text-align: center; color: #006400;">ADMIN LOGIN</h2>
                <div class="login-input-row">
                    <input type="email" id="username" placeholder="Email Admin"> 
                    <input type="password" id="password" placeholder="Password">
                </div>
                <button class="button btn-green" style="width: 100%;" onclick="attemptLogin()">Masuk</button> 
            </div>
        </div>
        </div>


    <script>
        
        // ===================================================
        // === BLOK FIREBASE CONFIGURATION & AUTHENTICATION ===
        // ===================================================

        // 1. Konfigurasi Firebase Anda
        const firebaseConfig = {
            apiKey: "AIzaSyA_8NMmZBaXZ4H6KQt7rHy8G1URR3HLP3A",
            authDomain: "upzis-ngablak.firebaseapp.com",
            projectId: "upzis-ngablak",
            storageBucket: "upzis-ngablak.firebasestorage.app",
            messagingSenderId: "869549648344",
            appId: "1:869549648344:web:a531a37cce3a87bb672aad"
        };

        // Inisialisasi Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        let isLoggedIn = false;
        let currentModule = 'koin'; // Default module is Koin


        // 2. Fungsi Login menggunakan Firebase Auth (Menggantikan fungsi lama)
        function attemptLogin() {
            const usernameInput = document.getElementById('username');
            const passwordInput = document.getElementById('password');
            const email = usernameInput.value; // ID 'username' digunakan sebagai Email
            const password = passwordInput.value;

            auth.signInWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    // Login Berhasil, onAuthStateChanged akan menangani tampilan
                    console.log("Login berhasil:", userCredential.user.email);
                    usernameInput.value = '';
                    passwordInput.value = '';
                })
                .catch((error) => {
                    // Login Gagal
                    const errorMessage = error.message;
                    alert(`Login Gagal: ${errorMessage}`);
                    console.error("Login Error:", error);
                });
        }

        // 3. Fungsi Logout (Menggantikan fungsi lama)
        function logout() {
            auth.signOut().then(() => {
                // Sign-out successful. onAuthStateChanged akan menangani tampilan
                alert('Anda telah Logout.');
            }).catch((error) => {
                alert("Gagal Logout.");
                console.error("Logout Error:", error);
            });
        }


        // 4. Pengelolaan Status Login (State Listener) - MENENTUKAN TAMPILAN
        auth.onAuthStateChanged((user) => {
            const loginArea = document.getElementById('login-area');
            const adminControls = document.querySelectorAll('[id$="-admin-controls"]');
            const inputAreas = document.querySelectorAll('[id$="-input-area"]');
            const mainModules = document.querySelectorAll('#koin-nu-module, #jurnal-umum-module, #laporan-tahunan-module');

            if (user) {
                // User is signed in (Admin)
                isLoggedIn = true;
                loginArea.style.display = 'none'; // Sembunyikan form login

                // Tampilkan semua kontrol admin dan input area
                adminControls.forEach(el => el.style.display = 'flex');
                inputAreas.forEach(el => el.style.display = 'block');

                // Tampilkan Modul yang aktif (default: Koin)
                mainModules.forEach(el => el.style.display = 'none'); // Sembunyikan semua dulu
                document.getElementById(`${currentModule}-nu-module`).style.display = 'block'; // Tampilkan yang aktif
                
                // Set navigasi ke modul yang aktif
                document.getElementById(`nav-${currentModule}`).classList.add('active');
                
                // Panggil filterData dan updateTableActionVisibility
                filterData(currentModule); 
                updateTableActionVisibility();
                
            } else {
                // User is signed out (Belum Login)
                isLoggedIn = false;
                loginArea.style.display = 'block'; // Tampilkan form login

                // Sembunyikan semua konten utama dan kontrol admin
                adminControls.forEach(el => el.style.display = 'none');
                inputAreas.forEach(el => el.style.display = 'none');
                mainModules.forEach(el => el.style.display = 'none'); 

                // Reset navigasi
                const navLinks = ['nav-koin', 'nav-jurnal', 'nav-tahunan'];
                navLinks.forEach(id => document.getElementById(id).classList.remove('active'));
                
                // Panggil filterData dan updateTableActionVisibility untuk merestorasi tampilan tabel tanpa tombol Edit/Hapus
                filterData(currentModule);
                updateTableActionVisibility();
            }
        });


        // 5. Fungsi untuk Update Visibility Tombol Aksi
        function updateTableActionVisibility() {
            // Koin
            const koinActionHeader = document.getElementById('koin-aksi-header');
            const koinTotalAksi = document.getElementById('koin-total-aksi');
            if (koinActionHeader) koinActionHeader.style.display = isLoggedIn ? 'table-cell' : 'none';
            if (koinTotalAksi) koinTotalAksi.style.display = isLoggedIn ? 'table-cell' : 'none';
            document.querySelectorAll('#koin-data-table .action-btns').forEach(el => el.style.display = isLoggedIn ? 'table-cell' : 'none');

            // Jurnal
            const jurnalActionHeader = document.getElementById('jurnal-aksi-header');
            const jurnalTotalAksi = document.getElementById('jurnal-total-aksi');
            if (jurnalActionHeader) jurnalActionHeader.style.display = isLoggedIn ? 'table-cell' : 'none';
            if (jurnalTotalAksi) jurnalTotalAksi.style.display = isLoggedIn ? 'table-cell' : 'none';
            document.querySelectorAll('#jurnal-data-table .action-btns').forEach(el => el.style.display = isLoggedIn ? 'table-cell' : 'none');
        }

        // 6. Fungsi showModule (Diperbarui untuk mengecek status login)
        function showModule(moduleName) {
            currentModule = moduleName;
            const modules = ['koin-nu-module', 'jurnal-umum-module', 'laporan-tahunan-module'];
            modules.forEach(id => document.getElementById(id).style.display = 'none');
            
            const navLinks = ['nav-koin', 'nav-jurnal', 'nav-tahunan'];
            navLinks.forEach(id => document.getElementById(id).classList.remove('active'));

            // Hanya tampilkan modul jika sudah login
            if (isLoggedIn) {
                if (moduleName === 'koin') {
                    document.getElementById('koin-nu-module').style.display = 'block';
                    document.getElementById('nav-koin').classList.add('active');
                } else if (moduleName === 'jurnal') {
                    document.getElementById('jurnal-umum-module').style.display = 'block';
                    document.getElementById('nav-jurnal').classList.add('active');
                } else if (moduleName === 'tahunan') {
                    document.getElementById('laporan-tahunan-module').style.display = 'block';
                    document.getElementById('nav-tahunan').classList.add('active');
                }
                filterData(moduleName); // Muat data untuk modul yang baru dibuka
            } else {
                 // Jika belum login, tampilkan pesan atau biarkan login area yang muncul (ditangani onAuthStateChanged)
                 alert('Anda harus Login sebagai Admin untuk mengakses fitur ini.');
            }
        }
        
        // ===================================================
        // === BLOK KODE LAINNYA (DUMMY DATA & FUNGSI)    ===
        // ===================================================
        
        // Data Dummy (Simulasi Database)
        let koinData = [
            { id: 1, tanggal: '2025-11-26', petugas: 'Shodiq', hp: '0813250089797', donatur: 'RT 01', alamat: 'Ngablak RT 1/ RW 1', nominal: 2000000 },
            { id: 2, tanggal: '2025-11-26', petugas: 'Fulan', hp: '0813250089797', donatur: 'RT 02', alamat: 'Ngablak RT 2/ RW 1', nominal: 1000000 },
            { id: 3, tanggal: '2025-10-01', petugas: 'Ahmad', hp: '08123456789', donatur: 'Warga RT 02', alamat: '02/01', nominal: 500000 },
            { id: 4, tanggal: '2025-10-15', petugas: 'Budi', hp: '08198765432', donatur: 'Kelompok Tahlil...


        ];
        
        let jurnalData = [
            // Contoh Saldo Bulan Lalu
            { id: 100, tanggal: '2025-11-01', keterangan: 'Saldo Bulan Lalu (Okt 2025)', kategori: 'Saldo Bulan Lalu', masuk: 1000000, keluar: 0, type: 'manual_saldo' },
            // Contoh Pemasukan Manual
            { id: 101, tanggal: '2025-11-10', keterangan: 'Donasi Toko Barokah', kategori: 'Donatur', masuk: 500000, keluar: 0, type: 'manual' },
            // Contoh Pengeluaran Manual
            { id: 102, tanggal: '2025-11-15', keterangan: 'Biaya Transportasi Petugas', kategori: 'Lain-lain', masuk: 0, keluar: 25000, type: 'manual' },
            // Contoh Pengeluaran Otomatis KOIN NU (Akhir Bulan November 2025) - Harusnya dihitung dari koinData, tapi di jurnal juga ada
            { id: 200, tanggal: '2025-11-30', keterangan: 'Pembagian Petugas KOIN NU', kategori: 'Petugas (10%)', masuk: 0, keluar: 300000, type: 'auto' },
            { id: 201, tanggal: '2025-11-30', keterangan: 'Pembagian MWC KOIN NU', kategori: 'MWC (25%)', masuk: 0, keluar: 750000, type: 'auto' },
            { id: 202, tanggal: '2025-11-30', keterangan: 'Pembagian PC KOIN NU', kategori: 'PC (5%)', masuk: 0, keluar: 150000, type: 'auto' },
            { id: 203, tanggal: '2025-11-30', keterangan: 'Pengeluaran Pendidikan', kategori: 'Untuk Pendidikan', masuk: 0, keluar: 500000, type: 'manual' },
            // Contoh Pengeluaran Des 2024 (Untuk Laporan Tahunan 2024)
            { id: 300, tanggal: '2024-12-05', keterangan: 'Sumbangan pembangunan', kategori: 'Untuk Pendidikan', masuk: 0, keluar: 100000, type: 'manual' },
            // Contoh Pemasukan Des 2024 (Untuk Laporan Tahunan 2024)
            { id: 301, tanggal: '2024-12-05', keterangan: 'Infaq Akhir Tahun', kategori: 'Infaq', masuk: 50000, keluar: 0, type: 'manual' }
        ];

        let annualData = [
            // Saldo Bank & Kas Tahun 2025
            { type: 'saldo_bank', year: 2025, nominal: 5000000 },
            { type: 'saldo_kas', year: 2025, nominal: 1000000 },
            // Data manual bulanan (hanya untuk kolom yang diinput manual di laporan tahunan)
            // Contoh: Januari 2025
            { 
                type: 'monthly', year: 2025, month: 1, 
                donatur: 5, // Jumlah Donatur
                pendidikan: { penerima: 2 }, // Jml Penerima Pendidikan
                sosial: { penerima: 3 }, // Jml Penerima Sosial
                kesehatan: { penerima: 0 },
                ekonomi: { penerima: 1 },
                banom: { keterangan: 'Kas Banom Fatayat' }, // Keterangan Subsidi Banom
                lain_lain: { nominal: 50000, uraian: 'Biaya ATK' } // Jml Uang & Uraian Lain-lain
            },
            // Contoh: Februari 2025
            { 
                type: 'monthly', year: 2025, month: 2, 
                donatur: 10,
                pendidikan: { penerima: 5 },
                sosial: { penerima: 0 },
                kesehatan: { penerima: 2 },
                ekonomi: { penerima: 0 },
                banom: { keterangan: 'Kas Banom Muslimat' },
                lain_lain: { nominal: 0, uraian: '' }
            }
        ];


        let koinEditId = null;
        let jurnalEditId = null;
        let currentAnnualEditKey = null;

        const namaBulan = [
            'Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni',
            'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'
        ];

        // ----------------------------------------------------
        // --- UTILITY FUNCTIONS (Fungsi Pembantu) ---
        // ----------------------------------------------------

        // 1. Format Tanggal
        function formatTanggal(isoDate) {
            const date = new Date(isoDate + 'T00:00:00');
            if (isNaN(date)) return isoDate;
            const options = { year: 'numeric', month: '2-digit', day: '2-digit' };
            return date.toLocaleDateString('id-ID', options).replace(/\//g, '/');
        }

        // 1b. Format Tanggal TTD
        function formatTanggalTTD() {
            const today = new Date();
            const options = { year: 'numeric', month: 'long', day: 'numeric' };
            return today.toLocaleDateString('id-ID', options);
        }

        // 2. Format Rupiah (Tanpa Rp)
        function formatRupiah(number) {
            let num = number === undefined || number === null ? 0 : number;
            let numberString = Math.abs(num).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
            return num < 0 ? `(${numberString})` : numberString;
        }

        // 3. Helper: Mendapatkan tanggal akhir bulan sebelumnya (untuk Saldo Bulan Lalu)
        function getLastDayOfPreviousMonth(currentMonth, currentYear) {
            const m = parseInt(currentMonth);
            const y = parseInt(currentYear);
            const lastDayDate = new Date(y, m - 1, 0);
            return lastDayDate.toISOString().split('T')[0];
        }

        // 4. Perhitungan Pembagian Dana KOIN NU
        function hitungPembagian(nominal) {
            return {
                petugas: nominal * 0.10, // 10%
                ranting: nominal * 0.60, // 60%
                mwc: nominal * 0.25, // 25%
                pc: nominal * 0.05 // 5%
            };
        }

        // 4b. Hitung Total KOIN NU untuk Jurnal Umum
        function calculateKoinTotals(month, year) {
            const selectedMonth = parseInt(month);
            const selectedYear = parseInt(year);

            const filteredKoin = koinData.filter(data => {
                const dataDate = new Date(data.tanggal + 'T00:00:00');
                const dataMonth = dataDate.getMonth() + 1;
                const dataYear = dataDate.getFullYear();
                return dataMonth === selectedMonth && dataYear === selectedYear;
            });

            const totalNominal = filteredKoin.reduce((sum, data) => sum + data.nominal, 0);
            
            const pembagian = hitungPembagian(totalNominal);
            
            // Total Petugas, MWC, PC = KELUAR
            const totalKeluar = pembagian.petugas + pembagian.mwc + pembagian.pc;
            // Total Ranting = MASUK (dicatat sebagai pemasukan Ranting, bukan keluar)
            const totalMasuk = pembagian.ranting;

            return {
                totalNominal,
                totalMasuk,
                totalKeluar,
                details: pembagian
            };
        }

        // 4c. Hitung Total Dana Keluar Jurnal per Kategori
        function calculateJurnalExpenseByCategory(month, year, category) {
            const selectedMonth = parseInt(month);
            const selectedYear = parseInt(year);
            const isAutoKoin = ['Petugas (10%)', 'MWC (25%)', 'PC (5%)'];

            return jurnalData
                .filter(data => {
                    const dataDate = new Date(data.tanggal + 'T00:00:00');
                    const dataMonth = dataDate.getMonth() + 1;
                    const dataYear = dataDate.getFullYear();
                    const isManualExpense = !isAutoKoin.includes(data.kategori) && data.type === 'manual' && data.keluar > 0;
                    
                    return dataMonth === selectedMonth && 
                           dataYear === selectedYear && 
                           data.kategori === category &&
                           (category === 'Ranting (60%)' || isManualExpense || data.type === 'auto'); // Include Ranting (60%) because it's revenue for Ranting
                })
                .reduce((sum, d) => sum + d.keluar, 0);
        }
        
        // 4d. Hitung Total Dana Keluar Jurnal per Kategori untuk Laporan Tahunan
        function calculateAnnualJurnalExpenseByCategory(year, category) {
            const reportYear = parseInt(year);
            const isAutoKoin = ['Petugas (10%)', 'MWC (25%)', 'PC (5%)'];

            return jurnalData
                .filter(data => {
                    const dataDate = new Date(data.tanggal + 'T00:00:00');
                    const dataYear = dataDate.getFullYear();
                    const isManualExpense = !isAutoKoin.includes(data.kategori) && data.type === 'manual' && data.keluar > 0;
                    
                    return dataYear === reportYear && 
                           data.kategori === category &&
                           (category === 'Ranting (60%)' || isManualExpense || data.type === 'auto'); // Include Ranting (60%) because it's revenue for Ranting
                })
                .reduce((sum, d) => sum + d.keluar, 0);
        }

        // ----------------------------------------------------
        // --- RENDERING FUNCTIONS (Fungsi Menampilkan Data) ---
        // ----------------------------------------------------

        // 5. Render Tabel KOIN NU
        function renderKoinTable(dataToRender) {
            const tableBody = document.getElementById('koin-data-body');
            tableBody.innerHTML = '';
            
            let total = {
                nominal: 0,
                petugas: 0,
                ranting: 0,
                mwc: 0,
                pc: 0
            };

            dataToRender.forEach((data, index) => {
                const pembagian = hitungPembagian(data.nominal);
                
                total.nominal += data.nominal;
                total.petugas += pembagian.petugas;
                total.ranting += pembagian.ranting;
                total.mwc += pembagian.mwc;
                total.pc += pembagian.pc;

                const row = tableBody.insertRow();
                row.innerHTML = `
                    <td style="text-align: center;">${index + 1}</td>
                    <td>${formatTanggal(data.tanggal)}</td>
                    <td>${data.petugas}</td>
                    <td>${data.hp}</td>
                    <td>${data.donatur}</td>
                    <td>${data.alamat}</td>
                    <td class="money-col">${formatRupiah(data.nominal)}</td>
                    <td class="money-col koin-pembagian-col">${formatRupiah(pembagian.petugas)}</td>
                    <td class="money-col koin-pembagian-col">${formatRupiah(pembagian.ranting)}</td>
                    <td class="money-col koin-pembagian-col">${formatRupiah(pembagian.mwc)}</td>
                    <td class="money-col koin-pembagian-col">${formatRupiah(pembagian.pc)}</td>
                    <td class="action-btns" data-id="${data.id}" style="display: ${isLoggedIn ? 'table-cell' : 'none'};">
                        <button class="button btn-blue" onclick="editData('koin', ${data.id})">Edit</button>
                        <button class="button btn-red" onclick="deleteData('koin', ${data.id})">Hapus</button>
                    </td>
                `;
            });

            document.getElementById('koin-total-nominal').textContent = formatRupiah(total.nominal);
            document.getElementById('koin-total-petugas').textContent = formatRupiah(total.petugas);
            document.getElementById('koin-total-ranting').textContent = formatRupiah(total.ranting);
            document.getElementById('koin-total-mwc').textContent = formatRupiah(total.mwc);
            document.getElementById('koin-total-pc').textContent = formatRupiah(total.pc);
            
            const totalLabelCell = document.getElementById('koin-total-label');
            totalLabelCell.colSpan = 6;
            
            document.getElementById('koin-total-aksi').style.display = isLoggedIn ? 'table-cell' : 'none';
            document.getElementById('koin-aksi-header').style.display = isLoggedIn ? 'table-cell' : 'none';
            document.getElementById('koin-alamat-header').style.display = 'table-cell';
            document.getElementById('koin-hp-header').style.display = 'table-cell';
            document.querySelectorAll('#koin-data-table .action-btns').forEach(el => el.style.display = isLoggedIn ? 'table-cell' : 'none');
        }

        // 5b. Render Tabel Jurnal Umum - (Logic unchanged from V30%)
        function renderJurnalTable(manualData, currentMonth, currentYear) {
            const tableBody = document.getElementById('jurnal-data-body');
            
            // 1. Tambahkan Saldo Bulan Lalu
            const saldoBulanLaluDate = getLastDayOfPreviousMonth(currentMonth, currentYear);
            
            // Hitung total saldo dari semua data manual Jurnal sebelum bulan ini
            const initialBalance = manualData
                .filter(data => {
                    const dataDate = new Date(data.tanggal + 'T00:00:00');
                    const dataMonth = dataDate.getMonth() + 1;
                    const dataYear = dataDate.getFullYear();
                    // Ambil data dari bulan/tahun sebelumnya atau Saldo Bulan Lalu
                    return (dataYear < parseInt(currentYear) || (dataYear === parseInt(currentYear) && dataMonth < parseInt(currentMonth))) 
                            && (data.kategori !== 'Saldo Bulan Lalu'); // Kecualikan entri 'Saldo Bulan Lalu' agar tidak dihitung ganda
                })
                .reduce((saldo, data) => saldo + data.masuk - data.keluar, 0);
            
            // Hitung total Koin NU (Masuk Ranting) dari bulan sebelumnya
            const koinTotalPrevious = calculateKoinTotals(parseInt(currentMonth) - 1, currentYear);
            const finalInitialBalance = initialBalance + koinTotalPrevious.totalMasuk; // Tambahkan Koin NU bulan lalu

            const saldoBulanLaluEntry = { 
                id: 'new-saldo-awal', 
                tanggal: saldoBulanLaluDate, 
                keterangan: `Saldo Bulan Lalu (${namaBulan[parseInt(currentMonth) - 2] || 'Des'} ${parseInt(currentMonth) - 1 === 0 ? parseInt(currentYear) - 1 : currentYear})`, 
                kategori: 'Saldo Bulan Lalu', 
                masuk: finalInitialBalance, 
                keluar: 0, 
                type: 'manual_saldo' 
            };
            
            // 2. Tambahkan Data Koin NU Bulan Ini (Otomatis)
            const koinTotals = calculateKoinTotals(currentMonth, currentYear);
            const autoKoinMasuk = koinTotals.totalMasuk;
            const autoKoinKeluarPetugas = koinTotals.details.petugas;
            const autoKoinKeluarMwc = koinTotals.details.mwc;
            const autoKoinKeluarPc = koinTotals.details.pc;
            
            const koinHeaderEntry = { id: 'koin-header', keterangan: 'PEMASUKAN KOIN NU BULAN INI', kategori: 'Koin NU', masuk: koinTotals.totalNominal, keluar: 0, type: 'auto_header' };
            
            const koinRantingEntry = { id: 'koin-ranting', tanggal: `${currentYear}-${currentMonth}-30`, keterangan: 'Pemasukan dari Dana Ranting KOIN NU (60%)', kategori: 'Koin NU', masuk: autoKoinMasuk, keluar: 0, type: 'auto' };

            const koinPetugasEntry = { id: 'koin-petugas', tanggal: `${currentYear}-${currentMonth}-30`, keterangan: 'Pengeluaran Pembagian Petugas KOIN NU (10%)', kategori: 'Petugas (10%)', masuk: 0, keluar: autoKoinKeluarPetugas, type: 'auto' };
            const koinMWCEntry = { id: 'koin-mwc', tanggal: `${currentYear}-${currentMonth}-30`, keterangan: 'Pengeluaran Pembagian MWC KOIN NU (25%)', kategori: 'MWC (25%)', masuk: 0, keluar: autoKoinKeluarMwc, type: 'auto' };
            const koinPCEntry = { id: 'koin-pc', tanggal: `${currentYear}-${currentMonth}-30`, keterangan: 'Pengeluaran Pembagian PC KOIN NU (5%)', kategori: 'PC (5%)', masuk: 0, keluar: autoKoinKeluarPc, type: 'auto' };

            // 3. Gabungkan semua data manual bulan ini (kecuali Saldo Bulan Lalu)
            const chronologicalList = manualData
                .filter(data => {
                    const dataDate = new Date(data.tanggal + 'T00:00:00');
                    const dataMonth = dataDate.getMonth() + 1;
                    const dataYear = dataDate.getFullYear();
                    return dataMonth === parseInt(currentMonth) && 
                           dataYear === parseInt(currentYear) && 
                           data.kategori !== 'Saldo Bulan Lalu';
                })
                .sort((a, b) => new Date(a.tanggal) - new Date(b.tanggal));
            
            // 4. Susun daftar urutan
            const fixedTopFour = [koinHeaderEntry, koinRantingEntry, koinPetugasEntry, koinMWCEntry, koinPCEntry];

            let totalMasuk = 0;
            let totalKeluar = 0;
            
            // Hitung total untuk semua data
            chronologicalList.forEach(data => {
                totalMasuk += data.masuk;
                totalKeluar += data.keluar;
            });
            fixedTopFour.forEach(data => {
                totalMasuk += data.masuk;
                totalKeluar += data.keluar;
            });

            // Tentukan urutan display
            let finalDisplayList = [];

            // A. Fixed Top: Koin NU Automatis
            fixedTopFour.forEach((data, index) => {
                data.displayNo = index + 1;
                data.runningSaldo = saldoBulanLaluEntry.runningSaldo;
                finalDisplayList.push(data);
            });
            
            // B. Saldo Bulan Lalu
            saldoBulanLaluEntry.displayNo = fixedTopFour.length + 1;
            finalDisplayList.push(saldoBulanLaluEntry);

            // C. Data Manual Bulanan
            let runningSaldo = saldoBulanLaluEntry.masuk;
            
            chronologicalList.forEach((data, index) => {
                // Jangan hitung Saldo Bulan Lalu sebagai bagian dari Masuk/Keluar
                if (data.kategori !== 'Saldo Bulan Lalu') {
                    runningSaldo += data.masuk - data.keluar;
                }
                data.runningSaldo = runningSaldo;
                data.displayNo = fixedTopFour.length + 2 + index;
                finalDisplayList.push(data);
            });

            tableBody.innerHTML = '';
            
            finalDisplayList.forEach((data) => {
                const isAutoHeader = data.type === 'auto_header';
                const isRantingAuto = data.type === 'auto';
                const isSaldoBulanLalu = data.type === 'manual_saldo';
                const isManual = data.type === 'manual';
                
                let rowClass;
                if (isAutoHeader || isRantingAuto) {
                    rowClass = 'auto-entry';
                } else if (isSaldoBulanLalu) {
                    rowClass = 'saldo-entry';
                } else {
                    rowClass = 'manual-entry';
                }

                let actionId = null;
                let displayTanggal = data.tanggal ? formatTanggal(data.tanggal) : '';

                if (isManual || isSaldoBulanLalu) {
                    actionId = data.id;
                }

                const finalSaldoValue = data.runningSaldo;

                const row = tableBody.insertRow();
                row.innerHTML = `
                    <td style="text-align: center;">${data.displayNo || ''}</td>
                    <td>${displayTanggal}</td>
                    <td class="${rowClass}">${data.keterangan}</td>
                    <td class="${rowClass}">${data.kategori}</td>
                    <td class="money-col ${rowClass}">${formatRupiah(data.masuk)}</td>
                    <td class="money-col ${rowClass}">${formatRupiah(data.keluar)}</td>
                    <td class="money-col total-saldo">${formatRupiah(finalSaldoValue)}</td>
                    <td class="action-btns" data-id="${actionId}" style="display: ${isLoggedIn && actionId ? 'table-cell' : 'none'};">
                        ${actionId ? `
                            <button class="button btn-blue" onclick="editData('jurnal', '${actionId}')">Edit</button>
                            <button class="button btn-red" onclick="deleteData('jurnal', '${actionId}')">Hapus</button>
                        ` : '-'}
                    </td>
                `;
            });

            // Update Footer
            document.getElementById('jurnal-total-masuk').textContent = formatRupiah(totalMasuk);
            document.getElementById('jurnal-total-keluar').textContent = formatRupiah(totalKeluar);
            document.getElementById('jurnal-saldo-akhir').textContent = formatRupiah(finalDisplayList.length > 0 ? finalDisplayList[finalDisplayList.length - 1].runningSaldo : 0);
            
            document.getElementById('jurnal-total-aksi').style.display = isLoggedIn ? 'table-cell' : 'none';
            document.getElementById('jurnal-aksi-header').style.display = isLoggedIn ? 'table-cell' : 'none';
        }

        // 8. Generate Report Data (Consolidates all sources)
        function generateAnnualReportData(year) {
            const reportYear = parseInt(year);
            let consolidatedData = [];
            const categories = {
                pendidikan: 'Untuk Pendidikan',
                sosial: 'Untuk Sosial',
                kesehatan: 'Untuk Kesehatan',
                ekonomi: 'Untuk Ekonomi',
                banom: 'Subsidi Banom & Lembaga NU',
                lain_lain: 'Lain-lain'
            };

            // --- 1. Saldo Bank (Row 1) ---
            let saldoBank = annualData.find(d => d.type === 'saldo_bank' && d.year === reportYear);
            if (!saldoBank) saldoBank = { type: 'saldo_bank', year: reportYear, nominal: 0 };
            consolidatedData.push({
                id: `saldo_bank_${reportYear}`,
                no: 1,
                label: 'SALDO DI BANK',
                type: 'saldo_bank',
                koinNominal: saldoBank.nominal, // Dianggap sebagai penerimaan manual
                manualData: saldoBank
            });

            // --- 2. Saldo Kas Tunai (Row 2) ---
            let saldoKas = annualData.find(d => d.type === 'saldo_kas' && d.year === reportYear);
            if (!saldoKas) saldoKas = { type: 'saldo_kas', year: reportYear, nominal: 0 };
            consolidatedData.push({
                id: `saldo_kas_${reportYear}`,
                no: 2,
                label: 'SALDO KAS TUNAI',
                type: 'saldo_kas',
                koinNominal: saldoKas.nominal, // Dianggap sebagai penerimaan manual
                manualData: saldoKas
            });

            // --- 3. Monthly Data (Row 3-14) ---
            for (let month = 1; month <= 12; month++) {
                const monthName = namaBulan[month - 1];

                // 3a. Ambil data KOIN dari koinData (Total Nominal)
                const koinTotals = calculateKoinTotals(month, reportYear);
                const totalKoinNominal = koinTotals.totalNominal;

                // 3b. Ambil data Jurnal (Pengeluaran Auto)
                const expensePendidikan = calculateJurnalExpenseByCategory(month, reportYear, categories.pendidikan);
                const expenseSosial = calculateJurnalExpenseByCategory(month, reportYear, categories.sosial);
                const expenseKesehatan = calculateJurnalExpenseByCategory(month, reportYear, categories.kesehatan);
                const expenseEkonomi = calculateJurnalExpenseByCategory(month, reportYear, categories.ekonomi);
                const expenseBanom = calculateJurnalExpenseByCategory(month, reportYear, categories.banom);
                // Lain-lain diisi manual

                // 3c. Ambil data manual (Penerima, Donatur, Lain-lain) dari annualData
                let monthlyManual = annualData.find(d => d.type === 'monthly' && d.year === reportYear && d.month === month);
                if (!monthlyManual) {
                    monthlyManual = {
                        type: 'monthly', year: reportYear, month: month, donatur: 0,
                        pendidikan: { penerima: 0 }, sosial: { penerima: 0 }, kesehatan: { penerima: 0 },
                        ekonomi: { penerima: 0 }, banom: { keterangan: '' }, lain_lain: { nominal: 0, uraian: '' }
                    };
                }

                const row = {
                    id: `monthly_${reportYear}_${month}`,
                    no: month + 2,
                    label: `${monthName} ${reportYear}`,
                    type: 'monthly',
                    koinNominal: totalKoinNominal,
                    donatur: monthlyManual.donatur, // Manual

                    pendidikan: { uang: expensePendidikan, penerima: monthlyManual.pendidikan.penerima }, // Auto Uang, Manual Penerima
                    sosial: { uang: expenseSosial, penerima: monthlyManual.sosial.penerima }, // Auto Uang, Manual Penerima
                    kesehatan: { uang: expenseKesehatan, penerima: monthlyManual.kesehatan.penerima }, // Auto Uang, Manual Penerima
                    ekonomi: { uang: expenseEkonomi, penerima: monthlyManual.ekonomi.penerima }, // Auto Uang, Manual Penerima
                    banom: { uang: expenseBanom, keterangan: monthlyManual.banom.keterangan }, // Auto Uang, Manual Keterangan
                    lain_lain: { uang: monthlyManual.lain_lain.nominal, uraian: monthlyManual.lain_lain.uraian }, // Manual Uang, Manual Uraian

                    manualData: monthlyManual
                };
                consolidatedData.push(row);
            }
            return consolidatedData;
        }


        // 9. Render Annual Report Table
        function renderAnnualReportTable(dataToRender) {
            const tableBody = document.getElementById('annual-data-body');
            tableBody.innerHTML = '';
            
            // Inisialisasi Total Footer
            let total = {
                koin: 0, donatur: 0, 
                pendidikan: { uang: 0, penerima: 0 }, 
                sosial: { uang: 0, penerima: 0 }, 
                kesehatan: { uang: 0, penerima: 0 }, 
                ekonomi: { uang: 0, penerima: 0 }, 
                banom: { uang: 0 }, 
                lain_lain: { uang: 0 }
            };

            dataToRender.forEach((data) => {
                const row = tableBody.insertRow();
                let isSaldoRow = data.type === 'saldo_bank' || data.type === 'saldo_kas';
                let nominalDisplay = isSaldoRow ? formatRupiah(data.koinNominal) : formatRupiah(data.koinNominal);

                // Update Total Footer
                total.koin += data.koinNominal;
                if (!isSaldoRow) {
                    total.donatur += data.donatur;
                    total.pendidikan.uang += data.pendidikan.uang;
                    total.pendidikan.penerima += data.pendidikan.penerima;
                    total.sosial.uang += data.sosial.uang;
                    total.sosial.penerima += data.sosial.penerima;
                    total.kesehatan.uang += data.kesehatan.uang;
                    total.kesehatan.penerima += data.kesehatan.penerima;
                    total.ekonomi.uang += data.ekonomi.uang;
                    total.ekonomi.penerima += data.ekonomi.penerima;
                    total.banom.uang += data.banom.uang;
                    total.lain_lain.uang += data.lain_lain.uang;
                }

                // Saldo Bank/Kas
                if(isSaldoRow) {
                    row.classList.add('annual-saldo-row');
                    const editableNominal = `<span class="editable-cell" data-type="${data.type}" data-key="nominal" data-id="${data.id}" onclick="editAnnualData('${data.id}', 'nominal', ${data.koinNominal})">${nominalDisplay}</span>`;
                    row.innerHTML = `
                        <td style="text-align: center;">${data.no}</td>
                        <td style="font-weight: bold;">${data.label}</td>
                        <td class="money-col">${editableNominal}</td>
                        <td colspan="13" style="text-align: center;">-</td>
                    `;
                } 
                // Monthly Data
                else if (data.type === 'monthly') {
                    row.classList.add('annual-manual-input');

                    // Helper function for editable cells (Uang & Penerima)
                    const createExpCells = (type, uang, penerima, id) => {
                        const uangCell = `<td class="money-col">${formatRupiah(uang)}</td>`; // Auto Uang
                        const penerimaCell = `<td class="money-col"><span class="editable-cell" data-type="monthly" data-key="${type}.penerima" data-id="${id}" onclick="editAnnualData('${id}', '${type}.penerima', ${penerima})">${penerima}</span></td>`; // Manual Penerima
                        return uangCell + penerimaCell;
                    };

                    // Helper function for Banom (Uang & Keterangan)
                    const createBanomCells = (uang, keterangan, id) => {
                        const uangCell = `<td class="money-col">${formatRupiah(uang)}</td>`; // Auto Uang
                        const ketCell = `<td style="text-align: center;"><span class="editable-cell" data-type="monthly" data-key="banom.keterangan" data-id="${id}" onclick="editAnnualData('${id}', 'banom.keterangan', '${keterangan}')">${keterangan || '-'}</span></td>`; // Manual Keterangan
                        return uangCell + ketCell;
                    };
                    
                    // Helper function for Lain-Lain (Uang & Uraian)
                    const createLainCells = (uang, uraian, id) => {
                        const uangCell = `<td class="money-col"><span class="editable-cell" data-type="monthly" data-key="lain_lain.nominal" data-id="${id}" onclick="editAnnualData('${id}', 'lain_lain.nominal', ${uang})">${formatRupiah(uang)}</span></td>`; // Manual Uang
                        const uraianCell = `<td style="text-align: center;"><span class="editable-cell" data-type="monthly" data-key="lain_lain.uraian" data-id="${id}" onclick="editAnnualData('${id}', 'lain_lain.uraian', '${uraian}')">${uraian || '-'}</span></td>`; // Manual Uraian
                        return uangCell + uraianCell;
                    };

                    // Cell for Koin Nominal (Auto)
                    const koinCell = `<td class="money-col">${formatRupiah(data.koinNominal)}</td>`;
                    
                    // Cell for Donatur (Manual)
                    const donaturCell = `<td class="money-col"><span class="editable-cell" data-type="monthly" data-key="donatur" data-id="${data.id}" onclick="editAnnualData('${data.id}', 'donatur', ${data.donatur})">${data.donatur}</span></td>`;


                    row.innerHTML = `
                        <td style="text-align: center;">${data.no}</td>
                        <td style="font-weight: bold;">${data.label}</td>
                        ${koinCell}
                        ${donaturCell}
                        ${createExpCells('pendidikan', data.pendidikan.uang, data.pendidikan.penerima, data.id)}
                        ${createExpCells('sosial', data.sosial.uang, data.sosial.penerima, data.id)}
                        ${createExpCells('kesehatan', data.kesehatan.uang, data.kesehatan.penerima, data.id)}
                        ${createExpCells('ekonomi', data.ekonomi.uang, data.ekonomi.penerima, data.id)}
                        ${createBanomCells(data.banom.uang, data.banom.keterangan, data.id)}
                        ${createLainCells(data.lain_lain.uang, data.lain_lain.uraian, data.id)}
                    `;
                }
            });

            // Update Footer
            document.getElementById('tahunan-total-koin').textContent = formatRupiah(total.koin);
            document.getElementById('tahunan-total-donatur').textContent = total.donatur;
            document.getElementById('tahunan-total-pend-uang').textContent = formatRupiah(total.pendidikan.uang);
            document.getElementById('tahunan-total-pend-penerima').textContent = total.pendidikan.penerima;
            document.getElementById('tahunan-total-sosial-uang').textContent = formatRupiah(total.sosial.uang);
            document.getElementById('tahunan-total-sosial-penerima').textContent = total.sosial.penerima;
            document.getElementById('tahunan-total-kes-uang').textContent = formatRupiah(total.kesehatan.uang);
            document.getElementById('tahunan-total-kes-penerima').textContent = total.kesehatan.penerima;
            document.getElementById('tahunan-total-eko-uang').textContent = formatRupiah(total.ekonomi.uang);
            document.getElementById('tahunan-total-eko-penerima').textContent = total.ekonomi.penerima;
            document.getElementById('tahunan-total-banom-uang').textContent = formatRupiah(total.banom.uang);
            document.getElementById('tahunan-total-lain-uang').textContent = formatRupiah(total.lain_lain.uang);
        }

        // ----------------------------------------------------
        // --- ADMIN & DATA MANAGEMENT FUNCTIONS ---
        // ----------------------------------------------------

        // 10. Filter Data (Universal)
        function filterData(module) {
            const selectedYear = document.getElementById(`${module}-filter-tahun`).value;
            const displayId = `${module}-pdf-periode-display`;
            const ttdId = `${module}-ttd-tanggal-output`;
            
            if (module === 'koin') {
                const selectedMonth = document.getElementById('koin-filter-bulan').value;
                const monthName = namaBulan[parseInt(selectedMonth) - 1];
                document.getElementById(displayId).textContent = `${monthName} ${selectedYear}`;
                
                // Tampilkan/Sembunyikan Aksi
                document.getElementById('koin-total-aksi').style.display = isLoggedIn ? 'table-cell' : 'none';
                document.getElementById('koin-aksi-header').style.display = isLoggedIn ? 'table-cell' : 'none';
                document.getElementById('koin-alamat-header').style.display = 'table-cell';
                document.getElementById('koin-hp-header').style.display = 'table-cell';
                
                const filtered = koinData.filter(data => {
                    const dataDate = new Date(data.tanggal + 'T00:00:00');
                    const dataMonth = (dataDate.getMonth() + 1).toString();
                    const dataYear = dataDate.getFullYear().toString();
                    return dataMonth === selectedMonth && dataYear === selectedYear;
                });
                renderKoinTable(filtered);
            } else if (module === 'jurnal') {
                const selectedMonth = document.getElementById('jurnal-filter-bulan').value;
                const monthName = namaBulan[parseInt(selectedMonth) - 1];
                document.getElementById(displayId).textContent = `${monthName} ${selectedYear}`;
                renderJurnalTable(jurnalData, selectedMonth, selectedYear);
            } else if (module === 'tahunan') {
                document.getElementById(displayId).textContent = selectedYear;
                const annualData = generateAnnualReportData(selectedYear);
                renderAnnualReportTable(annualData);
            }

            document.getElementById(ttdId).textContent = formatTanggalTTD();
        }


        // 11. Populate Filter Options
        function populateFilterOptions() {
            const currentYear = new Date().getFullYear();
            const startYear = 2024; // Tahun Mulai Data

            // Bulan
            const bulanOptions = namaBulan.map((name, index) => `<option value="${index + 1}">${name}</option>`).join('');
            document.getElementById('koin-filter-bulan').innerHTML = bulanOptions;
            document.getElementById('jurnal-filter-bulan').innerHTML = bulanOptions;
            
            // Set bulan ke bulan saat ini
            const currentMonth = new Date().getMonth() + 1;
            document.getElementById('koin-filter-bulan').value = currentMonth;
            document.getElementById('jurnal-filter-bulan').value = currentMonth;

            // Tahun
            let tahunOptions = '';
            for (let year = currentYear; year >= startYear; year--) {
                tahunOptions += `<option value="${year}">${year}</option>`;
            }
            document.getElementById('koin-filter-tahun').innerHTML = tahunOptions;
            document.getElementById('jurnal-filter-tahun').innerHTML = tahunOptions;
            document.getElementById('tahunan-filter-tahun').innerHTML = tahunOptions;

            document.getElementById('koin-filter-tahun').value = currentYear;
            document.getElementById('jurnal-filter-tahun').value = currentYear;
            document.getElementById('tahunan-filter-tahun').value = currentYear;
        }


        // 12. Download PDF (Universal)
        async function downloadPDF(moduleName) {
            const contentId = `${moduleName}-pdf-content`;
            const ttdAreaId = `${moduleName}-ttd-area`;
            const ttdDateId = `${moduleName}-ttd-date`;
            const downloadBtnId = `${moduleName}-download-btn-header`;
            const totalLabelId = `${moduleName}-total-label`;
            
            const ttdArea = document.getElementById(ttdAreaId);
            const ttdDate = document.getElementById(ttdDateId);
            const pdfContent = document.getElementById(contentId);
            const downloadButton = document.getElementById(downloadBtnId);
            const totalLabelCell = document.getElementById(totalLabelId);

            try {
                // Sembunyikan Tombol Aksi dan Editables
                downloadButton.style.display = 'none';
                if (totalLabelCell) {
                    totalLabelCell.colSpan = totalLabelCell.colSpan + 1;
                }
                document.getElementById(`${moduleName}-total-aksi`).style.display = 'none';
                document.getElementById(`${moduleName}-aksi-header`).style.display = 'none';
                
                if (moduleName === 'koin') {
                    document.getElementById('koin-alamat-header').style.display = 'table-cell'; // Tampilkan lagi jika sebelumnya disembunyikan
                    document.getElementById('koin-hp-header').style.display = 'table-cell'; // Tampilkan lagi jika sebelumnya disembunyikan
                }
                
                // Sembunyikan batas editable di laporan tahunan
                if (moduleName === 'tahunan') {
                    document.querySelectorAll('.editable-cell').forEach(el => el.style.borderBottom = 'none');
                }

                // Tampilkan TTD dan atur gaya cetak
                ttdArea.style.display = 'flex';
                ttdDate.style.display = 'block';
                pdfContent.style.padding = '20px';
                pdfContent.style.fontSize = '12px';
                
                // Konversi HTML ke Canvas/Gambar
                const canvas = await html2canvas(pdfContent, { scale: 2 });
                const imgData = canvas.toDataURL('image/png');
                
                // Buat PDF
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('l', 'mm', 'a4'); // 'l' for landscape, 'a4' size (297mm x 210mm)

                let pdfWidth;
                let pdfHeight;
                let position = 0;
                let heightLeft = canvas.height;

                if (moduleName === 'tahunan') {
                    // Jika Laporan Tahunan, gunakan ukuran A3 Landscape (420mm x 297mm)
                    pdf.internal.pageSize.width = 420;
                    pdf.internal.pageSize.height = 297;
                    pdfWidth = 420;
                    pdfHeight = (canvas.height * pdfWidth) / canvas.width;
                } else {
                    // A4 Landscape untuk Koin dan Jurnal
                    pdfWidth = pdf.internal.pageSize.getWidth();
                    pdfHeight = (canvas.height * pdfWidth) / canvas.width;
                }

                // Tambahkan halaman jika konten lebih dari satu halaman
                pdf.addImage(imgData, 'PNG', 0, position, pdfWidth, pdfHeight);
                heightLeft -= pdf.internal.pageSize.getHeight();
                
                while (heightLeft >= 0) {
                    position = heightLeft - pdfHeight;
                    pdf.addPage();
                    pdf.addImage(imgData, 'PNG', 0, position, pdfWidth, pdfHeight);
                    heightLeft -= pdf.internal.pageSize.getHeight();
                }

                pdf.save(`Laporan_${moduleName.toUpperCase()}_${document.getElementById(`${moduleName}-pdf-periode-display`).textContent.replace(' ', '_')}.pdf`);
                alert(`PDF berhasil dibuat untuk modul ${moduleName.toUpperCase()}.`);
                
            } catch (error) {
                console.error("Error generating PDF:", error);
                alert("Gagal membuat PDF. Coba lagi. Pastikan semua kolom yang tersisa muat dalam satu halaman.");
            } finally {
                // Kembalikan ke keadaan semula
                ttdArea.style.display = 'none';
                ttdDate.style.display = 'none';
                pdfContent.style.padding = '';
                pdfContent.style.fontSize = '';
                downloadButton.style.display = 'inline-block';

                if (moduleName === 'tahunan') {
                    // Restore editable cells' borders in the annual report
                    document.querySelectorAll('.editable-cell').forEach(el => el.style.borderBottom = '1px dashed #007bff');
                }
                
                // Panggil filterData untuk merestorasi tampilan tabel ke mode HTML normal
                filterData(moduleName);
            }
        }


        // 13. Save Data (Koin & Jurnal)
        function saveData(moduleName) {
            if (!isLoggedIn) {
                alert('Anda harus Login sebagai Admin untuk menyimpan data.');
                return;
            }
            
            if (moduleName === 'koin') {
                const newTanggal = document.getElementById('koin-input-tanggal').value;
                const newPetugas = document.getElementById('koin-input-petugas').value;
                const newHp = document.getElementById('koin-input-hp').value;
                const newDonatur = document.getElementById('koin-input-donatur').value;
                const newAlamat = document.getElementById('koin-input-alamat').value;
                const newNominal = parseInt(document.getElementById('koin-input-nominal').value || 0);

                if (newNominal <= 0 || !newTanggal || !newPetugas || !newDonatur || !newAlamat) {
                    alert('Mohon isi semua kolom dengan benar.');
                    return;
                }

                if (koinEditId === null) {
                    // Add new data
                    const newId = koinData.length > 0 ? Math.max(...koinData.map(d => d.id)) + 1 : 1;
                    koinData.push({ 
                        id: newId, 
                        tanggal: newTanggal, 
                        petugas: newPetugas, 
                        hp: newHp, 
                        donatur: newDonatur, 
                        alamat: newAlamat, 
                        nominal: newNominal 
                    });
                    alert('Data KOIN NU baru berhasil ditambahkan!');
                } else {
                    // Edit existing data
                    const index = koinData.findIndex(d => d.id === koinEditId);
                    if (index !== -1) {
                        koinData[index] = { 
                            id: koinEditId, 
                            tanggal: newTanggal, 
                            petugas: newPetugas, 
                            hp: newHp, 
                            donatur: newDonatur, 
                            alamat: newAlamat, 
                            nominal: newNominal 
                        };
                        alert('Data KOIN NU berhasil diubah!');
                    }
                }
                
                // Reset form
                document.getElementById('koin-input-area').querySelectorAll('input').forEach(input => input.value = '');
                koinEditId = null; 

            } else if (moduleName === 'jurnal') {
                const newTanggal = document.getElementById('jurnal-input-tanggal').value;
                const newKeterangan = document.getElementById('jurnal-input-keterangan').value;
                const newKategori = document.getElementById('jurnal-input-kategori').value;
                const newMasuk = parseInt(document.getElementById('jurnal-input-masuk').value || 0);
                const newKeluar = parseInt(document.getElementById('jurnal-input-keluar').value || 0);

                if (jurnalEditId === null) {
                    // Add new data (Validation: only one of Masuk/Keluar can be filled)
                    if (!newTanggal || !newKeterangan || !newKategori || (newMasuk === 0 && newKeluar === 0) || (newMasuk > 0 && newKeluar > 0)) {
                        alert('Mohon isi Tanggal, Keterangan, Kategori, dan hanya salah satu kolom Dana Masuk atau Dana Keluar.');
                        return;
                    }
                    const newId = jurnalData.length > 0 ? Math.max(...jurnalData.map(d => d.id)) + 1 : 1;
                    jurnalData.push({ 
                        id: newId, 
                        tanggal: newTanggal, 
                        keterangan: newKeterangan, 
                        kategori: newKategori, 
                        masuk: newMasuk, 
                        keluar: newKeluar, 
                        type: 'manual' 
                    });
                    alert('Data Jurnal baru berhasil ditambahkan!');
                } else {
                    // Edit Logic
                    const isSaldoBulanLaluEdit = jurnalEditId === 'new-saldo-awal' || jurnalData.find(d => d.id === jurnalEditId && d.kategori === 'Saldo Bulan Lalu');

                    if (isSaldoBulanLaluEdit) {
                        // Saldo Bulan Lalu Edit Logic
                        if (newMasuk === 0 && newKeluar === 0) {
                             alert('Saldo Bulan Lalu tidak boleh nol, silakan isi Dana Masuk.');
                             return;
                        }
                        if (newKeluar > 0) {
                             alert('Saldo Bulan Lalu hanya boleh diisi di kolom Dana Masuk.');
                             return;
                        }
                        
                        // Cari entri saldo bulan lalu yang sudah ada
                        const index = jurnalData.findIndex(d => d.kategori === 'Saldo Bulan Lalu');

                        if (index !== -1) {
                            jurnalData[index].tanggal = newTanggal;
                            jurnalData[index].masuk = newMasuk;
                            jurnalData[index].keterangan = newKeterangan;
                        } else {
                            // Jika ternyata tidak ada (hanya mungkin terjadi jika semua data jurnal dihapus), buat baru
                            const newId = jurnalData.length > 0 ? Math.max(...jurnalData.map(d => d.id)) + 1 : 1;
                            jurnalData.push({ id: newId, tanggal: newTanggal, keterangan: newKeterangan, kategori: 'Saldo Bulan Lalu', masuk: newMasuk, keluar: 0, type: 'manual_saldo' });
                        }
                        alert('Data Saldo Bulan Lalu berhasil diubah!');
                    } else {
                        // Regular Manual Entry Edit Logic
                        if (!newTanggal || !newKeterangan || !newKategori || (newMasuk === 0 && newKeluar === 0) || (newMasuk > 0 && newKeluar > 0)) {
                            alert('Mohon isi Tanggal, Keterangan, Kategori, dan hanya salah satu kolom Dana Masuk atau Dana Keluar.');
                            return;
                        }
                        const index = jurnalData.findIndex(d => d.id === jurnalEditId);
                        if (index !== -1) {
                            jurnalData[index] = { 
                                id: jurnalEditId, 
                                tanggal: newTanggal, 
                                keterangan: newKeterangan, 
                                kategori: newKategori, 
                                masuk: newMasuk, 
                                keluar: newKeluar,
                                type: 'manual'
                            };
                            alert('Data Jurnal berhasil diubah!');
                        }
                    }
                }
                
                // Reset form
                cancelEdit('jurnal'); 
            }
            filterData(moduleName);
        }


        // 14. Edit Data (Koin & Jurnal)
        function editData(moduleName, id) {
            if (!isLoggedIn) return;

            if (moduleName === 'koin') {
                const data = koinData.find(d => d.id === id);
                if (data) {
                    document.getElementById('koin-input-tanggal').value = data.tanggal;
                    document.getElementById('koin-input-petugas').value = data.petugas;
                    document.getElementById('koin-input-hp').value = data.hp;
                    document.getElementById('koin-input-donatur').value = data.donatur;
                    document.getElementById('koin-input-alamat').value = data.alamat;
                    document.getElementById('koin-input-nominal').value = data.nominal;
                    koinEditId = id; 
                    window.scrollTo(0, document.getElementById('koin-input-area').offsetTop);
                }
            } else if (moduleName === 'jurnal') {
                // Find existing data
                let data;
                const isSaldoAwal = id === 'new-saldo-awal';
                if (isSaldoAwal) {
                    // Jika Saldo Awal, cari yang kategori 'Saldo Bulan Lalu'
                    data = jurnalData.find(d => d.kategori === 'Saldo Bulan Lalu');
                } else {
                    data = jurnalData.find(d => d.id === id);
                }
                
                if (data) {
                    document.getElementById('jurnal-input-area').style.display = 'block';
                    document.getElementById('jurnal-input-tanggal').value = data.tanggal;
                    document.getElementById('jurnal-input-keterangan').value = data.keterangan;
                    document.getElementById('jurnal-input-kategori').value = data.kategori;
                    document.getElementById('jurnal-input-masuk').value = data.masuk;
                    document.getElementById('jurnal-input-keluar').value = data.keluar;
                    
                    if (isSaldoAwal || data.kategori === 'Saldo Bulan Lalu') {
                         document.getElementById('jurnal-input-kategori').disabled = true;
                         document.getElementById('jurnal-input-keluar').disabled = true;
                         document.getElementById('jurnal-input-masuk').disabled = false;
                    } else {
                         document.getElementById('jurnal-input-keluar').disabled = data.masuk > 0;
                         document.getElementById('jurnal-input-masuk').disabled = data.keluar > 0;
                         document.getElementById('jurnal-input-kategori').disabled = false;
                    }
                    
                    jurnalEditId = isSaldoAwal ? 'new-saldo-awal' : data.id; 
                    window.scrollTo(0, document.getElementById('jurnal-input-area').offsetTop);
                }
            }
        }


        // 15. Cancel Edit (Koin & Jurnal)
        function cancelEdit(moduleName) {
            if (moduleName === 'koin') {
                document.getElementById('koin-input-area').querySelectorAll('input').forEach(input => input.value = '');
                koinEditId = null;
            } else if (moduleName === 'jurnal') {
                document.getElementById('jurnal-input-area').querySelectorAll('input').forEach(input => input.value = '');
                document.getElementById('jurnal-input-kategori').value = '';
                document.getElementById('jurnal-input-masuk').disabled = false;
                document.getElementById('jurnal-input-keluar').disabled = false;
                document.getElementById('jurnal-input-tanggal').disabled = false;
                document.getElementById('jurnal-input-keterangan').disabled = false;
                document.getElementById('jurnal-input-kategori').disabled = false;
                jurnalEditId = null;
                updateMasukKeluarFields();
            }
        }

        // 16. Update Masuk Keluar Fields (Jurnal)
        function updateMasukKeluarFields() {
            const kategori = document.getElementById('jurnal-input-kategori').value;
            const masukInput = document.getElementById('jurnal-input-masuk');
            const keluarInput = document.getElementById('jurnal-input-keluar');
            
            const masukKategori = ['Koin NU', 'Donatur', 'Zakat Mall', 'Infaq', 'Shodaqoh', 'Saldo Bulan Lalu', 'Hasil Usaha'];
            const keluarKategori = ['Petugas (10%)', 'MWC (25%)', 'PC (5%)', 'Ranting (60%)', 'Untuk Pendidikan', 'Untuk Sosial', 'Untuk Ekonomi', 'Untuk Kesehatan', 'Subsidi Banom & Lembaga NU', 'Lain-lain'];

            masukInput.disabled = false;
            keluarInput.disabled = false;
            
            if (jurnalEditId === null) {
                masukInput.value = '';
                keluarInput.value = '';
                
                if (masukKategori.includes(kategori)) {
                    keluarInput.disabled = true; // Hanya boleh mengisi Masuk
                } else if (keluarKategori.includes(kategori)) {
                    masukInput.disabled = true; // Hanya boleh mengisi Keluar
                }
            } else {
                 // Logic for editing mode (should be handled in editData/saveData)
            }
        }

        // 17. Delete Data (Koin & Jurnal)
        function deleteData(moduleName, id) {
            if (!isLoggedIn) return;
            if (id === null || id === undefined || id === 'new-saldo-awal') return;
            
            const numericalId = parseInt(id); 

            if (moduleName === 'jurnal') {
                const dataToDelete = jurnalData.find(d => d.id === numericalId); 
                if (dataToDelete && dataToDelete.kategori === 'Saldo Bulan Lalu') {
                     alert('Entri Saldo Bulan Lalu adalah baris kunci dan tidak dapat dihapus, hanya dapat diubah (Edit).');
                     return;
                }
            }


            if (confirm('Yakin ingin menghapus data ini?')) {
                if (moduleName === 'koin') {
                    koinData = koinData.filter(d => d.id !== numericalId); 
                    alert('Data KOIN NU berhasil dihapus.');
                } else if (moduleName === 'jurnal') {
                    jurnalData = jurnalData.filter(d => d.id !== numericalId); 
                    alert('Data Jurnal berhasil dihapus.');
                }
                filterData(moduleName);
            }
        }
        
        // 18. Delete All Data
        function deleteAllDataGlobal(moduleName) {
            if (!isLoggedIn) return;
            
            if (confirm(`PERINGATAN! Anda yakin ingin menghapus SEMUA data ${moduleName.toUpperCase()}? Tindakan ini tidak dapat dibatalkan.`)) {
                if (moduleName === 'koin') {
                    koinData = [];
                    alert('Semua Data KOIN NU telah dihapus.');
                } else if (moduleName === 'jurnal') {
                    // Kecualikan entri 'Saldo Bulan Lalu' agar tidak terhapus semua
                    jurnalData = jurnalData.filter(d => d.kategori === 'Saldo Bulan Lalu'); 
                    alert('Semua Data Jurnal (kecuali Saldo Bulan Lalu) telah dihapus.');
                }
                filterData(moduleName);
            }
        }

        // 19. Edit Data Laporan Tahunan
        function editAnnualData(id, key, currentValue) {
            if (!isLoggedIn) return;
            
            document.getElementById('tahunan-edit-input-area').style.display = 'block';
            currentAnnualEditKey = key;
            
            // Tentukan label dan tampilkan/sembunyikan input keterangan
            let label = '';
            let showKeterangan = false;
            let isNumeric = true;

            if (key === 'saldo_bank' || key === 'saldo_kas') {
                label = (key === 'saldo_bank' ? 'SALDO DI BANK' : 'SALDO KAS TUNAI');
            } else if (key === 'donatur') {
                label = `Jml Donatur (${id.split('_')[2]})`;
            } else if (key.endsWith('.penerima')) {
                const category = key.split('.')[0];
                label = `Jml Penerima ${category.toUpperCase()} (${id.split('_')[2]})`;
            } else if (key === 'banom.keterangan') {
                label = `Keterangan Subsidi Banom (${id.split('_')[2]})`;
                showKeterangan = true;
                isNumeric = false;
            } else if (key === 'lain_lain.nominal') {
                label = `Jml Uang Lain-lain (${id.split('_')[2]})`;
            } else if (key === 'lain_lain.uraian') {
                label = `Uraian Lain-lain (${id.split('_')[2]})`;
                showKeterangan = true;
                isNumeric = false;
            }

            document.getElementById('annual-edit-label').value = label;
            document.getElementById('annual-edit-nominal').value = isNumeric ? currentValue : '';
            document.getElementById('annual-edit-nominal').style.display = isNumeric ? 'block' : 'none';
            document.getElementById('annual-edit-keterangan').value = !isNumeric ? currentValue : '';
            document.getElementById('annual-edit-keterangan-group').style.display = showKeterangan ? 'block' : 'none';

            window.scrollTo(0, document.getElementById('tahunan-edit-input-area').offsetTop);
        }

        // 20. Simpan Perubahan Laporan Tahunan
        function saveAnnualReportData() {
            if (!isLoggedIn) return;

            const id = document.getElementById('annual-edit-label').value.split('(')[0].trim().replace(/ /g, '_').toLowerCase();
            const type = id.includes('saldo') ? id : 'monthly';
            const rawValue = document.getElementById('annual-edit-nominal').value;
            const rawKeterangan = document.getElementById('annual-edit-keterangan').value;
            let newValue;

            if (currentAnnualEditKey === 'banom.keterangan' || currentAnnualEditKey === 'lain_lain.uraian') {
                newValue = rawKeterangan;
            } else {
                newValue = parseInt(rawValue || 0);
            }

            if (isNaN(newValue) && typeof newValue === 'number') {
                alert('Input harus berupa angka.');
                return;
            }

            // 1. Parse ID dan cari data yang akan diubah
            const parts = id.split('_');
            const year = parseInt(document.getElementById('tahunan-filter-tahun').value); 
            const month = type === 'monthly' ? parseInt(parts[parts.length - 1].replace(')', '')) : undefined; 
            
            let targetIndex = -1;
            if (type.includes('saldo')) {
                targetIndex = annualData.findIndex(d => d.type === type && d.year === year);
            } else if (type === 'monthly') {
                targetIndex = annualData.findIndex(d => d.type === 'monthly' && d.year === year && d.month === month);
            }
            
            let targetData = targetIndex !== -1 ? annualData[targetIndex] : null;

            // 2. Create new object if it doesn't exist (only for monthly)
            if (!targetData) {
                if (type === 'monthly') {
                    targetData = { 
                        type: 'monthly', year: year, month: month, donatur: 0,
                        pendidikan: { penerima: 0 }, sosial: { penerima: 0 }, kesehatan: { penerima: 0 },
                        ekonomi: { penerima: 0 }, banom: { keterangan: '' }, lain_lain: { nominal: 0, uraian: '' }
                    };
                    annualData.push(targetData);
                    targetIndex = annualData.length - 1;
                } else {
                    alert('Error: Saldo awal tidak ditemukan, tidak dapat disimpan.');
                    return;
                }
            }
            
            // 3. Update the value based on the key (using dot notation)
            const keys = currentAnnualEditKey.split('.');
            let obj = targetData;
            
            for (let i = 0; i < keys.length - 1; i++) {
                obj = obj[keys[i]];
            }
            obj[keys[keys.length - 1]] = newValue;

            // 4. Update Saldo Bank/Kas nominal directly
            if (type.includes('saldo')) {
                targetData.nominal = newValue;
            }

            alert('Data tahunan berhasil diubah!');
            cancelAnnualEdit();
            filterData('tahunan'); 
        }

        // 21. Batal Edit Laporan Tahunan
        function cancelAnnualEdit() {
            document.getElementById('tahunan-edit-input-area').style.display = 'none';
            document.getElementById('annual-edit-nominal').value = '';
            document.getElementById('annual-edit-keterangan').value = '';
            currentAnnualEditKey = null;
        }


        // ----------------------------------------------------
        // --- INITIALIZATION ---
        // ----------------------------------------------------
        
        // Ganti fungsi init() lama
        function init() {
            populateFilterOptions();
            
            // Atur tampilan awal: Sembunyikan semua modul dan tampilkan Login Area
            document.getElementById('login-area').style.display = 'block';
            document.getElementById('koin-nu-module').style.display = 'none';
            document.getElementById('jurnal-umum-module').style.display = 'none';
            document.getElementById('laporan-tahunan-module').style.display = 'none';
            
            // Muat data default di awal (meski disembunyikan)
            filterData('koin'); 
            filterData('jurnal'); 
            filterData('tahunan');
        }


        window.onload = init;
    </script>
</body>
</html>
