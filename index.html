<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pembukuan Haul: Donatur, Jurnal & Ekspor Firebase</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <style>
        /* Gaya agar tabel bisa digeser jika terlalu lebar */
        .table-wrapper {
            overflow-x: auto; 
        }

        /* --- PERBAIKAN FONT DAN TEBAL --- */
        /* Ganti font global ke Cambria / Times New Roman / Serif */
        body {
            font-family: Cambria, 'Times New Roman', Times, serif;
            padding: 0 0 80px 0; 
            background-color: #f8f9fa; 
            margin: 0; 
        }

        /* Terapkan tebal untuk elemen penting */
        .text-bold { font-weight: bold; }

        h1, h2, h3, h4, h5, th {
            font-weight: bold;
        }

        /* Gaya Khusus Tabel */
        #tabel-modul-2 {
            width: 100%;
            border-collapse: collapse;
            font-size: 11px; /* Ukuran font lebih kecil untuk kerapatan */
        }
        #tabel-modul-2 th, #tabel-modul-2 td {
            border: 1px solid #dee2e6;
            padding: 5px;
            text-align: left;
            vertical-align: top;
        }
        #tabel-modul-2 thead th {
            background-color: #e9ecef;
            text-align: center;
        }
        #tabel-modul-2 tbody tr:nth-child(even) {
            background-color: #f8f9fa; /* Warna selang-seling */
        }

        /* Header Sticky untuk Modul 2 */
        #tabel-modul-2 thead {
            position: sticky;
            top: 0; /* Tetap di atas saat digulir */
            z-index: 10;
        }

        /* Kontainer Gulir */
        .table-scroll-wrapper {
            max-height: 400px; /* Tinggi maksimum sebelum gulir vertikal muncul */
            overflow-y: auto;
            margin-bottom: 10px;
            border: 1px solid #dee2e6;
        }


        /* CSS untuk Navbar */
        #main-nav {
            background-color: #006400;
            padding: 10px 20px;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 20; /* Lebih tinggi dari header tabel */
        }
        #main-nav h1 {
            color: white;
            font-size: 18px;
            margin: 0;
            flex-shrink: 0;
        }
        #nav-menu {
            display: flex;
            list-style: none;
            padding: 0;
            margin: 0;
        }
        #nav-menu li {
            margin-left: 20px;
        }
        #nav-menu button {
            background: none;
            border: none;
            color: white;
            padding: 5px 10px;
            cursor: pointer;
            font-weight: bold;
        }
        #nav-menu button.active {
            background-color: #008000;
            border-radius: 5px;
        }

        /* CSS untuk Login/Logout */
        #login-status {
            color: white;
            font-size: 14px;
            display: flex;
            align-items: center;
        }
        #login-status button {
            margin-left: 10px;
            background-color: #8b0000; /* Merah Marun untuk Logout */
            padding: 5px 10px;
            border-radius: 5px;
            font-weight: bold;
        }

        /* Container Modul Utama */
        #app-container {
            padding: 20px;
        }
        
        /* Font dan ukuran input */
        input[type="text"], input[type="number"], input[type="date"], select {
            padding: 5px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
            width: 100%;
        }

        /* Admin only view */
        .admin-only-hidden {
            display: none;
        }
    </style>
</head>
<body>

    <nav id="main-nav">
        <h1>Sistem Pembukuan KOIN NU</h1>
        <ul id="nav-menu">
            <li><button onclick="showTab('donatur')">Modul 1A & Donatur</button></li>
            <li><button onclick="showTab('jurnal')">Modul 2 Jurnal Umum</button></li>
            <li><button onclick="showTab('laporan')">Modul 3 Laporan</button></li>
        </ul>
        <div id="login-status">
            <span id="user-email-display">Loading...</span>
            <button id="auth-button" onclick="handleAuth()">Login</button>
        </div>
    </nav>

    <div id="login-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 100;">
        <div style="background: white; width: 300px; margin: 100px auto; padding: 20px; border-radius: 8px;">
            <h2>Login Admin</h2>
            <input type="email" id="login-email" placeholder="Email" style="margin-bottom: 10px;">
            <input type="password" id="login-password" placeholder="Password" style="margin-bottom: 10px;">
            <button onclick="loginUser()" style="width: 100%; background-color: #006400; color: white; padding: 10px; border-radius: 5px; margin-top: 10px;">Login</button>
            <button onclick="toggleModal(false)" style="width: 100%; background-color: #ccc; color: black; padding: 10px; border-radius: 5px; margin-top: 5px;">Batal</button>
        </div>
    </div>


    <div id="app-container">
        
        <div id="donatur" class="p-4" style="display: none;">
            <h2 class="text-green-800 text-lg">MODUL 1A: Input Donatur Koin NU</h2>
            
            <div id="modul-1a-section" class="bg-white p-4 shadow-md rounded-md mb-6">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <div>
                        <label for="m1a-tanggal-input" class="block text-sm font-medium text-gray-700">Tanggal</label>
                        <input type="date" id="m1a-tanggal-input" required>
                    </div>
                    <div>
                        <label for="m1a-nama-petugas-input" class="block text-sm font-medium text-gray-700">Nama Petugas</label>
                        <input type="text" id="m1a-nama-petugas-input" required>
                    </div>
                    <div>
                        <label for="m1a-nominal-input" class="block text-sm font-medium text-gray-700">Nominal Koin NU</label>
                        <input type="number" id="m1a-nominal-input" placeholder="Nominal Uang" min="1000" required data-edit-id="">
                    </div>
                    <div>
                        <label for="m1a-no-hp-input" class="block text-sm font-medium text-gray-700">No. HP Donatur</label>
                        <input type="text" id="m1a-no-hp-input" placeholder="08xxxx">
                    </div>
                    <div>
                        <label for="m1a-donatur-input" class="block text-sm font-medium text-gray-700">Nama Donatur</label>
                        <input type="text" id="m1a-donatur-input" placeholder="Nama Donatur">
                    </div>
                    <div>
                        <label for="m1a-alamat-input" class="block text-sm font-medium text-gray-700">Alamat Donatur</label>
                        <input type="text" id="m1a-alamat-input" placeholder="RT/RW, Desa">
                    </div>
                </div>
                <button onclick="addKoinNUTransaction()" class="mt-4 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
                    Tambah Koin NU
                </button>
                <button onclick="clearKoinNUInputs()" class="mt-4 bg-gray-400 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded ml-2">
                    Reset Form
                </button>
            </div>

            <h3 class="text-green-800 text-base mt-8">MODUL 1: Data Donatur Koin NU</h3>
            <div class="table-scroll-wrapper">
                <table class="w-full text-sm text-left text-gray-500 dark:text-gray-400" id="donatur-table">
                    <thead class="text-xs text-gray-700 uppercase bg-gray-50 dark:bg-gray-700 dark:text-gray-400 sticky top-0" style="z-index: 1;">
                        <tr>
                            <th scope="col" class="py-3 px-6" style="width: 5%;">No</th>
                            <th scope="col" class="py-3 px-6" style="width: 10%;">Tanggal</th>
                            <th scope="col" class="py-3 px-6" style="width: 15%;">Petugas</th>
                            <th scope="col" class="py-3 px-6" style="width: 20%;">Donatur</th>
                            <th scope="col" class="py-3 px-6" style="width: 15%;">No. HP</th>
                            <th scope="col" class="py-3 px-6" style="width: 20%;">Alamat</th>
                            <th scope="col" class="py-3 px-6 text-right" style="width: 10%;">Nominal</th>
                            <th scope="col" class="py-3 px-6" style="width: 5%;">Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="donatur-table-body">
                        </tbody>
                </table>
            </div>

            <div id="donatur-pagination" class="flex justify-between items-center mt-4">
                <button onclick="prevDonaturPage()" class="bg-gray-200 hover:bg-gray-300 py-1 px-3 rounded">Sebelumnya</button>
                <span id="donatur-page-info" class="text-sm">Halaman 1</span>
                <button onclick="nextDonaturPage()" class="bg-gray-200 hover:bg-gray-300 py-1 px-3 rounded">Berikutnya</button>
            </div>
        </div>

        <div id="jurnal" class="p-4" style="display: none;">
            <h2 class="text-green-800 text-lg">MODUL 2: Jurnal Umum (Input Transaksi Lain)</h2>

            <div id="modul-2-input-section" class="bg-white p-4 shadow-md rounded-md mb-6">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    <div>
                        <label for="m2-tanggal-input" class="block text-sm font-medium text-gray-700">Tanggal</label>
                        <input type="date" id="m2-tanggal-input" required>
                    </div>
                    <div>
                        <label for="m2-keterangan-input" class="block text-sm font-medium text-gray-700">Keterangan</label>
                        <input type="text" id="m2-keterangan-input" placeholder="Contoh: Pembelian alat tulis" required>
                    </div>
                    <div>
                        <label for="m2-kategori-input" class="block text-sm font-medium text-gray-700">Kategori</label>
                        <select id="m2-kategori-input" required>
                            <option value="Infaq dan Shodaqoh">Infaq dan Shodaqoh</option>
                            <option value="Bantuan Sosial (Sosum)">Bantuan Sosial (Sosum)</option>
                            <option value="Banom">Banom</option>
                            <option value="Bencana">Bencana</option>
                            <option value="Rapat dan Koordinasi">Rapat dan Koordinasi</option>
                            <option value="Perawatan">Perawatan</option>
                            <option value="Biaya Bank">Biaya Bank</option>
                            <option value="Lain-lain">Lain-lain</option>
                            <option value="Pendidikan (Lainnya)">Pendidikan (Lainnya)</option>
                            <option value="Penerimaan Lain">Penerimaan Lain</option>
                        </select>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="m2-debit-input" class="block text-sm font-medium text-gray-700">Debit (Masuk)</label>
                            <input type="number" id="m2-debit-input" placeholder="0" min="0" data-edit-id="">
                        </div>
                        <div>
                            <label for="m2-kredit-input" class="block text-sm font-medium text-gray-700">Kredit (Keluar)</label>
                            <input type="number" id="m2-kredit-input" placeholder="0" min="0">
                        </div>
                    </div>
                </div>
                <button onclick="addManualTransaction()" class="mt-4 bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded">
                    Tambah Transaksi Lain
                </button>
                <button onclick="clearManualTransactionInputs()" class="mt-4 bg-gray-400 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded ml-2">
                    Reset Form
                </button>
            </div>

            <h3 class="text-green-800 text-base mt-8">Tabel Jurnal Umum (Gabungan Donatur dan Manual)</h3>
            
            <div id="modul-2-section" class="bg-white shadow-md rounded-md">
                <div class="table-scroll-wrapper">
                    <table id="tabel-modul-2">
                        <thead class="text-xs text-gray-700 uppercase bg-gray-50 dark:bg-gray-700 dark:text-gray-400 sticky top-0" style="z-index: 10;">
                            <tr>
                                <th style="width: 30px;">ID/Aksi</th>
                                <th style="width: 80px;">TANGGAL</th>
                                <th style="min-width: 200px;">KETERANGAN</th>
                                <th>KATEGORI</th>
                                <th style="min-width: 120px;">DANA MASUK (DEBIT)</th>
                                <th style="min-width: 120px;">DANA KELUAR (KREDIT)</th>
                                <th style="min-width: 120px;">SALDO</th>
                            </tr>
                        </thead>
                        <tbody id="m2-transaction-body">
                            <tr> 
                                <td colspan="4" class="saldo-awal-row text-right font-bold">Saldo Bulan Lalu:</td> 
                                <td colspan="2"> 
                                    <div id="m2-saldo-awal-display-container" class="admin-only-hidden" style="width: 100%; text-align: right; background-color: #fffacd; font-weight: bold; padding: 0; box-sizing: border-box;">
                                        <input type="number" id="m2-saldo-awal-input" value="0" min="0" oninput="m2SaldoAwal = parseInt(this.value)||0; recalculateAllReports(); renderAllTables();" style="width: 100%; text-align: right; padding: 5px; font-size: 11px;">
                                    </div>
                                    <span id="m2-saldo-awal-static" style="display: block; width: 100%; text-align: right; background-color: #fffacd; font-weight: bold; padding: 5px;">0</span>
                                </td>
                                <td id="m2-saldo-awal-display" class="saldo-awal-row text-right font-bold">0</td>
                            </tr>
                            </tbody>
                    </table>
                </div>
            </div>

            <div id="jurnal-pagination" class="flex justify-between items-center mt-4">
                <button onclick="prevJurnalPage()" class="bg-gray-200 hover:bg-gray-300 py-1 px-3 rounded">Sebelumnya</button>
                <span id="jurnal-page-info" class="text-sm">Halaman 1</span>
                <button onclick="nextJurnalPage()" class="bg-gray-200 hover:bg-gray-300 py-1 px-3 rounded">Berikutnya</button>
            </div>
        </div>

        <div id="laporan" class="p-4" style="display: none;">
            <h2 class="text-green-800 text-lg">MODUL 3: Laporan Keuangan (Laporan Pertanggungjawaban Global)</h2>
            <div class="mb-4">
                <button onclick="exportLaporanGlobalPDF()" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded">
                    Ekspor Laporan Global PDF
                </button>
            </div>
            
            <div id="modul-3-section" class="bg-white p-4 shadow-md rounded-md">
                <div id="m3-summary-info">
                    </div>

                <div class="table-scroll-wrapper mt-4">
                    <table class="w-full text-sm text-gray-700" id="tabel-modul-3">
                        <thead class="text-xs uppercase bg-gray-50 sticky top-0" style="z-index: 1;">
                            <tr>
                                <th rowspan="2" class="py-2 px-3 border">POS</th>
                                <th colspan="2" class="py-2 px-3 border">1. Donatur</th>
                                <th colspan="2" class="py-2 px-3 border">2. Infaq dan Shodaqoh</th>
                                <th colspan="2" class="py-2 px-3 border">3. Bantuan Sosial (Sosum)</th>
                                <th colspan="2" class="py-2 px-3 border">4. Banom</th>
                                <th colspan="2" class="py-2 px-3 border">5. Bencana</th>
                                <th rowspan="2" class="py-2 px-3 border">6. Rapat & Koordinasi</th>
                                <th rowspan="2" class="py-2 px-3 border">7. Perawatan MLU</th>
                                <th rowspan="2" class="py-2 px-3 border">8. Biaya Bank</th>
                                <th rowspan="2" class="py-2 px-3 border">9. Lain-lain</th>
                                <th rowspan="2" class="py-2 px-3 border">Total Pengeluaran (Rp)</th>
                                <th rowspan="2" class="py-2 px-3 border">Total Penerima (Orang)</th>
                            </tr>
                            <tr>
                                <th class="py-2 px-3 border">Uang (Rp)</th>
                                <th class="py-2 px-3 border">Penerima</th>
                                <th class="py-2 px-3 border">Uang (Rp)</th>
                                <th class="py-2 px-3 border">Penerima</th>
                                <th class="py-2 px-3 border">Uang (Rp)</th>
                                <th class="py-2 px-3 border">Penerima</th>
                                <th class="py-2 px-3 border">Uang (Rp)</th>
                                <th class="py-2 px-3 border">Penerima</th>
                                <th class="py-2 px-3 border">Uang (Rp)</th>
                                <th class="py-2 px-3 border">Penerima</th>
                            </tr>
                        </thead>
                        <tbody id="m3-report-body">
                            </tbody>
                        <tfoot id="m3-report-footer">
                            </tfoot>
                    </table>
                </div>
            </div>
        </div>

    </div>

    <script>
        // ================================================================================
        // 1. KONFIGURASI DAN VARIABEL GLOBAL
        // ================================================================================
        
        // GANTI DENGAN KONFIGURASI FIREBASE ANDA SENDIRI
        const firebaseConfig = {
    apiKey: "AIzaSyA_8NMmZBaXZ4H6KQt7rHy8G1URR3HLP3A",
    authDomain: "upzis-ngablak.firebaseapp.com",
    projectId: "upzis-ngablak",
    storageBucket: "upzis-ngablak.firebasestorage.app",
    messagingSenderId: "869549648344",
    appId: "1:869549648344:web:a531a37cce3a87bb672aad"
        };
        
        // Variabel Firebase Global (akan diinisialisasi di window.onload)
        let db;
        let auth;

        // Variabel Data Global
        let allTransactions = []; // Menyimpan Donatur Koin NU (M1A)
        let m2ManualTransactions = []; // Menyimpan Transaksi Manual (M2)
        let m3Data = getInitialM3Data(); // Data kerangka laporan M3
        let m2SaldoAwal = 0; // Saldo awal

        // Status Aplikasi
        let isLoggedIn = false;
        let currentDonaturPage = 1;
        let itemsPerDonaturPage = 10;
        let currentJurnalPage = 1;
        let itemsPerJurnalPage = 15;


        // ================================================================================
        // 2. UTILITAS
        // ================================================================================

        function getInitialM3Data() {
            return {
                bulan: '', tahun: '',
                donaturUang: 0, donaturPenerima: 0,
                infaqUang: 0, infaqPenerima: 0,
                sosumUang: 0, sosumPenerima: 0,
                banomUang: 0, banomPenerima: 0,
                bencanaUang: 0, bencanaPenerima: 0,
                rapat: 0,
                perwtnMlu: 0,
                biayaBank: 0,
                lainLain: 0,
            };
        }
        
        function formatNominal(num) {
            return num.toLocaleString('id-ID');
        }

        function showTab(tabName) {
            document.getElementById('donatur').style.display = 'none';
            document.getElementById('jurnal').style.display = 'none';
            document.getElementById('laporan').style.display = 'none';
            document.getElementById(tabName).style.display = 'block';

            // Update status aktif di nav
            document.querySelectorAll('#nav-menu button').forEach(btn => {
                btn.classList.remove('active');
                if (btn.innerText.toLowerCase().includes(tabName)) {
                    btn.classList.add('active');
                }
            });
            
            // Render ulang tabel saat pindah tab
            if (tabName === 'donatur' || tabName === 'jurnal') {
                renderAllTables();
            } else if (tabName === 'laporan') {
                recalculateAllReports();
                renderLaporanGlobal();
            }
        }
        
        // ================================================================================
        // 3. AUTENTIKASI (FIREBASE AUTH)
        // ================================================================================

        function toggleModal(show) {
            document.getElementById('login-modal').style.display = show ? 'block' : 'none';
        }

        function handleAuth() {
            if (isLoggedIn) {
                auth.signOut();
            } else {
                toggleModal(true);
            }
        }

        async function loginUser() {
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            try {
                await auth.signInWithEmailAndPassword(email, password);
                toggleModal(false);
            } catch (error) {
                alert("Login gagal: " + error.message);
                console.error("Login Error:", error);
            }
        }

        function handleAuthStateChange(user) {
            isLoggedIn = !!user;
            const userDisplay = document.getElementById('user-email-display');
            const authButton = document.getElementById('auth-button');
            const saldoInputContainer = document.getElementById('m2-saldo-awal-display-container');
            const saldoStatic = document.getElementById('m2-saldo-awal-static');


            if (user) {
                userDisplay.innerText = `Admin: ${user.email}`;
                authButton.innerText = 'Logout';
                // Tampilkan input saldo dan sembunyikan static display
                saldoInputContainer.style.display = 'block';
                saldoStatic.style.display = 'none';
                
            } else {
                userDisplay.innerText = 'Belum Login';
                authButton.innerText = 'Login';
                // Sembunyikan input saldo dan tampilkan static display
                saldoInputContainer.style.display = 'none';
                saldoStatic.style.display = 'block';
            }
        }

        // ================================================================================
        // 4. CRUD DAN DATA (MIGRASI KE FIREBASE FIRESTORE)
        // ================================================================================
        
        // =================================== 
        // --- CRUD FIREBASE BARU --- 
        // ===================================
        const deleteTransactionFromFirebase = async (transactionId) => {
            if (!auth.currentUser) {
                alert("Anda harus login untuk menghapus data.");
                return;
            }
            if (!confirm("Apakah Anda yakin ingin menghapus transaksi ini secara permanen?")) {
                return;
            }
            
            try {
                // Hapus dari koleksi user spesifik
                await db.collection("users").doc(auth.currentUser.uid).collection("transactions").doc(transactionId).delete();
                
                console.log("Transaksi berhasil dihapus:", transactionId);
                
                await loadTransactions(); 
                renderAllTables(); 
                recalculateAllReports();
                
            } catch (error) {
                console.error("Error menghapus transaksi: ", error);
                alert("Gagal menghapus data dari Firebase. Lihat konsol untuk detail.");
            }
        };

        const saveTransactionToFirebase = async (data) => {
            const user = auth.currentUser;
            if (!user) {
                alert("Anda harus login untuk menyimpan data.");
                return null;
            }
            
            try {
                if (data.id) {
                    // Update transaksi yang sudah ada (Edit)
                    const docRef = db.collection("users").doc(user.uid).collection("transactions").doc(data.id);
                    // Hapus 'id' dari data sebelum update
                    const { id, ...updatedData } = data; 
                    await docRef.update(updatedData);
                    console.log("Transaksi berhasil diupdate:", data.id);
                    return data.id;

                } else {
                    // Tambahkan transaksi baru (Input Baru)
                    const docRef = await db.collection("users").doc(user.uid).collection("transactions").add({
                        ...data,
                        timestamp: firebase.firestore.Timestamp.now()
                    });
                    console.log("Transaksi berhasil disimpan dengan ID:", docRef.id);
                    return docRef.id;
                }
            } catch (error) {
                console.error("Error menyimpan/mengupdate transaksi: ", error);
                alert("Gagal menyimpan data ke Firebase. Lihat konsol untuk detail.");
                return null;
            }
        };
        // =================================== 
        // --- AKHIR CRUD FIREBASE BARU --- 
        // ===================================

        // Modul 1A - Hapus
        function deleteKoinNUTxn(transactionId) {
            if (!isLoggedIn) return; 
            deleteTransactionFromFirebase(transactionId);
        }

        // Modul 1A - Edit
        function editKoinNUTxn(transactionId) {
            if (!isLoggedIn) return; 
            
            // Cari transaksi di data Donatur
            const tx = allTransactions.find(t => t.id === transactionId);
            
            if (tx) {
                // Pastikan konversi tanggal aman
                const dateValue = (tx.date instanceof Date) ? tx.date.toISOString().split('T')[0] : tx.date;

                document.getElementById('m1a-tanggal-input').value = dateValue;
                document.getElementById('m1a-nama-petugas-input').value = tx.petugas;
                document.getElementById('m1a-no-hp-input').value = tx.noHp;
                document.getElementById('m1a-donatur-input').value = tx.donatur;
                document.getElementById('m1a-alamat-input').value = tx.alamat;
                document.getElementById('m1a-nominal-input').value = tx.nominal;
                
                // Simpan ID transaksi di atribut data input untuk mode Edit
                document.getElementById('m1a-nominal-input').dataset.editId = tx.id;
                
                alert('Data dipindahkan ke form input. Silakan edit dan klik "Tambah Koin NU" untuk menyimpan perubahan.');
            } else {
                alert("Error: Transaksi Donatur tidak ditemukan.");
            }
        }

        // Modul 1A - Input/Update
        async function addKoinNUTransaction() {
            if (!isLoggedIn) return; 
            const date = document.getElementById('m1a-tanggal-input').value;
            const petugas = document.getElementById('m1a-nama-petugas-input').value.trim();
            const noHp = document.getElementById('m1a-no-hp-input').value.trim();
            const donatur = document.getElementById('m1a-donatur-input').value.trim();
            const alamat = document.getElementById('m1a-alamat-input').value.trim();
            const nominalInput = document.getElementById('m1a-nominal-input');
            const nominal = parseInt(nominalInput.value) || 0;

            if (!date || !petugas || nominal <= 0) {
                alert("Tanggal, Nama Petugas, dan Nominal Koin NU harus diisi dengan benar.");
                return;
            }
            
            // Periksa apakah ini mode edit
            const transactionId = nominalInput.dataset.editId;
            
            const data = {
                date: date,
                petugas: petugas,
                noHp: noHp,
                donatur: donatur,
                alamat: alamat,
                nominal: nominal,
                isManual: false, // Donatur Koin NU (Modul 1A)
            };
            
            if (transactionId) {
                data.id = transactionId;
            }

            const savedId = await saveTransactionToFirebase(data);
            
            if (savedId) {
                clearKoinNUInputs();
                await loadTransactions(); 
                renderAllTables();
                recalculateAllReports();
            }
        }

        function clearKoinNUInputs() {
            document.getElementById('m1a-tanggal-input').value = '';
            document.getElementById('m1a-nama-petugas-input').value = '';
            document.getElementById('m1a-no-hp-input').value = '';
            document.getElementById('m1a-donatur-input').value = '';
            document.getElementById('m1a-alamat-input').value = '';
            document.getElementById('m1a-nominal-input').value = '';
            document.getElementById('m1a-nominal-input').dataset.editId = ''; // Clear edit ID
            alert('Form Donatur dikosongkan.');
        }

        // Modul 2 - Edit
        function editManualTxn(transactionId) {
            if (!isLoggedIn) return; 
            
            // Cari transaksi di data Jurnal Manual
            const tx = m2ManualTransactions.find(t => t.id === transactionId);
            
            if (tx) {
                // Pastikan konversi tanggal aman
                const dateValue = (tx.date instanceof Date) ? tx.date.toISOString().split('T')[0] : tx.date;

                document.getElementById('m2-tanggal-input').value = dateValue;
                document.getElementById('m2-keterangan-input').value = tx.keterangan;
                document.getElementById('m2-kategori-input').value = tx.kategori;
                document.getElementById('m2-debit-input').value = tx.debit;
                document.getElementById('m2-kredit-input').value = tx.kredit;
                
                // Simpan ID transaksi di atribut data input untuk mode Edit
                document.getElementById('m2-debit-input').dataset.editId = tx.id;
                
                alert('Data dipindahkan ke form input. Silakan edit dan klik "Tambah Transaksi Lain" untuk menyimpan perubahan.');
            } else {
                alert("Error: Transaksi Jurnal tidak ditemukan.");
            }
        }

        // Modul 2 - Input/Update
        async function addManualTransaction() {
            if (!isLoggedIn) return;
            const date = document.getElementById('m2-tanggal-input').value;
            const keterangan = document.getElementById('m2-keterangan-input').value.trim();
            const kategori = document.getElementById('m2-kategori-input').value;
            const debit = parseInt(document.getElementById('m2-debit-input').value) || 0;
            const kredit = parseInt(document.getElementById('m2-kredit-input').value) || 0;

            if (!date || !keterangan || (debit === 0 && kredit === 0)) {
                alert("Tanggal, Keterangan, dan minimal satu nominal Debit/Kredit harus diisi.");
                return;
            }

            // Periksa apakah ini mode edit
            const transactionId = document.getElementById('m2-debit-input').dataset.editId;
            
            const data = {
                date: date,
                keterangan: keterangan,
                kategori: kategori,
                debit: debit,
                kredit: kredit,
                isManual: true, // Jurnal Manual (Modul 2)
            };

            if (transactionId) {
                data.id = transactionId;
            }

            const savedId = await saveTransactionToFirebase(data);
            
            if (savedId) {
                clearManualTransactionInputs();
                await loadTransactions(); 
                renderAllTables();
                recalculateAllReports();
            }
        }

        function clearManualTransactionInputs() {
            document.getElementById('m2-tanggal-input').value = '';
            document.getElementById('m2-keterangan-input').value = '';
            document.getElementById('m2-kategori-input').value = 'Infaq dan Shodaqoh';
            document.getElementById('m2-debit-input').value = '';
            document.getElementById('m2-kredit-input').value = '';
            document.getElementById('m2-debit-input').dataset.editId = ''; // Clear edit ID
            alert('Form Jurnal dikosongkan.');
        }

        // ================================================================================
        // 5. RENDER TABEL
        // ================================================================================
        
        function renderDonaturTable(transactions, page) {
            const tbody = document.getElementById('donatur-table-body');
            const pageInfo = document.getElementById('donatur-page-info');
            tbody.innerHTML = '';
            
            const totalItems = transactions.length;
            const totalPages = Math.ceil(totalItems / itemsPerDonaturPage);
            
            let currentPage = Math.max(1, Math.min(page, totalPages));
            currentDonaturPage = currentPage; // Update global page state

            const start = (currentPage - 1) * itemsPerDonaturPage;
            const end = start + itemsPerDonaturPage;
            const transactionsOnPage = transactions.slice(start, end);
            
            let totalNominal = 0;
            
            transactionsOnPage.forEach((transaction, indexInPage) => {
                const globalIndex = start + indexInPage + 1;
                totalNominal += transaction.nominal;
                
                const dateDisplay = (transaction.date instanceof Date) ? transaction.date.toISOString().split('T')[0] : transaction.date;
                
                let html = `
                    <tr class="bg-white border-b dark:bg-gray-800 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600">
                        <td class="py-2 px-6">${globalIndex}</td>
                        <td class="py-2 px-6">${dateDisplay}</td>
                        <td class="py-2 px-6">${transaction.petugas}</td>
                        <td class="py-2 px-6">${transaction.donatur || '-'}</td>
                        <td class="py-2 px-6">${transaction.noHp || '-'}</td>
                        <td class="py-2 px-6">${transaction.alamat || '-'}</td>
                        <td class="py-2 px-6 text-right">${formatNominal(transaction.nominal)}</td>
                        <td class="py-2 px-6">
                            <button class="text-blue-500 hover:text-blue-700 font-bold mr-2" onclick="editKoinNUTxn('${transaction.id}')">Edit</button>
                            <button class="text-red-500 hover:text-red-700 font-bold" onclick="deleteTransactionFromFirebase('${transaction.id}')">Hapus</button>
                        </td>
                    </tr>
                `;
                tbody.innerHTML += html;
            });

            pageInfo.innerText = `Halaman ${currentPage} dari ${totalPages || 1} (Total: ${totalItems} Donatur)`;
            
            // Tambahkan baris total
            const totalDonasiKeseluruhan = transactions.reduce((acc, t) => acc + t.nominal, 0);
            const totalRow = `
                <tr class="bg-gray-100 font-bold border-t-2 border-gray-900">
                    <td colspan="6" class="py-2 px-6 text-right">TOTAL DONASI HALAMAN INI:</td>
                    <td class="py-2 px-6 text-right">${formatNominal(totalNominal)}</td>
                    <td class="py-2 px-6"></td>
                </tr>
                <tr class="bg-gray-200 font-bold border-t-2 border-gray-900">
                    <td colspan="6" class="py-2 px-6 text-right">TOTAL DONASI KESELURUHAN:</td>
                    <td class="py-2 px-6 text-right">${formatNominal(totalDonasiKeseluruhan)}</td>
                    <td class="py-2 px-6"></td>
                </tr>
            `;
            tbody.innerHTML += totalRow;

            return totalDonasiKeseluruhan; 
        }

        function prevDonaturPage() {
            if (currentDonaturPage > 1) {
                currentDonaturPage--;
                renderAllTables();
            }
        }

        function nextDonaturPage() {
            const totalItems = allTransactions.length;
            const totalPages = Math.ceil(totalItems / itemsPerDonaturPage);
            if (currentDonaturPage < totalPages) {
                currentDonaturPage++;
                renderAllTables();
            }
        }

        function renderJurnalTable(totalDonasi, page) {
            const tbody = document.getElementById('m2-transaction-body');
            const pageInfo = document.getElementById('jurnal-page-info');
            
            // Gabungkan semua transaksi (Donasi Otomatis + Manual)
            const autoTransactions = allTransactions.map(t => {
                const dateDisplay = (t.date instanceof Date) ? t.date.toISOString().split('T')[0] : t.date;
                return {
                    id: t.id,
                    date: dateDisplay,
                    keterangan: `Donasi Koin NU (${t.donatur || 'Anonim'} - ${t.petugas})`,
                    kategori: 'Infaq dan Shodaqoh',
                    debit: t.nominal,
                    kredit: 0,
                    isManual: false,
                    timestamp: t.timestamp
                };
            });

            const allJurnalEntries = [
                ...autoTransactions,
                ...m2ManualTransactions.map(t => {
                    const dateDisplay = (t.date instanceof Date) ? t.date.toISOString().split('T')[0] : t.date;
                    return { ...t, date: dateDisplay };
                })
            ];

            // Urutkan berdasarkan tanggal, lalu timestamp (untuk memastikan urutan saat tanggal sama)
            allJurnalEntries.sort((a, b) => {
                if (a.date < b.date) return -1;
                if (a.date > b.date) return 1;
                if (a.timestamp < b.timestamp) return -1;
                if (a.timestamp > b.timestamp) return 1;
                return 0;
            });
            
            const totalItems = allJurnalEntries.length;
            const totalPages = Math.ceil(totalItems / itemsPerJurnalPage);
            
            let currentPage = Math.max(1, Math.min(page, totalPages));
            currentJurnalPage = currentPage; // Update global page state

            const start = (currentPage - 1) * itemsPerJurnalPage;
            const end = start + itemsPerJurnalPage;
            const transactionsOnPage = allJurnalEntries.slice(start, end);
            
            let currentSaldo = m2SaldoAwal;
            
            // Hitung saldo hingga halaman saat ini
            for (let i = 0; i < start; i++) {
                currentSaldo += (allJurnalEntries[i].debit || 0) - (allJurnalEntries[i].kredit || 0);
            }

            let html = '';

            // Render Saldo Awal (Baris Terkunci Saldo Awal)
            // Ambil dan update elemen Saldo Awal di DOM
            document.getElementById('m2-saldo-awal-input').value = m2SaldoAwal;
            document.getElementById('m2-saldo-awal-static').innerText = formatNominal(m2SaldoAwal);
            
            // Perbarui saldo yang tampil di baris Saldo Bulan Lalu
            document.getElementById('m2-saldo-awal-display').innerText = formatNominal(currentSaldo);

            let totalDebitOnPage = 0;
            let totalKreditOnPage = 0;
            
            transactionsOnPage.forEach((t) => {
                const debit = t.debit || 0;
                const kredit = t.kredit || 0;
                currentSaldo += debit - kredit;

                totalDebitOnPage += debit;
                totalKreditOnPage += kredit;

                // Tentukan aksi dan warna latar
                let aksiHtml;
                let bgColorClass = t.isManual ? 'bg-yellow-50' : 'bg-green-50'; // Kuning untuk manual, Hijau untuk Donasi Otomatis
                
                if (t.isManual) {
                    // Transaksi manual bisa diedit/dihapus
                    aksiHtml = `
                        <button class="text-blue-500 hover:text-blue-700 font-bold mr-2" onclick="editManualTxn('${t.id}')">Edit</button>
                        <button class="text-red-500 hover:text-red-700 font-bold" onclick="deleteTransactionFromFirebase('${t.id}')">Hapus</button>
                    `;
                } else {
                    // Transaksi otomatis (Donasi Koin NU)
                    aksiHtml = `
                        <button class="text-gray-500 hover:text-gray-700 font-bold" onclick="showTab('donatur')">Lihat M1A</button>
                    `;
                }

                html += `
                    <tr class="border-b ${bgColorClass} hover:bg-gray-100">
                        <td class="py-2 px-6">${aksiHtml}</td>
                        <td class="py-2 px-6">${t.date}</td>
                        <td class="py-2 px-6">${t.keterangan}</td>
                        <td class="py-2 px-6">${t.kategori}</td>
                        <td class="py-2 px-6 text-right">${formatNominal(debit)}</td>
                        <td class="py-2 px-6 text-right">${formatNominal(kredit)}</td>
                        <td class="py-2 px-6 text-right font-bold">${formatNominal(currentSaldo)}</td>
                    </tr>
                `;
            });

            // Tambahkan baris total
            const totalRow = `
                <tr class="bg-gray-200 font-bold border-t-2 border-gray-900 sticky bottom-0" style="z-index: 5;">
                    <td colspan="4" class="py-2 px-6 text-right">TOTAL TRANSAKSI HALAMAN INI:</td>
                    <td class="py-2 px-6 text-right">${formatNominal(totalDebitOnPage)}</td>
                    <td class="py-2 px-6 text-right">${formatNominal(totalKreditOnPage)}</td>
                    <td class="py-2 px-6 text-right">${formatNominal(currentSaldo)}</td>
                </tr>
            `;
            html += totalRow;

            // Masukkan data transaksi dan total ke tbody, setelah baris Saldo Awal (yang statis)
            // Kita harus mengambil baris pertama (Saldo Awal) dan mengganti sisanya.
            const saldoAwalRow = document.querySelector('#tabel-modul-2 tbody tr:first-child').outerHTML;
            tbody.innerHTML = saldoAwalRow + html;

            pageInfo.innerText = `Halaman ${currentPage} dari ${totalPages || 1} (Total: ${totalItems} Transaksi)`;
        }

        function prevJurnalPage() {
            if (currentJurnalPage > 1) {
                currentJurnalPage--;
                renderAllTables();
            }
        }

        function nextJurnalPage() {
            // Logika paginasi perlu data gabungan
            const totalJurnalEntries = allTransactions.length + m2ManualTransactions.length;
            const totalPages = Math.ceil(totalJurnalEntries / itemsPerJurnalPage);
            if (currentJurnalPage < totalPages) {
                currentJurnalPage++;
                renderAllTables();
            }
        }


        // ================================================================================
        // 6. LAPORAN (MODUL 3)
        // ================================================================================

        function recalculateAllReports() {
            m3Data = getInitialM3Data();
            
            // Hitung Donatur (M1A)
            m3Data.donaturUang = allTransactions.reduce((sum, t) => sum + (t.nominal || 0), 0);
            m3Data.donaturPenerima = allTransactions.length;
            
            // Hitung Jurnal Manual (M2)
            m2ManualTransactions.forEach(t => {
                const debit = t.debit || 0;
                const kredit = t.kredit || 0;
                
                if (debit > 0) {
                    // Penerimaan (masuk)
                    if (t.kategori === 'Infaq dan Shodaqoh') m3Data.infaqUang += debit;
                    else if (t.kategori === 'Penerimaan Lain') m3Data.lainLain += debit;
                } else if (kredit > 0) {
                    // Pengeluaran (keluar)
                    if (t.kategori === 'Bantuan Sosial (Sosum)') {
                        m3Data.sosumUang += kredit;
                        m3Data.sosumPenerima += 1; // Asumsi 1 transaksi = 1 penerima
                    }
                    else if (t.kategori === 'Banom') {
                        m3Data.banomUang += kredit;
                        m3Data.banomPenerima += 1;
                    }
                    else if (t.kategori === 'Bencana') {
                        m3Data.bencanaUang += kredit;
                        m3Data.bencanaPenerima += 1;
                    }
                    else if (t.kategori === 'Rapat dan Koordinasi') m3Data.rapat += kredit;
                    else if (t.kategori === 'Perawatan') m3Data.perwtnMlu += kredit;
                    else if (t.kategori === 'Biaya Bank') m3Data.biayaBank += kredit;
                    else if (t.kategori === 'Lain-lain' || t.kategori === 'Pendidikan (Lainnya)') m3Data.lainLain += kredit;
                }
            });
            
            renderLaporanGlobal();
        }

        function renderLaporanGlobal() {
            const tbody = document.getElementById('m3-report-body');
            const tfoot = document.getElementById('m3-report-footer');
            const summaryDiv = document.getElementById('m3-summary-info');
            tbody.innerHTML = '';
            tfoot.innerHTML = '';

            const m3 = m3Data;
            
            // Hitung Total Pemasukan dan Pengeluaran
            // Total Pemasukan adalah jumlah dari Donatur (M1A) dan Infaq/Penerimaan Lain (M2)
            const totalPemasukan = m3.donaturUang + m3.infaqUang + m3.lainLain; 
            const totalPengeluaran = m3.sosumUang + m3.banomUang + m3.bencanaUang + m3.rapat + m3.perwtnMlu + m3.biayaBank + m3.lainLain;
            const saldoAkhir = m2SaldoAwal + totalPemasukan - totalPengeluaran;
            const totalPenerima = m3.donaturPenerima + m3.sosumPenerima + m3.banomPenerima + m3.bencanaPenerima; // Hanya penerima yang dihitung

            // Render Ringkasan
            summaryDiv.innerHTML = `
                <p class="text-sm"><strong>Saldo Awal Periode:</strong> ${formatNominal(m2SaldoAwal)}</p>
                <p class="text-sm"><strong>Total Pemasukan (Baru):</strong> ${formatNominal(totalPemasukan)}</p>
                <p class="text-sm"><strong>Total Pengeluaran:</strong> ${formatNominal(totalPengeluaran)}</p>
                <p class="text-lg text-bold text-green-700"><strong>SALDO AKHIR PERIODE:</strong> ${formatNominal(saldoAkhir)}</p>
                <hr class="my-3">
            `;

            // Render Baris Data Pemasukan
            let pemasukanHtml = `
                <tr class="bg-green-100 font-bold">
                    <td colspan="18" class="py-2 px-3 border text-left">A. PEMASUKAN</td>
                </tr>
                <tr>
                    <td class="py-2 px-3 border">1. Donatur (Koin NU)</td>
                    <td class="py-2 px-3 border text-right">${formatNominal(m3.donaturUang)}</td>
                    <td class="py-2 px-3 border text-center">${formatNominal(m3.donaturPenerima)}</td>
                    <td colspan="15" class="py-2 px-3 border"></td>
                </tr>
                <tr>
                    <td class="py-2 px-3 border">2. Infaq dan Shodaqoh (Manual)</td>
                    <td colspan="2" class="py-2 px-3 border"></td>
                    <td class="py-2 px-3 border text-right">${formatNominal(m3.infaqUang)}</td>
                    <td class="py-2 px-3 border text-center"></td>
                    <td colspan="13" class="py-2 px-3 border"></td>
                </tr>
                <tr>
                    <td class="py-2 px-3 border">3. Penerimaan Lain (Manual)</td>
                    <td colspan="13" class="py-2 px-3 border"></td>
                    <td class="py-2 px-3 border text-right">${formatNominal(m3.lainLain)}</td>
                    <td colspan="2" class="py-2 px-3 border"></td>
                </tr>
                <tr class="bg-green-200 font-bold">
                    <td class="py-2 px-3 border text-bold">TOTAL PEMASUKAN</td>
                    <td colspan="17" class="py-2 px-3 border text-right text-bold">${formatNominal(totalPemasukan)}</td>
                </tr>
            `;

            // Render Baris Data Pengeluaran
            let pengeluaranHtml = `
                <tr class="bg-red-100 font-bold">
                    <td colspan="18" class="py-2 px-3 border text-left">B. PENGELUARAN</td>
                </tr>
                <tr>
                    <td class="py-2 px-3 border">1. Bantuan Sosial (Sosum)</td>
                    <td colspan="4" class="py-2 px-3 border"></td>
                    <td class="py-2 px-3 border text-right">${formatNominal(m3.sosumUang)}</td>
                    <td class="py-2 px-3 border text-center">${formatNominal(m3.sosumPenerima)}</td>
                    <td colspan="11" class="py-2 px-3 border"></td>
                </tr>
                <tr>
                    <td class="py-2 px-3 border">2. Banom</td>
                    <td colspan="6" class="py-2 px-3 border"></td>
                    <td class="py-2 px-3 border text-right">${formatNominal(m3.banomUang)}</td>
                    <td class="py-2 px-3 border text-center">${formatNominal(m3.banomPenerima)}</td>
                    <td colspan="9" class="py-2 px-3 border"></td>
                </tr>
                <tr>
                    <td class="py-2 px-3 border">3. Bencana</td>
                    <td colspan="8" class="py-2 px-3 border"></td>
                    <td class="py-2 px-3 border text-right">${formatNominal(m3.bencanaUang)}</td>
                    <td class="py-2 px-3 border text-center">${formatNominal(m3.bencanaPenerima)}</td>
                    <td colspan="7" class="py-2 px-3 border"></td>
                </tr>
                <tr>
                    <td class="py-2 px-3 border">4. Rapat & Koordinasi</td>
                    <td colspan="10" class="py-2 px-3 border"></td>
                    <td class="py-2 px-3 border text-right">${formatNominal(m3.rapat)}</td>
                    <td colspan="5" class="py-2 px-3 border"></td>
                </tr>
                <tr>
                    <td class="py-2 px-3 border">5. Perawatan MLU</td>
                    <td colspan="11" class="py-2 px-3 border"></td>
                    <td class="py-2 px-3 border text-right">${formatNominal(m3.perwtnMlu)}</td>
                    <td colspan="4" class="py-2 px-3 border"></td>
                </tr>
                <tr>
                    <td class="py-2 px-3 border">6. Biaya Bank</td>
                    <td colspan="12" class="py-2 px-3 border"></td>
                    <td class="py-2 px-3 border text-right">${formatNominal(m3.biayaBank)}</td>
                    <td colspan="3" class="py-2 px-3 border"></td>
                </tr>
                <tr>
                    <td class="py-2 px-3 border">7. Pengeluaran Lain-lain</td>
                    <td colspan="13" class="py-2 px-3 border"></td>
                    <td class="py-2 px-3 border text-right">${formatNominal(m3.lainLain)}</td>
                    <td colspan="2" class="py-2 px-3 border"></td>
                </tr>
                <tr class="bg-red-200 font-bold">
                    <td class="py-2 px-3 border text-bold">TOTAL PENGELUARAN</td>
                    <td colspan="14" class="py-2 px-3 border"></td>
                    <td class="py-2 px-3 border text-right text-bold">${formatNominal(totalPengeluaran)}</td>
                    <td class="py-2 px-3 border text-center text-bold">${formatNominal(totalPenerima)}</td>
                </tr>
            `;

            // Render Total Saldo
            let totalHtml = `
                <tr class="bg-gray-300 font-bold">
                    <td colspan="15" class="py-2 px-3 border text-left">SALDO AKHIR PERIODE (A + Saldo Awal - B)</td>
                    <td colspan="3" class="py-2 px-3 border text-right text-bold">${formatNominal(saldoAkhir)}</td>
                </tr>
            `;
            
            tbody.innerHTML = pemasukanHtml + pengeluaranHtml;
            tfoot.innerHTML = totalHtml;
        }

        function exportLaporanGlobalPDF() {
            window.jsPDF = window.jspdf.jsPDF;
            const doc = new jsPDF('landscape');
            const table = document.getElementById('tabel-modul-3');
            
            doc.text("Laporan Pertanggungjawaban Global", 148, 10, { align: "center" });
            
            // Konfigurasi jspdf-autotable
            doc.autoTable({
                html: table,
                startY: 15,
                theme: 'grid',
                headStyles: { 
                    fillColor: [233, 236, 239], 
                    textColor: 50, 
                    fontStyle: 'bold', 
                    fontSize: 6.5,
                    halign: 'center'
                },
                styles: { 
                    fontSize: 7, 
                    cellPadding: 2,
                },
                bodyStyles: {
                    halign: 'right'
                },
                footStyles: { 
                    fontStyle: 'bold', 
                    fillColor: [209, 213, 219],
                    halign: 'right'
                },
                didDrawCell: function(data) {
                    if (data.section === 'body') {
                        // Align kiri untuk kolom POS
                        if (data.column.index === 0) {
                            doc.text(data.cell.text, data.cell.x + data.cell.padding('left'), data.cell.y + data.cell.height / 2, { valign: 'middle', align: 'left' });
                        }
                        // Align tengah untuk kolom Penerima (index 2, 4, 6, 8, 10, 16)
                        const centerIndices = [2, 4, 6, 8, 10, 16];
                        if (centerIndices.includes(data.column.index)) {
                             doc.text(data.cell.text, data.cell.x + data.cell.width / 2, data.cell.y + data.cell.height / 2, { valign: 'middle', align: 'center' });
                        }
                    }
                }
            });

            // Tambahkan ringkasan
            const summaryInfo = document.getElementById('m3-summary-info').innerText.split('\n');
            let yPos = doc.lastAutoTable.finalY + 10;
            summaryInfo.forEach(line => {
                doc.text(line, 15, yPos);
                yPos += 7;
            });
            
            doc.save("LPJ_Global_Ringkasan.pdf");
        }


        // =================================================================================
        // 7. RENDER ALL DAN ONLOAD
        // =================================================================================

        const renderAllTables = () => {
            // Urutkan donatur sebelum merender
            allTransactions.sort((a, b) => a.timestamp - b.timestamp);
            const totalDonasi = renderDonaturTable(allTransactions, currentDonaturPage);
            renderJurnalTable(totalDonasi, currentJurnalPage);
        };

        window.onload = async () => { 
            
            // Inisialisasi Firebase
            firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            auth = firebase.auth(); 
            
            // Listener status autentikasi: fungsi handleAuthStateChange akan dipanggil
            auth.onAuthStateChanged(async (user) => {
                
                // Ambil data sebelum update status login untuk memastikan tampilan saldo yang benar
                await loadTransactions(); 
                handleAuthStateChange(user); 
                
                // Panggil render setelah semua data siap
                renderAllTables(); 
                recalculateAllReports(); 
            });

            // *PENTING: Panggil ini untuk menampilkan Donatur sebagai tab default*
            showTab('donatur'); 
        };

        // =================================================================================
        // 8. DATA LOADING
        // =================================================================================

        const loadTransactions = async () => {
            const user = auth.currentUser;
            
            if (!user) {
                allTransactions = [];
                m2ManualTransactions = [];
                m3Data = getInitialM3Data(); 
                console.log("Pengguna belum login, data tidak dimuat.");
                return;
            }

            try {
                // Ambil data dari Firestore, diurutkan berdasarkan timestamp
                const querySnapshot = await db.collection("users").doc(user.uid).collection("transactions")
                                            .orderBy("timestamp", "asc") 
                                            .get();

                allTransactions = [];
                m2ManualTransactions = [];
                
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    data.id = doc.id; 
                    
                    // Konversi Firebase Timestamp menjadi objek Date standar
                    if (data.timestamp && data.timestamp.toDate) {
                        data.timestamp = data.timestamp.toDate(); 
                    }

                    if (data.isManual === true) {
                        m2ManualTransactions.push(data);
                    } else {
                        allTransactions.push(data);
                    }
                });
                
                console.log(`Data ${allTransactions.length + m2ManualTransactions.length} berhasil dimuat dari Firestore untuk user: ${user.uid}.`);

            } catch (error) {
                console.error("Error memuat data dari Firestore: ", error);
                // Biarkan data kosong, jangan alert agar aplikasi tidak crash
                allTransactions = []; 
                m2ManualTransactions = [];
            }
        };
    </script>

</body>
</html>

