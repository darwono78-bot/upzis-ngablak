<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Pembukuan UPZIS | Ranting Ngablak</title>
    <!-- Library yang sudah ada -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <!-- ðŸ”¥ TAHAP 1: FIREBASE SDK ðŸ”¥ -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection, query, where, getDocs, FieldValue } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";
        
        // --- KONFIGURASI DAN INISIALISASI ---
        
        // ðŸŽ¯ MENGGUNAKAN KONFIGURASI DARI LINGKUNGAN CANVAS (WAJIB)
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id'; 

        // Variabel global untuk layanan Firebase
        let app = null;
        let db = null; 
        let auth = null;   
        window.isLoggedIn = false; // Status login admin
        window.isAuthReady = false; // Status kesiapan otentikasi
        window.appId = appId; 
        
        if (firebaseConfig) {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app); 
            auth = getAuth(app);
            
            window.db = db; // Pasang ke window agar bisa diakses di luar modul
            window.auth = auth;
            
            // ðŸŽ¯ FUNGSI OTENTIKASI AWAL (WAJIB DILAKUKAN SEBELUM LOAD DATA)
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    // Cek apakah user adalah admin (Sementara: anggap user yang memiliki custom token sebagai admin untuk lingkungan Canvas)
                    window.isLoggedIn = !!initialAuthToken; 
                } else {
                    // Jika belum ada user, coba sign in anonim agar bisa membaca data publik
                    try {
                        // Jika ada custom token (dari Canvas), gunakan itu. Jika tidak, gunakan anonim.
                        if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch (e) {
                        console.error("Gagal melakukan sign-in anonim/custom:", e);
                    }
                }
                
                window.isAuthReady = true;
                updateUIForLoginStatus();
                // Panggil init setelah otentikasi siap
                window.init(); // <--- INI PENTING: Memulai aplikasi setelah Auth siap
            });
            
        } else {
            console.error("Firebase Config tidak ditemukan. Pastikan Anda menjalankan kode ini di lingkungan Canvas.");
        }

        // --- FUNGSI AUTHENTICATION ---

        window.showLoginOverlay = function() {
            document.getElementById('login-overlay').style.display = 'flex';
            document.getElementById('login-error').style.display = 'none';
        }

        window.hideLoginOverlay = function() {
            document.getElementById('login-overlay').style.display = 'none';
        }

        window.updateUIForLoginStatus = function() {
            console.log("updateUIForLoginStatus dipanggil...");
            const loginBtn = document.getElementById('login-btn');
            const logoutBtn = document.getElementById('logout-btn');
            const koinHeader = document.getElementById('koin-aksi-header');
            const jurnalHeader = document.getElementById('jurnal-aksi-header');
            const koinAddBtn = document.getElementById('koin-add-btn');
            const jurnalAddBtn = document.getElementById('jurnal-add-btn');
            
            // Tampilkan tombol Login/Logout yang sesuai
            loginBtn.style.display = window.isLoggedIn ? 'none' : 'inline';
            logoutBtn.style.display = window.isLoggedIn ? 'inline' : 'none';

            // Tampilkan atau sembunyikan tombol tambah data
            if (koinAddBtn) koinAddBtn.style.display = window.isLoggedIn ? 'inline-block' : 'none';
            if (jurnalAddBtn) jurnalAddBtn.style.display = window.isLoggedIn ? 'inline-block' : 'none';


            // Tampilkan atau sembunyikan kolom "Aksi" (Edit/Hapus)
            const displayAction = window.isLoggedIn ? 'table-cell' : 'none';
            if (koinHeader) koinHeader.style.display = displayAction;
            if (jurnalHeader) jurnalHeader.style.display = displayAction;

            // Render ulang tabel yang sedang aktif untuk memperbarui tombol Aksi
            // âŒ HAPUS: window.showModule(window.currentModule || 'koin', true); 
            // âœ… GANTI: Dengan pemanggilan render spesifik
            if (window.currentModule === 'koin' || !window.currentModule) {
                window.renderKoinTable();
            } else if (window.currentModule === 'jurnal') {
                window.renderJurnalTable();
            }
        }

        window.loginAdmin = function() {
            // Placeholder/Simulasi Login
            const errorElement = document.getElementById('login-error');
            errorElement.style.display = 'block';
            errorElement.textContent = "Simulasi Login Gagal. Di lingkungan ini, login admin dilakukan secara otomatis melalui Custom Token dari Canvas.";
        }

        window.logoutAdmin = function() {
            if (!window.auth) return;
            
            auth.signOut().then(() => {
                window.isLoggedIn = false;
                window.updateUIForLoginStatus();
                signInAnonymously(auth); 
            }).catch((error) => {
                console.error("Logout Error:", error);
                console.log("Gagal logout. Coba lagi.");
            });
        }
        
        // --- FUNGSI UTILITY (LOAD/SAVE/FORMAT) --- 

        // ðŸŽ¯ FUNGSI LOAD DATA BARU (ASINKRON - FIREBASE) ðŸŽ¯
        async function loadDataFromStorage(key, defaultData) {
            if (!window.isAuthReady || !window.db) {
                return defaultData;
            }

            // ðŸ†• MENGGUNAKAN PATH DATA PUBLIK SESUAI STANDAR CANVAS
            const collectionPath = `artifacts/${window.appId}/public/data/records`;
            const docId = `data-${key.toLowerCase()}`;
            
            try {
                const docRef = doc(window.db, collectionPath, docId);
                const docSnap = await getDoc(docRef);

                if (docSnap.exists() && docSnap.data().records) {
                    return docSnap.data().records;
                } else {
                    return defaultData;
                }
            } catch (error) {
                console.error(`Gagal memuat data ${key} (Izin Baca/Auth Error): `, error);
                return defaultData; 
            }
        }

        // ðŸŽ¯ FUNGSI SAVE DATA BARU (FIREBASE) ðŸŽ¯
        async function saveDataToStorage(key, data) {
            if (!window.isLoggedIn || !window.db) {
                console.error("âŒ Akses ditolak! Anda harus Login Admin untuk menyimpan atau mengubah data.");
                return Promise.reject(new Error("Unauthorized write access."));
            }

            // ðŸ†• MENGGUNAKAN PATH DATA PUBLIK UNTUK PENYIMPANAN
            const collectionPath = `artifacts/${window.appId}/public/data/records`;
            const docId = `data-${key.toLowerCase()}`; 

            try {
                const docRef = doc(window.db, collectionPath, docId);
                await setDoc(docRef, {
                    records: data,
                    updatedAt: new Date() 
                });
                console.log(`Data ${key} berhasil disimpan ke Firestore.`);
            } catch (error) {
                console.error(`Gagal menyimpan data ${key}: `, error);
                throw error; 
            }
        }
        
        // --- Variabel Global Awal ---
        window.KOIN_KEY = 'upzis_koin_data';
        window.JURNAL_KEY = 'upzis_jurnal_data';
        window.ANNUAL_KEY = 'upzis_annual_data';

        window.koinData = [];
        window.jurnalData = [];
        window.annualData = [];
        window.currentModule = 'koin';
        window.currentMonth = new Date().getMonth() + 1;
        window.currentYear = new Date().getFullYear();

        // --- FUNGSI GLOBAL ---

        window.formatRupiah = function(angka) {
            const num = Number(angka);
            if (isNaN(num)) return 'Rp 0';
            return 'Rp ' + num.toFixed(0).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
        }
        
        window.formatTanggalTTD = function() {
            const date = new Date();
            const options = { day: 'numeric', month: 'long', year: 'numeric' };
            return date.toLocaleDateString('id-ID', options);
        }

        // ðŸ†• FUNGSI UNTUK MENAMPILKAN/MENYEMBUNYIKAN FORM (Tampilan yang hilang sudah kembali!)
        window.showInputForm = function(type) {
             const form = document.getElementById(`${type}-input-form`);
             if (form) form.style.display = 'block';
             const btn = document.getElementById(`${type}-add-btn`);
             if (btn) btn.style.display = 'none';
             if (type === 'jurnal') window.updateMasukKeluarFields();
        }

        window.hideInputForm = function(type) {
             const form = document.getElementById(`${type}-input-form`);
             if (form) form.style.display = 'none';
             const btn = document.getElementById(`${type}-add-btn`);
             if (btn && window.isLoggedIn) btn.style.display = 'inline-block';
        }

        window.showModule = function(moduleName, forceRender = false) {
            console.log("showModule dipanggil untuk:", moduleName);
            const modules = ['koin', 'jurnal', 'tahunan'];
            modules.forEach(id => {
                const element = document.getElementById(id + '-module');
                if (element) element.style.display = 'none';
                const navBtn = document.getElementById('nav-' + id);
                if (navBtn) navBtn.classList.remove('active');
            });

            window.currentModule = moduleName;
            const activeModule = document.getElementById(moduleName + '-module');
            const activeNav = document.getElementById('nav-' + moduleName);
            
            if (activeModule) activeModule.style.display = 'block';
            if (activeNav) activeNav.classList.add('active');

            if (moduleName === 'koin' || forceRender) {
                window.renderKoinTable();
            } else if (moduleName === 'jurnal' || forceRender) {
                window.renderJurnalTable();
            } else if (moduleName === 'tahunan' || forceRender) {
                window.generateAnnualReportData();
                window.renderAnnualReportTable();
            }
            // âŒ HAPUS: Panggilan rekursif yang menyebabkan error RangeError
            // window.updateUIForLoginStatus(); 
        }

        // --- Update Footer Tahunan ---
        window.updateAnnualFooter = function(total, dataToRender) {
             const saldoKasAkhir = total.saldoKasTahunBerjalan || 0;

             document.getElementById('tahunan-total-koin').textContent = window.formatRupiah(total.koin || 0);
             document.getElementById('tahunan-total-donatur').textContent = total.donatur || 0;
             
             document.getElementById('tahunan-total-pend-uang').textContent = window.formatRupiah(total.pendidikan?.uang || 0);
             document.getElementById('tahunan-total-kes-uang').textContent = window.formatRupiah(total.kesehatan?.uang || 0);
             document.getElementById('tahunan-total-eko-uang').textContent = window.formatRupiah(total.ekonomi?.uang || 0);
             document.getElementById('tahunan-total-sosial-uang').textContent = window.formatRupiah(total.sosial?.uang || 0);
             document.getElementById('tahunan-total-banom-uang').textContent = window.formatRupiah(total.banom?.uang || 0);
             document.getElementById('tahunan-total-bencana-uang').textContent = window.formatRupiah(total.bencana?.uang || 0);
             
             document.getElementById('tahunan-total-honor-petugas').textContent = window.formatRupiah(total.honor?.petugas || 0);
             document.getElementById('tahunan-total-honor-mwc').textContent = window.formatRupiah(total.honor?.mwc || 0);
             document.getElementById('tahunan-total-honor-pc').textContent = window.formatRupiah(total.honor?.pc || 0);
             document.getElementById('tahunan-total-rapat').textContent = window.formatRupiah(total.rapat || 0);
             document.getElementById('tahunan-total-perwtn-mlu').textContent = window.formatRupiah(total.perwtn_mlu || 0);
             document.getElementById('tahunan-total-biaya-rek-bank').textContent = window.formatRupiah(total.biaya_rek_bank || 0);
             document.getElementById('tahunan-total-lain-lain-peng').textContent = window.formatRupiah(total.lain_lain_peng || 0);
             
             document.getElementById('tahunan-total-pengeluaran').textContent = window.formatRupiah(total.totalPengeluaran || 0);
             
             document.getElementById('tahunan-total-saldo-akhir').textContent = window.formatRupiah(saldoKasAkhir);
             document.getElementById('tahunan-total-saldo-kas').textContent = window.formatRupiah(saldoKasAkhir);
        }
        
        // --- JURNAL INPUT UTILITY (Tampilan yang hilang sudah kembali!) ---
        window.updateMasukKeluarFields = function() {
             const kategori = document.getElementById('jurnal-input-kategori').value;
             const masukField = document.getElementById('jurnal-input-masuk');
             const keluarField = document.getElementById('jurnal-input-keluar');

             const isDanaMasuk = ['Koin NU', 'Donatur', 'Zakat Mall', 'Infaq', 'Shodaqoh', 'Saldo Bulan Lalu', 'Hasil Usaha', 'Ranting (60%)'].includes(kategori);
             const isDanaKeluar = !isDanaMasuk;

             if (isDanaMasuk) {
                 masukField.disabled = false;
                 keluarField.disabled = true;
                 keluarField.value = 0; // Set Keluar ke 0
             } else if (isDanaKeluar) {
                 masukField.disabled = true;
                 masukField.value = 0; // Set Masuk ke 0
                 keluarField.disabled = false;
             } else {
                 masukField.disabled = false;
                 keluarField.disabled = false;
             }
        }


        // --- PDF EXPORT ---
        window.downloadPDF = function(module) {
             const contentId = `${module}-module`; 
             const content = document.getElementById(contentId);
             if (!content) return;

             const actionHeader = document.getElementById(`${module}-aksi-header`);
             const actionCells = content.querySelectorAll('.action-btns');
             const ttdArea = document.getElementById(`${module}-ttd-area`);
             
             // Sembunyikan tombol aksi dan tampilkan TTD sebelum export
             const originalDisplay = actionHeader ? actionHeader.style.display : 'none';
             if (actionHeader) actionHeader.style.display = 'none';
             actionCells.forEach(cell => cell.style.display = 'none');
             if (ttdArea) ttdArea.style.display = 'flex';
             document.getElementById(`${module}-ttd-tanggal-output`).textContent = window.formatTanggalTTD();

             // Penyesuaian ukuran font untuk laporan tahunan agar muat di PDF
             let originalFontSize = content.style.fontSize;
             let originalTableFontSize = null;
             let originalTablePadding = null; 

             if (module === 'tahunan') {
                 const annualTable = content.querySelector('table');
                 if (annualTable) {
                      originalTableFontSize = annualTable.style.fontSize;
                      annualTable.style.fontSize = '8px'; 
                      
                      const firstCell = annualTable.querySelector('th, td');
                      if(firstCell) {
                          originalTablePadding = firstCell.style.padding;
                      }

                      annualTable.querySelectorAll('th, td').forEach(el => {
                          el.style.padding = '2px'; 
                      });
                 }
             }

             // --- Proses PDF Export ---
             html2canvas(content, {
                 scale: 3, 
                 width: content.scrollWidth, 
                 windowWidth: content.scrollWidth,
             }).then(function(canvas) {
                 const { jsPDF } = window.jspdf;
                 const imgData = canvas.toDataURL('image/jpeg', 1.0);
                 
                 const pdf = new jsPDF('l', 'mm', 'a4'); 
                 const pdfWidth = pdf.internal.pageSize.getWidth(); 

                 const margin = 10;
                 const targetPdfWidth = pdfWidth - (2 * margin); 
                 
                 const imgHeight = canvas.height * targetPdfWidth / canvas.width; 

                 let heightLeft = imgHeight;
                 let position = margin;
                 
                 pdf.addImage(imgData, 'JPEG', margin, position, targetPdfWidth, imgHeight);
                 heightLeft -= pdf.internal.pageSize.getHeight();
                 
                 while (heightLeft >= 0) {
                     position = heightLeft - imgHeight + margin; 
                     pdf.addPage();
                     pdf.addImage(imgData, 'JPEG', margin, position, targetPdfWidth, imgHeight);
                     heightLeft -= pdf.internal.pageSize.getHeight();
                 }
                 
                 pdf.save(`Laporan_${module}_${new Date().toISOString().split('T')[0]}.pdf`);

                 // KEMBALIKAN PERUBAHAN SEMENTARA SETELAH SELESAI
                 if (module === 'tahunan') {
                     content.style.fontSize = originalFontSize; 
                     const annualTable = content.querySelector('table');
                     if (annualTable) {
                          annualTable.style.fontSize = originalTableFontSize;
                          annualTable.querySelectorAll('th, td').forEach(el => {
                              el.style.padding = originalTablePadding || ''; 
                          });
                     }
                 }
                 
                 // Kembalikan tampilan setelah selesai
                 window.updateUIForLoginStatus(); // Ini akan merender ulang tabel dan menyembunyikan aksi/TTD
                 if (ttdArea) ttdArea.style.display = 'none';
             });
        }
        
        // ðŸŽ¯ INISIALISASI BARU (ASINKRON) ðŸŽ¯
        window.init = async function() {
            if (!window.isAuthReady) return; 

            // 1. Load data dari Firebase
            try {
                window.koinData = await loadDataFromStorage(window.KOIN_KEY, window.koinData);
                window.jurnalData = await loadDataFromStorage(window.JURNAL_KEY, window.jurnalData);
                window.annualData = await loadDataFromStorage(window.ANNUAL_KEY, window.annualData);
                
            } catch (error) {
                console.error("Gagal memuat semua data awal:", error);
            }
            
            // 2. Isi Opsi Filter (Ini memastikan dropdown Bulan/Tahun terisi)
            window.populateFilterOptions(); 
            
            // 3. Tampilkan modul default ('koin') dan update UI (Ini memastikan tombol Tambah muncul jika Login)
            window.showModule(window.currentModule);
        }

    </script>

    <style>
        /* Gaya CSS untuk Tampilan */
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; padding: 0; background-color: #f4f7f6; color: #333; }
        .container { padding: 20px; max-width: 100%; margin: auto; }
        .navbar { background-color: #006400; color: white; padding: 10px 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.2); display: flex; align-items: center; justify-content: space-between; }
        .navbar-logo { font-size: 1.5rem; font-weight: bold; }
        .navbar-links button { background: none; border: none; color: white; padding: 8px 15px; cursor: pointer; font-size: 1rem; margin-left: 10px; transition: background-color 0.2s; }
        .navbar-links button:hover { background-color: #004d00; }
        .tab-button { background-color: #f0f0f0; color: #333; border: 1px solid #ccc; padding: 10px 15px; cursor: pointer; margin-right: 5px; border-radius: 5px 5px 0 0; }
        .tab-button.active { background-color: white; border-bottom: none; }
        .tab-content { background-color: white; padding: 20px; border: 1px solid #ccc; border-top: none; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; font-size: 12px; }
        th { background-color: #f2f2f2; font-weight: bold; }
        .action-btns button { margin-right: 5px; padding: 3px 8px; font-size: 10px; cursor: pointer; background-color: #ff9800; color: white; border: none; border-radius: 4px; }
        .action-btns button:hover { opacity: 0.8; }
        .text-center { text-align: center; }
        .text-right { text-align: right; }
        .flex-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .form-group { margin-bottom: 10px; }
        input, select { padding: 8px; border: 1px solid #ccc; border-radius: 4px; width: 100%; box-sizing: border-box; }
        /* Gaya untuk Laporan Tahunan */
        .annual-report-title { text-align: center; margin-bottom: 20px; }
        .annual-report-title h2 { margin: 0; }
        .annual-report-title p { margin: 5px 0 0 0; font-size: 0.9em; }
        /* Gaya Area TTD */
        .ttd-area { display: none; margin-top: 50px; justify-content: space-around; font-size: 11px; }
        .ttd-block { text-align: center; }
        /* Overlay Login */
        .login-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.7); z-index: 1000; justify-content: center; align-items: center; }
        .login-box { background-color: white; padding: 30px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3); width: 300px; text-align: center; }
        .login-box input { margin-bottom: 15px; }
        .login-box button { width: 100%; }

    </style>
</head>
<body>

    <div class="navbar">
        <div class="navbar-logo">Sistem Pembukuan UPZIS Ranting Ngablak</div>
        <div class="navbar-links">
            <button id="nav-koin" onclick="showModule('koin')" class="active">Koin NU</button>
            <button id="nav-jurnal" onclick="showModule('jurnal')">Jurnal Manual</button>
            <button id="nav-tahunan" onclick="showModule('tahunan')">Laporan Tahunan</button>
            
            <!-- Tombol Login dan Logout disesuaikan berdasarkan status login -->
            <button id="login-btn" onclick="showLoginOverlay()">Login Admin</button>
            <button id="logout-btn" onclick="logoutAdmin()" style="display: none;">Logout</button>
        </div>
    </div>

    <!-- Area Login (Sembunyi) -->
    <div id="login-overlay" class="login-overlay">
        <div class="login-box">
            <h3>Login Admin</h3>
            <p id="login-error" style="color: red; display: none;"></p>
            <input type="email" id="login-email" placeholder="Email Admin" required>
            <input type="password" id="login-password" placeholder="Password" required>
            <button onclick="loginAdmin()">Login</button>
        </div>
    </div>

    <!-- KONTEN UTAMA APLIKASI -->
    <div id="main-content" class="container">

        <!-- MODUL KOIN NU -->
        <div id="koin-module" class="module-content">
            
            <!-- Filter & Tombol Tambah (INI ADALAH TAMPILAN YANG ANDA CARI) -->
            <div class="flex-row">
                <div>
                    <label for="koin-filter-month">Bulan:</label>
                    <select id="koin-filter-month" onchange="filterData('koin')"></select>
                    <label for="koin-filter-year">Tahun:</label>
                    <select id="koin-filter-year" onchange="filterData('koin')"></select>
                </div>
                <!-- Tombol ini akan muncul jika window.isLoggedIn = true -->
                <button onclick="showInputForm('koin')" id="koin-add-btn" style="display: none;">+ Tambah Koin NU</button>
            </div>

            <!-- Formulir Input Koin NU (INI ADALAH TAMPILAN YANG ANDA CARI) -->
            <div id="koin-input-form" style="display: none; background: #e0f7fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                <h4>Tambah/Edit Data Koin NU</h4>
                <div class="form-group"><label for="koin-input-ranting">Ranting</label><input type="text" id="koin-input-ranting" placeholder="Nama Ranting" required></div>
                <div class="form-group"><label for="koin-input-tanggal">Tanggal</label><input type="date" id="koin-input-tanggal" required></div>
                <div class="form-group"><label for="koin-input-total">Total Koin (100%)</label><input type="number" id="koin-input-total" placeholder="Contoh: 100000" required></div>
                <div class="form-group"><label for="koin-input-keterangan">Keterangan Tambahan</label><input type="text" id="koin-input-keterangan" placeholder="Opsional"></div>
                <input type="hidden" id="koin-input-index">
                <button onclick="saveKoinRecord()">Simpan Koin</button>
                <button onclick="hideInputForm('koin')">Batal</button>
            </div>

            <div id="koin-data-table" class="table-responsive">
                <table>
                    <thead>
                        <tr>
                            <!-- Header Aksi hanya terlihat jika admin login -->
                            <th id="koin-aksi-header" style="width: 100px; display: none;">Aksi</th> 
                            <th>No.</th>
                            <th>Tanggal</th>
                            <th>Ranting</th>
                            <th>Koin (100%)</th>
                            <th>Ranting (60%)</th>
                            <th>Petugas (10%)</th>
                            <th>MWC (25%)</th>
                            <th>PC (5%)</th>
                        </tr>
                    </thead>
                    <tbody id="koin-table-body">
                        <tr><td colspan="9" class="text-center">Memuat Data...</td></tr>
                    </tbody>
                    <tfoot>
                        <tr>
                            <td colspan="4" class="text-right"><strong>TOTAL</strong></td>
                            <td class="text-right" id="koin-total-100">0</td>
                            <td class="text-right" id="koin-total-60">0</td>
                            <td class="text-right" id="koin-total-10">0</td>
                            <td class="text-right" id="koin-total-25">0</td>
                            <td class="text-right" id="koin-total-5">0</td>
                        </tr>
                    </tfoot>
                </table>
            </div>
            <button onclick="downloadPDF('koin')" style="margin-top: 15px;">Download PDF Laporan Koin</button>
            
            <div id="koin-ttd-area" class="ttd-area">
                <div class="ttd-block">
                    Ngablak, <span id="koin-ttd-tanggal-output"></span><br>
                    Ketua UPZIS Ranting<br><br><br><br>
                    (...............................)
                </div>
            </div>
        </div>

        <!-- MODUL JURNAL MANUAL -->
        <div id="jurnal-module" class="module-content" style="display: none;">
            
            <!-- Filter & Tombol Tambah (INI ADALAH TAMPILAN YANG ANDA CARI) -->
            <div class="flex-row">
                <div>
                    <label for="jurnal-filter-month">Bulan:</label>
                    <select id="jurnal-filter-month" onchange="filterData('jurnal')"></select>
                    <label for="jurnal-filter-year">Tahun:</label>
                    <select id="jurnal-filter-year" onchange="filterData('jurnal')"></select>
                </div>
                <!-- Tombol ini akan muncul jika window.isLoggedIn = true -->
                <button onclick="showInputForm('jurnal')" id="jurnal-add-btn" style="display: none;">+ Tambah Jurnal</button>
            </div>

            <!-- Formulir Input Jurnal (INI ADALAH TAMPILAN YANG ANDA CARI) -->
            <div id="jurnal-input-form" style="display: none; background: #e0f2f1; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                <h4>Tambah/Edit Jurnal Manual</h4>
                <div class="form-group"><label for="jurnal-input-tanggal">Tanggal</label><input type="date" id="jurnal-input-tanggal" required></div>
                <div class="form-group">
                    <label for="jurnal-input-kategori">Kategori</label>
                    <select id="jurnal-input-kategori" onchange="updateMasukKeluarFields()" required>
                        <option value="">Pilih Kategori</option>
                        <optgroup label="Penerimaan">
                            <option value="Koin NU">Koin NU (Manual)</option>
                            <option value="Donatur">Donatur</option>
                            <option value="Zakat Mall">Zakat Mall</option>
                            <option value="Infaq">Infaq</option>
                            <option value="Shodaqoh">Shodaqoh</option>
                            <option value="Saldo Bulan Lalu">Saldo Bulan Lalu (Otomatis)</option>
                            <option value="Hasil Usaha">Hasil Usaha</option>
                            <option value="Ranting (60%)">Ranting (60%)</option>
                        </optgroup>
                        <optgroup label="Pengeluaran">
                            <option value="Pendidikan">Pendidikan</option>
                            <option value="Kesehatan">Kesehatan</option>
                            <option value="Ekonomi">Ekonomi</option>
                            <option value="Sosial">Sosial</option>
                            <option value="Banom">Banom</option>
                            <option value="Bencana">Bencana</option>
                            <option value="Operasional Rapat">Operasional Rapat</option>
                            <option value="Perawatan MLU">Perawatan MLU</option>
                            <option value="Biaya Rek Bank">Biaya Rek Bank</option>
                            <option value="Lain-lain Pengeluaran">Lain-lain</option>
                            <option value="Petugas (10%)">Honor Petugas (10%)</option>
                            <option value="MWC (25%)">Honor MWC (25%)</option>
                            <option value="PC (5%)">Honor PC (5%)</option>
                        </optgroup>
                    </select>
                </div>
                <div class="form-group"><label for="jurnal-input-keterangan">Keterangan</label><input type="text" id="jurnal-input-keterangan" placeholder="Contoh: Bantuan Anak Yatim" required></div>
                <div class="form-group"><label for="jurnal-input-masuk">Dana Masuk (Rp)</label><input type="number" id="jurnal-input-masuk" value="0" placeholder="0"></div>
                <div class="form-group"><label for="jurnal-input-keluar">Dana Keluar (Rp)</label><input type="number" id="jurnal-input-keluar" value="0" placeholder="0"></div>
                <input type="hidden" id="jurnal-input-index">
                <button onclick="saveJurnalRecord()">Simpan Jurnal</button>
                <button onclick="hideInputForm('jurnal')">Batal</button>
            </div>

            <div id="jurnal-data-table" class="table-responsive">
                <table>
                    <thead>
                        <tr>
                            <!-- Header Aksi hanya terlihat jika admin login -->
                            <th id="jurnal-aksi-header" style="width: 100px; display: none;">Aksi</th>
                            <th>No.</th>
                            <th>Tanggal</th>
                            <th>Kategori</th>
                            <th>Keterangan</th>
                            <th>Masuk (Rp)</th>
                            <th>Keluar (Rp)</th>
                            <th>Saldo (Rp)</th>
                        </tr>
                    </thead>
                    <tbody id="jurnal-table-body">
                        <tr><td colspan="8" class="text-center">Memuat Data...</td></tr>
                    </tbody>
                    <tfoot>
                        <tr>
                            <td colspan="4" class="text-right"><strong>TOTAL</strong></td>
                            <td class="text-right" id="jurnal-total-masuk">0</td>
                            <td class="text-right" id="jurnal-total-keluar">0</td>
                            <td class="text-right" id="jurnal-saldo-akhir">0</td>
                        </tr>
                    </tfoot>
                </table>
            </div>
            <button onclick="downloadPDF('jurnal')" style="margin-top: 15px;">Download PDF Laporan Jurnal</button>

            <div id="jurnal-ttd-area" class="ttd-area">
                <div class="ttd-block">
                    Ngablak, <span id="jurnal-ttd-tanggal-output"></span><br>
                    Ketua UPZIS Ranting<br><br><br><br>
                    (...............................)
                </div>
            </div>
        </div>

        <!-- MODUL LAPORAN TAHUNAN -->
        <div id="tahunan-module" class="module-content" style="display: none;">
            <div id="tahunan-pdf-content">
                <div class="annual-report-title">
                    <h2>LAPORAN KEUANGAN TAHUNAN</h2>
                    <p>UPZIS NU Ranting Ngablak</p>
                    <p id="tahunan-periode"></p>
                </div>
                <table>
                    <thead>
                        <tr><th>Deskripsi</th><th>Nominal</th></tr>
                    </thead>
                    <tbody>
                        <tr><td>Total Koin NU</td><td id="tahunan-total-koin" class="text-right">0</td></tr>
                        <tr><td>Total Donatur</td><td id="tahunan-total-donatur" class="text-right">0</td></tr>
                        <tr><td>Dana Pendidikan</td><td id="tahunan-total-pend-uang" class="text-right">0</td></tr>
                        <tr><td>Dana Kesehatan</td><td id="tahunan-total-kes-uang" class="text-right">0</td></tr>
                        <tr><td>Dana Ekonomi</td><td id="tahunan-total-eko-uang" class="text-right">0</td></tr>
                        <tr><td>Dana Sosial</td><td id="tahunan-total-sosial-uang" class="text-right">0</td></tr>
                        <tr><td>Dana Banom</td><td id="tahunan-total-banom-uang" class="text-right">0</td></tr>
                        <tr><td>Dana Bencana</td><td id="tahunan-total-bencana-uang" class="text-right">0</td></tr>

                        <tr><td>Honor Petugas</td><td id="tahunan-total-honor-petugas" class="text-right">0</td></tr>
                        <tr><td>Honor MWC</td><td id="tahunan-total-honor-mwc" class="text-right">0</td></tr>
                        <tr><td>Honor PC</td><td id="tahunan-total-honor-pc" class="text-right">0</td></tr>
                        <tr><td>Operasional Rapat</td><td id="tahunan-total-rapat" class="text-right">0</td></tr>
                        <tr><td>Perawatan MLU</td><td id="tahunan-total-perwtn-mlu" class="text-right">0</td></tr>
                        <tr><td>Biaya Rek. Bank</td><td id="tahunan-total-biaya-rek-bank" class="text-right">0</td></tr>
                        <tr><td>Lain-lain Pengeluaran</td><td id="tahunan-total-lain-lain-peng" class="text-right">0</td></tr>
                    </tbody>
                    <tfoot>
                        <tr><td><strong>Total Pengeluaran</strong></td><td id="tahunan-total-pengeluaran" class="text-right"><strong>0</strong></td></tr>
                        <tr><td><strong>Saldo Akhir Tahun Berjalan</strong></td><td id="tahunan-total-saldo-akhir" class="text-right"><strong>0</strong></td></tr>
                    </tfoot>
                </table>

                <button onclick="downloadPDF('tahunan')" style="margin-top: 15px;">Download PDF Laporan Tahunan</button>
                
                <div id="tahunan-ttd-area" class="ttd-area">
                    <div class="ttd-block">
                        Ngablak, <span id="tahunan-ttd-tanggal-output"></span><br>
                        Ketua UPZIS Ranting<br><br><br><br>
                        (...............................)
                    </div>
                </div>
            </div>
        </div>

    </div>
    <!-- AKHIR KONTEN UTAMA APLIKASI -->


    <script>
        // --- PLACEHOLDER FUNGSI JAVASCRIPT YANG TERKAIT DENGAN UI YANG DIKEMBALIKAN ---

        window.saveKoinRecord = function() {
            // Placeholder: Logika untuk menyimpan Koin NU
            console.log("Simpan Koin Record (Placeholder)");
            window.hideInputForm('koin');
            // TODO: LENGKAPI LOGIKA PERHITUNGAN 60/10/25/5% dan panggil saveDataToStorage
        };

        window.saveJurnalRecord = function() {
            // Placeholder: Logika untuk menyimpan Jurnal Manual
            console.log("Simpan Jurnal Record (Placeholder)");
            window.hideInputForm('jurnal');
            // TODO: LENGKAPI LOGIKA VALIDASI dan panggil saveDataToStorage
        };

        window.filterData = function(type) {
             // Placeholder: Logika untuk memfilter data
             console.log(`Filtering data ${type} (Placeholder)`);
             if (type === 'koin') window.renderKoinTable();
             if (type === 'jurnal') window.renderJurnalTable();
             // TODO: Ambil nilai filter bulan/tahun dan filter window.koinData/window.jurnalData
        };

        // FUNGSI INI MENGISI DROPDOWN FILTER BULAN DAN TAHUN (SANGAT PENTING UNTUK TAMPILAN FILTER!)
        window.populateFilterOptions = function() {
            const currentMonth = new Date().getMonth() + 1;
            const currentYear = new Date().getFullYear();
            
            // Mengisi filter bulan
            const months = ['Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni', 'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'];
            ['koin-filter-month', 'jurnal-filter-month'].forEach(id => {
                const select = document.getElementById(id);
                if (select) {
                    select.innerHTML = '<option value="0">Semua Bulan</option>';
                    months.forEach((month, index) => {
                        const option = document.createElement('option');
                        option.value = index + 1;
                        option.textContent = month;
                        if (index + 1 === currentMonth) option.selected = true;
                        select.appendChild(option);
                    });
                }
            });

            // Mengisi filter tahun
             ['koin-filter-year', 'jurnal-filter-year'].forEach(id => {
                const select = document.getElementById(id);
                if (select) {
                    select.innerHTML = '';
                    for (let year = currentYear - 2; year <= currentYear + 1; year++) {
                        const option = document.createElement('option');
                        option.value = year;
                        option.textContent = year;
                        if (year === currentYear) option.selected = true;
                        select.appendChild(option);
                    }
                }
            });
            window.currentMonth = currentMonth;
            window.currentYear = currentYear;
            console.log("Filter options berhasil diisi.");
        };


        // --- FUNGSI RENDER (DIPERTANKAN) ---

        window.renderKoinTable = function() {
            const body = document.getElementById('koin-table-body');
            body.innerHTML = '';
            // (Logika rendering dan total koin di sini...)
            if (window.koinData.length === 0) {
                body.innerHTML = `<tr><td colspan="9" class="text-center">Tidak ada data Koin NU yang ditemukan.</td></tr>`;
            } else {
                 // SENSITIF: Logika tampilan tombol Edit/Hapus bergantung pada window.isLoggedIn
                 window.koinData.forEach((record, index) => {
                    const aksiCell = window.isLoggedIn ? 
                        `<td class="action-btns"><button onclick="editRecord('koin', ${index})">Edit</button><button onclick="deleteRecord('koin', ${index})">Hapus</button></td>` : 
                        `<td style="display:none;"></td>`;
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `${aksiCell}
                        <td>${index + 1}</td>
                        <td>${record.tanggal || 'N/A'}</td>
                        <td>${record.ranting || 'N/A'}</td>
                        <td class="text-right">${window.formatRupiah(record.totalKoin || 0)}</td>
                        <td class="text-right">${window.formatRupiah(record.ranting60 || 0)}</td>
                        <td class="text-right">${window.formatRupiah(record.petugas10 || 0)}</td>
                        <td class="text-right">${window.formatRupiah(record.mwc25 || 0)}</td>
                        <td class="text-right">${window.formatRupiah(record.pc5 || 0)}</td>`;
                    body.appendChild(row);
                });
            }
            // Pastikan header Aksi disembunyikan/ditampilkan
             const koinHeader = document.getElementById('koin-aksi-header');
             if (koinHeader) koinHeader.style.display = window.isLoggedIn ? 'table-cell' : 'none';
        };

        window.renderJurnalTable = function() {
            const body = document.getElementById('jurnal-table-body');
            body.innerHTML = '';
            // (Logika rendering dan saldo jurnal di sini...)
             if (window.jurnalData.length === 0) {
                body.innerHTML = `<tr><td colspan="8" class="text-center">Tidak ada data Jurnal Manual yang ditemukan.</td></tr>`;
            } else {
                 // SENSITIF: Logika tampilan tombol Edit/Hapus bergantung pada window.isLoggedIn
                 let saldo = 0;
                 window.jurnalData.forEach((record, index) => {
                    saldo += (record.masuk || 0) - (record.keluar || 0);

                    const aksiCell = window.isLoggedIn ? 
                        `<td class="action-btns"><button onclick="editRecord('jurnal', ${index})">Edit</button><button onclick="deleteRecord('jurnal', ${index})">Hapus</button></td>` : 
                        `<td style="display:none;"></td>`;
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `${aksiCell}
                        <td>${index + 1}</td>
                        <td>${record.tanggal || 'N/A'}</td>
                        <td>${record.kategori || 'N/A'}</td>
                        <td>${record.keterangan || 'N/A'}</td>
                        <td class="text-right">${window.formatRupiah(record.masuk || 0)}</td>
                        <td class="text-right">${window.formatRupiah(record.keluar || 0)}</td>
                        <td class="text-right">${window.formatRupiah(saldo)}</td>`;
                    body.appendChild(row);
                });
            }
            // Pastikan header Aksi disembunyikan/ditampilkan
            const jurnalHeader = document.getElementById('jurnal-aksi-header');
            if (jurnalHeader) jurnalHeader.style.display = window.isLoggedIn ? 'table-cell' : 'none';
        };

        window.renderAnnualReportTable = function() {
            const periodeElement = document.getElementById('tahunan-periode');
            periodeElement.textContent = `Periode: 1 Januari ${window.currentYear} - 31 Desember ${window.currentYear}`;
            
            window.updateAnnualFooter(window.annualData.total || {}, window.annualData.dataToRender || []);
        }

        window.generateAnnualReportData = function() {
            console.log("Generating Annual Report Data...");
        }

        // Placeholder untuk fungsi Edit dan Delete
        window.editRecord = function(type, index) { console.log(`Edit ${type} record di index ${index}`); };
        window.deleteRecord = function(type, index) { console.log(`Delete ${type} record di index ${index}`); };


    </script>
</body>
</html>
