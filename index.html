<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Input & Laporan KOIN NU Paling Detail (Firebase)</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    
    <style>
        /* CSS yang sudah ada di file asli Anda (disederhanakan) */
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f8f9fa; }
        .main-container { max-width: 1200px; margin: 20px auto; padding: 20px; background: white; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        .tab-content { border: 1px solid #ccc; padding: 15px; border-radius: 5px; margin-bottom: 20px; }
        .tab-button.active { background-color: #006400; color: white; }
        .btn-success { background-color: #006400; color: white; }
        .btn-danger { background-color: #dc3545; color: white; }
        .table-container { overflow-x: auto; margin-top: 10px; }
        table { width: 100%; border-collapse: collapse; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
        .sticky-col { position: sticky; left: 0; background-color: white; z-index: 2; }
        .sticky-header { position: sticky; top: 0; z-index: 3; }
        .text-right { text-align: right; }
        .text-center { text-align: center; }
    </style>
</head>
<body>

    <div class="main-container">
        <header class="mb-6">
            <h1 class="text-3xl font-bold text-center text-green-800">Sistem Input & Laporan KOIN NU</h1>
            
            <div id="auth-section" class="flex justify-between items-center bg-gray-100 p-4 rounded-md mt-4">
                <div id="login-form-content-bar" class="flex items-center space-x-2 w-full">
                    <input type="email" id="login-email-input" placeholder="Email Admin" class="p-2 border rounded flex-grow">
                    <input type="password" id="login-password-input" placeholder="Password Admin" class="p-2 border rounded flex-grow">
                    <button onclick="login()" class="bg-blue-600 text-white p-2 rounded hover:bg-blue-700 whitespace-nowrap">Login Admin</button>
                    <span id="login-message-bar" class="text-red-500"></span>
                </div>
                
                <div id="logout-form-content-bar" class="hidden items-center space-x-4 w-full justify-between">
                    <span class="text-sm">Logged in as: <strong id="logged-in-user">admin@example.com</strong></span>
                    <div class="flex space-x-2">
                        <button onclick="confirmResetAllData()" class="bg-yellow-600 text-white p-2 rounded hover:bg-yellow-700 whitespace-nowrap">Reset Semua Data</button>
                        <button onclick="logout()" class="bg-red-600 text-white p-2 rounded hover:bg-red-700 whitespace-nowrap">Logout</button>
                    </div>
                </div>
            </div>
            
            <div class="flex justify-center mt-4 space-x-3">
                <button onclick="exportM1APDF()" class="bg-purple-600 text-white p-2 rounded hover:bg-purple-700">Unduh PDF KOIN NU (M1A)</button>
                <button onclick="exportM2PDF()" class="bg-green-600 text-white p-2 rounded hover:bg-green-700">Unduh PDF Manual (M2)</button>
                <button onclick="exportGlobalPDF()" class="bg-indigo-600 text-white p-2 rounded hover:bg-indigo-700">Unduh PDF Global</button>
            </div>
        </header>

        <nav class="flex border-b border-gray-300 mb-4">
            <button id="tab-m1a" onclick="showModule('m1a')" class="tab-button p-3 border-r active">1. Input KOIN NU (M1A)</button>
            <button id="tab-m1b" onclick="showModule('m1b')" class="tab-button p-3 border-r">2. Laporan Agregat (M1B)</button>
            <button id="tab-m2" onclick="showModule('m2')" class="tab-button p-3">3. Jurnal Manual (M2)</button>
        </nav>

        <div id="module-m1a" class="tab-content">
            <h2 class="text-2xl font-semibold mb-3">1. Input Data KOIN NU (M1A)</h2>
            <div id="m1a-input-container" class="hidden">
                <form id="form-m1a" class="grid grid-cols-6 gap-4 p-4 bg-blue-50 border rounded mb-4">
                    <input type="hidden" id="m1a-original-index-input">
                    <div><label class="block text-sm">Tanggal</label><input type="date" id="m1a-date-input" required class="p-2 border rounded w-full"></div>
                    <div><label class="block text-sm">Petugas</label><input type="text" id="m1a-petugas-input" required placeholder="Nama Petugas" class="p-2 border rounded w-full"></div>
                    <div><label class="block text-sm">No. HP</label><input type="text" id="m1a-noHp-input" placeholder="No. HP Petugas" class="p-2 border rounded w-full"></div>
                    <div><label class="block text-sm">Nama Donatur</label><input type="text" id="m1a-donatur-input" required placeholder="Nama Donatur/Kepala KK" class="p-2 border rounded w-full"></div>
                    <div><label class="block text-sm">Alamat</label><input type="text" id="m1a-alamat-input" required placeholder="Alamat/RT/RW" class="p-2 border rounded w-full"></div>
                    <div><label class="block text-sm">Nominal (Rp)</label><input type="number" id="m1a-nominal-input" required min="1" placeholder="Nominal Uang" class="p-2 border rounded w-full"></div>
                    <div class="col-span-6 flex space-x-2">
                        <button type="submit" id="m1a-submit-btn" class="bg-green-600 text-white p-2 rounded hover:bg-green-700 w-full">Catat Transaksi KOIN NU</button>
                        <button type="button" id="m1a-cancel-btn" onclick="clearKoinNUInputs()" class="hidden bg-gray-500 text-white p-2 rounded hover:bg-gray-600">Batal Edit</button>
                    </div>
                </form>
            </div>
            
            <div class="table-container">
                <table id="m1a-table" class="min-w-full divide-y divide-gray-200">
                    </table>
            </div>
        </div>

        <div id="module-m1b" class="tab-content hidden">
            <h2 class="text-2xl font-semibold mb-3">2. Laporan Agregat Bulanan (M1B)</h2>
            <div id="m1b-controls" class="mb-4 flex space-x-3">
                <div><label class="block text-sm">Filter Tahun</label><select id="filter-year" onchange="recalculateAllReports()" class="p-2 border rounded"></select></div>
                <div><label class="block text-sm">Filter Bulan</label><select id="filter-month" onchange="recalculateAllReports()" class="p-2 border rounded"><option value="">Semua Bulan</option></select></div>
            </div>
            
            <div class="table-container">
                <table id="m1b-table" class="min-w-full divide-y divide-gray-200">
                    </table>
            </div>
            
            <div id="m1b-update-container" class="mt-4 hidden">
                <h3 class="text-xl font-semibold mb-2">Update Data Agregat Manual (Hanya Admin)</h3>
                <form id="form-m1b" class="grid grid-cols-3 gap-4 p-4 bg-yellow-50 border rounded">
                    <div class="col-span-3 text-sm text-yellow-800">Perhatian: Data di bawah ini adalah data bulanan yang diinput/diperbarui manual.</div>
                    <div class="col-span-3"><button type="submit" class="bg-indigo-600 text-white p-2 rounded hover:bg-indigo-700 w-full">Simpan Data Agregat</button></div>
                </form>
            </div>
        </div>

        <div id="module-m2" class="tab-content hidden">
            <h2 class="text-2xl font-semibold mb-3">3. Jurnal Transaksi Manual (M2)</h2>
            <div id="m2-input-container" class="hidden">
                <form id="form-m2" class="grid grid-cols-6 gap-4 p-4 bg-red-50 border rounded mb-4">
                    <input type="hidden" id="m2-original-index-input">
                    <div><label class="block text-sm">Tanggal</label><input type="date" id="m2-date-input" required class="p-2 border rounded w-full"></div>
                    <div class="col-span-2"><label class="block text-sm">Keterangan</label><input type="text" id="m2-keterangan-input" required placeholder="Uraian Transaksi" class="p-2 border rounded w-full"></div>
                    <div><label class="block text-sm">Kategori</label><select id="m2-kategori-input" required class="p-2 border rounded w-full"></select></div>
                    <div><label class="block text-sm">Dana Masuk (Debit Rp)</label><input type="number" id="m2-debit-input" min="0" placeholder="0" class="p-2 border rounded w-full"></div>
                    <div><label class="block text-sm">Dana Keluar (Kredit Rp)</label><input type="number" id="m2-kredit-input" min="0" placeholder="0" class="p-2 border rounded w-full"></div>
                    <div class="col-span-6 flex space-x-2">
                        <button type="submit" id="m2-submit-btn" class="bg-red-600 text-white p-2 rounded hover:bg-red-700 w-full">Catat Transaksi Manual</button>
                        <button type="button" id="m2-cancel-btn" onclick="clearManualInputs()" class="hidden bg-gray-500 text-white p-2 rounded hover:bg-gray-600">Batal Edit</button>
                    </div>
                </form>
            </div>

            <div class="table-container">
                <table id="m2-table" class="min-w-full divide-y divide-gray-200">
                    </table>
            </div>
        </div>
    </div>

    <script>
        const { jsPDF } = window.jspdf;

        // ====================================================================================
        // !!! 1. KONFIGURASI FIREBASE ANDA !!!
        // GANTI NILAI DI BAWAH INI DENGAN DATA PROYEK FIREBASE ANDA
        // ====================================================================================
        const firebaseConfig = {
            apiKey: "AIzaSyA_8NMmZBaXZ4H6KQt7rHy8G1URR3HLP3A", // GANTI INI
            authDomain: "upzis-ngablak.firebaseapp.com", // GANTI INI
            projectId: "upzis-ngablak", // GANTI INI
            storageBucket: "upzis-ngablak.firebasestorage.app", // GANTI INI
            messagingSenderId: "869549648344", // GANTI INI
            appId: "1:869549648344:web:a531a37cce3a87bb672aad" // GANTI INI
        };
        // ====================================================================================

        // DEKLARASI GLOBAL FIREBASE & DATA
        let db;
        let auth;
        let isLoggedIn = false;
        let currentAdminEmail = null;

        // Data Utama (Semua data dari Firestore akan dimuat ke sini)
        let m1aTransactions = []; // Transaksi KOIN NU (list detail)
        let m2ManualTransactions = []; // Transaksi Manual (debit/kredit)
        let m1AggregateData = []; // Data Agregat Bulanan Manual (M1B)

        // Variabel untuk state aplikasi
        let currentModule = 'm1a';
        const M2_CATEGORIES = [
            'Infaq dan Shodaqoh', 'Zakat', 'Dana Lain-lain Masuk', 
            'Pendidikan (Santunan)', 'Kesehatan (Santunan)', 'Sosial Umum (Santunan)', 
            'Banom (Kegiatan)', 'Penanggulangan Bencana', 'Biaya Rapat/Operasional', 
            'Perawatan Inventaris', 'Biaya Bank/Administrasi', 'Pengeluaran Lain-lain'
        ];

        // --------------------------------------------------------------------------------
        // 2. FIREBASE UTILITIES (Load & Save Data)
        // --------------------------------------------------------------------------------

        /**
         * Memuat semua data utama (M1A, M2, M1B Aggregate) dari Firestore
         */
        async function loadDataFromFirebase() {
            try {
                // Muat Data Modul 1A (KOIN NU Transactions)
                const m1aRef = db.collection('transactions').doc('koin_nu_list');
                const m1aDoc = await m1aRef.get();
                m1aTransactions = m1aDoc.exists && m1aDoc.data().transactions ? m1aDoc.data().transactions : [];

                // Muat Data Modul 2 (Manual Transactions)
                const m2Ref = db.collection('transactions').doc('manual_jurnal');
                const m2Doc = await m2Ref.get();
                m2ManualTransactions = m2Doc.exists && m2Doc.data().transactions ? m2Doc.data().transactions : [];

                // Muat Data Modul 1B (Aggregate Manual Input)
                const m1bRef = db.collection('reports').doc('aggregate_monthly');
                const m1bDoc = await m1bRef.get();
                m1AggregateData = m1bDoc.exists && m1bDoc.data().data ? m1bDoc.data().data : [];

            } catch (error) {
                console.error("Error saat memuat data dari Firebase:", error);
                alert("Gagal memuat data dari server. Cek koneksi dan Rules Firestore Anda.");
            }
        }

        /**
         * Menyimpan semua data utama (M1A, M2, M1B Aggregate) ke Firestore
         */
        async function saveDataToFirebase() {
            if (!isLoggedIn) return; 

            try {
                const batch = db.batch();
                const timestamp = firebase.firestore.FieldValue.serverTimestamp();
                
                // 1. Simpan Data Modul 1A
                const m1aRef = db.collection('transactions').doc('koin_nu_list');
                batch.set(m1aRef, { 
                    transactions: m1aTransactions, 
                    lastUpdated: timestamp,
                    updatedBy: currentAdminEmail
                });

                // 2. Simpan Data Modul 2
                const m2Ref = db.collection('transactions').doc('manual_jurnal');
                batch.set(m2Ref, { 
                    transactions: m2ManualTransactions, 
                    lastUpdated: timestamp,
                    updatedBy: currentAdminEmail
                });

                // 3. Simpan Data Modul 1B
                const m1bRef = db.collection('reports').doc('aggregate_monthly');
                batch.set(m1bRef, { 
                    data: m1AggregateData, 
                    lastUpdated: timestamp,
                    updatedBy: currentAdminEmail
                });
                
                await batch.commit();
                console.log("Semua data berhasil disimpan ke Firebase.");

            } catch (error) {
                console.error("Error saat menyimpan data ke Firebase:", error);
                alert("Gagal menyimpan data ke server. Cek koneksi dan Rules Firestore Anda.");
            }
        }

        // --------------------------------------------------------------------------------
        // 3. AUTENTIKASI DAN GLOBAL RENDER CONTROL
        // --------------------------------------------------------------------------------

        function handleAuthStateChange(user) {
            isLoggedIn = !!user;
            currentAdminEmail = user ? user.email : null;

            const loginBar = document.getElementById('login-form-content-bar');
            const logoutBar = document.getElementById('logout-form-content-bar');
            
            if (isLoggedIn) {
                loginBar.style.display = 'none';
                logoutBar.style.display = 'flex';
                document.getElementById('logged-in-user').textContent = currentAdminEmail;
            } else {
                loginBar.style.display = 'flex';
                logoutBar.style.display = 'none';
            }
            
            // Perbarui visibility input form
            updateAdminViewVisibility(isLoggedIn);
        }

        function updateAdminViewVisibility(isLogged) {
            document.getElementById('m1a-input-container').classList.toggle('hidden', !(isLogged && currentModule === 'm1a'));
            document.getElementById('m2-input-container').classList.toggle('hidden', !(isLogged && currentModule === 'm2'));
            document.getElementById('m1b-update-container').classList.toggle('hidden', !(isLogged && currentModule === 'm1b'));
        }
        
        window.login = async () => {
            const email = document.getElementById('login-email-input').value;
            const password = document.getElementById('login-password-input').value;
            const loginMessage = document.getElementById('login-message-bar');
            loginMessage.textContent = '';
            
            if (!email || !password) {
                loginMessage.textContent = "Email & Password wajib diisi.";
                return;
            }

            try {
                loginMessage.textContent = "Loading...";
                await auth.signInWithEmailAndPassword(email, password);
                
                // Setelah login berhasil, onAuthStateChanged akan dipanggil, yang akan memuat data
                loginMessage.textContent = "Login Berhasil! Memuat data...";
            } catch (error) {
                loginMessage.textContent = "Login Gagal: " + error.message;
                console.error("Login Error:", error);
            }
        };

        window.logout = async () => {
            try {
                await auth.signOut();
                // onAuthStateChanged akan dipanggil
            } catch (error) {
                console.error("Logout Error:", error);
            }
        };
        
        window.confirmResetAllData = async () => {
             if (!isLoggedIn) return;

            if (confirm('PERINGATAN KERAS! Anda yakin ingin MENGHAPUS SEMUA data KOIN NU, JURNAL MANUAL, dan DATA AGREGAT dari Firebase? Tindakan ini tidak bisa dibatalkan!')) {
                try {
                    const batch = db.batch();
                    
                    // Hapus data KOIN NU
                    batch.set(db.collection('transactions').doc('koin_nu_list'), { transactions: [] });
                    // Hapus data Jurnal Manual
                    batch.set(db.collection('transactions').doc('manual_jurnal'), { transactions: [] });
                    // Hapus data Agregat Manual
                    batch.set(db.collection('reports').doc('aggregate_monthly'), { data: [] });
                    
                    await batch.commit();
                    
                    // Reset lokal dan muat ulang
                    m1aTransactions = [];
                    m2ManualTransactions = [];
                    m1AggregateData = [];
                    
                    alert('Semua data berhasil direset (dikosongkan di Firebase).');
                    
                    // Logout dan render ulang
                    await auth.signOut();
                    renderAppView(); 
                } catch (error) {
                    console.error("Error saat mereset data Firebase: ", error);
                    alert("Gagal mereset data. Pastikan Rules Firestore Anda mengizinkan operasi 'write' bagi user yang terautentikasi.");
                }
            }
        };

        // --------------------------------------------------------------------------------
        // 4. HELPER FUNCTIONS (Format Rupiah, Sorting, etc.)
        // --------------------------------------------------------------------------------

        const formatRupiah = (angka) => {
            if (angka === undefined || angka === null || isNaN(angka)) return 'Rp 0';
            const numberString = Math.abs(angka).toString().replace(/[^,\d]/g, '');
            const split = numberString.split(',');
            const sisa = split[0].length % 3;
            let rupiah = split[0].substr(0, sisa);
            const ribuan = split[0].substr(sisa).match(/\d{3}/gi);
            
            if (ribuan) {
                const separator = sisa ? '.' : '';
                rupiah += separator + ribuan.join('.');
            }
            
            rupiah = split[1] !== undefined ? rupiah + ',' + split[1] : rupiah;
            return (angka < 0 ? 'Rp -' : 'Rp ') + rupiah; 
        };

        const monthNames = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];
        
        // --------------------------------------------------------------------------------
        // 5. M1A (KOIN NU) CRUD & RENDER (UPDATED WITH FIREBASE)
        // --------------------------------------------------------------------------------
        
        document.getElementById('form-m1a').addEventListener('submit', function(e) {
            e.preventDefault();
            if (!isLoggedIn) return alert('Akses Ditolak. Silakan login sebagai Admin.');

            const date = document.getElementById('m1a-date-input').value;
            const petugas = document.getElementById('m1a-petugas-input').value.trim();
            const noHp = document.getElementById('m1a-noHp-input').value.trim();
            const donatur = document.getElementById('m1a-donatur-input').value.trim();
            const alamat = document.getElementById('m1a-alamat-input').value.trim();
            const nominal = parseInt(document.getElementById('m1a-nominal-input').value);
            const originalIndex = document.getElementById('m1a-original-index-input').value;
            
            if (!date || !petugas || !donatur || isNaN(nominal) || nominal <= 0) {
                alert('Mohon isi semua kolom dengan benar.');
                return;
            }

            const newTransaction = { date, petugas, noHp, donatur, alamat, nominal, updatedBy: currentAdminEmail };

            if (originalIndex !== "") {
                // Edit Mode
                m1aTransactions[parseInt(originalIndex)] = newTransaction;
                alert('Data KOIN NU berhasil diubah.');
            } else {
                // Add Mode
                m1aTransactions.push(newTransaction);
                alert('Data KOIN NU berhasil ditambahkan.');
            }
            
            saveDataToFirebase();
            recalculateAllReports();
            clearKoinNUInputs();
        });

        window.editKoinNUTxn = (index) => {
            if (!isLoggedIn) return alert('Akses Ditolak. Silakan login sebagai Admin.');
            const data = m1aTransactions[index];
            if (!data) return;

            document.getElementById('m1a-original-index-input').value = index;
            document.getElementById('m1a-date-input').value = data.date;
            document.getElementById('m1a-petugas-input').value = data.petugas;
            document.getElementById('m1a-noHp-input').value = data.noHp;
            document.getElementById('m1a-donatur-input').value = data.donatur;
            document.getElementById('m1a-alamat-input').value = data.alamat;
            document.getElementById('m1a-nominal-input').value = data.nominal;
            
            document.getElementById('m1a-submit-btn').textContent = 'Simpan Perubahan KOIN NU';
            document.getElementById('m1a-submit-btn').classList.replace('bg-green-600', 'bg-blue-600');
            document.getElementById('m1a-submit-btn').classList.replace('hover:bg-green-700', 'hover:bg-blue-700');
            document.getElementById('m1a-cancel-btn').classList.remove('hidden');
        };

        window.deleteKoinNUTxn = (index) => {
            if (!isLoggedIn) return alert('Akses Ditolak. Hanya admin yang dapat menghapus data.');
            if (confirm('Anda yakin ingin menghapus transaksi KOIN NU ini?')) {
                m1aTransactions.splice(index, 1);
                saveDataToFirebase();
                recalculateAllReports();
            }
        };

        window.clearKoinNUInputs = () => {
            document.getElementById('form-m1a').reset();
            document.getElementById('m1a-original-index-input').value = '';
            document.getElementById('m1a-submit-btn').textContent = 'Catat Transaksi KOIN NU';
            document.getElementById('m1a-submit-btn').classList.replace('bg-blue-600', 'bg-green-600');
            document.getElementById('m1a-submit-btn').classList.replace('hover:bg-blue-700', 'hover:bg-green-700');
            document.getElementById('m1a-cancel-btn').classList.add('hidden');
        };
        
        function renderM1ATable() {
            // (Function logic for rendering M1A table here, using m1aTransactions)
            // ... (Kode render tabel M1A yang sudah Anda miliki) ...
            const tableBody = document.getElementById('m1a-table');
            tableBody.innerHTML = '';
            
            const header = `
                <thead class="bg-green-700 text-white">
                    <tr>
                        <th class="sticky-col text-center sticky-header">No</th>
                        <th class="sticky-header">Tanggal</th>
                        <th class="sticky-header">Petugas</th>
                        <th class="sticky-header">No. HP</th>
                        <th class="sticky-header">Donatur</th>
                        <th class="sticky-header">Alamat</th>
                        <th class="text-right sticky-header">Nominal (Rp)</th>
                        <th class="text-center sticky-header ${isLoggedIn ? '' : 'hidden'}">Aksi</th>
                    </tr>
                </thead>
                <tbody id="m1a-table-body"></tbody>
            `;
            tableBody.innerHTML = header;

            const body = document.getElementById('m1a-table-body');
            if (m1aTransactions.length === 0) {
                body.innerHTML = `<tr><td colspan="8" class="text-center py-4 text-gray-500">Belum ada data KOIN NU.</td></tr>`;
                return;
            }

            m1aTransactions.forEach((t, index) => {
                const row = body.insertRow();
                row.insertCell().innerHTML = `<div class="sticky-col text-center">${index + 1}</div>`;
                row.insertCell().textContent = new Date(t.date).toLocaleDateString('id-ID');
                row.insertCell().textContent = t.petugas;
                row.insertCell().textContent = t.noHp || '-';
                row.insertCell().textContent = t.donatur;
                row.insertCell().textContent = t.alamat;
                row.insertCell().innerHTML = `<div class="text-right">${formatRupiah(t.nominal)}</div>`;
                
                const actionCell = row.insertCell();
                actionCell.className = `text-center ${isLoggedIn ? '' : 'hidden'}`;
                actionCell.innerHTML = `
                    <button onclick="editKoinNUTxn(${index})" class="text-blue-600 hover:text-blue-900 text-sm mr-2">Edit</button>
                    <button onclick="deleteKoinNUTxn(${index})" class="text-red-600 hover:text-red-900 text-sm">Hapus</button>
                `;
            });
            // ... (End of render M1A table)
        }


        // --------------------------------------------------------------------------------
        // 6. M2 (MANUAL JURNAL) CRUD & RENDER (UPDATED WITH FIREBASE)
        // --------------------------------------------------------------------------------

        function populateM2Categories() {
            const select = document.getElementById('m2-kategori-input');
            select.innerHTML = '<option value="">Pilih Kategori</option>';
            M2_CATEGORIES.forEach(cat => {
                select.innerHTML += `<option value="${cat}">${cat}</option>`;
            });
        }
        
        document.getElementById('form-m2').addEventListener('submit', function(e) {
            e.preventDefault();
            if (!isLoggedIn) return alert('Akses Ditolak. Silakan login sebagai Admin.');

            const date = document.getElementById('m2-date-input').value;
            const keterangan = document.getElementById('m2-keterangan-input').value.trim();
            const kategori = document.getElementById('m2-kategori-input').value;
            const debit = parseInt(document.getElementById('m2-debit-input').value || 0);
            const kredit = parseInt(document.getElementById('m2-kredit-input').value || 0);
            const originalIndex = document.getElementById('m2-original-index-input').value;
            
            if (!date || !keterangan || !kategori || (debit === 0 && kredit === 0) || (debit > 0 && kredit > 0)) {
                alert('Mohon isi Tanggal, Keterangan, Kategori, dan masukkan hanya salah satu: Dana Masuk atau Dana Keluar.');
                return;
            }

            const newTransaction = { date, keterangan, kategori, debit, kredit, isAuto: false, updatedBy: currentAdminEmail };

            if (originalIndex !== "") {
                // Edit Mode
                m2ManualTransactions[parseInt(originalIndex)] = newTransaction;
                alert('Data Jurnal Manual berhasil diubah.');
            } else {
                // Add Mode
                m2ManualTransactions.push(newTransaction);
                alert('Data Jurnal Manual berhasil ditambahkan.');
            }
            
            saveDataToFirebase();
            recalculateAllReports();
            clearManualInputs();
        });

        window.editManualTxn = (index) => {
             if (!isLoggedIn) return alert('Akses Ditolak. Silakan login sebagai Admin.');
            const data = m2ManualTransactions[index];
            if (!data) return;

            document.getElementById('m2-original-index-input').value = index;
            document.getElementById('m2-date-input').value = data.date;
            document.getElementById('m2-keterangan-input').value = data.keterangan;
            document.getElementById('m2-kategori-input').value = data.kategori;
            document.getElementById('m2-debit-input').value = data.debit;
            document.getElementById('m2-kredit-input').value = data.kredit;
            
            document.getElementById('m2-submit-btn').textContent = 'Simpan Perubahan Manual';
            document.getElementById('m2-submit-btn').classList.replace('bg-red-600', 'bg-blue-600');
            document.getElementById('m2-submit-btn').classList.replace('hover:bg-red-700', 'hover:bg-blue-700');
            document.getElementById('m2-cancel-btn').classList.remove('hidden');
        };

        window.deleteManualTxn = (index) => {
            if (!isLoggedIn) return alert('Akses Ditolak. Hanya admin yang dapat menghapus data.');
            if (confirm('Anda yakin ingin menghapus transaksi manual ini?')) {
                m2ManualTransactions.splice(index, 1);
                saveDataToFirebase();
                recalculateAllReports();
            }
        };

        window.clearManualInputs = () => {
            document.getElementById('form-m2').reset();
            document.getElementById('m2-original-index-input').value = '';
            document.getElementById('m2-submit-btn').textContent = 'Catat Transaksi Manual';
            document.getElementById('m2-submit-btn').classList.replace('bg-blue-600', 'bg-red-600');
            document.getElementById('m2-submit-btn').classList.replace('hover:bg-blue-700', 'hover:bg-red-700');
            document.getElementById('m2-cancel-btn').classList.add('hidden');
        };
        
        function renderM2Table() {
            // (Function logic for rendering M2 table here, using m2ManualTransactions)
            // ... (Kode render tabel M2 yang sudah Anda miliki) ...
            const tableBody = document.getElementById('m2-table');
            tableBody.innerHTML = '';
            
            const header = `
                <thead class="bg-red-700 text-white">
                    <tr>
                        <th class="sticky-col text-center sticky-header">No</th>
                        <th class="sticky-header">Tanggal</th>
                        <th class="sticky-header">Keterangan</th>
                        <th class="sticky-header">Kategori</th>
                        <th class="text-right sticky-header">Debit (Rp)</th>
                        <th class="text-right sticky-header">Kredit (Rp)</th>
                        <th class="text-right sticky-header">Saldo (Rp)</th>
                        <th class="text-center sticky-header ${isLoggedIn ? '' : 'hidden'}">Aksi</th>
                    </tr>
                </thead>
                <tbody id="m2-table-body"></tbody>
            `;
            tableBody.innerHTML = header;

            const body = document.getElementById('m2-table-body');
            
            // Gabungkan Transaksi M1A (sebagai entri Masuk) dan M2 Manual
            const totalM1A = m1aTransactions.reduce((sum, t) => sum + t.nominal, 0);
            const m1aEntry = { 
                date: m1aTransactions.length > 0 ? m1aTransactions.reduce((a, b) => new Date(a.date) > new Date(b.date) ? a : b).date : new Date().toISOString().split('T')[0], 
                keterangan: 'TOTAL AKUMULASI KOIN NU (Dari M1A)', 
                kategori: 'Infaq dan Shodaqoh', 
                debit: totalM1A, 
                kredit: 0, 
                isAuto: true 
            }; 
            
            const combinedData = [...m2ManualTransactions, m1aEntry]
                .sort((a, b) => new Date(a.date) - new Date(b.date));

            if (combinedData.length === 0 || (combinedData.length === 1 && totalM1A === 0)) {
                body.innerHTML = `<tr><td colspan="8" class="text-center py-4 text-gray-500">Jurnal kas umum masih kosong.</td></tr>`;
                return;
            }

            let runningBalance = 0;
            let totalDebit = 0;
            let totalKredit = 0;

            combinedData.forEach((t, index) => {
                runningBalance += t.debit - t.kredit;
                totalDebit += t.debit;
                totalKredit += t.kredit;
                
                const row = body.insertRow();
                const isAuto = t.isAuto;

                row.insertCell().innerHTML = `<div class="sticky-col text-center">${index + 1}</div>`;
                row.insertCell().textContent = new Date(t.date).toLocaleDateString('id-ID');
                row.insertCell().innerHTML = `<div class="${isAuto ? 'font-bold text-green-700' : ''}">${t.keterangan}</div>`;
                row.insertCell().textContent = t.kategori;
                row.insertCell().innerHTML = `<div class="text-right">${formatRupiah(t.debit)}</div>`;
                row.insertCell().innerHTML = `<div class="text-right">${formatRupiah(t.kredit)}</div>`;
                row.insertCell().innerHTML = `<div class="text-right font-semibold">${formatRupiah(runningBalance)}</div>`;
                
                const actionCell = row.insertCell();
                actionCell.className = `text-center ${isLoggedIn ? '' : 'hidden'}`;
                actionCell.innerHTML = isAuto ? '<span class="text-xs text-gray-500">Otomatis</span>' : `
                    <button onclick="editManualTxn(${m2ManualTransactions.indexOf(t)})" class="text-blue-600 hover:text-blue-900 text-sm mr-2">Edit</button>
                    <button onclick="deleteManualTxn(${m2ManualTransactions.indexOf(t)})" class="text-red-600 hover:text-red-900 text-sm">Hapus</button>
                `;
            });
            
            // Footer Total
            const footer = tableBody.createTFoot();
            const totalRow = footer.insertRow();
            totalRow.className = 'font-bold bg-gray-200';
            totalRow.insertCell().setAttribute('colspan', '4');
            totalRow.cells[0].textContent = 'TOTAL AKUMULASI KAS:';
            totalRow.cells[0].className = 'text-right';
            totalRow.insertCell().innerHTML = `<div class="text-right text-green-700">${formatRupiah(totalDebit)}</div>`;
            totalRow.insertCell().innerHTML = `<div class="text-right text-red-700">${formatRupiah(totalKredit)}</div>`;
            totalRow.insertCell().innerHTML = `<div class="text-right text-blue-700">${formatRupiah(runningBalance)}</div>`;
            totalRow.insertCell().className = `${isLoggedIn ? '' : 'hidden'}`;
        }

        // --------------------------------------------------------------------------------
        // 7. M1B (AGREGAT) LOGIC
        // --------------------------------------------------------------------------------
        
        // (Asumsi: Anda sudah memiliki fungsi renderM1BTable, populateFilters, dan updateInputData)
        // Saya akan tambahkan logika `saveDataToFirebase()` ke fungsi updateInputData.
        
        window.updateInputData = (prefix) => {
            if (!isLoggedIn) return alert('Akses Ditolak. Hanya admin yang dapat mengubah data agregat.');

            const month = parseInt(document.getElementById('filter-month').value);
            const year = parseInt(document.getElementById('filter-year').value);
            
            if (isNaN(month) || isNaN(year)) {
                 alert('Mohon pilih Bulan dan Tahun.');
                 return;
            }

            const key = `${year}-${month.toString().padStart(2, '0')}`;
            let index = m1AggregateData.findIndex(d => d.key === key);

            const newData = {
                key: key,
                year: year,
                month: month,
                // Tambahkan semua field dari form M1B (berdasarkan template)
                sosumUang: parseInt(document.getElementById(`${prefix}sosumUang`).value || 0),
                sosumPenerima: parseInt(document.getElementById(`${prefix}sosumPenerima`).value || 0),
                banomUang: parseInt(document.getElementById(`${prefix}banomUang`).value || 0),
                banomPenerima: parseInt(document.getElementById(`${prefix}banomPenerima`).value || 0),
                bencanaUang: parseInt(document.getElementById(`${prefix}bencanaUang`).value || 0),
                bencanaPenerima: parseInt(document.getElementById(`${prefix}bencanaPenerima`).value || 0),
                rapat: parseInt(document.getElementById(`${prefix}rapat`).value || 0),
                perwtnMlu: parseInt(document.getElementById(`${prefix}perwtnMlu`).value || 0),
                biayaBank: parseInt(document.getElementById(`${prefix}biayaBank`).value || 0),
                lainLain: parseInt(document.getElementById(`${prefix}lainLain`).value || 0),
                // Field lainnya...
                updatedBy: currentAdminEmail
            };

            if (index !== -1) {
                m1AggregateData[index] = newData;
            } else {
                m1AggregateData.push(newData);
            }
            
            saveDataToFirebase();
            recalculateAllReports();
            alert('Data Agregat berhasil diperbarui dan disimpan ke Firebase.');
        };
        
        function renderM1BTable() {
            // ... (Function logic for rendering M1B table, including aggregation of M1A and M2 data)
            // Saya tidak bisa mereplikasi semua kode M1B, tapi pastikan ia memanggil:
            // 1. Logic perhitungan data
            // 2. renderM1BTable
            // 3. renderM1BForm (dengan panggilan updateInputData)
        }
        
        // Asumsi: Di file asli, form M1B di-generate secara dinamis.
        function renderM1BForm(data, prefix) {
            const formContainer = document.getElementById('form-m1b');
            // ... (Code to generate input fields and assign updateInputData to submit button)
            formContainer.onsubmit = function(e) { e.preventDefault(); updateInputData(prefix); };
            // ...
        }

        // --------------------------------------------------------------------------------
        // 8. GLOBAL RENDER & ONLOAD
        // --------------------------------------------------------------------------------

        function recalculateAllReports() {
            // Fungsi ini akan melakukan semua perhitungan dan rendering
            populateM2Categories();
            // populateFilters(); // Panggil ini jika Anda mengimplementasikan M1B

            renderM1ATable();
            renderM2Table();
            // renderM1BTable(); // Panggil ini jika Anda mengimplementasikan M1B
            
            // Re-check visibility just in case
            updateAdminViewVisibility(isLoggedIn);
        }

        window.showModule = (moduleName) => {
            currentModule = moduleName;
            ['m1a', 'm1b', 'm2'].forEach(mod => {
                document.getElementById(`module-${mod}`).classList.toggle('hidden', mod !== moduleName);
                document.getElementById(`tab-${mod}`).classList.remove('active');
            });
            document.getElementById(`tab-${moduleName}`).classList.add('active');
            
            // Render ulang dan update visibility input form
            recalculateAllReports(); 
        };

        window.onload = async () => { 
            // 1. INJEKSI FIREBASE
            firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            auth = firebase.auth(); 
            
            // 2. SET LISTENER OTENTIKASI
            auth.onAuthStateChanged(async (user) => {
                handleAuthStateChange(user); 
                if (user) {
                    await loadDataFromFirebase();
                } else {
                    // Kosongkan data lokal jika logout
                    m1aTransactions = [];
                    m2ManualTransactions = [];
                    m1AggregateData = [];
                }
                
                // 3. RENDER APLIKASI
                recalculateAllReports(); 
            });

            // 4. SET MODUL DEFAULT
            showModule('m1a'); 
        };
        
        // --------------------------------------------------------------------------------
        // 9. PDF EXPORT (Pastikan menggunakan data array global yang sudah ter-update)
        // --------------------------------------------------------------------------------
        // (Tambahkan kembali fungsi exportM1APDF, exportM2PDF, exportGlobalPDF di sini)
        // ...
        
        window.exportM1APDF = () => {
             // Logic PDF M1A menggunakan m1aTransactions
             alert("Fungsi Export M1A dipanggil. Data dari m1aTransactions (" + m1aTransactions.length + " entri) akan digunakan.");
        };
        window.exportM2PDF = () => {
             // Logic PDF M2 menggunakan m2ManualTransactions dan m1aEntry
             alert("Fungsi Export M2 dipanggil. Data dari m2ManualTransactions (" + m2ManualTransactions.length + " entri) dan total M1A akan digunakan.");
        };
        window.exportGlobalPDF = () => {
             // Logic PDF Global menggunakan m1AggregateData, total M1A, dan total M2
             alert("Fungsi Export Global dipanggil. Data dari m1AggregateData (" + m1AggregateData.length + " entri) akan digunakan.");
        };
        
    </script>
    </body>
</html>
