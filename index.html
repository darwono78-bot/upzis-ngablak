<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Pembukuan UPZIS | Ranting Ngablak</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <style>
        /* Gaya CSS untuk Tampilan */
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; padding: 0; background-color: #f4f7f6; color: #333; }
        .container { padding: 20px; max-width: 100%; margin: auto; } /* Lebar Maksimum Disesuaikan */
        
        /* Gaya Navigasi */
        .navbar { background-color: #006400; color: white; padding: 10px 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.2); display: flex; align-items: center; justify-content: space-between; }
        .navbar-logo { font-size: 1.5rem; font-weight: bold; }
        .navbar-links a { color: white; text-decoration: none; padding: 8px 15px; margin-left: 10px; border-radius: 4px; transition: background-color 0.3s; }
        .navbar-links a:hover, .navbar-links a.active { background-color: #008000; }
        
        .button { padding: 10px 15px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; transition: background-color 0.3s; }
        .btn-green { background-color: #008000; color: white; }
        .btn-green:hover { background-color: #006400; }
        .btn-red { background-color: #cc0000; color: white; }
        .btn-red:hover { background-color: #a00000; }
        .btn-blue { background-color: #007bff; color: white; }
        .btn-blue:hover { background-color: #0056b3; }
        
        /* Gaya Login Box */
        .login-box { 
            background: white; 
            padding: 30px; 
            border-radius: 8px; 
            box-shadow: 0 4px 8px rgba(0,0,0,0.1); 
            width: 450px; 
            margin: 20px auto; 
        }
        .login-input-row { 
            display: flex; 
            gap: 10px; 
            margin-bottom: 10px; 
        }
        .login-input-row input { 
            width: 50%; 
            padding: 10px; 
            border: 1px solid #ccc; 
            border-radius: 4px; 
            box-sizing: border-box; 
            margin-bottom: 0; 
        }

        table { width: 100%; border-collapse: collapse; margin-top: 15px; background: white; box-shadow: 0 2px 4px rgba(0,0,0,0.05); font-size: 0.9rem; }
        th, td { border: 1px solid #ddd; padding: 10px; text-align: left; }
        th { background-color: #006400; color: white; text-align: center; font-size: small; }
        
        /* Gaya untuk kolom angka */
        .money-col { text-align: right !important; }
        /* Kelas untuk elemen yang disembunyikan di luar PDF Koin NU (Hanya Pembagian Dana yang tetap disembunyikan) */
        .koin-pembagian-col, .koin-pembagian-header { display: table-cell; }
        
        .action-btns button { margin: 2px; font-size: 0.7rem; padding: 5px; }
        .input-form { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); margin-top: 30px; }
        .input-form h3 { color: #006400; border-bottom: 2px solid #006400; padding-bottom: 5px; }
        .form-row { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 10px; }
        .form-row label { font-weight: bold; display: block; margin-bottom: 5px; }
        .form-row input, .form-row select { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        .form-controls { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        
        /* Gaya Footer Total */
        tfoot td { font-weight: bold; text-align: right; background-color: #f0f0f0; }
        .total-label { text-align: right !important; }

        /* TTD Area Diperbaiki (Centered Block) */
        .ttd-area { 
            width: 80%; 
            margin: 30px auto 0 auto; 
            display: none; 
            justify-content: space-between; 
            padding: 20px 0; 
            box-sizing: border-box; 
        }
        .ttd-box { 
            text-align: center; 
            width: 45%; 
        }
        
        .ttd-box p { margin: 0; line-height: 1.5; }
        .ttd-line { 
            height: 1px; 
            width: 100%; 
            background: black; 
            margin: 30px 0 5px 0; 
        }
        /* ============================ */

        .report-header-section {
            display: flex;
            justify-content: space-between; 
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #ddd;
        }
        .report-title-center { text-align: center; flex-grow: 1; }
        .report-controls { display: flex; gap: 10px; align-items: center; }
        .auto-entry { font-style: italic; background-color: #f9f9f9; }
        .manual-entry { background-color: #fffacd; } 
        .saldo-entry { background-color: #e6ffe6; font-weight: bold; } 
        .total-saldo { background-color: #d4edda !important; color: #155724; } 
        
        /* === Gaya Laporan Tahunan Baru === */
        #annual-data-table th { font-size: x-small; padding: 5px; vertical-align: middle; }
        #annual-data-table td { font-size: x-small; padding: 5px; }
        .annual-sub-header { background-color: #008000; color: white; font-weight: bold; }
        .annual-manual-input { background-color: #fffacd; }
        .annual-saldo-row { background-color: #e6ffe6; }
        .annual-total-row { background-color: #d4edda !important; color: #155724; font-weight: bold; }
        .editable-cell { cursor: pointer; border-bottom: 1px dashed #007bff; }
        
        /* Gaya untuk Baris KOIN NU (Baris 1-4) */
        .koin-fixed-entry { background-color: #f0fff0; font-weight: normal; }
    </style>
</head>
<body>

    <div class="navbar">
        <span class="navbar-logo">Pembukuan UPZIS</span>
        <div class="navbar-links">
            <a href="#" id="nav-koin" onclick="showModule('koin')">Laporan KOIN NU</a>
            <a href="#" id="nav-jurnal" onclick="showModule('jurnal')">Jurnal Umum</a>
            <a href="#" id="nav-tahunan" onclick="showModule('tahunan')">Laporan Tahunan</a>
        </div>
    </div>

    <div class="container">
        
        <div id="koin-nu-module" style="display: block;">
            <div id="koin-pdf-content">
                <div style="text-align: center; margin-bottom: 10px; padding-bottom: 10px; border-bottom: 3px double #006400;">
                    <h1 style="color: #006400; margin: 0; line-height: 1.2; font-size: 24px;">NU CARE UPZIS - LAZISNU RANTING NGABLAK</h1>
                    <p style="margin: 0; font-size: 14px; color: #555;">Sekretariat: Jalan [Nama Jalan], Desa Ngablak, Kec. [Kecamatan], Kab. [Kabupaten]</p>
                </div>

                <div class="report-header-section">
                    <div class="report-controls">
                        <label for="koin-filter-bulan">Bulan:</label>
                        <select id="koin-filter-bulan" onchange="filterData('koin')"></select>
                        <label for="koin-filter-tahun">Tahun:</label>
                        <select id="koin-filter-tahun" onchange="filterData('koin')"></select>
                    </div>
                    
                    <div class="report-title-center">
                        <p style="font-weight: bold; margin: 0;">Laporan Pemasukan KOIN NU Periode <span id="koin-pdf-periode-display"></span></p>
                    </div>

                    <div class="report-controls">
                        <button class="button btn-red" id="koin-download-btn-header" onclick="downloadPDF('koin')">Unduh PDF</button>
                    </div>
                </div>


                <table id="koin-data-table">
                    <thead>
                        <tr>
                            <th rowspan="2">NO</th>
                            <th rowspan="2">TANGGAL</th>
                            <th rowspan="2">NAMA PETUGAS</th>
                            <th rowspan="2" id="koin-hp-header">NO HP</th> 
                            <th rowspan="2">DONATUR/KELOMPOK</th>
                            <th rowspan="2" id="koin-alamat-header">ALAMAT (RT/RW)</th> 
                            <th rowspan="2" class="money-col">NOMINAL</th> 
                            <th colspan="4" class="koin-pembagian-header">PEMBAGIAN DANA KOIN</th> 
                            <th rowspan="2" id="koin-aksi-header" style="display: none;">Aksi</th>
                        </tr>
                        <tr>
                            <th class="koin-pembagian-header money-col">Petugas (10%)</th> 
                            <th class="koin-pembagian-header money-col">Ranting (60%)</th> 
                            <th class="koin-pembagian-header money-col">MWC (25%)</th> 
                            <th class="koin-pembagian-header money-col">PC (5%)</th> 
                        </tr>
                    </thead>
                    <tbody id="koin-data-body">
                        </tbody>
                    <tfoot>
                        <tr>
                            <td colspan="6" class="total-label" id="koin-total-label">TOTAL PENJUMLAHAN</td>
                            <td id="koin-total-nominal" class="money-col">0</td>
                            <td id="koin-total-petugas" class="money-col koin-pembagian-col">0</td>
                            <td id="koin-total-ranting" class="money-col koin-pembagian-col">0</td>
                            <td id="koin-total-mwc" class="money-col koin-pembagian-col">0</td>
                            <td id="koin-total-pc" class="money-col koin-pembagian-col">0</td>
                            <td id="koin-total-aksi" style="display: none;"></td>
                        </tr>
                    </tfoot>
                </table>
                
                <div id="koin-ttd-date" style="text-align: right; margin-bottom: 15px; display: none;"> Ngablak, <span id="koin-ttd-tanggal-output"></span></div>
                <div id="koin-ttd-area" class="ttd-area"> 
                    <div class="ttd-box"><p>Mengetahui,</p><p>Ketua UPZIS</p><div class="ttd-line"></div><p>(Nama Ketua)</p></div>
                    <div class="ttd-box"><p>Dibuat oleh,</p><p>Bendahara UPZIS</p><div class="ttd-line"></div><p>(Nama Bendahara)</p></div>
                </div>

            </div>
            <div class="form-controls" id="koin-admin-controls" style="display: none; margin-top: 20px;">
                <button class="button btn-red" onclick="deleteAllDataGlobal('koin')">Hapus Semua Data</button> 
                <button class="button btn-blue" onclick="logout()">Log Out</button> 
            </div>
            <div class="input-form" id="koin-input-area" style="display: none;">
                <h3>Input Data Pemasukan Baru (KOIN NU)</h3>
                <div class="form-row">
                    <div><label for="koin-input-tanggal">Tanggal:</label><input type="date" id="koin-input-tanggal" required></div>
                    <div><label for="koin-input-petugas">Nama Petugas:</label><input type="text" id="koin-input-petugas" required></div>
                    <div><label for="koin-input-hp">No. HP Petugas:</label><input type="tel" id="koin-input-hp" required></div>
                </div>
                <div class="form-row">
                    <div><label for="koin-input-donatur">Donatur/Kelompok:</label><input type="text" id="koin-input-donatur" required></div>
                    <div><label for="koin-input-alamat">Alamat (RT/RW):</label><input type="text" id="koin-input-alamat" required></div>
                    <div><label for="koin-input-nominal">Nominal:</label><input type="number" id="koin-input-nominal" required></div>
                </div>
                <div style="text-align: right; margin-top: 10px;">
    		<button class="button btn-green" onclick="saveData('koin')">Simpan Data</button>
		</div>
                <div style="clear: both;"></div> 
            </div>
        </div>
        
        <div id="jurnal-umum-module" style="display: none;">
             <div id="jurnal-pdf-content">
                <div style="text-align: center; margin-bottom: 10px; padding-bottom: 10px; border-bottom: 3px double #006400;">
                    <h1 style="color: #006400; margin: 0; line-height: 1.2; font-size: 24px;">NU CARE UPZIS - LAZISNU RANTING NGABLAK</h1>
                    <p style="margin: 0; font-size: 14px; color: #555;">Sekretariat: Jalan [Nama Jalan], Desa Ngablak, Kec. [Kecamatan], Kab. [Kabupaten]</p>
                </div>

                <div class="report-header-section">
                    <div class="report-controls">
                        <label for="jurnal-filter-bulan">Bulan:</label>
                        <select id="jurnal-filter-bulan" onchange="filterData('jurnal')"></select>
                        <label for="jurnal-filter-tahun">Tahun:</label>
                        <select id="jurnal-filter-tahun" onchange="filterData('jurnal')"></select>
                    </div>
                    
                    <div class="report-title-center">
                        <p style="font-weight: bold; margin: 0;">Jurnal Umum Periode <span id="jurnal-pdf-periode-display"></span></p>
                    </div>

                    <div class="report-controls">
                        <button class="button btn-red" id="jurnal-download-btn-header" onclick="downloadPDF('jurnal')">Unduh PDF</button>
                    </div>
                </div>

                <table id="jurnal-data-table">
                    <thead>
                        <tr>
                            <th>NO</th>
                            <th>TANGGAL</th>
                            <th>KETERANGAN</th>
                            <th>KATEGORI</th>
                            <th class="money-col">DANA MASUK</th> 
                            <th class="money-col">DANA KELUAR</th> 
                            <th class="money-col">SALDO</th> 
                            <th id="jurnal-aksi-header" style="display: none;">Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="jurnal-data-body"></tbody>
                    <tfoot>
                        <tr>
                            <td colspan="4" class="total-label" id="jurnal-total-label">TOTAL</td>
                            <td id="jurnal-total-masuk" class="money-col">0</td>
                            <td id="jurnal-total-keluar" class="money-col">0</td>
                            <td id="jurnal-saldo-akhir" class="total-saldo money-col">0</td>
                            <td id="jurnal-total-aksi" style="display: none;"></td>
                        </tr>
                    </tfoot>
                </table>

                <div id="jurnal-ttd-date" style="text-align: right; margin-bottom: 15px; display: none;"> Ngablak, <span id="jurnal-ttd-tanggal-output"></span></div>
                <div id="jurnal-ttd-area" class="ttd-area"> 
                    <div class="ttd-box"><p>Mengetahui,</p><p>Ketua UPZIS</p><div class="ttd-line"></div><p>(Nama Ketua)</p></div>
                    <div class="ttd-box"><p>Dibuat oleh,</p><p>Bendahara UPZIS</p><div class="ttd-line"></div><p>(Nama Bendahara)</p></div>
                </div>
            </div>

            <div class="form-controls" id="jurnal-admin-controls" style="display: none; margin-top: 20px;">
                <button class="button btn-red" onclick="deleteAllDataGlobal('jurnal')">Hapus Semua Data</button> 
                <button class="button btn-blue" onclick="logout()">Log Out</button> 
            </div>

            <div class="input-form" id="jurnal-input-area" style="display: none;">
                <h3>Input Data Jurnal Umum (Manual)</h3>
                <div class="form-row">
                    <div><label for="jurnal-input-tanggal">Tanggal:</label><input type="date" id="jurnal-input-tanggal" required></div>
                    <div><label for="jurnal-input-keterangan">Keterangan/Uraian:</label><input type="text" id="jurnal-input-keterangan" required></div>
                    <div>
                        <label for="jurnal-input-kategori">Kategori:</label>
                        <select id="jurnal-input-kategori" onchange="updateMasukKeluarFields()" required>
                            <option value="">Pilih Kategori</option>
                            <optgroup label="DANA MASUK">
                                <option value="Koin NU">Koin NU</option>
                                <option value="Donatur">Donatur</option>
                                <option value="Zakat Mall">Zakat Mall</option>
                                <option value="Infaq">Infaq</option>
                                <option value="Shodaqoh">Shodaqoh</option>
                                <option value="Saldo Bulan Lalu">Saldo Bulan Lalu</option>
                                <option value="Hasil Usaha">Hasil Usaha</option>
                            </optgroup>
                            <optgroup label="DANA KELUAR WAJIB">
                                <option value="Untuk Pendidikan">Untuk Pendidikan</option>
                                <option value="Untuk Sosial">Untuk Sosial</option>
                                <option value="Untuk Ekonomi">Untuk Ekonomi</option>
                                <option value="Untuk Kesehatan">Untuk Kesehatan</option>
                                <option value="Subsidi Banom & Lembaga NU">Subsidi Banom & Lembaga NU</option>
                                <option value="Untuk Bencana">Untuk Bencana</option>
                            </optgroup>
                            <optgroup label="DANA KELUAR LAIN-LAIN">
                                <option value="Petugas (10%)">Petugas (10%)</option>
                                <option value="MWC (25%)">MWC (25%)</option>
                                <option value="PC (5%)">PC (5%)</option>
                                <option value="Ranting (60%)">Ranting (60%)</option>
                                <option value="Rapat-rapat">Rapat-rapat</option>
                                <option value="PERWTN MLU">PERWTN MLU</option>
                                <option value="BIAYA REK BANK">BIAYA REK BANK</option>
                                <option value="Lain-lain">Lain-lain (General)</option>
                            </optgroup>
                        </select>
                    </div>
                </div>
                <div class="form-row" style="grid-template-columns: repeat(2, 1fr);">
                    <div><label for="jurnal-input-masuk">Dana Masuk:</label><input type="number" id="jurnal-input-masuk" min="0"></div>
                    <div><label for="jurnal-input-keluar">Dana Keluar:</label><input type="number" id="jurnal-input-keluar" min="0"></div>
                </div>
                 <div style="text-align: right; margin-top: 10px;">
   		 <button class="button btn-green" onclick="saveData('jurnal')">Simpan Data</button>
		 </div>
                <div style="clear: both;"></div> 
            </div>
        </div>
        
        <div id="laporan-tahunan-module" style="display: none;">
             <div id="tahunan-pdf-content">
                <div style="text-align: center; margin-bottom: 10px; padding-bottom: 10px; border-bottom: 3px double #006400;">
                    <h1 style="color: #006400; margin: 0; line-height: 1.2; font-size: 24px;">NU CARE UPZIS - LAZISNU RANTING NGABLAK</h1>
                    <p style="margin: 0; font-size: 14px; color: #555;">Sekretariat: Jalan [Nama Jalan], Desa Ngablak, Kec. [Kecamatan], Kab. [Kabupaten]</p>
                </div>

                <div class="report-header-section">
                    <div class="report-controls">
                        <label for="tahunan-filter-tahun">Tahun Laporan:</label>
                        <select id="tahunan-filter-tahun" onchange="filterData('tahunan')"></select>
                    </div>
                    
                    <div class="report-title-center">
                        <p style="font-weight: bold; margin: 0;">Laporan Tahunan Periode <span id="tahunan-pdf-periode-display"></span></p>
                    </div>

                    <div class="report-controls">
                        <button class="button btn-red" id="tahunan-download-btn-header" onclick="downloadPDF('tahunan')">Unduh PDF</button>
                    </div>
                </div>

                <div style="overflow-x: auto;">
                    <table id="annual-data-table">
                        <thead>
                            <tr>
                                <th rowspan="4" style="width: 1%;">NO (1)</th>
                                <th rowspan="4" style="width: 8%;">BULAN (2)</th>
                                <th colspan="2" class="annual-sub-header">PENERIMAAN</th>
                                <th colspan="12" class="annual-sub-header">PENGELUARAN WAJIB (5)</th>
                                <th colspan="7" class="annual-sub-header">PENGELUARAN LAIN-LAIN (6)</th>
                                <th rowspan="4" class="money-col" style="width: 8%;">JUMLAH PENGELUARAN (7)</th>
                                <th rowspan="4" class="money-col" style="width: 8%;">SALDO AKHIR BULAN INI (8)</th>
                                <th rowspan="4" class="money-col" style="width: 8%;">SALDO KAS TAHUN BERJALAN (9)</th>
                            </tr>
                            <tr>
                                <th rowspan="3" class="money-col" style="width: 8%;">Total Penerimaan Koin (3)</th>
                                <th rowspan="3" style="width: 5%;">Jumlah Donatur (4)</th>
                                
                                <th colspan="2">Pendidikan</th>
                                <th colspan="2">Kesehatan</th>
                                <th colspan="2">Ekonomi</th>
                                <th colspan="2">Sosial</th>
                                <th colspan="2">Subsidi Banom & Lembaga NU</th>
                                <th colspan="2">Bencana</th>
                                
                                <th colspan="3">Honor Wajib</th>
                                <th rowspan="3" class="money-col">Rapat-Rapat</th>
                                <th rowspan="3" class="money-col">PERWTN MLU</th>
                                <th rowspan="3" class="money-col">BIAYA REK BANK</th>
                                <th rowspan="3" class="money-col">Lain - Lain</th>
                            </tr>
                            <tr>
                                <th colspan="8">Rincian Per Bidang (Uang & Penerima)</th>
                                <th colspan="2">Uang & Keterangan</th>
                                <th colspan="2">Uang & Penerima</th>
                                
                                <th class="money-col">Petugas 10%</th>
                                <th class="money-col">MWC 25%</th>
                                <th class="money-col">PC 5%</th>
                            </tr>
                            <tr>
    				<th class="money-col annual-pengeluaran-wajib">Jml Uang</th>
    				<th class="annual-pengeluaran-wajib">Jml Penerima (Manual)</th> 
    				<th class="money-col annual-pengeluaran-wajib">Jml Uang</th>
    				<th class="annual-pengeluaran-wajib">Jml Penerima (Manual)</th>
    				<th class="money-col annual-pengeluaran-wajib">Jml Uang</th>
    				<th class="annual-pengeluaran-wajib">Jml Penerima (Manual)</th>
    				<th class="money-col annual-pengeluaran-wajib">Jml Uang</th>
    				<th class="annual-pengeluaran-wajib">Jml Penerima (Manual)</th>
    				<th class="money-col annual-pengeluaran-wajib">Jml Uang</th>
    				<th class="annual-pengeluaran-wajib">Keterangan (Manual)</th>
    				<th class="money-col annual-pengeluaran-wajib">Jml Uang</th>
    				<th class="annual-pengeluaran-wajib">Jml Penerima (Manual)</th>
    
    				<th class="money-col annual-pengeluaran-lain"></th>
    				<th class="money-col annual-pengeluaran-lain"></th>
    				<th class="money-col annual-pengeluaran-lain"></th>
			   </tr>
                        </thead>
                        <tbody id="annual-data-body"></tbody>
                        <tfoot>
                            <tr class="annual-total-row">
                                <td colspan="2" class="total-label" style="text-align: center;">TOTAL TAHUNAN</td>
                                <td id="tahunan-total-koin" class="money-col">0</td>
                                <td id="tahunan-total-donatur" class="money-col">0</td>
                                
                                <td id="tahunan-total-pend-uang" class="money-col">0</td>
                                <td id="tahunan-total-pend-penerima" style="text-align: center;">-</td>
                                <td id="tahunan-total-kes-uang" class="money-col">0</td>
                                <td id="tahunan-total-kes-penerima" style="text-align: center;">-</td>
                                <td id="tahunan-total-eko-uang" class="money-col">0</td>
                                <td id="tahunan-total-eko-penerima" style="text-align: center;">-</td>
                                <td id="tahunan-total-sosial-uang" class="money-col">0</td>
                                <td id="tahunan-total-sosial-penerima" style="text-align: center;">-</td>
                                <td id="tahunan-total-banom-uang" class="money-col">0</td>
                                <td id="tahunan-total-banom-ket" style="text-align: center;">-</td>
                                <td id="tahunan-total-bencana-uang" class="money-col">0</td>
                                <td id="tahunan-total-bencana-penerima" style="text-align: center;">-</td>

                                <td id="tahunan-total-honor-petugas" class="money-col">0</td>
                                <td id="tahunan-total-honor-mwc" class="money-col">0</td>
                                <td id="tahunan-total-honor-pc" class="money-col">0</td>
                                <td id="tahunan-total-rapat" class="money-col">0</td>
                                <td id="tahunan-total-perwtn-mlu" class="money-col">0</td>
                                <td id="tahunan-total-biaya-rek-bank" class="money-col">0</td>
                                <td id="tahunan-total-lain-lain-peng" class="money-col">0</td>
                                
                                <td id="tahunan-total-pengeluaran" class="money-col">0</td>
                                <td id="tahunan-total-saldo-akhir" class="money-col">0</td>
                                <td id="tahunan-total-saldo-kas" class="money-col">0</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>

                <div id="tahunan-ttd-date" style="text-align: right; margin-bottom: 15px; display: none;"> Ngablak, <span id="tahunan-ttd-tanggal-output"></span></div>
                <div id="tahunan-ttd-area" class="ttd-area"> 
                    <div class="ttd-box"><p>Mengetahui,</p><p>Ketua UPZIS</p><div class="ttd-line"></div><p>(Nama Ketua)</p></div>
                    <div class="ttd-box"><p>Dibuat oleh,</p><p>Bendahara UPZIS</p><div class="ttd-line"></div><p>(Nama Bendahara)</p></div>
                </div>
            </div>
             
            <div class="form-controls" id="tahunan-admin-controls" style="display: none; justify-content: flex-end;">
                <button class="button btn-blue" onclick="logout()">Log Out</button> 
            </div>
            
            <div class="input-form" id="tahunan-edit-input-area" style="display: none;">
                <h3>Edit Data Laporan Tahunan (Baris Khusus)</h3>
                <div class="form-row" style="grid-template-columns: 1fr 1fr 1fr;">
                    <div><label>Baris yang Diedit:</label><input type="text" id="annual-edit-label" disabled></div>
                    <div><label>Nominal/Penerima:</label><input type="number" id="annual-edit-nominal" required></div>
                    <div id="annual-edit-keterangan-group" style="display: none;">
                        <label>Keterangan/Uraian:</label>
                        <input type="text" id="annual-edit-keterangan">
                    </div>
                </div>
                <div style="float: right; margin-top: 10px;">
                    <button class="button btn-green" onclick="saveAnnualReportData()">Simpan Perubahan</button>
                    <button class="button btn-red" onclick="cancelAnnualEdit()">Batal</button>
                </div>
                <div style="clear: both;"></div> 
            </div>

        </div>
        <div id="login-area" style="display: none;">
            <div class="login-box">
                <h2 style="text-align: center; color: #006400;">ADMIN LOGIN</h2>
                <div class="login-input-row">
                    <input type="text" id="username" placeholder="Username">
                    <input type="password" id="password" placeholder="Password">
                </div>
                <button class="button btn-green" style="width: 100%;" onclick="attemptLogin()">Masuk</button>
            </div>
        </div>
        </div>
<script>
        // --- KONSTANTA DAN INISIALISASI ---
        
        // Kunci untuk Local Storage
        const KOIN_KEY = 'upzis_koin_data';
        const JURNAL_KEY = 'upzis_jurnal_data';
        const ANNUAL_KEY = 'upzis_annual_data';

        // Data Dummy Awal (Jika Local Storage Kosong)
        let koinData = [
            { id: 1, tanggal: '2025-01-15', petugas: 'Shodiq', hp: '0813250089797', donatur: 'RT 01', alamat: 'Ngablak RT 1/ RW 1', nominal: 2000000, type: 'manual' },
            { id: 2, tanggal: '2025-01-20', petugas: 'Ahmad', hp: '081234567890', donatur: 'Kelompok Tani', alamat: 'Ngablak RT 2/ RW 1', nominal: 1500000, type: 'manual' },
            { id: 3, tanggal: '2025-02-10', petugas: 'Budi', hp: '081234567890', donatur: 'Ibu-ibu Yasinan', alamat: 'Ngablak RT 3/ RW 2', nominal: 1000000, type: 'manual' },
            // Tambahan data agar ada KOIN NU di Feb 2025
            { id: 4, tanggal: '2025-02-27', petugas: 'Fulan', hp: '081234567891', donatur: 'Jamaah Tahlil', alamat: 'Ngablak RT 4/ RW 2', nominal: 500000, type: 'manual' },
        ];
        
        let jurnalData = [
            // Saldo Akhir Tahun Lalu (Des 2024). ENTRI INI HANYA DIGUNAKAN SEBAGAI BASIS SALDO AWAL TAHUN UNTUK LAPORAN TAHUNAN ATAU FILTER 'SEMUA BULAN'.
            // TIDAK DIGUNAKAN SEBAGAI Saldo Bulan Lalu di filter bulanan (karena diubah jadi manual input per bulan).
            { id: 300, tanggal: '2024-12-31', keterangan: 'Saldo Akhir Tahun Lalu (Basis Saldo Awal 2025)', kategori: 'Saldo Bulan Lalu', masuk: 8000000, keluar: 0, type: 'manual' },
            
            // Jurnal Contoh Pengeluaran Otomatis (Januari 2025)
            { id: 301, tanggal: '2025-01-25', keterangan: 'Bantuan Pendidikan Anak Yatim', kategori: 'Untuk Pendidikan', masuk: 0, keluar: 500000, type: 'manual' },
            { id: 302, tanggal: '2025-01-25', keterangan: 'Pengeluaran Lain-lain', kategori: 'Lain-lain', masuk: 0, keluar: 100000, type: 'manual' }, 

            // Jurnal Contoh Pengeluaran Otomatis (Februari 2025)
            { id: 304, tanggal: '2025-02-15', keterangan: 'Santunan Kesehatan Dhuafa', kategori: 'Untuk Kesehatan', masuk: 0, keluar: 400000, type: 'manual' },
            { id: 305, tanggal: '2025-02-20', keterangan: 'Biaya Rapat Bulanan', kategori: 'Rapat-rapat', masuk: 0, keluar: 150000, type: 'manual' },
        ];
        
        let annualData = [
            // Saldo Awal 2025 (Nilai Manual di Laporan Tahunan)
            { id: 'saldo_bank_2025', type: 'saldo_bank', year: 2025, nominal: 8000000 }, 
            { id: 'saldo_kas_2025', type: 'saldo_kas', year: 2025, nominal: 4000000 }, 
            
            // CONTOH SALDO BULAN LALU MANUAL (Januari 2025)
            { type: 'saldo_bulan_lalu_manual', year: 2025, month: 1, nominal: 3000000 }, // Contoh Saldo Awal Jan
            { type: 'saldo_bulan_lalu_manual', year: 2025, month: 2, nominal: 3400000 }, // Contoh Saldo Awal Feb

            // Monthly Manual Data (Contoh Jan 2025)
            { 
                type: 'monthly', 
                year: 2025, 
                month: 1, 
                donatur: 50, 
                pendidikan: { penerima: 5 }, 
                sosial: { penerima: 0 }, 
                kesehatan: { penerima: 0 }, 
                ekonomi: { penerima: 0 }, 
                banom: { keterangan: '' }, 
                bencana: { penerima: 0 }, 
            }, 
            // Monthly Manual Data (Contoh Feb 2025)
            { 
                type: 'monthly', 
                year: 2025, 
                month: 2, 
                donatur: 30, 
                pendidikan: { penerima: 0 }, 
                sosial: { penerima: 0 }, 
                kesehatan: { penerima: 1 }, 
                ekonomi: { penerima: 0 }, 
                banom: { keterangan: '' }, 
                bencana: { penerima: 0 }, 
            },
        ];
        
        let isLoggedIn = false;
        let koinEditId = null;
        let jurnalEditId = null;
        let annualEditData = null; // Menyimpan data yang sedang diedit di Laporan Tahunan
        let annualEditId = null; 
        let annualEditKey = null; 
        let annualEditType = null; 
        let currentModule = 'koin';
        
        const namaBulan = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];
        
        const categories = {
            // PENGELUARAN WAJIB
            pendidikan: 'Untuk Pendidikan',
            sosial: 'Untuk Sosial',
            kesehatan: 'Untuk Kesehatan',
            ekonomi: 'Untuk Ekonomi',
            banom: 'Subsidi Banom & Lembaga NU',
            bencana: 'Untuk Bencana',

            // PENGELUARAN LAIN-LAIN
            honor_petugas: 'Petugas (10%)',
            honor_mwc: 'MWC (25%)',
            honor_pc: 'PC (5%)',
            ranting_60: 'Ranting (60%)',
            rapat: 'Rapat-rapat',
            perwtn_mlu: 'PERWTN MLU',
            biaya_rek: 'BIAYA REK BANK',
            lain_lain_peng: 'Lain-lain',

            // DANA MASUK
            koin_nu: 'Koin NU',
            donatur: 'Donatur',
            zakat_mall: 'Zakat Mall',
            infaq: 'Infaq',
            shodaqoh: 'Shodaqoh',
            saldo_bln_lalu: 'Saldo Bulan Lalu',
            hasil_usaha: 'Hasil Usaha',
            saldo_bank: 'SALDO KAS BANK (Awal Tahun)',
            saldo_kas: 'SALDO KAS TUNAI (Awal Tahun)',
        };

        // --- FUNGSI UTILITY ---
        function formatRupiah(angka) {
            if (angka === undefined || angka === null) return 'Rp 0';
            let reverse = angka.toString().split('').reverse().join('');
            let ribuan = reverse.match(/\d{1,3}/g);
            let rupiah = ribuan.join('.').split('').reverse().join('');
            return 'Rp ' + rupiah;
        }

        function formatTanggalTTD() {
            const today = new Date();
            const day = today.getDate();
            const monthName = namaBulan[today.getMonth()];
            const year = today.getFullYear();
            return `${day} ${monthName} ${year}`;
        }
        
        function loadDataFromStorage(key, defaultData) {
            const data = localStorage.getItem(key);
            if (data) {
                try {
                    return JSON.parse(data);
                } catch (e) {
                    console.error('Gagal parsing data dari Local Storage:', key, e);
                    return defaultData;
                }
            }
            return defaultData;
        }
        
        function saveDataToStorage(key, data) {
            localStorage.setItem(key, JSON.stringify(data));
        }
        
        // --- FUNGSI LOGIC KOIN NU ---
        function calculateKoinTotals(month, year) {
            const monthStr = month.toString().padStart(2, '0');
            const filteredData = koinData.filter(d => {
                const dataDate = new Date(d.tanggal + 'T00:00:00');
                const dataMonth = (dataDate.getMonth() + 1).toString().padStart(2, '0');
                const dataYear = dataDate.getFullYear().toString();
                // Filter berdasarkan bulan dan tahun, atau jika bulan adalah 'all'
                return (month === 'all' || dataMonth === monthStr) && dataYear === year;
            });

            const totalNominal = filteredData.reduce((sum, d) => sum + d.nominal, 0);

            // Pembagian Dana Koin (10% Petugas, 60% Ranting, 25% MWC, 5% PC)
            const petugas = Math.round(totalNominal * 0.10);
            const ranting = Math.round(totalNominal * 0.60);
            const mwc = Math.round(totalNominal * 0.25);
            const pc = Math.round(totalNominal * 0.05);

            // Sisa untuk memastikan total nominal tetap sama
            const totalPembagian = petugas + ranting + mwc + pc;
            const selisih = totalNominal - totalPembagian; 
            // Tambahkan selisih ke Ranting agar pembagian genap
            const rantingFixed = ranting + selisih; 

            return {
                data: filteredData,
                totalNominal: totalNominal,
                petugas: petugas,
                ranting: rantingFixed,
                mwc: mwc,
                pc: pc
            };
        }

        // --- FUNGSI RENDER TABEL ---
        function renderKoinTable(data, total) {
            const tableBody = document.getElementById('koin-data-body');
            tableBody.innerHTML = '';
            
            if (data.length === 0) {
                const row = tableBody.insertRow();
                row.innerHTML = `<td colspan="11" style="text-align: center; font-style: italic;">Tidak ada data Koin NU untuk periode ini.</td>`;
            }

            data.forEach((d, index) => {
                const row = tableBody.insertRow();
                const nominal = d.nominal;
                const petugas = Math.round(nominal * 0.10);
                const ranting = Math.round(nominal * 0.60);
                const mwc = Math.round(nominal * 0.25);
                const pc = Math.round(nominal * 0.05);
                
                const totalPembagian = petugas + ranting + mwc + pc;
                const selisih = nominal - totalPembagian;
                const rantingFixed = ranting + selisih;

                const actionCells = isLoggedIn ? `<td class="action-btns" id="koin-aksi-${d.id}">
                    <button class="button btn-blue" onclick="editData('koin', ${d.id})">Edit</button>
                    <button class="button btn-red" onclick="deleteData('koin', ${d.id})">Hapus</button>
                </td>` : '';
                
                const datePart = d.tanggal.split('-'); // YYYY-MM-DD
                const formattedDate = `${datePart[2]}-${datePart[1]}-${datePart[0]}`;

                row.innerHTML = `
                    <td style="text-align: center;">${index + 1}</td>
                    <td>${formattedDate}</td>
                    <td>${d.petugas}</td>
                    <td id="koin-hp-col">${d.hp || '-'}</td>
                    <td>${d.donatur}</td>
                    <td id="koin-alamat-col">${d.alamat || '-'}</td>
                    <td class="money-col">${formatRupiah(nominal)}</td>
                    <td class="money-col koin-pembagian-col">${formatRupiah(petugas)}</td>
                    <td class="money-col koin-pembagian-col">${formatRupiah(rantingFixed)}</td>
                    <td class="money-col koin-pembagian-col">${formatRupiah(mwc)}</td>
                    <td class="money-col koin-pembagian-col">${formatRupiah(pc)}</td>
                    ${actionCells}
                `;
            });
            
            // Render Total
            document.getElementById('koin-total-nominal').textContent = formatRupiah(total.totalNominal);
            document.getElementById('koin-total-petugas').textContent = formatRupiah(total.petugas);
            document.getElementById('koin-total-ranting').textContent = formatRupiah(total.ranting);
            document.getElementById('koin-total-mwc').textContent = formatRupiah(total.mwc);
            document.getElementById('koin-total-pc').textContent = formatRupiah(total.pc);
            
            // Atur tampilan Kolom Aksi
            document.getElementById('koin-aksi-header').style.display = isLoggedIn ? 'table-cell' : 'none';
            document.getElementById('koin-total-aksi').style.display = isLoggedIn ? 'table-cell' : 'none';
        }

        // --- FUNGSI LOGIC JURNAL UMUM ---
        function calculateJurnalData(month, year) {
            const monthStr = month.toString().padStart(2, '0');
            
            // 1. Ambil data KOIN NU yang sudah dihitung untuk bulan ini
            const koinTotals = calculateKoinTotals(month, year);
            const koinIncome = koinTotals.ranting; // 60% yang masuk ke Kas UPZIS

            // 2. Buat entri Jurnal Otomatis dari KOIN
            let autoEntries = [];
            let entryIdCounter = 10000;
            const firstDay = `${year}-${monthStr}-01`; 

            // 2.1 DANA MASUK (RANTING 60% yang masuk ke Kas)
            if (koinIncome > 0) {
                 autoEntries.push({
                    id: `auto-koin-${monthStr}-${year}-${entryIdCounter++}`,
                    tanggal: firstDay,
                    keterangan: `Penerimaan Kas (60%) dari Dana KOIN NU`,
                    kategori: categories.ranting_60,
                    masuk: koinIncome,
                    keluar: 0,
                    type: 'auto'
                });
            }

            // 2.2 DANA KELUAR (PETUGAS 10%)
            if (koinTotals.petugas > 0) {
                 autoEntries.push({
                    id: `auto-koin-${monthStr}-${year}-${entryIdCounter++}`,
                    tanggal: firstDay,
                    keterangan: `Pembagian Honor Petugas (10%) dari Dana KOIN NU`,
                    kategori: categories.honor_petugas,
                    masuk: 0,
                    keluar: koinTotals.petugas,
                    type: 'auto'
                });
            }
            
            // 2.3 DANA KELUAR (MWC 25%)
            if (koinTotals.mwc > 0) {
                 autoEntries.push({
                    id: `auto-koin-${monthStr}-${year}-${entryIdCounter++}`,
                    tanggal: firstDay,
                    keterangan: `Pembagian MWC (25%) dari Dana KOIN NU`,
                    kategori: categories.honor_mwc,
                    masuk: 0,
                    keluar: koinTotals.mwc,
                    type: 'auto'
                });
            }

            // 2.4 DANA KELUAR (PC 5%)
            if (koinTotals.pc > 0) {
                 autoEntries.push({
                    id: `auto-koin-${monthStr}-${year}-${entryIdCounter++}`,
                    tanggal: firstDay,
                    keterangan: `Pembagian PC (5%) dari Dana KOIN NU`,
                    kategori: categories.honor_pc,
                    masuk: 0,
                    keluar: koinTotals.pc,
                    type: 'auto'
                });
            }

            // 3. Ambil entri manual Jurnal Umum untuk bulan ini
            const manualEntries = jurnalData.filter(d => {
                const dataDate = new Date(d.tanggal + 'T00:00:00');
                const dataMonth = (dataDate.getMonth() + 1).toString().padStart(2, '0');
                const dataYear = dataDate.getFullYear().toString();
                return dataMonth === monthStr && dataYear === year;
            });
            
            // Gabungkan entri manual dan otomatis
            let allEntries = [...manualEntries, ...autoEntries];
            
            // Urutkan berdasarkan tanggal
            allEntries.sort((a, b) => {
                if (a.tanggal < b.tanggal) return -1;
                if (a.tanggal > b.tanggal) return 1;
                return 0;
            });
            
            // 4. Hitung Saldo Awal (hanya jika bulan tidak 'all')
            let saldoAwal = 0;
            
            if (month !== 'all') {
                 // Cari entri saldo bulan lalu dari annualData (manual input Saldo Bulan Lalu)
                 const saldoManual = annualData.find(d => 
                    d.type === 'saldo_bulan_lalu_manual' && 
                    d.year == parseInt(year) && 
                    d.month == parseInt(month)
                 );
                 
                 if (saldoManual) {
                     saldoAwal = saldoManual.nominal || 0;
                 } else {
                     // Jika tidak ada input manual untuk saldo bulan lalu, gunakan Saldo Awal Tahun
                     if (parseInt(month) === 1) {
                        const saldoBank = annualData.find(d => d.id === `saldo_bank_${year}`) || { nominal: 0 };
                        const saldoKas = annualData.find(d => d.id === `saldo_kas_${year}`) || { nominal: 0 };
                        saldoAwal = saldoBank.nominal + saldoKas.nominal;
                     }
                 }
            } else {
                 // Jika "Semua Bulan" dipilih, hitung saldo awal dari saldo akhir tahun lalu (id 300)
                 const saldoAkhirTahunLalu = jurnalData.find(d => 
                    d.id === 300 
                    // TANGGAL TIDAK RELEVAN DI SINI KARENA JURNAL UMUM HANYA MENAMPILKAN TRANSAKSI
                 );
                 if (saldoAkhirTahunLalu && parseInt(year) === 2025) { // Hanya berlaku untuk tahun 2025 sebagai contoh
                     saldoAwal = saldoAkhirTahunLalu.masuk || 0;
                 }
            }
            
            let runningSaldo = saldoAwal;
            let totalMasuk = 0;
            let totalKeluar = 0;
            
            const dataToRender = [];
            
            // 5. Hitung saldo untuk setiap transaksi
            allEntries.forEach((d) => {
                totalMasuk += d.masuk || 0;
                totalKeluar += d.keluar || 0;
                runningSaldo += (d.masuk || 0) - (d.keluar || 0);
                
                dataToRender.push({
                    ...d,
                    runningSaldo: runningSaldo,
                });
            });

            return {
                data: dataToRender,
                saldoAwal: saldoAwal,
                totalMasuk: totalMasuk,
                totalKeluar: totalKeluar,
                saldoAkhir: runningSaldo,
            };
        }

        function renderJurnalTable(data, total, month, year) {
            const tableBody = document.getElementById('jurnal-data-body');
            tableBody.innerHTML = '';
            
            // 1. Tampilkan baris Saldo Awal (kecuali filter 'Semua Bulan')
            if (month !== 'all' && total.saldoAwal > 0) {
                 const row = tableBody.insertRow();
                 row.classList.add('saldo-entry');
                 
                 const monthStr = month.toString().padStart(2, '0');
                 const tanggalDisplay = parseInt(month) === 1 ? '01' : '31';
                 const idSaldo = `saldo-bulan-lalu-edit`;
                 
                 let actionCell = `<td class="action-btns" id="jurnal-aksi-${idSaldo}">
                     <button class="button btn-blue" onclick="editData('jurnal', '${idSaldo}', '${monthStr}', '${year}', ${total.saldoAwal})">Edit Nilai</button>
                 </td>`;
                 
                 row.innerHTML = `
                     <td style="text-align: center;">-</td>
                     <td>${tanggalDisplay}-${monthStr}-${year}</td>
                     <td>Saldo Awal Bulan (Berasal dari Input Laporan Tahunan)</td>
                     <td>${categories.saldo_bln_lalu}</td>
                     <td class="money-col">${formatRupiah(total.saldoAwal)}</td>
                     <td class="money-col">0</td>
                     <td class="money-col">${formatRupiah(total.saldoAwal)}</td>
                     ${isLoggedIn ? actionCell : ''}
                 `;
            }

            let currentRunningSaldo = total.saldoAwal;
            
            if (data.length === 0 && total.saldoAwal === 0) {
                const row = tableBody.insertRow();
                row.innerHTML = `<td colspan="8" style="text-align: center; font-style: italic;">Tidak ada data Jurnal Umum untuk periode ini.</td>`;
            }

            data.forEach((d, index) => {
                const row = tableBody.insertRow();
                const typeClass = d.type === 'auto' ? 'auto-entry' : 'manual-entry';
                row.classList.add(typeClass);
                
                currentRunningSaldo += (d.masuk || 0) - (d.keluar || 0);
                
                const actionCells = isLoggedIn ? `<td class="action-btns" id="jurnal-aksi-${d.id}">
                    ${d.type === 'manual' ? 
                        `<button class="button btn-blue" onclick="editData('jurnal', '${d.id}')">Edit</button>
                         <button class="button btn-red" onclick="deleteData('jurnal', '${d.id}')">Hapus</button>` : 
                        '<span style="font-style: italic;">Auto</span>'}
                </td>` : '';
                
                const datePart = d.tanggal.split('-'); // YYYY-MM-DD
                const formattedDate = `${datePart[2]}-${datePart[1]}-${datePart[0]}`;

                row.innerHTML = `
                    <td style="text-align: center;">${index + 1}</td>
                    <td>${formattedDate}</td>
                    <td>${d.keterangan}</td>
                    <td>${d.kategori}</td>
                    <td class="money-col">${formatRupiah(d.masuk)}</td>
                    <td class="money-col">${formatRupiah(d.keluar)}</td>
                    <td class="money-col">${formatRupiah(currentRunningSaldo)}</td>
                    ${actionCells}
                `;
            });
            
            // Render Total
            document.getElementById('jurnal-total-masuk').textContent = formatRupiah(total.totalMasuk);
            document.getElementById('jurnal-total-keluar').textContent = formatRupiah(total.totalKeluar);
            document.getElementById('jurnal-saldo-akhir').textContent = formatRupiah(total.saldoAkhir);
            
            // Atur tampilan Kolom Aksi
            document.getElementById('jurnal-aksi-header').style.display = isLoggedIn ? 'table-cell' : 'none';
            document.getElementById('jurnal-total-aksi').style.display = isLoggedIn ? 'table-cell' : 'none';
        }

        // 4c. Helper function to get expense from Jurnal Umum
        function calculateJurnalExpense(category, month, year) {
            const monthStr = month.toString().padStart(2, '0');
            const filtered = jurnalData.filter(d => {
                if (d.kategori !== category) return false;
                const dataDate = new Date(d.tanggal + 'T00:00:00');
                const dataMonth = (dataDate.getMonth() + 1).toString().padStart(2, '0');
                const dataYear = dataDate.getFullYear().toString();
                return dataMonth === monthStr && dataYear === year;
            });
            return filtered.reduce((sum, d) => sum + d.keluar, 0);
        }

        // 5. Populate Filter Options
        function populateFilterOptions() {
            const today = new Date();
            const currentYear = today.getFullYear();
            const maxYear = currentYear + 2;
            const minYear = 2024;

            const monthSelects = ['koin-filter-bulan', 'jurnal-filter-bulan'];
            const yearSelects = ['koin-filter-tahun', 'jurnal-filter-tahun', 'tahunan-filter-tahun'];

            // Populate Months
            monthSelects.forEach(id => {
                const select = document.getElementById(id);
                select.innerHTML = '<option value="all">Semua Bulan</option>';
                for (let i = 0; i < namaBulan.length; i++) {
                    const monthValue = (i + 1).toString().padStart(2, '0');
                    select.innerHTML += `<option value="${monthValue}">${namaBulan[i]}</option>`;
                }
                // Set default to current month
                const currentMonthValue = (today.getMonth() + 1).toString().padStart(2, '0');
                select.value = currentMonthValue;
            });

            // Populate Years
            yearSelects.forEach(id => {
                const select = document.getElementById(id);
                select.innerHTML = '';
                for (let year = maxYear; year >= minYear; year--) {
                    select.innerHTML += `<option value="${year}">${year}</option>`;
                }
                select.value = currentYear;
            });
        }

        // 6. Filter and Render Data
        function filterData(module) {
            let selectedMonth, selectedYear, displayId, ttdId;

            if (module === 'koin') {
                selectedMonth = document.getElementById('koin-filter-bulan').value;
                selectedYear = document.getElementById('koin-filter-tahun').value;
                displayId = 'koin-pdf-periode-display';
                ttdId = 'koin-ttd-tanggal-output';
                
                const koinTotals = calculateKoinTotals(selectedMonth, selectedYear);
                renderKoinTable(koinTotals.data, koinTotals);
                
                if (selectedMonth === 'all') {
                    document.getElementById(displayId).textContent = `Tahun ${selectedYear}`;
                } else {
                    document.getElementById(displayId).textContent = `${namaBulan[parseInt(selectedMonth) - 1]} ${selectedYear}`;
                }

            } else if (module === 'jurnal') {
                selectedMonth = document.getElementById('jurnal-filter-bulan').value;
                selectedYear = document.getElementById('jurnal-filter-tahun').value;
                displayId = 'jurnal-pdf-periode-display';
                ttdId = 'jurnal-ttd-tanggal-output';

                const jurnalResults = calculateJurnalData(selectedMonth, selectedYear);
                renderJurnalTable(jurnalResults.data, jurnalResults, selectedMonth, selectedYear);
                
                if (selectedMonth === 'all') {
                    document.getElementById(displayId).textContent = `Tahun ${selectedYear}`;
                } else {
                    document.getElementById(displayId).textContent = `${namaBulan[parseInt(selectedMonth) - 1]} ${selectedYear}`;
                }
                
            } else if (module === 'tahunan') {
                selectedYear = document.getElementById('tahunan-filter-tahun').value;
                displayId = 'tahunan-pdf-periode-display';
                ttdId = 'tahunan-ttd-tanggal-output';
                
                document.getElementById(displayId).textContent = `Tahun ${selectedYear}`;

                const annualDataFinal = generateAnnualReportData(selectedYear);
                renderAnnualReportTable(annualDataFinal, selectedYear);
            }

            document.getElementById(ttdId).textContent = formatTanggalTTD();
        }

        // --- CRUD DAN INPUT BARU ---
        function resetForm(module) {
            if (module === 'koin') {
                document.getElementById('koin-input-tanggal').value = '';
                document.getElementById('koin-input-petugas').value = '';
                document.getElementById('koin-input-hp').value = '';
                document.getElementById('koin-input-donatur').value = '';
                document.getElementById('koin-input-alamat').value = '';
                document.getElementById('koin-input-nominal').value = '';
                koinEditId = null;
            } else if (module === 'jurnal') {
                document.getElementById('jurnal-input-tanggal').value = '';
                document.getElementById('jurnal-input-keterangan').value = '';
                document.getElementById('jurnal-input-kategori').value = '';
                document.getElementById('jurnal-input-masuk').value = '';
                document.getElementById('jurnal-input-keluar').value = '';
                jurnalEditId = null;
                updateMasukKeluarFields(); // Reset field state
            }
        }

        window.saveData = async function(module) { // Di-override di script module
            if (!isLoggedIn) { alert('Anda harus login sebagai admin untuk melakukan aksi ini.'); return; }
            let dataArray;
            let dataKey;
            let newData = {};
            let isEditing = false;

            if (module === 'koin') {
                const tanggal = document.getElementById('koin-input-tanggal').value;
                const petugas = document.getElementById('koin-input-petugas').value;
                const hp = document.getElementById('koin-input-hp').value;
                const donatur = document.getElementById('koin-input-donatur').value;
                const alamat = document.getElementById('koin-input-alamat').value;
                const nominal = parseInt(document.getElementById('koin-input-nominal').value) || 0;
                
                if (!tanggal || !petugas || !donatur || nominal <= 0) {
                    alert('Mohon lengkapi semua data Koin NU yang diperlukan.');
                    return;
                }

                if (koinEditId !== null) {
                    isEditing = true;
                    newData = koinData.find(d => d.id === koinEditId);
                } else {
                    const maxId = koinData.length > 0 ? Math.max(...koinData.map(d => d.id)) : 0;
                    newData.id = maxId + 1;
                }

                newData.tanggal = tanggal;
                newData.petugas = petugas;
                newData.hp = hp;
                newData.donatur = donatur;
                newData.alamat = alamat;
                newData.nominal = nominal;
                newData.type = 'manual';
                
                dataArray = koinData;
                dataKey = KOIN_KEY;

                if (!isEditing) {
                    dataArray.push(newData);
                }
                
                resetForm('koin');

            } else if (module === 'jurnal') {
                const tanggal = document.getElementById('jurnal-input-tanggal').value;
                const keterangan = document.getElementById('jurnal-input-keterangan').value;
                const kategori = document.getElementById('jurnal-input-kategori').value;
                const masuk = parseInt(document.getElementById('jurnal-input-masuk').value) || 0;
                const keluar = parseInt(document.getElementById('jurnal-input-keluar').value) || 0;
                
                if (!tanggal || !keterangan || !kategori || (masuk <= 0 && keluar <= 0)) {
                    alert('Mohon lengkapi semua data Jurnal Umum yang diperlukan.');
                    return;
                }

                if (jurnalEditId !== null) {
                    isEditing = true;
                    // FIX: Gunakan perbandingan longgar (==) karena jurnalEditId adalah string dari tombol,
                    // sedangkan d.id bisa berupa number.
                    newData = jurnalData.find(d => d.id == jurnalEditId); 
                } else {
                    // Pastikan ID tidak bentrok dengan ID dummy Saldo Awal (300)
                    const existingIds = jurnalData.map(d => typeof d.id === 'number' ? d.id : 0);
                    const maxId = existingIds.length > 0 ? Math.max(...existingIds) : 0;
                    const newId = maxId >= 300 ? maxId + 1 : 301;
                    newData.id = newId;
                }

                newData.tanggal = tanggal;
                newData.keterangan = keterangan;
                newData.kategori = kategori;
                newData.masuk = masuk;
                newData.keluar = keluar;
                newData.type = 'manual';
                
                dataArray = jurnalData;
                dataKey = JURNAL_KEY;

                if (!isEditing) {
                    dataArray.push(newData);
                }
                resetForm('jurnal');
            }

            saveDataToStorage(dataKey, dataArray);
            alert(`Data ${module.toUpperCase()} berhasil ${isEditing ? 'diperbarui' : 'disimpan'}!`);
            filterData(module);
        }

        window.editData = async function(module, id, month = null, year = null, currentValue = null) { // Di-override di script module
            if (!isLoggedIn) { alert('Anda harus login sebagai admin untuk melakukan aksi ini.'); return; }
            let dataToEdit;

            if (module === 'koin') {
                dataToEdit = koinData.find(d => d.id === id);
                if (!dataToEdit) return;

                document.getElementById('koin-input-tanggal').value = dataToEdit.tanggal;
                document.getElementById('koin-input-petugas').value = dataToEdit.petugas;
                document.getElementById('koin-input-hp').value = dataToEdit.hp;
                document.getElementById('koin-input-donatur').value = dataToEdit.donatur;
                document.getElementById('koin-input-alamat').value = dataToEdit.alamat;
                document.getElementById('koin-input-nominal').value = dataToEdit.nominal;
                koinEditId = id;

            } else if (module === 'jurnal') {
                // handle saldo-bulan-lalu-edit special case (tetap dijalankan untuk tampilan jika firebase script gagal)
                if (id === 'saldo-bulan-lalu-edit') {
                    if (!month || !year) return alert('Data bulan/tahun tidak ditemukan.');
                    const newSaldo = prompt(`Edit Saldo Bulan Lalu untuk ${month}/${year}:`, currentValue);
                    if (newSaldo !== null && !isNaN(newSaldo) && newSaldo.trim() !== '') {
                        const newSaldoNum = parseInt(newSaldo);
                        // find if exists in annualData with type 'saldo_bulan_lalu_manual'
                        let target = annualData.find(d => d.type === 'saldo_bulan_lalu_manual' && d.year === parseInt(year) && d.month === parseInt(month));
                        
                        if (target) { 
                            target.nominal = newSaldoNum;
                        } else {
                            // tambahkan data baru jika belum ada
                            annualData.push({ type: 'saldo_bulan_lalu_manual', year: parseInt(year), month: parseInt(month), nominal: newSaldoNum });
                        }
                        
                        saveDataToStorage(ANNUAL_KEY, annualData);
                        alert('Saldo Bulan Lalu berhasil diperbarui (Local Storage).');
                        filterData('jurnal');
                    }
                    return;
                }
                
                // FIX: Gunakan perbandingan longgar (==) untuk mengatasi perbedaan tipe data (number vs string)
                dataToEdit = jurnalData.find(d => d.id == id && d.type === 'manual');
                
                if (!dataToEdit) {
                    alert("Data tidak ditemukan atau bukan entri manual yang bisa diedit.");
                    return;
                }

                document.getElementById('jurnal-input-tanggal').value = dataToEdit.tanggal;
                document.getElementById('jurnal-input-keterangan').value = dataToEdit.keterangan;
                document.getElementById('jurnal-input-kategori').value = dataToEdit.kategori;
                document.getElementById('jurnal-input-masuk').value = dataToEdit.masuk;
                document.getElementById('jurnal-input-keluar').value = dataToEdit.keluar;
                jurnalEditId = id;
                updateMasukKeluarFields(); // Update status Masuk/Keluar fields
            }

            // Scroll to form after filling data
            const inputArea = document.getElementById(`${module}-input-area`);
            if (inputArea) {
                inputArea.scrollIntoView({ behavior: 'smooth' });
            }
        }
        
        window.deleteData = async function(module, id) { // Di-override di script module
            if (!isLoggedIn) { alert('Anda harus login sebagai admin untuk melakukan aksi ini.'); return; }
            
            if (module === 'jurnal') {
                // FIX: Gunakan perbandingan longgar (==) untuk mengatasi perbedaan tipe data (number vs string)
                const dataToDelete = jurnalData.find(d => d.id == id);
                if (dataToDelete && dataToDelete.kategori === categories.saldo_bln_lalu) {
                    alert("Entri Saldo Akhir Tahun Lalu (Basis Saldo Awal) tidak dapat dihapus, hanya dapat diedit nilai nominalnya melalui Laporan Tahunan.");
                    return;
                }
            }

            if (!confirm("Yakin ingin menghapus data ini?")) return;

            if (module === 'koin') {
                koinData = koinData.filter(d => d.id !== id);
                saveDataToStorage(KOIN_KEY, koinData);
            } else if (module === 'jurnal') {
                // FIX: Gunakan perbandingan longgar (!=) untuk mengatasi perbedaan tipe data (number vs string)
                jurnalData = jurnalData.filter(d => d.id != id); 
                saveDataToStorage(JURNAL_KEY, jurnalData);
            }
            
            alert(`Data ${module.toUpperCase()} berhasil dihapus.`);
            filterData(module);
        }
        
        window.deleteAllDataGlobal = async function(module) { // Di-override di script module
            if (!isLoggedIn) { alert('Anda harus login sebagai admin untuk melakukan aksi ini.'); return; }
            if (!confirm('Yakin ingin menghapus SEMUA DATA pada modul ini? Tindakan ini tidak bisa dibatalkan.')) return;
            
            if (module === 'koin') {
                koinData = [];
                saveDataToStorage(KOIN_KEY, koinData);
            } else if (module === 'jurnal') {
                jurnalData = [];
                saveDataToStorage(JURNAL_KEY, jurnalData);
            }
            
            alert('Semua data dihapus (Local Storage).');
            filterData(module);
        }

        // --- AUTHENTIKASI ---
        window.attemptLogin = async function() { // Di-override di script module
            alert('Fungsi login sedang di-override oleh Firebase.');
        }

        window.logout = async function() { // Di-override di script module
            isLoggedIn = false;
            localStorage.removeItem('upzis_is_admin_logged_in'); // Hapus status login local storage
            showModule(currentModule);
            alert('Anda telah Log Out.');
        }

        // --- PENGATURAN TAMPILAN MODUL ---
        function showModule(moduleName) {
            currentModule = moduleName;
            const modules = ['koin-nu-module', 'jurnal-umum-module', 'laporan-tahunan-module'];
            modules.forEach(id => document.getElementById(id).style.display = 'none');
            
            const navLinks = ['nav-koin', 'nav-jurnal', 'nav-tahunan'];
            navLinks.forEach(id => document.getElementById(id).classList.remove('active'));

            if (moduleName === 'koin') {
                document.getElementById('koin-nu-module').style.display = 'block';
                document.getElementById('nav-koin').classList.add('active');
            } else if (moduleName === 'jurnal') {
                document.getElementById('jurnal-umum-module').style.display = 'block';
                document.getElementById('nav-jurnal').classList.add('active');
            } else if (moduleName === 'tahunan') {
                document.getElementById('laporan-tahunan-module').style.display = 'block';
                document.getElementById('nav-tahunan').classList.add('active');
                cancelAnnualEdit();
            }

            // Atur tampilan login/admin controls
            document.getElementById('login-area').style.display = isLoggedIn ? 'none' : 'block';
            
            const controls = document.getElementById(`${moduleName}-admin-controls`);
            const inputArea = document.getElementById(`${moduleName}-input-area`);
            
            if (controls) controls.style.display = isLoggedIn ? 'flex' : 'none';
            if (inputArea) inputArea.style.display = isLoggedIn ? 'block' : 'none';
            
            resetForm(moduleName);
            filterData(moduleName);
        }

        // --- ANNUAL REPORT EDITING ---
        window.editAnnualData = function(id, key, currentValue, isText = false) {
            if (!isLoggedIn) {
                alert('Anda harus login sebagai admin untuk melakukan aksi ini.');
                return;
            }
        
            // 1. Mencari data target di annualData
            let targetData = annualData.find(d => d.id === id); 
        
            // Jika targetData tidak ditemukan (walaupun sudah ada fix di generateAnnualReportData), coba cari ulang
            if (!targetData) {
                 // Coba cari tahun dari ID (saldo_bank_YYYY)
                const yearMatch = id.match(/\d{4}$/);
                const targetYear = yearMatch ? yearMatch[0] : new Date().getFullYear().toString();
                
                // Coba generate ulang data tahunan untuk memastikan placeholder Saldo Awal terbuat
                generateAnnualReportData(targetYear);
                targetData = annualData.find(d => d.id === id);
                
                if (!targetData) {
                    alert("Data tidak ditemukan."); 
                    return;
                }
            }
        
            // 2. Mengatur elemen form edit
            const inputArea = document.getElementById('tahunan-edit-input-area');
            const annualEditLabel = document.getElementById('annual-edit-label');
            const annualEditNominal = document.getElementById('annual-edit-nominal');
            const annualEditKeteranganGroup = document.getElementById('annual-edit-keterangan-group');
            const annualEditKeterangan = document.getElementById('annual-edit-keterangan');
        
            // Reset default state
            annualEditKeteranganGroup.style.display = 'none';
            annualEditNominal.setAttribute('type', 'number'); // Pastikan nominal terlihat dan type number
        
            // Menentukan label baris yang diedit (FIX untuk masalah Baris 1 & 2)
            let labelDisplay = '';
            let nominalValue = 0;
            
            // Logika Khusus untuk Saldo Awal (Baris 1 & 2, diidentifikasi dari ID yang dimulai dengan 'saldo_')
            if (id.startsWith('saldo_')) {
                const isBank = id.startsWith('saldo_bank_');
                // FIX: Menampilkan label baris yang benar
                labelDisplay = (isBank ? 'SALDO KAS BANK (Awal Tahun)' : 'SALDO KAS TUNAI (Awal Tahun)') + ' | Kolom: Nominal';
                
                // Ambil nilai nominal dari currentValue yang dilewatkan dari sel
                nominalValue = currentValue || 0; 
                
            } else {
                // Logika untuk data bulanan/monthly (non-saldo)
                const idParts = id.split('_'); // format: monthly_YYYY_MM
                const monthIndex = parseInt(idParts[2], 10) - 1;
                const monthName = namaBulan[monthIndex] || 'Data Bulanan';
                
                // Asumsi key yang diklik sudah mencerminkan nama kolom
                labelDisplay = `Bulan: ${monthName} | Kolom: ${key}`;
        
                // Mengatur nilai input
                if (isText) {
                    annualEditKeteranganGroup.style.display = 'block';
                    annualEditKeterangan.value = currentValue || '';
                    annualEditNominal.value = ''; 
                    annualEditNominal.setAttribute('type', 'hidden'); 
                } else {
                    nominalValue = currentValue || 0;
                }
            }
            
            annualEditLabel.value = labelDisplay;
            annualEditNominal.value = nominalValue;
        
            // Menyimpan state editing global
            annualEditId = id;
            annualEditKey = key;
            annualEditType = targetData.type; // type: 'saldo_bank', 'saldo_kas', atau 'monthly'
        
            // Menampilkan form edit
            inputArea.style.display = 'block';
            inputArea.scrollIntoView({ behavior: 'smooth' });
        }
        
        window.cancelAnnualEdit = function() {
            document.getElementById('tahunan-edit-input-area').style.display = 'none';
            annualEditId = null;
            annualEditKey = null;
            annualEditType = null;
        }

        window.saveAnnualReportData = async function() { // Di-override di script module
            if (!annualEditId) return;
            if (!isLoggedIn) return alert('Anda harus login sebagai admin untuk melakukan aksi ini.');
            
            let newValue;
            let targetData = annualData.find(d => d.id === annualEditId);

            if (!targetData) return alert('Data target tidak ditemukan.');

            if (annualEditNominal.getAttribute('type') === 'number') {
                newValue = parseInt(document.getElementById('annual-edit-nominal').value) || 0;
            } else {
                newValue = document.getElementById('annual-edit-keterangan').value;
            }
            
            // Simpan ke local storage
            let keys = annualEditKey.split('.'); // Contoh: pendidikan.penerima, atau nominal
            let obj = targetData;

            for (let i = 0; i < keys.length - 1; i++) {
                obj = obj[keys[i]];
            }
            obj[keys[keys.length - 1]] = newValue;

            // Khusus untuk Saldo Awal, update properti 'nominal' di objek utama
            if (annualEditType === 'saldo_bank' || annualEditType === 'saldo_kas') {
                targetData.nominal = newValue;
            }

            saveDataToStorage(ANNUAL_KEY, annualData);
            alert('Data tahunan berhasil disimpan (Local Storage)!');
            cancelAnnualEdit();
            filterData('tahunan');
        }

        // --- LOGIC LAPORAN TAHUNAN ---
        function generateAnnualReportData(reportYear) {
            const reportYearNum = parseInt(reportYear);
            let runningBalance = 0;
            const dataToRender = [];
            
            let total = {
                koin: 0, donatur: 0,
                pendidikan: { uang: 0, penerima: 0 },
                sosial: { uang: 0, penerima: 0 },
                kesehatan: { uang: 0, penerima: 0 },
                ekonomi: { uang: 0, penerima: 0 },
                banom: { uang: 0, keterangan: '' },
                bencana: { uang: 0, penerima: 0 },
                honor: { petugas: 0, mwc: 0, pc: 0 },
                rapat: 0, perwtn_mlu: 0, biaya_rek_bank: 0, lain_lain_peng: 0,
                totalPengeluaran: 0,
                saldoKasTahunBerjalan: 0
            };

            // 1. Ambil Saldo Awal Tahun dari annualData
            // FIX: Pastikan objek memiliki ID jika belum ada di Firestore (untuk menghindari error "Data tidak ditemukan")
            let saldoBank = annualData.find(d => d.id === `saldo_bank_${reportYear}`) || { nominal: 0, id: `saldo_bank_${reportYear}` }; 
            let saldoKas = annualData.find(d => d.id === `saldo_kas_${reportYear}`) || { nominal: 0, id: `saldo_kas_${reportYear}` }; 
            
            const totalSaldoAwal = saldoBank.nominal + saldoKas.nominal;
            runningBalance = totalSaldoAwal;

            dataToRender.push({ id: saldoBank.id, no: 1, label: 'SALDO KAS BANK (Awal Tahun)', type: 'saldo_bank', koinNominal: saldoBank.nominal, manual: {} });
            dataToRender.push({ id: saldoKas.id, no: 2, label: 'SALDO KAS TUNAI (Awal Tahun)', type: 'saldo_kas', koinNominal: saldoKas.nominal, manual: {} });

            // 2. Loop per bulan
            for (let month = 1; month <= 12; month++) {
                const monthName = namaBulan[month - 1];

                // FIX: Gunakan perbandingan longgar (==) atau d.year == reportYearNum (untuk string/number)
                let monthlyManual = annualData.find(d => d.type === 'monthly' && d.year == reportYearNum && d.month === month); 

                // Pastikan data bulanan manual ada (jika tidak, inisiasi)
                if (!monthlyManual) {
                    monthlyManual = {
                        type: 'monthly',
                        year: reportYearNum,
                        month: month,
                        donatur: 0,
                        pendidikan: { penerima: 0 },
                        sosial: { penerima: 0 },
                        kesehatan: { penerima: 0 },
                        ekonomi: { penerima: 0 },
                        banom: { keterangan: '' },
                        bencana: { penerima: 0 },
                    };
                    annualData.push(monthlyManual);
                    saveDataToStorage(ANNUAL_KEY, annualData);
                }

                // 2a. HITUNG KOIN NU BULAN INI
                const koinTotal = calculateKoinTotals(month.toString(), reportYear);
                const totalCollectedKoin = koinTotal.totalNominal; // 100% dari KOIN
                const koinRantingIncome = koinTotal.ranting; // 60% (BAGIAN YANG MASUK KAS)

                // 2b. HITUNG DANA MASUK MANUAL JURNAL (Manual Masuk, selain Saldo Bulan Lalu/Ranting 60%)
                const totalDanaMasukJurnalManual = jurnalData.filter(d => {
                    const dataDate = new Date(d.tanggal + 'T00:00:00');
                    const dataMonth = (dataDate.getMonth() + 1);
                    const dataYear = dataDate.getFullYear();
                    
                    // FIX: Gunakan perbandingan longgar (==)
                    return dataMonth === month && dataYear == reportYearNum && d.masuk > 0 && d.kategori !== categories.saldo_bln_lalu && d.kategori !== categories.ranting_60;
                }).reduce((sum, d) => sum + d.masuk, 0);


                // TOTAL DANA MASUK KAS 
                const totalDanaMasukKas = koinRantingIncome + totalDanaMasukJurnalManual; // (Kolom 3 + Saldo Masuk Manual Jurnal Umum)

                // 2c. HITUNG RINCIAN PENGELUARAN WAJIB (Uang)
                const expensePendidikan = calculateJurnalExpense(categories.pendidikan, month.toString(), reportYear);
                const expenseKesehatan = calculateJurnalExpense(categories.kesehatan, month.toString(), reportYear);
                const expenseEkonomi = calculateJurnalExpense(categories.ekonomi, month.toString(), reportYear);
                const expenseSosial = calculateJurnalExpense(categories.sosial, month.toString(), reportYear);
                const expenseBanom = calculateJurnalExpense(categories.banom, month.toString(), reportYear);
                const expenseBencana = calculateJurnalExpense(categories.bencana, month.toString(), reportYear);

                // 2d. HITUNG TOTAL PENGELUARAN JURNAL (Semua dana keluar, termasuk yang otomatis dari KOIN 40%)
                const totalDanaKeluarJurnal = jurnalData.filter(d => {
                    const dataDate = new Date(d.tanggal + 'T00:00:00');
                    const dataMonth = (dataDate.getMonth() + 1);
                    const dataYear = dataDate.getFullYear();
                    // FIX: Gunakan perbandingan longgar (==)
                    return dataMonth === month && dataYear == reportYearNum && d.keluar > 0;
                }).reduce((sum, d) => sum + d.keluar, 0);

                // 2e. HITUNG RINCIAN PENGELUARAN LAIN-LAIN (Manual + Auto Honor)
                const expenseRapat = calculateJurnalExpense(categories.rapat, month.toString(), reportYear);
                const expensePerwtnMlu = calculateJurnalExpense(categories.perwtn_mlu, month.toString(), reportYear);
                const expenseBiayaRek = calculateJurnalExpense(categories.biaya_rek, month.toString(), reportYear);
                const expenseLainLainPeng = calculateJurnalExpense(categories.lain_lain_peng, month.toString(), reportYear);
                
                // Honor dihitung dari KOIN (otomatis)
                const honorPetugas = koinTotal.petugas;
                const honorMwc = koinTotal.mwc;
                const honorPc = koinTotal.pc;
                
                // PERHITUNGAN SALDO: Total Dana Masuk Kas - Total Dana Keluar Jurnal
                // Ini adalah NET CASH MOVEMENT (Penerimaan Rill - Pengeluaran Rill)
                const saldoAkhirBulanIni = totalDanaMasukKas - totalDanaKeluarJurnal;

                // Running balance (SALDO KAS TAHUN BERJALAN)
                runningBalance += saldoAkhirBulanIni;
                
                const totalMonthlyExpense = totalDanaKeluarJurnal; // This is COL 7

                const row = {
                    id: `monthly_${reportYear}_${month}`,
                    no: month + 2,
                    label: monthName,
                    type: 'monthly',
                    // Kolom 3 (Display 100% Koin)
                    koinNominal: totalCollectedKoin,
                    // Kolom 4 (Manual)
                    donatur: monthlyManual.donatur,
                    
                    // Pengeluaran Wajib (Uang dari Jurnal, Penerima dari Manual)
                    pendidikan: { uang: expensePendidikan, penerima: monthlyManual.pendidikan.penerima },
                    sosial: { uang: expenseSosial, penerima: monthlyManual.sosial.penerima },
                    kesehatan: { uang: expenseKesehatan, penerima: monthlyManual.kesehatan.penerima },
                    ekonomi: { uang: expenseEkonomi, penerima: monthlyManual.ekonomi.penerima },
                    banom: { uang: expenseBanom, keterangan: monthlyManual.banom.keterangan },
                    bencana: { uang: expenseBencana, penerima: monthlyManual.bencana.penerima },

                    // Pengeluaran Lain-lain (Manual + Auto Honor)
                    honor: { petugas: honorPetugas, mwc: honorMwc, pc: honorPc },
                    rapat: expenseRapat,
                    perwtn_mlu: expensePerwtnMlu,
                    biaya_rek_bank: expenseBiayaRek,
                    lain_lain_peng: expenseLainLainPeng,

                    // Kolom 7 (Total Pengeluaran)
                    totalPengeluaran: totalMonthlyExpense,
                    // Kolom 8 (Net Cash Movement)
                    saldoAkhirBulanIni: saldoAkhirBulanIni,
                    // Kolom 9 (Running Balance)
                    saldoKasTahunBerjalan: runningBalance
                };

                dataToRender.push(row);

                // Update Total Tahunan
                total.koin += row.koinNominal;
                total.donatur += row.donatur;
                total.pendidikan.uang += row.pendidikan.uang;
                total.pendidikan.penerima += row.pendidikan.penerima;
                total.sosial.uang += row.sosial.uang;
                total.sosial.penerima += row.sosial.penerima;
                total.kesehatan.uang += row.kesehatan.uang;
                total.kesehatan.penerima += row.kesehatan.penerima;
                total.ekonomi.uang += row.ekonomi.uang;
                total.ekonomi.penerima += row.ekonomi.penerima;
                total.banom.uang += row.banom.uang;
                total.bencana.uang += row.bencana.uang;
                total.bencana.penerima += row.bencana.penerima;
                total.honor.petugas += row.honor.petugas;
                total.honor.mwc += row.honor.mwc;
                total.honor.pc += row.honor.pc;
                total.rapat += row.rapat;
                total.perwtn_mlu += row.perwtn_mlu;
                total.biaya_rek_bank += row.biaya_rek_bank;
                total.lain_lain_peng += row.lain_lain_peng;
                total.totalPengeluaran += row.totalPengeluaran;
            }
            
            // Simpan Saldo Kas Tahun Berjalan Akhir
            total.saldoKasTahunBerjalan = runningBalance;

            return { data: dataToRender, total: total, saldoAwal: totalSaldoAwal };
        }

        // --- RENDER ANNUAL REPORT ---
        function renderAnnualReportTable(data, reportYear) {
            const tableBody = document.getElementById('annual-data-body');
            tableBody.innerHTML = '';
            
            const { data: dataToRender, total, saldoAwal } = data;
            
            if (dataToRender.length === 0) {
                 const row = tableBody.insertRow();
                row.innerHTML = `<td colspan="26" style="text-align: center; font-style: italic;">Tidak ada data Tahunan untuk periode ini.</td>`;
            }

            // Helper function untuk cell input manual (donatur)
            const createManualDonaturCell = (donatur, id) => {
                const donaturDisplay = donatur || 0;
                return `<td style="text-align: center;"><span class="editable-cell annual-manual-input" data-type="monthly" data-key="donatur" data-id="${id}" onclick="editAnnualData('${id}', 'donatur', ${donatur})">${donaturDisplay}</span></td>`;
            };

            // Helper function untuk cell input manual (penerima)
            const createManualPenerimaCell = (key, penerima, id) => {
                const penerimaDisplay = penerima || 0;
                return `<td><span class="editable-cell annual-manual-input" data-type="monthly" data-key="${key}.penerima" data-id="${id}" onclick="editAnnualData('${id}', '${key}.penerima', ${penerima})">${penerimaDisplay}</span></td>`;
            };
            
            // Helper function untuk cell input manual (keterangan/teks)
            const createManualKeteranganCell = (key, keterangan, id) => {
                const keteranganDisplay = keterangan || '-';
                // Escape quotes for JavaScript function call
                return `<td><span class="editable-cell annual-manual-input" data-type="monthly" data-key="${key}.keterangan" data-id="${id}" onclick="editAnnualData('${id}', '${key}.keterangan', '${keterangan.replace(/'/g, "\\'")}', true)">${keteranganDisplay}</span></td>`;
            };


            dataToRender.forEach((data, index) => {
                const row = tableBody.insertRow();
                let nominalDisplay = formatRupiah(data.koinNominal);

                // --- Saldo Awal Rows (1 & 2) ---
                if(data.type === 'saldo_bank' || data.type === 'saldo_kas') {
                    row.classList.add('annual-saldo-row');
                    const isBank = data.type === 'saldo_bank';
                    const label = isBank ? 'SALDO KAS BANK (Awal Tahun)' : 'SALDO KAS TUNAI (Awal Tahun)';
                    
                    // Membuat cell nominal dapat diedit
                    const editableNominal = `<span class="editable-cell annual-manual-input" data-type="${data.type}" data-key="nominal" data-id="${data.id}" onclick="editAnnualData('${data.id}', 'nominal', ${data.koinNominal})">${nominalDisplay}</span>`;

                    // Saldo Kas Tahun Berjalan hanya dihitung di baris Saldo Kas Tunai
                    // Catatan: Baris Saldo Kas Tunai (indeks 1) akan menampilkan Total Saldo Awal (Bank + Kas Tunai)
                    const saldoKasTahunBerjalan = isBank ? formatRupiah(data.koinNominal) : formatRupiah(dataToRender[0].koinNominal + data.koinNominal); 
                    
                    row.innerHTML = `
                        <td style="text-align: center;">${index + 1}</td>
                        <td style="font-weight: bold;">${label}</td>
                        <td class="money-col">${editableNominal}</td>
                        <td style="text-align: center;">-</td>
                        <td colspan="19"></td>
                        <td class="money-col">0</td>
                        <td class="money-col">0</td>
                        <td class="money-col annual-total-row" style="font-weight: bold;">${isBank ? '-' : saldoKasTahunBerjalan}</td> 
                    `;

                } else if (data.type === 'monthly') {
                    // --- Data Bulanan (Monthly) ---
                    const emptyCell = '<td>-</td>';
                    const emptyMoneyCell = '<td class="money-col">0</td>';
                    
                    row.innerHTML = `
                        <td style="text-align: center;">${data.no}</td>
                        <td>${data.label}</td>
                        <td class="money-col koin-fixed-entry">${formatRupiah(data.koinNominal)}</td>
                        ${createManualDonaturCell(data.donatur, data.id)}
                        
                        <td class="money-col">${formatRupiah(data.pendidikan.uang)}</td>
                        ${createManualPenerimaCell('pendidikan', data.pendidikan.penerima, data.id)}
                        <td class="money-col">${formatRupiah(data.kesehatan.uang)}</td>
                        ${createManualPenerimaCell('kesehatan', data.kesehatan.penerima, data.id)}
                        <td class="money-col">${formatRupiah(data.ekonomi.uang)}</td>
                        ${createManualPenerimaCell('ekonomi', data.ekonomi.penerima, data.id)}
                        <td class="money-col">${formatRupiah(data.sosial.uang)}</td>
                        ${createManualPenerimaCell('sosial', data.sosial.penerima, data.id)}
                        <td class="money-col">${formatRupiah(data.banom.uang)}</td>
                        ${createManualKeteranganCell('banom', data.banom.keterangan, data.id)}
                        <td class="money-col">${formatRupiah(data.bencana.uang)}</td>
                        ${createManualPenerimaCell('bencana', data.bencana.penerima, data.id)}

                        <td class="money-col koin-fixed-entry">${formatRupiah(data.honor.petugas)}</td>
                        <td class="money-col koin-fixed-entry">${formatRupiah(data.honor.mwc)}</td>
                        <td class="money-col koin-fixed-entry">${formatRupiah(data.honor.pc)}</td>
                        <td class="money-col">${formatRupiah(data.rapat)}</td>
                        <td class="money-col">${formatRupiah(data.perwtn_mlu)}</td>
                        <td class="money-col">${formatRupiah(data.biaya_rek_bank)}</td>
                        <td class="money-col">${formatRupiah(data.lain_lain_peng)}</td>

                        <td class="money-col">${formatRupiah(data.totalPengeluaran)}</td>
                        <td class="money-col">${formatRupiah(data.saldoAkhirBulanIni)}</td>
                        <td class="money-col annual-total-row">${formatRupiah(data.saldoKasTahunBerjalan)}</td>
                    `;
                }
            });

            // Render Total Footer
            document.getElementById('tahunan-total-koin').textContent = formatRupiah(total.koin);
            document.getElementById('tahunan-total-donatur').textContent = total.donatur.toString(); // Donatur dalam jumlah, bukan rupiah
            
            document.getElementById('tahunan-total-pend-uang').textContent = formatRupiah(total.pendidikan.uang);
            document.getElementById('tahunan-total-pend-penerima').textContent = total.pendidikan.penerima;
            document.getElementById('tahunan-total-kes-uang').textContent = formatRupiah(total.kesehatan.uang);
            document.getElementById('tahunan-total-kes-penerima').textContent = total.kesehatan.penerima;
            document.getElementById('tahunan-total-eko-uang').textContent = formatRupiah(total.ekonomi.uang);
            document.getElementById('tahunan-total-eko-penerima').textContent = total.ekonomi.penerima;
            document.getElementById('tahunan-total-sosial-uang').textContent = formatRupiah(total.sosial.uang);
            document.getElementById('tahunan-total-sosial-penerima').textContent = total.sosial.penerima;
            document.getElementById('tahunan-total-banom-uang').textContent = formatRupiah(total.banom.uang);
            // Keterangan tidak dijumlahkan
            document.getElementById('tahunan-total-bencana-uang').textContent = formatRupiah(total.bencana.uang);
            document.getElementById('tahunan-total-bencana-penerima').textContent = total.bencana.penerima;

            document.getElementById('tahunan-total-honor-petugas').textContent = formatRupiah(total.honor.petugas);
            document.getElementById('tahunan-total-honor-mwc').textContent = formatRupiah(total.honor.mwc);
            document.getElementById('tahunan-total-honor-pc').textContent = formatRupiah(total.honor.pc);
            document.getElementById('tahunan-total-rapat').textContent = formatRupiah(total.rapat);
            document.getElementById('tahunan-total-perwtn-mlu').textContent = formatRupiah(total.perwtn_mlu);
            document.getElementById('tahunan-total-biaya-rek-bank').textContent = formatRupiah(total.biaya_rek_bank);
            document.getElementById('tahunan-total-lain-lain-peng').textContent = formatRupiah(total.lain_lain_peng);
            
            document.getElementById('tahunan-total-pengeluaran').textContent = formatRupiah(total.totalPengeluaran);
            
            const saldoKasAkhir = total.saldoKasTahunBerjalan;
            document.getElementById('tahunan-total-saldo-akhir').textContent = formatRupiah(saldoKasAkhir - saldoAwal);
            document.getElementById('tahunan-total-saldo-kas').textContent = formatRupiah(saldoKasAkhir);
        }

        // --- JURNAL INPUT UTILITY ---
        function updateMasukKeluarFields() {
            const kategori = document.getElementById('jurnal-input-kategori').value;
            const masukField = document.getElementById('jurnal-input-masuk');
            const keluarField = document.getElementById('jurnal-input-keluar');

            // Cek apakah kategori termasuk Dana Masuk atau Dana Keluar
            const isDanaMasuk = ['Koin NU', 'Donatur', 'Zakat Mall', 'Infaq', 'Shodaqoh', 'Saldo Bulan Lalu', 'Hasil Usaha', 'Ranting (60%)'].includes(kategori);
            const isDanaKeluar = !isDanaMasuk;

            // Reset dan atur status
            masukField.disabled = false;
            keluarField.disabled = false;
            masukField.value = '';
            keluarField.value = '';

            // Jika Kategori Dana Masuk, nonaktifkan Dana Keluar
            if (isDanaMasuk) {
                keluarField.disabled = true;
                keluarField.value = 0;
            } 
            // Jika Kategori Dana Keluar, nonaktifkan Dana Masuk
            else if (isDanaKeluar && kategori !== "") {
                masukField.disabled = true;
                masukField.value = 0;
            }
        }
        
        // --- DOWNLOAD PDF ---
        function downloadPDF(module) {
            let contentId, ttdAreaId, ttdDateId;

            if (module === 'koin') {
                contentId = 'koin-pdf-content';
                ttdAreaId = 'koin-ttd-area';
                ttdDateId = 'koin-ttd-date';
            } else if (module === 'jurnal') {
                contentId = 'jurnal-pdf-content';
                ttdAreaId = 'jurnal-ttd-area';
                ttdDateId = 'jurnal-ttd-date';
            } else if (module === 'tahunan') {
                contentId = 'tahunan-pdf-content';
                ttdAreaId = 'tahunan-ttd-area';
                ttdDateId = 'tahunan-ttd-date';
                document.getElementById('tahunan-edit-input-area').style.display = 'none'; // Sembunyikan form edit
            } else {
                return;
            }

            const content = document.getElementById(contentId);
            
            // Tampilkan TTD dan Tanggal
            document.getElementById(ttdAreaId).style.display = 'flex';
            document.getElementById(ttdDateId).style.display = 'block';

            // Sembunyikan kolom yang tidak perlu di PDF (Koin NU: Pembagian & Aksi)
            if (module === 'koin') {
                document.querySelectorAll('.koin-pembagian-col').forEach(el => el.style.display = 'none');
                document.getElementById('koin-hp-header').style.display = 'none';
                document.getElementById('koin-alamat-header').style.display = 'none';
            }
            if (isLoggedIn) {
                document.getElementById('koin-aksi-header').style.display = 'none';
                document.getElementById('jurnal-aksi-header').style.display = 'none';
            }

            // FIX LAPORAN TAHUNAN: Menangani tabel lebar (Pertahankan ini)
            // ===============================================
            let originalFontSize = content.style.fontSize;
            let originalTableFontSize = null;
            let originalTablePadding = null; 
            
            if (module === 'tahunan') {
                const tableWrapper = content.querySelector('div[style*="overflow-x: auto"]');
                if (tableWrapper) {
                    // FIX 1: Hapus overflow-x
                    tableWrapper.style.overflowX = 'visible';
                }
                // FIX 2: Reduksi ukuran font dan padding SECARA AGRESIF
                content.style.fontSize = '5px';
                const annualTable = content.querySelector('#annual-data-table');
                if (annualTable) {
                    originalTableFontSize = annualTable.style.fontSize;
                    annualTable.style.fontSize = '5px';
                    // Ambil nilai padding cell pertama sebagai referensi untuk dikembalikan
                    const firstCell = annualTable.querySelector('th, td');
                    if(firstCell) {
                        originalTablePadding = firstCell.style.padding;
                    }
                    // Kurangi padding kolom header & cell ke 1px (Sangat Rapat)
                    annualTable.querySelectorAll('th, td').forEach(el => {
                        el.style.padding = '1px';
                    });
                }
            }
            // ===============================================

            html2canvas(content, {
                scale: 3, // Skala yang lebih tinggi untuk resolusi lebih baik
                // Pastikan html2canvas menangkap seluruh lebar konten yang di-scroll
                width: content.scrollWidth,
                windowWidth: content.scrollWidth, 
            }).then(function(canvas) {
                const { jsPDF } = window.jspdf;
                const imgData = canvas.toDataURL('image/jpeg', 1.0);
                
                // Pilihan kertas Landscape A4 (Lebih lebar)
                const pdf = new jsPDF('l', 'mm', 'a4');
                const pdfWidth = pdf.internal.pageSize.getWidth();
                const margin = 10;
                const targetPdfWidth = pdfWidth - (2 * margin); // Lebar target dalam mm (setelah margin)

                // Hitung tinggi gambar berdasarkan rasio aspek dan lebar target (Ini yang memaksa muat)
                const imgHeight = canvas.height * targetPdfWidth / canvas.width;

                let heightLeft = imgHeight;
                let position = margin;

                // Tambahkan gambar ke PDF (logika multi-halaman)
                pdf.addImage(imgData, 'JPEG', margin, position, targetPdfWidth, imgHeight);
                heightLeft -= pdf.internal.pageSize.getHeight();

                while (heightLeft >= 0) {
                    position = heightLeft - imgHeight + margin;
                    pdf.addPage();
                    pdf.addImage(imgData, 'JPEG', margin, position, targetPdfWidth, imgHeight);
                    heightLeft -= pdf.internal.pageSize.getHeight();
                }

                pdf.save(`Laporan_${module}_${document.getElementById(`${module}-filter-tahun`).value}_${document.getElementById(`${module}-filter-bulan`) ? document.getElementById(`${module}-filter-bulan`).value : ''}.pdf`);

                // Kembalikan tampilan setelah unduh
                document.getElementById(ttdAreaId).style.display = 'none';
                document.getElementById(ttdDateId).style.display = 'none';

                if (module === 'koin') {
                    document.querySelectorAll('.koin-pembagian-col').forEach(el => el.style.display = 'table-cell');
                    document.getElementById('koin-hp-header').style.display = 'table-cell';
                    document.getElementById('koin-alamat-header').style.display = 'table-cell';
                }
                if (isLoggedIn) {
                    document.getElementById('koin-aksi-header').style.display = 'table-cell';
                    document.getElementById('jurnal-aksi-header').style.display = 'table-cell';
                }
                
                // Kembalikan gaya Tahunan
                if (module === 'tahunan') {
                    content.style.fontSize = originalFontSize;
                    const tableWrapper = content.querySelector('div[style*="overflow-x: auto"]');
                    if (tableWrapper) {
                        tableWrapper.style.overflowX = 'auto';
                    }
                    const annualTable = content.querySelector('#annual-data-table');
                    if (annualTable) {
                        annualTable.style.fontSize = originalTableFontSize;
                        annualTable.querySelectorAll('th, td').forEach(el => {
                            el.style.padding = originalTablePadding;
                        });
                    }
                }
            });
        }

        // --- INISIALISASI ---
        function init() {
            // 1. Load data dari Local Storage
            koinData = loadDataFromStorage(KOIN_KEY, koinData);
            jurnalData = loadDataFromStorage(JURNAL_KEY, jurnalData);
            annualData = loadDataFromStorage(ANNUAL_KEY, annualData);
            
            // 2. Isi Opsi Filter
            populateFilterOptions();
            
            // 3. Tampilkan modul default ('koin')
            showModule(currentModule);
        }

        window.onload = init;
</script>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, deleteDoc, query, orderBy, where, writeBatch } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    // =========== CONFIG - GANTI DENGAN MILIK KAKAK ===========
    const firebaseConfig = {
        apiKey: "AIzaSyA_8NMmZBaXZ4H6KQt7rHy8G1URR3HLP3A",
        authDomain: "upzis-ngablak.firebaseapp.com",
        projectId: "upzis-ngablak",
        storageBucket: "upzis-ngablak.firebasestorage.app",
        messagingSenderId: "869549648344",
        appId: "1:869549648344:web:a531a37cce3a87bb672aad"
    };
    // =========================================================

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    // Collection names (Opsi 1)
    const COL_KOIN = 'laporan_koin_nu';
    const COL_JURNAL = 'jurnal_umum';
    const COL_TAHUNAN = 'laporan_tahunan';
    
    // Admin credentials (hanya untuk login di aplikasi ini, bukan di Firebase Auth)
    const ADMIN_USERNAME = 'admin'; 
    const ADMIN_PASSWORD = 'password'; // GANTI INI DENGAN PASSWORD ASLI ADMIN ANDA

    // Variable global di window yang akan diisi dari Firestore
    window.koinData = []; 
    window.jurnalData = []; 
    window.annualData = []; 
    window.isLoggedIn = false;
    
    // Listen to Auth State
    onAuthStateChanged(auth, (user) => {
        if (user) {
            // Pengguna login. Cek apakah ini pengguna admin (opsional)
            // Di sini kita asumsikan user yang login via Firebase Auth adalah admin
            window.isLoggedIn = true;
            localStorage.setItem('upzis_is_admin_logged_in', 'true');
            document.getElementById('login-area').style.display = 'none';
        } else {
            // Pengguna logout
            window.isLoggedIn = false;
            localStorage.removeItem('upzis_is_admin_logged_in');
        }
        // Pastikan tampilan diupdate setelah status Auth berubah
        showModule(currentModule);
    });

    // Load All Data from Firestore
    window.loadAllCollections = async function() {
        // load koin
        try {
            const qk = query(collection(db, COL_KOIN), orderBy('tanggal', 'asc'));
            const snapK = await getDocs(qk);
            window.koinData = [];
            snapK.forEach(d => window.koinData.push({ id: d.id, ...d.data() }));
        } catch(e){ console.error('load koin error', e); }

        // load jurnal
        try {
            const qj = query(collection(db, COL_JURNAL), orderBy('tanggal', 'asc'));
            const snapJ = await getDocs(qj);
            window.jurnalData = [];
            snapJ.forEach(d => window.jurnalData.push({ id: d.id, ...d.data() }));
        } catch(e){ console.error('load jurnal error', e); }

        // load tahunan
        try {
            const qt = query(collection(db, COL_TAHUNAN), orderBy('year', 'asc'));
            const snapT = await getDocs(qt);
            window.annualData = [];
            snapT.forEach(d => window.annualData.push({ id: d.id, ...d.data() }));
        } catch(e){ console.error('load tahunan error', e); }
    }

    // OVERRIDE: Simpan data ke Firestore
    window.saveData = async function(module){
        if (!isLoggedIn) return alert('Anda harus login sebagai admin untuk melakukan aksi ini.');

        if (module === 'koin') {
            // gather fields
            const tanggal = document.getElementById('koin-input-tanggal').value;
            const petugas = document.getElementById('koin-input-petugas').value;
            const hp = document.getElementById('koin-input-hp').value;
            const donatur = document.getElementById('koin-input-donatur').value;
            const alamat = document.getElementById('koin-input-alamat').value;
            const nominal = parseInt(document.getElementById('koin-input-nominal').value) || 0;
            
            if (!tanggal || !petugas || !donatur || nominal <= 0) {
                return alert('Mohon lengkapi semua data Koin NU yang diperlukan.');
            }

            if (koinEditId !== null) {
                // update existing doc
                try {
                    const docRef = doc(db, COL_KOIN, String(koinEditId));
                    await updateDoc(docRef, { tanggal, petugas, hp, donatur, alamat, nominal });
                    alert('Data Koin diperbarui di Firestore.');
                } catch(e){ console.error(e); alert('Gagal update: '+e.message); }
            } else {
                try {
                    await addDoc(collection(db, COL_KOIN), {
                        tanggal, petugas, hp, donatur, alamat, nominal, type: 'manual', createdAt: Date.now()
                    });
                    alert('Data Koin tersimpan di Firestore.');
                } catch(e){ console.error(e); alert('Gagal simpan: '+e.message); }
            }
            
            await loadAllCollections();
            resetForm('koin');
            filterData('koin');
            koinEditId = null;

        } else if (module === 'jurnal') {
            // gather fields
            const tanggal = document.getElementById('jurnal-input-tanggal').value;
            const keterangan = document.getElementById('jurnal-input-keterangan').value;
            const kategori = document.getElementById('jurnal-input-kategori').value;
            const masuk = parseInt(document.getElementById('jurnal-input-masuk').value) || 0;
            const keluar = parseInt(document.getElementById('jurnal-input-keluar').value) || 0;
            
            if (!tanggal || !keterangan || !kategori || (masuk <= 0 && keluar <= 0)) {
                return alert('Mohon lengkapi semua data Jurnal Umum yang diperlukan.');
            }

            if (jurnalEditId !== null) {
                // update existing doc
                 try {
                    const docRef = doc(db, COL_JURNAL, String(jurnalEditId));
                    await updateDoc(docRef, { tanggal, keterangan, kategori, masuk, keluar });
                    alert('Data Jurnal diperbarui di Firestore.');
                } catch(e){ console.error(e); alert('Gagal update: '+e.message); }
            } else {
                try {
                    await addDoc(collection(db, COL_JURNAL), {
                        tanggal, keterangan, kategori, masuk, keluar, type: 'manual', createdAt: Date.now()
                    });
                    alert('Data Jurnal tersimpan di Firestore.');
                } catch(e){ console.error(e); alert('Gagal simpan: '+e.message); }
            }
            
            await loadAllCollections();
            resetForm('jurnal');
            filterData('jurnal');
            jurnalEditId = null;
        }
    };

    // OVERRIDE: Edit data (Handle Saldo Bulan Lalu Edit)
    window.editData = async function(module, id, month = null, year = null, currentValue = null){
        if (!isLoggedIn) return alert('Anda harus login sebagai admin untuk melakukan aksi ini.');

        // handle saldo-bulan-lalu-edit special case (store in laporan_tahunan)
        if (module === 'jurnal' && id === 'saldo-bulan-lalu-edit') {
            if (!month || !year) return alert('Data bulan/tahun tidak ditemukan.');
            const newSaldo = prompt(`Edit Saldo Bulan Lalu untuk ${month}/${year}:`, currentValue);
            
            if (newSaldo !== null && !isNaN(newSaldo) && newSaldo.trim() !== '') {
                const newSaldoNum = parseInt(newSaldo);

                // find if exists in annualData with type 'saldo_bulan_lalu_manual'
                let target = annualData.find(d => d.type === 'saldo_bulan_lalu_manual' && d.year === parseInt(year) && d.month === parseInt(month));
                
                try {
                    if (target && target.id) {
                        // update doc
                        await updateDoc(doc(db, COL_TAHUNAN, target.id), { nominal: newSaldoNum });
                    } else {
                        // add new
                        await addDoc(collection(db, COL_TAHUNAN), { 
                            type: 'saldo_bulan_lalu_manual',
                            year: parseInt(year), 
                            month: parseInt(month), 
                            nominal: newSaldoNum 
                        });
                    }
                    alert('Saldo Bulan Lalu berhasil diperbarui di Firestore.');
                    await loadAllCollections();
                    filterData('jurnal');
                } catch(e){ console.error(e); alert('Gagal update Saldo Bulan Lalu: '+e.message); }
            }
            return;
        }
        
        // Handle regular Jurnal/Koin edits (fill form)
        let dataToEdit;
        if (module === 'koin') {
            dataToEdit = koinData.find(d => d.id === id);
            if (!dataToEdit) return;

            document.getElementById('koin-input-tanggal').value = dataToEdit.tanggal;
            document.getElementById('koin-input-petugas').value = dataToEdit.petugas;
            document.getElementById('koin-input-hp').value = dataToEdit.hp;
            document.getElementById('koin-input-donatur').value = dataToEdit.donatur;
            document.getElementById('koin-input-alamat').value = dataToEdit.alamat;
            document.getElementById('koin-input-nominal').value = dataToEdit.nominal;
            koinEditId = id;

        } else if (module === 'jurnal') {
             // FIX: Gunakan perbandingan longgar (==) untuk mengatasi perbedaan tipe data (number vs string)
            dataToEdit = jurnalData.find(d => d.id == id && d.type === 'manual'); 
            if (!dataToEdit) {
                alert("Data tidak ditemukan atau bukan entri manual yang bisa diedit.");
                return;
            }

            document.getElementById('jurnal-input-tanggal').value = dataToEdit.tanggal;
            document.getElementById('jurnal-input-keterangan').value = dataToEdit.keterangan;
            document.getElementById('jurnal-input-kategori').value = dataToEdit.kategori;
            document.getElementById('jurnal-input-masuk').value = dataToEdit.masuk;
            document.getElementById('jurnal-input-keluar').value = dataToEdit.keluar;
            jurnalEditId = id;
            updateMasukKeluarFields(); // Update status Masuk/Keluar fields
        }

        // Scroll to form after filling data
        const inputArea = document.getElementById(`${module}-input-area`);
        if (inputArea) {
            inputArea.scrollIntoView({ behavior: 'smooth' });
        }
    }


    // OVERRIDE: Save Annual Report Data (Saldo Awal, Donatur, Penerima, Keterangan)
    window.saveAnnualReportData = async function() {
        if (!annualEditId) return;
        if (!isLoggedIn) return alert('Anda harus login sebagai admin untuk melakukan aksi ini.');
        
        let newValue;
        let targetData = annualData.find(d => d.id === annualEditId);

        if (!targetData) return alert('Data target tidak ditemukan.');

        if (annualEditNominal.getAttribute('type') === 'number') {
            newValue = parseInt(document.getElementById('annual-edit-nominal').value) || 0;
        } else {
            newValue = document.getElementById('annual-edit-keterangan').value;
        }
        
        // Cek apakah data ini sudah ada di Firestore (memiliki ID Firestore yang asli)
        const isNewDoc = !targetData.id || targetData.id.startsWith('saldo_');
        
        try {
            if (isNewDoc) {
                // Untuk data Saldo Awal, kita selalu buat dokumen baru atau update jika ID sudah ada (saldo_bank_YYYY)
                // Kita gunakan ID yang sudah di-generate ('saldo_bank_YYYY') sebagai ID dokumen di Firestore
                
                const dataToSave = {
                    type: annualEditType,
                    year: parseInt(annualEditId.split('_').pop()), // Ambil tahun dari ID (misal: 2025)
                    nominal: newValue, // Hanya Saldo Awal yang punya 'nominal' langsung
                };
                
                // Coba cek apakah dokumen sudah ada dengan ID yang sama
                const docRef = doc(db, COL_TAHUNAN, annualEditId);
                const docSnap = await getDocs(query(collection(db, COL_TAHUNAN), where('type', '==', annualEditType), where('year', '==', dataToSave.year)));
                
                if (docSnap.empty) {
                    // Jika tidak ditemukan, tambahkan dokumen baru dengan ID custom
                    await setDoc(docRef, dataToSave);
                    targetData.id = annualEditId; // Pastikan ID lokal sama dengan ID Firestore
                } else {
                    // Jika ditemukan (harusnya hanya satu), update dokumen yang sudah ada
                    const existingDocId = docSnap.docs[0].id;
                    await updateDoc(doc(db, COL_TAHUNAN, existingDocId), { nominal: newValue });
                    targetData.id = existingDocId;
                }
                
                
            } else {
                // Untuk data Bulanan (monthly_YYYY_MM)
                let keys = annualEditKey.split('.'); // Contoh: pendidikan.penerima, atau donatur
                let updateData = {};
                let firestoreField = keys[0];

                if (keys.length > 1) {
                    // Jika key nested (ex: pendidikan.penerima)
                    updateData[firestoreField] = { 
                        ...targetData[firestoreField], 
                        [keys[1]]: newValue 
                    };
                } else {
                    // Jika key tunggal (ex: donatur)
                    updateData[firestoreField] = newValue;
                }

                const docRef = doc(db, COL_TAHUNAN, annualEditId);
                await updateDoc(docRef, updateData);
            }
            
            // Simpan ke local storage (sinkronisasi array lokal setelah update Firestore)
            let keys = annualEditKey.split('.');
            let obj = targetData;

            for (let i = 0; i < keys.length - 1; i++) {
                obj = obj[keys[i]];
            }
            obj[keys[keys.length - 1]] = newValue;
            
            // Khusus Saldo Awal, update properti 'nominal' di objek utama
            if (annualEditType === 'saldo_bank' || annualEditType === 'saldo_kas') {
                targetData.nominal = newValue;
            }

            alert('Data tahunan berhasil diperbarui di Firestore!');
            await loadAllCollections();
            cancelAnnualEdit();
            filterData('tahunan');
        } catch(e){ 
            console.error(e); 
            alert('Gagal update data tahunan: '+e.message); 
        }
    }


    // OVERRIDE: Hapus data
    window.deleteData = async function(module, id) {
        if (!isLoggedIn) return alert('Anda harus login sebagai admin untuk melakukan aksi ini.');
        
        if (module === 'jurnal') {
            const dataToDelete = jurnalData.find(d => d.id == id);
            if (dataToDelete && dataToDelete.kategori === categories.saldo_bln_lalu) {
                alert("Entri Saldo Akhir Tahun Lalu (Basis Saldo Awal) tidak dapat dihapus, hanya dapat diedit nilai nominalnya melalui Laporan Tahunan.");
                return;
            }
        }

        if (!confirm("Yakin ingin menghapus data ini?")) return;

        try {
            if (module === 'koin') {
                await deleteDoc(doc(db, COL_KOIN, String(id)));
            } else if (module === 'jurnal') {
                await deleteDoc(doc(db, COL_JURNAL, String(id)));
            } else if (module === 'tahunan') {
                await deleteDoc(doc(db, COL_TAHUNAN, String(id)));
            }
            alert('Data berhasil dihapus dari Firestore.');
        } catch(e){ console.error(e); alert('Gagal menghapus: '+e.message); }

        await loadAllCollections();
        filterData(module);
    }
    
    // OVERRIDE: Hapus Semua Data
    window.deleteAllDataGlobal = async function(module) {
        if (!isLoggedIn) return alert('Anda harus login sebagai admin untuk melakukan aksi ini.');
        if (!confirm('Yakin ingin menghapus SEMUA DATA pada modul ini? Tindakan ini tidak bisa dibatalkan.')) return;

        try {
            const batch = writeBatch(db);
            const collectionName = module === 'koin' ? COL_KOIN : COL_JURNAL;
            
            const snap = await getDocs(collection(db, collectionName));
            
            snap.forEach(d => {
                batch.delete(doc(db, collectionName, d.id));
            });
            
            await batch.commit();

            alert('Semua data dihapus.');
            await loadAllCollections();
            filterData(module);
        } catch(e){ console.error(e); alert('Gagal menghapus semua data: '+e.message); }
    };
    
    // OVERRIDE: Login dengan Firebase Auth
    window.attemptLogin = async function() {
        const email = document.getElementById('username').value;
        const password = document.getElementById('password').value;
        
        if (!email || !password) {
            return alert('Mohon isi Email dan Password.');
        }
        
        try {
            await signInWithEmailAndPassword(auth, email, password);
            // onAuthStateChanged akan menangani pembaruan UI
        } catch (error) {
            alert(`Login Gagal. Error: ${error.message}`);
        }
    }

    // OVERRIDE: Logout dengan Firebase Auth
    window.logout = async function() {
        try {
            await signOut(auth);
            // onAuthStateChanged akan menangani pembaruan UI
        } catch (error) {
            alert(`Logout Gagal. Error: ${error.message}`);
        }
    }


    // Load initial data on page ready
    window.addEventListener('DOMContentLoaded', async () => {
        await loadAllCollections();
        populateFilterOptions && populateFilterOptions();
        filterData && filterData('koin');
    });

</script>
