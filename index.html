<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pembukuan Dana Koin NU - UPZIS Ngablak</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .tab-button.active { background-color: #10b981; color: white; }
        .tab-button:not(.active) { background-color: #e5e7eb; color: #4b5563; }
        .shadow-custom { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); }
        /* Style untuk Tabel Responsif */
        .table-responsive { overflow-x: auto; -webkit-overflow-scrolling: touch; }
        .table-auto-width th, .table-auto-width td { white-space: nowrap; padding: 0.5rem 0.75rem; border: 1px solid #e5e7eb; }
        .table-auto-width th { background-color: #f9fafb; }
        .sticky-header th { position: sticky; top: 0; background-color: #f3f4f6; z-index: 10; }
        .center-text { text-align: center; }
        /* Style untuk input form */
        input[type="number"]::-webkit-inner-spin-button, 
        input[type="number"]::-webkit-outer-spin-button { 
            -webkit-appearance: none; margin: 0; 
        }
        input[type="number"] { -moz-appearance: textfield; }
        .card { background-color: white; padding: 1.5rem; border-radius: 0.75rem; margin-bottom: 1rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
    </style>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
</head>
<body class="min-h-screen">

    <div class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">
        <header class="text-center mb-6">
            <h1 class="text-2xl sm:text-3xl font-bold text-green-700">Pembukuan Dana Koin NU</h1>
            <p class="text-sm text-gray-500" id="user-info">Memuat data pengguna...</p>
        </header>

        <div class="flex flex-wrap justify-center space-x-2 sm:space-x-4 mb-6" id="nav-tabs">
            <button class="tab-button active px-4 py-2 rounded-lg font-semibold transition duration-150 shadow-md" data-target="laporan-koin">Laporan Koin</button>
            <button class="tab-button px-4 py-2 rounded-lg font-semibold transition duration-150 shadow-md" data-target="jurnal-umum">Jurnal Umum</button>
            <button class="tab-button px-4 py-2 rounded-lg font-semibold transition duration-150 shadow-md" data-target="laporan-tahunan">Laporan Tahunan</button>
        </div>

        <div id="content-area">
            <div id="laporan-koin" class="tab-content">
                <div class="flex flex-wrap justify-between items-center mb-4 space-y-2 sm:space-y-0">
                    <div id="filter-koin" class="flex space-x-2">
                        <select id="filter-tahun-koin" class="p-2 border border-gray-300 rounded-lg text-sm bg-white"></select>
                        <select id="filter-bulan-koin" class="p-2 border border-gray-300 rounded-lg text-sm bg-white"></select>
                    </div>
                    <button id="download-koin-pdf" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-150 shadow-md flex items-center text-sm">
                        <i data-lucide="download" class="w-4 h-4 mr-2"></i> Unduh PDF
                    </button>
                </div>
                
                <div class="card p-0 table-responsive shadow-custom">
                    <table class="w-full table-auto-width text-sm" id="table-laporan-koin">
                        <thead class="sticky-header">
                            <tr>
                                <th rowspan="2" class="center-text">No</th>
                                <th rowspan="2" class="center-text">Tanggal</th>
                                <th rowspan="2" class="center-text">Nama Petugas</th>
                                <th rowspan="2" class="center-text">No HP</th>
                                <th rowspan="2" class="center-text">Donatur/Kelompok</th>
                                <th rowspan="2" class="center-text">Alamat (RT/RW)</th>
                                <th rowspan="2" class="center-text">Nominal</th>
                                <th colspan="4" class="center-text">Pembagian Dana Koin</th>
                                <th rowspan="2" class="center-text">Aksi</th>
                            </tr>
                            <tr>
                                <th class="center-text">Ranting (60%)</th>
                                <th class="center-text">Petugas (10%)</th>
                                <th class="center-text">MWC (25%)</th>
                                <th class="center-text">PC (5%)</th>
                            </tr>
                        </thead>
                        <tbody id="tbody-laporan-koin">
                            <tr><td colspan="11" class="text-center py-4 text-gray-500">Memuat data...</td></tr>
                        </tbody>
                    </table>
                </div>

                <div class="card mt-6">
                    <h2 class="text-xl font-bold text-green-600 mb-4">Input Data Koin Baru</h2>
                    <form id="form-laporan-koin" class="space-y-4">
                        <input type="hidden" id="koin-doc-id" value="">
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div>
                                <label for="koin-tanggal" class="block text-sm font-medium text-gray-700">Tanggal</label>
                                <input type="date" id="koin-tanggal" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border">
                            </div>
                            <div>
                                <label for="koin-petugas" class="block text-sm font-medium text-gray-700">Nama Petugas</label>
                                <input type="text" id="koin-petugas" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border">
                            </div>
                        </div>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div>
                                <label for="koin-nohp" class="block text-sm font-medium text-gray-700">No HP</label>
                                <input type="text" id="koin-nohp" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border">
                            </div>
                            <div>
                                <label for="koin-donatur" class="block text-sm font-medium text-gray-700">Donatur/Kelompok</label>
                                <input type="text" id="koin-donatur" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border">
                            </div>
                        </div>
                        <div>
                            <label for="koin-alamat" class="block text-sm font-medium text-gray-700">Alamat (RT/RW)</label>
                            <input type="text" id="koin-alamat" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border">
                        </div>
                        <div>
                            <label for="koin-nominal" class="block text-sm font-medium text-gray-700">Nominal (Wajib Angka)</label>
                            <input type="number" id="koin-nominal" required min="1" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border text-lg font-bold">
                        </div>
                        <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition duration-150 shadow-md" id="koin-submit-btn">Tambah Data Koin</button>
                        <button type="button" class="w-full bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg transition duration-150 shadow-md mt-2 hidden" id="koin-cancel-btn">Batal Edit</button>
                    </form>
                </div>
            </div>

            <div id="jurnal-umum" class="tab-content hidden">
                <div class="flex justify-between items-center mb-4 space-y-2 sm:space-y-0">
                    <div class="flex space-x-2">
                        <button id="reset-data-jurnal" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-150 shadow-md text-sm flex items-center">
                            <i data-lucide="alert-circle" class="w-4 h-4 mr-2"></i> Reset Data (Manual)
                        </button>
                    </div>
                    <div id="filter-jurnal" class="flex space-x-2">
                        <select id="filter-tahun-jurnal" class="p-2 border border-gray-300 rounded-lg text-sm bg-white"></select>
                        <select id="filter-bulan-jurnal" class="p-2 border border-gray-300 rounded-lg text-sm bg-white"></select>
                    </div>
                    </div>

                <div class="card p-0 table-responsive shadow-custom">
                    <table class="w-full table-auto-width text-sm" id="table-jurnal-umum">
                        <thead class="sticky-header">
                            <tr>
                                <th rowspan="3" class="center-text">No</th>
                                <th rowspan="3" class="center-text">Tanggal</th>
                                <th rowspan="3" class="center-text">Keterangan</th>
                                <th colspan="7" class="center-text">Jml Penerima</th>
                                <th rowspan="3" class="center-text">Kategori</th>
                                <th rowspan="3" class="center-text">Dana Masuk</th>
                                <th rowspan="3" class="center-text">Dana Keluar</th>
                                <th rowspan="3" class="center-text">Saldo</th>
                                <th rowspan="3" class="center-text">Aksi</th>
                            </tr>
                            <tr>
                                <th class="center-text" colspan="7">Bidang</th>
                            </tr>
                            <tr>
                                <th class="center-text">Donatur</th>
                                <th class="center-text">Pendidikan</th>
                                <th class="center-text">Kesehatan</th>
                                <th class="center-text">Ekonomi</th>
                                <th class="center-text">Sosial</th>
                                <th class="center-text">Subsidi</th>
                                <th class="center-text">Bencana</th>
                            </tr>
                        </thead>
                        <tbody id="tbody-jurnal-umum">
                            <tr><td colspan="16" class="text-center py-4 text-gray-500">Memuat data...</td></tr>
                        </tbody>
                        <tfoot id="tfoot-jurnal-umum" class="font-bold">
                            <tr class="bg-gray-100">
                                <td colspan="11" class="text-right">TOTAL</td>
                                <td id="total-masuk" class="text-right text-green-600">0</td>
                                <td id="total-keluar" class="text-right text-red-600">0</td>
                                <td id="saldo-akhir" class="text-right">0</td>
                                <td></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>

                <div class="card mt-6">
                    <h2 class="text-xl font-bold text-green-600 mb-4">Input Jurnal Baru (Manual)</h2>
                    <form id="form-jurnal-umum" class="space-y-4">
                        <input type="hidden" id="jurnal-doc-id" value="">
                        <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                            <div>
                                <label for="jurnal-tanggal" class="block text-sm font-medium text-gray-700">Tanggal</label>
                                <input type="date" id="jurnal-tanggal" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border">
                            </div>
                            <div>
                                <label for="jurnal-kategori" class="block text-sm font-medium text-gray-700">Kategori</label>
                                <select id="jurnal-kategori" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border bg-white">
                                    <optgroup label="Dana Masuk">
                                        <option value="Donatur">Donatur (Non Koin)</option>
                                        <option value="Zakat Mall">Zakat Mall</option>
                                        <option value="Infaq dan Shodaqoh">Infaq dan Shodaqoh</option>
                                        <option value="Hasil Usaha">Hasil Usaha</option>
                                    </optgroup>
                                    <optgroup label="Dana Keluar Wajib">
                                        <option value="Untuk Pendidikan">Untuk Pendidikan</option>
                                        <option value="Untuk Sosial">Untuk Sosial</option>
                                        <option value="Untuk Ekonomi">Untuk Ekonomi</option>
                                        <option value="Untuk Kesehatan">Untuk Kesehatan</option>
                                        <option value="Subsidi Banom dan Lembaga NU">Subsidi Banom dan Lembaga NU</option>
                                        <option value="Untuk Bencana">Untuk Bencana</option>
                                    </optgroup>
                                    <optgroup label="Dana Keluar Lain-lain">
                                        <option value="Rapat">Rapat</option>
                                        <option value="PERWTN MLU">PERWTN MLU</option>
                                        <option value="BIAYA REK BANK">BIAYA REK BANK</option>
                                        <option value="Lain - Lain">Lain - Lain</option>
                                    </optgroup>
                                </select>
                            </div>
                            <div>
                                <label for="jurnal-jenis" class="block text-sm font-medium text-gray-700">Jenis Transaksi</label>
                                <select id="jurnal-jenis" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border bg-white">
                                    <option value="MASUK">Dana Masuk</option>
                                    <option value="KELUAR">Dana Keluar</option>
                                </select>
                            </div>
                        </div>

                        <div>
                            <label for="jurnal-keterangan" class="block text-sm font-medium text-gray-700">Keterangan</label>
                            <input type="text" id="jurnal-keterangan" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border">
                        </div>

                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div>
                                <label for="jurnal-nominal" class="block text-sm font-medium text-gray-700">Nominal (Masuk/Keluar)</label>
                                <input type="number" id="jurnal-nominal" required min="0" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border text-lg font-bold">
                            </div>
                            <div>
                                <label for="jurnal-penerima" class="block text-sm font-medium text-gray-700">Jml Penerima (Opsional, isi JSON)</label>
                                <textarea id="jurnal-penerima" placeholder='{"pendidikan": 2, "kesehatan": 1}' class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border text-sm h-20"></textarea>
                                <p class="text-xs text-gray-500 mt-1">Format JSON: {"bidang": jumlah_penerima}</p>
                            </div>
                        </div>

                        <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition duration-150 shadow-md" id="jurnal-submit-btn">Tambah Data Jurnal</button>
                        <button type="button" class="w-full bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg transition duration-150 shadow-md mt-2 hidden" id="jurnal-cancel-btn">Batal Edit</button>
                    </form>
                </div>
            </div>

            <div id="laporan-tahunan" class="tab-content hidden">
                <div class="flex justify-between items-center mb-4 space-y-2 sm:space-y-0">
                    <div id="filter-tahunan" class="flex space-x-2">
                        <select id="filter-tahun" class="p-2 border border-gray-300 rounded-lg text-sm bg-white"></select>
                    </div>
                    <button id="edit-saldo-awal" class="bg-yellow-500 hover:bg-yellow-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-150 shadow-md flex items-center text-sm">
                        <i data-lucide="wallet" class="w-4 h-4 mr-2"></i> Edit Saldo Awal Tahun
                    </button>
                </div>

                <div id="saldo-awal-input" class="card hidden mb-6">
                    <h2 class="text-xl font-bold text-yellow-600 mb-4">Edit Saldo Awal Tahun</h2>
                    <form id="form-saldo-awal" class="space-y-4">
                        <div>
                            <label for="saldo-bank" class="block text-sm font-medium text-gray-700">SALDO KAS BANK (Manual Input)</label>
                            <input type="number" id="saldo-bank" required min="0" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border">
                        </div>
                        <div>
                            <label for="saldo-tunai" class="block text-sm font-medium text-gray-700">SALDO KAS TUNAI (Manual Input)</label>
                            <input type="number" id="saldo-tunai" required min="0" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border">
                        </div>
                        <button type="submit" class="w-full bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-2 px-4 rounded-lg transition duration-150 shadow-md">Simpan Saldo Awal</button>
                    </form>
                </div>

                <div class="card p-0 table-responsive shadow-custom">
                    <table class="w-full table-auto-width text-xs sm:text-sm" id="table-laporan-tahunan">
                        <thead class="sticky-header">
                            <tr>
                                <th rowspan="4" class="center-text">No</th>
                                <th rowspan="4" class="center-text">Bulan</th>
                                <th rowspan="4" class="center-text">Total Penerimaan (3)</th>
                                <th colspan="3" class="center-text">Pengeluaran Wajib (5)</th>
                                <th colspan="4" rowspan="2" class="center-text">Pengeluaran Lain-lain (6)</th>
                                <th rowspan="4" class="center-text">Jumlah Pengeluaran (7)</th>
                                <th rowspan="4" class="center-text">Saldo Akhir Bulan Ini (8)</th>
                                <th rowspan="4" class="center-text">Saldo Kas Tahun Berjalan (9)</th>
                            </tr>
                            <tr>
                                <th colspan="5" class="center-text">Rincian Per Bidang (Pengeluaran Wajib)</th>
                                <th rowspan="2" class="center-text">Subsidi Banom & Lembaga NU</th>
                                <th colspan="3" class="center-text">Honor Wajib</th>
                            </tr>
                            <tr>
                                <th colspan="2" class="center-text">Pendidikan</th>
                                <th colspan="2" class="center-text">Kesehatan</th>
                                <th colspan="2" class="center-text">Ekonomi</th>
                                <th colspan="2" class="center-text">Sosial</th>
                                <th colspan="2" class="center-text">Bencana</th>
                                <th class="center-text">Petugas (10%)</th>
                                <th class="center-text">MWC (25%)</th>
                                <th class="center-text">PC (5%)</th>
                                <th class="center-text">Rapat</th>
                                <th class="center-text">PERWTN MLU</th>
                                <th class="center-text">BIAYA REK BANK</th>
                                <th class="center-text">Lain - Lain</th>
                            </tr>
                            <tr>
                                <th class="center-text">Uang</th>
                                <th class="center-text">Penerima</th>
                                <th class="center-text">Uang</th>
                                <th class="center-text">Penerima</th>
                                <th class="center-text">Uang</th>
                                <th class="center-text">Penerima</th>
                                <th class="center-text">Uang</th>
                                <th class="center-text">Penerima</th>
                                <th class="center-text">Uang</th>
                                <th class="center-text">Penerima</th>
                                <th class="center-text">Uang</th>
                                <th class="center-text">Uang</th>
                                <th class="center-text">Uang</th>
                                <th class="center-text">Uang</th>
                                <th class="center-text">Uang</th>
                                <th class="center-text">Uang</th>
                                <th class="center-text">Uang</th>
                                <th class="center-text">Uang</th>
                            </tr>
                        </thead>
                        <tbody id="tbody-laporan-tahunan">
                            <tr><td colspan="23" class="text-center py-4 text-gray-500">Memuat data...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="card p-2 mt-8">
                <div class="flex flex-row justify-between items-center">
                    <p class="text-sm font-semibold text-gray-700">Status Otentikasi:</p>
                    <div class="flex items-center space-x-4">
                        <p class="text-xs text-gray-500">User ID: <span id="user-id-display" class="font-mono text-gray-900">N/A</span></p>
                        <button id="logout-btn" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-1 px-3 rounded-lg text-sm transition duration-150 shadow-md">Logout</button>
                    </div>
                </div>
            </div>
            </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-auth.js";
        import { getFirestore, doc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, orderBy, getDocs, runTransaction, getDoc, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-firestore.js";

        // Global variables from Canvas environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : { /* Your manual config as fallback, though not used here */ };
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        setLogLevel('debug'); // Wajib untuk melihat log Firebase

        let db;
        let auth;
        let userId = null;
        let isAuthReady = false;
        let currentKoinUnsubscribe = () => {};
        let currentJurnalUnsubscribe = () => {};
        let currentSaldoUnsubscribe = () => {};

        // --- UTILITY FUNCTIONS ---

        // Fungsi untuk format angka (tanpa Rp)
        const formatRupiah = (number) => {
            return new Intl.NumberFormat('id-ID', { maximumFractionDigits: 0 }).format(number);
        };

        // Fungsi untuk format tanggal (Indonesia)
        const formatTanggalIndonesia = (dateString) => {
            const date = new Date(dateString);
            return date.toLocaleDateString('id-ID', { year: 'numeric', month: 'long', day: 'numeric' });
        };
        
        // Fungsi untuk mendapatkan path koleksi
        const collectionPath = (col) => {
            if (!userId) {
                console.error("User ID tidak tersedia. Gagal membuat path koleksi.");
                return null;
            }
            // Menggunakan path private per user
            return `/artifacts/${appId}/users/${userId}/${col}`;
        };

        // Fungsi Penundaan (Exponential Backoff)
        const delay = (ms) => new Promise(resolve => setTimeout(resolve, ms));
        const MAX_RETRIES = 5;

        // Fungsi Wrapper Fetch (Contoh API call, tidak terpakai di sini tapi baik untuk praktik)
        async function robustFetch(url, options) {
            for (let i = 0; i < MAX_RETRIES; i++) {
                try {
                    const response = await fetch(url, options);
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    return await response.json();
                } catch (error) {
                    if (i === MAX_RETRIES - 1) {
                        console.error('Fetch failed after multiple retries:', error);
                        throw error;
                    }
                    const waitTime = Math.pow(2, i) * 1000;
                    console.warn(`Retry ${i + 1}/${MAX_RETRIES}. Waiting ${waitTime}ms...`, error.message);
                    await delay(waitTime);
                }
            }
        }

        // --- FIREBASE INITIALIZATION & AUTH ---

        const initFirebase = async () => {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        document.getElementById('user-id-display').textContent = userId;
                        document.getElementById('user-info').textContent = `Selamat datang! ID Pengguna Anda: ${userId}`;
                        isAuthReady = true;
                        
                        // Setelah Auth siap, jalankan listener data dan inisialisasi filter
                        setupDataListeners();
                        populateMonthFilter(); // MODIFIKASI: Panggil fungsi baru untuk bulan
                        populateYearFilter(); // MODIFIKASI: Panggil fungsi yang sudah dimodifikasi untuk tahun

                    } else {
                        // Coba sign in dengan custom token atau anonim
                        if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            await signInAnonymously(auth);
                        }
                    }
                });

            } catch (error) {
                console.error("Error initializing Firebase:", error);
                document.getElementById('user-info').textContent = `Kesalahan: Gagal menginisialisasi Firebase. Cek konsol.`;
            }
        };

        const handleLogout = async () => {
            try {
                await signOut(auth);
                // Setelah logout, onAuthStateChanged akan dipanggil, dan user akan sign in anonim/custom token lagi
            } catch (error) {
                console.error("Error during logout:", error);
            }
        };

        document.getElementById('logout-btn').addEventListener('click', handleLogout);

        // --- TAB/NAVIGASI LOGIC ---

        const tabButtons = document.querySelectorAll('.tab-button');
        const tabContents = document.querySelectorAll('.tab-content');
        let currentModule = 'laporan-koin';

        tabButtons.forEach(button => {
            button.addEventListener('click', () => {
                const target = button.getAttribute('data-target');

                tabButtons.forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');

                tabContents.forEach(content => content.classList.add('hidden'));
                document.getElementById(target).classList.remove('hidden');
                
                currentModule = target;
                
                // Panggil listener/render untuk modul yang baru dibuka jika perlu
                if (isAuthReady) {
                    if (target === 'laporan-tahunan') {
                        renderLaporanTahunan();
                    } else if (target === 'jurnal-umum') {
                        // Jurnal umum akan di-render oleh listener otomatis
                    }
                }
            });
        });

        // --- FIREBASE DATA LISTENERS (onSnapshot) ---

        // MODIFIKASI: Helper untuk mendapatkan filter Bulan-Tahun
        const getMonthYearFilter = (module) => {
            const year = document.getElementById(`filter-tahun-${module}`).value;
            const month = document.getElementById(`filter-bulan-${module}`).value;
            return year && month ? `${year}-${month}` : null;
        };
        
        const setupDataListeners = () => {
            if (!isAuthReady) return;

            // 1. Laporan Koin Listener
            currentKoinUnsubscribe();
            // MODIFIKASI: Menggunakan filter baru
            const dateFilterKoin = getMonthYearFilter('koin'); 
            let qKoin = query(collection(db, collectionPath('laporan_koin_nu')), orderBy('tanggal', 'desc'));

            if (dateFilterKoin) {
                const start = new Date(dateFilterKoin + '-01');
                const end = new Date(start);
                end.setMonth(start.getMonth() + 1);
                qKoin = query(collection(db, collectionPath('laporan_koin_nu')), 
                              where('tanggal', '>=', start.toISOString().substring(0, 10)),
                              where('tanggal', '<', end.toISOString().substring(0, 10)),
                              orderBy('tanggal', 'desc'));
            }

            currentKoinUnsubscribe = onSnapshot(qKoin, (snapshot) => {
                const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderLaporanKoin(data);
            }, (error) => {
                console.error("Error listening to Laporan Koin:", error);
                document.getElementById('tbody-laporan-koin').innerHTML = `<tr><td colspan="11" class="text-center py-4 text-red-500">Gagal memuat data: ${error.message}</td></tr>`;
            });

            // 2. Jurnal Umum Listener
            currentJurnalUnsubscribe();
            // MODIFIKASI: Menggunakan filter baru
            const dateFilterJurnal = getMonthYearFilter('jurnal');
            let qJurnal = query(collection(db, collectionPath('jurnal_umum')), orderBy('tanggal', 'desc'));

            if (dateFilterJurnal) {
                const start = new Date(dateFilterJurnal + '-01');
                const end = new Date(start);
                end.setMonth(start.getMonth() + 1);
                qJurnal = query(collection(db, collectionPath('jurnal_umum')), 
                                where('tanggal', '>=', start.toISOString().substring(0, 10)),
                                where('tanggal', '<', end.toISOString().substring(0, 10)),
                                orderBy('tanggal', 'asc')); // ASC untuk jurnal agar saldo berjalan benar
            } else {
                qJurnal = query(collection(db, collectionPath('jurnal_umum')), orderBy('tanggal', 'asc'));
            }


            currentJurnalUnsubscribe = onSnapshot(qJurnal, async (snapshot) => {
                let data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                // Ambil data Koin bulan ini untuk menghitung otomatis
                // MODIFIKASI: Menggunakan filter baru
                const currentMonth = dateFilterJurnal || new Date().toISOString().substring(0, 7);
                const start = new Date(currentMonth + '-01');
                const end = new Date(start);
                end.setMonth(start.getMonth() + 1);

                const qKoinForJurnal = query(collection(db, collectionPath('laporan_koin_nu')), 
                                            where('tanggal', '>=', start.toISOString().substring(0, 10)),
                                            where('tanggal', '<', end.toISOString().substring(0, 10)));
                
                const koinSnapshot = await getDocs(qKoinForJurnal);
                const koinData = koinSnapshot.docs.map(doc => doc.data());

                renderJurnalUmum(data, koinData, currentMonth);

            }, (error) => {
                console.error("Error listening to Jurnal Umum:", error);
                document.getElementById('tbody-jurnal-umum').innerHTML = `<tr><td colspan="16" class="text-center py-4 text-red-500">Gagal memuat data: ${error.message}</td></tr>`;
            });
            
            // 3. Saldo Awal Listener (untuk Laporan Tahunan)
            currentSaldoUnsubscribe();
            const saldoDocRef = doc(db, collectionPath('laporan_tahunan'), 'saldo_awal_tahun');
            currentSaldoUnsubscribe = onSnapshot(saldoDocRef, (docSnap) => {
                const data = docSnap.exists() ? docSnap.data() : { bank: 0, tunai: 0 };
                document.getElementById('saldo-bank').value = data.bank || 0;
                document.getElementById('saldo-tunai').value = data.tunai || 0;

                // Jika modul laporan tahunan sedang aktif, render ulang
                if (currentModule === 'laporan-tahunan') {
                     renderLaporanTahunan();
                }
            }, (error) => {
                console.error("Error listening to Saldo Awal:", error);
            });
        };

        // --- RENDER FUNCTIONS (omitted for brevity, assume unchanged except for filter handling) ---
        // ... (renderLaporanKoin, renderJurnalUmum, renderLaporanTahunan, renderWajibCell, aggregateMonthlyData remain the same) ...
        
        // Modul 1: Laporan Dana Koin
        const renderLaporanKoin = (data) => {
            const tbody = document.getElementById('tbody-laporan-koin');
            tbody.innerHTML = '';
            
            if (data.length === 0) {
                tbody.innerHTML = `<tr><td colspan="11" class="text-center py-4 text-gray-500">Belum ada data Koin.</td></tr>`;
                return;
            }

            data.sort((a, b) => new Date(b.tanggal) - new Date(a.tanggal)); // Data baru di atas data lama

            data.forEach((item, index) => {
                const total = item.nominal || 0;
                const ranting = Math.round(total * 0.60);
                const petugas = Math.round(total * 0.10);
                const mwc = Math.round(total * 0.25);
                const pc = Math.round(total * 0.05);

                // Pastikan total sama (untuk pembulatan)
                const diff = total - (ranting + petugas + mwc + pc);
                // Tambahkan selisih ke komponen terbesar (Ranting)
                const finalRanting = ranting + diff;

                const row = `
                    <tr class="hover:bg-gray-50">
                        <td class="center-text">${data.length - index}</td>
                        <td>${formatTanggalIndonesia(item.tanggal)}</td>
                        <td>${item.nama_petugas}</td>
                        <td>${item.no_hp || '-'}</td>
                        <td>${item.donatur_kelompok}</td>
                        <td>${item.alamat_rtrw || '-'}</td>
                        <td class="text-right font-semibold">${formatRupiah(total)}</td>
                        <td class="text-right">${formatRupiah(finalRanting)}</td>
                        <td class="text-right">${formatRupiah(petugas)}</td>
                        <td class="text-right">${formatRupiah(mwc)}</td>
                        <td class="text-right">${formatRupiah(pc)}</td>
                        <td class="center-text">
                            <button class="text-blue-500 hover:text-blue-700 mr-2" onclick="window.editKoin('${item.id}', '${item.tanggal}', '${item.nama_petugas}', '${item.no_hp}', '${item.donatur_kelompok}', '${item.alamat_rtrw}', ${total})">
                                <i data-lucide="edit" class="w-4 h-4 inline-block"></i>
                            </button>
                            <button class="text-red-500 hover:text-red-700" onclick="window.deleteKoin('${item.id}', ${total})">
                                <i data-lucide="trash-2" class="w-4 h-4 inline-block"></i>
                            </button>
                        </td>
                    </tr>
                `;
                tbody.insertAdjacentHTML('beforeend', row);
            });
            // Re-render Lucide icons
            lucide.createIcons();
        };

        // Modul 2: Jurnal Umum
        const renderJurnalUmum = async (data, koinData, currentMonth) => {
            const tbody = document.getElementById('tbody-jurnal-umum');
            const tfootMasuk = document.getElementById('total-masuk');
            const tfootKeluar = document.getElementById('total-keluar');
            const tfootSaldo = document.getElementById('saldo-akhir');

            tbody.innerHTML = '';
            
            // 1. Dapatkan Saldo Bulan Lalu (Manual Input)
            let saldoBulanLaluValue = 0;
            const saldoRef = doc(db, collectionPath('jurnal_umum'), currentMonth); // Saldo disimpan per bulan
            
            try {
                const saldoSnap = await getDoc(saldoRef);
                if (saldoSnap.exists()) {
                    saldoBulanLaluValue = saldoSnap.data().saldo_awal_bulan || 0;
                }
            } catch (e) {
                console.error("Gagal mendapatkan Saldo Bulan Lalu:", e);
            }

            // 2. Hitung Total Koin Bulan Ini dan Distribusi Otomatis
            const totalKoin = koinData.reduce((sum, k) => sum + (k.nominal || 0), 0);
            const petugas = Math.round(totalKoin * 0.10);
            const mwc = Math.round(totalKoin * 0.25);
            const pc = Math.round(totalKoin * 0.05);

            // 3. Tambahkan 5 Baris Otomatis/Manual di Awal
            let manualRows = [];
            let rowNoCounter = 1;
            let currentSaldo = 0;
            let totalDanaMasuk = 0;
            let totalDanaKeluar = 0;
            
            // Baris 1: Saldo Bulan Lalu (Manual Input, bisa di edit)
            currentSaldo += saldoBulanLaluValue;
            manualRows.push({
                id: currentMonth,
                keterangan: 'SALDO BULAN LALU (Input Manual)',
                dana_masuk: saldoBulanLaluValue,
                dana_keluar: 0,
                kategori: 'SALDO',
                aksi: `<button class="text-yellow-500 hover:text-yellow-700" onclick="window.editSaldoBulanLalu('${currentMonth}', ${saldoBulanLaluValue})"><i data-lucide="edit" class="w-4 h-4 inline-block"></i></button>`,
                saldo: currentSaldo,
                isManual: true,
                style: 'bg-yellow-100 font-bold'
            });
            totalDanaMasuk += saldoBulanLaluValue;

            // Baris 2: Total Penerimaan Koin (Dana Masuk Otomatis)
            currentSaldo += totalKoin;
            manualRows.push({
                keterangan: 'Total Penerimaan Koin',
                dana_masuk: totalKoin,
                dana_keluar: 0,
                kategori: 'Koin NU',
                aksi: 'Otomatis',
                saldo: currentSaldo,
                isManual: false,
                style: 'bg-green-100 font-bold'
            });
            totalDanaMasuk += totalKoin;

            // Baris 3-5: Dana Keluar Distribusi Koin (Otomatis)
            // Petugas 10%
            currentSaldo -= petugas;
            manualRows.push({
                keterangan: 'Petugas 10%',
                dana_masuk: 0,
                dana_keluar: petugas,
                kategori: 'Petugas 10%',
                aksi: 'Otomatis',
                saldo: currentSaldo,
                isManual: false,
                style: 'bg-red-100'
            });
            totalDanaKeluar += petugas;

            // MWC 25%
            currentSaldo -= mwc;
            manualRows.push({
                keterangan: 'MWC 25%',
                dana_masuk: 0,
                dana_keluar: mwc,
                kategori: 'MWC 25%',
                aksi: 'Otomatis',
                saldo: currentSaldo,
                isManual: false,
                style: 'bg-red-100'
            });
            totalDanaKeluar += mwc;

            // PC 5%
            currentSaldo -= pc;
            manualRows.push({
                keterangan: 'PC 5%',
                dana_masuk: 0,
                dana_keluar: pc,
                kategori: 'PC 5%',
                aksi: 'Otomatis',
                saldo: currentSaldo,
                isManual: false,
                style: 'bg-red-100'
            });
            totalDanaKeluar += pc;
            
            // Tampilkan baris-baris manual
            manualRows.forEach(row => {
                const penerimaHtml = `
                    <td>-</td>
                    <td>-</td>
                    <td>-</td>
                    <td>-</td>
                    <td>-</td>
                    <td>-</td>
                    <td>-</td>
                `;
                const rowHtml = `
                    <tr class="${row.style}">
                        <td class="center-text">-</td>
                        <td class="center-text">-</td>
                        <td>${row.keterangan}</td>
                        ${penerimaHtml}
                        <td>${row.kategori}</td>
                        <td class="text-right">${formatRupiah(row.dana_masuk)}</td>
                        <td class="text-right">${formatRupiah(row.dana_keluar)}</td>
                        <td class="text-right">${formatRupiah(row.saldo)}</td>
                        <td class="center-text">${row.aksi}</td>
                    </tr>
                `;
                tbody.insertAdjacentHTML('beforeend', rowHtml);
            });
            
            // 4. Tampilkan Baris Jurnal Manual (Mulai Penomoran dari Baris ke-6)
            data.sort((a, b) => new Date(a.tanggal) - new Date(b.tanggal)); // Urutkan ASC untuk saldo berjalan

            data.forEach((item) => {
                const masuk = item.dana_masuk || 0;
                const keluar = item.dana_keluar || 0;
                
                // Hitung saldo berjalan
                currentSaldo += masuk - keluar;
                totalDanaMasuk += masuk;
                totalDanaKeluar += keluar;

                const penerimaObj = item.jumlah_penerima || {};
                const penerimaHtml = `
                    <td class="center-text">${penerimaObj.donatur || '-'}</td>
                    <td class="center-text">${penerimaObj.pendidikan || '-'}</td>
                    <td class="center-text">${penerimaObj.kesehatan || '-'}</td>
                    <td class="center-text">${penerimaObj.ekonomi || '-'}</td>
                    <td class="center-text">${penerimaObj.sosial || '-'}</td>
                    <td class="center-text">${penerimaObj.subsidi || '-'}</td>
                    <td class="center-text">${penerimaObj.bencana || '-'}</td>
                `;

                const row = `
                    <tr class="hover:bg-gray-50">
                        <td class="center-text">${rowNoCounter++}</td>
                        <td>${formatTanggalIndonesia(item.tanggal)}</td>
                        <td>${item.keterangan}</td>
                        ${penerimaHtml}
                        <td>${item.kategori}</td>
                        <td class="text-right">${item.jenis_transaksi === 'MASUK' ? formatRupiah(masuk) : ''}</td>
                        <td class="text-right">${item.jenis_transaksi === 'KELUAR' ? formatRupiah(keluar) : ''}</td>
                        <td class="text-right font-semibold">${formatRupiah(currentSaldo)}</td>
                        <td class="center-text">
                            <button class="text-blue-500 hover:text-blue-700 mr-2" onclick="window.editJurnal('${item.id}', '${item.tanggal}', '${item.keterangan}', '${item.jenis_transaksi}', '${item.kategori}', ${masuk > 0 ? masuk : keluar}, '${JSON.stringify(penerimaObj).replace(/"/g, '&quot;')}')">
                                <i data-lucide="edit" class="w-4 h-4 inline-block"></i>
                            </button>
                            <button class="text-red-500 hover:text-red-700" onclick="window.deleteJurnal('${item.id}')">
                                <i data-lucide="trash-2" class="w-4 h-4 inline-block"></i>
                            </button>
                        </td>
                    </tr>
                `;
                tbody.insertAdjacentHTML('beforeend', row);
            });
            
            // 5. Update Footer (Total dan Saldo Akhir)
            tfootMasuk.textContent = formatRupiah(totalDanaMasuk);
            tfootKeluar.textContent = formatRupiah(totalDanaKeluar);
            tfootSaldo.textContent = formatRupiah(currentSaldo);

            // Re-render Lucide icons
            lucide.createIcons();
        };

        // Modul 3: Laporan Tahunan
        const renderLaporanTahunan = async () => {
            if (!isAuthReady) return;

            const tbody = document.getElementById('tbody-laporan-tahunan');
            tbody.innerHTML = '';
            
            const selectedYear = document.getElementById('filter-tahun').value;
            if (!selectedYear) {
                tbody.innerHTML = `<tr><td colspan="23" class="text-center py-4 text-gray-500">Pilih Tahun untuk memuat laporan.</td></tr>`;
                return;
            }

            // 1. Dapatkan Saldo Awal Tahun
            const saldoAwalDoc = await getDoc(doc(db, collectionPath('laporan_tahunan'), 'saldo_awal_tahun'));
            const saldoAwal = saldoAwalDoc.exists() ? saldoAwalDoc.data() : { bank: 0, tunai: 0 };
            const totalSaldoAwal = (saldoAwal.bank || 0) + (saldoAwal.tunai || 0);

            // 2. Query data Jurnal Umum untuk tahun terpilih
            const startYear = new Date(`${selectedYear}-01-01`);
            const endYear = new Date(`${parseInt(selectedYear) + 1}-01-01`);

            const qJurnalTahunan = query(
                collection(db, collectionPath('jurnal_umum')),
                where('tanggal', '>=', startYear.toISOString().substring(0, 10)),
                where('tanggal', '<', endYear.toISOString().substring(0, 10)),
                orderBy('tanggal', 'asc')
            );
            const jurnalSnapshot = await getDocs(qJurnalTahunan);
            const jurnalData = jurnalSnapshot.docs.map(doc => doc.data());

            // 3. Agregasi data per bulan
            const monthlyData = aggregateMonthlyData(jurnalData, selectedYear);

            // 4. Hitung Saldo Koin per bulan (Total Penerimaan Koin)
            const qKoinTahunan = query(
                collection(db, collectionPath('laporan_koin_nu')),
                where('tanggal', '>=', startYear.toISOString().substring(0, 10)),
                where('tanggal', '<', endYear.toISOString().substring(0, 10))
            );
            const koinSnapshot = await getDocs(qKoinTahunan);
            koinSnapshot.docs.forEach(doc => {
                const koin = doc.data();
                const monthKey = new Date(koin.tanggal).toISOString().substring(0, 7);
                const monthIndex = parseInt(monthKey.substring(5, 7)) - 1;
                if (monthlyData[monthIndex]) {
                    monthlyData[monthIndex].penerimaan.koin += koin.nominal || 0;
                }
            });


            // 5. Render Baris Saldo Awal
            let runningSaldoTahunan = totalSaldoAwal;
            const months = ['Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni', 'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'];
            
            // Baris Saldo Kas Bank/Tunai (Manual Input)
            tbody.insertAdjacentHTML('beforeend', `
                <tr class="bg-yellow-100 font-bold">
                    <td class="center-text">1</td>
                    <td>SALDO KAS BANK</td>
                    <td class="text-right">${formatRupiah(saldoAwal.bank)}</td>
                    <td colspan="19"></td>
                    <td class="text-right">${formatRupiah(totalSaldoAwal)}</td>
                </tr>
                <tr class="bg-yellow-100 font-bold">
                    <td class="center-text">2</td>
                    <td>SALDO KAS TUNAI</td>
                    <td class="text-right">${formatRupiah(saldoAwal.tunai)}</td>
                    <td colspan="19"></td>
                    <td class="text-right">${formatRupiah(totalSaldoAwal)}</td>
                </tr>
            `);


            // 6. Render Data Bulanan
            let rowCounter = 3;
            monthlyData.forEach((month, index) => {
                const totalPenerimaan = month.penerimaan.koin + month.penerimaan.non_koin;
                const totalPengeluaran = month.pengeluaran.wajib.total + month.pengeluaran.lain_lain.total;
                const saldoAkhirBulan = totalPenerimaan - totalPengeluaran;
                
                runningSaldoTahunan += saldoAkhirBulan;

                const dataHtml = `
                    <tr class="hover:bg-gray-50">
                        <td class="center-text">${rowCounter++}</td>
                        <td>${months[index]}</td>
                        <td class="text-right font-semibold text-green-600">${formatRupiah(totalPenerimaan)}</td>

                        ${renderWajibCell(month.pengeluaran.wajib.Pendidikan)}
                        ${renderWajibCell(month.pengeluaran.wajib.Kesehatan)}
                        ${renderWajibCell(month.pengeluaran.wajib.Ekonomi)}
                        ${renderWajibCell(month.pengeluaran.wajib.Sosial)}
                        ${renderWajibCell(month.pengeluaran.wajib.Bencana)}

                        <td class="text-right">${formatRupiah(month.pengeluaran.wajib.Subsidi)}</td>
                        <td class="text-right">${formatRupiah(month.pengeluaran.wajib.Petugas)}</td>
                        <td class="text-right">${formatRupiah(month.pengeluaran.wajib.MWC)}</td>
                        <td class="text-right">${formatRupiah(month.pengeluaran.wajib.PC)}</td>

                        <td class="text-right">${formatRupiah(month.pengeluaran.lain_lain.Rapat)}</td>
                        <td class="text-right">${formatRupiah(month.pengeluaran.lain_lain.PERWTN_MLU)}</td>
                        <td class="text-right">${formatRupiah(month.pengeluaran.lain_lain.BIAYA_REK_BANK)}</td>
                        <td class="text-right">${formatRupiah(month.pengeluaran.lain_lain.Lain_Lain)}</td>
                        
                        <td class="text-right font-bold text-red-600">${formatRupiah(totalPengeluaran)}</td>
                        <td class="text-right font-bold">${formatRupiah(saldoAkhirBulan)}</td>
                        <td class="text-right font-bold text-green-700">${formatRupiah(runningSaldoTahunan)}</td>
                    </tr>
                `;
                tbody.insertAdjacentHTML('beforeend', dataHtml);
            });
        };

        const renderWajibCell = (data) => {
            return `
                <td class="text-right">${formatRupiah(data.uang)}</td>
                <td class="center-text">${data.penerima}</td>
            `;
        };

        const aggregateMonthlyData = (jurnalData, year) => {
            const months = Array(12).fill(0).map((_, i) => {
                const monthObj = {
                    penerimaan: { koin: 0, non_koin: 0 },
                    pengeluaran: {
                        wajib: {
                            Pendidikan: { uang: 0, penerima: 0 },
                            Kesehatan: { uang: 0, penerima: 0 },
                            Ekonomi: { uang: 0, penerima: 0 },
                            Sosial: { uang: 0, penerima: 0 },
                            Bencana: { uang: 0, penerima: 0 },
                            Subsidi: 0,
                            Petugas: 0,
                            MWC: 0,
                            PC: 0,
                            total: 0
                        },
                        lain_lain: {
                            Rapat: 0, PERWTN_MLU: 0, BIAYA_REK_BANK: 0, Lain_Lain: 0, total: 0
                        }
                    }
                };
                return monthObj;
            });

            jurnalData.forEach(item => {
                const date = new Date(item.tanggal);
                if (date.getFullYear().toString() === year) {
                    const monthIndex = date.getMonth();
                    const month = months[monthIndex];

                    const masuk = item.dana_masuk || 0;
                    const keluar = item.dana_keluar || 0;
                    const kategori = item.kategori;
                    const penerima = item.jumlah_penerima || {};

                    // DANA MASUK
                    if (item.jenis_transaksi === 'MASUK') {
                        // Koin NU akan dihitung di luar agregasi ini (step 4 di renderLaporanTahunan)
                        if (kategori !== 'Koin NU' && kategori !== 'SALDO') {
                            month.penerimaan.non_koin += masuk;
                        }
                    }

                    // DANA KELUAR
                    if (item.jenis_transaksi === 'KELUAR') {
                        // Pengeluaran Wajib
                        if (kategori.startsWith('Untuk ')) {
                            const field = kategori.replace('Untuk ', '');
                            month.pengeluaran.wajib[field].uang += keluar;
                            month.pengeluaran.wajib[field].penerima += Object.values(penerima).reduce((sum, val) => sum + (parseInt(val) || 0), 0);
                            month.pengeluaran.wajib.total += keluar;
                        } else if (kategori === 'Subsidi Banom dan Lembaga NU') {
                            month.pengeluaran.wajib.Subsidi += keluar;
                            month.pengeluaran.wajib.total += keluar;
                        } else if (kategori === 'Petugas 10%') {
                            month.pengeluaran.wajib.Petugas += keluar;
                            month.pengeluaran.wajib.total += keluar;
                        } else if (kategori === 'MWC 25%') {
                            month.pengeluaran.wajib.MWC += keluar;
                            month.pengeluaran.wajib.total += keluar;
                        } else if (kategori === 'PC 5%') {
                            month.pengeluaran.wajib.PC += keluar;
                            month.pengeluaran.wajib.total += keluar;
                        }
                        
                        // Pengeluaran Lain-lain
                        else if (kategori === 'Rapat') {
                            month.pengeluaran.lain_lain.Rapat += keluar;
                            month.pengeluaran.lain_lain.total += keluar;
                        } else if (kategori === 'PERWTN MLU') {
                            month.pengeluaran.lain_lain.PERWTN_MLU += keluar;
                            month.pengeluaran.lain_lain.total += keluar;
                        } else if (kategori === 'BIAYA REK BANK') {
                            month.pengeluaran.lain_lain.BIAYA_REK_BANK += keluar;
                            month.pengeluaran.lain_lain.total += keluar;
                        } else if (kategori === 'Lain - Lain') {
                            month.pengeluaran.lain_lain.Lain_Lain += keluar;
                            month.pengeluaran.lain_lain.total += keluar;
                        }
                    }
                }
            });

            return months;
        };
        // --- END RENDER FUNCTIONS ---


        // --- CRUD Koin (omitted for brevity, assume unchanged) ---
        // ... (editKoin, koin-cancel-btn listener, deleteKoin, form-laporan-koin listener remain the same) ...

        window.editKoin = (id, tanggal, petugas, nohp, donatur, alamat, nominal) => {
            document.getElementById('koin-doc-id').value = id;
            document.getElementById('koin-tanggal').value = tanggal;
            document.getElementById('koin-petugas').value = petugas;
            document.getElementById('koin-nohp').value = nohp;
            document.getElementById('koin-donatur').value = donatur;
            document.getElementById('koin-alamat').value = alamat;
            document.getElementById('koin-nominal').value = nominal;
            document.getElementById('koin-submit-btn').textContent = 'Update Data Koin';
            document.getElementById('koin-cancel-btn').classList.remove('hidden');
        };

        document.getElementById('koin-cancel-btn').addEventListener('click', () => {
            document.getElementById('form-laporan-koin').reset();
            document.getElementById('koin-doc-id').value = '';
            document.getElementById('koin-submit-btn').textContent = 'Tambah Data Koin';
            document.getElementById('koin-cancel-btn').classList.add('hidden');
        });

        window.deleteKoin = async (id, nominal) => {
            if (!confirm(`Yakin ingin menghapus data koin nominal ${formatRupiah(nominal)}? Tindakan ini akan menghapus data di Jurnal Umum juga.`)) return;
            
            try {
                // Hapus dokumen di laporan_koin_nu
                await deleteDoc(doc(db, collectionPath('laporan_koin_nu'), id));
                
                // Cari dan hapus entri Jurnal Umum yang dibuat otomatis oleh entri koin ini (jika ada)
                const q = query(collection(db, collectionPath('jurnal_umum')), 
                                where('source_koin_id', '==', id));
                
                const docsToDelete = await getDocs(q);
                docsToDelete.forEach(async (docSnapshot) => {
                    await deleteDoc(docSnapshot.ref);
                });

                alert('Data Koin berhasil dihapus.');
            } catch (e) {
                console.error("Error deleting Koin:", e);
                alert('Gagal menghapus data koin. Cek konsol.');
            }
        };

        document.getElementById('form-laporan-koin').addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('koin-doc-id').value;
            const tanggal = document.getElementById('koin-tanggal').value;
            const nama_petugas = document.getElementById('koin-petugas').value;
            const no_hp = document.getElementById('koin-nohp').value;
            const donatur_kelompok = document.getElementById('koin-donatur').value;
            const alamat_rtrw = document.getElementById('koin-alamat').value;
            const nominal = parseInt(document.getElementById('koin-nominal').value);

            const docData = {
                tanggal: tanggal,
                nama_petugas: nama_petugas,
                no_hp: no_hp,
                donatur_kelompok: donatur_kelompok,
                alamat_rtrw: alamat_rtrw,
                nominal: nominal,
                timestamp: serverTimestamp()
            };

            try {
                if (id) {
                    await updateDoc(doc(db, collectionPath('laporan_koin_nu'), id), docData);
                    alert('Data Koin berhasil diperbarui.');
                } else {
                    await addDoc(collection(db, collectionPath('laporan_koin_nu')), docData);
                    alert('Data Koin berhasil ditambahkan.');
                }
                
                document.getElementById('koin-cancel-btn').click(); // Reset form
            } catch (e) {
                console.error("Error saving Koin:", e);
                alert('Gagal menyimpan data koin. Cek konsol.');
            }
        });


        // --- CRUD Jurnal Umum (Manual Entry) (omitted for brevity, assume unchanged) ---
        // ... (editJurnal, jurnal-cancel-btn listener, deleteJurnal, form-jurnal-umum listener remain the same) ...

        window.editJurnal = (id, tanggal, keterangan, jenis, kategori, nominal, penerimaJsonString) => {
            document.getElementById('jurnal-doc-id').value = id;
            document.getElementById('jurnal-tanggal').value = tanggal;
            document.getElementById('jurnal-keterangan').value = keterangan;
            document.getElementById('jurnal-jenis').value = jenis;
            document.getElementById('jurnal-kategori').value = kategori;
            document.getElementById('jurnal-nominal').value = nominal;
            
            // Konversi JSON string kembali ke format textarea
            try {
                const penerimaObj = JSON.parse(penerimaJsonString.replace(/&quot;/g, '"'));
                document.getElementById('jurnal-penerima').value = JSON.stringify(penerimaObj);
            } catch (e) {
                console.error("Error parsing JSON for edit:", e);
                document.getElementById('jurnal-penerima').value = '';
            }

            document.getElementById('jurnal-submit-btn').textContent = 'Update Data Jurnal';
            document.getElementById('jurnal-cancel-btn').classList.remove('hidden');
        };

        document.getElementById('jurnal-cancel-btn').addEventListener('click', () => {
            document.getElementById('form-jurnal-umum').reset();
            document.getElementById('jurnal-doc-id').value = '';
            document.getElementById('jurnal-submit-btn').textContent = 'Tambah Data Jurnal';
            document.getElementById('jurnal-cancel-btn').classList.add('hidden');
        });
        
        window.deleteJurnal = async (id) => {
            if (!confirm(`Yakin ingin menghapus entri Jurnal Umum ini?`)) return;
            try {
                await deleteDoc(doc(db, collectionPath('jurnal_umum'), id));
                alert('Entri Jurnal Umum berhasil dihapus.');
            } catch (e) {
                console.error("Error deleting Jurnal:", e);
                alert('Gagal menghapus entri jurnal. Cek konsol.');
            }
        };

        document.getElementById('form-jurnal-umum').addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('jurnal-doc-id').value;
            const tanggal = document.getElementById('jurnal-tanggal').value;
            const keterangan = document.getElementById('jurnal-keterangan').value;
            const jenis_transaksi = document.getElementById('jurnal-jenis').value;
            const kategori = document.getElementById('jurnal-kategori').value;
            const nominal = parseInt(document.getElementById('jurnal-nominal').value);
            const penerimaText = document.getElementById('jurnal-penerima').value.trim();

            let dana_masuk = jenis_transaksi === 'MASUK' ? nominal : 0;
            let dana_keluar = jenis_transaksi === 'KELUAR' ? nominal : 0;
            let jumlah_penerima = {};

            if (penerimaText) {
                try {
                    jumlah_penerima = JSON.parse(penerimaText);
                } catch (err) {
                    alert('Format Jumlah Penerima (JSON) tidak valid.');
                    return;
                }
            }

            const docData = {
                tanggal: tanggal,
                keterangan: keterangan,
                jenis_transaksi: jenis_transaksi,
                kategori: kategori,
                dana_masuk: dana_masuk,
                dana_keluar: dana_keluar,
                jumlah_penerima: jumlah_penerima,
                timestamp: serverTimestamp()
            };

            try {
                if (id) {
                    await updateDoc(doc(db, collectionPath('jurnal_umum'), id), docData);
                    alert('Data Jurnal berhasil diperbarui.');
                } else {
                    await addDoc(collection(db, collectionPath('jurnal_umum')), docData);
                    alert('Data Jurnal berhasil ditambahkan.');
                }
                
                document.getElementById('jurnal-cancel-btn').click(); // Reset form
            } catch (e) {
                console.error("Error saving Jurnal:", e);
                alert('Gagal menyimpan data jurnal. Cek konsol.');
            }
        });
        
        // --- CRUD Saldo Bulan Lalu (Baris Otomatis Jurnal Umum) (omitted for brevity, assume unchanged) ---
        // ... (editSaldoBulanLalu remains the same) ...

        window.editSaldoBulanLalu = async (monthKey, currentSaldo) => {
            const newSaldo = prompt(`Masukkan Saldo Bulan Lalu untuk ${monthKey} (saat ini: ${formatRupiah(currentSaldo)}):`);
            if (newSaldo === null) return;

            const numericSaldo = parseInt(newSaldo.replace(/\D/g, '')) || 0;
            const saldoRef = doc(db, collectionPath('jurnal_umum'), monthKey);

            try {
                await setDoc(saldoRef, { saldo_awal_bulan: numericSaldo, keterangan: 'SALDO BULAN LALU (Manual Input)' }, { merge: true });
                alert(`Saldo Awal Bulan ${monthKey} berhasil diperbarui.`);
            } catch (e) {
                console.error("Error updating Saldo Bulan Lalu:", e);
                alert('Gagal memperbarui saldo awal bulan. Cek konsol.');
            }
        };


        // --- FORM SALDO AWAL TAHUN (Laporan Tahunan) (omitted for brevity, assume unchanged) ---
        // ... (edit-saldo-awal listener, form-saldo-awal listener remain the same) ...
        document.getElementById('edit-saldo-awal').addEventListener('click', () => {
            document.getElementById('saldo-awal-input').classList.toggle('hidden');
        });
        
        document.getElementById('form-saldo-awal').addEventListener('submit', async (e) => {
            e.preventDefault();
            const bank = parseInt(document.getElementById('saldo-bank').value) || 0;
            const tunai = parseInt(document.getElementById('saldo-tunai').value) || 0;
            
            const docRef = doc(db, collectionPath('laporan_tahunan'), 'saldo_awal_tahun');

            try {
                await setDoc(docRef, { bank, tunai, last_updated: serverTimestamp() });
                alert('Saldo Awal Tahun berhasil disimpan.');
                document.getElementById('saldo-awal-input').classList.add('hidden');
            } catch (e) {
                console.error("Error saving Saldo Awal Tahun:", e);
                alert('Gagal menyimpan Saldo Awal Tahun. Cek konsol.');
            }
        });
        
        // --- FILTER & HELPER ---

        // MODIFIKASI: Fungsi baru untuk mengisi dropdown Bulan
        const populateMonthFilter = () => {
            const months = [
                { value: '01', text: 'Januari' }, { value: '02', text: 'Februari' }, { value: '03', text: 'Maret' },
                { value: '04', text: 'April' }, { value: '05', text: 'Mei' }, { value: '06', text: 'Juni' },
                { value: '07', text: 'Juli' }, { value: '08', text: 'Agustus' }, { value: '09', text: 'September' },
                { value: '10', text: 'Oktober' }, { value: '11', text: 'November' }, { value: '12', text: 'Desember' }
            ];
            const currentMonth = new Date().toISOString().substring(5, 7); // MM

            const koinSelect = document.getElementById('filter-bulan-koin');
            const jurnalSelect = document.getElementById('filter-bulan-jurnal');
            
            [koinSelect, jurnalSelect].forEach(select => {
                select.innerHTML = '';
                months.forEach(month => {
                    const option = document.createElement('option');
                    option.value = month.value;
                    option.textContent = month.text;
                    select.appendChild(option);
                });
                select.value = currentMonth;
            });
            
            // Tambahkan listener untuk filter bulan yang baru
            koinSelect.addEventListener('change', setupDataListeners);
            jurnalSelect.addEventListener('change', setupDataListeners);
        };
        
        // MODIFIKASI: Fungsi yang dimodifikasi untuk mengisi dropdown Tahun
        const populateYearFilter = () => {
            const currentYear = new Date().getFullYear();
            const yearSelects = [
                document.getElementById('filter-tahun'),
                document.getElementById('filter-tahun-koin'), // Tambahan untuk Koin
                document.getElementById('filter-tahun-jurnal') // Tambahan untuk Jurnal Umum
            ];

            yearSelects.forEach(select => {
                if (!select) return;
                select.innerHTML = '';
                for (let i = currentYear; i >= 2020; i--) {
                    const option = document.createElement('option');
                    option.value = i;
                    option.textContent = i;
                    select.appendChild(option);
                }
                select.value = currentYear;
            });

            // Tambahkan listener untuk filter tahun yang baru
            document.getElementById('filter-tahun').addEventListener('change', renderLaporanTahunan);
            document.getElementById('filter-tahun-koin').addEventListener('change', setupDataListeners);
            document.getElementById('filter-tahun-jurnal').addEventListener('change', setupDataListeners);

            renderLaporanTahunan(); // Initial render for annual report
        };
        
        // PDF Download (Placeholder)
        document.getElementById('download-koin-pdf').addEventListener('click', () => {
            alert('Fungsi Unduh PDF belum diimplementasikan. Anda akan membutuhkan pustaka pihak ketiga (misalnya jsPDF atau html2canvas) untuk menghasilkan PDF dengan tanda tangan.');
        });
        
        // Reset Data (Placeholder - Modul Jurnal)
        document.getElementById('reset-data-jurnal').addEventListener('click', () => {
            alert('Fungsi "Reset Data" (Manual) harus dilakukan dengan sangat hati-hati dan memerlukan konfirmasi berlapis. Saat ini tidak diimplementasikan untuk mencegah kehilangan data yang tidak disengaja. Untuk mereset, hapus data secara manual per bulan.');
        });

        // --- START APP ---
        window.onload = initFirebase;
    </script>
</body>
</html>
