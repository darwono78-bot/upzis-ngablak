<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Pembukuan UPZIS | Ranting Ngablak</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.1.0/firebase-app.js";
        import { getFirestore, collection, getDocs, doc, setDoc, deleteDoc, getDoc, query, where, orderBy, updateDoc } from "https://www.gstatic.com/firebasejs/9.1.0/firebase-firestore.js";
        
        // --- KONFIGURASI FIREBASE ANDA ---
        const firebaseConfig = {
            apiKey: "AIzaSyA_8NMmZBaXZ4H6KQt7rHy8G1URR3HLP3A",
            authDomain: "upzis-ngablak.firebaseapp.com",
            projectId: "upzis-ngablak",
            storageBucket: "upzis-ngablak.firebasestorage.app",
            messagingSenderId: "869549648344",
            appId: "1:869549648344:web:a531a37cce3a87bb672aad"
        };
        
        // Inisialisasi Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // --- KONSTANTA NAMA KOLEKSI (DARI ANDA) ---
        const COL_KOIN = 'laporan_koin_nu';
        const COL_JURNAL = 'jurnal_umum';
        // --- KONSTANTA BARU UNTUK LAPORAN TAHUNAN (ASUMSI NAMA KOLEKSI) ---
        const COL_TAHUNAN = 'laporan_tahunan'; 
        
        // Variabel Global (dipertahankan agar alur logika lain tidak rusak)
        let allKoinData = [];
        let allJurnalData = [];
        let allTahunanData = []; // Data Laporan Tahunan disimpan di sini
        
        // ====================================================================
        // FUNGSI UMUM: LOAD SEMUA DATA (Disimpan ke variabel global)
        // ====================================================================
        
        const loadAllCollections = async () => {
            console.log('Memuat semua koleksi dari Firebase...');
            try {
                // 1. Ambil Laporan Koin NU
                const koinSnap = await getDocs(collection(db, COL_KOIN));
                allKoinData = koinSnap.docs.map(d => ({ id: d.id, ...d.data() }));

                // 2. Ambil Jurnal Umum
                const jurnalSnap = await getDocs(query(collection(db, COL_JURNAL), orderBy('tanggal', 'desc')));
                allJurnalData = jurnalSnap.docs.map(d => ({ id: d.id, ...d.data() }));
                
                // 3. Ambil Laporan Tahunan (WAJIB DIAMBIL UNTUK BARIS EDIT MANUAL)
                const tahunanSnap = await getDocs(collection(db, COL_TAHUNAN));
                allTahunanData = tahunanSnap.docs.map(d => ({ id: d.id, ...d.data() }));

                console.log('Data berhasil dimuat. Koin:', allKoinData.length, 'Jurnal:', allJurnalData.length, 'Tahunan:', allTahunanData.length);
                
                // Panggil ulang fungsi rendering setelah data global terisi
                renderLaporanTahunan(); 
            } catch (e) {
                console.error("Gagal memuat koleksi:", e);
                alert('Gagal memuat data dari Firebase: ' + e.message);
            }
        };

        // ====================================================================
        // FUNGSI KHUSUS: EDIT MANUAL LAPORAN TAHUNAN (PERBAIKAN KRITIS)
        // ====================================================================

        /**
         * FUNGSI PERBAIKAN: Mengambil data Laporan Tahunan spesifik dari Firebase.
         * @param {string} recordId - ID unik dokumen Firebase dari baris yang diklik.
         */
        window.editManual = async (recordId) => {
            console.log('Mencoba mengedit ID:', recordId);
            
            // 1. Validasi ID (Menghindari pop-up "data tidak ditemukan" jika ID kosong)
            if (!recordId || typeof recordId !== 'string' || recordId.length < 5) {
                alert('Error: ID data tidak valid. Logika ID lama ditemukan.');
                return;
            }

            try {
                // 2. Gunakan getDoc() untuk mengambil dokumen spesifik
                const docRef = doc(db, COL_TAHUNAN, recordId); // Referensi ke koleksi & ID
                const docSnap = await getDoc(docRef);          
                
                if (docSnap.exists()) {
                    const dataToEdit = docSnap.data();
                    
                    // --- MENGISI FORM INPUT (Memperbaiki masalah nama baris tidak muncul) ---
                    // Asumsi: form Anda memiliki ID 'form-edit-tahunan'
                    // Asumsi: input nama baris Anda memiliki ID 'edit-nama-baris'
                    // Asumsi: input nilai Anda memiliki ID 'edit-nilai'
                    // Asumsi: hidden input untuk ID memiliki ID 'edit-firebase-id'

                    // **MEMPERBAIKI MASALAH: NAMA BARIS TIDAK MUNCUL**
                    document.getElementById('edit-nama-baris').value = dataToEdit.nama_item || 'Baris Manual';
                    document.getElementById('edit-nilai').value = dataToEdit.kolom_3 || 0; // Kolom 3 adalah yang diedit
                    document.getElementById('edit-firebase-id').value = docSnap.id;
                    
                    // Tampilkan pop-up/modal form input Anda
                    document.getElementById('modal-edit-tahunan').style.display = 'block'; 
                    
                    console.log("Data berhasil diambil:", dataToEdit);
                } else {
                    // Pop-up "Data tidak ditemukan" karena ID valid tapi dokumen hilang
                    alert("Data tidak ditemukan di Firebase! (Dokumen tidak ada)"); 
                }
            } catch (error) {
                console.error("Gagal mengambil data edit:", error);
                alert("Terjadi kesalahan sistem: " + error.message);
            }
        };

        // ====================================================================
        // FUNGSI KHUSUS: RENDERING LAPORAN TAHUNAN (PERBAIKAN KRITIS)
        // ====================================================================
        
        /**
         * FUNGSI PERBAIKAN: Memastikan Baris 1 & 2 menggunakan ID Firebase yang benar.
         */
        const renderLaporanTahunan = () => {
            const tabelBody = document.getElementById('tabel-laporan-tahunan-body');
            let htmlContent = '';

            // --- Logika untuk Baris 1 dan Baris 2 yang BISA DIEDIT MANUAL ---
            const barisManual = allTahunanData.filter(item => item.tipe_input === 'manual'); // Asumsi ada field 'tipe_input'

            barisManual.forEach(item => {
                // **PENTING: MENGGUNAKAN item.id (ID FIREBASE) DI ONCLICK**
                htmlContent += `
                    <tr>
                        <td>${item.nama_item}</td>
                        <td>${item.kolom_1 || 0}</td>
                        <td>${item.kolom_2 || 0}</td>
                        <td onclick="editManual('${item.id}')">${item.kolom_3 || 0}</td> 
                    </tr>
                `;
            });

            // --- Logika untuk Baris Lainnya (otomatis / hasil hitungan) ---
            const barisOtomatis = allTahunanData.filter(item => item.tipe_input !== 'manual');
            barisOtomatis.forEach(item => {
                // Baris ini tidak memiliki onclick atau menggunakan fungsi yang berbeda
                htmlContent += `
                    <tr>
                        <td>${item.nama_item}</td>
                        <td colspan="3">${item.nilai_otomatis}</td> 
                    </tr>
                `;
            });
            
            tabelBody.innerHTML = htmlContent;
        };


        // ====================================================================
        // FUNGSI LAIN (Contoh dari file Anda, dipertahankan)
        // ====================================================================
        
        const deleteAllData = async (module) => {
            if (window.confirm && !confirm('Anda harus memiliki hak admin untuk melakukan aksi ini.')) return;
            if (!confirm('Yakin ingin menghapus SEMUA DATA pada modul ini? Tindakan ini tidak bisa dibatalkan.')) return;

            try {
                // Logika penghapusan data... (tidak diubah)
            } catch(e){ 
                console.error(e); 
                alert('Gagal menghapus semua data: '+e.message); 
            }
        };

        // Load initial data on page ready
        window.addEventListener('DOMContentLoaded', async () => {
            await loadAllCollections();
            // ... fungsi inisialisasi lainnya
        });
        
        // ... (Fungsi Jurnal Umum, Koin NU lainnya)
        
    </script>
    <style>
        /* Gaya CSS untuk Tampilan */
        /* ... Gaya Anda yang sudah ada ... */
    </style>
</head>
<body>
    <div id="modal-edit-tahunan" style="display: none;">
        <h3>Edit Nilai Manual</h3>
        <p>Baris yang di edit:</p>
        <input type="text" id="edit-nama-baris" readonly> 
        <input type="number" id="edit-nilai">
        <input type="hidden" id="edit-firebase-id">
        <button onclick="saveManualEdit()">Simpan</button>
        <button onclick="document.getElementById('modal-edit-tahunan').style.display='none'">Batal</button>
    </div>
    
    </body>
</html>
