<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Input & Laporan KOIN NU Paling Detail</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background-color: #f8f9fa; }
        h1, h2 { color: #006400; }
        /* Menggunakan font-size yang lebih kecil dan padding yang sempit untuk tabel yang sangat lebar */
        table { width: 100%; border-collapse: collapse; margin-bottom: 40px; background-color: white; font-size: 11px; } 
        th, td { border: 1px solid #ddd; padding: 4px 6px; text-align: left; } /* Padding lebih kecil */
        th { background-color: #006400; color: white; text-align: center; }
        .text-right { text-align: right; }
        .footer-total { background-color: #e6ffe6; font-weight: bold; }
        .header-group { background-color: #006400; color: white; }
        /* Style untuk kolom input */
        input[type="number"] { width: 90%; padding: 2px; border: 1px solid #ccc; text-align: right; box-sizing: border-box; font-size: 11px; }
        .input-table th { background-color: #007bff; }
        
        /* Style khusus untuk baris Saldo Awal */
        .saldo-awal-row td { background-color: #fffacd; font-weight: bold; } 
        
    </style>
</head>
<body>

    <h1>Sistem Input & Laporan KOIN NU Interaktif (Detail Penuh)</h1>
    <p style="color: red; font-weight: bold;">Catatan: Silakan ubah angka di Modul 1 dan Saldo Bulan Lalu (Modul 2), termasuk **Saldo Awal Bank dan Tunai (Modul 3)**, maka semua laporan akan otomatis berubah.</p>

    <h2>MODUL 1: INPUT DATA BULANAN (Sumber Utama)</h2>
    <table id="tabel-modul-1" class="input-table">
        <thead>
            <tr>
                <th rowspan="3">BULAN</th>
                <th colspan="2">PENERIMAAN</th>
                <th colspan="12">PENGELUARAN DANA SOSIAL/BANTUAN</th>
                <th colspan="4">PENGELUARAN OPERASIONAL</th>
            </tr>
            <tr>
                <th rowspan="2">TOTAL KOIN</th>
                <th rowspan="2">JML DONATUR</th>
                <th colspan="2">Pendidikan</th>
                <th colspan="2">Kesehatan</th>
                <th colspan="2">Ekonomi</th>
                <th colspan="2">Sosial Umum</th>
                <th colspan="2">Subsidi Banom & Lembaga NU</th>
                <th colspan="2">Bencana</th>
                <th rowspan="2">Rapat</th>
                <th rowspan="2">PERWTN MLU</th>
                <th rowspan="2">BIAYA REK BANK</th>
                <th rowspan="2">Lain - Lain</th>
            </tr>
            <tr>
                <th>Jml Uang</th>
                <th>Jml Pnm</th>
                <th>Jml Uang</th>
                <th>Jml Pnm</th>
                <th>Jml Uang</th>
                <th>Jml Pnm</th>
                <th>Jml Uang</th>
                <th>Jml Pnm</th>
                <th>Jml Uang</th>
                <th>Jml Pnm</th>
                <th>Jml Uang</th>
                <th>Jml Pnm</th>
            </tr>
        </thead>
        <tbody id="m1-input-body">
            </tbody>
    </table>

    <hr>

    <h2>MODUL 2: TAMPILAN JURNAL UMUM (Bulan Januari)</h2>
    <p>Jurnal Umum mencatat rincian honor (40%) dan total semua pengeluaran uang lainnya.</p>
    <table id="tabel-modul-2">
        <thead>
            <tr>
                <th>NO</th>
                <th>KETERANGAN</th>
                <th>DANA MASUK (DEBIT)</th>
                <th>DANA KELUAR (KREDIT)</th>
                <th>SALDO</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td>-</td>
                <td>Saldo Bulan Lalu</td>
                <td class="text-right">0</td>
                <td class="text-right">0</td>
                <td><input type="number" id="m2-saldo-awal-input" value="0" min="0" style="width: 100%;"></td>
            </tr>
            <tr><td>1</td><td style="font-weight: bold;">Penerimaan Dana KOIN NU (100% Total)</td><td id="m2-dana-masuk-koin" class="text-right">0</td><td class="text-right">0</td><td id="m2-saldo-penerimaan" class="text-right">0</td></tr>
            
            <tr><td>2</td><td>Pengeluaran Honor Petugas (10%)</td><td class="text-right">0</td><td id="m2-dana-keluar-honor-petugas" class="text-right">0</td><td id="m2-saldo-honor-petugas" class="text-right">0</td></tr>
            <tr><td>3</td><td>Pengeluaran Honor MWC (25%)</td><td class="text-right">0</td><td id="m2-dana-keluar-honor-mwc" class="text-right">0</td><td id="m2-saldo-honor-mwc" class="text-right">0</td></tr>
            <tr><td>4</td><td>Pengeluaran Honor PC (5%)</td><td class="text-right">0</td><td id="m2-dana-keluar-honor-pc" class="text-right">0</td><td id="m2-saldo-honor-pc" class="text-right">0</td></tr>
            
            <tr><td>5</td><td>Total Pengeluaran Dana Sosial & Operasional Lainnya</td><td class="text-right">0</td><td id="m2-dana-keluar-nonhonor" class="text-right">0</td><td id="m2-saldo-akhir" class="text-right">0</td></tr>
        </tbody>
        <tfoot>
            <tr>
                <td colspan="2" class="footer-total text-right">TOTAL</td>
                <td id="m2-total-masuk" class="footer-total text-right">0</td>
                <td id="m2-total-keluar" class="footer-total text-right">0</td>
                <td id="m2-footer-saldo-total" class="footer-total text-right">0</td>
            </tr>
        </tfoot>
    </table>

    <hr>

    <h2>MODUL 3: TAMPILAN LAPORAN TAHUNAN</h2>
    
    <table id="tabel-modul-3">
        <thead>
            <tr>
                <th rowspan="3">NO</th>
                <th rowspan="3">BULAN</th>
                <th colspan="2">PENERIMAAN</th>
                <th colspan="12">PENGELUARAN SOSIAL (JML UANG/JML PENERIMA)</th>
                <th colspan="4">PENGELUARAN OPERASIONAL</th>
                <th rowspan="3">Honor Wajib (40%)</th>
                <th rowspan="3">JML PENGELUARAN (7)</th>
                <th rowspan="3">SALDO AKHIR BULAN INI (8)</th>
                <th rowspan="3">SALDO KAS TAHUN BERJALAN (9)</th>
            </tr>
            <tr>
                <th rowspan="2">Total Koin (3)</th>
                <th rowspan="2">JML Donatur (4)</th>
                <th colspan="2">Pendidikan</th>
                <th colspan="2">Kesehatan</th>
                <th colspan="2">Ekonomi</th>
                <th colspan="2">Sosial Umum</th>
                <th colspan="2">Subsidi Banom & Lembaga NU</th>
                <th colspan="2">Bencana</th>
                <th rowspan="2">Rapat</th>
                <th rowspan="2">PERWTN MLU</th>
                <th rowspan="2">BIAYA REK BANK</th>
                <th rowspan="2">Lain - Lain</th>
            </tr>
            <tr>
                <th>Jml Uang</th>
                <th>Jml Pnm</th>
                <th>Jml Uang</th>
                <th>Jml Pnm</th>
                <th>Jml Uang</th>
                <th>Jml Pnm</th>
                <th>Jml Uang</th>
                <th>Jml Pnm</th>
                <th>Jml Uang</th>
                <th>Jml Pnm</th>
                <th>Jml Uang</th>
                <th>Jml Pnm</th>
            </tr>
        </thead>
        <tbody id="m3-data-body">
            </tbody>
        <tfoot>
            <tr>
                <td colspan="2" class="footer-total text-right">TOTAL TAHUNAN</td>
                <td class="footer-total text-right" id="m3-total-penerimaan">0</td>
                <td class="footer-total text-right" id="m3-total-donatur">0</td>
                
                <td class="footer-total text-right" id="m3-total-pend-uang">0</td>
                <td class="footer-total text-right" id="m3-total-pend-pnm">0</td>
                <td class="footer-total text-right" id="m3-total-kes-uang">0</td>
                <td class="footer-total text-right" id="m3-total-kes-pnm">0</td>
                <td class="footer-total text-right" id="m3-total-eko-uang">0</td>
                <td class="footer-total text-right" id="m3-total-eko-pnm">0</td>
                <td class="footer-total text-right" id="m3-total-sosum-uang">0</td>
                <td class="footer-total text-right" id="m3-total-sosum-pnm">0</td>
                <td class="footer-total text-right" id="m3-total-banom-uang">0</td>
                <td class="footer-total text-right" id="m3-total-banom-pnm">0</td>
                <td class="footer-total text-right" id="m3-total-bencana-uang">0</td>
                <td class="footer-total text-right" id="m3-total-bencana-pnm">0</td>

                <td class="footer-total text-right" id="m3-total-rapat">0</td>
                <td class="footer-total text-right" id="m3-total-perwtn">0</td>
                <td class="footer-total text-right" id="m3-total-bank">0</td>
                <td class="footer-total text-right" id="m3-total-lain">0</td>

                <td class="footer-total text-right" id="m3-total-honor">0</td>
                <td class="footer-total text-right" id="m3-total-pengeluaran">0</td>
                <td class="footer-total text-right" id="m3-footer-saldo-akhir">0</td>
                <td class="footer-total text-right" id="m3-footer-saldo-kas">0</td>
            </tr>
        </tfoot>
    </table>

    <script>
        // --- DATA INITIATION (digunakan untuk mengisi input awal) ---
        const INITIAL_DATA_SOURCE = [
            { 
                bulan: 'Januari', penerimaan: 4000000, donatur: 200, 
                pendUang: 500000, pendPenerima: 5, kesUang: 300000, kesPenerima: 3, 
                ekoUang: 400000, ekoPenerima: 4, sosumUang: 300000, sosumPenerima: 10, 
                banomUang: 300000, banomPenerima: 2, bencanaUang: 0, bencanaPenerima: 0,
                rapat: 200000, perwtnMlu: 50000, biayaBank: 10000, lainLain: 140000,
                honorWajibPercent: 0.40 
            },
            { 
                bulan: 'Februari', penerimaan: 5000000, donatur: 250, 
                pendUang: 600000, pendPenerima: 6, kesUang: 0, kesPenerima: 0, 
                ekoUang: 500000, ekoPenerima: 5, sosumUang: 400000, sosumPenerima: 15, 
                banomUang: 0, banomPenerima: 0, bencanaUang: 0, bencanaPenerima: 0,
                rapat: 0, perwtnMlu: 0, biayaBank: 0, lainLain: 0,
                honorWajibPercent: 0.40 
            },
            { 
                bulan: 'Maret', penerimaan: 6000000, donatur: 300, 
                pendUang: 500000, pendPenerima: 5, kesUang: 500000, kesPenerima: 5, 
                ekoUang: 0, ekoPenerima: 0, sosumUang: 0, sosumPenerima: 0, 
                banomUang: 0, banomPenerima: 0, bencanaUang: 0, bencanaPenerima: 0,
                rapat: 0, perwtnMlu: 0, biayaBank: 0, lainLain: 0,
                honorWajibPercent: 0.40 
            },
            { bulan: 'April', penerimaan: 0, donatur: 0, pendUang: 0, pendPenerima: 0, kesUang: 0, kesPenerima: 0, ekoUang: 0, ekoPenerima: 0, sosumUang: 0, sosumPenerima: 0, banomUang: 0, banomPenerima: 0, bencanaUang: 0, bencanaPenerima: 0, rapat: 0, perwtnMlu: 0, biayaBank: 0, lainLain: 0, honorWajibPercent: 0.40 },
            { bulan: 'Mei', penerimaan: 0, donatur: 0, pendUang: 0, pendPenerima: 0, kesUang: 0, kesPenerima: 0, ekoUang: 0, ekoPenerima: 0, sosumUang: 0, sosumPenerima: 0, banomUang: 0, banomPenerima: 0, bencanaUang: 0, bencanaPenerima: 0, rapat: 0, perwtnMlu: 0, biayaBank: 0, lainLain: 0, honorWajibPercent: 0.40 },
            { bulan: 'Juni', penerimaan: 0, donatur: 0, pendUang: 0, pendPenerima: 0, kesUang: 0, kesPenerima: 0, ekoUang: 0, ekoPenerima: 0, sosumUang: 0, sosumPenerima: 0, banomUang: 0, banomPenerima: 0, bencanaUang: 0, bencanaPenerima: 0, rapat: 0, perwtnMlu: 0, biayaBank: 0, lainLain: 0, honorWajibPercent: 0.40 },
            { bulan: 'Juli', penerimaan: 0, donatur: 0, pendUang: 0, pendPenerima: 0, kesUang: 0, kesPenerima: 0, ekoUang: 0, ekoPenerima: 0, sosumUang: 0, sosumPenerima: 0, banomUang: 0, banomPenerima: 0, bencanaUang: 0, bencanaPenerima: 0, rapat: 0, perwtnMlu: 0, biayaBank: 0, lainLain: 0, honorWajibPercent: 0.40 },
            { bulan: 'Agustus', penerimaan: 0, donatur: 0, pendUang: 0, pendPenerima: 0, kesUang: 0, kesPenerima: 0, ekoUang: 0, ekoPenerima: 0, sosumUang: 0, sosumPenerima: 0, banomUang: 0, banomPenerima: 0, bencanaUang: 0, bencanaPenerima: 0, rapat: 0, perwtnMlu: 0, biayaBank: 0, lainLain: 0, honorWajibPercent: 0.40 },
            { bulan: 'September', penerimaan: 0, donatur: 0, pendUang: 0, pendPenerima: 0, kesUang: 0, kesPenerima: 0, ekoUang: 0, ekoPenerima: 0, sosumUang: 0, sosumPenerima: 0, banomUang: 0, banomPenerima: 0, bencanaUang: 0, bencanaPenerima: 0, rapat: 0, perwtnMlu: 0, biayaBank: 0, lainLain: 0, honorWajibPercent: 0.40 },
            { bulan: 'Oktober', penerimaan: 0, donatur: 0, pendUang: 0, pendPenerima: 0, kesUang: 0, kesPenerima: 0, ekoUang: 0, ekoPenerima: 0, sosumUang: 0, sosumPenerima: 0, banomUang: 0, banomPenerima: 0, bencanaUang: 0, bencanaPenerima: 0, rapat: 0, perwtnMlu: 0, biayaBank: 0, lainLain: 0, honorWajibPercent: 0.40 },
            { bulan: 'November', penerimaan: 0, donatur: 0, pendUang: 0, pendPenerima: 0, kesUang: 0, kesPenerima: 0, ekoUang: 0, ekoPenerima: 0, sosumUang: 0, sosumPenerima: 0, banomUang: 0, banomPenerima: 0, bencanaUang: 0, bencanaPenerima: 0, rapat: 0, perwtnMlu: 0, biayaBank: 0, lainLain: 0, honorWajibPercent: 0.40 },
            { bulan: 'Desember', penerimaan: 0, donatur: 0, pendUang: 0, pendPenerima: 0, kesUang: 0, kesPenerima: 0, ekoUang: 0, ekoPenerima: 0, sosumUang: 0, sosumPenerima: 0, banomUang: 0, banomPenerima: 0, bencanaUang: 0, bencanaPenerima: 0, rapat: 0, perwtnMlu: 0, biayaBank: 0, lainLain: 0, honorWajibPercent: 0.40 },
        ];
        
        // Konstanta alokasi Honor (digunakan di Modul 2)
        const HONOR_RATES = {
            petugas: 0.10,
            mwc: 0.25,
            pc: 0.05
        };

        // Saldo Awal Default (Digunakan saat pertama kali load)
        let initialBankBalance = 10000000;
        let initialCashBalance = 5000000;

        // --- HELPER FUNCTION ---
        const formatNominal = (angka) => {
            if (typeof angka !== 'number' || isNaN(angka)) return '0';
            return angka.toLocaleString('id-ID', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
        };
        
        // Fungsi parsing input yang kini harus mencari input di Modul 3 juga
        const parseInput = (id) => {
            const element = document.getElementById(id);
            if (element) {
                return parseFloat(element.value) || 0;
            }
            // Khusus untuk Saldo Awal Modul 3, jika elemen belum ada (pertama kali load), gunakan nilai default
            if (id === 'saldo-bank-awal-input') return initialBankBalance;
            if (id === 'saldo-tunai-awal-input') return initialCashBalance;
            return 0;
        };

        // --- CORE FUNCTION 1: GATHER DATA FROM INPUTS (Modul 1) ---
        function gatherInputData() {
            const data = [];
            INITIAL_DATA_SOURCE.forEach((monthData, index) => {
                const prefix = `m1-${index}-`;
                data.push({
                    bulan: monthData.bulan,
                    penerimaan: parseInput(prefix + 'penerimaan'),
                    donatur: parseInput(prefix + 'donatur'),
                    // Dana Sosial
                    pendUang: parseInput(prefix + 'pendUang'),
                    pendPenerima: parseInput(prefix + 'pendPenerima'),
                    kesUang: parseInput(prefix + 'kesUang'),
                    kesPenerima: parseInput(prefix + 'kesPenerima'),
                    ekoUang: parseInput(prefix + 'ekoUang'),
                    ekoPenerima: parseInput(prefix + 'ekoPenerima'),
                    sosumUang: parseInput(prefix + 'sosumUang'),
                    sosumPenerima: parseInput(prefix + 'sosumPenerima'),
                    banomUang: parseInput(prefix + 'banomUang'),
                    banomPenerima: parseInput(prefix + 'banomPenerima'),
                    bencanaUang: parseInput(prefix + 'bencanaUang'),
                    bencanaPenerima: parseInput(prefix + 'bencanaPenerima'),
                    // Operasional
                    rapat: parseInput(prefix + 'rapat'),
                    perwtnMlu: parseInput(prefix + 'perwtnMlu'),
                    biayaBank: parseInput(prefix + 'biayaBank'),
                    lainLain: parseInput(prefix + 'lainLain'),
                    honorWajibPercent: monthData.honorWajibPercent 
                });
            });
            return data;
        }
        
        // Fungsi untuk menjumlahkan semua pengeluaran Non-Honor Uang
        function calculateTotalNonHonorExpense(dataBulan) {
            return dataBulan.pendUang + dataBulan.kesUang + dataBulan.ekoUang + dataBulan.sosumUang + dataBulan.banomUang + dataBulan.bencanaUang + dataBulan.rapat + dataBulan.perwtnMlu + dataBulan.biayaBank + dataBulan.lainLain;
        }

        // --- CORE FUNCTION 2: UPDATE MODUL 2 (JURNAL UMUM) ---
        function updateJurnalUmum(data) {
            // Modul 2 hanya fokus pada bulan pertama (Januari)
            if (data.length === 0) return;
            const dataJan = data[0]; 
            const totalPenerimaan = dataJan.penerimaan; 
            const totalPengeluaranNonHonor = calculateTotalNonHonorExpense(dataJan);

            // Perhitungan Honor Rinci
            const honorPetugas = totalPenerimaan * HONOR_RATES.petugas;
            const honorMWC = totalPenerimaan * HONOR_RATES.mwc;
            const honorPC = totalPenerimaan * HONOR_RATES.pc;
            const totalHonor = honorPetugas + honorMWC + honorPC; 

            // Ambil Saldo Awal (Saldo Bulan Lalu)
            let saldoJurnalUmum = parseInput('m2-saldo-awal-input'); 
            let totalMasuk = 0;
            let totalKeluar = 0;

            // 1. Penerimaan Dana KOIN NU (100%)
            saldoJurnalUmum += totalPenerimaan;
            totalMasuk += totalPenerimaan;
            document.getElementById('m2-dana-masuk-koin').textContent = formatNominal(totalPenerimaan);
            document.getElementById('m2-saldo-penerimaan').textContent = formatNominal(saldoJurnalUmum);

            // 2. Pengeluaran Honor Petugas (10%)
            saldoJurnalUmum -= honorPetugas;
            document.getElementById('m2-dana-keluar-honor-petugas').textContent = formatNominal(honorPetugas);
            document.getElementById('m2-saldo-honor-petugas').textContent = formatNominal(saldoJurnalUmum);

            // 3. Pengeluaran Honor MWC (25%)
            saldoJurnalUmum -= honorMWC;
            document.getElementById('m2-dana-keluar-honor-mwc').textContent = formatNominal(honorMWC);
            document.getElementById('m2-saldo-honor-mwc').textContent = formatNominal(saldoJurnalUmum);

            // 4. Pengeluaran Honor PC (5%)
            saldoJurnalUmum -= honorPC;
            document.getElementById('m2-dana-keluar-honor-pc').textContent = formatNominal(honorPC);
            document.getElementById('m2-saldo-honor-pc').textContent = formatNominal(saldoJurnalUmum);
            
            // 5. Total Pengeluaran Non-Honor
            saldoJurnalUmum -= totalPengeluaranNonHonor;
            document.getElementById('m2-dana-keluar-nonhonor').textContent = formatNominal(totalPengeluaranNonHonor);
            document.getElementById('m2-saldo-akhir').textContent = formatNominal(saldoJurnalUmum);

            // FOOTER MODUL 2
            totalKeluar = totalHonor + totalPengeluaranNonHonor;
            document.getElementById('m2-total-masuk').textContent = formatNominal(totalMasuk);
            document.getElementById('m2-total-keluar').textContent = formatNominal(totalKeluar);
            document.getElementById('m2-footer-saldo-total').textContent = formatNominal(saldoJurnalUmum);
        }

        // --- CORE FUNCTION 3: UPDATE MODUL 3 (LAPORAN TAHUNAN) ---
        function updateLaporanTahunan(data) {
            const tableBody = document.getElementById('m3-data-body');
            tableBody.innerHTML = ''; 

            // --- 1. AMBIL SALDO AWAL (BANK & TUNAI) ---
            // Gunakan parseInput untuk mengambil nilai yang terakhir diinput/nilai default
            const saldoBankAwal = parseInput('saldo-bank-awal-input');
            const saldoTunaiAwal = parseInput('saldo-tunai-awal-input');

            // Simpan nilai input yang baru untuk digunakan sebagai default di render berikutnya
            initialBankBalance = saldoBankAwal;
            initialCashBalance = saldoTunaiAwal;

            // Saldo Kas Tahun Berjalan (Running Total untuk Kolom 9)
            let runningSaldoKas = 0; 
            
            // Inisialisasi Total Tahunan
            let totalPenerimaanTahunan = 0; 
            let totalDonaturTahunan = 0;
            let totalPengeluaranTahunan = 0;
            let totalHonorTahunan = 0;
            
            // Total Uang & Penerima untuk Dana Sosial
            let totalPendUangTahunan = 0;
            let totalPendPnmTahunan = 0;
            let totalKesUangTahunan = 0;
            let totalKesPnmTahunan = 0;
            let totalEkoUangTahunan = 0;
            let totalEkoPnmTahunan = 0;
            let totalSosumUangTahunan = 0;
            let totalSosumPnmTahunan = 0;
            let totalBanomUangTahunan = 0;
            let totalBanomPnmTahunan = 0;
            let totalBencanaUangTahunan = 0;
            let totalBencanaPnmTahunan = 0;

            // Total Operasional
            let totalRapatTahunan = 0;
            let totalPerwtnTahunan = 0;
            let totalBankTahunan = 0;
            let totalLainTahunan = 0;
            

            // --- 2. MASUKKAN BARIS SALDO AWAL ---
            
            // Baris 1: SALDO KAS BANK (Awal Tahun)
            runningSaldoKas += saldoBankAwal; // Saldo Bank masuk ke Kas Tahun Berjalan
            let rowBank = tableBody.insertRow();
            rowBank.classList.add('saldo-awal-row');
            rowBank.innerHTML = `
                <td>-</td>
                <td>SALDO KAS BANK (Awal Tahun)</td>
                <td class="text-right"><input type="number" id="saldo-bank-awal-input" value="${saldoBankAwal}" min="0" style="width: 100%;"></td>
                <td class="text-right">-</td> <td colspan="16">-</td>
                <td>-</td>
                <td>-</td>
                <td class="text-right">-</td> <td class="text-right">${formatNominal(runningSaldoKas)}</td> `;
            
            // Baris 2: SALDO KAS TUNAI (Awal Tahun)
            runningSaldoKas += saldoTunaiAwal; // Saldo Tunai ikut menjumlahkan ke Kas Tahun Berjalan
            let rowTunai = tableBody.insertRow();
            rowTunai.classList.add('saldo-awal-row');
            rowTunai.innerHTML = `
                <td>-</td>
                <td>SALDO KAS TUNAI (Awal Tahun)</td>
                <td class="text-right"><input type="number" id="saldo-tunai-awal-input" value="${saldoTunaiAwal}" min="0" style="width: 100%;"></td>
                <td class="text-right">-</td> <td colspan="16">-</td>
                <td>-</td>
                <td>-</td>
                <td class="text-right">${formatNominal(saldoTunaiAwal)}</td> <td class="text-right">${formatNominal(runningSaldoKas)}</td> `;

            // --- 3. PROSES DATA BULANAN (Januari - Desember) ---
            data.forEach((dataBulan, index) => {
                const no = index + 1;
                
                // Perhitungan
                const honorWajib = dataBulan.penerimaan * dataBulan.honorWajibPercent; 
                const totalPengeluaranNonHonor = calculateTotalNonHonorExpense(dataBulan);
                const jmlPengeluaranBulanIni = honorWajib + totalPengeluaranNonHonor;
                const saldoAkhirBulanIni = dataBulan.penerimaan - jmlPengeluaranBulanIni;
                
                // Update Running Total
                runningSaldoKas += saldoAkhirBulanIni; 

                // --- AKUMULASI TOTAL TAHUNAN (Hanya data bulanan) ---
                totalPenerimaanTahunan += dataBulan.penerimaan;
                totalDonaturTahunan += dataBulan.donatur;
                totalPengeluaranTahunan += jmlPengeluaranBulanIni;
                totalHonorTahunan += honorWajib;
                
                // Dana Sosial
                totalPendUangTahunan += dataBulan.pendUang;
                totalPendPnmTahunan += dataBulan.pendPenerima;
                totalKesUangTahunan += dataBulan.kesUang;
                totalKesPnmTahunan += dataBulan.kesPenerima;
                totalEkoUangTahunan += dataBulan.ekoUang;
                totalEkoPnmTahunan += dataBulan.ekoPenerima;
                totalSosumUangTahunan += dataBulan.sosumUang;
                totalSosumPnmTahunan += dataBulan.sosumPenerima;
                totalBanomUangTahunan += dataBulan.banomUang;
                totalBanomPnmTahunan += dataBulan.banomPenerima;
                totalBencanaUangTahunan += dataBulan.bencanaUang;
                totalBencanaPnmTahunan += dataBulan.bencanaPenerima;

                // Operasional
                totalRapatTahunan += dataBulan.rapat;
                totalPerwtnTahunan += dataBulan.perwtnMlu;
                totalBankTahunan += dataBulan.biayaBank;
                totalLainTahunan += dataBulan.lainLain;
                
                // --- Buat Baris Data Bulanan ---
                const row = tableBody.insertRow();
                row.innerHTML = `
                    <td>${no}</td>
                    <td>${dataBulan.bulan.toUpperCase()}</td>
                    <td class="text-right">${formatNominal(dataBulan.penerimaan)}</td>
                    <td class="text-right">${formatNominal(dataBulan.donatur)}</td>
                    <td class="text-right">${formatNominal(dataBulan.pendUang)}</td>
                    <td class="text-right">${formatNominal(dataBulan.pendPenerima)}</td>
                    <td class="text-right">${formatNominal(dataBulan.kesUang)}</td>
                    <td class="text-right">${formatNominal(dataBulan.kesPenerima)}</td>
                    <td class="text-right">${formatNominal(dataBulan.ekoUang)}</td>
                    <td class="text-right">${formatNominal(dataBulan.ekoPenerima)}</td>
                    <td class="text-right">${formatNominal(dataBulan.sosumUang)}</td>
                    <td class="text-right">${formatNominal(dataBulan.sosumPenerima)}</td>
                    <td class="text-right">${formatNominal(dataBulan.banomUang)}</td>
                    <td class="text-right">${formatNominal(dataBulan.banomPenerima)}</td>
                    <td class="text-right">${formatNominal(dataBulan.bencanaUang)}</td>
                    <td class="text-right">${formatNominal(dataBulan.bencanaPenerima)}</td>
                    <td class="text-right">${formatNominal(dataBulan.rapat)}</td>
                    <td class="text-right">${formatNominal(dataBulan.perwtnMlu)}</td>
                    <td class="text-right">${formatNominal(dataBulan.biayaBank)}</td>
                    <td class="text-right">${formatNominal(dataBulan.lainLain)}</td>
                    <td class="text-right">${formatNominal(honorWajib)}</td>
                    <td class="text-right">${formatNominal(jmlPengeluaranBulanIni)}</td>
                    <td class="text-right">${formatNominal(saldoAkhirBulanIni)}</td>
                    <td class="text-right">${formatNominal(runningSaldoKas)}</td>
                `;
            });

            // --- Update FOOTER (TOTAL TAHUNAN) ---
            document.getElementById('m3-total-penerimaan').textContent = formatNominal(totalPenerimaanTahunan);
            document.getElementById('m3-total-donatur').textContent = formatNominal(totalDonaturTahunan);
            document.getElementById('m3-total-pengeluaran').textContent = formatNominal(totalPengeluaranTahunan);
            document.getElementById('m3-total-honor').textContent = formatNominal(totalHonorTahunan);
            
            // Total Dana Sosial & Operasional
            document.getElementById('m3-total-pend-uang').textContent = formatNominal(totalPendUangTahunan);
            document.getElementById('m3-total-pend-pnm').textContent = formatNominal(totalPendPnmTahunan);
            document.getElementById('m3-total-kes-uang').textContent = formatNominal(totalKesUangTahunan);
            document.getElementById('m3-total-kes-pnm').textContent = formatNominal(totalKesPnmTahunan);
            document.getElementById('m3-total-eko-uang').textContent = formatNominal(totalEkoUangTahunan);
            document.getElementById('m3-total-eko-pnm').textContent = formatNominal(totalEkoPnmTahunan);
            document.getElementById('m3-total-sosum-uang').textContent = formatNominal(totalSosumUangTahunan);
            document.getElementById('m3-total-sosum-pnm').textContent = formatNominal(totalSosumPnmTahunan);
            document.getElementById('m3-total-banom-uang').textContent = formatNominal(totalBanomUangTahunan);
            document.getElementById('m3-total-banom-pnm').textContent = formatNominal(totalBanomPnmTahunan);
            document.getElementById('m3-total-bencana-uang').textContent = formatNominal(totalBencanaUangTahunan);
            document.getElementById('m3-total-bencana-pnm').textContent = formatNominal(totalBencanaPnmTahunan);
            document.getElementById('m3-total-rapat').textContent = formatNominal(totalRapatTahunan);
            document.getElementById('m3-total-perwtn').textContent = formatNominal(totalPerwtnTahunan);
            document.getElementById('m3-total-bank').textContent = formatNominal(totalBankTahunan);
            document.getElementById('m3-total-lain').textContent = formatNominal(totalLainTahunan);

            // Footer Saldo (menampilkan Saldo Kas Akhir Tahun)
            document.getElementById('m3-footer-saldo-akhir').textContent = formatNominal(runningSaldoKas); 
            document.getElementById('m3-footer-saldo-kas').textContent = formatNominal(runningSaldoKas); 
        }

        // --- MAIN CONTROL FUNCTION ---
        function recalculateAllReports() {
            const currentData = gatherInputData();
            updateJurnalUmum(currentData);
            updateLaporanTahunan(currentData);
            
            // Re-attach listeners for dynamically generated Modul 3 inputs after redraw
            const dynamicInputs = document.querySelectorAll('#m3-data-body input[type="number"]');
            dynamicInputs.forEach(input => {
                // Hapus listener lama jika ada, lalu tambahkan yang baru
                input.removeEventListener('input', recalculateAllReports);
                input.addEventListener('input', recalculateAllReports);
            });
        }

        // --- INITIALIZATION ---
        function initializeLaporan() {
            const inputBody = document.getElementById('m1-input-body');
            
            // 1. Generate Input Fields (Modul 1)
            INITIAL_DATA_SOURCE.forEach((data, index) => {
                const prefix = `m1-${index}-`;
                const row = inputBody.insertRow();
                row.innerHTML = `
                    <td>${data.bulan.toUpperCase()}</td>
                    <td><input type="number" id="${prefix}penerimaan" value="${data.penerimaan}" min="0"></td>
                    <td><input type="number" id="${prefix}donatur" value="${data.donatur}" min="0"></td>
                    
                    <td><input type="number" id="${prefix}pendUang" value="${data.pendUang}" min="0"></td>
                    <td><input type="number" id="${prefix}pendPenerima" value="${data.pendPenerima}" min="0"></td>
                    
                    <td><input type="number" id="${prefix}kesUang" value="${data.kesUang}" min="0"></td>
                    <td><input type="number" id="${prefix}kesPenerima" value="${data.kesPenerima}" min="0"></td>

                    <td><input type="number" id="${prefix}ekoUang" value="${data.ekoUang}" min="0"></td>
                    <td><input type="number" id="${prefix}ekoPenerima" value="${data.ekoPenerima}" min="0"></td>

                    <td><input type="number" id="${prefix}sosumUang" value="${data.sosumUang}" min="0"></td>
                    <td><input type="number" id="${prefix}sosumPenerima" value="${data.sosumPenerima}" min="0"></td>
                    
                    <td><input type="number" id="${prefix}banomUang" value="${data.banomUang}" min="0"></td>
                    <td><input type="number" id="${prefix}banomPenerima" value="${data.banomPenerima}" min="0"></td>
                    
                    <td><input type="number" id="${prefix}bencanaUang" value="${data.bencanaUang}" min="0"></td>
                    <td><input type="number" id="${prefix}bencanaPenerima" value="${data.bencanaPenerima}" min="0"></td>
                    
                    <td><input type="number" id="${prefix}rapat" value="${data.rapat}" min="0"></td>
                    <td><input type="number" id="${prefix}perwtnMlu" value="${data.perwtnMlu}" min="0"></td>
                    <td><input type="number" id="${prefix}biayaBank" value="${data.biayaBank}" min="0"></td>
                    <td><input type="number" id="${prefix}lainLain" value="${data.lainLain}" min="0"></td>
                `;
            });
            
            // 2. Attach Event Listeners to static input fields (Modul 1 dan Saldo Awal Modul 2)
            const staticInputs = document.querySelectorAll('#tabel-modul-1 input[type="number"], #m2-saldo-awal-input');
            staticInputs.forEach(input => {
                input.addEventListener('input', recalculateAllReports);
            });

            // 3. Run initial calculation (This will generate the Modul 3 inputs for the first time)
            recalculateAllReports();
        }

        // Jalankan fungsi setelah dokumen dimuat
        document.addEventListener('DOMContentLoaded', initializeLaporan);
    </script>

</body>
</html>
