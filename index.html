<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pembukuan Koin NU UPZIS Ngablak (Firebase)</title>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

    <style>
        /* CSS Dasar untuk Keringanan dan Support HP */
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f4f4f9;
        }
        #app {
            max-width: 100%;
            margin: auto;
            background-color: #fff;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        header {
            background-color: #006400; /* Warna Hijau NU */
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        h1 {
            margin: 0;
            font-size: 1.5em;
        }
        #auth-controls button {
            background-color: #dc3545;
            color: white;
            border: none;
            padding: 8px 15px;
            cursor: pointer;
            border-radius: 4px;
        }
        #module-nav {
            background-color: #e9ecef;
            padding: 10px;
            text-align: center;
            border-bottom: 1px solid #ddd;
        }
        #module-nav button {
            padding: 10px 15px;
            margin: 0 5px;
            border: 1px solid #006400;
            background-color: white;
            cursor: pointer;
            font-weight: bold;
            border-radius: 4px;
        }
        .module-view {
            padding: 20px;
        }
        /* Tabel Responsif (Penting untuk HP) */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            display: block;
            overflow-x: auto; /* Memastikan tabel bisa di-scroll horizontal di HP */
            white-space: nowrap;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
            font-size: 0.9em;
        }
        th {
            background-color: #007bff;
            color: white;
            text-align: center !important; /* Keterangan: Header kolom center */
        }
        /* Input Form */
        form input, form button {
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
            box-sizing: border-box;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        form button {
            background-color: #28a745;
            color: white;
            cursor: pointer;
        }
        /* Login Form */
        #login-form-container {
            padding: 20px;
            max-width: 350px;
            margin: 50px auto;
            border: 1px solid #ccc;
            border-radius: 8px;
        }
        #login-form-container h2 {
            text-align: center;
            margin-top: 0;
        }

        /* Kontrol Khusus */
        .controls {
            padding: 10px 0;
            overflow: hidden;
        }
        .controls button {
            padding: 8px 12px;
            margin: 5px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        #download-pdf-koin-btn { background-color: #17a2b8; color: white; float: right; } /* Unduhan PDF rata kanan */
        #reset-koin-btn { background-color: #ffc107; color: #333; float: left; } /* Reset data rata kiri */
    </style>

</head>
<body>
    <div id="app">
        <header>
            <h1>Pembukuan Dana Koin NU</h1>
            <div id="auth-controls">
                <button id="logout-btn" style="display:none;">LOG OUT</button>
            </div>
        </header>

        <main id="main-content" style="display:none;">
            <nav id="module-nav">
                <button onclick="showModule('koin-nu')">Modul Koin NU</button>
                <button onclick="showModule('jurnal-umum')">Modul Jurnal Umum</button>
                <button onclick="showModule('laporan-tahunan')">Modul Laporan Tahunan</button>
            </nav>

            <div id="koin-nu-module" class="module-view module-active">
                </div>
            <div id="jurnal-umum-module" class="module-view" style="display:none;">
                </div>
            <div id="laporan-tahunan-module" class="module-view" style="display:none;">
                </div>
        </main>

        <div id="login-form-container">
            <h2>LOGIN</h2>
            <input type="email" id="login-email" placeholder="Email" value="darwono78@gmail.com">
            <input type="password" id="login-password" placeholder="Password">
            <button id="login-btn">Masuk</button>
        </div>
    </div>

    <script>
        // --- KONFIGURASI FIREBASE ANDA ---
        const firebaseConfig = {
            apiKey: "AIzaSyA_8NMmZBaXZ4H6KQt7rHy8G1URR3HLP3A",
            authDomain: "upzis-ngablak.firebaseapp.com",
            projectId: "upzis-ngablak",
            storageBucket: "upzis-ngablak.firebasestorage.app",
            messagingSenderId: "869549648344",
            appId: "1:869549648344:web:a531a37cce3a87bb672aad"
        };

        // Inisialisasi Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // Pilihan Koleksi (Database Paths)
        const COLLECTIONS = {
            KOIN_NU: 'laporan_koin_nu',
            JURNAL_UMUM: 'jurnal_umum',
            LAPORAN_TAHUNAN: 'laporan_tahunan' // Koleksi yang diminta
        };

        // --- FUNGSI UTILITY (Pencegahan Konsol Merah) ---

        // Fungsi format Nominal (tidak pakai Rp, pakai titik)
        const formatNominal = (angka) => {
            if (typeof angka !== 'number') return '0';
            return angka.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
        };

        // Fungsi format Tanggal Indonesia
        const formatTanggal = (timestamp) => {
            // Pastikan input adalah Firestore Timestamp
            if (!timestamp || !timestamp.toDate) return '-'; 
            const date = timestamp.toDate();
            const options = { year: 'numeric', month: 'long', day: 'numeric' };
            return date.toLocaleDateString('id-ID', options);
        };

        // Fungsi untuk beralih Modul
        const showModule = (moduleId) => {
            document.querySelectorAll('.module-view').forEach(el => {
                el.style.display = 'none';
                el.classList.remove('module-active');
            });
            const activeModule = document.getElementById(`${moduleId}-module`);
            if (activeModule) {
                activeModule.style.display = 'block';
                activeModule.classList.add('module-active');
            }

            // Panggil fungsi render data sesuai modul
            if (moduleId === 'koin-nu') renderKoinNutable();
            if (moduleId === 'jurnal-umum') renderJurnalUmumTable();
            // Laporan Tahunan
            if (moduleId === 'laporan-tahunan') renderLaporanTahunanTable();
        };

        // --- A. OTENTIKASI (LOGIN/LOGOUT) ---

        const loginContainer = document.getElementById('login-form-container');
        const mainContent = document.getElementById('main-content');
        const logoutBtn = document.getElementById('logout-btn');
        const loginBtn = document.getElementById('login-btn');

        loginBtn.addEventListener('click', async () => {
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value; 
            
            if (!email || !password) {
                alert('Email dan Password harus diisi!');
                return;
            }

            try {
                // HINDARI KONSOL MERAH: Menggunakan try...catch untuk error otentikasi
                await auth.signInWithEmailAndPassword(email, password);
            } catch (error) {
                console.error("Login Error:", error.code, error.message);
                alert('Login gagal. Cek email dan password Anda. Pesan Error: ' + error.message);
            }
        });

        logoutBtn.addEventListener('click', async () => {
            try {
                await auth.signOut();
            } catch (error) {
                console.error("Logout Error:", error);
            }
        });

        // Listener status otentikasi
        auth.onAuthStateChanged((user) => {
            if (user) {
                // User login
                loginContainer.style.display = 'none';
                mainContent.style.display = 'block';
                logoutBtn.style.display = 'block';
                // Tampilkan modul Koin NU saat pertama login
                showModule('koin-nu'); 
            } else {
                // User logout
                loginContainer.style.display = 'block';
                mainContent.style.display = 'none';
                logoutBtn.style.display = 'none';
            }
        });

        // --- B. MODUL 1: LAPORAN DANA KOIN NU (Fungsional) ---

        const koinNuModule = document.getElementById('koin-nu-module');

        // Render struktur HTML Modul 1
        koinNuModule.innerHTML = `
            <h3>Modul 1: Laporan Dana Koin NU</h3>
            <div class="controls">
                <button id="reset-koin-btn">RESET DATA</button>
                <div style="float: right;">
                    <button id="download-pdf-koin-btn">Unduh PDF</button>
                    <input type="month" id="filter-bulan-koin" style="padding: 5px; margin-left: 10px;">
                </div>
            </div>
            <div style="clear:both;"></div>

            <table id="koin-nu-table">
                <thead>
                    <tr>
                        <th style="width: 5%;">NO</th>
                        <th style="width: 10%;">TANGGAL</th>
                        <th style="width: 10%;">NAMA PETUGAS</th>
                        <th style="width: 10%;">NO HP</th>
                        <th style="width: 15%;">DONATUR/KELOMPOK</th>
                        <th style="width: 10%;">ALAMAT (RT/RW)</th>
                        <th style="width: 10%;">NOMINAL</th>
                        <th style="width: 20%;">PEMBAGIAN DANA KOIN</th>
                        <th style="width: 10%;">Aksi</th>
                    </tr>
                </thead>
                <tbody id="koin-nu-data">
                    </tbody>
            </table>

            <h4>Input Data Koin Baru</h4>
            <form id="koin-nu-form">
                <input type="date" id="koin-tanggal" required>
                <input type="text" id="koin-petugas" placeholder="Nama Petugas" required>
                <input type="text" id="koin-nohp" placeholder="No HP" required>
                <input type="text" id="koin-donatur" placeholder="Donatur/Kelompok" required>
                <input type="text" id="koin-alamat" placeholder="Alamat (RT/RW)" required>
                <input type="number" id="koin-nominal" placeholder="Nominal (Tanpa Rp)" required>
                <button type="submit">Simpan Data Koin</button>
            </form>
        `;

        // Fungsi untuk render data dari Firebase
        const renderKoinNutable = () => {
            const tableBody = document.getElementById('koin-nu-data');
            tableBody.innerHTML = '<tr><td colspan="9" style="text-align: center;">Memuat data...</td></tr>';

            // Keterangan: Data baru di bawah data lama dan urut sesuai tanggal (desc)
            db.collection(COLLECTIONS.KOIN_NU).orderBy('tanggal', 'desc').get().then((snapshot) => {
                tableBody.innerHTML = ''; // Kosongkan
                let no = 1;

                if (snapshot.empty) {
                    tableBody.innerHTML = '<tr><td colspan="9" style="text-align: center;">Belum ada data Koin NU.</td></tr>';
                    return;
                }

                snapshot.forEach(doc => {
                    const data = doc.data();
                    const nominal = data.nominal || 0;
                    
                    // Perhitungan Pembagian Dana Koin
                    const ranting = formatNominal(Math.round(nominal * 0.60));
                    const petugas = formatNominal(Math.round(nominal * 0.10));
                    const mwc = formatNominal(Math.round(nominal * 0.25));
                    const pc = formatNominal(Math.round(nominal * 0.05));

                    const row = tableBody.insertRow();
                    row.innerHTML = `
                        <td style="text-align: center;">${no++}</td>
                        <td>${formatTanggal(data.tanggal)}</td>
                        <td>${data.petugas}</td>
                        <td>${data.nohp}</td>
                        <td>${data.donatur}</td>
                        <td>${data.alamat}</td>
                        <td style="text-align: right;">${formatNominal(nominal)}</td>
                        <td>
                            Ranting (60%): ${ranting}<br>
                            Petugas (10%): ${petugas}<br>
                            MWC (25%): ${mwc}<br>
                            PC (5%): ${pc}
                        </td>
                        <td>
                            <button onclick="alert('Fitur Edit belum diimplementasi');">Edit</button>
                            <button onclick="deleteKoin('${doc.id}')">Hapus</button>
                        </td>
                    `;
                });
            }).catch(error => {
                console.error("Error fetching Koin NU data: ", error); 
                tableBody.innerHTML = '<tr><td colspan="9" style="color: red; text-align: center;">Gagal memuat data: ' + error.message + '</td></tr>';
            });
        };

        // Fungsi Submit Form Koin NU
        document.getElementById('koin-nu-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            const nominalValue = parseInt(document.getElementById('koin-nominal').value);

            // Validasi Input
            if (isNaN(nominalValue) || nominalValue <= 0) {
                 alert('Nominal harus berupa angka positif.');
                 return;
            }

            const dataBaru = {
                tanggal: firebase.firestore.Timestamp.fromDate(new Date(document.getElementById('koin-tanggal').value)),
                petugas: document.getElementById('koin-petugas').value,
                nohp: document.getElementById('koin-nohp').value,
                donatur: document.getElementById('koin-donatur').value,
                alamat: document.getElementById('koin-alamat').value,
                nominal: nominalValue,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            };

            try {
                await db.collection(COLLECTIONS.KOIN_NU).add(dataBaru);
                alert('Data Koin NU berhasil disimpan!');
                document.getElementById('koin-nu-form').reset();
                renderKoinNutable(); // Refresh tabel
            } catch (error) {
                console.error("Error saving Koin NU data: ", error); 
                alert('Gagal menyimpan data. Cek koneksi Anda atau aturan Firestore.');
            }
        });

        // Fungsi Hapus Data Koin NU (Global, dipanggil dari tombol di tabel)
        window.deleteKoin = async (docId) => {
            if (!confirm("Yakin ingin menghapus data ini?")) return;

            try {
                await db.collection(COLLECTIONS.KOIN_NU).doc(docId).delete();
                alert('Data berhasil dihapus!');
                renderKoinNutable(); // Refresh tabel
            } catch (error) {
                console.error("Error deleting Koin NU data: ", error);
                alert('Gagal menghapus data: ' + error.message);
            }
        };


        // --- C. MODUL 2: JURNAL UMUM (Kerangka Logika) ---

        const jurnalUmumModule = document.getElementById('jurnal-umum-module');

        // Render struktur HTML Modul 2
        jurnalUmumModule.innerHTML = `
            <h3>Modul 2: Jurnal Umum (Dana Masuk & Keluar)</h3>
            
            <div class="controls">
                <button id="reset-jurnal-btn">RESET DATA</button>
                <div style="float: right;">
                    <button id="download-pdf-jurnal-btn">Unduh PDF</button>
                    <input type="month" id="filter-bulan-jurnal" style="padding: 5px; margin-left: 10px;">
                </div>
            </div>
            <div style="clear:both;"></div>

            <table id="jurnal-umum-table">
                <thead>
                    <tr>
                        <th rowspan="2" style="width: 5%;">NO</th>
                        <th rowspan="2" style="width: 10%;">TANGGAL</th>
                        <th rowspan="2" style="width: 20%;">KETERANGAN</th>
                        <th colspan="7" style="text-align: center;">JML PENERIMA</th>
                        <th rowspan="2" style="width: 10%;">KATEGORI</th>
                        <th rowspan="2" style="width: 10%;">DANA MASUK</th>
                        <th rowspan="2" style="width: 10%;">DANA KELUAR</th>
                        <th rowspan="2" style="width: 10%;">SALDO</th>
                        <th rowspan="2" style="width: 5%;">Aksi</th>
                    </tr>
                    <tr>
                        <th>Donatur</th>
                        <th>Pendidikan</th>
                        <th>Kesehatan</th>
                        <th>Ekonomi</th>
                        <th>Sosial</th>
                        <th>Subsidi</th>
                        <th>Bencana</th>
                    </tr>
                </thead>
                <tbody id="jurnal-umum-data">
                    </tbody>
            </table>

            <h4>Input Jurnal Umum Baru</h4>
            <form id="jurnal-umum-form">
                <button type="submit">Simpan Jurnal</button>
            </form>
        `;

        // Fungsi Render Jurnal Umum (Logika Penting)
        const renderJurnalUmumTable = async () => {
            const tableBody = document.getElementById('jurnal-umum-data');
            tableBody.innerHTML = '';
            
            // 1. Ambil Data Koin NU Total (untuk baris otomatis)
            const koinSnapshot = await db.collection(COLLECTIONS.KOIN_NU).get();
            let totalKoin = 0;
            koinSnapshot.forEach(doc => { totalKoin += doc.data().nominal || 0; });

            // Perhitungan Otomatis
            const petugas10 = Math.round(totalKoin * 0.10);
            const mwc25 = Math.round(totalKoin * 0.25);
            const pc5 = Math.round(totalKoin * 0.05);

            // 2. Data Baris Terkunci (5 Baris Pertama)
            const automaticEntries = [
                // Baris 1: Total Penerimaan Koin
                { keterangan: 'Total Penerimaan Koin', dana_masuk: totalKoin, dana_keluar: 0, kategori: 'Koin NU' },
                // Baris 2: Petugas 10%
                { keterangan: 'Petugas 10%', dana_masuk: 0, dana_keluar: petugas10, kategori: 'Dana keluar wajib: Petugas 10%' },
                // Baris 3: MWC 25%
                { keterangan: 'MWC 25%', dana_masuk: 0, dana_keluar: mwc25, kategori: 'Dana keluar wajib: MWC 25%' },
                // Baris 4: PC 5%
                { keterangan: 'PC 5%', dana_masuk: 0, dana_keluar: pc5, kategori: 'Dana keluar wajib: PC 5%' },
                // Baris 5: Saldo Bulan Lalu (Input Manual, diasumsikan 0 untuk demo)
                { keterangan: 'SALDO BULAN LALU (Input Manual)', dana_masuk: 0, dana_keluar: 0, kategori: 'Saldo' }
                // Catatan: Baris 5 perlu di-*query* dari koleksi lain/khusus untuk saldo
            ];

            let currentSaldo = 0; // Mulai saldo dari 0

            // Render 5 Baris Terkunci
            automaticEntries.forEach((data, index) => {
                currentSaldo += data.dana_masuk - data.dana_keluar;
                const row = tableBody.insertRow();
                // Keterangan: kelima baris ini tidak usah di kasih no dan tanggal serta terkunci
                row.innerHTML = `
                    <td colspan="2" style="text-align: left; font-style: italic;">${index === 4 ? '' : ''}</td>
                    <td style="font-weight: bold;">${data.keterangan}</td>
                    <td colspan="7"></td>
                    <td>${data.kategori}</td>
                    <td style="text-align: right;">${formatNominal(data.dana_masuk)}</td>
                    <td style="text-align: right;">${formatNominal(data.dana_keluar)}</td>
                    <td style="text-align: right; font-weight: bold;">${formatNominal(currentSaldo)}</td>
                    <td>${index === 4 ? '<button>Edit Saldo</button>' : 'Terkunci'}</td>
                `;
            });

            // 3. Ambil Data Jurnal Umum Manual (Mulai Penomoran dari baris ke-6)
            const jurnalSnapshot = await db.collection(COLLECTIONS.JURNAL_UMUM).orderBy('tanggal', 'asc').get();
            let noManual = 1;

            jurnalSnapshot.forEach(doc => {
                const data = doc.data();
                currentSaldo += data.dana_masuk - data.dana_keluar;
                
                const row = tableBody.insertRow();
                row.innerHTML = `
                    <td style="text-align: center;">${noManual++}</td>
                    <td>${formatTanggal(data.tanggal)}</td>
                    <td>${data.keterangan}</td>
                    <td>${data.jml_penerima?.donatur || 0}</td>
                    <td>${data.jml_penerima?.pendidikan || 0}</td>
                    <td>${data.jml_penerima?.kesehatan || 0}</td>
                    <td>${data.jml_penerima?.ekonomi || 0}</td>
                    <td>${data.jml_penerima?.sosial || 0}</td>
                    <td>${data.jml_penerima?.subsidi || 0}</td>
                    <td>${data.jml_penerima?.bencana || 0}</td>
                    <td>${data.kategori}</td>
                    <td style="text-align: right;">${formatNominal(data.dana_masuk)}</td>
                    <td style="text-align: right;">${formatNominal(data.dana_keluar)}</td>
                    <td style="text-align: right;">${formatNominal(currentSaldo)}</td>
                    <td><button onclick="alert('Aksi');">Edit/Hapus</button></td>
                `;
            });
            
            if (noManual === 1) { // Jika tidak ada data manual
                const row = tableBody.insertRow();
                row.innerHTML = `<td colspan="16" style="text-align: center;">Belum ada data Jurnal Umum.</td>`;
            }

        };

        // --- D. MODUL 3: LAPORAN TAHUNAN (Placeholder) ---

        const laporanTahunanModule = document.getElementById('laporan-tahunan-module');

        laporanTahunanModule.innerHTML = `
            <h3>Modul 3: Laporan Tahunan</h3>
            <p>Modul ini memerlukan agregasi data yang sangat kompleks dari Modul 1 dan Modul 2 untuk 12 bulan. Implementasi di sini hanya berupa kerangka tabel.</p>
            `;
        
        const renderLaporanTahunanTable = () => {
             // Fungsi untuk mengambil dan mengagregasi data dari KOIN_NU dan JURNAL_UMUM
             console.log("Rendering Laporan Tahunan...");
        };
    </script>
</body>
</html>
